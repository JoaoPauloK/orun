var __decorate=this&&this.__decorate||function(e,t,i,s){var a,r=arguments.length,n=r<3?t:null===s?s=Object.getOwnPropertyDescriptor(t,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)n=Reflect.decorate(e,t,i,s);else for(var o=e.length-1;0<=o;o--)(a=e[o])&&(n=(r<3?a(n):3<r?a(t,i,n):a(t,i))||n);return 3<r&&n&&Object.defineProperty(t,i,n),n},katrid,Katrid,katrid,katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,katrid,Katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,Katrid,katrid,Katrid,Katrid,katrid,katrid,Katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,Katrid,Katrid,Katrid,katrid,katrid,katrid,Katrid,Katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,Katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,Katrid,katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,Katrid,Katrid,Katrid,katrid,katrid,Katrid,Katrid,Katrid,Katrid,katrid,katrid,Katrid,Katrid,Katrid,Katrid,Katrid,Katrid,katrid,Katrid,katrid,katrid,katrid,katrid;(e=>{{e=e.ui||(e.ui={});class t extends HTMLElement{constructor(){super(...arguments),this._created=!1}connectedCallback(){this._created||this.create()}create(){this._created=!0}}e.WebComponent=t,e.Widget=class{render(){}}}})(katrid=katrid||{}),(s=>{s.$hashId=0,s.customElementsRegistry={},s.define=function(e,t,i){s.customElementsRegistry[e]={constructor:t,options:i}},s.createVm=function(e){return e.components=s.componentsRegistry,e.directives=s.directivesRegistry,(e=Vue.createApp(e)).config.globalProperties.$filters=s.filtersRegistry,e},s.componentsRegistry={},s.directivesRegistry={},s.filtersRegistry={},s.component=function(e,t){s.componentsRegistry[e]=t},s.directive=function(e,t){s.directivesRegistry[e]=t},s.filter=function(e,t){s.filtersRegistry[e]=t},s.html=function(e){return $(e)[0]},s.globalData={}})(Katrid=Katrid||{}),(e=>{(e=e.mobile||(e.mobile={})).isAndroid=void 0!==window.__katridMobileHost,e.isIOS=void 0!==window.__katridMobileHost,e.isApp=e.isAndroid||e.isIOS,e.writeStringToFile=function(e,t){__katridMobileHost.writeStringToFile(e,t)},e.readStringFromFile=function(e){return __katridMobileHost.readStringFromFile(e)}})(katrid=katrid||{}),(i=>{i.localStorage=class{static setItem(e,t){i.mobile.isApp?i.mobile.writeStringToFile(e,t):window.localStorage.setItem(e,t)}static getItem(e){return i.mobile.isApp?i.mobile.readStringFromFile(e):window.localStorage.getItem(e)}};let s="_LOCAL_DATA";i.localData=class{constructor(e,t){this.dbName=e,this.version=t}open(){let e;return(e=indexedDB.open(this.dbName,this.version)).onupgradeneeded=e=>{e.target.result.createObjectStore(s,{keyPath:"key"})},new Promise(t=>{e.onsuccess=e=>{this.db=e.target.result,t(this.db)}})}setItem(e,i){return new Promise(t=>{this.db.transaction([s],"readwrite").objectStore(s).put({key:e,value:i}).onsuccess=e=>t(!0)})}getItem(e){return new Promise(t=>{this.db.transaction(s).objectStore(s).get(e).onsuccess=e=>t(e.target.result?.value)})}}})(katrid=katrid||{}),(t=>{{var e=t.ui||(t.ui={});class i{constructor(e){this.template=e?.template,this.app=e?.app}createElement(){var e=document.createElement("div");return e.className="action-view",this.template&&(e.innerHTML=this.template),e}_prepareElement(e){return e}getElement(){return this.element||(this.element=this.createElement(),this._prepareElement(this.element)),this.element}ready(){return this._ready}async _execute(){}async execute(e){e.actionViewer.appendChild(this.getElement()),this._ready=new Promise(async e=>{await this._execute(),e()})}}e.BaseActionView=i;class s extends i{_prepareElement(e){return super._prepareElement(e),this.vm=this.createVm(e),e}defineData(){return{}}defineMethods(){return{}}defineComponent(){return{data:()=>this.defineData(),methods:this.defineMethods()}}createVm(e){var t=this.defineComponent();return this.vm=Katrid.createVm(t).mount(e),this.vm}}e.ActionView=s,e.BaseApplication=class{constructor(e){this.actions={},this.element=e.el,this.template=e.template,this.title=e.title,this.actionViewer=this.element.querySelector(".action-manager"),this.render(this.element),(t.ui.app=this).ready()}get title(){return this._title}set title(e){this._title=e,document.title=e}$nextTick(){return Vue.nextTick()}registerAction(e,t){this.actions[e]=t}render(e){this.actionViewer||(this.actionViewer=document.createElement("div"),this.actionViewer.className="action-manager"),"string"==typeof this.template&&(this.actionViewer.innerHTML=this.template),e.appendChild(this.actionViewer),e.className="katrid-base-app",this.prepareElement(e),this._ready=Promise.resolve(this)}prepareElement(e){}async gotoAction(e){e=this.actions[e];if(e instanceof i)return this.setAction(e);if(e instanceof Function)return this.setAction(new e({app:this}));throw new Error("Invalid action")}async setAction(e){if(this.action=e,this.actionViewer.innerHTML="",this.action)return await this.push(this.action),this.action}push(e){return e.execute(this)}ready(){return console.log("ready"),this._ready}}}})(katrid=katrid||{}),(e=>{{var t=e.pwa||(e.pwa={});class i extends e.ui.BaseApplication{prepareElement(e){super.prepareElement(e),this.vm=Katrid.createVm(this.defineComponent()).mount(e)}defineData(){return{}}defineMethods(){return{}}defineComponent(){return{data:()=>this.defineData(),methods:this.defineMethods()}}}t.Application=i}})(katrid=katrid||{}),(a=>{{var i=a.Actions||(a.Actions={});i.registry={};class e{static{this._context={}}constructor(e){this.state=null,(this.config=e).info&&(this.info=e.info),this.isDialog=e.isDialog,this.app=e.app||a.webApp,e.actionManager?this.actionManager=e.actionManager:this.app?.actionManager&&(this.actionManager=this.app.actionManager),this.container=e.container||this.actionManager,this.actionManager&&this.actionManager.addAction(this)}beforeUnload(e){}async confirmDiscard(){return!0}async debug(){}async render(){this.element||(this.element=document.createElement("action-view"),this.element.className="action-view")}async renderTo(e){await this.render(),(e=e||this.actionManager).append(this.element)}destroy(){this.app.actionManager.removeAction(this),this.element?this.element.remove():this.container.innerHTML=""}get id(){return this.config.id||this.info?.id}get context(){if(!this._context){a.isString(this.config.context)?this._context=JSON.parse(this.config.context):this.config.context?this._context=this.config.context:this._context={};var e,t,i=window.location.href.split("#",2)[1];if(i)for([e,t]of new URLSearchParams(i))(e.startsWith("default_")||"filter"===e)&&(this._context[e]=t)}return this._context}doAction(e){var t=e.type||e.action_type;return i.registry[t].dispatchAction(this,e)}onActionLink(e,t,i){var s={};return i&&Object.assign(s,i),Object.assign(s,this.context),a.Services.Actions.onExecuteAction(e,t,s)}openObject(e,t,i){i.preventDefault(),i.stopPropagation();let s=i.target.href;return s=s||`#/app/?menu_id=${this.params.menu_id}&model=${e}&view_type=form&id=`+t,i.ctrlKey?window.open(i.target.href):location.hash=s,!1}restore(){}apply(){}execute(){$(this.app).trigger("action.execute",this)}search(){}async onHashChange(e){$(this.app).trigger("action",[this])}getDisplayText(){return this.config.caption}createBreadcrumbItem(e,t){var i=document.createElement("li");i.classList.add("breadcrumb-item"),t===this.actionManager.actions.length-1?i.innerText=this.getDisplayText():i.append(this.createBackItemLink(this.getDisplayText(),0<t,`back(${t})`)),e.append(i)}createBackItemLink(e,t,i){var s=document.createElement("a"),t=(t&&(s.innerHTML='<i class="fa fa-chevron-left"></i> '),document.createElement("span"));return t.innerText=e,s.append(t),s.setAttribute("href","#"),"string"==typeof i?s.setAttribute("v-on:click.stop.prevent",i):s.addEventListener("click",i),s}generateHelp(e){var t;this.config.caption&&((t=document.createElement("h3")).innerText=this.config.caption,e.element.append(t)),this.config.usage&&((t=document.createElement("p")).innerHTML=this.config.usage,e.element.append(t))}}i.Action=e;class t extends e{static{this.actionType="ir.action.url"}constructor(e){super(e),window.location.href=e.url}}i.goto=function(e,t,i=!1){return e={action:e},t&&Object.assign(e,t),a.webApp.actionManager.onHashChange(e,i)},i.registry[t.actionType]=t}})(Katrid=Katrid||{}),(s=>{{var e=s.Actions||(s.Actions={});class t extends e.Action{static{this.actionType="ui.action.homepage"}static{this.hooks=[]}get content(){return this.info.content}onHashChange(e){super.onHashChange(e);e=new i;console.log("action info",this.info.id),e.actionId=this.info.id,this.element.append(e.element);let t=this.content;t&&("string"==typeof t&&(t=JSON.parse(t)),e.load(t)),e.render()}}e.Homepage=t;class i{constructor(){this.panels=[],this._rendered=!1,this.createElement(),this.render()}createElement(){var e=document.createElement("div"),t=document.createElement("div"),i=(t.className="homepage-toolbar",e.append(t),document.createElement("a"));i.classList.add("btn","btn-edit","btn-outline-secondary"),i.innerHTML='<i class="fas fa-pen"></i>',t.append(i),e.append(t),i.addEventListener("click",()=>this.edit()),e.classList.add("homepage-view","col-12"),this.element=e}load(e){this.panels=e.panels,this.info=e;for(var t of s.Actions.Homepage.hooks)t.onLoad&&t.onLoad(this)}edit(){var e=new s.Actions.Portlets.HomepageEditor;e.actionId=this.actionId,this.info&&e.load(this.info),this.element.parentElement.append(e.element),this.element.remove()}render(){if(!this._rendered){this._rendered=!0,console.log("panels",this.panels);for(var e of this.panels){var t=this.createPanel();console.log("panel",t.load),t.load(e),this.element.append(t)}for(var i of s.Actions.Homepage.hooks)i.onRender&&i.onRender(this)}}createPanel(){return document.createElement("portlet-panel")}}e.HomepageView=i,s.Actions.registry[t.actionType]=t}})(Katrid=Katrid||{}),(r=>{{var i=r.Actions||(r.Actions={});class e extends HTMLElement{constructor(){super(),this.actions=[],this.currentAction=null,this.mainAction=null,this.$cachedActions={},this._navbarVisible=!0}get action(){return this._action}set action(e){(this._action=e)&&(this.empty(),e.actionManager=this)}get navbarVisible(){return this._navbarVisible}set navbarVisible(e){this._navbarVisible=e}back(t){if(void 0===t&&1<this.actions.length)this.action=this.actions[this.actions.length-2];else{let e;t instanceof i.Action&&(e=this.actions.indexOf(t)),this.actions.splice(e+1,this.actions.length-e),this.action=this.actions[e]}}removeAction(e){this.actions.splice(this.actions.indexOf(e),this.length),0===this.length&&(this.mainAction=null)}get length(){return this.actions.length}get context(){return this.currentAction?this.currentAction.context:{user_id:r.app.userInfo.id}}empty(){this.innerHTML=""}reset(){this.empty(),this.actions=[]}get path(){return this.action.path}doAction(e){}async confirmDiscard(){return!this.action||this.action?.confirmDiscard()}async onHashChange(e,t){var i=e.action;let s,a;return a=s=this.currentAction,s&&s.info.id,t&&(this.reset(),this.action&&this.action.destroy(),this.action=null),i in this.$cachedActions?(t=this.$cachedActions[i],a=new r.Actions.registry[t.type](t,e)):!i&&e.model&&(!a||a.params&&a.params.model!==e.model)?(t=await new r.Services.ModelService(e.model).rpc("admin_get_formview_action",[e.id]),a=new r.Actions.registry[t.type](t)):this.action&&this.action.config.id==i||(t=await r.Services.Actions.load(i),a="ui.action.window"===t.type?new r.Actions.registry[t.type](t,e):new r.Actions.registry[t.type]({info:t},e)),await a.renderTo(this),await a.onHashChange(e),a}addAction(e){this.empty(),this.actions.push(e),this.action=e}async execAction(e){var t;return"ui.action.view"===e.type?(console.log("exec",e),new r.Actions.ViewAction({actionManager:this,info:e}).renderTo(this)):"ui.action.window"===e.type?((t=Object.assign({ActionManager:this},e)).model=new r.Data.Model({name:e.model,fields:e.fields}),new r.Actions.WindowAction(t).renderTo(this)):void 0}async debug(e){await new r.Actions.registry[e.action_type]({info:e}).debug()}registerActions(e){for(var[t,i]of Object.entries(e))(this.$cachedActions[t]=i).actionManager=this}}i.ActionManager=e,r.define("action-manager",e)}})(Katrid=Katrid||{}),(o=>{{var d=o.Actions||(o.Actions={});let c={form:[/id/,/action/,/view_type/,/menu_id/,/model/,/default_.+/],default:[/action/,/view_type/,/menu_id/,/model/,/default_.+/,/filter/]};d.DEFAULT_VIEWS=["list","form"];class i extends o.Actions.Action{static{this.actionType="ui.action.window"}constructor(e,t){if(super(e),this._loadDataCallbacks=[],this.pendingOperation=!1,this.viewModes=e.viewModes||d.DEFAULT_VIEWS,this.config?.viewMode?this.viewMode=this.config.viewMode:this.config?.info?.viewMode?this.viewMode=this.config.info.viewMode:this.viewMode="list",e.model instanceof o.Data.Model?(this.model=e.model,this.modelName=e.model.name):e.fields?(this.modelName=e.model,this.model=new o.Data.Model({name:this.modelName,fields:e.fields})):"string"==typeof e.model&&(this.modelName=e.model),this._cachedViews={},this.model&&e.templates){if(this._cachedViews=o.Forms.Views.fromTemplates(this,this.model,e.templates),e.records)for(var i of Object.values(this._cachedViews))i.records=e.records}else if(e.views)for(var[s,a]of Object.entries(e.views))a instanceof o.Forms.ModelView&&(this._cachedViews[s]=a);else if(e.viewsInfo){this.views={};for(var[r,n]of Object.entries(e.viewsInfo))this.views[r]=n;console.log("views info",this.views)}e.viewModes||(this._cachedViews?this.viewModes=Object.keys(this._cachedViews):this.viewModes=Object.keys(this.views))}createSearchView(){if(this._cachedViews.search)this.searchView=this._cachedViews.search,this.searchView.render();else if(this.modelName){let e;(e=this.views?this.views.search:{}).model=this.model,this.searchView=new o.Forms.SearchView(e,this),this.searchView.render()}}async onHashChange(e){let t=!1;this.params&&(this.params.id,e.id);this.params={},e.view_type||(this.params.view_type=this.viewModes[0],t=!0),e.model||(this.params.model=this.config.model,t=!0);let i=c[e.view_type||this.params.view_type];void 0===i&&(i=c.default),Object.assign(this.params,e);var s,a=[];for(s of Object.keys(this.params)){let e=!1;for(var r of i)r.test(s)&&(e=!0);e?a.push(s):t=!0}if(t){var n,o=this.params;this.params={};for(n of a){var d=o[n];void 0!==d&&(this.params[n]=d)}this.params.action||delete this.params.action;var l=this.makeUrl(this.viewMode);history.replaceState(null,null,l)}l=this.params.view_type;l===this.viewType?await this.view.onHashChange(e):await this.showView(l)}getCaption(){return this.view.vm.record?.$str}rpc(e,t,i){i&&i.stopPropagation(),t?Array.isArray(t)?t={args:t}:o.isObject(t)||(t={args:[t]}):t={},this.model.service.rpc(e,t.args,t.kwargs)}beforeUnload(e){this.view.vm.changing&&e.preventDefault()}prepareContext(){var e=super.context(),t=this.view.getSelection();return t&&t.length&&(e.active_id=t[0],e.active_ids=t),e}getDisplayText(){return"form"===this.viewMode?this.view.getDisplayText():super.getDisplayText()}onLoadData(e){this.selection&&this.selection.clear&&this.selection.clear();for(var t of this._loadDataCallbacks)t(e)}addLoadDataCallback(e){-1===this._loadDataCallbacks.indexOf(e)&&this._loadDataCallbacks.push(e)}removeLoadDataCallback(e){-1<this._loadDataCallbacks.indexOf(e)&&this._loadDataCallbacks.splice(this._loadDataCallbacks.indexOf(e),1)}switchView(e,t){var i;e!==this.viewType&&(i={},Object.assign(i,o.app.$location.$$search),t&&Object.assign(i,t),i.view_type=e,o.app.$location.search(i))}async showView(e,t=null){var i=this.view;return(this.viewMode=e)in this._cachedViews?this.view=this._cachedViews[e]:(this.viewInfo=this.views[e],this.view=new o.Forms.Views.registry[e](Object.assign({action:this},this.viewInfo)),this.view.createElement(),"form"===e?await this.view.loadPendingViews():this.lastSearchMode=e,this.view.renderTo(this.container),this._cachedViews[Object.getPrototypeOf(this.view).constructor.viewType]=this.view),this.view.ready(),this.view instanceof o.Forms.RecordCollectionView&&(this.searchResultView=this.view,this.lastUrl=location.hash),this.element&&(this.element.children.length&&this.element.removeChild(this.element.children[0]),this.view.renderTo(this.element),this.searchView||1===this.viewModes.length&&"form"==this.viewModes[0]||this.createSearchView(),this.view instanceof o.Forms.RecordCollectionView&&(this.view.searchView=this.searchView),i&&this.view!==i&&(i.active=!1),this.view.active=!0),"form"===e&&(i=this.view,t?.params?.id||this.params?.id?i.setState(o.Data.DataSourceState.browsing):await i.insert()),this.params?.view_type&&e!==this.params.view_type&&(history.pushState({view_type:this.params.view_type},document.title,this.makeUrl(e)),this.params.view_type=e),this.app&&this.app.element.dispatchEvent(new CustomEvent("katrid.actionChange")),this.view}async render(){await super.render(),this.viewMode&&await this.showView(this.viewMode)}createViewsButtons(e){for(var t of this.viewModes){t=o.Forms.Views.registry[t];t&&t.createViewModeButton(e)}}get selectionLength(){if(this.selection)return this.selection.length}async copyTo(e){var t,i,s;this.scope.recordId&&(e=await new o.Services.ModelService("ui.copy.to").rpc("copy_to",[e,this.scope.recordId]),i=await(t=new o.Services.ModelService(e.model)).getViewInfo({view_type:"form"}),s=this.scope.$new(!0),new o.Forms.Dialogs.Window({scope:s,view:i,model:t,defaultValues:e.value}))}makeUrl(e){e=e||this.viewMode;var t={};return Object.assign(t,this.params),Object.assign(t,{model:this.model.name,view_type:e,menu_id:o.webApp.currentMenu.id}),this.config?.id&&(t.action=this.config.id),"form"===e&&this.record&&(t.id=this.view.record.id),"#/app/?"+new URLSearchParams(t).toString()}async execute(){var e;super.execute(),this.container.innerHTML="",this._cachedViews?this.render():this.views||(e=await this.model.loadViews({views:this.config.views,action:this.config.id,toolbar:!0}),this.fields=e.fields,this.fieldList=e.fieldList,this.views=e.views,e.views.form)}changeUrl(){}get viewType(){return this._viewType}set viewType(e){e!==this._viewType&&(this._viewType=e)}searchText(e){}_prepareParams(e){var t,i={};for(t of Array.from(e))t.field&&"ForeignKey"===t.field.type?i[t.field.name]=t.id:i[t.id.name+"__icontains"]=t.text;return i}async setSearchParams(e){this.view.setSearchParams(e)}async applyGroups(e,t){e=await this.dataSource.groupBy(e,t);this.searchResultView.groupBy(e)}groupHeaderClick(e,t){console.log("group header click",e),e.$expanded=!e.$expanded,e.$expanded?this.dataSource.expandGroup(t,e):this.dataSource.collapseGroup(t,e)}async loadGroupRecords(e){var t;0<e.$count&&(t=await this.dataSource.model.search({params:e.$params}),e.records=t.data,console.log(e),this.scope.$apply())}doViewAction(e,t,i,s){return this._doViewAction(this.scope,e,t,i,s)}_doViewAction(e,t,i,s,a){let r=null;if(a&&(r=window.prompt(a)),!s||confirm(s))return this.model.doViewAction({action_name:t,target:i,prompt:r}).then(function(e){var t;"open"!==e.status&&"download"===e.status&&((t=document.createElement("a")).href=e.download,e=e.download.split("/"),t.download=e[e.length-1],t.click())})}async formButtonClick(e,t){try{this.pendingOperation=!0;var i=await this.model.service.rpc(t,[e],null,this);await this._evalResponseAction(i)}finally{this.pendingOperation=!1}}onActionLink(e,t,i,s){var a={active_id:this.view?.record?.id};return i&&Object.assign(a,i),Object.assign(a,this.context),s.target.hasAttribute("data-binding-params")&&(i=s.target.getAttribute("data-binding-params"),s=new Function("__ctx__",`with (__ctx__) { return ${i} }`).call(this,this.view.vm),a.bindingParams=s),o.Services.Actions.onExecuteAction(e,t,a)}async _evalResponseAction(e){if("refresh"===e.tag)this.view.refresh();else if("new"==e.tag)e.action?await(await o.Actions.goto(e.action,{view_type:"form"})).view.insert(e.values):this.view.datasource.insert(!0,e.values);else if(e.invoke)for(var[t,i]of Object.entries(e.invoke))katrid.invoke(t)(i);else if(e.type)return new o.Actions.registry[e.type](e,this.scope,this.scope.location).execute()}doBindingAction(e){o.Services.Actions.load($(e.currentTarget).data("id")).then(e=>{"ui.action.report"===e.action_type&&o.Actions.ReportAction.dispatchBindingAction(this,e)})}listRowClick(e,t,i){t.$hasChildren?this.groupHeaderClick(t,e):(t={id:t.id,action:this.config.id,model:this.config.model,view_type:"form",menu_id:o.webApp.currentMenu.id},i&&i.ctrlKey?(i="#/app/?"+$.param(t),window.open(i)):(o.app.loadPage("#/app/?"+$.param(t),!1),this.dataSource.recordIndex=e))}get recordIndex(){return this._recordIndex}set recordIndex(e){this._recordIndex=e}onDataStateChange(e,t){let i=t.scope.action;t.changing&&setTimeout(()=>{if(i.$element)for(var e of Array.from(i.$element.find("input[type!=hidden].form-field:visible")))if(!(e=$(e)).attr("readonly"))return void $(e).focus()})}autoReport(){return this.model.autoReport().then(function(e){if(e.ok&&e.result.open)return window.open(e.result.open)})}get selection(){return this.view.selection}getSelection(){return"form"===this.viewType?this.view.vm.recordId?[this.view.vm.recordId]:void 0:this.view.vm.selection&&this.view.vm.selection.length?this.view.vm.selection.map(e=>e.id):void 0}set attachments(e){this.scope.$apply(()=>this.scope.attachments=e)}deleteAttachment(e,t){var i=e[t];confirm(o.i18n.gettext("Confirm delete attachment?"))&&(e.splice(t,1),o.Services.Attachments.delete(i.id))}markStar(e){}addFilter(e,t){e=this.view.fields[e];e instanceof o.Data.DateTimeField&&"string"==typeof t&&(t=moment(t)),this.searchView.controller.addCustomFilter(e,[t])}static async fromModel(e){e=new o.Services.ModelService(e);await e.loadViews({form:null});return new i({model:e,info:{view_mode:"form",view_type:"form"}})}canBackToSearch(){return 1<this.viewModes.length}createBreadcrumbItem(e,t){var i;"form"===this.viewMode&&this.canBackToSearch&&0===t&&((i=document.createElement("li")).classList.add("breadcrumb-item"),i.append(this.createBackItemLink(super.getDisplayText(),!0,`back(${t}, '${this.lastSearchMode||"list"}')`)),e.append(i)),"form"===this.viewMode&&t<this.actionManager.actions.length-1&&((i=document.createElement("li")).classList.add("breadcrumb-item"),i.append(this.createBackItemLink(this.view.vm.record?.$str,!1,`back(${t}, '${this.viewMode}')`)),e.append(i)),t===this.actionManager.actions.length-1&&super.createBreadcrumbItem(e,t)}back(e,t){e===this.index?this.viewMode!==t&&this.showView(t):(e=this.actionManager.actions[e],this.actionManager.back(e),this.actionManager.append(e.element),t&&e instanceof i&&t!==e.viewMode&&e.showView(t))}get index(){return this.actionManager.actions.indexOf(this)}generateHelp(e){var t,i,s;super.generateHelp(e),this.modelName&&((t=document.createElement("h5")).innerText=o.i18n.gettext("Technical information"),(i=document.createElement("pre")).innerText="Model name: "+this.modelName,(s=document.createElement("p")).innerHTML=this.config.help_text||"",e.element.append(t),e.element.append(i),e.element.append(s)),this.view?.fields&&this.view.generateHelp(e)}}d.WindowAction=i,d.gotoNewRecord=async function(e){var t=e.actionId;let i=await o.Actions.goto(t,{view_type:"list"},!0);setTimeout(()=>{console.log("goto",e.values),i.view.vm.insert(e.values)},1e3)},o.Actions.registry[i.actionType]=i}})(Katrid=Katrid||{}),(e=>{var t;(t=e.ComponentState||(e.ComponentState={}))[t.Loading=0]="Loading",t[t.Loaded=1]="Loaded";class i extends HTMLElement{constructor(){super(...arguments),this._created=!1}connectedCallback(){this._created||(this._created=!0,this.create())}create(){}}e.WebComponent=i})(Katrid=Katrid||{}),(e=>{class t{constructor(){this.items=[]}add(e){this.items.push(e),this.notify("add",e)}dump(){}remove(e){var t=this.items.indexOf(e);0<=t&&this.items.splice(t,1),this.notify("remove",e)}clear(){this.items=[]}}e.Collection=t;class i extends t{constructor(e){super(),this.owner=e}}e.OwnedCollection=i})(katrid=katrid||{}),(e=>{{var t=e.Actions||(e.Actions={});class i extends e.WebComponent{create(){super.create(),this.className="breadcrumb-nav"}get actionManager(){return this._actionManager}set actionManager(e){this._actionManager=e,this.render()}render(){this.innerHTML="";var e=document.createElement("nav");e.setAttribute("aria-label","breadcrumb");let i=document.createElement("ol");i.className="breadcrumb",this._actionManager.actions.forEach((e,t)=>e.createBreadcrumbItem(i,t)),e.append(i),this.append(e)}}t.ActionNavbar=i,e.define("action-navbar",i)}})(Katrid=Katrid||{}),(a=>{{var e=a.Actions||(a.Actions={});class t extends a.Actions.Action{static{this.actionType="ui.action.report"}static async dispatchBindingAction(e,t){var i=localStorage.katridReportViewer||"pdf";let s=e.selection;e={data:[{name:"id",value:s=s&&s.join(",")}]},t=await new a.Services.ModelService("ui.action.report").post("export_report",{args:[t.id],kwargs:{format:i,params:e}});t.open&&window.open(t.open)}get name(){return this.config.info.name}constructor(e,t,i){super(e),this.fields=[],this.templateUrl="view.report.jinja2",this.userReport={}}userReportChanged(e){return this.location.search({user_report:e})}async onHashChange(e){var t;console.log("report hash change",e),this.userReport.id=e.user_report,this.userReport.id&&(t=await new a.Services.ModelService("ui.action.report").post("load_user_report",{kwargs:{user_report:this.userReport.id}}),this.userReport.params=t.result),location.hash="#/app/?"+$.param(e),this.renderParams()}async debug(){this.renderParams()}renderParams(){var e=a.html(a.Reports.renderDialog(this));this.vm=this.createVm(e),$(a.webApp.element).empty().append(e)}createVm(e){let t=this;this.report=new a.Reports.Report(t),this.report.loadFromXml(t.config.info.content),this.report.render(e),this.report.loadParams();var i=a.createVm({data(){return{userReport:this.userReport||{},userReports:[],report:t.report,customizableReport:this.customizableReport,advancedOptions:this.advancedOptions}},mounted(){this.$report=t.report},methods:{exportReport(e){}},components:a.componentsRegistry,directives:a.directivesRegistry});return i.mount(e),i}}e.ReportAction=t,a.Actions.registry[t.actionType]=t}})(Katrid=Katrid||{}),(t=>{{var e=t.Actions||(t.Actions={});class i extends e.Action{static{this.actionType="ui.action.view"}constructor(e){super(e),e.info?.template&&(this.view=new t.Forms.BaseView({template:e.info.template}))}async onHashChange(e){return}async render(){await super.render(),this.element&&this.view.renderTo(this.element)}}e.ViewAction=i,e.registry[i.actionType]=i,e.registry.ViewAction=i}})(Katrid=Katrid||{}),(i=>{var e=i.Actions||(i.Actions={});{e=e.Portlets||(e.Portlets={});class t extends i.Actions.HomepageView{createPanel(){var e=super.createPanel();return e.editing=!0,e}createElement(){var e=document.createElement("div"),e=(e.classList.add("homepage-toolbar"),e.classList.add("homepage-view","col-12"),this.element=e,document.createElement("button")),t=(e.classList.add("btn","btn-primary"),e.innerText=i.i18n.gettext("Save"),document.createElement("button"));t.classList.add("btn","btn-secondary"),t.innerText=i.i18n.gettext("Discard"),e.addEventListener("click",()=>this.save()),t.addEventListener("click",()=>this.back()),this.element.append(e),this.element.append(t)}edit(){throw Error("Editor already loaded")}dump(){return{panels:Array.from(this.element.querySelectorAll("portlet-panel")).map(e=>e.dump())}}async save(){var e=new i.Services.ModelService("ui.action.homepage"),t=this.dump(),e=(await e.rpc("save_layout",[[this.actionId],JSON.stringify(t)]),this._back());e.actionId=this.actionId,e.load(t),this.parentElement.append(e),this.remove()}_back(){return document.createElement("homepage-view")}back(){var e=this._back();this.info&&e.load(this.info),this.parentElement.append(e),this.remove()}render(){this.panels&&this.panels.length||(this.panels=[{caption:"",portlets:[]}]),super.render()}}e.HomepageEditor=t}})(Katrid=Katrid||{}),(a=>{var e=a.Actions||(a.Actions={});{var t=e.Portlets||(e.Portlets={});class i{constructor(){this.editing=!1}render(){var e;this.wrapper=document.createElement("div"),this.wrapper.classList.add("portlet-wrapper"),this.element=document.createElement("div"),this.element.classList.add("portlet"),this.header&&((e=document.createElement("h4")).innerText=this.header,this.element.append(e)),this.text&&((e=document.createElement("h5")).innerText=this.text,this.element.append(e)),this.wrapper.append(this.element)}renderTo(e){}load(e){this.header=e.header||e.name}}t.BasePortlet=i;class s extends i{renderTo(e){this.wrapper=document.createElement("div"),this.wrapper.classList.add("portlet-wrapper","col"),this.element||this.render(),e.append(this.wrapper)}}t.Portlet=s,t.PortletGroup=class{constructor(e){this.portlets=[],this.element=document.createElement("div"),this.element.classList.add("portlet-panel","col-12"),this.text=e?.text;var t=document.createElement("h3");this.text&&(t.innerText=this.text),this.element.append(t),e?.homepage&&(this.homepage=e.homepage),this.homepage&&this.renderTo(this.homepage)}addPortlet(e){this.portlets.push(e),e.renderTo(this.element)}renderTo(e){e.append(this.element)}};class r extends HTMLElement{constructor(){super(...arguments),this.caption="",this.editing=!1,this.portlets=[]}connectedCallback(){this.classList.add("portlet-panel","col-12"),this.editing&&this.classList.add("editing"),this.render()}render(){var e=document.createElement("div"),t=(e.classList.add("col-12"),document.createElement("h5"));if(t.innerText=this.caption,e.append(t),this.append(e),this.editing&&this.renderEditor(e),this.info)for(var i of this.info.portlets)this.addPortlet(i).render()}async renderEditor(e){var t=new a.Services.ModelService("ui.portlet"),t=(this.availableItems=[],await t.rpc("search_portlets")),t=t.portlets,i=document.createElement("div");i.classList.add("toolbar");let s=document.createElement("select");s.classList.add("form-control"),t.forEach((e,t)=>{this.availableItems[e.id]=e;var i=document.createElement("option");i.value=e.id,i.innerText=e.name,s.append(i)});t=document.createElement("button");return t.innerText=a.i18n.gettext("Add"),t.classList.add("btn","btn-outline-secondary"),i.append(s),i.append(t),i.querySelector("button").addEventListener("click",e=>this.addPortletClick(e.target)),e.append(i),i}dump(){return{caption:this.caption,portlets:this.portlets.map(e=>e.dump())}}load(e){e.caption&&(this.caption=e.caption),this.info=e}addPortlet(e){var t;return this.editing?((t=document.createElement("portlet-editor")).load(e),this.portlets.push(t.el),this.append(t),t.panel=this,t.render(),t):((t=portletRegistry[e.tag]).element.load(e),this.portlets.push(t),(e=document.createElement("div")).classList.add("portlet-wrapper","col-1"),e.append(t),this.append(e),t)}addPortletClick(e){var e=e.parentElement.querySelector("select"),e=this.availableItems[parseInt(e.value)],t={tag:e.tag,name:e.name};e.info&&("string"==typeof e.info&&(e.info=JSON.parse(e.info)),Object.assign(t,e.info)),this.addPortlet(t)}}t.PortletPanel=r;class n extends HTMLElement{connectedCallback(){this.create(),this.render()}create(){this.classList.add("portlet-editor","col-1")}load(e){this.info=e,console.log("tag",e),this.portlet=new t.registry[e.tag],this.portlet.editing=!0,this.portlet.load(e),this.portlet.render()}render(){var e;this.el||((e=document.createElement("div")).classList.add("mirror"),e.append(this.portlet.element),this.append(e),console.log("render"),this.portlet.editing&&this.addEventListener("click",()=>this.removePortlet()),this.el=e)}removePortlet(){var e=this.panel.portlets.indexOf(this.el);console.log(e,this.panel),-1<e&&this.panel.portlets.splice(e,1),this.remove()}}t.PortletEditor=n;class o extends HTMLElement{constructor(){super(...arguments),this.editing=!1,this.info={},this.loaded=!1}connectedCallback(){this.create()}create(){this.classList.add("portlet")}dump(){return{}}load(e){this.info=e}render(e){e=e||this;var t=document.createElement("h6");t.innerText=a.i18n.gettext(this.info.name),e.append(t)}}t.PortletElement=o;class d extends s{create(){super.create(),this.classList.add("portlet-create-new")}dump(){return{tag:this.tagName.toLowerCase(),model:this.model,action:this.action}}load(e){super.load(e),this.model=e.model,this.action=e.action}}t.CreateNew=d;class l extends s{constructor(e){super(),this.actionId=e}render(){super.render();var e="#"+this.actionId,t=document.createElement("a"),i=(t.innerText=a.i18n.gettext("Create"),t.classList.add("btn","btn-light"),t.href=e+"&view_type=form",document.createElement("a")),e=(i.innerText=a.i18n.gettext("Search"),i.classList.add("btn","btn-light"),i.href=e,document.createElement("div"));e.className="portlet-footer",e.append(t),e.append(i),this.element.append(e)}dump(){return{tag:this.tagName.toLowerCase(),name:this.info.name,model:this.model,action:this.action,info:this.info.info}}load(e){super.load(e),this.action=e.action,this.model=e.model}}t.ModelActionPortlet=l;class c extends s{create(){super.create(),this.classList.add("portlet-goto-list")}dump(){return{tag:this.tagName.toLowerCase(),action:this.action,viewType:this.viewType}}render(){document.createElement("h6").innerText="Goto List"}}t.GotoList=c;class h extends s{create(){super.create(),this.classList.add("portlet-goto-report")}load(e){super.load(e),this.action=e.action,this.model=e.model}dump(){return{tag:this.tagName.toLowerCase(),name:this.info.name,model:this.model,action:this.action,info:this.info.info}}render(){var e=document.createElement("a");e.classList.add("full-size"),super.render(e),e.href=a.webApp.formatActionHref(this.action),this.append(e)}}t.GotoReport=h,a.define("portlet-panel",r),a.define("portlet-editor",n),a.define("portlet-create-new",d),t.registry={ModelAction:l}}})(Katrid=Katrid||{}),(e=>{(e.admin||(e.admin={})).Messages=class{static message(e){switch(e.type){case"info":Katrid.Forms.Dialogs.Alerts.info(e.message);break;case"warning":case"warn":Katrid.Forms.Dialogs.Alerts.warning(e.message);break;case"sucess":case"ok":Katrid.Forms.Dialogs.Alerts.success(e.message);break;case"error":case"danger":Katrid.Forms.Dialogs.Alerts.error(e.message)}}}})(katrid=katrid||{}),(i=>{{var e=i.admin||(i.admin={});class t{constructor(e){this.response=e}process(e){e=e["katrid.admin.ResponseMessagesProcessor"];if(Array.isArray(e))for(var t of e)i.admin.Messages.message(t)}}e.ResponseMessagesProcessor=t,e.requestMiddleware=[],e.responseMiddleware=[t]}})(katrid=katrid||{}),(a=>{(a.BI||(a.BI={})).newPlot=function(e,t,i,s){return"hovermode"in(i=i||{})||(i.hovermode="closest"),i.separators||(i.separators=a.i18n.formats.DECIMAL_SEPARATOR+a.i18n.formats.THOUSAND_SEPARATOR),"responsive"in(s=s||{})||(s.responsive=!0),Plotly.newPlot(e,t,i,s)}})(Katrid=Katrid||{}),(a=>{var e;async function r(i,s=null,a="javascript",e){return new Promise((t,e)=>{require(["vs/editor/editor.main"],function(){var e=monaco.editor.create(i,{language:a,automaticLayout:!0,value:s});t(e)})})}(e=a.bi||(a.bi={})).createCodeEditor=r,e.showCodeEditor=async function(e,t){var i=document.createElement("div");i.className="code-editor";let s=new a.ui.Dialog({title:"Code Editor",buttons:["ok","cancel"]});return s.dialog.classList.add("code-editor-dialog"),e=await r(i,e,t),s.dialog.querySelector(".dialog-body").appendChild(i),s.dialog.addEventListener("close",()=>{monaco.editor.getModels().forEach(e=>e.dispose()),s.dialog.remove()}),"ok"===(t=await s.showModal())&&e.getModel().getValue()}})(katrid=katrid||{}),(e=>{(e.design||(e.design={})).WidgetDesigner=class{constructor(e,t){this.target=e,this.dragging=!1,this.moved=!1,this.gridX=8,this.gridY=8,this.locked=!1,this.designer=t}drawDesign(e){return this.draw=this.target.drawDesign(e),this._pointerDownHandler||(this._pointerDownHandler=e=>this.designMouseDown(e),this._pointerMoveHandler=e=>this.designMouseMove(e),this._pointerUpHandler=e=>this.designMouseUp(e),this.target.graphic.$el.addEventListener("pointerdown",this._pointerDownHandler),this.target.graphic.$el.addEventListener("pointermove",this._pointerMoveHandler),this.target.graphic.$el.addEventListener("pointerup",this._pointerUpHandler),this.target.graphic.$el.addEventListener("dblclick",e=>this.designer.widgetDoubleClick(this,e))),this.draw}destroyDesign(){this._pointerDownHandler&&(this.target.graphic.$el.removeEventListener("pointerdown",this._pointerDownHandler),this.target.graphic.$el.removeEventListener("pointermove",this._pointerMoveHandler),this.target.graphic.$el.removeEventListener("pointerup",this._pointerUpHandler))}getDesignRect(){return new DOMRect(this.target.x,this.target.y,this.target.width,this.target.height)}get pageY(){return this.target.y+this.target.parent.clientY}moveTo(e,t){this.target.x=e,this.target.y=t,this.update(this.target)}moveToParent(e){this.target.parent=e}moveBy(e,t){e=Math.max(this.target.x+e,0),t=this.target.y+t;this.draw.attr("transform",`translate(${e}, ${t})`),this.target.x=e,this.target.y=t}get page(){}resize(e,t){this.target.width=e,this.target.height=t,this.update(this.target)}update(e){e.redraw()}designMove(e,t){this.designer?.moveSelectionBy(e,t)}applyRect(e,t,i,s){this.target.x+=e,this.target.y+=t,this.target.width+=i,this.target.height+=s,this.update(this.target)}designApplyRect(e,t,i,s){this.designer.applyRectToSelection(e,t,i,s)}setRect(e,t,i,s){this.target.x=e,this.target.y=t,this.target.width=i,this.target.height=s,this.update(this.target)}designMouseDown(e){0===e.button&&(e.preventDefault(),e.stopPropagation(),this.moved=!1,this.designer.dragging=this.dragging=!0,e.target.setPointerCapture(e.pointerId),this._dx=e.clientX,this._dy=e.clientY,this.designer.snapToGrid&&(this._dx=Math.trunc(this._dx/this.gridX)*this.gridX,this._dy=Math.trunc(this._dy/this.gridY)*this.gridY),e.shiftKey?this.designer.toggleSelection(this.target):this.designer.selectObject(this.target),this.designer.createGuidelines())}designMouseMove(i){if(this.dragging){i.preventDefault(),i.stopPropagation();let e=i.clientX,t=i.clientY;this.designer.snapToGrid&&!i.ctrlKey&&(e=Math.trunc(e/this.designer.gridX)*this.designer.gridX,t=Math.trunc(t/this.designer.gridY)*this.designer.gridY);var i=e-this._dx,s=t-this._dy;(i||s)&&(this.moved=!0,this.designer.clearGuidelines(),this.designMove(i,s),this.designer.undoManager.beginUpdate(),e&&(this._dx=e),t&&(this._dy=t),this.designer.createGuidelines())}}dump(){return{locked:this.locked}}load(e){this.locked=e.locked}_mouseUp(){this.moved&&this.designer.onSelectionMoved()}designMouseUp(e){this.designer.clearGuidelines(),this.designer.undoManager.endUpdate(),this.designer.dragging=this.dragging=!1,e.target.releasePointerCapture(e.pointerId),e.stopPropagation(),this.designer.clearGuidelines(),this._mouseUp(),this.moved=!1}}})(katrid=katrid||{}),(t=>{{var e=t.drawing||(t.drawing={});class i{get clientY(){return this.y+this.parent.clientY}get clientX(){return this.x+this.parent.clientX}constructor(){this._created=!1,this.defaultProps(),this._create()}defaultProps(){this.x=0,this.y=0,this.width=0,this.height=0}_create(){this._created||(this._created=!0,this.create())}get location(){return{x:this.x,y:this.y}}set location(e){this.x=e.x,this.y=e.y,this.redraw()}get size(){return{width:this.width,height:this.height}}set size(e){this.width=e.width,this.height=e.height,this.redraw()}drawTo(e){this._create(),this.redraw(),e.append(this.graphic)}drawDesign(e){return this._create(),this.redraw(),this.graphic.attr("class","widget-designer"),this.graphic}create(){this.graphic=e.g({transform:`translate(${this.x},${this.y})`}),this.element=this.graphic.$el}redraw(){this.graphic.attr("transform",`translate(${this.x},${this.y})`)}remove(){this.parent&&this.parent.objects.includes(this)&&this.parent.objects.splice(this.parent.objects.indexOf(this),1),this.element.remove()}getDesignRect(){return this.parent?new DOMRect(this.parent.x+this.x,this.clientY,this.width,this.height):new DOMRect(this.x,this.y,this.width,this.height)}getType(){return this.constructor.name}dump(){return{type:this.getType(),name:this.name,x:this.x,y:this.y,width:this.width,height:this.height,objects:this.objects?.map(e=>e.dump())}}load(e){this.name=e.name,this.x=e.x||e.left||0,this.y=e.y||e.top||0,this.width=e.width,this.height=e.height,e.objects&&this.loadObjects(e)}getClassByName(e){return t.report[e]}children(){return this.objects}loadObjects(e){for(var t of e.objects){var i=this.getClassByName(t.type);void 0===i?console.error(`Class ${t.type} not found`):(i=new i,this.objects.push(i),i.page=this.page,i.parent=this,i.load(t))}}}e.BaseWidget=i;class s extends i{defaultProps(){super.defaultProps(),this.width=100,this.height=100}create(){this.element||(this.graphic=e.g({transform:`translate(${this.x},${this.y})`}),this.element=this.graphic.$el,this.rect=this.graphic.rect(0,0,this.width,this.height))}redraw(){super.redraw(),this.rect.attr("width",this.width),this.rect.attr("height",this.height)}}e.Rectangle=s}})(katrid=katrid||{}),(e=>{{var t=e.drawing||(e.drawing={});class i extends t.BaseWidget{constructor(){super(...arguments),this.transparent=!1}defaultProps(){super.defaultProps(),this.height=50,this.width=50}dump(){return Object.assign(super.dump(),{field:this.field,dataSource:this.datasource?.name,picture:this.picture,center:this.center,transparent:this.transparent,format:this.format,width:this.width,height:this.height})}load(e){super.load(e),this.field=e.field,this.picture=e.picture,this.transparent=e.transparent,this.format=e.format,this.center=e.center,e.datasource&&(this.datasource=this.report.findObject(e.datasource))}create(){super.create(),this.img=e.drawing.draw("image",{x:0,y:0,width:this.width,height:this.height}),this.graphic.append(this.img),this._rect=this.graphic.rect(0,0,this.width,this.height)}redraw(){super.redraw(),this.picture&&this.img.attr("src",`data:image/${this.format};base64, `+this.picture),this.img.attr("width",this.width),this.img.attr("height",this.height),this._rect.attr("width",this.width),this._rect.attr("height",this.height)}}t.Image=i}})(katrid=katrid||{}),(e=>{{var i=e.drawing||(e.drawing={});class t extends i.BaseWidget{create(){this.graphic=i.g({transform:`translate(${this.x},${this.y})`});var e=i.draw("foreignObject",{x:0,y:0,width:this.width,height:this.height}),t=this._div=document.createElement("div");t.className="text-object",this.textElement=document.createElement("span"),t.append(this.textElement),e.$el.append(t),this.foreignObject=e.$el,this.graphic.append(e),this.element=this.graphic.$el,this.text=this._text}defaultProps(){super.defaultProps(),this.height=20,this.width=100,this.wrap=!1,this.allowExpression=!0,this.canGrow=!1,this.allowTags=!1}get text(){return this._text}set text(e){this._text=e,this.textElement&&(this.textElement.innerHTML=e)}get background(){return this._background}set background(e){this._background=e,this.applyStyle()}get displayFormat(){return this._displayFormat}set displayFormat(e){this._displayFormat=e}get border(){return this._border}set border(e){this._border=e,this.applyStyle()}get font(){return this._font||(this._font={name:"Helvetica",size:"9pt",color:"#000000"}),this._font}set font(e){this._font=e,this.applyStyle()}get hAlign(){return this._hAlign}set hAlign(e){this._hAlign=e,this.applyStyle()}get vAlign(){return this._vAlign}set vAlign(e){this._vAlign=e,this.applyStyle()}applyStyle(){if(null==this.border?this._div.style.border="none":(this._div.style.border="none",this.border.all?this._div.style.border="1px solid gray":(this.border.left&&(this._div.style.borderLeft="1px solid gray"),this.border.right&&(this._div.style.borderRight="1px solid gray"),this.border.top&&(this._div.style.borderTop="1px solid gray"),this.border.bottom&&(this._div.style.borderBottom="1px solid gray"))),this.font&&(this._div.style.fontFamily="",this.font.name&&(this._div.style.fontFamily=this.font.name),this.font.size&&(this._div.style.fontSize=this.font.size.toString()+"pt"),this._div.style.fontStyle=null,this.font.italic&&(this._div.style.fontStyle="italic"),this._div.style.fontWeight=null,this.font.bold&&(this._div.style.fontWeight="bold"),this._div.style.textDecoration=null,this.font.underline&&(this._div.style.textDecoration="underline"),this.font.color)&&(this._div.style.color=this.font.color),this._background&&(this._div.style.background=this._background.color),null!=this._vAlign)switch(this._vAlign){case i.VAlign.bottom:this._div.style.verticalAlign="bottom";break;case i.VAlign.middle:this._div.style.verticalAlign="middle";break;default:this._div.style.verticalAlign="top"}if(null!=this._hAlign)switch(this._hAlign){case i.HAlign.center:this._div.style.textAlign="center";break;case i.HAlign.right:this._div.style.textAlign="right";break;case i.HAlign.justify:this._div.style.textAlign="justify";break;default:this._div.style.textAlign="left"}}dump(){var e=super.dump();return e.text=this.text,e.hAlign=this.hAlign,e.vAlign=this.vAlign,this._font&&(e.font=this._font),this._border&&(e.border=this._border),this.background&&(e.background=this.background),e.allowExpression=this.allowExpression,e.allowTags=this.allowTags,e.canGrow=this.canGrow,e.wrap=this.wrap,this._background&&(e.background=this._background),this._displayFormat&&(e.displayFormat=this._displayFormat),this.highlights&&(e.highlights=this.highlights),e}load(e){super.load(e),this.text=e.text,this.allowExpression=e.allowExpression,this.allowTags=e.allowTags,this.canGrow=e.canGrow,this.wrap=e.wrap,e.hAlign&&(this._hAlign=e.hAlign),e.vAlign&&(this._vAlign=e.vAlign),e.font&&(this._font=e.font),e.border&&(this._border=e.border),e.background&&(this._background=e.background),e.displayFormat&&(this._displayFormat=e.displayFormat),e.highlights?this.highlights=e.highlights:e.highlight&&(this.highlights=[e.highlight]),this.applyStyle()}redraw(){super.redraw(),this.foreignObject.setAttribute("width",this.width.toString()),this.foreignObject.setAttribute("height",this.height.toString()),this._div.style.width=this.width.toString()+"px",this._div.style.height=this.height.toString()+"px"}}i.Text=t}})(katrid=katrid||{}),(e=>{{e=e.drawing||(e.drawing={});class t extends e.BaseWidget{defaultProps(){super.defaultProps(),this.height=50,this.width=100}dump(){return Object.assign(super.dump(),{field:this.field,dataSource:this.datasource?.name,code:this.code,center:this.center,barcodeType:this.barcodeType,width:this.width,height:this.height})}load(e){super.load(e),this.field=e.field,this.code=e.code,this.barcodeType=e.barcodeType}redraw(){super.redraw(),this.graphic.clear(),this.graphic.rect(0,0,this.width,this.height),this.graphic.text(4,this.height/2,"BARCODE").attr("fill","black")}}e.Barcode=t}})(katrid=katrid||{}),(e=>{(e.bi||(e.bi={})).componentRegistry={text:e.drawing.Text,Text:e.drawing.Text,image:e.drawing.Image,Image:e.drawing.Image,Barcode:e.drawing.Barcode,barcode:e.drawing.Barcode}})(katrid=katrid||{}),(e=>{(e.bi||(e.bi={}))._DataSource=class{constructor(e,t){this.commandText=t,this.widgets=[],this._name=e}get name(){return this._name}set name(e){this._name=e;for(var t of this.widgets)t._datasourceName=e}dump(){return{name:this.name,commandText:this.commandText}}static fromJson(e){return new this(e.name,e.commandText)}async refresh(){var e,t;this.data=[],this.commandText&&(e=await Katrid.Services.Service.$post("/bi/studio/query/",{query:this.commandText}),this.data=e.data);for(t of this.widgets)t.dataNotification(this)}get dataView(){return this.data}values(t){return this.dataView?this.dataView.map(e=>e[t]):[]}bind(e){-1===this.widgets.indexOf(e)&&this.widgets.push(e)}unbind(e){this.widgets.splice(this.widgets.indexOf(e),1)}}})(katrid=katrid||{}),(e=>{{var s=e.bi||(e.bi={});s.GUIDELINE_DELAY=2e3,s.BasePageDesigner=class{constructor(e,t,i){this.container=e,this.page=t,this.reportDesigner=i,this.dragging=!1,this.snapToGrid=!1,this.selectionBox=!1,this.draggingSelectionBox=!1,this._dx=0,this._dy=0,this._bx=0,this._by=0,this._bw=0,this._bh=0,t.designing=!0,(t.designer=this).selection=[],this.grabs=[]}activate(){this._documentKeyDown&&document.removeEventListener("keydown",this._documentKeyDown),this._documentKeyDown=e=>this.onKeyDown(e),document.addEventListener("keydown",this._documentKeyDown),this.container.append(this.el),this.reportDesigner.activatePage(this.page)}deactivate(){this.clearSelection(),this.el?.parentElement&&this.el.parentElement.removeChild(this.el),document.removeEventListener("keydown",this._documentKeyDown),this._documentKeyDown=null}get report(){return this.page.report}onKeyDown(e){if(!this.selection?.length||e.altKey||e.altKey)!this.selectedBand||e.altKey||e.metaKey||e.ctrlKey||"Delete"===e.key&&this.deleteSelection();else if(e.shiftKey)switch(e.key){case"ArrowDown":e.ctrlKey,this.resizeSelectionBy(0,1);break;case"ArrowUp":e.ctrlKey,this.resizeSelectionBy(0,-1);break;case"ArrowLeft":e.ctrlKey,this.resizeSelectionBy(-1,0);break;case"ArrowRight":e.ctrlKey,this.resizeSelectionBy(1,0)}else switch(e.key){case"ArrowDown":e.ctrlKey?this.moveSelectionBy(0,-1*this.gridY):this.moveSelectionBy(0,-1),this._tempGuidelines();break;case"ArrowUp":e.ctrlKey?this.moveSelectionBy(0,+this.gridY):this.moveSelectionBy(0,1),this._tempGuidelines();break;case"ArrowLeft":e.ctrlKey?this.moveSelectionBy(+this.gridX,0):this.moveSelectionBy(1,0),this._tempGuidelines();break;case"ArrowRight":e.ctrlKey?this.moveSelectionBy(-1*this.gridX,0):this.moveSelectionBy(-1,0),this._tempGuidelines();break;case"Delete":this.deleteSelection()}}resizeSelectionBy(e,t){for(var i of this.selection)i.resize(i.width+e,i.height+t);this.refreshGrabs(),this.guidelines?.length&&(clearTimeout(this._resizingTimeout),this._resizingTimeout=setTimeout(()=>this.clearGuidelines(),s.GUIDELINE_DELAY))}refreshGrabs(){for(var e of this.grabs)e.setPosition()}clearGuidelines(){if(this.guidelines)for(var e of this.guidelines)e.remove();this.guidelines=[]}clearSelection(){this.destroyGrabHandles(),this.selection=[],this.reportDesigner.onSelectionChange(this.selection)}addToSelection(e){this.selection.includes(e)||(this.selection.push(e),this.createGrabHandles(e)),this.reportDesigner.onSelectionChange(this.selection)}destroyGrabHandles(e){for(var t of Array.from(this.grabs))e&&t.target!==e||(t.destroy(),this.grabs.splice(this.grabs.indexOf(t),1))}createGrabHandles(e){var t=new i({container:this.container,target:e,onObjectResizing:()=>e.onDesignResizing(),onObjectResized:()=>e.onDesignResized(),snapToGrid:!1});this.grabs.push(t)}createElement(e,t,i,s){}selectObject(e){this.selection.includes(e)||this.clearSelection(),this.addToSelection(e)}removeFromSelection(e){this.selection.includes(e)&&(this.destroyGrabHandles(e),this.selection.splice(this.selection.indexOf(e),1)),this.reportDesigner.onSelectionChange(this.selection)}moveSelectionBy(e,t){for(var i of this.selection)i.designMoveBy(e,t);for(var s of this.grabs)s.setPosition()}deleteSelection(){var e,t;this.selection.length;for(e of this.selection)e.remove();for(t of this.grabs)t.destroy();this.grabs=[],this.reportDesigner.onSelectionChange()}onPointerDown(e){this.selectionBox&&0===e.button&&(this.draggingSelectionBox=!0,this._dx=e.layerX,this._dy=e.layerY,this._bx=this._by=this._bw=this._bh=0,this.createSelectionBox(this._dx,this._dy,0,0))}createSelectionBox(e,t,i,s){this._selBox=document.createElement("div"),this._selBox.className="designer-selection-box",$(this._selBox).css({left:e,top:t,width:i,height:s}),this.container.append(this._selBox)}destroySelectionBox(){this._selBox.remove()}updateSelectionBox(e,t,i,s){$(this._selBox).css({left:e,top:t,width:i,height:s}),this._bx=e,this._by=t,this._bw=i,this._bh=s}onPointerUp(e){this.selectionBox&&(this.clearGuidelines(),this.draggingSelectionBox)&&(this.draggingSelectionBox=!1,this.refreshSelection(),this.destroySelectionBox())}refreshSelection(){this.selection?.length||this.reportDesigner.onSelectionChange([this.page])}onMouseMove(a){if(this.draggingSelectionBox){a.preventDefault();let e=this._dx,t=this._dy,i=a.layerX-this._dx,s=a.layerY-this._dy;i<0&&(e+=i,i=Math.abs(i)),s<0&&(t+=s,s=Math.abs(s)),this.updateSelectionBox(e,t,i,s)}}};class i{constructor(e){this.dragging=!1,this.gridX=0,this.gridY=0,this.snapToGrid=!1,this.container=e.container,this.target=e.target,this.onObjectResized=e.onObjectResized,this.onObjectResizing=e.onObjectResizing,this.handles=[],this.createHandles(),this.setPosition(),e.snapToGrid&&(this.gridX=e.gridX,this.gridY=e.gridY,this.snapToGrid=!0)}createHandle(){var e=document.createElement("label");return e.classList.add("target-handle"),this.handles.push(e),e}clear(){for(var e of this.handles)e.remove();this.handles=[]}setPosition(){var e=this.target.getDesignRect();let t=new a(this.bottomLeft);t.left=e.left-3,t.top=e.bottom-5,(t=new a(this.middleLeft)).left=e.left-3,t.top=e.bottom-e.height/2-4,(t=new a(this.topLeft)).left=e.left-3,t.top=e.top-3,(t=new a(this.topRight)).left=e.right-4,t.top=e.top-3,(t=new a(this.middleRight)).left=e.right-4,t.top=e.bottom-e.height/2-4,(t=new a(this.bottomRight)).left=e.right-4,t.top=e.bottom-5,(t=new a(this.topCenter)).left=e.right-e.width/2-4,t.top=e.top-3,(t=new a(this.bottomCenter)).left=e.right-e.width/2-4,t.top=e.bottom-5}_setGrabHandle(){let d,l,n,o;this.topLeft.addEventListener("pointerdown",e=>{let t=e.target,s=(d=e.clientY,l=e.clientX,this.snapToGrid&&(l=Math.trunc(l/this.gridX)*this.gridX,d=Math.trunc(d/this.gridY)*this.gridY),this.target),a=(o=s.height,n=s.width,{left:s.left,top:s.top}),i=(this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=i.clientY,t=i.clientX;this.snapToGrid&&(t=Math.trunc(t/this.gridX)*this.gridX,e=Math.trunc(e/this.gridY)*this.gridY),(t||e)&&(e=d-e,t=l-t,s.left=a.left-t,s.top=a.top-e,s.height=o+e,s.width=n+t,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),r=e=>{t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",i),t.removeEventListener("pointerup",r))};t.addEventListener("pointermove",i),t.addEventListener("pointerup",r,{once:!0})}),this.topRight.addEventListener("pointerdown",e=>{let t=e.target,s=(d=e.screenY,l=e.screenX,this.snapToGrid&&(l=Math.trunc(l/this.gridX)*this.gridX,d=Math.trunc(d/this.gridY)*this.gridY),this.target),a=s.height,r=s.width,n={left:s.left,top:s.top},i=(this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=i.screenY,t=i.screenX;this.snapToGrid&&(t=Math.trunc(t/this.gridX)*this.gridX,e=Math.trunc(e/this.gridY)*this.gridY),(t||e)&&(e=d-e,t=l-t,s.left=n.left,s.top=n.top-e,s.height=a+e,s.width=r-t,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),o=e=>{t.setPointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",i),t.removeEventListener("pointerup",o))};t.addEventListener("pointermove",i),t.addEventListener("pointerup",o,{once:!0})}),this.bottomRight.addEventListener("pointerdown",e=>{let t=e.target,s=(d=e.clientY,l=e.clientX,this.snapToGrid&&(l=Math.trunc(l/this.gridX)*this.gridX,d=Math.trunc(d/this.gridY)*this.gridY),this.target),i=(n=s.width,o=s.height,this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=d-i.clientY,t=l-i.clientX;this.snapToGrid&&(t=Math.trunc(t/this.gridX)*this.gridX,e=Math.trunc(e/this.gridY)*this.gridY),(t||e)&&(s.height=o-e,s.width=n-t,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),a=e=>{t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",i),t.removeEventListener("pointerup",a))};t.addEventListener("pointermove",i),t.addEventListener("pointerup",a)}),this.middleLeft.addEventListener("pointerdown",e=>{let t=e.target,i=(l=e.clientX,this.snapToGrid&&(l=Math.trunc(l/this.gridX)*this.gridX),this.target),s=(n=i.width,i.left),a=(this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),this.dragging){let e=t.clientX;(e=this.snapToGrid?Math.trunc(e/this.gridX)*this.gridX:e)&&(e=l-e,i.left=s-e,i.width=n+e,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),r=e=>{t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",a),t.removeEventListener("pointerup",r))};t.addEventListener("pointermove",a),t.addEventListener("pointerup",r)}),this.middleRight.addEventListener("pointerdown",e=>{let t=e.target,i=(l=e.clientX,this.snapToGrid&&(l=Math.trunc(l/this.gridX)*this.gridX),this.target),s=(n=i.width,this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),t.stopPropagation(),this.dragging){let e=t.clientX;(e=this.snapToGrid?Math.trunc(e/this.gridX)*this.gridX:e)&&(e=l-e,i.width=n-e,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),a=e=>{t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",s),t.removeEventListener("pointerup",a))};t.addEventListener("pointermove",s),t.addEventListener("pointerup",a)}),this.bottomCenter.addEventListener("pointerdown",e=>{let t=e.target,i=(d=e.clientY,this.snapToGrid&&(d=Math.trunc(d/this.gridY)*this.gridY),this.target),s=(o=i.height,this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),this.dragging){let e=t.clientY;(e=this.snapToGrid?Math.trunc(e/this.gridY)*this.gridY:e)&&(e=d-e,i.height=o-e,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),a=e=>{t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",s),t.removeEventListener("pointerup",a))};t.addEventListener("pointermove",s),t.addEventListener("pointerup",a)}),this.topCenter.addEventListener("pointerdown",e=>{let t=e.target,i=(d=e.clientY,this.snapToGrid&&(d=Math.trunc(d/this.gridY)*this.gridY),this.target),s=(o=i.height,i.top),a=(this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),this.dragging){let e=t.clientY;(e=this.snapToGrid?Math.trunc(e/this.gridY)*this.gridY:e)&&(e=d-e,i.top=s-e,i.height=o+e,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),r=e=>{t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",a),t.removeEventListener("pointerup",r))};t.addEventListener("pointermove",a),t.addEventListener("pointerup",r)}),this.bottomLeft.addEventListener("pointerdown",e=>{let t=e.target,s=(d=e.clientY,l=e.clientX,this.snapToGrid&&(l=Math.trunc(l/this.gridX)*this.gridX,d=Math.trunc(d/this.gridY)*this.gridY),this.target),a=(o=s.height,n=s.width,s.left),i=(this.dragging=!0,e.stopPropagation(),e.preventDefault(),t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=i.clientY,t=i.clientX;this.snapToGrid&&(t=Math.trunc(t/this.gridX)*this.gridX,e=Math.trunc(e/this.gridY)*this.gridY),(t||e)&&(e=d-e,t=l-t,s.height=o-e,s.left=a-t,s.width=n+t,this.setPosition(),this.onObjectResizing)&&this.onObjectResizing({target:this.target})}}),r=e=>{t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.onObjectResized&&this.onObjectResized({target:this.target}),t.removeEventListener("pointermove",i),t.removeEventListener("pointerup",r))};t.addEventListener("pointermove",i),t.addEventListener("pointerup",r)})}createHandles(){let e;return this.bottomLeft=e=this.createHandle(),e.classList.add("bottom-left"),this.container.append(e),this.middleLeft=e=this.createHandle(),e.classList.add("middle-left"),this.container.append(e),this.topLeft=e=this.createHandle(),e.classList.add("top-left"),this.container.append(e),this.topRight=e=this.createHandle(),e.classList.add("top-right"),this.container.append(e),this.middleRight=e=this.createHandle(),e.classList.add("middle-right"),this.container.append(e),this.bottomRight=e=this.createHandle(),e.classList.add("bottom-right"),this.container.append(e),this.topCenter=e=this.createHandle(),e.classList.add("top-center"),this.container.append(e),this.bottomCenter=e=this.createHandle(),e.classList.add("bottom-center"),this.container.append(e),this.setPosition(),this._setGrabHandle(),this}destroy(){for(var e of this.handles)e.remove();this.handles=[]}}s.GrabHandles=i;class a{constructor(e){this.el=e}set left(e){this.el.style.left=e+"px"}set top(e){this.el.style.top=e+"px"}set width(e){this.el.style.width=e+"px"}set height(e){this.el.style.height=e+"px"}}}})(katrid=katrid||{}),(h=>{(h.bi||(h.bi={})).ReportDesigner=class{constructor(e){this.container=e,this.loading=!1,this.pages=[],this.create(),h.bi.reportDesigner=this}create(){this._datasources=[],this.workspace=document.createElement("div"),this.workspace.className="katrid-studio workspace",this.el=document.createElement("div"),this.el.className="katrid-report-designer workspace-area";var e=document.createElement("div"),t=(e.className="tabset",document.createElement("ul")),t=(t.className="nav nav-tabs",e.append(t),this.tabsetElement=e,this.container.append(e),this.container.append(this.workspace),this.toolbox=new h.bi.Toolbox(this.workspace),this.workspace.append(this.el),this.toolWindow=new h.bi.ToolWindow(this,this.workspace),this.container.classList.add("report-designer"),this.createDragEvents(),document.querySelectorAll(".toolbox-item").forEach((t,e)=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{this.page.clearSelection(),e.dataTransfer.setData("text",t.getAttribute("data-widget"))})}),document.querySelectorAll(".toolbox-item img").forEach(e=>e.setAttribute("draggable","false")),document.querySelector("#properties-editor"));this.propertiesEditor=new h.bi.ObjectInspector(this,t)}onSelectionChange(e){e?this.propertiesEditor.setSelection(e):this.propertiesEditor.setSelection([]),$(this).trigger("selectionChange",e)}get datasources(){return this._datasources}createDragEvents(){this.container.addEventListener("dragover",e=>{e.target.closest(".band-designer")&&e.preventDefault()}),this.container.addEventListener("drop",e=>{e.stopPropagation(),e.preventDefault(),this.toolItemDrop(e.dataTransfer.getData("text"),e)})}toolItemDrop(e,t){this.createElement(e,t.target,t.offsetX,t.offsetY)}createElement(e,t,i,s){this.page.createElement(e,t,i,s)}newReport(e="banded"){var t;return this.clear(),"banded"===e?((t=new BandedReport).newPage(),this.loadReport(t),t):"dashboard"===e?((t=new DashboardReport).newPage(),this.loadReport(t),t):void 0}get report(){return this._report}set report(e){this._report=e}get page(){return this._page}set page(e){e!==this._page&&(this._page&&this._page.deactivate(),this._page=e)&&(e.activate(),this.el.append(e.container))}getValidName(e){return this._report.getValidName(e)}async showParamsDialog(){var t=this.report.params;if(t){t=jQuery.parseXML(t);let e="";var i,s=this.report.cache.params||{},a={};for(i of t.querySelector("params").children){var r=i.getAttribute("name"),n=i.getAttribute("label"),o=i.getAttribute("type")||"StringField";a[r]={label:n,type:o},e+=`${r}: ${s[r]||"null"}    # ${n} (${o})\n`}t=await h.bi.showCodeEditor(e.trimEnd(),"yaml",null);if(!1!==t){var d,l,c=jsyaml.load(t);for([d,l]of Object.entries(c))null!=l&&"DateField"===a[d].type&&(c[d]=moment.utc(l).format("YYYY-MM-DD"));return{values:this.report.cache.params=c,info:a}}}}async preview(e=!1){let t;e&&!1===(t=await this.showParamsDialog())||await new Katrid.Services.ModelService("ui.action.report").rpc("preview",[JSON.stringify(this.dump()),{values:t.values,info:t.info}])}loadReport(e){this.clear(),this._report=e,this._datasources=e.datasources;for(var t of this._datasources)this.toolWindow.registerDataSource(t);for(var i of e.pages)this.pages.push(this.createPageDesigner(i));this.pages.length&&(this.page=this.pages[0])}createPageDesigner(e){var t=document.createElement("div");return t.className="page-designer",e.createDesigner(t,this)}async widgetExecuteEditor(e){var t=h.bi.getComponentEditor(e.constructor);t&&await new t(e).showEditor()}async showOpenFilePicker(){[this.fileHandle]=await window.showOpenFilePicker({types:[{description:"Reptile Report (*.report)",accept:{"application/json":[".report"]}}]});var e=await this.fileHandle.getFile(),t=await e.text();this.load(JSON.parse(t),e.name)}async showSaveFilePicker(){this.fileHandle||(this.fileHandle=await window.showSaveFilePicker({types:[{description:"Reptile Report (*.report)",accept:{"application/json":[".report"]}}]}));var e=await this.fileHandle.createWritable(),t=(console.log("content",this._report.dump),this.dump(),new Blob([JSON.stringify(this.dump())],{type:"application/json"}));await e.write(t),await e.close()}removeObjectNotification(e){if(!this.loading)for(var t of Array.from(this._report.objects()))t.onRemoveObjectNotification(e)}dump(){return this._report.dump()}load(e,t){this.clear();let i;e=e.report;return(i="banded"===e.type?new BandedReport:i).load(e),this.loadReport(i),this.filename=t,i}set filename(e){console.log("set filename",e),document.title=e?e+" - Report Editor":"Report Editor"}clear(){this.toolWindow.clear(),this._page&&this._page.deactivate(),this.filename="",this.fileHandle=null,this.pages=[],this._report=null}registerDataSource(e){e.report=this._report,this._datasources.includes(e)||(this._datasources.push(e),this.toolWindow.registerDataSource(e))}}})(katrid=katrid||{}),(e=>{var t;(e=e.drawing||(e.drawing={})).Component=class{getType(){return this.constructor.name}dump(){return{type:this.getType(),name:this.name}}load(e){this.name=e.name}},e.pageSizes={A3:{width:1122,height:1587},A4:{width:794,height:1122},A5:{width:583,height:794},Letter:{width:816,height:1071},Auto:{width:-1,height:-1},Custom:{width:0,height:0},Responsive:{width:"100%",height:-1},WebSmall:{width:768,height:1024},WebMedium:{width:1024,height:768},WebLarge:{width:1280,height:1024}},(t=e.PageOrientation||(e.PageOrientation={}))[t.Portrait=0]="Portrait",t[t.Landscape=1]="Landscape",(t=e.HAlign||(e.HAlign={}))[t.left=0]="left",t[t.center=1]="center",t[t.right=2]="right",t[t.justify=3]="justify",(t=e.VAlign||(e.VAlign={}))[t.top=0]="top",t[t.middle=1]="middle",t[t.bottom=2]="bottom"})(katrid=katrid||{}),!function(katrid){var design;!function(design){var HAlign=katrid.drawing.HAlign,VAlign=katrid.drawing.VAlign;class PropertyEditor{static{this.tag="input"}constructor(e,t){this.name=e,this.config=t,this.caption=t?.caption,this.description=t?.description,this.placeholder=t?.placeholder,this.title=t?.title}createEditor(e){var t=document.createElement("section"),i=(t.classList.add("form-group","col-12"),t.setAttribute("prop-name",this.name),t.classList.add("property-editor"),this.caption&&this.createLabel(t),this.cssClass&&t.classList.add(this.cssClass),this.createInput(e)),e=this.getValue(e);return this.setValue(e,i),t.append(i),this.title&&(t.title=this.title),t}setValue(e,t){null!=e&&(t.value=e)}createLabel(e){var t=document.createElement("label");t.innerText=this.caption||this.name,t.className="control-label",e.appendChild(t)}createInput(e){var t=document.createElement(this.constructor.tag);return t.classList.add("form-control"),this.placeholder&&(t.placeholder=this.placeholder),this.createInputEvent(e,t),t}createInputEvent(t,i){i.addEventListener("change",e=>this.inputChange(t,i,e))}inputChange(e,t,i){this.apply(e,t.value)}getValue(e){return e.targetObject[this.name]}apply(e,t){e.targetObject[this.name]=t}}design.PropertyEditor=PropertyEditor;class StringProperty extends PropertyEditor{createInput(e){e=super.createInput(e);return e.spellcheck=!1,e}}design.StringProperty=StringProperty;class NameStringProperty extends PropertyEditor{}design.NameStringProperty=NameStringProperty;class TextProperty extends StringProperty{static{this.tag="textarea"}}design.TextProperty=TextProperty;class IntegerProperty extends PropertyEditor{createInput(e){e=super.createInput(e);return e.type="number",e}}design.IntegerProperty=IntegerProperty;class AutocompleteProperty extends StringProperty{}design.AutocompleteProperty=AutocompleteProperty;let CONTROL_COUNT=0;class BooleanProperty extends PropertyEditor{createEditor(e){var t=document.createElement("section");t.className="col-12 property-editor",t.innerHTML=`<div class="form-check"><input class="form-check-input" type="checkbox" id="_el-input-${++CONTROL_COUNT}"><label class="form-check-label" for="_el-input-${CONTROL_COUNT}">${this.caption}</label></div>`;let i=t.querySelector("input");return i.checked=this.getValue(e),i.addEventListener("change",()=>e.targetObject[this.name]=i.checked),t}}design.BooleanProperty=BooleanProperty;class BackgroundProperty extends PropertyEditor{createEditor(e){var t=document.createElement("section");t.className="col-12 property-editor",t.innerHTML=`
      <table>
      <tr>
      <td><label>Background</label></td>
      <td style="width:100%">
      <input class="form-control" type="color" name="background-color">
      </td></tr>
      </table>
      `;let i=this.getValue(e)||{},s=t.querySelector('input[name="background-color"]');return i.color?s.value=i.color:s.value="#FFFFFF",s.addEventListener("change",()=>{i.color=s.value,e.targetObject.background=i}),t}}design.BackgroundProperty=BackgroundProperty;class FontProperty extends PropertyEditor{createEditor(e){var t,i=document.createElement("section");i.className="col-12 property-editor",i.style.textAlign="center",i.innerHTML=`
<table>
<tr>
<td>
<select class="form-select-sm" name="font-name">
<option value=""></option>
<option value="Arial">Arial</option>
<option value="Helvetica">Helvetica</option>
<option value="Times New Roman">Times New Roman</option>
<option value="Courier">Courier</option>
<option value="Courier New">Courier New</option>
</select>
</td>
<td>
<input class="form-control input-sm" type="number" name="font-size" value="9">
</td>
<td style="width:40px">
<input class="form-control input-sm" name="font-color" type="color">
</td>
</tr>
</table>
<div class="btn-group" style="width: 100%">
<input class="btn-check" type="checkbox" id="property-font-bold" name="font-bold">
<label class="btn btn-sm btn-outline-secondary" for="property-font-bold"><i class="fa-solid fa-bold"></i></label>
<input class="btn-check" type="checkbox" id="property-font-italic" name="font-italic">
<label class="btn btn-sm btn-outline-secondary" for="property-font-italic"><i class="fa-solid fa-italic"></i></label>
<input class="btn-check" type="checkbox" id="property-font-underline" name="font-underline">
<label class="btn btn-sm btn-outline-secondary" for="property-font-underline"><i class="fa-solid fa-underline"></i></label>
</div>
`;let s=this.getValue(e)||{},a=i.querySelector('input[name="font-bold"]'),r=(s.bold&&(a.checked=!0),a.addEventListener("change",()=>{s.bold=a.checked,e.targetObject.font=s}),i.querySelector('input[name="font-italic"]')),n=(s.italic&&(r.checked=!0),r.addEventListener("change",()=>{s.italic=r.checked,e.targetObject.font=s}),i.querySelector('input[name="font-underline"]')),o=(s.underline&&(n.checked=!0),n.addEventListener("change",()=>{s.underline=n.checked,e.targetObject.font=s}),i.querySelector('select[name="font-name"]')),d=(o.value=e.targetObject.font?.name,o.addEventListener("change",()=>{s.name=o.value,e.targetObject.font=s}),i.querySelector('input[name="font-color"]')),l=(d.value=e.targetObject.font?.color,d.addEventListener("change",()=>{s.color=d.value,e.targetObject.font=s}),i.querySelector('input[name="font-size"]'));return e.targetObject.font?.size&&(t=e.targetObject.font.size,l.value="number"==typeof t?t.toString():t.match(/(\d+)/)[0]),l.addEventListener("change",()=>{s.size=l.value,e.targetObject.font=s}),i}}design.FontProperty=FontProperty;class BorderProperty extends PropertyEditor{createEditor(e){var t=document.createElement("div");t.className="property-editor",t.style.textAlign="center",t.innerHTML=`
<div class="btn-group" style="width: 100%">
<input class="btn-check" type="checkbox" id="property-border-all" name="border-all">
<label class="btn btn-sm btn-outline-secondary" for="property-border-all"><i class="fa-duotone fa-border-all"></i></label>
<input class="btn-check" type="checkbox" id="property-border-top" name="border-top">
<label class="btn btn-sm btn-outline-secondary" for="property-border-top"><i class="fa-duotone fa-border-top"></i></label>
<input class="btn-check" type="checkbox" id="property-border-right" name="border-right">
<label class="btn btn-sm btn-outline-secondary" for="property-border-right"><i class="fa-duotone fa-border-right"></i></label>
<input class="btn-check" type="checkbox" id="property-border-bottom" name="border-bottom">
<label class="btn btn-sm btn-outline-secondary" for="property-border-bottom"><i class="fa-duotone fa-border-bottom"></i></label>
<input class="btn-check" type="checkbox" id="property-border-left" name="border-left">
<label class="btn btn-sm btn-outline-secondary" for="property-border-left"><i class="fa-duotone fa-border-left"></i></label>
</div>
      `;let i=this.getValue(e)||{},s=t.querySelector('input[name="border-all"]'),a=t.querySelector('input[name="border-top"]'),r=t.querySelector('input[name="border-right"]'),n=t.querySelector('input[name="border-bottom"]'),o=t.querySelector('input[name="border-left"]');return i.all?s.checked=!0:(a.checked=i.top,r.checked=i.right,n.checked=i.bottom,o.checked=i.left),s.addEventListener("change",()=>{i.all=s.checked,a.checked=r.checked=n.checked=o.checked=i.top=i.right=i.bottom=i.left=i.all,i.all?e.targetObject[this.name]=i:e.targetObject[this.name]=null}),a.addEventListener("change",()=>{i.top=a.checked,s.checked=i.all=this.allChecked(i),e.targetObject[this.name]=i}),r.addEventListener("change",()=>{i.right=r.checked,s.checked=i.all=this.allChecked(i),e.targetObject[this.name]=i}),n.addEventListener("change",()=>{i.bottom=n.checked,s.checked=i.all=this.allChecked(i),e.targetObject[this.name]=i}),o.addEventListener("change",()=>{i.left=o.checked,s.checked=i.all=this.allChecked(i),e.targetObject[this.name]=i}),t}allChecked(e){return e.top&&e.right&&e.bottom&&e.left}}design.BorderProperty=BorderProperty;class VAlignProperty extends PropertyEditor{createEditor(t){var e=document.createElement("div"),i=(e.className="property-editor",e.style.textAlign="center",e.innerHTML=`
<div class="btn-group" style="width: 100%">
<input class="btn-check" type="radio" id="property-valign-top" name="valign" value="0">
<label class="btn btn-sm btn-outline-secondary" for="property-valign-top"><i class="fa-duotone fa-objects-align-top"></i></label>
<input class="btn-check" type="radio" id="property-valign-middle" name="valign" value="1">
<label class="btn btn-sm btn-outline-secondary" for="property-valign-middle"><i class="fa-duotone fa-objects-align-center-vertical"></i></label>
<input class="btn-check" type="radio" id="property-valign-bottom" name="valign" value="2">
<label class="btn btn-sm btn-outline-secondary" for="property-valign-bottom"><i class="fa-duotone fa-objects-align-bottom"></i></label>
</div>
      `,this.getValue(t)||VAlign.top),s=e.querySelector("#property-valign-top"),a=e.querySelector("#property-valign-middle"),r=e.querySelector("#property-valign-bottom"),i=(s.checked=i===VAlign.top,a.checked=i===VAlign.middle,r.checked=i===VAlign.bottom,e=>t.targetObject[this.name]=parseInt(e.target.value));return s.addEventListener("change",i),a.addEventListener("change",i),r.addEventListener("change",i),e}}design.VAlignProperty=VAlignProperty;class HAlignProperty extends PropertyEditor{createEditor(t){var e=document.createElement("div"),i=(e.className="property-editor",e.style.textAlign="center",e.innerHTML=`
<div class="btn-group" style="width: 100%">
<input class="btn-check" type="radio" id="property-halign-left" name="halign" value="0">
<label class="btn btn-sm btn-outline-secondary" title="Align to left" for="property-halign-left"><i class="fa-duotone fa-align-left"></i></label>
<input class="btn-check" type="radio" id="property-halign-center" name="halign" value="1">
<label class="btn btn-sm btn-outline-secondary" title="Align to center" for="property-halign-center"><i class="fa-duotone fa-align-center"></i></label>
<input class="btn-check" type="radio" id="property-halign-right" name="halign" value="2">
<label class="btn btn-sm btn-outline-secondary" title="Align to right" for="property-halign-right"><i class="fa-duotone fa-align-right"></i></label>
<input class="btn-check" type="radio" id="property-halign-justify" name="halign" value="3">
<label class="btn btn-sm btn-outline-secondary" title="Justify" for="property-halign-justify"><i class="fa-duotone fa-align-justify"></i></label>
</div>`,this.getValue(t)||HAlign.left),s=e.querySelector("#property-halign-left"),a=e.querySelector("#property-halign-center"),r=e.querySelector("#property-halign-right"),n=e.querySelector("#property-halign-justify"),i=(s.checked=i===HAlign.left,a.checked=i===HAlign.center,r.checked=i===HAlign.right,n.checked=i===HAlign.justify,e=>t.targetObject[this.name]=parseInt(e.target.value));return s.addEventListener("change",i),a.addEventListener("change",i),r.addEventListener("change",i),n.addEventListener("change",i),e}}design.HAlignProperty=HAlignProperty;class DisplayFormatProperty extends PropertyEditor{createEditor(e){var t=document.createElement("div");t.className="property-editor",t.style.textAlign="center",t.innerHTML=`
      <table><tr>
      <td><select class="form-select" name="displayFormat"><option value=""></option>
        <option value="Numeric">Numeric</option>
        <option value="DateTime">DateTime</option>
        <option value="String">String</option>
      </select></td>
      <td><input class="form-control" type="text"></td>
      </tr></table>
`;let i=this.getValue(e)||{};var s=t.querySelector("input"),a=t.querySelector("select"),r=(i.type&&(a.value=i.type),i.format&&(s.value=i.format),()=>e.targetObject.displayFormat=i);return s.addEventListener("change",r),a.addEventListener("change",r),t}}design.DisplayFormatProperty=DisplayFormatProperty;class SelectProperty extends StringProperty{static{this.tag="select"}getValues(e){if(this.config.options)return Array.isArray(this.config.options)?this.config.options:Array.from(Object.entries(this.config.options).map(([e,t])=>({value:e.toString(),text:t.toString()})))}createInput(e){let t=super.createInput(e);t.className="form-select",t.innerHTML=`<option value="">(${this.caption||this.name})</option>`;for(var i of this.getValues(e)){var s=document.createElement("option");s.setAttribute("value",i.value),s.innerText=i.text,t.append(s)}return t.addEventListener("change",()=>this.selectItem(e,parseInt(t.value))),t}selectItem(e,t){}}design.SelectProperty=SelectProperty;class ComponentProperty extends SelectProperty{constructor(e,t){super(e,t),this.onGetValues=t.onGetValues}getValues(e){e=Array.from(this.onGetValues(e));return this.values=e.map(e=>e.value),e.forEach((e,t)=>e.value=t),e}selectItem(e,t){e.targetObject[this.name]=this.values[t]}setValue(e,t){if(e){e=this.values.indexOf(e);if(-1<e)return void(t.value=e.toString())}t.value=""}}function createInputGroup(e){var t=document.createElement("div"),i=(t.className="input-group input-group-sm",document.createElement("span")),e=(i.className="input-group-text",i.innerHTML=e,document.createElement("input"));return e.className="form-control input-xl",t.append(e),t.append(i),t}design.ComponentProperty=ComponentProperty;class LocationProperty extends PropertyEditor{createEditor(t){var e=document.createElement("section");e.classList.add("form-group","row","property-editor"),e.setAttribute("prop-name",this.name);let i=this.getValue(t),s=(this.caption&&this.createLabel(e),this.cssClass&&e.classList.add(this.cssClass),document.createElement("div")),a=(s.className="col-6",createInputGroup("x")),r=a.querySelector("input");return r.value=i?.x,r.addEventListener("blur",e=>t.setPropValue(this.name,{x:parseInt(e.target.value),y:i.y})),s.append(a),e.append(s),(s=document.createElement("div")).className="col-6",a=createInputGroup("y"),(r=a.querySelector("input")).addEventListener("blur",e=>t.setPropValue(this.name,{x:i.x,y:parseInt(e.target.value)})),r.value=i?.y,s.append(a),e.append(s),e}}design.LocationProperty=LocationProperty;class HeightProperty extends PropertyEditor{createEditor(t){var e=document.createElement("section"),i=(e.classList.add("form-group","row","property-editor"),e.setAttribute("prop-name",this.name),this.getValue(t)),s=(this.caption&&this.createLabel(e),this.cssClass&&e.classList.add(this.cssClass),document.createElement("div")),a=(s.className="col-12",createInputGroup('<i class="fa-regular fa-arrows-up-down"></i>')),r=a.querySelector("input");return r.type="number",r.addEventListener("blur",e=>t.setPropValue(this.name,parseInt(e.target.value))),r.value=i,s.append(a),e.append(s),this.title&&(e.title=this.title),e}}design.HeightProperty=HeightProperty;class SizeProperty extends PropertyEditor{createEditor(t){var e=document.createElement("section");e.classList.add("form-group","row","property-editor"),e.setAttribute("prop-name",this.name);let i=this.getValue(t),s=(this.caption&&this.createLabel(e),this.cssClass&&e.classList.add(this.cssClass),document.createElement("div")),a=(s.className="col-6",createInputGroup('<i class="fa-regular fa-arrows-left-right"></i>')),r=a.querySelector("input");return r.addEventListener("blur",e=>t.setPropValue(this.name,{width:parseInt(e.target.value),height:i.height})),r.value=i.width,s.append(a),e.append(s),(s=document.createElement("div")).className="col-6",a=createInputGroup('<i class="fa-regular fa-arrows-up-down"></i>'),(r=a.querySelector("input")).addEventListener("blur",e=>t.setPropValue(this.name,{width:i.width,height:parseInt(e.target.value)})),r.value=i.height,s.append(a),e.append(s),e}}design.SizeProperty=SizeProperty;let componentEditorRegistry=[];function findComponentEditor(t){for(var e of componentEditorRegistry)if(e.type===t)return e;for(let e=componentEditorRegistry.length-1;0<=e;e--){var i=componentEditorRegistry[e];if(i.type&&t.prototype instanceof i.type)return i}for(var s of componentEditorRegistry)if(void 0===s.type)return s}function registerComponentEditor(e,t){let i;for(var s of componentEditorRegistry)if(s.type===e){i=s;break}i?i.editor=t:(i={type:e,editor:t},componentEditorRegistry.push(i)),t.properties=t.defineProperties()}function getComponentEditor(e){e=findComponentEditor(e);return e?e.editor:ComponentEditor}design.findComponentEditor=findComponentEditor,design.registerComponentEditor=registerComponentEditor,design.getComponentEditor=getComponentEditor;class ComponentEditor{constructor(e,t){this.designer=t,this.targetObject=e}createEditor(){var e,t=document.createElement("div");for(e of this.constructor.properties)t.append(e.createEditor(this));return t}showEditor(){}static registerPropertyEditor(e,t){this.properties[e]=t}static defineProperties(){return[new StringProperty("name",{placeholder:"Object Name"})]}setPropValue(e,t){this.targetObject[e]=t,this.designer.updateSelectedObjects()}}design.ComponentEditor=ComponentEditor,registerComponentEditor(katrid.drawing.Component,ComponentEditor);class WidgetEditor extends ComponentEditor{static defineProperties(){return super.defineProperties().concat(new LocationProperty("location"),new SizeProperty("size"))}}design.WidgetEditor=WidgetEditor,registerComponentEditor(katrid.drawing.BaseWidget,WidgetEditor);class DataWidgetEditor extends ComponentEditor{static defineProperties(){return[new StringProperty("title",{caption:"Title"}),new DataSourceProperty("datasource",{caption:"Data Source"})]}}class DataSourceProperty extends SelectProperty{getValues(e){return e.designer.report.datasources.map(e=>({value:e,text:e.name}))}getValue(e){e=e.targetObject;if(e.datasource)return appStudio.dataSources.indexOf(e.datasource)}apply(e,t){e.targetObject.setDataSource(appStudio.dataSources[t])}}design.DataSourceProperty=DataSourceProperty;class ChartEditor extends WidgetEditor{async showEditor(){this.targetObject.code=await showCodeEditor(this.targetObject.code,"javascript","chart")}}class PieChartEditor extends ChartEditor{static defineProperties(){return super.defineProperties().concat(new AutocompleteProperty("values",{caption:"Values"}),new AutocompleteProperty("labels",{caption:"Labels"}))}}class DonutChartEditor extends PieChartEditor{}class BarChartEditor extends ChartEditor{static defineProperties(){return super.defineProperties().concat(new AutocompleteProperty("x",{caption:"X"}),new AutocompleteProperty("y",{caption:"Y"}))}}class LineChartEditor extends BarChartEditor{}async function showCodeEditor(o=null,d="javascript",l="table"){let c;return new Promise((n,e)=>{requirejs(["vs/editor/editor.main"],function(){let a=document.createElement("div");a.className="modal",a.tabIndex=-1,a.innerHTML=`<div class="modal-dialog modal-xl modal-fullscreen-md-down" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Code Editor</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      <div class="code-editor"></div>
      </div>
      <div class="modal-footer">
      <button type="button" class="btn-ok btn btn-outline-secondary">OK</button>
      <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>`;let r,e=new bootstrap.Modal(a);a.addEventListener("hidden.bs.modal",()=>{a.remove(),n(!1)}),e.show();var t=a.querySelector(".btn-ok");if(!c){var i=a.querySelector(".code-editor");let s=a.querySelector(".preview");if(c=monaco.editor.create(i,{lang:d}),"table"===l){let i=new Katrid.bi.TableWidget(s);c.onDidChangeModelContent(e=>{r&&clearTimeout(r),r=setTimeout(()=>{var e=a.getAttribute("preview-type"),t=(r=null,c.getModel().getValue());"table"===e?i.fromCode(t):"chart"===e?chartPreview(s,t):s.innerHTML=t},1e3)})}}let s=o;s||("javascript"===d?s=["({})"].join("\n"):"html"===d&&(s="<div></div>")),d&&monaco.editor.setModelLanguage(c.getModel(),d),c.getModel().setValue(s),c.focus(),t.addEventListener("click",()=>{n(c.getModel().getValue()),e.hide()})})})}design.showCodeEditor=showCodeEditor;let _lastChart=null;function chartPreview(preview,code){$(preview).empty(),_lastChart&&(Plotly.purge(_lastChart),_lastChart=null);let config=katrid.bi.getTraces(eval(code),this.studio);_lastChart=Plotly.newPlot(preview,config.traces,config.layout||{height:$(preview).height(),width:$(preview).width()},{responsive:!0})}function getTraces(e){var t=["datasource","x","y","values","labels"];if(e.traces instanceof Function){var i,s=[];for(i of e.traces()){var a={};if("string"==typeof i.datasource){var r,n=appStudio.findComponent(i.datasource);n.data&&(i.x&&(a.x=n.values(i.x)),i.y&&(a.y=n.values(i.y)),i.values&&(a.values=n.values(i.values)),i.labels)&&(a.labels=n.values(i.labels));for(r of Object.keys(i))t.includes(r)||(a[r]=i[r])}s.push(a)}e.traces=s}}async function createCodeEditor(i,s=null,a="javascript",e){return new Promise((t,e)=>{requirejs(["vs/editor/editor.main"],function(){let e=monaco.editor.create(i,{lang:a});setTimeout(()=>{e.layout()}),a&&monaco.editor.setModelLanguage(e.getModel(),a),s&&e.getModel().setValue(s),t(e)})})}design.createCodeEditor=createCodeEditor}(design=katrid.design||(katrid.design={}))}(katrid=katrid||{}),(e=>{{(e=e.bi||(e.bi={})).Field=class{constructor(){this.calculated=!1,this.client=!1}};class t{constructor(e){this.name=e,this._dataStored=!0}dump(){return{name:this.name,master:this.master?.name,data:this._dataStored?this.data:void 0}}load(e){this.name=e.name,this.data=e.data,e.master&&this.report.addLoadCallback(()=>this.master=this.report.findObject(e.master))}}e.DataSource=t;class i extends t{constructor(){super(...arguments),this._dataStored=!1}get sql(){return this._sql}set sql(e){this._sql=e,this._sql&&this.connection&&this.read()}dump(){var e=super.dump();return e.sql=this._sql,e}load(e){super.load(e),this._sql=e.sql}async read(){this.fields=null;var e=await new Katrid.Services.ModelService("ui.action.report").rpc("exec_sql",[this._sql,{}],{});return this.data=e.data,this.fields=e.fields,e}}e.SqlDataSource=i;class s extends t{constructor(){super(...arguments),this._dataStored=!1}dump(){var e=super.dump();return e.model=this.model,e.domain=this.domain,e.selectFields=this.selectFields,e.where=this.where,e}load(e){super.load(e),this.model=e.model,this.domain=e.domain,this.selectFields=e.selectFields,this.where=e.where}async read(){var e=await new Katrid.Services.ModelService(this.model).rpc("search",[this.domain,this.selectFields],{});return this.data=e.data,this.fields=e.fields,e}}e.ORMDataSource=s}})(katrid=katrid||{}),(e=>{{var i=e.drawing||(e.drawing={});i.BaseColumn=class{dump(){return{expression:this.expression,caption:this.caption}}};class t extends i.BaseWidget{constructor(){super(...arguments),this.columns=[]}defaultProps(){super.defaultProps(),this.height=100,this.width=200}create(){this.graphic=i.g({transform:`translate(${this.x},${this.y})`});var e=i.draw("foreignObject",{x:0,y:0,width:this.width,height:this.height}),t=this._div=document.createElement("div");t.className="grid",this.gridElement=document.createElement("table"),t.append(this.gridElement),e.$el.append(t),this.foreignObject=e.$el,this.graphic.append(e),this.element=this.graphic.$el,this.createTable()}createTable(){var e=this.gridElement.createTHead().appendChild(document.createElement("tr")),t=e.appendChild(document.createElement("th"));t.innerText="Column 1",t.style.cursor="pointer",t.addEventListener("click",e=>{this.thClick(e.target)}),e.appendChild(document.createElement("th")).innerText="Column 2",e.appendChild(document.createElement("th")).innerText="Column 3"}thClick(e){}dump(){var e=super.dump();return e.columns=this.columns.map(e=>e.dump()),e}}i.BaseGrid=t}})(katrid=katrid||{}),(e=>{{var t=e.bi||(e.bi={});class i extends e.drawing.BaseGrid{dump(){var e=super.dump();return e.datasource=this.datasource?.name,e}}t.Grid=i,e.bi.componentRegistry.Grid=i}})(katrid=katrid||{}),(o=>{{var e=o.Core||(o.Core={});class t{constructor(e){this.config=e,this.plugins=[],o.app=this,e.adapter?o.Services.Service.adapter=e.adapter:o.Services.Service.adapter=new o.Services.FetchAdapter,e.el?this.rootElement=e.el:this.element=document.querySelector("#action-manager"),this.title=e.title||"Open Runtime",o.init(),this.userInfo=e.userInfo;for(var t of o.Core.plugins)this.plugins.push(new t(this))}get context(){}setView(e){this.element.innerHTML="",this.element.append(e)}get userInfo(){return this._userInfo}set userInfo(e){this._userInfo=e,this.setUserInfo(e)}setUserInfo(e){}searchParams(){return new URLSearchParams(window.location.hash)}appReady(){document.body.append($(`<div id="loading-msg" class="animated fadeIn">
  <span>${o.i18n.gettext("Loading...")}</span>
</div>
`)[0]),document.body.append($(`<div id="overlay" class="animated fadeIn text-center">
  <i class="fa-4x fas fa-circle-notch fa-spin"></i>
  <h3 class="margin-top-16">
    ${o.i18n.gettext("Loading...")}
  </h3>
</div>`)[0]);let t,i,s=$("#loading-msg").hide(),a=$("#overlay").hide();document.addEventListener("ajax.start",e=>{clearTimeout(t),clearTimeout(i),t=setTimeout(()=>s.show(),400),i=setTimeout(()=>{s.hide(),a.show()},4e3)}),document.addEventListener("ajax.stop",()=>{clearTimeout(t),clearTimeout(i),s.hide(),a.hide()}),$(document).ajaxStart(function(){t=setTimeout(()=>s.show(),400),i=setTimeout(()=>{s.hide(),a.show()},2500)}).ajaxStop(function(){clearTimeout(t),clearTimeout(i),s.hide(),a.hide()})}async loadPage(e,t=0){}}e.Application=t;class i extends t{constructor(e){super(e),(o.webApp=this).render(),this.appReady(),window.addEventListener("popstate",e=>{this.loadPage(location.hash,null===e.state||e.state?.clear)}),window.addEventListener("beforeunload",e=>{this.beforeUnload(e)})}beforeUnload(e){if(this.actionManager.action?.beforeUnload)return this.actionManager.action.beforeUnload(e)}get actionManager(){return this._actionManager}render(){var e=document.createElement("app-header"),e=(e.id="app-header",e.classList.add("navbar","navbar-expand-lg","navbar-dark","bg-primary","bg-gradient","flex-row"),e.innerHTML=`<div class="dropdown dropdown-apps">
        <a id="apps-button" class="header-link" data-bs-toggle="dropdown">
          <i class="fa fa-th"></i>
        </a>
        <div class="dropdown-menu apps-menu">
        </div>
      </div>
      <nav class="navbar no-padding">
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-target="#navbar"
                aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
      </nav>
      <div id="navbar-menu" class="mr-auto"></div>
      <div id="navbar" class="collapse navbar-collapse navbar-tools">
        <div class="navbar-search">
          <i class="fa fw fa-search"></i>
          <input id="navbar-search" type="search" class="form-control form-control-dark typeahead" spellcheck="false" autocomplete="off"
                 placeholder="${o.i18n.gettext("Find resources here...")}">
        </div>
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="dropdown-toggle nav-link button-notification-messages" href="javascript:void(0);" data-action="messages"
               title="View notifications"
               data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              <div class="position-absolute badge text-bg-warning" style="display:none">
                <span class="messages-counter">32<span>
                <span class="visually-hidden">messages</span>
              </div>
              <i class="fa fa-bell"></i>
            </a>

            <div class="dropdown-menu dropdown-menu-end dropdown-menu-notifications">
              <a class="dropdown-item"><i class="fa fa-fw"></i> Messages</a>
            </div>

          </li>
          <li class="nav-item d-none d-sm-block">
            <a class="nav-link" href="#/query-viewer/" title="${o.i18n.gettext("Query Viewer")}">
              <i class="fa fa-fw fa-database"></i>
            </a>
          </li>
          <li class="nav-item d-none d-sm-block">
            <a class="nav-link" href="javascript:void(0);" data-action="helpCenter" title="Help Center"
               onclick="Katrid.UI.helpCenter()">
              <i class="fa fa-question"></i>
            </a>
          </li>
          <li class="nav-item user-menu dropdown">
            <a class="nav-link dropdown-toggle" data-bs-toggle="dropdown" href="#">
              <img class="user-avatar" src="/static/admin/assets/img/avatar.png"> <span/>
            </a>
            <div class="dropdown-menu dropdown-menu-end">
              <a class="dropdown-item"><i class="fa fa-fw"></i> ${o.i18n.gettext("Preferences")}</a>
              <div class="dropdown-divider"></div>
              <a class="dropdown-item" href="/web/logout/"><i class="fa fa-lg fa-fw fa-sign-out-alt"></i> ${o.i18n.gettext("Logout")}</a>
            </div>
          </li>
        </ul>
      </div>`,this.rootElement.append(e),document.createElement("div")),t=(e.className="main-content",e.setAttribute("role","main"),document.createElement("action-manager"));t.id="action-manager",t.className="action-manager",this.element=t,e.append(t),this.rootElement.append(e),this._actionManager=t,this.buttonNotificationMessages=this.rootElement.querySelector(".button-notification-messages"),this.buttonNotificationMessages.addEventListener("mousedown",()=>{var e=this.buttonNotificationMessages.parentElement.querySelector(".dropdown-menu");if(e.innerHTML="",0<this.notificationMessages?.length){var t,i=[];for(t of this.notificationMessages)t.read||(i.push(t.id),t.read=!0),this.createNotificationMessageItem(e,t);i.length&&new o.Services.ModelService("mail.message").post("set_read",{kwargs:{ids:i}}),setTimeout(()=>{this.hideMessageCounter()},5e3)}}),this.messageCounterElement=this.buttonNotificationMessages.querySelector(".messages-counter").parentElement}hideMessageCounter(){$(this.messageCounterElement).hide()}set newMessagesCount(e){0<e?($(this.messageCounterElement).show(),this.messageCounterElement.querySelector(".messages-counter").innerText=e.toString()):this.hideMessageCounter()}get notificationMessages(){return this._notificationMessages}set notificationMessages(e){this.buttonNotificationMessages.parentElement.querySelector(".dropdown-menu").innerHTML="",this._notificationMessages=e}createNotificationMessageItem(e,t){var i,s=document.createElement("a");s.className="dropdown-item";let a="";t.timestamp&&(i=moment(t.timestamp),a+=`<small class="timestamp float-sm-end" title="${katrid.filters.dateTimeHumanize(i)}">${i.fromNow()}</small>`),t.title&&(a+=`<h3>${t.title}</h3>`),"string"==typeof t.content?a+=`<div>${t.content}</div>`:t.url&&(a+=`<div>${t.content.message}</div>`,s.href=t.url),t.read||s.classList.add("unread"),s.innerHTML=a,e.appendChild(s)}appReady(){$(()=>{var e;super.appReady(),""===location.hash?(e=document.querySelector("a.module-selector:first-child"))&&e.click():this.loadPage(location.hash)})}formatActionHref(e){return`#/app/?menu_id=${this.currentMenu.id}&action=`+e}get currentMenu(){return this._currentMenu}set currentMenu(e){(this._currentMenu=e)&&($("app-header > .dropdown[data-menu-id]").hide(),$(`app-header > .dropdown[data-menu-id="${e.id}"]`).show(),$("app-header .navbar-menu-group[data-parent-id]").hide(),$(`app-header .navbar-menu-group[data-parent-id="${e.id}"]`).show())}setUserInfo(e){var t;e&&(e.language&&(o.i18n.languageCode=e.language),t=document.querySelector(".user-menu"))&&(t.querySelector("a.nav-link span").innerText=e.name,e.avatar)&&(t.querySelector(".user-avatar").src=e.avatar)}async loadPage(t,i=!0){if(await this.actionManager.confirmDiscard()){let e=t;-1<t.indexOf("?")&&(e=t.substring(0,t.indexOf("?")),t=t.substring(t.indexOf("?")+1,t.length));var s,a,r,n={};for([s,a]of new URLSearchParams(t).entries())n[s]=a;if(this.$search=n,(!this.currentMenu||n.menu_id&&this.currentMenu.id!=n.menu_id)&&(this.currentMenu={id:n.menu_id,name:$(`.module-selector[data-menu-id="${n.menu_id}"]`).text()}),e.startsWith("#/action/")){t=await o.Services.Service.$fetch("/web"+e.substring(1,e.length),null,null).then(e=>e.json());await this.actionManager.execAction(t)}else if("action"in n||"model"in n)await this.actionManager.onHashChange(n,i);else if(!("action"in n)&&"menu_id"in n){t=document.querySelector('app-header .navbar-menu-group[data-parent-id="'+n.menu_id+'"] .menu-item-action[href]');if(t){let e=t.parentElement.querySelector("a.dropdown-item[href]");e?(i=e.getAttribute("href"),history.replaceState(null,null,i),this.loadPage(i)):(e=t.parentElement.querySelector("#navbar-menu .menu-item-action"))&&e.click()}}e.startsWith("#/app/debug/run/")&&this.debug(n);for(r of this.plugins)if(r.hashChange(e))break;this.element.dispatchEvent(new CustomEvent("katrid.actionChange"))}}async debug(e){e=await o.Services.Service.$post("/webide/file/debug/",e);this.actionManager.debug(e)}search(e){this.$location.search(e),window.location.href="#"+this.$location.$$url}changeUrl(e,t){this.$location.$$search[e]=t,history.replaceState(null,null,"#/app/?"+$.param(this.$location.$$search))}get context(){return this.actionManager.context}}e.WebApplication=i}})(Katrid=Katrid||{}),Katrid=Katrid||{},(katrid=katrid||{}).core=Katrid.Core,!function(Katrid){var Forms;!function(Forms){class BaseView{constructor(e){this.config=e,this.dialog=!1,this.create(e),this.container&&this.render()}create(e){e?.template instanceof HTMLTemplateElement?this.template=e.template:e?.template instanceof HTMLElement?this.html=e.template.outerHTML:"string"==typeof e?.template?this.html=e.template:"string"==typeof e?.info?.template&&(this.html=e.info.template),e?.container&&(this.container=e.container)}_applyDataDefinition(e){if(this._readyEventListeners)for(var t of this._readyEventListeners)t.data&&Object.assign(e,t.data);return e}getComponentData(){var e={data:null,...Katrid.globalData};return this._applyDataDefinition(e),e}createComponent(){let t=this,e={};return{data(){return t.getComponentData()},methods:{},computed:e=this.parentVm?{parent(){return t.parentVm}}:e,created(){for(var e of t._readyEventListeners)e.created&&e.created.call(this)}}}cloneTemplate(){let e,t;this.template?e=this.template:t=e=Katrid.html(this.html),e instanceof HTMLTemplateElement&&(e=e.content,t=e.firstElementChild.cloneNode(!0)),this.scripts=[];for(var i of e.querySelectorAll("script"))this.scripts.push(i.text),i.parentNode.removeChild(i);return t}domTemplate(){return this.cloneTemplate()}createDialogButtons(e){var t,i={close:{dismiss:"modal",text:Katrid.i18n.gettext("Close")},ok:{dismiss:"modal",text:Katrid.i18n.gettext("OK"),modalResult:!0},cancel:{dismiss:"modal",text:Katrid.i18n.gettext("Cancel"),modalResult:!1}},s=[];for(t of e){Katrid.isString(t)&&(t=i[t]);var a=document.createElement("button");a.type="button",a.innerText=t.text,t.modalResult?a.setAttribute("v-on:click","$result = "+t.modalResult.toString()):t.click&&a.setAttribute("v-on:click",t.click),t.dismiss&&a.setAttribute("data-bs-dismiss",t.dismiss),t.class?a.className=t.class:a.className="btn btn-outline-secondary",s.push(a)}return s}createDialog(e,t=["close"]){var i,s=Katrid.html(`
    <div class="modal" tabindex="-1" role="dialog">
      <div class="modal-dialog modal-dialog-scrollable modal-xl" role="document">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              {{ title }}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body data-form data-panel">
               
            <div class="clearfix"></div>
          </div>
          <div class="modal-footer">
<!--buttons-->
          </div>
        </div>
      </div>
    </div>
      `),a=(s.querySelector(".modal-body").append(e),s.querySelector(".modal-footer"));for(i of this.createDialogButtons(t))a.append(i);return s}createVm(el){let component=this.createComponent();if(this.scripts){this._readyEventListeners=[];for(var script of this.scripts){let setup=eval(`(${script})`);if(setup&&setup.call){let def=setup.call(this);def.methods&&Object.assign(component.methods,def.methods),(def.ready||def.created||def.data)&&this._readyEventListeners.push(def),def.beforeMount&&def.beforeMount.call(this,el)}}}let vm=Katrid.createVm(component).mount(el);return this.vm=vm,vm}beforeRender(e){return e}createElement(){this.element||(this.element=this.beforeRender(this.domTemplate()),this.applyCustomTags(this.element))}applyCustomTags(e){Katrid.Forms.CustomTag.render(this,e)}render(){if(this.createElement(),this.vm||this.createVm(this.element),this.container&&(this.container.append(this.element),this._readyEventListeners))for(var e of this._readyEventListeners)e.ready&&e.ready.call(this.vm,this);return this.element}closeDialog(){this._modal.hide()}renderTo(e){this.container=e,this.render()}async onHashChange(e){}}function compileButtons(e){let a=0;return e.querySelectorAll("button").forEach((e,t)=>{var i,e=$(e),s=e.attr("type");e.attr("type")&&"object"!==e.attr("type")||e.attr("type","button"),"object"===s?(i=e.attr("send-file"),e.attr("button-object",e.attr("name")),void 0===i?e.attr("v-on:click",`actionClick(selection, '${e.attr("name")}', $event)`):(i="__send_file_"+ ++a,e.parent().append(`<input id="${i}" type="file" style="display: none" v-on:change="sendFile('${e.attr("name")}', $event.target)"/>`),e.attr("send-file",e.attr("name")),e.attr("onclick",`$('#${i}').trigger('click')`))):"tag"===s&&(e.attr("button-tag",e.attr("name")),e.attr("onclick","Katrid.Actions.ClientAction.tagButtonClick($(this))")),e.attr("class")||e.addClass("btn btn-outline-secondary")})}Forms.BaseView=BaseView,Forms.compileButtons=compileButtons,Forms.globalSettings={defaultGridInline:!1}}(Forms=Katrid.Forms||(Katrid.Forms={}))}(Katrid=Katrid||{}),(r=>{{var n=r.Forms||(r.Forms={});n.searchModes=["table","card"],n.registry={};class e extends n.BaseView{constructor(e){super(e),this.pendingOperation=0,this._active=!1}static fromTemplate(e,t,i){return new r.Forms.Views.registry[this.viewType]({action:e,model:t,template:i})}static createViewModeButton(e){}async deleteSelection(e){if((1===e.length&&confirm(r.i18n.gettext("Confirm delete record?"))||1<e.length&&confirm(r.i18n.gettext("Confirm delete records?")))&&e)return await this.datasource.delete(e.map(e=>e.id)),r.Forms.Dialogs.Alerts.success(r.i18n.gettext("Record(s) deleted successfully")),this.refresh(),!0}create(e){this.action=e.action,this._readonly=!0;var t=e.viewInfo;e.model?this.model=e.model:e.name||e.action?.modelName?(console.warn("Please specify a model instance instead of name"),this.model=new r.Data.Model({name:e.name||e.action.modelName,fields:e.fields||t?.fields}),e.action?.model&&(this.model.allFields=e.action.model.fields)):e.fields?this.model=new r.Data.Model({fields:e.fields,name:this.action?.modelName}):(t?.fields||t?.info?.fields)&&(this.model=new r.Data.Model({name:t.info.name,fields:t.fields||t.info.fields})),this.fields=this.model.fields,this.datasource=new r.Data.DataSource({model:this.model,context:this.action?.context,domain:this.action?.config?.domain,fields:this.fields}),this.datasource.dataCallback=e=>this.dataSourceCallback(e),e.records?this.records=this.model.fromArray(e.records):this.records=null,null==this.toolbarVisible&&this.action?this.toolbarVisible=!0:this.toolbarVisible=e.toolbarVisible,super.create(e)}dataSourceCallback(e){e.record?this.record=e.record:e.records&&(this.records=e.records)}createDialog(e,t=["close"]){e=super.createDialog(e,t);return e.setAttribute("data-model",this.model.name),e}get records(){return this._records}set records(e){this._records=e,this.recordCount=e?e.length:null,this.vm&&(this.vm.records=e)}get recordCount(){return this._recordCount}set recordCount(e){this._recordCount=e,this.vm&&(this.vm.recordCount=e),this.action?.searchView?.vm&&(this.action.searchView.vm.recordCount=e)}get active(){return this._active}set active(e){this._active=e,this.setActive(e)}setActive(e){}getComponentData(){var e=super.getComponentData();return e.records=this.records,e.pendingRequest=!1,e}get readonly(){return this._readonly}set readonly(e){(this._readonly=e)?(this.element.classList.add("readonly"),this.element.classList.remove("editable")):(this.element.classList.add("editable"),this.element.classList.remove("readonly"))}async ready(){}refresh(){this.datasource.refresh()}_search(e){return e.id?this.datasource.get({id:e.id,timeout:e.timeout}):this.datasource.search({where:e.where,page:e.page,limit:e.limit,fields:Array.from(Object.keys(this.fields))})}_mergeHeader(e,t){for(var i of Array.from(t.children))"HEADER"===i.tagName?this._mergeHeader(e,i):(t.removeChild(i),e.append(i))}mergeHeader(e,t){var i=t.querySelector("header");return n.compileButtons(t),i&&(i.remove(),this._mergeHeader(e,i)),e}_vmCreated(e){e.$view=this,e.$fields=this.fields,this.datasource.vm=e}async doViewAction(e,t){return this._evalResponseAction(await this.model.service.callAdminViewAction({action:e,ids:[t]}))}async callSubAction(e,t){}async _evalResponseAction(e){return e?.open&&window.open(e.open),e}getSelectedIds(){}createComponent(){var e=super.createComponent();let s=this;return Object.assign(e.methods,{refresh(){s.refresh()},nextPage(){s.datasource.nextPage()},rpc(e,t){return Array.isArray(t)?s.model.service.rpc(e,t):s.model.service.rpc(e,t.args,t.kwargs)},actionClick(e,t,i){s.action.formButtonClick(e.map(e=>e.id),t)},doViewAction(e,t){return s.doViewAction(e,t)},async deleteSelection(){await s.deleteSelection(this.selection)&&(this.selection=[])},sum(e,t){let i=0;if(e)for(var s of e)i+=s[t]||0;return i},sendFile(e,t){return r.Services.Upload.sendFile({model:s.model||s.action?.model,method:e,file:t,vm:this})},$closeDialog(e){void 0!==e&&(this.$result=e),s.closeDialog()}}),e.methods.setViewMode=async function(e){return s.action.showView(e)},e.methods.callAdminViewAction=async function(e){let t;e.prompt&&!(t=prompt(e.prompt))||e.confirm&&(e.confirm,!confirm(e.confirm))||((e={action:e.action,ids:e.ids}).ids||(e.ids=await s.getSelectedIds()),t&&(e.prompt=t),(e=await s.model.service.callAdminViewAction(e)).location&&(window.location.href=e.location))},e.methods.insert=async function(e){(await this.setViewMode("form")).vm.insert(e)},e.computed.$fields=function(){return s.fields},e.created=function(){s._vmCreated(this)},e}getViewType(){return Object.getPrototypeOf(this).constructor.viewType}autoCreateView(){var e,t=document.createElement(this.getViewType()+"-view");for(e of Object.values(this.model.fields)){var i=document.createElement("field");i.setAttribute("name",e.name),t.append(i)}return t}domTemplate(){return this.template||this.html?super.domTemplate():this.autoCreateView()}beforeRender(e){var t,i,s=e.querySelector(":scope > header"),a=(n.compileButtons(e),s&&e.removeChild(s),e.querySelector(":scope > actions")),e=(a&&e.removeChild(a),this.renderTemplate(e));return this.dialog?this.createDialog(e,this.dialogButtons):((t=document.createElement("div")).className="view-content",(i=document.createElement("div")).classList.add("action-view-content","content-scroll"),this.toolbarVisible&&t.append(this.createToolbar()),a&&t.append(a),(a=document.createElement("div")).className="content-container-heading",s&&this._mergeHeader(a,s),(s=document.createElement("div")).className="content no-padding",s.append(a),s.append(e),i.append(s),t.append(i),t)}renderTemplate(e){return e}createToolbar(){var e=document.createElement("div");return e.className="toolbar",e}generateHelp(t){if(this.fields)for(var i of Object.values(this.fields))if(i.visible){var e=document.createElement("h4");if(e.innerText=i.caption,t.element.append(e),i.helpText){let e=document.createElement("p");e.innerHTML=i.helpText,t.element.append(e),i.widgetHelp&&((e=document.createElement("p")).className="text-muted",e.innerHTML=i.widgetHelp,t.element.append(e))}}}}n.ModelView=e;class t extends e{constructor(e){super(e),this.autoLoad=!0}get orderBy(){return this._orderBy}set orderBy(e){this._orderBy=e,this.datasource.orderBy=e}async getSelectedIds(){return this.vm.allSelectionFilter?this.model.service.listId({where:this._lastSearch,limit:99999}):this.vm.selection.map(e=>e.id)}async callSubAction(e,t){(t=t||await this.getSelectedIds())?.length&&await this.model.service.callSubAction(e,t)}create(e){super.create(e),this.recordGroups=e.recordGroups||null}async _recordClick(e,t){this.dialog?(this.vm.$result=e,this.closeDialog()):(this.record=e,this.action&&(e=await this.action.showView("form",{params:{id:e.id}}),console.debug("set records",this.groupLength),this.groupLength?e.records=this.datasource.records:e.records=this.vm.records,e.recordIndex=t))}nextPage(){this.datasource.nextPage()}prevPage(){this.datasource.prevPage()}createComponent(){var e=super.createComponent();let s=this;return e.methods.recordClick=this.config.recordClick||async function(e,t,i){await s._recordClick(e,t)},e.methods.toggleGroup=function(e){e.$expanded?s.collapseGroup(e):s.expandGroup(e)},e.methods.download=function(e){if(e.format)return this.rpc("api_export",{kwargs:{where:s._lastSearch,fields:Array.from(Object.keys(s.fields))}})},e}setActive(e){var t;this._searchView&&(t=this._searchView.element.querySelector(".btn-view-"+Object.getPrototypeOf(this).constructor.viewType))&&(e?t.classList.add("active"):t.classList.remove("active"))}get searchView(){return this._searchView}set searchView(e){(this._searchView=e)&&this.toolbarVisible&&(this.setSearchView(e),e.resultView=this)}dataSourceCallback(e){super.dataSourceCallback(e),this._searchView&&(this._searchView.vm.dataOffset=this.datasource.offset,this._searchView.vm.dataOffsetLimit=this.datasource.offsetLimit,this._searchView.vm.recordCount=this.datasource.recordCount,this.vm.recordCount=this.datasource.recordCount),this._invalidateSelection()}setSearchView(e){var t;this.element&&(t=this.element.querySelector(".search-view-area"))&&(t.innerHTML="",t.append(e.element))}getComponentData(){var e=super.getComponentData();return e.selection=[],e.groups=this.prepareGroup(this.recordGroups),e.recordCount=this.recordCount,e.$fields=this.fields,e.allSelectionFilter=!1,e}prepareGroup(e){return e}async groupBy(e){this.vm.records=this.vm.groups}async applyGroups(e,t){e=await this.datasource.groupBy(e,t);await this.groupBy(e)}_addRecordsToGroup(e,t){}async expandGroup(e){e.$expanded=!0;var t,i=this.vm.groups.indexOf(e),s=(console.log(e),e.$children);s?(t=this.vm.groups,this.vm.groups=[...t.slice(0,i+1),...s,...t.slice(i+1)]):await this.datasource.expandGroup(i,e)}expandAll(){for(var e of this.vm.groups)e.$hasChildren&&!e.$expanded&&this.expandGroup(e)}collapseAll(){for(var e of this.vm.groups)e.$hasChildren&&e.$expanded&&this.collapseGroup(e)}collapseGroup(e){var t,i=this.vm.groups.indexOf(e),s=this.vm.groups;for(t of e.$children){if(!t.$hasChildren)break;t.$expanded&&this.collapseGroup(t)}s.splice(i+1,e.$children.length),e.$expanded=!1}async setSearchParams(e){let t={};this.action?.info?.domain&&(t=JSON.parse(this.action.info.domain));for(var[i,s]of Object.entries(t)){var a={};a[i]=s,e.push(a)}this._lastSearch=e,await this.datasource.search({where:e})}_invalidateSelection(){this.vm.selection=[],this.vm.selectionLength=0,this.vm.allSelected=!1}createToolbar(){var e=r.html(`<div class="data-heading panel panel-default">
      <div class="panel-body">
        <div class="row">
        <div class="col-md-6">
        
          <action-navbar></action-navbar>
          <p class="help-block"></p>
          <div class="toolbar">
            <div class="toolbar-action-buttons"></div>
        </div>
      </div>
          <div class="search-view-area col-md-6"></div>
        </div>
      </div>
    </div>`);return e.querySelector("action-navbar").actionManager=this.action.actionManager,this.createToolbarButtons(e),e}createToolbarButtons(e){var e=e.querySelector(".toolbar-action-buttons"),t=document.createElement("button"),t=(t.className="btn btn-primary btn-action-create",t.innerText=r.i18n.gettext("Create"),t.setAttribute("v-on:click","insert()"),e.append(t),document.createElement("button"));if(t.innerHTML='<i class="fas fa-download"></i>',t.title="Download as excel",t.className="btn btn-outline-secondary btn-export-xls",t.setAttribute("v-on:click","download({format: 'xlsx'})"),e.append(t),this.config?.toolbar?.print){var i,t=document.createElement("div"),s=(t.classList.add("btn-group"),t.innerHTML=`<button type="button" class="btn btn-outline-secondary dropdown-toggle btn-actions" name="print" data-bs-toggle="dropdown" aria-haspopup="true">
        ${r.i18n.gettext("Print")} <span class="caret"></span>
      </button>
      <div class="dropdown-menu">
        <a class="dropdown-item" v-on:click="autoReport()">${r.i18n.gettext("Auto Report")}</a>
      </div>`,t.querySelector(".dropdown-menu"));for(i of this.config?.toolbar?.print){var a=document.createElement("a");a.classList.add("dropdown-item"),a.setAttribute("data-id",i.id),a.innerText=i.name,s.append(a)}e.append(t)}t=document.createElement("button"),t.type="button",t.classList.add("btn","toolbtn"),t.innerHTML='<i class="fas fa-redo-alt"></i>',t.title=r.i18n.gettext("Refresh"),t.setAttribute("v-on:click","refresh()"),e.append(t),this.createSelectionInfo(e),t=document.createElement("div");return t.classList.add("btn-group"),t.innerHTML=`<div class="dropdown">
        <button name="actions" type="button" class="btn btn-outline-secondary dropdown-toggle btn-actions" data-bs-toggle="dropdown" v-show="selectionLength"
                aria-haspopup="true">
          ${r.i18n.gettext("Action")} <span class="caret"></span>
        </button>
        <div class="dropdown-menu dropdown-menu-actions">
          <a class="dropdown-item" v-on:click="deleteSelection()">
            <i class="fa fa-fw fa-trash-o"></i> ${r.i18n.gettext("Delete")}
          </a>
          <!-- replace-actions -->
        </div>
      </div>`,e.append(t),e}createSelectionInfo(e){}get $modalResult(){return this.vm.$result}set $modalResult(e){this.vm.$result=e}showDialog(s){return void 0===(s=s||{}).backdrop&&(s.backdrop="static"),this.dialog=!0,new Promise(async(e,t)=>{let i=this.element;i=i||this.render(),$(i).modal(s).on("hidden.bs.modal",()=>{e(this.vm.$modalResult),$(i).data("bs.modal",null),i.remove()})})}async ready(){if(!this.records)return this.datasource.open();this.refresh()}}n.RecordCollectionView=t;class i extends r.WebComponent{create(){this.classList.add("action-view")}}r.define("action-view",n.ActionViewElement=i)}})(Katrid=Katrid||{}),(e=>{var n;e=e.Forms||(e.Forms={}),(n=e.Views||(e.Views={})).registry={},n.fromTemplates=function(e,t,i){var s,a,r={};for([s,a]of Object.entries(i))r[s]=n.registry[s].fromTemplate(e,t,a);return r}})(Katrid=Katrid||{}),(e=>{var i;(i=e.drawing||(e.drawing={})).BasePage=class{constructor(){this.objects=[],this.loading=!1,this.defaultProps()}get isEmpty(){return 0===this.objects?.length}defaultProps(){this.width="100%",this.height=-1}get size(){return{width:this.width,height:this.height}}set size(e){var t;this.width=e.width,this.height=e.height,!this._pageSize||"Custom"===this._pageSize||(t=i.pageSizes[this._pageSize]).width===e.width&&t.height===e.height||(this._pageSize="Custom"),this.designer&&this.designer.resize(e.width,e.height)}get pageSize(){return this._pageSize}set pageSize(e){(this._pageSize=e)&&(e=i.pageSizes[e],this.width=e.width,this.height=e.height,this.designer)&&this.designer.resize(e.width,e.height)}get orientation(){return this._orientation??=i.PageOrientation.Portrait,this._orientation}set orientation(e){var t,i;e!==this._orientation&&(e!==this._orientation&&({height:t,width:i}=this.size,this.width=t,this.height=i,this.designer)&&this.designer.resize(this.width,this.height),this._orientation=e)}dump(){return{name:this.name,height:this.height,width:this.width,pageSize:this._pageSize,orientation:this._orientation}}*allObjects(){for(var e of this.objects)yield e}children(){return this.objects}load(e){this.name=e.name,this.width=e.width,this.height=e.height,this._pageSize=e.pageSize,this._orientation=e.orientation}onLoad(e){}_createDesigner(){return new e.design.PageDesigner(this)}createDesigner(){try{return this.loading=!0,this.designer=this._createDesigner(),this.designer}finally{this.loading=!1}}}})(katrid=katrid||{}),(e=>{{var t=e.bi||(e.bi={});class i extends e.drawing.BasePage{}t.BasePage=i}})(katrid=katrid||{}),(l=>{{var e=l.BI||(l.BI={});class t extends l.Forms.RecordCollectionView{constructor(){super(...arguments),this.searchViewVisible=!0,this._loadedRows=0}static{this.viewType="query"}get queryId(){return this._queryId}set queryId(e){(this._queryId=e)&&this.queryChange(e)}async queryChange(e){$(this).empty(),document.createElement("div").classList.add("table-responsive")}async refreshQuery(e,t){this._loadedRows=0,$(this.container).empty();e=await l.Services.Query.read({id:e,details:!0,params:t});this.fields=e.fields;return this.fieldList=Object.values(this.fields),e}loadData(e){this._lastGroup=void 0;var t=this.table=document.createElement("table");t.classList.add("table","table-hover");var i,s=t.createTHead().insertRow(0);t.createTBody();let a=!1;for(i of this.columns){var r,n=document.createElement("th");-1<i.dataIndex?((r=this.fieldList[i.dataIndex]).type&&(n.className=r.type),i.width&&(n.style.width=i.width+"px",a=!0),i.cols&&n.classList.add("col-"+i.cols),i.label||(i.label=r.caption)):i.type&&(n.className=i.type),n.innerText=i.label,s.append(n)}this.element.append(t),a&&t.classList.add("table-fixed"),t.addEventListener("contextmenu",e=>this.contextMenu(e))}evalTotal(t,e){let i=0;switch(t.total.toLowerCase()){case"sum":return e.forEach(e=>i+=parseFloat(e[t.dataIndex])||0),i;case"min":return e.forEach(e=>i=Math.min(parseFloat(e[t.dataIndex])||0,i)),i;case"max":return e.forEach(e=>i=Math.max(parseFloat(e[t.dataIndex])||0,i)),i;case"avg":return e.forEach(e=>i+=parseFloat(e[t.dataIndex])||0),i/e.length}}addGroupHeader(e,t,i){var s,a=this.table.tBodies.item(0),r=document.createElement("tr");let n=document.createElement("th"),o=this.columns.length;for(s of this.columns)if(s.total){o=this.columns.indexOf(s);break}n.colSpan=o,e?n.innerText=e.toString():(n.innerText="--",n.className="text-muted"),r.append(n);for(let e=o;e<this.columns.length;e++){var d=this.columns[e];n=document.createElement("th"),d.total&&(n.className=d.type,d=this.evalTotal(d,i),n.innerText=l.intl.number({minimumFractionDigits:2}).format(d)),r.append(n)}a.append(r)}addGroupFooter(){var e=this.table.tBodies.item(0),t=document.createElement("tr"),i=document.createElement("th");i.colSpan=this.columns.length,i.innerText="Total de registros: "+this._lastGroupValues.length.toString(),t.append(i),e.append(t)}more(e){var i=this.table.tBodies.item(0);e=Math.min(e,this.data.length-this._loadedRows);for(let t=0;t<e;t++){var s,a=this.data[this._loadedRows+t],r=document.createElement("tr");let e=0;if(this.groupsIndex){let t=this.groupsIndex[0],i=a[t];this._lastGroup!=i&&(void 0!==this._lastGroup&&this.addGroupFooter(),this._lastGroupValues=this.data.filter(e=>e[t]==i),this.addGroupHeader(i,a,this._lastGroupValues),this._lastGroup=i)}for(s of this.columns){if(-1<s.dataIndex){var n=this.fieldList[s.dataIndex];let e=a[s.dataIndex];var o=document.createElement("td");null==e?e="--":"DecimalField"===n.type?e=l.intl.number({minimumFractionDigits:2}).format(e):l.isNumber(e)?e=l.intl.number({minimumFractionDigits:0}).format(e):"DateField"===n.type||"date"===n.type?e=moment(e).format("DD/MM/YYYY"):"DateTimeField"!==n.type&&"datetime"!==n.type||(e=moment(e).format("DD/MM/YYYY HH:mm")),n.type&&(o.className=n.type),o.innerText=e,r.append(o)}e++}i.append(r)}return this._loadedRows+=e,e&&this._loadedRows===this.data.length&&this.groupsIndex&&this.addGroupFooter(),e}async ready(){this.columns=null,this.fieldList=Object.values(this.fields);let t=Object.keys(this.fields);if(this.metadata.template?.columns){this.columns=this.metadata.template.columns.map(e=>new i(e));for(var e of this.columns)"string"==typeof e.name&&(e.dataIndex=t.indexOf(e.name),e.type||(e.type=this.fieldList[e.dataIndex].type))}else this.columns=this.fieldList.map((e,t)=>new i({name:e.name,type:e.type,label:e.caption,dataIndex:t}));for(this.metadata?.groupBy&&(this.groupsIndex=this.metadata.groupBy.map(e=>t.indexOf(e))),this.element=document.createElement("div"),this.element.classList.add("table-responsive"),this.element.addEventListener("scroll",e=>this.tableScroll(e)),this.loadData(this.data),this.more(200);this.element.scrollHeight<this.element.clientHeight&&this.more(100););this.searchViewVisible&&new l.Forms.SearchView({fields:this.fields}).renderTo(this.container),this.container.append(this.element)}tableScroll(e){this.element.scrollHeight<this.element.scrollTop+this.element.clientHeight+100&&this.more(100)}contextMenu(e){e.stopPropagation(),e.preventDefault();var t=new l.Forms.ContextMenu;t.add('<i class="fa fa-fw fa-copy"></i> '+l.i18n.gettext("Copy"),()=>this.copyToClipboard()),t.add('<i class="fa fa-fw fa-copy"></i> '+l.i18n.gettext("Copy with formatting"),()=>this.copyToClipboard(!0)),t.add('<i class="fa fa-fw fa-download"></i> '+l.i18n.gettext("Export"),()=>this.export()),t.show(e.pageX,e.pageY)}async copyToClipboard(e=!1){e?navigator.clipboard.writeText(l.UI.Utils.toTsv(this.data)):(await this.more(this.data.length-this._loadedRows),navigator.clipboard.writeText(l.UI.Utils.tableToText(this.table)))}export(){l.UI.Utils.textToDownload(l.UI.Utils.tableToText(this.table),this._queryId+".tsv")}get orientation(){return 2==this.metadata?.orientation?"landscape":"portrait"}async print(){for(;this._loadedRows<this.data.length&&this.more(1e3););let e=window.open("");e.addEventListener("afterprint",()=>{e.close()}),this.reportTemplate&&e.document.write(this.reportTemplate);var t=document.createElement("style");t.innerHTML=`@page { size: A4 ${this.orientation} }`,e.document.head.append(t),e.document.querySelector(".document-content").innerHTML=this.table.outerHTML,e.document.body.classList.add(this.orientation),e.document.querySelector("h1").innerText=this.metadata.name,e.document.write("<script>print()<\/script>"),e.document.close()}destroy(){this.element.remove()}}e.QueryView=t;class i{constructor(e){this.name=e.name,this.type=e.type,this.label=e.label,this.visible=!e.visible||null!=e.visible,this.dataIndex=e.dataIndex,this.total=e.total,this.width=e.width,this.cols=e.cols}}}})(Katrid=Katrid||{}),(e=>{{e=e.bi||(e.bi={});class t extends Katrid.BI.QueryView{}e.QueryView=t;class i extends e.BasePage{constructor(){super(...arguments),this.userCanCustomize=!1}_createDesigner(){return new QueryPageDesigner(this)}dump(){var e=super.dump();return e.datasource=this.datasource?.name,e.userCanCustomize=this.userCanCustomize,e.title=this.title,e.model=this.model,e}load(e){super.load(e),this.userCanCustomize=e.userCanCustomize,this.title=e.title,this.model=e.model}get model(){return this._model}set model(e){this._model=e,this.modelService?.name!==e&&this.setModelService(new Katrid.Services.ModelService(e))}async setModelService(e){this.modelService=e;e=await this.modelService.getFieldsInfo({view_type:"list"});this.createQueryView(e)}createQueryView(e){this.queryView=new t({fields:e}),this.queryView.metadata={template:{}},this.designer&&(this.queryView.container=this.designer.getElement(),this.queryView.ready().then(()=>{console.debug(this.queryView.element)}))}get datasource(){return this._datasource}set datasource(e){this._datasource=e}}e.QueryPage=i}})(katrid=katrid||{}),(e=>{{var t=e.bi||(e.bi={}),i=e.design.ComponentEditor;class s extends i{static defineProperties(){return super.defineProperties().concat(new e.design.ComponentProperty("master",{caption:"Master Source",onGetValues:e=>{var t,i=[];for(t of e.designer.report.datasources)e.targetObject!==t&&i.push({value:t,text:t.name});return i}}),new e.design.TextProperty("sql",{caption:"SQL"}))}}t.DataSourceEditor=s;class a extends e.design.WidgetEditor{static defineProperties(){return super.defineProperties().concat(new e.design.DataSourceProperty("datasource",{caption:"Data Source"}))}}t.GridEditor=a;class r extends e.design.ComponentEditor{static defineProperties(){return super.defineProperties().concat(new e.design.StringProperty("model",{caption:"Data Model"}),new e.design.DataSourceProperty("datasource",{caption:"Data Source"}),new e.design.BooleanProperty("userCanCustomize",{caption:"User Can Customize"}),new e.design.StringProperty("title",{caption:"Page Title"}),new e.design.TextProperty("description",{caption:"Description"}))}}t.QueryPageEditor=r,e.design.registerComponentEditor(e.bi.DataSource,s),e.design.registerComponentEditor(e.bi.Grid,a),e.design.registerComponentEditor(e.bi.QueryPage,r)}})(katrid=katrid||{}),(e=>{{var a=e.drawing||(e.drawing={});a.NS="http://www.w3.org/2000/svg";class n{constructor(e,t){if(this.$el="string"==typeof e?document.createElementNS(a.NS,e):e,t)for(var[i,s]of Object.entries(t))this.$el.setAttribute(i,t[i].toString())}path(e){e=r("path",{...e});this.append(e)}rect(e,t,i,s){e=r("rect",{x:e,y:t,width:i,height:s});return this.append(e),e}beginPath(e){return void 0===e&&(e={d:""}),this._path=new n("path",e),this.append(this._path),this._d="",this._path}moveTo(e,t){return this._d+=` M${e} `+t,this._path.attr("d",this._d),this}lineTo(e,t){return this._d+=` L${e} `+t,this._path.attr("d",this._d),this}closePath(){return this._path.attr("d",this._path.attr("d")+" Z"),this}text(e,t,i,s){e=r("text",{x:e,y:t,...s});return e.$el.textContent=i,this.append(e),e}line(e,t,i,s,a){e=r("line",{x1:e,y1:t,x2:i,y2:s,...a});return this.append(e),e}image(e,t,i,s,a){e=r("image",{x:e,y:t,width:i,height:s});return this.append(e),e}attr(e,t){if("string"==typeof e){if(void 0===t)return this.$el.getAttribute(e);this.$el.setAttribute(e,t.toString())}else for(var[i,s]of Object.entries(e))this.$el.setAttribute(i,s.toString());return this}clear(){return this.$el.innerHTML="",this}append(e){this.$el.appendChild(e.$el)}parent(){return new n(this.$el.parentNode)}translate(e,t){this.attr("transform",`translate(${e},${t})`)}remove(){this.$el.remove()}}a.Graphic=n,a.svg=function(e){return new n(e)};class t extends n{}function r(e,t){return new n(e,t)}a.Draw=t,a.draw=r,a.rect=function(e,t,i,s,a){return new n("rect",{x:e,y:t,width:i,height:s,...a})},a.g=function(e){return new n("g",e)};class i extends t{constructor(e,t){super("svg"),this.width=e,this.height=t}get width(){return this._width}set width(e){this._width=e,this.$el.setAttribute("width",e.toString())}get height(){return this._height}set height(e){this._height=e,this.$el.setAttribute("height",e.toString())}}a.SVG=i;class s extends i{constructor(e=500,t=500){super(e,t)}appendTo(e){(this.container=e).appendChild(this.$el)}}a.Canvas=s}})(katrid=katrid||{}),(a=>{{var i=a.design||(a.design={});let s="macOS"===navigator.userAgentData?.platform;i.GUIDELINE_DELAY=1e3;class e extends a.drawing.Canvas{constructor(e=500,t=500){super(e,t),this.dragging=!1,this.snapToGrid=!1,this.gridX=4,this.gridY=4,this.showGrid=!1,this.showGuidelines=!1,this._loading=!1,this._active=!1,this.eventsDisabled=!1,this.resizing=!1,this._zoom=100,this.selectionBox=!0,this.draggingSelectionBox=!1,this._dx=0,this._dy=0,this._bx=0,this._by=0,this._bw=0,this._bh=0,this.selection=[],this.grabs=[],this.guidelines=[],this.objects=[],this.$el.classList.add("design-surface"),this.undoManager=new i.UndoManager(this),this.clipboardManager=new i.ClipboardManager(this),this.defaultProps(),this.workspace=this.$el,this.create()}defaultProps(){}get loading(){return this._loading}set loading(e){this.undoManager.enabled=!e,this._loading=e}beginChanges(e){"move"===e&&this.undoManager.moveSelection(this.selection),this.undoManager.beginUpdate()}endChanges(){this.undoManager.endUpdate()}create(){this.$el.addEventListener("pointerdown",e=>this.onPointerDown(e)),this.$el.addEventListener("pointerup",e=>this.onPointerUp(e)),this.$el.addEventListener("mousemove",e=>this.onMouseMove(e)),this.$el.addEventListener("contextmenu",e=>{e.preventDefault(),e.stopPropagation(),this.showContextMenu(e.clientX,e.clientY)}),this.createDragEvents()}enableEvents(){this.eventsDisabled=!1}disableEvents(){this.eventsDisabled=!0}activate(){this._active||(this._active=!0,this._keyDownHandler&&document.removeEventListener("keydown",this._keyDownHandler),this._keyDownHandler=e=>this.onKeyDown(e),document.addEventListener("keydown",this._keyDownHandler))}createSelectionBox(e,t,i,s){this._selBox=a.drawing.draw("rect",{x:e,y:t,width:i,height:s,class:"selection-box"}),this.append(this._selBox)}deactivate(){this._active&&(this._active=!1,this.clearSelection(),document.removeEventListener("keydown",this._keyDownHandler),this._keyDownHandler=null,this.$el.remove())}onKeyDown(i){if(!this.eventsDisabled){let e=i.ctrlKey,t=i.altKey;if(s&&(e=t,t=!1),!s&&e||s&&i.metaKey&&!e){if("z"===i.key)return i.preventDefault(),void this.undo();if("c"===i.key)return i.preventDefault(),void this.copy();if("v"===i.key)return i.preventDefault(),void this.paste();if("x"===i.key)i.preventDefault(),this.cut();else if(s&&"Z"===i.key||!s&&"y"===i.key)return i.preventDefault(),void this.redo()}if(this.selection?.length&&!t)if(i.shiftKey)switch(i.key){case"ArrowDown":i.preventDefault(),e?this.resizeSelectionBy(0,1):this.resizeSelectionBy(0,this.gridY||1);break;case"ArrowUp":i.preventDefault(),e?this.resizeSelectionBy(0,-1):this.resizeSelectionBy(0,-this.gridY||-1);break;case"ArrowLeft":i.preventDefault(),e?this.resizeSelectionBy(-1,0):this.designer.refre,this.resizeSelectionBy(-this.gridX||-1,0);break;case"ArrowRight":i.preventDefault(),e?this.resizeSelectionBy(1,0):this.resizeSelectionBy(this.gridX||1,0)}else switch(i.key){case"ArrowDown":i.preventDefault(),e?this.moveSelectionBy(0,this.gridY||1):this.moveSelectionBy(0,1),this._tempGuidelines();break;case"ArrowUp":i.preventDefault(),e?this.moveSelectionBy(0,-1*this.gridY||1):this.moveSelectionBy(0,-1),this._tempGuidelines();break;case"ArrowLeft":i.preventDefault(),e?this.moveSelectionBy(-this.gridX||-1,0):this.moveSelectionBy(-1,0),this._tempGuidelines();break;case"ArrowRight":i.preventDefault(),e?this.moveSelectionBy(this.gridX||1,0):this.moveSelectionBy(1,0),this._tempGuidelines();break;case"Delete":i.preventDefault(),this.deleteSelection()}}}applyRectToSelection(e,t,i,s){if(e||t||i||s){this.undoManager.resizeSelection(this.selection);for(var a of this.selection)a.designer.applyRect(e,t,i,s);this.updateGrabs()}}updateSelectedObjects(){for(var e of this.selection)e.redraw();this.updateGrabs()}updateGrabs(){if(!this.resizing){this.destroyGrabHandles();for(var e of this.selection)this.createGrabHandles(e)}for(var t of this.grabs)t.setPosition()}refreshGrabs(){for(var e of this.grabs)e.setPosition()}resizeSelectionBy(e,t){this.applyRectToSelection(0,0,e,t)}addObject(e){var t;return this.objects.includes(e)||(this.objects.push(e),t=this.getDesigner(e),this.addDesigner(t),this.undoManager.add("add",[e]),this.onNotification&&this.onNotification(e,"add")),e.designer}addDesigner(e){this.append(e.drawDesign(this))}setSelection(e){this.clearSelection();for(var t of e)this.addToSelection(t)}clearSelection(){this.destroyGrabHandles(),this.selection=[],this.onSelectionChange()}createGrabHandles(e){var t=new i.GrabHandles({container:this.workspace||this.container,target:e,onObjectResizing:()=>e.designer.onDesignResizing?.(),onObjectResized:()=>e.designer.onDesignResized?.(),snapToGrid:this.snapToGrid,designer:this,gridX:this.gridX,gridY:this.gridY});this.grabs.push(t)}destroyGrabHandles(e){if(!this.resizing)for(var t of Array.from(this.grabs))e&&t.target!==e||(t.destroy(),this.grabs.splice(this.grabs.indexOf(t),1))}applySelectionBox(e){this.clearSelection();for(var t of this.objects)a.drawing.rectInRect(t.element.getBoundingClientRect(),e)&&this.addToSelection(t)}invalidate(){}getValidName(e){}getDesigner(e){return e.designer||(e.designer=new i.WidgetDesigner(e,this)),e.designer}removeFromSelection(e){this.selection.includes(e)&&(this.destroyGrabHandles(e),this.selection.splice(this.selection.indexOf(e),1))}onSelectionChange(){}addToSelection(e){this.selection.includes(e)||(this.selection.push(e),this.createGrabHandles(e)),this.onSelectionChange()}selectObject(e){this.selection.includes(e)||this.clearSelection(),this.addToSelection(e)}toggleSelection(e){this.selection.includes(e)?this.removeFromSelection(e):this.addToSelection(e)}moveSelectionBy(e,t){if(100!==this._zoom&&(e/=this._zoom/100,t/=this._zoom/100),this.selection.length){this.undoManager.moveSelection(this.selection);for(var i of this.selection)i.designer.moveBy(e,t)}for(var s of this.grabs)s.setPosition()}onSelectionMoved(){}_createGuideline(e,t,i,s){e=this.line(e,t,i,s,{class:"guideline"});this.guidelines.push(e.$el),this.append(e)}createGuidelines(){this.resizing||this.destroyGrabHandles();for(var e of this.selection)for(var t of this.objects){var i;t!==e&&(t=t.designer.getDesignRect(),(i=e.getDesignRect()).right===t.right&&this._createGuideline(i.right,i.top,t.right,t.bottom),i.left===t.left&&this._createGuideline(i.left,i.top,t.left,t.bottom),i.right===t.left&&this._createGuideline(i.right,i.top,t.left,t.bottom),i.left===t.right&&this._createGuideline(i.left,i.top,t.right,t.bottom),i.top===t.top&&this._createGuideline(i.left,i.top,t.right,t.top),i.bottom===t.top&&this._createGuideline(i.left,i.bottom,t.right,t.top),i.top===t.bottom&&this._createGuideline(i.left,i.top,t.right,t.bottom),i.bottom===t.bottom)&&this._createGuideline(i.left,i.bottom,t.right,t.bottom)}}clearGuidelines(){this.updateGrabs();for(var e of this.guidelines)e.remove();this.guidelines=[]}loadObject(e){var t;return"Text"===e.type?((t=new a.drawing.Text).load(e),t):"Rectangle"===e.type?((t=new a.drawing.Rectangle).load(e),t):void 0}removeObject(e){this._removeObjects([e])}deleteSelection(){var e=this.selection.length;this._removeObjects(this.selection,`Delete ${e} objects`),this.grabs=[],this.selection=[],this.onSelectionChange()}_removeObjects(e,t){this.undoManager.add("remove",[...e],t),this.onNotification&&e.forEach(e=>this.onNotification(e,"remove"));for(var i of e)this.selection.includes(i)&&(this.destroyGrabHandles(i),this.selection.splice(this.selection.indexOf(i),1)),this.objects.includes(i)&&(this.objects.splice(this.objects.indexOf(i),1),i.remove());this.updateGrabs()}removeObjects(e){this._removeObjects(e)}async cut(){await this.clipboardManager.copy(),this._removeObjects(this.selection)}copy(){if(this.selection.length)return console.debug("copy",this.selection),this.clipboardManager.copy()}async paste(){try{this.undoManager.beginUpdate();var e=await this.clipboardManager.paste();this.undoManager.endUpdate(),this.undoManager.add("add",e)}finally{this.undoManager.endUpdate()}}pasteObject(e){return this.addObject(e)}undo(){this.undoManager.undo(),this.updateGrabs()}redo(){this.undoManager.redo()}resize(e,t){this.width=e,this.height=t,this._resize()}getDesignerHeight(){return this.height}_resize(){let e=this.width,t=this.getDesignerHeight();100!==this._zoom&&(e*=this._zoom/100,t*=this._zoom/100),this.attr("width",e.toString()),this.attr("height",t.toString()),this.attr("viewBox",`0 0 ${this.width} `+this.getDesignerHeight())}get zoom(){return this._zoom}set zoom(e){this._zoom=e,this._resize()}_tempGuidelines(){this.clearGuidelines(),this.createGuidelines(),clearTimeout(this._resizingTimeout),this._resizingTimeout=setTimeout(()=>this.clearGuidelines(),i.GUIDELINE_DELAY)}onPointerDown(e){var t;this.eventsDisabled||(e.stopPropagation(),this.clearSelection(),this.selectionBox&&0===e.button&&(this.draggingSelectionBox=!0,t=this.$el.getBoundingClientRect(),this._dx=e.clientX-t.left,this._dy=e.clientY-t.top,this._bx=this._by=this._bw=this._bh=0,this.createSelectionBox(this._dx,this._dy,0,0)),this.selection.length)||0!==e.button||this.$el.setPointerCapture(e.pointerId)}onMouseMove(a){if(!this.eventsDisabled&&this.draggingSelectionBox){a.preventDefault();let e=this._dx,t=this._dy;var r=this.$el.getBoundingClientRect();let i=a.clientX-this._dx-r.left,s=a.clientY-this._dy-r.top;i<0&&(e+=i,i=Math.abs(i)),s<0&&(t+=s,s=Math.abs(s)),this.updateSelectionBox(e,t,i,s)}}onPointerUp(e){this.eventsDisabled||(this.resizing||this.clearGuidelines(),this.draggingSelectionBox&&(this.draggingSelectionBox=!1,this.$el.releasePointerCapture(e.pointerId),this._onPointerUp(),this.destroySelectionBox(),this.refreshSelection()))}_onPointerUp(){this.applySelectionBox(this._selBox.$el.getBoundingClientRect())}refreshSelection(){}destroySelectionBox(){this._selBox.remove()}updateSelectionBox(e,t,i,s){this._selBox.attr({x:e,y:t,width:i,height:s}),this._bx=e,this._by=t,this._bw=i,this._bh=s}widgetDoubleClick(e,t){t.preventDefault(),t.stopPropagation(),this.executeEditor(e)}executeEditor(e){new(i.getComponentEditor(e.target.constructor))(e.target,this).showEditor()}toolItemDragOver(e){}createDragEvents(){this.$el.addEventListener("dragover",e=>{this.toolItemDragOver(e)}),this.$el.addEventListener("drop",e=>{e.stopPropagation(),e.preventDefault(),this.toolItemDrop(e.dataTransfer.getData("text"),e)})}toolItemDrop(e,t){this.createWidget(e,t.target,t.offsetX,t.offsetY)}createWidget(e,t,i,s){}getElement(){return this.$el}}i.DesignSurface=e}})(katrid=katrid||{}),(e=>{{var t=e.design||(e.design={});class i extends e.design.DesignSurface{constructor(e){super(),this.page=e}get page(){return this._page}get report(){return this.page.report}set page(e){(this._page=e)&&0<e.width&&(this.width=e.width),e&&0<e.height&&(this.height=e.height)}showConfigWizard(){}hideConfigWizard(){}onConfigClick(e){}getElement(){return this.$el}}t.PageDesigner=i}})(katrid=katrid||{}),(e=>{{var t=e.bi||(e.bi={});class i extends e.design.PageDesigner{activate(){super.activate(),this.reportDesigner.activatePage(this.page)}onSelectionChange(){super.onSelectionChange(),this.reportDesigner.onSelectionChanged(this.selection)}}t.PageDesigner=i}})(katrid=katrid||{}),(n=>{(n.bi||(n.bi={})).PivotTable=class{constructor(e){this.create(),e?.append(this.el)}create(){this.el=document.createElement("div"),this.createTable()}createTable(){this.table=document.createElement("table"),this.el.append(this.table),this.table.createTHead(),this.table.createTBody()}get cols(){return this._cols}set cols(e){this._cols=e,this.update()}get rows(){return this._rows}set rows(e){this._rows=e,this.update()}update(){this.table.remove(),this.createTable(),this.loadData()}setData(e){(this.data=e)&&this.loadData()}loadData(){this._rows?.length&&(this.rowPivot=n.utils.pivot(this.data,this._rows[0])),this._cols?.length&&(this.colPivot=n.utils.pivot(this.data,this._cols[0]));var e=document.createElement("tr");if(this.table.tBodies[0].append(e),e.appendChild(document.createElement("td")),this.colPivot)for(var t of this.colPivot){var i=document.createElement("td");i.innerText=t.key,e.append(i)}if(this.rowPivot)for(var s of this.rowPivot){var a=document.createElement("tr"),r=(this.table.tBodies[0].append(a),document.createElement("td"));r.innerText=s.key,a.append(r)}}}})(katrid=katrid||{}),(e=>{{var t=e.Core||(e.Core={});t.Plugin=class{constructor(e){this.app=e}hashChange(e){return!1}};class i extends Array{start(e){for(var t of this)e.plugins.push(new t(e))}}t.plugins=new i,t.registerPlugin=function(e){t.plugins.push(e)}}})(Katrid=Katrid||{}),(t=>{{t.BI||(t.BI={});let e=class extends t.Core.Plugin{hashChange(e){if(e.startsWith("#/query-viewer/"))return this.execute(),!0}async execute(){var e=document.createElement("query-viewer");e.className="content-container",this.app.setView(e)}};e=__decorate([t.Core.registerPlugin],e)}})(Katrid=Katrid||{}),(a=>{{var s=a.BI||(a.BI={});class e extends a.WebComponent{create(){this.queryViewer=new t(this)}}s.QueryViewerElement=e;class t{constructor(e){this.el=e,this.create()}create(){this.el.className="query-viewer",this.el.innerHTML=`
        <div class="col-12 px-2"><h4 class="text-muted">Visualizador de Consultas</h4></div>
        <div class="row px-3">
          <div class="col-2 overflow-auto" id="query-viewer-treeview" style="max-height: 85vh"></div>
          <div class="col-10 query-view card shadow flex-column overflow-auto" style="max-height: 85vh"></div>
        </div>
      `,this.load()}async load(){this.container=this.el.querySelector(".query-view");var e=await a.Services.Query.all();if(e.data){for(let s of e.data)s.onclick=async()=>{$(this.container).empty(),this.query=new a.Services.Query(s.id),window.history.pushState("","","#/query-viewer/?id="+s.id.toString());var e=await this.query.getMetadata(),t=(this.metadata=e).fields,i=e.params;this.params=null,i&&this.createParamsPanel(i),t?this.createQueryView(t,e.data).ready():"query"===e.type&&(i=await this.query.execute({}),this.createQueryView(i.fields,i.data).ready())};await new a.WebComponent.TreeView(e.data,"query-viewer-treeview").makeTreeView()}}createParamsPanel(e){var t=document.createElement("div"),t=(t.className="col-12 px-3",t.innerHTML=`<h4 class="text-muted mb-0">${this.metadata.name}</div>`,this.container.appendChild(t),this.params=Object.values(e).map(e=>new a.Reports.Param(e)),a.Reports.createParamsPanel(this.container,this.params),document.createElement("div"));t.className="col-12 text-end toolbar-action-buttons px-3";let i=document.createElement("button");i.type="button",i.className="btn btn-outline-secondary",i.title=a.i18n.gettext("Print"),i.innerHTML='<i class="fas fa-print"></i>',i.addEventListener("click",()=>this.print()),(this.btnPrint=i).style.display="none",t.append(i),(i=document.createElement("button")).type="button",i.className="btn btn-outline-secondary",i.title="Export to Excel",i.innerHTML='<i class="fas fa-download"></i>',i.addEventListener("click",()=>this.exportToExcel()),(this.btnExport=i).style.display="none",t.append(i),(i=document.createElement("button")).type="button",i.className="btn btn-outline-secondary",i.innerText=a.i18n.gettext("Apply"),t.append(i),i.addEventListener("click",()=>this.applyParams()),this.container.append(t)}async applyParams(){this.queryView&&this.queryView.destroy();var e,t,i=this.params.map(e=>e.dump()),i=await this.query.execute({params:i});i.data&&i.fields?((e=this.createQueryView(i.fields,i.data)).searchViewVisible=!1,e.ready(),$(this.btnPrint).show()):i.filename&&i.content&&(e=document.createElement("a"),t=new Blob([i.content],{type:"text/json"}),e.href=URL.createObjectURL(t),e.download=i.filename,e.click(),e.remove())}async print(){this.queryView.reportTemplate=this.metadata?.template?.reportTemplate,this.queryView.print()}createQueryView(e,t,i=0){e=new s.QueryView({fields:e});return e.metadata=this.metadata,e.data=t,e.container=this.container,this.queryView=e}}s.QueryViewer=t,a.define("query-viewer",e)}})(Katrid=Katrid||{}),(e=>{(e.bi||(e.bi={})).QueryViewer=Katrid.BI.QueryViewer})(katrid=katrid||{}),(h=>{var n;(n=h.bi||(h.bi={})).ReportEditor=class{constructor(e){this.container=e,this.loading=!1,this._modified=!1,this.pages=[],this.create(),e&&e.appendChild(this.el)}onSelectionChanged(e){this.inspector.setSelection(e)}objectNotification(e,t){this.outlineExplorer.objectNotification(e,t)}get reportName(){return this._name||""}set reportName(e){this._name=e,this.el.querySelector(".report-editor-header span").textContent=e}create(){this.el=document.createElement("div"),this.el.style.display="flex",this.el.style.flexDirection="column",this.el.style.flex="1 1 auto",this.createWorkspace()}createWorkspace(){var e=document.createElement("header"),e=(e.innerHTML=`<table><tr><td><h1 class="back"><i class="fa-solid fa-fw fa-chevron-left"></i></h1></td><td><h3>Report Editor</h3>
      <span>${this.reportName}</span>
      </td></tr></table>`,e.querySelector(".back").addEventListener("click",()=>this.close()),e.className="report-editor-header",this.el.appendChild(e),this.createToolbar(this.el),document.createElement("div"));e.className="report-editor",this.el.appendChild(e),this.leftNav=document.createElement("div"),e.appendChild(this.leftNav),this.leftNav.className="tool-window left-side";let t=new h.ui.Toolbar(this.leftNav),i=(t.vertical=!0,t.addButton('<i class="fa-duotone fa-2x fa-fw fa-tools"></i>'));i.title=h.i18n.gettext("Tool Box"),i.addEventListener("click",()=>this.showToolBox()),(i=t.addButton('<i class="fa-duotone fa-2x fa-database"></i>')).title=h.i18n.gettext("Data Sources"),i.addEventListener("click",()=>this.showDataExplorer()),(i=t.addButton('<i class="fa-duotone fa-2x fa-fw fa-sitemap">')).title=h.i18n.gettext("Outline"),i.addEventListener("click",()=>this.showOutlineExplorer()),(i=t.addButton('<i class="fa-duotone fa-2x fa-fw fa-files"></i>')).title=h.i18n.gettext("Pages"),i.addEventListener("click",()=>this.showPageExplorer()),this.pageExplorer=new n.PageExplorer(this.leftNav),(this.pageExplorer.reportEditor=this).pageExplorer.hide(),this.dataExplorer=new n.DataExplorer(this.leftNav),this.dataExplorer.onRemoveDataSource=e=>this.report.removeDataSource(e),this.dataExplorer.onNewDataSource=()=>{var e=new h.bi.SqlDataSource(this.report.getValidName("datasource"));return this.report.datasources.push(e),e},this.dataExplorer.onSelectionChange=e=>this.onSelectionChanged(e?[e]:void 0),this.dataExplorer.hide(),this.outlineExplorer=new n.OutlineExplorer(this.leftNav),this.outlineExplorer.hide(),this.outlineExplorer.onSelectItem=e=>this.onSelectionChanged([e]),this.toolBox=new n.ToolBox(this.leftNav);var s=document.createElement("div"),a=(s.className="report-container",e.appendChild(s),this.zoomTool=new n.ZoomTool(s),document.createElement("div")),r=(a.className="workspace",document.createElement("div"));r.className="designer",r.addEventListener("pointerdown",e=>{this.page.eventsDisabled||(Katrid.Forms.ContextMenu.closeAll(),e.stopPropagation(),e.preventDefault(),this.page?.clearSelection(),this.page.selection.length)||this.inspector.setSelection([this.page.page])}),a.appendChild(r),s.appendChild(a),this.workspaceElement=r,this.rightNav=document.createElement("div"),this.rightNav.className="tool-window data-tool-window",this.inspector=new n.ObjectInspector(this.rightNav),this.paramExplorer=new n.ParamExplorer(this.rightNav),(this.paramExplorer.reportEditor=this).paramExplorer.hide(),(t=new h.ui.Toolbar(this.rightNav)).vertical=!0,e.appendChild(this.rightNav),(i=t.addButton('<i class="fa-duotone fa-solid fa-cog"></i>')).title=h.i18n.gettext("Config page"),i.addEventListener("click",e=>this.configCurrentPage(e)),(i=t.addButton('<i class="fa-duotone fa-solid fa-square-list"></i>')).title=h.i18n.gettext("Properties"),i.addEventListener("click",()=>this.showPropertiesEditor()),(i=t.addButton('<i class="fa-solid fa-list"></i>')).title=h.i18n.gettext("Parameters"),i.addEventListener("click",()=>this.showParamExplorer())}createToolbar(e){var t=document.createElement("div");t.className="main-toolbar";let i=new h.ui.Toolbar(t);var s=i.addButton('<i class="fa-duotone fa-solid fa-2x fa-file"></i>');return s.id="btn-new-report",s.title=h.i18n.gettext("New report"),s.addEventListener("click",()=>this.newReportWizard()),i.addButton('<i class="fa-duotone fa-solid fa-2x fa-floppy-disk"></i>').addEventListener("click",()=>this.save()),i.addButton('<i class="fa-duotone fa-solid fa-2x fa-folder-open"></i>').addEventListener("click",()=>this.openFile()),(i=new h.ui.Toolbar(t)).el.style.flex="0 0 auto",i.addButton({text:h.i18n.gettext("Preview"),iconClass:"fa-regular fa-fw fa-file-pdf"}).addEventListener("click",()=>this.preview(Boolean(this.report.params))),e.appendChild(t),i}async showParamsDialog(){var t=this.report.params;if(t){t=jQuery.parseXML(t);let e="";var i,s=this.report.cache.params||{},a={};for(i of t.querySelector("params").children){var r=i.getAttribute("name"),n=i.getAttribute("label"),o=i.getAttribute("type")||"StringField";a[r]={label:n,type:o},e+=`${r}: ${s[r]||"null"}    # ${n} (${o})\n`}t=await h.bi.showCodeEditor(e.trimEnd(),"yaml");if(!1===t)return!1;var d,l,c=jsyaml.load(t);for([d,l]of Object.entries(c))null!=l&&"DateField"===a[d].type&&(c[d]=moment.utc(l).format("YYYY-MM-DD"));return{values:this.report.cache.params=c,info:a}}}async preview(e=!1){let t;e&&!1===(t=await this.showParamsDialog())||await new Katrid.Services.ModelService("ui.action.report").rpc("preview",[JSON.stringify(this.report.dump()),{values:t?.values,info:t?.info}])}activatePage(e){this._page&&(this._page.onNotification=null),this._page=e.designer,this._page.onNotification=(e,t)=>this.objectNotification(e,t),this.workspaceElement.innerHTML="",this.workspaceElement.appendChild(e.designer.getElement()),this.inspector.designer=e.designer,this.zoomTool.designer=e.designer,e.isEmpty&&this._page.showConfigWizard()}get report(){return this._report}set report(e){this._report=e,this.loadReport(e)}showToolBox(){this.pageExplorer.hide(),this.dataExplorer.hide(),this.outlineExplorer.hide(),this.toolBox.show()}showPageExplorer(){this.outlineExplorer.hide(),this.dataExplorer.hide(),this.toolBox.hide(),this.pageExplorer.show()}showOutlineExplorer(){this.pageExplorer.hide(),this.dataExplorer.hide(),this.toolBox.hide(),this.outlineExplorer.show()}showDataExplorer(){this.toolBox.hide(),this.pageExplorer.hide(),this.outlineExplorer.hide(),this.dataExplorer.show()}showParamExplorer(){this.inspector.hide(),this.paramExplorer.show()}showPropertiesEditor(){this.paramExplorer.hide(),this.inspector.show()}loadReport(e){try{this.loading=!0,this.reportName=e.name,this.dataExplorer.clear();for(var t of e.datasources)this.dataExplorer.registerDataSource(t);for(var i of e.pages)this.addPage(i);this.pages.length&&this.pages[0].activate(),this.outlineExplorer.loadReport(e)}finally{this.loading=!1}}save(){!this.fileHandle&&this.onSave?this.onSave(this.report.dump()):this.saveFile()}close(){this.el.remove(),this.onDestroy?.()}newReportWizard(){var e=new h.ui.ContextMenu,t=(e.add(h.i18n.gettext("Query View"),()=>{this.newReport(h.report.PageType.Query);this.newPage(h.report.PageType.Query)}),e.add(h.i18n.gettext("Banded Report"),()=>{this.newReport(h.report.PageType.Banded);this.newPage(),this.page.newBand("ReportTitle"),this.page.newBand("DataBand"),this.page.newBand("PageFooter")}),e.add(h.i18n.gettext("Structured Report"),()=>{this.newReport(h.report.PageType.Structured);this.newPage(h.report.PageType.Structured)}),e.add(h.i18n.gettext("Data Export"),()=>{this.newReport(h.report.PageType.DataExport);this.newPage(h.report.PageType.DataExport)}),this.el.querySelector("#btn-new-report").getBoundingClientRect());e.show(t.right,t.bottom)}newReport(e=h.report.PageType.Banded){e=new h.report.Report(e);return e.name="no-name",this.clean(),this.report=e}clean(){this._page&&this._page.deactivate(),this.pages=[],this._page=null,this.modified=!1,this.zoomTool.designer=null,this.outlineExplorer.clear(),this.dataExplorer.clear(),this.pageExplorer.clear()}addPage(e){var t=e.createDesigner();return(t.reportDesigner=this).pages.push(t),this.loading||this.outlineExplorer.addObject(e),this.pageExplorer.registerPage(e),t}setModified(){this.modified=!0}newPage(e,t){this.setModified();e=this.report.newPage(e||this.report.reportType),e.name=this.report.getValidName(t||"page"),t=this.addPage(e);return t.activate(),t}get modified(){return this._modified}set modified(e){this._modified=e;e=this.el.querySelector(".report-editor-header");this._modified?e.classList.add("modified"):e.classList.remove("modified")}get page(){return this._page}set page(e){this._page?.deactivate(),(this._page=e)?.activate()}load(e,t){this.clean();var i=new h.report.Report;i.name=t,i.load(e),this.report=i}async openFile(){[this.fileHandle]=await window.showOpenFilePicker({types:[{description:"Reptile Report (*.json)",accept:{"application/json":[".json"]}}]}),this.clean();var e=await this.fileHandle.getFile(),t=await e.text();this.load(JSON.parse(t),e.name)}async saveFile(){this.fileHandle||(this.fileHandle=await window.showSaveFilePicker({types:[{description:"Reptile Report (*.json)",accept:{"application/json":[".json"]}}]}));var e=await this.fileHandle.createWritable(),t=new Blob([JSON.stringify(this.report.dump())],{type:"application/json"});await e.write(t),await e.close(),this.modified=!1}setParams(e){this.report.params=e,this.setModified()}configCurrentPage(e){this.page.onConfigClick(e)}}})(katrid=katrid||{}),(s=>{{var i=s.bi||(s.bi={});let e=class extends s.core.Plugin{hashChange(e){if(e.startsWith("#/report-manager/"))return this.execute(),!0}async execute(){var e=document.createElement("div");e.className="report-manager",this.reportManager=new t(e),this.app.setView(e)}};e=__decorate([s.core.registerPlugin],e);class t{constructor(e){this.container=e,this.create()}create(){this.el=document.createElement("div"),this.el.innerHTML='<div class="report-editor-header"><h1>Report Manager</h1></div>',this.el.className="report-explorer",new s.ui.Toolbar(this.el.querySelector(".report-editor-header")).addButton("Report Editor").addEventListener("click",()=>this.showReportEditor()),this.createExplorer(),this.container.appendChild(this.el),this.load()}showContextMenu(e,t){var i;(e.data.isReport?((i=new s.ui.ContextMenu).add("Novo...",()=>{console.log("Editar",e.data)}),i.add("Editar",()=>{this.editReport(e.data)}),i.add("Remover",()=>{console.log("Eliminar",e.data)}),i.add("Vincular menu...",()=>{console.log("Eliminar",e.data)}),i):((i=new s.ui.ContextMenu).add("Novo relatório...",()=>{console.log("Editar",e.data)}),i.add("Nova pasta...",()=>{console.log("Editar",e.data)}),i.add("Remover",()=>{console.log("Eliminar",e.data)}),i)).show(t.clientX,t.clientY)}createExplorer(){document.createElement("input").type="text",this.treeView=new s.ui.TreeView(this.el,{options:{onContextMenu:(e,t)=>{this.showContextMenu(e,t)}}})}async load(){var e,t=await Katrid.Services.Query.all(),i=(this.reportCatalog=t.data,{});for(e of t.data)(i[e.category]??=[]).push({id:e.id,text:e.name,isReport:!0});t=Object.entries(i).map(([e,t])=>({id:e,text:e,children:t}));this.treeView.addNodes({data:t})}hide(){this.el.style.display="none",document.querySelector("app-header").style.display="none"}show(){this.el.style.display="",document.querySelector("app-header").style.display=""}async editReport(e){var t=new i.ReportEditor(this.container);t.onDestroy=()=>{this.show()};e=await new Katrid.Services.Query(e.id).getMetadata(!0);t.report=s.report.Report.fromMetadata(e),this.hide()}async showReportEditor(){new i.ReportEditor(this.container).onDestroy=()=>{this.show()},this.hide()}}}})(katrid=katrid||{}),(p=>{{var e=p.BI||(p.BI={});class i{constructor(e,t){this.el=e,this.config=t,this._waiting=!1,this.config||(this.config={})}get queryCommand(){return this._queryCommand}set queryCommand(e){this._queryCommand=e,this.waiting=!0,p.Services.post("/bi/query/",{query:e,withDescription:!0,asDict:!0}).then(e=>this._refresh(e)).finally(()=>this.waiting=!1)}get waiting(){return this._waiting}set waiting(e){(this._waiting=e)?this.el.innerHTML=`<div><i class="fas fa-spinner fa-spin"></i> <span>${p.i18n.gettext("Loading...")}</span></div>`:(e=this.el.querySelector(".fas.fa-spinner"))&&e.remove()}_refresh(e){var t=e.fields;let i=[];if(this.config.fieldElements?.length){let s={};for(var a of t)s[a.name]=a;i=Array.from(this.config.fieldElements.map(e=>{var t=e.getAttribute("name");let i;return t&&(i=s[t]),new u(e,i)}))}else i=Array.from(t.map(e=>new u(null,e)));this.el.innerHTML="",this.config.caption&&(this.el.innerHTML=`<h4 class="widget-header">${this.config.caption}</h4>`);var s,t=document.createElement("table"),r=(t.classList.add("table"),document.createElement("tr"));t.createTHead().append(r);for(s of i){var n=document.createElement("th");n.innerText=s.caption,n.className=s.type,r.append(n)}var o,d=t.createTBody();for(o of e.data){var l,c=document.createElement("tr");for(l of i){var h=document.createElement("td");h.className=l.type;let e;l.name?(e=o[l.name],p.isNumber(e)?e=p.intl.number({minimumFractionDigits:0}).format(e):"DateField"===l.type?e=moment(e).format("DD/MM/YYYY"):"DateTimeField"===l.type&&(e=moment(e).format("DD/MM/YYYY HH:mm"))):e="",l.type&&(h.className=l.type),h.innerText=e,c.append(h)}d.append(c)}this.el.append(t)}}e.TableWidget=i;class t extends p.WebComponent{create(){super.create(),this.className="table-responsive";var e,t=Array.from(this.querySelectorAll("field"));for(e of t)e.remove();new i(this,{caption:this.getAttribute("caption"),fieldElements:t}).queryCommand=this.getAttribute("query-command")}}class u{constructor(e,t){this.el=e,this.field=t,e?(this.name=e.getAttribute("name")||t?.name,this.caption=e.getAttribute("caption")||this.name,this.type=e.getAttribute("data-type")||t?.type):t&&(this.caption=this.name=t.name,this.type=t.type),this.type||(this.type="StringField")}}p.define("table-widget",e.TableWidgetElement=t)}})(Katrid=Katrid||{}),(d=>{{var e=d.Services||(d.Services={});let s=window.fetch;window.$fetch=s,window.fetch=function(){var e=new CustomEvent("ajax.start",{detail:document,bubbles:!0,cancelable:!1});let t=new CustomEvent("ajax.stop",{detail:document,bubbles:!0,cancelable:!1});var i=s.apply(this,arguments);return document.dispatchEvent(e),i.finally(()=>{document.dispatchEvent(t)}),i};class l{static{this.url="/api/rpc/"}constructor(e){this.name=e}static $fetch(e,t,i=null){return this.adapter.$fetch(e,t,i)}static $post(e,t,i){return this.adapter.$fetch(e,{method:"POST",credentials:"same-origin",body:JSON.stringify(t),headers:{"content-type":"application/json"}},i).then(e=>e.json())}get(e,t){var i=this.name?this.name+"/":"",i=d.settings.server+this.constructor.url+i+e+"/";return $.get(i,t)}post(e,t,i,s,a){t=t||{},a&&(t.context=a),t={method:e,params:t},s=s||{},Object.assign(s,{method:"POST",body:JSON.stringify(t),headers:{Accept:"application/json","Content-Type":"application/json"}});a=this.name?this.name+"/":"";let o=d.settings.server+this.constructor.url+a+e+"/";return i&&(o+="?"+$.param(i)),new Promise((r,n)=>{l.adapter.$fetch(o,s).then(async e=>{var i,t=e.headers.get("Content-Type");if(500===e.status)return i=await e.json(),d.Forms.Dialogs.ExceptionDialog.show("Server Error 500",i.error),n(i);let s;if("application/json"!==t)return(async e=>{let t=await e.blob(),i=e.headers.get("Content-Type"),s=e.headers.get("Content-Disposition"),a=URL.createObjectURL(t);if(s?.includes("filename=")&&(s=s.split("filename=",2)[1]),-1<i.indexOf("pdf")){let e=window.open("/pdf-viewer/pdf/web/viewer.html");e.addEventListener("load",async()=>{await e.PDFViewerApplication.open({url:a,originalUrl:s}),URL.revokeObjectURL(a)})}else{e=document.createElement("a");e.style.display="none",e.href=a,e.target="_blank",e.download=s,document.body.append(e),e.click(),e.remove(),URL.revokeObjectURL(a)}})(e);if((s=await e.json()).error)"message"in s.error?d.Forms.Dialogs.Alerts.error(s.error.message):"messages"in s.error?d.Forms.Dialogs.Alerts.error(s.error.messages.join("<br>")):d.Forms.Dialogs.Alerts.error(s.error),n(s.error);else{for(var a of katrid.admin.responseMiddleware)new a(e).process(s);if(s.result){let e=s.result;Array.isArray(e)&&1===e.length&&(e=e[0]);let t;if(t=e.messages||[],e.message?e.message.info?t.push({type:"info",message:e.message.info}):t.push(e.message):e.warn?t.push({type:"warn",message:e.warn}):e.error&&("string"==typeof e.error?t.push({type:"error",message:e.error}):t.push({type:"error",message:e.error.message})),t.forEach(function(e){d.isString(e)?d.Forms.Dialogs.Alerts.success(e):"warn"===e.type?d.Forms.Dialogs.Alerts.warn(e.message):"info"===e.type?d.Forms.Dialogs.Alerts.info(e.message):"error"===e.type||"danger"===e.type?d.Forms.Dialogs.Alerts.error(e.message):"toast"===e.type?d.Forms.Dialogs.toast(e.message):"alert"===e.type&&d.Forms.Dialogs.alert(e.message,e.title,e.alert)}),e)if((e.$open||e.open)&&window.open(e.$open||e.open),e.download)return(i=document.createElement("a")).href=e.download,i.target="_blank",void i.click();r(e)}else r(s)}}).catch(e=>{console.log("error",e),n(e)})})}}e.Service=l;class t extends l{static get url(){return"/web/data/"}reorder(e,t,i="sequence",s=0){return this.post("reorder",{args:[e,t,i,s]})}}e.Data=t,e.Attachments=class{static delete(e){new d.Services.ModelService("content.attachment").delete(e)}static upload(a,r){return new Promise((t,e)=>{var i,s=new FormData;s.append("model",r.model.name),s.append("id",r.recordId);for(i of a.files)s.append("attachment",i,i.name);return $.ajax({url:"/web/content/upload/",type:"POST",data:s,processData:!1,contentType:!1}).done(e=>{t(e)})})}},class extends l{},e.Upload=class{static callWithFiles(e){var{model:e,method:t,file:i,vm:s,data:a}=e;let r=new FormData;var n=i.files,i=(1===n.length?r.append("files",i.files[0]):n.map(e=>r.append("files[]",e)),`/web/file/upload/${e.name}/${t}/`);return s?.record?.id&&r.append("id",s.record.id),console.debug("data",a),a&&Object.entries(a).map(([e,t])=>{r.append(e,t),console.debug(e,t)}),l.$fetch(i,{url:i,method:"POST",body:r}).then(e=>e.json())}static sendFile(e){var{model:e,method:t,file:i,vm:s}=e;let a=new FormData;var r=i.files,i=(1===r.length?a.append("files",i.files[0]):r.map(e=>a.append("files[]",e)),`/web/file/upload/${e.name}/${t}/`);s?.record?.id&&a.append("id",s.record.id);let n=s?.dataSource;$.ajax({url:i,data:a,processData:!1,contentType:!1,type:"POST",success:e=>{n&&n.refresh(),d.Forms.Dialogs.Alerts.success("Operação realizada com sucesso.")}})}static uploadTo(e,t){var i=new FormData;return i.append("files",t.files[0]),$.ajax({url:e,data:i,processData:!1,contentType:!1,type:"POST",success:e=>{d.Forms.Dialogs.Alerts.success("Arquivo enviado com sucesso!")}})}},e.data=new t(""),e.post=function(e,t){return fetch(e,{method:"POST",body:JSON.stringify(t),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.json())}}})(Katrid=Katrid||{}),(e=>{{var t=e.bi||(e.bi={});class i extends e.drawing.BaseWidget{dump(){var e=super.dump();return e.datasource=this.datasource?.name,e}}t.TableWidget=i}})(katrid=katrid||{}),(e=>{var a;(a=e.bi||(e.bi={})).DataToolWindow=class{constructor(e){this.container=e,this.create()}create(){this.el=document.createElement("div"),this.el.className="data-tool-window"}async createDataSourceDialog(e){var t=`
      <div class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Data Source</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        <div class="row">
          <div class="form-group col-6">
            <label for="id-name">Connection</label>
            <select class="form-select"><option>(Default)</option></select>
          </div>
          <div class="form-group col-6">
            <label for="id-name">Name</label>
            <input id="id-name" class="form-control" v-model="dataSourceDialog_name" name="name" value="${e?.name||""}"/>
          </div>
</div>
          <div class="form-group">
            <label for="id-command">SQL Query</label>
            <div class="code-editor" name="commandText"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
              type="button"
              class="btn btn-outline-secondary btn-ok"
              data-bs-dismiss="modal"
              >
            OK
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
      `;let i=$(t)[0];i.addEventListener("hidden.bs.modal",()=>{s.dispose(),i.remove()});t=i.querySelector(".code-editor"),t=await a.createCodeEditor(t,e?.sql||"select col from tablename","sql");let s=new bootstrap.Modal(i);return s.show(),{dlg:i,modal:s,btnOk:i.querySelector(".btn-ok"),name:i.querySelector("input[name=name]"),codeEditor:t}}async newDataSource(){let t=await this.createDataSourceDialog({name:this.designer.getValidName("dataSource")});t.btnOk.addEventListener("click",e=>this.createDataSource(t.name.value,t.codeEditor.getValue()))}async editDataSource(t){let i=await this.createDataSourceDialog({name:t.name,sql:t.sql});i.name.value=t.name,i.btnOk.addEventListener("click",e=>{this.saveDataSource(t,i.name.value,i.codeEditor.getValue())})}createDataSource(e,t){e=new a.DataSource({report:this.designer.report,name:e,sql:t});this.addDataSource(e)}saveDataSource(e,t,i){e.name=t,e.sql=i;i=this.designer.datasources.indexOf(e);this.table.querySelector(`tr:nth-child(${i+1})`).querySelector("button").innerText=t}registerDataSource(t){let i=document.createElement("tr");$(i).data("datasource",t);var e=document.createElement("td"),s=document.createElement("td"),a=document.createElement("button"),r=(a.className="btn btn-light",a.addEventListener("dblclick",e=>this.editDataSource($(e.target.closest("tr")).data("datasource"))),a.addEventListener("click",e=>this.designer.onSelectionChange([t])),a.title="Double click to edit",a.innerText=t.name,document.createElement("button"));r.className="btn btn-light",r.addEventListener("click",e=>{console.log(this.designer),this.designer.removeObjectNotification(t),i.remove()}),r.innerHTML='<i class="fa fas fa-times"></i>',r.title="Remove Data Source",i.append(e,s),e.appendChild(a),s.append(r),this.table.tBodies[0].appendChild(i)}addDataSource(e){this.datasources.push(e),this.registerDataSource(e)}clear(){this.table.tBodies[0].innerHTML=""}get datasources(){return this.designer.report.datasources}}})(katrid=katrid||{}),(t=>{var a;(a=t.bi||(t.bi={})).ToolWindow=class{constructor(e,t){this.designer=e,this.template=`
      <div class="tool-window">
        <div class="tool-window-header"><i class="fa fa-fw fa-database"></i> Data</div>
        <div>
          <button type="button" id="btn-new-datasource" class="btn btn-light new-datasource">
            Novo Data Source
          </button>
        </div>
        <hr>
        <div class="row">
          <div class="col-12">
            <table><tbody></tbody></table>
          </div>

        </div>
      </div>
    `,$(t).append(this.template),$(t).append(`
      <div class="right-bar">
        <div class="tool-button">
          <span class="fa fa-cog fa-2x"></span>
        </div>
        <div class="tool-button">
          <span class="fa fa-database fa-2x"></span>
        </div>
        <div id="bi-btn-code-editor" class="tool-button">
          <span class="fa fa-code fa-2x"></span>
        </div>
      </div>
      `),this.btnNew=t.querySelector(".new-datasource"),this.btnNew.addEventListener("click",e=>this.newDataSource()),this.table=t.querySelector("table"),t.querySelector("#bi-btn-code-editor").addEventListener("click",e=>this.showCodeEditor())}async showCodeEditor(){var e=await t.bi.showCodeEditor(this.designer.report.params,"xml",null);e&&(this.designer.report.params=e)}async createDataSourceDialog(e){var t=`
      <div class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Data Source</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        <div class="row">
          <div class="form-group col-6">
            <label for="id-name">Connection</label>
            <select class="form-select"><option>(Default)</option></select>
          </div>
          <div class="form-group col-6">
            <label for="id-name">Name</label>
            <input id="id-name" class="form-control" v-model="dataSourceDialog_name" name="name" value="${e?.name||""}"/>
          </div>
</div>
          <div class="form-group">
            <label for="id-command">SQL Query</label>
            <div class="code-editor" name="commandText"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
              type="button"
              class="btn btn-outline-secondary btn-ok"
              data-bs-dismiss="modal"
              >
            OK
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
      `;let i=$(t)[0];i.addEventListener("hidden.bs.modal",()=>{s.dispose(),i.remove()});t=i.querySelector(".code-editor"),t=await a.createCodeEditor(t,e?.sql||"select col from tablename","sql");let s=new bootstrap.Modal(i);return s.show(),{dlg:i,modal:s,btnOk:i.querySelector(".btn-ok"),name:i.querySelector("input[name=name]"),codeEditor:t}}async newDataSource(){let t=await this.createDataSourceDialog({name:this.designer.getValidName("dataSource")});t.btnOk.addEventListener("click",e=>this.createDataSource(t.name.value,t.codeEditor.getValue()))}async editDataSource(t){let i=await this.createDataSourceDialog({name:t.name,sql:t.sql});i.name.value=t.name,i.btnOk.addEventListener("click",e=>{this.saveDataSource(t,i.name.value,i.codeEditor.getValue())})}createDataSource(e,t){e=new a.DataSource({report:this.designer.report,name:e,sql:t});this.addDataSource(e)}saveDataSource(e,t,i){e.name=t,e.sql=i;i=this.designer.datasources.indexOf(e);this.table.querySelector(`tr:nth-child(${i+1})`).querySelector("button").innerText=t}registerDataSource(t){let i=document.createElement("tr");$(i).data("datasource",t);var e=document.createElement("td"),s=document.createElement("td"),a=document.createElement("button"),r=(a.className="btn btn-light",a.addEventListener("dblclick",e=>this.editDataSource($(e.target.closest("tr")).data("datasource"))),a.addEventListener("click",e=>this.designer.onSelectionChange([t])),a.title="Double click to edit",a.innerText=t.name,document.createElement("button"));r.className="btn btn-light",r.addEventListener("click",e=>{console.log(this.designer),this.designer.removeObjectNotification(t),i.remove()}),r.innerHTML='<i class="fa fas fa-times"></i>',r.title="Remove Data Source",i.append(e,s),e.appendChild(a),s.append(r),this.table.tBodies[0].appendChild(i)}addDataSource(e){this.datasources.push(e),this.registerDataSource(e)}clear(){this.table.tBodies[0].innerHTML=""}get datasources(){return this.designer.report.datasources}}})(katrid=katrid||{}),(e=>{{var t=e.report||(e.report={});class i extends e.bi.BasePage{}t.BasePage=i}})(katrid=katrid||{}),(t=>{{var i=t.report||(t.report={});let e;(t=e=i.DataType||(i.DataType={})).String="string",t.Number="number",t.Decimal="decimal",t.Float="float",t.Date="date",t.Time="time",t.DateTime="datetime",t.Boolean="boolean",t.Text="text",t.Unknown="unknown",i.DataExportColumn=class{constructor(){this.type=e.String,this.required=!1,this.calculated=!1}dump(){return{dataIndex:this.dataIndex,type:this.type,pattern:this.pattern,calculated:this.calculated,caption:this.caption,description:this.description,text:this.text}}load(e){this.dataIndex=e.dataIndex,this.type=e.type,this.pattern=e.pattern,this.calculated=e.calculated,this.caption=e.caption,this.description=e.description,this.text=e.text}};class s{constructor(e){this.page=e,this.required=!1,this.columns=[],this.children=[]}}i.DataExportBlock=s;class a extends i.BasePage{constructor(){super(...arguments),this.blocks=[],this.allowAnalyze=!1,this.allowExport=!0}_createDesigner(){return new i.DataExportDesigner(this)}newBlock(){var e=new s(this);return this.blocks.push(e),e}}i.DataExport=a}})(katrid=katrid||{}),(i=>{{var e=i.report||(i.report={});class t{constructor(e,t){this.block=e,(this.container=t)&&this.create(t)}create(e){this.el=document.createElement("div");var t=document.createElement("table");this.el.className="base-table-designer",this.el.appendChild(t),e.appendChild(this.el),this.createAddColumnButton(this.el)}createAddColumnButton(e){var t=document.createElement("span");return t.className="btn btn-secondary",t.innerText="+",t.title=i.i18n.gettext("Add new column before"),t.addEventListener("click",e=>{e.stopPropagation(),console.debug("add new column before")}),e.appendChild(t)}}class s extends i.bi.PageDesigner{get page(){return super.page}set page(e){super.page=e}create(){var e=this.pageContainer=document.createElement("div");this.pageContainer.className="data-export-editor",this.pageContainer.addEventListener("click",()=>{console.debug("edit table")}),this.createAddNodeButton(e)}createAddNodeButton(e){var t=document.createElement("span");return t.className="btn btn-primary",t.innerText="+",t.title=i.i18n.gettext("Add new node"),t.addEventListener("click",e=>{e.stopPropagation(),this.newBlock()}),e.appendChild(t)}newBlock(){var e=this.page.newBlock();return this.createBlockDesigner(e)}createBlockDesigner(e){return new t(e,this.pageContainer)}getElement(){return this.pageContainer}}e.DataExportDesigner=s}})(katrid=katrid||{}),(e=>{((e=e.report||(e.report={})).exports||(e.exports={})).BaseExport=class{}})(katrid=katrid||{}),(e=>{e=e.report||(e.report={});{e=e.exports||(e.exports={});class t extends e.BaseExport{constructor(){super(...arguments),this.separator=",",this.decimalFormat="0.00"}}e.TextExport=t}})(katrid=katrid||{}),(e=>{{var t=e.bi||(e.bi={});class i extends e.bi.PageDesigner{get page(){return super.page}set page(e){super.page=e}get queryView(){return this.page.queryView}create(){this.pageContainer=document.createElement("div"),this.pageContainer.className="query-page-editor",this.pageContainer.addEventListener("click",()=>{console.debug("edit table")}),this.createEmptyPage()}createEmptyPage(){this.elEmptyPage=document.createElement("div"),this.elEmptyPage.className="empty-page",this.elEmptyPage.innerHTML="<h3>Select a data source or data model</h3>",this.pageContainer.appendChild(this.elEmptyPage);var e=document.createElement("button");e.className="btn btn-primary",e.textContent="Add Query"}getElement(){return this.pageContainer}}t.QueryPageDesigner=i}})(katrid=katrid||{}),(e=>{{var t=e.report||(e.report={});class i extends e.drawing.BaseWidget{applyStyle(){}}t.ReportElement=i}})(katrid=katrid||{}),(o=>{var s;(s=o.report||(o.report={})).ReportDesigner=class{constructor(e){this.container=e,this._modified=!1,this.loading=!1,this.pages=[],this.create(),o.report.reportDesigner=this}create(){this._datasources=[],this.workspace=document.createElement("div"),this.workspace.className="katrid-studio workspace",this.el=document.createElement("div"),this.el.className="katrid-report-designer workspace-area";var e=document.createElement("div"),t=(e.className="tabset",document.createElement("ul")),t=(t.className="nav nav-tabs",e.append(t),this.tabsetElement=e,this.container.append(e),this.container.append(this.workspace),this.toolbox=new o.bi.Toolbox(this.workspace),this.workspace.append(this.el),this.toolWindow=new o.bi.ToolWindow(this,this.workspace),this.container.classList.add("report-designer"),this.createDragEvents(),document.querySelectorAll(".toolbox-item").forEach((t,e)=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{this.page.clearSelection(),e.dataTransfer.setData("text",t.getAttribute("data-widget"))})}),document.querySelectorAll(".toolbox-item img").forEach(e=>e.setAttribute("draggable","false")),document.querySelector("#properties-editor"));this.propertiesEditor=new o.bi.ObjectInspector(this,t)}onSelectionChange(e){e?this.propertiesEditor.setSelection(e):this.propertiesEditor.setSelection([]),$(this).trigger("selectionChange",e)}get datasources(){return this._datasources}createDragEvents(){this.container.addEventListener("dragover",e=>{e.target.closest(".band-designer")&&e.preventDefault()}),this.container.addEventListener("drop",e=>{e.stopPropagation(),e.preventDefault(),this.toolItemDrop(e.dataTransfer.getData("text"),e)})}toolItemDrop(e,t){this.createWidget(e,t.target,t.offsetX,t.offsetY)}createWidget(e,t,i,s){var a=t.closest(".band-designer").$object;i-=a.x,s-=a.clientY;let r;switch(e){case"text":var n=new o.drawing.Text;n.name=this.getValidName("text"),n.text=n.name,n.x=i,n.y=s,a.addObject(n),r=n;break;case"image":(r=new o.bi.ImageObject).name=this.getValidName("image"),r.x=i,r.y=s,a.addObject(r);break;case"barcode":n=new o.bi.Barcode;n.name=this.getValidName("image"),n.left=i,n.top=s,a.addObject(n),r=n}this.page.addToSelection(r)}newReport(){var e=new s.Report;return e.newPage(),this.loadReport(e),e}get report(){return this._report}set report(e){this._report=e}get page(){return this._page}set page(e){e!==this._page&&(this._page&&this._page.deactivate(),this._page=e)&&(e.activate(),this.el.append(e.container))}getValidName(t){let i=0;for(t=t[0].toLowerCase()+t.slice(1);;){let e=!1;var s,a=t+ ++i;for(s of Array.from(this._report.objects()))if(s.name===a){e=!0;break}if(!e)return a}}loadReport(e){this.clear(),this._report=e,this._datasources=e.datasources;for(var t of this._datasources)this.toolWindow.registerDataSource(t);for(var i of e.pages)this.pages.push(this.addPage(i));this.pages.length&&(this.page=this.pages[0])}async widgetExecuteEditor(e){var t=o.bi.getComponentEditor(e.constructor);t&&await new t(e).showEditor()}async showOpenFilePicker(){[this.fileHandle]=await window.showOpenFilePicker({types:[{description:"Reptile Report (*.report)",accept:{"application/json":[".report"]}}]});var e=await this.fileHandle.getFile(),t=await e.text();this.load(JSON.parse(t),e.name)}async showSaveFilePicker(){this.fileHandle||(this.fileHandle=await window.showSaveFilePicker({types:[{description:"Reptile Report (*.report)",accept:{"application/json":[".report"]}}]}));var e=await this.fileHandle.createWritable(),t=(console.log("content",this._report.dump),this.dump(),new Blob([JSON.stringify(this.dump())],{type:"application/json"}));await e.write(t),await e.close()}removeObjectNotification(e){if(!this.loading)for(var t of Array.from(this._report.objects()))t.onRemoveObjectNotification(e)}dump(){return this._report.dump()}load(e,t){this.clear();var i=new s.Report;return i.filename=this.filename=t,i.load(e),this.loadReport(i),i}set filename(e){document.title=e?e+" - Report Editor":"Report Editor"}clear(){this._page&&this._page.deactivate(),this.filename="",this.fileHandle=null,this.pages=[],this._report=null}registerDataSource(e){e.report=this._report,this._datasources.includes(e)||(this._datasources.push(e),this.toolWindow.registerDataSource(e))}removeObjectNotification(e){if(!this.report.loading)for(var t of Array.from(this.report.getObjects()))t.onRemoveObjectNotification(e)}addPage(e){this.setModified();e=e.createDesigner();return this.pages.push(e),e}newPage(e){var e=this.report.newPage(e),t=this.addPage(e);return e.name=this.report.getValidName("page"),t}setModified(e=!0){this._modified=e}}})(katrid=katrid||{}),(s=>{var e;{var a=s.report||(s.report={});let i;(e=i=a.PageType||(a.PageType={})).Banded="banded",e.Query="query",e.Dashboard="dashboard",e.Document="document",e.Spreadsheet="spreadsheet",e.Structured="structured",e.DataExport="data-export",a.Report=class{constructor(e=i.Banded){this.pages=[],this.datasources=[],this.loading=!1,this.onLoadCallbacks=[],this.cache={},this.reportType=e}static fromMetadata(e){var t=new this(i.Banded);return t.name=e.name,t}addPage(e){this.pages.push(e),e.report=this}removeDataSource(e){e=this.datasources.indexOf(e);-1<e&&this.datasources.splice(e,1)}getValidName(t){let i=0;for(t=t[0].toLowerCase()+t.slice(1);;){var s,a=t+ ++i;let e=!1;for(s of Array.from(this.getObjects()))if(s.name===a){e=!0;break}if(!e)return a}}findObject(e){for(var t of this.getObjects())if(t.name===e)return t}*getObjects(){for(var e of this.datasources)yield e;for(var t of this.pages)yield t,yield*t.allObjects()}newPage(e){e??=i.Banded;let t;return t=new(e===i.Banded?a.BandedPage:e===i.Structured?s.report.StructuredReport:e===i.DataExport?s.report.DataExport:s.bi.QueryPage),this.addPage(t),t}addDataSource(e){this.datasources.push(e)}dump(){return{report:{version:1,type:this.reportType,pages:this.pages.map(e=>e.dump()),datasources:this.datasources.map(e=>e.dump())}}}loadPage(e){var t;if(!e.pageType||e.pageType===i.Banded)return(t=new a.BandedPage).report=this,t.load(e),t}loadDataSource(e){var t=new s.bi.DataSource;return t.load(e),t}clear(){this.pages=[],this.datasources=[]}load(e){this.clear();try{this.loading=!0,this.params=e.report.params,this.datasources=e.report.datasources.map(e=>this.loadDataSource(e)),this.pages=e.report.pages.map((e,t)=>this.loadPage(e));for(var t of this.onLoadCallbacks)t(this)}finally{this.loading=!1}}addLoadCallback(e){this.onLoadCallbacks.push(e)}}}})(katrid=katrid||{}),(e=>{{var t=e.report||(e.report={});class i{constructor(){this.children=[],this.columns=[],this.maxRows=-1,this.minRows=0}}t.ReportNode=i;class s{constructor(){this.separator=";",this.quote='"',this.lineBreak="\\n"}}t.TextExportOptions=s;class a extends t.BasePage{constructor(){super(...arguments),this.nodes=[],this.textExportOptions=new s}defaultProps(){super.defaultProps(),this.pageSize="Responsive"}_createDesigner(){return new t.StructuredPageDesigner(this)}newNode(){var e=new i;return this.nodes.push(e),e}}t.StructuredReport=a}})(katrid=katrid||{}),(r=>{{var e=r.report||(r.report={});class t extends e.ReportElement{}e.BandedObject=t;class i extends e.ReportElement{constructor(){super(...arguments),this._sizerHeight=6,this._resizing=!1,this._dy=0,this._minHeight=0}defaultProps(){super.defaultProps(),this.canGrow=!1,this.canShrink=!1,this.objects=[],this._headerHeight=20,this.height=40,this.width=400}onRemoveNotification(e){}getDesignRect(){return new DOMRect(this.x,this.y,this.width,this.height+this._headerHeight+this._sizerHeight)}reorderBy(e){}get clientY(){return this.y+this._headerHeight}get report(){return this.page.report}get background(){return this._background}set background(e){this._background=e,this.applyStyle()}get totalHeight(){return this.height+this._headerHeight+this._sizerHeight}addObject(e){if(!this.objects.includes(e))return this.objects.push(e),(e.parent=this).appendToDesigner(e)}validateHeight(){var e=this.getMinHeight();this.height<e&&(this.height=e,this.pageDesigner.invalidateBands())}dump(){var e=super.dump();return e.x=void 0,e.y=void 0,e}appendToDesigner(e){var t;if(this.pageDesigner)return t=this.pageDesigner.addObject(e),this.elBand.append(e.graphic),t}getHeaderCaption(){return this.name+": "+this.getType()}_createDesigner(){this.pageDesigner??=this.page.designer;var e,t=r.drawing.g({class:"band-designer",transform:`translate(${this.x}, ${this.y})`}),i=this._header=r.drawing.g({transform:`translate(${this.x}, ${this.y})`,class:"band-header"}),s=(r.data(t.$el,"band",this),this.graphic=t,this.elBand=r.drawing.g({transform:`translate(0, ${this._headerHeight||20})`,class:"band"}),this._rect=this.elBand.rect(0,0,this.width,this.height),this._rect.attr("fill","url(#grid)"),this.page.designer),i=(t.append(i),t.append(this.elBand),t.append(this.createSizer(t)),this.bandDesign=t,this.pageDesigner.append(t),this.page.designer);let a=this.createDesignerContextMenu(i);this.graphic.$el.addEventListener("contextmenu",e=>{this.pageDesigner.selection=[],e.stopPropagation(),e.preventDefault(),a.show(e.pageX,e.pageY)});for(e of this.objects)e.drawDesign(s)}createDesigner(){this._createDesigner(),this.redraw()}createGroup(){var e=new c;e.name=this.pageDesigner.getValidName("groupHeader"),this.groupHeader&&(e.parentBand=this.groupHeader),(e.dataBand=this).pageDesigner.addBand(e),(this.groupHeader=e).footer=new h,e.footer.name=this.pageDesigner.getValidName("groupFooter"),e.footer.header=e,this.pageDesigner.addBand(e.footer)}createSizer(e){var t=r.drawing.rect(this.x,this._headerHeight+this.height,this.width,this._sizerHeight,{class:"band-sizer"});return t.$el.addEventListener("pointerdown",e=>this._sizerMouseDown(e)),t.$el.addEventListener("pointerup",e=>this._sizerMouseUp(e)),t.$el.addEventListener("pointermove",e=>this._sizerMouseMove(e)),this.sizer=t}createDesignerContextMenu(t){var e=new r.ui.ContextMenu;return this instanceof s&&(e.add("Add Group",()=>this.createGroup()),e.add("Add Header",()=>{var e=new d;e.name=this.pageDesigner.getValidName("header"),(this.header=e).parentBand=this,t.addBand(e)}),e.add("Add Footer",()=>{var e=new l;e.name=this.pageDesigner.getValidName("footer"),(this.footer=e).parentBand=this,t.addBand(e)}),e.add("Add Detail",()=>{var e=new s;e.name=this.pageDesigner.getValidName("detail"),e.parent=this,t.addBand(e)}),e.addSeparator()),e.add("Delete",()=>{this.destroyDesigner(),this.pageDesigner.invalidateBands()}),e}getMinHeight(){return Math.max(...this.objects.map(e=>e.y+e.height),0)}_sizerMouseDown(e){this._resizing=!0,e.target.setPointerCapture(e.pointerId),this._dy=e.offsetY,e.stopPropagation(),e.preventDefault(),this._minHeight=this.getMinHeight(),this.redraw()}_sizerMouseMove(e){this._resizing&&(e.stopPropagation(),e.preventDefault(),this.sizerMoveBy(e.offsetY-this._dy),this._dy=e.offsetY)}_sizerMouseUp(e){this._resizing=!1,e.target.releasePointerCapture(e.pointerId),e.stopPropagation(),this.height<this._minHeight&&(this.height=this._minHeight),this.pageDesigner.invalidateBands()}sizerMoveBy(e){if(100!==this.pageDesigner?.zoom&&(e/=this.pageDesigner.zoom/100),this.height+e<this._minHeight)return!1;this.height+=e,this.pageDesigner.invalidateBands()}destroyDesigner(){this.pageDesigner&&this.pageDesigner.removeBand(this)}redraw(){super.redraw(),this.width=this.page.width,this.bandDesign.attr("transform",`translate(${this.x}, ${this.y})`),this.sizer.attr("x",this.x),this.sizer.attr("y",this._headerHeight+this.height),this.sizer.attr("width",this.width),this._rect.attr("height",this.height),this._rect.attr("width",this.width),this._header.clear(),this._header.rect(0,0,this.width,this._headerHeight),this._header.text(10,this._headerHeight-6,this.getHeaderCaption(),{fill:"white"})}getClassByName(e){var t=r.bi.componentRegistry[e];return t||super.getClassByName(e)}}e.Band=i;class s extends i{static{this.type="DataBand"}get datasource(){return this._datasource}set datasource(e){this._datasource=e}load(e){super.load(e),(e.datasource||e.groupHeader||e.header||e.footer||e.parent)&&this.report.addLoadCallback(()=>this.onLoad(e))}onRemoveNotification(e){super.onRemoveNotification(e),e===this._datasource?this._datasource=null:e===this.header?this.header=null:e===this.groupHeader&&(this.groupHeader.parentBand?(this.groupHeader=this.groupHeader.parentBand,this.groupHeader.dataBand=this):this.groupHeader=null)}dump(){var e=super.dump();return this._datasource&&(e.datasource=this._datasource.name),this.groupHeader&&(e.groupHeader=this.groupHeader.name),this.header&&(e.header=this.header.name),this.footer&&(e.footer=this.footer.name),this.parentBand&&(e.parent=this.parentBand.name),e}onLoad(e){var t=this.report;e.datasource&&(this._datasource=t.findObject(e.datasource)),e.groupHeader&&(this.groupHeader=t.findObject(e.groupHeader)),e.header&&(this.header=t.findObject(e.header)),e.footer&&(this.footer=t.findObject(e.footer)),e.parent&&(this.parentBand=t.findObject(e.parent))}}e.DataBand=s;class a extends i{static{this.type="PageHeader"}}e.PageHeader=a;class n extends i{static{this.type="PageFooter"}}e.PageFooter=n;class o extends i{static{this.type="ReportTitle"}}e.ReportTitle=o;class d extends i{static{this.type="HeaderBand"}remove(){super.remove(),this.parentBand&&(this.parentBand.header=null)}}e.HeaderBand=d;class l extends i{static{this.type="FooterBand"}remove(){super.remove(),this.parentBand&&(this.parentBand.footer=null)}}e.FooterBand=l;class c extends i{static{this.type="GroupHeader"}remove(){super.remove(),this.footer&&this.footer.destroyDesigner()}onRemoveNotification(e){e===this.footer?this.remove():e===this.parentBand&&(this.parentBand.parentBand?this.parentBand=this.parentBand.parentBand:this.parentBand=null)}dump(){var e=super.dump();return this.expression&&(e.expression=this.expression),this.footer&&(e.footer=this.footer.name),this.parentBand&&(e.parent=this.parentBand.name),e}load(e){super.load(e),this.expression=e.expression||"",(e.parent||e.footer)&&this.report.addLoadCallback(()=>this.onLoad(e))}onLoad(e){e.parent&&(this.parentBand=this.report.findObject(e.parent)),e.footer&&(this.footer=this.report.findObject(e.footer))}}e.GroupHeader=c;class h extends i{static{this.type="GroupFooter"}remove(){super.remove(),console.debug("remove",this),this.header&&this.header.remove()}load(e){super.load(r.data),e.header&&this.report.addLoadCallback(()=>this.onLoad(e))}onLoad(e){e.header&&(this.header=this.report.findObject(e.header))}}e.GroupFooter=h;class p extends i{static{this.type="SummaryBand"}}e.SummaryBand=p}})(katrid=katrid||{}),(n=>{{var c=n.report||(n.report={});class e extends n.design.WidgetDesigner{_mouseUp(){if(this.moved)for(var e of this.designer.selection){var t=this.pageY;if(!(t>=e.parent.clientY&&t<=e.parent.clientY+e.parent.height))for(var i of this.page.bands)i!==e.parent&&t>=i.clientY&&t<=i.clientY+i.height&&this.moveToParent(i)}}}c.BandedObjectDesigner=e;class t extends n.bi.PageDesigner{defaultProps(){super.defaultProps(),this.snapToGrid=!0}removeObjectNotification(){}create(){super.create();var e=n.drawing.draw("pattern",{id:"grid",width:2*this.gridX,height:2*this.gridY,patternUnits:"userSpaceOnUse"}),t=(e.path({d:"M8 0 L0 0 0 8",fill:"none",stroke:"#e9e9e9","stroke-width":.5}),n.drawing.draw("defs"));this.append(t),t.append(e)}loadBands(){try{this.loading=!0;for(var e of this.page.bands)this.addBand(e)}finally{this.loading=!1}this.invalidateBands()}addBand(e){var t,i=this.page;(e.page=i).bands.includes(e)||i.addBand(e),e.pageDesigner=this,e.createDesigner(),this.loading||this.invalidateBands();for(t of e.objects)e.appendToDesigner(t);this.onNotification?.(e,"add")}newBand(e){let t;switch(e){case"PageHeader":t=new c.PageHeader;break;case"ReportTitle":t=new c.ReportTitle;break;case"DataBand":t=new c.DataBand;break;case"GroupHeader":t=new c.GroupHeader;break;case"GroupFooter":t=new c.GroupFooter;break;case"SummaryBand":t=new c.SummaryBand;break;case"PageFooter":t=new c.PageFooter;break;case"TableBand":t=new c.TableBand}return t.name=this.getValidName(e),this.addBand(t),t}getValidName(e){return this.report.getValidName(e)}invalidate(){this.invalidateBands()}invalidateBands(){this.destroyGrabHandles();let e=[];var t,i,s,a,r,n,o,d=this.page;for(t of d.bands)t instanceof c.PageHeader&&e.push(t);for(i of d.bands)i instanceof c.ReportTitle&&e.push(i);for(s of d.bands)s instanceof c.DataBand&&(e=e.concat(this._rearrangeBand(s)));for(a of d.bands)(a instanceof c.SummaryBand||a instanceof c.TableBand)&&e.push(a);for(r of d.bands)r instanceof c.PageFooter&&e.push(r);for(n of d.bands);let l=0;for(o of e)o.y=l,o.redraw(),l+=o.totalHeight;d.bands=e,d.objects=e,this.adjustPageHeight()}getDesignerHeight(){var e;let t=0;for(e of this.page.bands)t+=e.totalHeight;return t}adjustPageHeight(){this.resize(this.width,this.getDesignerHeight())}_resize(){var e;super._resize();for(e of this.page.bands)e.width=this.width,e.redraw()}_rearrangeBand(t){var i=[];if(t.header&&i.push(t.header),t.groupHeader){let e=t.groupHeader;for(i.push(e);e.parentBand;)i.splice(0,0,e.parentBand),e=e.parentBand}if(i.push(t),t.groupHeader){let e=t.groupHeader;if(e.footer)for(i.push(e.footer);e.parentBand;)i.push(e.parentBand.footer),e=e.parentBand}return t.footer&&i.push(t.footer),i}get selectedBand(){return this._selectedBand}set selectedBand(e){this._selectedBand&&this._selectedBand.bandDesign.$el.classList.remove("selected"),(this._selectedBand=e)&&(e.bandDesign.$el.classList.add("selected"),this.selection.push(e),this.onSelectionChange())}createGrabHandles(e){e instanceof c.Band||super.createGrabHandles(e)}removeBand(e){e.bandDesign.remove(),this.page.removeBand(e),this.invalidateBands()}onKeyDown(e){if(this.selectedBand&&"c"!==e.key&&"v"!==e.key&&"x"!==e.key&&"z"!==e.key)switch(e.key){case"Delete":e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.removeBand(this.selectedBand),e.preventDefault(),e.stopPropagation();break;case"ArrowUp":e.shiftKey?this.selectedBand.sizerMoveBy(-this.gridY):e.ctrlKey||this.selectedBand.reorderBy(-1),e.preventDefault(),e.stopPropagation();break;case"ArrowDown":e.shiftKey?this.selectedBand.sizerMoveBy(this.gridY):e.ctrlKey||this.selectedBand.reorderBy(-1),e.preventDefault(),e.stopPropagation()}else super.onKeyDown(e)}applySelectionBox(t){if(super.applySelectionBox(t),!this.selection.length){let e;for(var i of this.page.bands)n.drawing.rectInRect(t,i.bandDesign.$el.getBoundingClientRect())&&(e=i);this.selectedBand=e}}onSelectionChange(){super.onSelectionChange(),this.selection.length&&(1!==this.selection.length||this.selection[0]instanceof c.Band)||(this.selectedBand=null)}moveObjectToBand(e,t){var i=e.clientY-t.clientY;e.remove(),e.y=i,e.redraw(),t.addObject(e)}onSelectionMoved(){super.onSelectionMoved();for(var e of this.selection)if(e.parent){var t=e.clientY;if(!(t>=e.parent.clientY&&t<=e.parent.clientY+e.parent.height))for(var i of this.page.bands)if(i!==e.parent&&t>=i.clientY&&t<=i.clientY+i.height){this.moveObjectToBand(e,i);break}}}toolItemDragOver(e){e.target.closest(".band-designer")&&e.preventDefault()}createWidget(e,t,i,s){t=n.data(t.closest(".band-designer"),"band");i-=t.x,s-=t.clientY;var a=new n.bi.componentRegistry[e];switch(a.name=this.getValidName(e),this.snapToGrid&&(i=Math.round(i/this.gridX)*this.gridX,s=Math.round(s/this.gridY)*this.gridY),a.x=i,a.y=s,e.toLowerCase()){case"text":var r=a;r.text=r.name;break;case"subreport":r=a;r.page=this.reportDesigner.newPage(this.report.reportType,r.name).page}t.addObject(a),t.validateHeight(),this.setSelection([a])}pasteObject(e){return(this._selectedBand||this.page.bands[0]).addObject(e)}showConfigWizard(){}hideConfigWizard(){this._configButton?.remove()}onConfigClick(e){var t=new n.ui.ContextMenu;t.add("Add Report Title",()=>this.newBand("ReportTitle")),t.add("Add Data Band",()=>this.newBand("DataBand")),t.add("Add Table Band",()=>this.newBand("TableBand")),t.add("Add Page Header",()=>this.newBand("PageHeader")),t.add("Add Page Footer",()=>this.newBand("PageFooter")),t.add("Add Summary",()=>this.newBand("SummaryBand")),t.show(e.clientX,e.clientY)}}c.BandDesigner=t}})(katrid=katrid||{}),(s=>{{var e=s.report||(s.report={});class t extends e.Band{constructor(){super(...arguments),this.headerVisible=!0,this.footerVisible=!0}static{this.type="TableBand"}defaultProps(){super.defaultProps(),this.canGrow=!0,this.canShrink=!0,this.height=100}get datasource(){return this._datasource}set datasource(e){this._datasource=e}load(e){super.load(e),this.headerVisible=e.headerVisible,this.footerVisible=e.footerVisible,(e.datasource||e.groupHeader||e.header||e.footer||e.parent)&&this.report.addLoadCallback(()=>this.onLoad(e))}onLoad(e){var t=this.report;e.datasource&&(this._datasource=t.findObject(e.datasource))}dump(){var e=super.dump();return this._datasource&&(e.datasource=this._datasource.name),e.headerVisible=this.headerVisible,e.footerVisible=this.footerVisible,e}_createDesigner(){super._createDesigner(),this.table=document.createElement("table"),this.table.className="table table-sm table-striped table-bordered",this.table.innerHTML=`
      <thead>
      <tr><th>Column 1</th><th>Column 2</th></tr>
      </thead>
      <tbody>
      <tr><td>1</td><td>2</td></tr>
      </tbody>
      `,this.table.querySelector("td").addEventListener("dblclick",e=>console.debug("dbl click"));var e=s.drawing.draw("foreignObject",{x:0,y:0,width:this.width,height:this.height});e.$el.append(this.table),this.elBand.append(e)}createDesignerContextMenu(e){var t=new Katrid.Forms.ContextMenu;return t.add("Table Editor",e=>{this.showTableEditor(e)}),t.add("Columns...",()=>{this.selectColumns()}),t.add("Group by...",()=>{this.destroyDesigner(),this.pageDesigner.invalidateBands()}),t.addSeparator(),t.add("Delete",()=>{this.destroyDesigner(),this.pageDesigner.invalidateBands()}),t}createOutlineContextMenu(){new Katrid.Forms.ContextMenu}redraw(){super.redraw(),this.table.parentElement.style.width=this.width+"px",this.table.parentElement.style.height=this.height+"px"}showTableEditor(e){new i(this.pageDesigner,this.table).showEditorToolbar()}selectColumns(){console.error("Not implemented")}selectColumn(e){}}e.TableBand=t;class i{constructor(e,t){this.designer=e,this.table=t,e.disableEvents()}activate(){let t=e=>this.cellMouseDown(e);this.table.querySelectorAll("td").forEach(e=>e.addEventListener("pointerdown",t))}cellMouseDown(e){e.stopPropagation(),e.preventDefault(),e.target.classList.add("selected")}showEditorToolbar(){var e,t=this.table.getBoundingClientRect();(e=new s.ui.Toolbar).addButton({iconClass:"fa fa-bold",onClick:()=>{}}),e.addButton({iconClass:"fa fa-italic",onClick:()=>{}}),e.addButton({iconClass:"fa fa-underline",onClick:()=>{}});let i=e;document.body.appendChild(i.el),i.showFloating(t.left,t.bottom+10),document.addEventListener("pointerdown",()=>{i.el.remove(),this.destroy()},{once:!0}),this.activate()}destroy(){this.designer.enableEvents()}}}})(katrid=katrid||{}),(e=>{{var t=e.report||(e.report={}),i=e.design.ComponentEditor,s=e.design.ComponentProperty,a=e.design.BackgroundProperty,r=e.design.BooleanProperty,n=e.design.SelectProperty,o=e.design.SizeProperty,d=e.design.StringProperty,l=e.design.WidgetEditor,c=e.design.registerComponentEditor,h=e.design.HeightProperty;class p extends i{static defineProperties(){return super.defineProperties().concat(new h("height",{title:"Height"}),new n("autoSize",{caption:"Auto Size",options:{0:"None",1:"Can shrink",2:"Can grow",3:"Auto"}}),new a("background"),new r("canGrow",{caption:"Can Grow"}),new r("canShrink",{caption:"Can Shrink"}))}}t.BandEditor=p;class u extends p{static defineProperties(){return super.defineProperties().concat(new e.design.ComponentProperty("datasource",{caption:"Data Source",onGetValues:e=>e.designer.report.datasources.map(e=>({value:e,text:e.name}))}),new s("parent",{caption:"Master Band",onGetValues:t=>t.targetObject.page.bands.filter(e=>e!==t.targetObject).map(e=>({value:e,text:e.name}))}))}}t.DataBandEditor=u;class m extends p{static defineProperties(){return super.defineProperties().concat(new d("expression",{caption:"Expression"}))}}t.GroupHeaderEditor=m;class g extends o{createEditor(e){var t=super.createEditor(e);let i=document.createElement("select");i.className="form-select",i.innerHTML=`
      <option></option>
      <option value="Custom">Custom</option>
      <option value="Responsive">Responsive</option>
      <option value="A4">A4</option>
      <option value="A3">A3</option>
      <option value="WebSmall">Web Small</option>
      <option value="WebMedium">Web Medium</option>
      <option value="WebLarge">Web Large</option>
      `;var s=document.createElement("div");s.className="col-12",s.appendChild(i),i.addEventListener("change",()=>{e.targetObject.pageSize=i.value}),i.value=e.targetObject.pageSize,t.insertAdjacentElement("afterbegin",s);let a=document.createElement("select");return a.className="form-select",a.innerHTML=`
      <option value="0">Portrait</option>
      <option value="1">Landscape</option>
      `,a.value=e.targetObject.orientation,a.addEventListener("change",()=>{e.targetObject.orientation=a.value}),s.appendChild(a),t}}class v extends i{static defineProperties(){return super.defineProperties().concat(new g("size"),new d("margins",{caption:"Margins"}))}}t.PageEditor=v;class f extends l{}t.SubReportEditor=f;class b extends p{static defineProperties(){return super.defineProperties().concat(new e.design.DataSourceProperty("datasource",{caption:"Data Source"}),new e.design.TextProperty("columns"))}}t.TableBandEditor=b,c(t.Band,p),c(t.DataBand,u),c(t.TableBand,b),c(t.GroupHeader,m),c(e.report.BandedPage,v),c(t.SubReport,f)}})(katrid=katrid||{}),(e=>{{e=e.report||(e.report={});class t extends e.Band{}e.GridBand=t}})(katrid=katrid||{}),(i=>{{var t=i.report||(i.report={});class e extends t.BasePage{constructor(){super(...arguments),this.bands=[]}defaultProps(){super.defaultProps(),this._pageSize="A4";var{width:e,height:t}=i.drawing.pageSizes.A4;this.width=e,this.height=t}_createDesigner(){var e=new t.BandDesigner(this);return e.loadBands(),e}addBand(e){e.page=this,(e.parent=this).bands.push(e),e.width=this.width}children(){return this.bands}*allObjects(){for(var e of this.bands){yield e;for(var t of e.objects)yield t}}removeBand(t){-1<this.bands.indexOf(t)&&this.bands.splice(this.bands.indexOf(t),1),this.bands.forEach(e=>e.onRemoveNotification(t))}redraw(){this.bands?.forEach(e=>e.redraw())}dump(){var e=super.dump();return e.bands=this.bands.map(e=>e.dump()),e}load(e){super.load(e),e.bands&&(this.bands=e.bands.map(e=>{var t=i.report[e.type];if(t)return(t=new t).parent=this,t.page=this,t.load(e),t;throw Error("Class not found "+e.type)}))}}t.BandedPage=e}})(katrid=katrid||{}),(e=>{{var t=e.report||(e.report={}),i=e.drawing.BaseWidget;class s extends i{defaultProps(){super.defaultProps(),this.width=200,this.height=20}get page(){return this._page}set page(e){this._page=e}dump(){var e=super.dump();return e.page=this.page?.name,e}redraw(){super.redraw(),this.graphic.clear(),this.graphic.rect(0,0,this.width,this.height),this.graphic.text(4,this.height/2,this.name).attr("fill","black")}}t.SubReport=s,e.bi.componentRegistry.SubReport=s,e.bi.componentRegistry.subreport=s}})(katrid=katrid||{}),(e=>{(e.BI||(e.BI={})).ReportPreview=class{loadReport(e){for(var t of e.pages){var i,s=document.createElement("page");s.className="report-page",s.setAttribute("size","A4");for(i of t.bands){var a,r=document.createElement("div");r.className="report-band",s.append(r);for(a of i.objects)if("text"===a.tag)r.append(this.loadText(a));else{if("image"!==a.tag)throw Error("tag not found");r.append(this.loadImage(a))}}}}loadBand(e){var t=document.createElement("div");t.className="report-element report-band",t.style.left=e.left+"px",t.style.top=e.top+"px",t.style.width=e.width+"px",t.style.height=e.height+"px"}loadText(e){var t=document.createElement("span");return t.className="report-element report-text",t.innerHTML=e.text,t.style.left=e.left+"px",t.style.top=e.top+"px",t.style.width=e.width+"px",t.style.height=e.height+"px",t}loadImage(e){var t=document.createElement("img");return t.className="report-element report-image",t.style.left=e.left+"px",t.style.top=e.top+"px",t.style.width=e.width+"px",t.style.height=e.height+"px",t}}})(Katrid=Katrid||{}),(i=>{{var e=i.report||(i.report={});class t extends class{constructor(e,t){this.node=e,(this.container=t)&&this.create(t)}create(e){this.el=document.createElement("div");var t=document.createElement("table");this.el.className="base-table-designer",this.el.appendChild(t),e.appendChild(this.el),this.createAddColumnButton(this.el)}createAddColumnButton(e){var t=document.createElement("span");return t.className="btn btn-secondary",t.innerText="+",t.title=i.i18n.gettext("Add new column before"),t.addEventListener("click",e=>{e.stopPropagation(),console.debug("add new column before")}),e.appendChild(t)}}{}class s extends i.bi.PageDesigner{get page(){return super.page}set page(e){super.page=e}create(){var e=this.pageContainer=document.createElement("div");this.pageContainer.className="structured-report-editor",this.pageContainer.addEventListener("click",()=>{console.debug("edit table")}),this.createAddNodeButton(e)}createAddNodeButton(e){var t=document.createElement("span");return t.className="btn btn-primary",t.innerText="+",t.title=i.i18n.gettext("Add new node"),t.addEventListener("click",e=>{e.stopPropagation(),this.newNode()}),e.appendChild(t)}newNode(){var e=this.page.newNode();return this.createNodeDesigner(e)}createNodeDesigner(e){return new t(e,this.pageContainer)}getElement(){return this.pageContainer}}e.StructuredPageDesigner=s}})(katrid=katrid||{}),(e=>{var t;(t=e.bi||(e.bi={})).StructuredReportViewer=class{constructor(e){this.container=e,this.cutomizable=!1,e&&(this.create(),e.appendChild(this.el))}create(){this.el=document.createElement("div"),this.el.className="structured-report-viewer",this.el.innerHTML="<h1>Visualizar Relatório Estruturado</h1>";var e=document.createElement("div");e.className="report-body",this.outline=new t.OutlineExplorer(e)}get report(){return this._report}set report(e){(this._report=e)&&this.loadReport(e)}loadReport(e){this.renderReport(e)}renderReport(e){this.page=e.pages[0]}}})(katrid=katrid||{}),(i=>{(i.bi||(i.bi={})).AlignmentTool=class{constructor(){this.create()}create(){this.el=document.createElement("div"),this.el.className="alignment-tool";var e=new i.ui.Toolbar(this.el);let t=e.addButton('<i class="fa-duotone fa-objects-align-left"></i>');t.title="Align Left",t.addEventListener("click",()=>this.alignLeft()),(t=e.addButton('<i class="fa-duotone fa-objects-align-center-horizontal"></i>')).title="Align Center Horizontal",t.addEventListener("click",()=>this.alignCenterHorizontal()),(t=e.addButton('<i class="fa-duotone fa-objects-align-right"></i>')).title="Align Right",t.addEventListener("click",()=>this.alignRight()),(t=e.addButton('<i class="fa-duotone fa-objects-align-top"></i>')).title="Align Top",t.addEventListener("click",()=>this.alignTop()),(t=e.addButton('<i class="fa-duotone fa-objects-align-center-vertical"></i>')).title="Align Center Vertical",t.addEventListener("click",()=>this.alignCenterVertical()),(t=e.addButton('<i class="fa-duotone fa-objects-align-bottom"></i>')).title="Align Bottom",t.addEventListener("click",()=>this.alignBottom())}alignLeft(){if(!(this.designer.selection.length<=1)){var e,t=Math.min(...this.designer.selection.map(e=>e.x));this.designer.beginChanges("move");for(e of this.designer.selection)e.designer.moveTo(t,e.y);this.designer.endChanges(),this.designer.refreshGrabs()}}alignCenterHorizontal(){if(!(this.designer.selection.length<=1)){var e,t=Math.min(...this.designer.selection.map(e=>e.x+e.width/2));this.designer.beginChanges("move");for(e of this.designer.selection)e.designer.moveTo(t-e.width/2,e.y);this.designer.endChanges(),this.designer.refreshGrabs()}}alignRight(){if(!(this.designer.selection.length<=1)){var e,t=Math.max(...this.designer.selection.map(e=>e.x+e.width));this.designer.beginChanges("move");for(e of this.designer.selection)e.designer.moveTo(t-e.width,e.y);this.designer.endChanges(),this.designer.refreshGrabs()}}alignTop(){if(!(this.designer.selection.length<=1)){var e,t=Math.min(...this.designer.selection.map(e=>e.y));this.designer.beginChanges("move");for(e of this.designer.selection)e.designer.moveTo(e.x,t);this.designer.endChanges(),this.designer.refreshGrabs()}}alignCenterVertical(){if(!(this.designer.selection.length<=1)){var e,t=Math.min(...this.designer.selection.map(e=>e.y+e.height/2));this.designer.beginChanges("move");for(e of this.designer.selection)e.designer.moveTo(e.x,t-e.height/2);this.designer.endChanges(),this.designer.refreshGrabs()}}alignBottom(){if(!(this.designer.selection.length<=1)){var e,t=Math.max(...this.designer.selection.map(e=>e.y+e.height));this.designer.beginChanges("move");for(e of this.designer.selection)e.designer.moveTo(e.x,t-e.height);this.designer.endChanges(),this.designer.refreshGrabs()}}distributeHorizontally(){}distributeVertically(){}}})(katrid=katrid||{}),(e=>{(e.bi||(e.bi={})).BaseToolWindow=class{constructor(e){this.container=e,this.create(),e&&e.appendChild(this.el)}getHeaderTemplate(){return'<div class="tool-window-header"></div><hr>'}create(){this.el=document.createElement("div"),this.el.className="tool-window-content",this.el.innerHTML=this.getHeaderTemplate()}hide(){this.el.style.display="none"}show(){this.el.style.display=""}}})(katrid=katrid||{}),(a=>{{var r=a.bi||(a.bi={});class e extends r.BaseToolWindow{getHeaderTemplate(){return`
      <div class="tool-window-header">
        <i class="fa fa-fw fa-database"></i> Data
      </div>
      <div>
          <button type="button" id="btn-new" class="btn btn-light new-datasource">
            Novo Data Source
          </button>
      </div>
      <hr>
      `}create(){super.create(),this.el.classList.add("data-explorer"),this.table=document.createElement("div"),this.tv=new a.ui.TreeView(this.table,{options:{onDblClick:e=>this.editDataSource(e.data.target),onSelect:e=>this.onSelectionChange?.(e.data.target),onContextMenu:(e,t)=>this.nodeContextMenu(e,t)}}),this.el.appendChild(this.table),this.el.querySelector("#btn-new").addEventListener("click",()=>{this.onNewDataSource&&this.registerDataSource(this.onNewDataSource())})}registerDataSource(e){this.tv.addItem({text:e.name,target:e,title:"Double click to edit"})}saveDataSource(e,t,i){e.name=t,e.sql=i;for(var s of this.tv.nodes)if(a.data(s,"datasource")===e){s.setText(t);break}}async editDataSource(t){let i=await this.createDataSourceDialog({name:t.name,sql:t.sql});i.name.value=t.name,i.btnOk.addEventListener("click",e=>{this.saveDataSource(t,i.name.value,i.codeEditor.getValue())})}async createDataSourceDialog(e){var t=`
      <div class="modal" tabindex="-1" role="dialog">
    <div class="modal-dialog modal-lg" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Data Source</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
        <div class="row">
          <div class="form-group col-6">
            <label for="id-name">Connection</label>
            <select class="form-select"><option>(Default)</option></select>
          </div>
          <div class="form-group col-6">
            <label for="id-name">Name</label>
            <input id="id-name" class="form-control" v-model="dataSourceDialog_name" name="name" value="${e?.name||""}"/>
          </div>
</div>
          <div class="form-group">
            <label for="id-command">SQL Query</label>
            <div class="code-editor" name="commandText"></div>
          </div>
        </div>
        <div class="modal-footer">
          <button
              type="button"
              class="btn btn-outline-secondary btn-ok"
              data-bs-dismiss="modal"
              >
            OK
          </button>
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </div>
    </div>
  </div>
      `;let i=$(t)[0];i.addEventListener("hidden.bs.modal",()=>{s.dispose(),i.remove()});t=i.querySelector(".code-editor"),t=await r.createCodeEditor(t,e?.sql||"select col from tablename","sql");let s=new bootstrap.Modal(i);return s.show(),{dlg:i,modal:s,btnOk:i.querySelector(".btn-ok"),name:i.querySelector("input[name=name]"),codeEditor:t}}clear(){this.tv.clear()}nodeContextMenu(e,t){var i=new a.ui.ContextMenu;i.add("Edit",()=>this.editDataSource(e.data.target)),i.add("Delete",()=>{this.onRemoveDataSource?.(e.data.target),e.remove()}),i.show(t.clientX,t.clientY)}}r.DataExplorer=e}})(katrid=katrid||{}),(i=>{{var e=i.bi||(i.bi={});let t=["INPUT","SELECT","TEXTAREA"];class s extends e.BaseToolWindow{getHeaderTemplate(){return'<div class="tool-window-header"><i class="fa-duotone fa-solid fa-square-list"></i> Properties</div>'}create(){super.create(),this.el.classList.add("properties-editor"),this.content=document.createElement("div"),this.el.appendChild(this.content),this.alignmentTool=new e.AlignmentTool,this.el.insertAdjacentElement("afterbegin",this.alignmentTool.el),this.el.addEventListener("keydown",this._keyDown)}_keyDown(e){t.includes(e.target.tagName)&&e.stopPropagation()}get designer(){return this._designer}set designer(e){this._designer=e,this.alignmentTool.designer=e}setSelection(e){if((this.selection=e).length)for(var t of e)this.editor=this.createComponentEditor(t);else this.content.innerHTML=""}getComponentEditor(e){return new(i.design.getComponentEditor(e.constructor))(e,this.designer)}createComponentEditor(e){this.content.innerHTML="";e=this.getComponentEditor(e);return this.content.appendChild(e.createEditor()),e}refresh(){this.setSelection(this.selection)}}e.ObjectInspector=s}})(katrid=katrid||{}),(e=>{{var t=e.bi||(e.bi={});class i extends t.BaseToolWindow{getHeaderTemplate(){return`
        <div class="tool-window-header"><i class="fa fa-fw fa-sitemap"></i> Outline</div>
        <hr>
      `}create(){super.create(),this.el.classList.add("outline-explorer"),this.treeView=new e.ui.TreeView(this.el.appendChild(document.createElement("div")))}objectNotification(e,t){switch(t){case"add":this.addObject(e);break;case"remove":this.removeObject(e);break;case"rename":this.renameObject(e)}}clear(){this.treeView.clear()}loadReport(e){for(var t of e.pages)this.addObject(t)}_findNode(e){for(var t of this.treeView.all())if(t.data.object===e)return t}addObject(e){var t=this.getObjectText(e);let i;e.target.parent&&(i=this._findNode(e.target.parent));var t=this.treeView.addItem({text:t,object:e},i,{onSelect:()=>this.selectObject(e)}),s=e.children?.();if(s)for(var a of s)this.addObject(a);return t}removeObject(e){e=this._findNode(e);e&&e.remove()}renameObject(e){var t=this._findNode(e);t&&t.setText(this.getObjectText(e))}getObjectText(e){return e.name||`(${e.type})`}selectObject(e){this.onSelectItem?.(e)}}t.OutlineExplorer=i}})(katrid=katrid||{}),(t=>{{var e=t.bi||(t.bi={});class i extends e.BaseToolWindow{getHeaderTemplate(){return`<div class="tool-window-header"><i class="fa fa-fw fa-file"></i> Pages</div>
<div>
<button id="btn-new" class="btn btn-light">New Page</button>
</div>
      <hr>`}create(){super.create(),this.el.classList.add("page-explorer"),this.el.querySelector("#btn-new").addEventListener("click",()=>this.reportEditor.newPage());var e=document.createElement("div");this.treeView=new t.ui.TreeView(e,{options:{onSelect:e=>this.reportEditor.page=e.data.object.designer}}),this.el.appendChild(e)}registerPage(e){this.treeView.addItem({id:e.name,text:e.name,object:e})}clear(){this.treeView.clear()}}e.PageExplorer=i}})(katrid=katrid||{}),(t=>{{var e=t.bi||(t.bi={});class i extends e.BaseToolWindow{getHeaderTemplate(){return`
        <div class="tool-window-header"><i class="fa fa-fw fa-database"></i> Parameters</div>
        <div>
          <button type="button" id="btn-new-param" class="btn btn-light new-param">
            Novo Parâmetro
          </button>
          <button type="button" id="btn-edit-params" class="btn btn-light new-param">
            Params Editor
          </button>
        </div>
        <hr>
      `}create(){super.create(),this.el.classList.add("param-explorer"),this.el.querySelector("#btn-edit-params").addEventListener("click",async()=>{var e=await t.bi.showCodeEditor(this.reportEditor.report.params,"xml");!1!==e&&this.reportEditor.setParams(e)})}}e.ParamExplorer=i}})(katrid=katrid||{}),(t=>{{var e=t.bi||(t.bi={});class i extends e.BaseToolWindow{getHeaderTemplate(){return`
        <div class="tool-window-header"><i class="fa fa-fw fa-toolbox"></i> Objects</div>
        <hr>
      `}create(){super.create(),this.el.classList.add("toolbox");var e=document.createElement("div");e.innerHTML=`
      <div>
        <div class="toolbox-menu col-12">
          <div class="row">
            <div class="col-4 toolbox-item" data-widget="text">
              <div>
                <i class="fa-duotone fa-2x  fa-fw fa-text"></i>
              </div>
              <div class="widget-label">
                ${t.i18n.gettext("Text")}
              </div>
            </div>
            <div class="col-4 toolbox-item" data-widget="image">
              <div>
                 <i class="fa-duotone fa-2x fa-fw fa-image"></i>
              </div>
              <div class="widget-label">
                ${t.i18n.gettext("Image")}
              </div>
            </div>

            <div class="col-4 toolbox-item" data-widget="Grid">
              <div>
                 <i class="fa-duotone fa-regular fa-2x fa-fw fa-table"></i>
              </div>
              <div class="widget-label">
                ${t.i18n.gettext("Grid")}
              </div>
            </div>

            <div class="col-4 toolbox-item" data-widget="barcode">
              <div>
                 <i class="fa-duotone fa-2x fa-fw fa-barcode"></i>
              </div>
              <div class="widget-label">
                ${t.i18n.gettext("Barcode")}
              </div>
            </div>

            <div class="col-4 toolbox-item" data-widget="subreport">
              <div>
                <i class="fa-duotone fa-thin fa-2x fa-fw fa-file"></i>
             </div>
              <div class="widget-label">
                ${t.i18n.gettext("Sub-Report")}
              </div>
            </div>

          </div>
        </div>

        <div class="toolbox-header">
          <i class="fas fa-fw fa-vector-square"></i> Gráficos
        </div>
        <div class="toolbox-menu col-12">
          <div class="row">

            <div class="col-4 toolbox-item" data-widget="bar">
              <div>
<i class="fa-duotone fa-2x fa-fw fa-chart-column"></i>
             </div>
              <div class="widget-label">
                ${t.i18n.gettext("Column")}
              </div>
            </div>

            <div class="col-4 toolbox-item" data-widget="hbar">
              <div>
<i class="fa-duotone fa-2x fa-fw fa-chart-simple"></i>
             </div>
              <div class="widget-label">
                ${t.i18n.gettext("Bar")}
              </div>
            </div>

            <div class="col-4 toolbox-item" data-widget="area-chart">
              <div>
<i class="fa-duotone fa-2x fa-fw fa-chart-area"></i>
             </div>
              <div class="widget-label">
                ${t.i18n.gettext("Area")}
              </div>
            </div>

            <div class="col-4 toolbox-item" data-widget="line-chart">
              <div>
<i class="fa-duotone fa-2x fa-fw fa-chart-line-up"></i>
             </div>
              <div class="widget-label">
                ${t.i18n.gettext("Line")}
              </div>
            </div>

            <div class="col-4 toolbox-item" data-widget="pie">
              <div>
<i class="fa-duotone fa-2x fa-fw fa-chart-pie"></i>
             </div>
              <div class="widget-label">
                 ${t.i18n.gettext("Pie")}
              </div>
            </div>
          </div>
        </div>
      </div>
    `,this.el.append(e),this.el.querySelectorAll(".toolbox-item").forEach((t,e)=>{t.setAttribute("draggable","true"),t.addEventListener("dragstart",e=>{e.dataTransfer.setData("text",t.getAttribute("data-widget"))})}),this.el.querySelectorAll(".toolbox-item img").forEach(e=>e.setAttribute("draggable","false"))}}e.ToolBox=i}})(katrid=katrid||{}),(t=>{(t.bi||(t.bi={})).ZoomTool=class{constructor(e,t){this.container=e,this.create()}create(){var e=new t.ui.Toolbar(this.container);e.el.classList.add("floating-toolbar","btn-group"),e.el.classList.remove("toolbar-action-buttons"),e.addButton('<i class="fa fa-fw fa-minus-square"></i>').addEventListener("click",()=>this.zoomOut()),this.buttonReset=e.addButton("100%"),this.buttonReset.addEventListener("click",()=>this.zoomReset()),e.addButton('<i class="fa fa-fw fa-plus-square"></i>').addEventListener("click",()=>this.zoomIn())}get designer(){return this._designer}set designer(e){(this._designer=e)?this.setZoomText(e.zoom):this.setZoomText(100)}setZoomText(e){this.buttonReset.textContent=e+"%"}zoomIn(){this.designer.zoom+=5,this.setZoomText(this.designer.zoom)}zoomOut(){this.designer.zoom-=5,this.setZoomText(this.designer.zoom)}zoomReset(){this.designer.zoom=100,this.setZoomText(this.designer.zoom)}}})(katrid=katrid||{}),(e=>{{class t{}(e=e.Components||(e.Components={})).Component=t;class i extends t{}e.Widget=i}})(Katrid=Katrid||{}),(e=>{{e=e.exceptions||(e.exceptions={});class t extends Error{constructor(e){super(e),Katrid.Forms.Dialogs.alert({text:e,icon:"error"})}}e.Exception=t;class i extends t{}e.ValidationError=i}})(katrid=katrid||{}),(i=>{var e,t;i.isMobile=(t=!1,e=navigator.userAgent||navigator.vendor,t=!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(e)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(e.substr(0,4)))||t),i.settings={additionalModules:[],server:"",ui:{isMobile:i.isMobile,dateInputMask:!0,defaultView:"list",goToDefaultViewAfterCancelInsert:!0,goToDefaultViewAfterCancelEdit:!1,horizontalForms:!0},services:{choicesPageLimit:10},speech:{enabled:!1}},i.isMobile?document?.body?.classList.add("mobile"):document?.body?.classList.add("desktop");let s=!1;i.init=function(){if(i.Services.Service.adapter||(i.Services.Service.adapter=new i.Services.FetchAdapter),!s){s=!0;for(var[e,t]of Object.entries(i.customElementsRegistry))customElements.define(e,t.constructor,t.options)}},i.assignElement=function(e,t){for(var i of t.attributes)e.setAttribute(i.name,i.value)},i.LocalSettings=class a{static init(){i.localSettings=new a}constructor(){}get searchMenuVisible(){return 1===parseInt(localStorage.searchMenuVisible)}set searchMenuVisible(e){localStorage.searchMenuVisible=e?1:0}}})(Katrid=Katrid||{}),(s=>{let i=!1;s.init=function(){if(!i){i=!0;for(var[e,t]of Object.entries(Katrid.customElementsRegistry))customElements.define(e,t.constructor,t.options)}},s.elementDataSymbol=Symbol("data"),s.data=function(e,t,i){return t||void 0!==i?void 0===i?e[s.elementDataSymbol]?.[t]:(e[s.elementDataSymbol]??={},void(e[s.elementDataSymbol][t]=i)):e[s.elementDataSymbol]}})(katrid=katrid||{}),(u=>{var e;{var r=u.Data||(u.Data={});let p;(e=p=r.DataSourceState||(r.DataSourceState={}))[e.inserting=0]="inserting",e[e.browsing=1]="browsing",e[e.editing=2]="editing",e[e.loading=3]="loading",e[e.inactive=4]="inactive",r.DataSource=class{constructor(e){this.config=e,this.$modifiedRecords=[],this._fieldChanging=!1,this._callbacks=[],this._pendingPromises=[],this.readonly=!1,this.$modifiedRecords=[],this.model=e.model,this.field=e.field,this._recordIndex=0,this.recordCount=null,this.loading=!1,this.loadingRecord=!1,this._masterSource=null,this.masterSource=e.master,this._pageIndex=0,this.pageLimit=e.pageLimit||100,this.offset=0,this.offsetLimit=0,this.requestInterval=300,this.pendingTimeout=null,this.pendingRequest=!1,this.children=[],this.modifiedData=null,this.uploading=0,this.fields=e.fields||e.model.fields,this.fields&&(this._fields=Array.from(Object.keys(this.fields))),this._state=null,this.fieldWatchers=[],this._pendingChanges=!1,this.action?.recordId||(this.recordId=null),this._records=[],this.vm=e.vm,this.domain=e.domain,this.context=e.context}create(e){return this.model.create(e,this)}registerCallback(e){this._callbacks.push(e)}unregisterCallback(e){this._callbacks.splice(this._callbacks.indexOf(e),1)}get pageIndex(){return this._pageIndex}set pageIndex(e){this._pageIndex=e,this.search({where:this._params,page:e,fields:this._fields,timeout:300})}get loadingRecord(){return this._loadingRecord}set loadingRecord(e){this._loadingRecord=e,this.state=this.state}get pendingRequest(){return this._pendingRequest}set pendingRequest(e){this._pendingRequest=e,this.requestCallback&&this.requestCallback(e)}get loadingAction(){return this._loadingAction}set loadingAction(e){this.requestInterval=e?0:300,this._loadingAction=e}get $form(){return this._$form}set $form(e){this._$form=e,this._record?.$record&&(this._record.$record.$form=this)}async cancel(){var e;if(this.changing)return e=this.state===p.editing,this.state=p.browsing,this._recordIndex=null,this._pendingChanges=!1,e?this.refreshRecord():void 0}_createRecord(e){return this.model.fromObject(e,this)}async copy(e){let t=await this.model.service.copy(e);return this.setRecord({}),await this.insert(),setTimeout(()=>{clearTimeout(this.pendingTimeout),this.setValues(t)},this.requestInterval),t}findById(e){for(var t of this._records)if(t.id===e)return t;return null}$removeById(e){let t=0;for(var i of this._records){if(i.id===e)return this._records.splice(t,1),i;t++}return null}hasKey(e){return null!==this.findById(e)}refresh(e){let t;return!0===(e=void 0===e?!0:e)?t=this.search({where:this._params,page:this._page,order:this.orderBy}):e?t=this.get(e[0]):this.record&&this.record.id&&(t=this.get(this.record.id)),t}refreshRecord(e){return void 0===e&&(e=this._recordId),this.get({id:e})}async validate(e,t=0){return!0}indexOf(e){if(this._records)return this._records.indexOf(this.findById(e.id))}getFieldChoices(a,e=0){return new Promise((i,t)=>{let s=new AbortController;var e=()=>{var e={field:this.field.name,config:{signal:s.signal},context:this.context,filter:a};this.parent.model.service.getFieldChoices(e).catch(e=>t(e)).then(e=>{1<this.pageIndex?this.offset=(this.pageIndex-1)*this.pageLimit+1:this.offset=1,null!=e.count&&(this.recordCount=e.count);var t=e.data;return this.rawData=t,this.readonly?this.records=t:this.records=t.map(e=>this._createRecord(e)),1===this.pageIndex?this.offsetLimit=this._records.length:this.offsetLimit=this.offset+this._records.length-1,i(e)}).finally(()=>{this.pendingRequest=!1})};this._pendingPromises.push(s),0<this.requestInterval?this.pendingTimeout=setTimeout(e,this.requestInterval):e()})}search(e){this._clearTimeout();let a=e.where;var t=e.page;let i=e.fields||this._fields,r;this.masterSource;this._params=a,this._page=t,this._fields=i,this.pendingRequest=!0,this.loading=!0,this.state=p.loading,this._pageIndex=t=t||1;let s=this.domain;s="string"==typeof s?JSON.parse(s):s||{},this.where&&Object.assign(s,this.where),i&&!Array.isArray(i)&&(i=Object.keys(i));var n=this.orderBy;return a={count:!0,page:t,where:a,fields:i,domain:s,order:n,limit:e.limit||this.pageLimit},new Promise((i,t)=>{let s=new AbortController;var e=()=>{var e=this.context;this.model.service.search(a,null,{signal:s.signal},e).catch(e=>t(e)).then(e=>{1<this.pageIndex?this.offset=(this.pageIndex-1)*this.pageLimit+1:this.offset=1,null!=e.count&&(this.recordCount=e.count);var t=e.data;return this.rawData=t,1===this.pageIndex?this.offsetLimit=t.length:this.offsetLimit=this.offset+t.length-1,this.records=t.map((e,t)=>{e=this._createRecord(e);return e.$index=t,e}),i(e)}).finally(()=>{this.pendingRequest=!1,this.state=p.browsing})};this._pendingPromises.push(s),(r=0)<this.requestInterval?this.pendingTimeout=setTimeout(e,this.requestInterval):e()})}async groupBy(e,t){if(this._params=[],e?.length)return this.groups=this.vm.groups=e,this.vm.groups=await this._loadGroup(e,0,t),this.vm.groups;this.groups=[],this.vm.groups=null,this.search(t)}async _loadGroup(e,i,t,s){var a,r=[],s=(t=t||[],s&&s.$params&&(t=t.concat(s.$params)),await this.model.service.groupBy([e[i]],t)),n=e[i];console.log(s);for(a of s){let e=a[n],t;Array.isArray(e)?(t=e[0],e=e[1]):t=e,a.$str=e,a.$expanded=!1,{}[a.$group=n]=t,a.$level=i,a.$hasChildren=!0,r.push(a)}return r}goto(e){return this.recordIndex=e}moveBy(e){e=this._recordIndex+e;-1<e&&e<this._records.length&&(this.recordIndex=e),this.scrollCallback&&this.scrollCallback(this.recordIndex,this.record)}_clearTimeout(){this.loading=!1,this.loadingRecord=!1,this._canceled=!0,this.pendingRequest=!1,clearTimeout(this.pendingTimeout);for(var e of this._pendingPromises)try{e.abort()}catch{console.debug("Abort signal")}this._pendingPromises=[]}set masterSource(e){(this._masterSource=e)&&e.children.push(this)}get masterSource(){return this._masterSource}applyModifiedData(i,e,t){var s=this.getModifiedData(i,e,t),i=u.hash(t);if(s){let e=this.modifiedData,t=(e=null==e?{}:e)[i];for(var a in t||(t={},e[i]=t),s){var r=s[a];t[a]=r}this.modifiedData=e,this.masterSource.scope.form.$setDirty()}return s}async save(t=!0){var e,i=this.record.$flush(!0);if(!0!==i)throw i.showError(),Error("Validation error");for(e of this.children)e.changing&&e.flush();if(await this.validate()){i=this.record.$serialize();if(i)return this.uploading++,this.model.service.write([i]).then(e=>(this._pendingChanges=!1,this.state=p.browsing,Array.isArray(e)&&1===e.length&&(e=e[0]),t?this.refreshRecord(e):e)).catch(t=>{let i=`<span>${u.i18n.gettext("The following fields are invalid:")}<hr></span>`;if(t.message)i=t.message;else if(t.messages){var s;for(s of Object.keys(t.messages)){var a=t.messages[s];let e;if(-1<s.indexOf(".")){var r,n=s.split("."),o=n[1];for(r of this.children)r.scope.fieldName===n[0]&&(e=r.scope.view.fields[o])}else e=this.scope.view.fields[s];if(e&&e.name){i+=`<strong>${e.caption}</strong><ul>`;for(var d of a)i+=`<li>${d}</li>`;i+="</ul>"}}}throw u.Forms.Dialogs.Alerts.error(i),new Error(i)}).finally(()=>this.uploading--);u.Forms.Dialogs.Alerts.warn(u.i18n.gettext("No pending changes"))}}async delete(e){await this.model.service.delete(e)}_getNested(e){var t=[];if(e.$deleted&&e.$deleted.recs.length)for(var i of e.$deleted.recs)t.push({id:i.id,action:"DESTROY"});let s;if(e.recs.length)for(var a of e.recs)if(a){if(s={},a.$created)s={action:"CREATE",values:this._getModified(a.$modifiedData)};else{if(!a.$modified)continue;(s={action:"UPDATE",values:this._getModified(a.$modifiedData)}).values.id=a.id}t.push(s)}return t}_getModified(e){var t={};if(e)for(var[i,s]of Object.entries(e))s instanceof u.Data.SubRecords?t[i]=this._getNested(s):t[i]=s;return t}getModifiedData(e,t,i){var s={};return i.$modified&&jQuery.extend(s,this._getModified(i.$modifiedData)),this.record.id&&(s.id=i.id),s}get(e){let a=e.id,t=e.timeout,r=e.index;return this._clearTimeout(),this.state=p.loading,this.loadingRecord=!0,new Promise((i,s)=>{var e=()=>{var e=new AbortController;this._pendingPromises.push(e);let t;return this.fields&&(t=Object.keys(this.fields)),this.model.service.getById(a,{fields:t,signal:e.signal}).catch(e=>"AbortError"===e.name?s():s(e)).then(e=>{if(e){if(this.state===p.loading)this.state=p.browsing;else if(this.state===p.inserting)return;if(Array.isArray(e.data))this.record=e.data[0];else{if(!e.data)return;this.record=e.data}return!(this._record.$loaded=!0)!==r&&(this._records[r]=this.record),i(this.record)}}).finally(()=>{this.loadingRecord=!1})};if(!t&&!this.requestInterval)return e();this.pendingTimeout=setTimeout(e,t||this.requestInterval)})}async insert(e=!0,t,i){await Promise.all(this._pendingPromises),this._clearTimeout();for(var s of this.children)s._clearTimeout();var a,r=this.model.newRecord(null,this),n=this._records;this.record=r,this._records=n;let o;for(a of this.children)a.vm.records=[];e&&((i=i||{}).context=this.context,r=new AbortController,this._pendingPromises.push(r),o=await this.model.service.getDefaults(i,{signal:r.signal})),this.state=p.inserting,this.record.$str=u.i18n.gettext("(New)");var d,l,c,h={};this.masterSource&&this.field&&this.field.defaultValue&&Object.assign(h,this.field.defaultValue);for(d of Object.values(this.fields))d.defaultValue&&(h[d.name]=d.defaultValue);this.defaultValues&&Object.assign(h,this.defaultValues),o&&Object.assign(h,o),t&&Object.assign(h,t);for([l,c]of Object.entries(h))"function"==typeof c&&void 0!==(c=c(h,this))&&(h[l]=c);return this.setValues(h),this.record}setValues(e,s){s=s||this.record,Object.entries(e).forEach(([e,t])=>{var i=this.fields[e];i?i.setValue(s,t,this):s[e]=t})}edit(){this.state=p.editing}toClientValue(e,t){e=this.scope.view.fields[e];return t=e&&"DateTimeField"===e.type?new Date(t):t}fieldByName(e){return this.fields[e]}set state(e){var t=this.changing;this._modifiedFields=[],this._state=e,this.inserting=e===p.inserting,this.editing=e===p.editing,this.loading=e===p.loading,this.changing=[p.editing,p.inserting].includes(this.state),this.stateChangeCallback&&this.stateChangeCallback(e),t&&this.$form?.dirty&&this.$form.reset()}get browsing(){return this._state===p.browsing}childByName(e){for(var t of this.children)if(t.field.name===e)return t}get state(){return this._state}get record(){return this._record}set recordId(e){this._recordId=e}get recordId(){return this._recordId}set record(e){e&&(e instanceof r.DataRecord||"object"!=typeof e||(e=this.model.fromObject(e,this)),this.vm&&(this.vm.record=e,e=this.vm.record),this.dataCallback&&this.dataCallback({record:e}),this._record=e,this.recordId=e.id,this._pendingChanges=!1),this.childrenNotification(e)}setRecord(e){return e=this._createRecord(e)}set records(e){this._records=e,this.dataCallback&&this.dataCallback({records:e})}get records(){return this._records}next(){return this.moveBy(1)}prior(){return this.moveBy(-1)}nextPage(){let e=this.recordCount/this.pageLimit;Math.floor(e)&&e++,console.log("rec count",this.recordCount,this.pageLimit,e),e>this.pageIndex+1&&this.pageIndex++}prevPage(){1<this.pageIndex&&this.pageIndex--}set recordIndex(e){this._recordIndex=e;e=this._records[e];(this.record=e)?.id&&(this.action&&this.action.changeUrl("id",this.recordId),this.get(e.id))}get recordIndex(){return this._recordIndex}addRecord(e){e=this.model.newRecord(e,this);e.$flush(),this.vm.records.push(e),console.log("add record"),this.records.push(e)}async expandGroup(e,t){var i={};this._params&&Object.assign(i,this._params),t.$params&&Object.assign(i,t.$params),t.$level===this.groups.length-1?((i=await this.model.service.search({params:i})).data&&(t.$children=i.data,this.vm.groups.splice.apply(this.vm.groups,[e+1,0].concat(i.data))),this._records=this._chain(),console.debug("expand group",this._records)):(i=await this._loadGroup(this.groups,t.$level+1,this._params,t),t.$children=i,this.vm.groups.splice.apply(this.vm.groups,[e+1,0].concat(i)))}collapseGroup(e,t){let i=(e,t)=>{t.$children&&t.$children.length&&t.$level!==this.groups.length-1&&t.$children.map(e=>i(this.vm.groups.indexOf(e),e)),t.$children&&t.$children.length&&this.vm.groups.splice(e+1,t.$children.length),t.$children=[]};i(e,t),this._records=this._chain()}_chain(){let e=[];for(var t of this.vm.groups)t.$hasChildren&&t.$expanded&&t.$children.length&&(e=e.concat(t.$children));let i=0;for(var s of e)s.$index=i++;return e}_applyResponse(e){e?.value?this.setValues(e.value):e?.values&&this.setValues(e.values)}async dispatchEvent(e,...t){e=await this.model.service.rpc(e,...t);this._applyResponse(e)}open(){return this.search({},1)}get parent(){return this.masterSource}set parent(e){(this._masterSource=e)&&e.children.push(this)}$setDirty(e){}destroyChildren(){for(var e of this.children)e.scope.$destroy();this.children=[]}childrenNotification(e){for(var t of this.children)t.parentNotification(e);for(var i of this._callbacks)i(e)}async parentNotification(t){this._clearTimeout(),t&&t.$state!==r.RecordState.created&&(this.state=p.loading,this.pendingTimeout=setTimeout(async()=>{var e;null!=t.id?((e={})[this.field.info.field]=t.id,await this.getFieldChoices(e),e=this.records,t[this.field.name]=e):t[this.field.name]=[],this.state=u.Data.DataSourceState.browsing},this.requestInterval))}destroy(){this._masterSource&&this._masterSource.children.splice(this._masterSource.children.indexOf(this),1)}flush(e=!0,t=!0){return e&&this.validate(),this.record.$flush(),t&&(this.state=p.browsing),this.record}discardChanges(){this.record.$discard()}encodeObject(e){if(Array.isArray(e))return e.map(e=>this.encodeObject(e));if(u.isObject(e)){var t,i,s={};for([t,i]of Object.entries(e))t.startsWith("$")||(s[t]=this.encodeObject(i));return s}return e}static encodeRecord(e,t){var i,s={};for(i of Object.keys(t)){var a=e.fields[i];s[i]=a?a.toJSON(t[i]):s[i]}return s}$onFieldChange(t,e,i){t.name===this._lastFieldName&&clearTimeout(this.pendingTimeout),this._lastFieldName=t.name,this.pendingTimeout=setTimeout(()=>{this._fieldChanging||(this._fieldChanging=!0);try{var e=this.encode(i);this.parent&&(e[this.field.info.field]=this.parent.encode(this.parent.record)),this.dispatchEvent("admin_on_field_change",[t.name,e])}finally{this._fieldChanging=!1}},10)}encode(e){var t,i,s={};for([t,i]of Object.entries(e.$data)){var a=this.model.fields[t];!a||t.startsWith("$")||a instanceof r.OneToManyField||(s[t]=a.toJSON(i))}return s}}}})(Katrid=Katrid||{}),(e=>{(e.Data||(e.Data={})).emptyText="--"})(Katrid=Katrid||{}),(r=>{var i;(i=r.Data||(r.Data={})).Model=class{constructor(e){this.readonly=!1,this.idField="id",this.nameField="$str",this.name=e.name,this.fields=e.fields?r.Data.Fields.fromArray(e.fields):{},this.readonly=!0===e.readonly;for(var[t,i]of Object.entries(this.fields))i.name=t}get recordClass(){if(!this._recordClass){let s=this;class a extends i.DataRecord{static{this.$model=s}}var e=this.allFields||this.fields;for(let[t,i]of Object.entries(e))Object.defineProperty(a.prototype,t,{get(){return this.$data[t]},set(e){this.$dirty=!0,this.$pristine||(this.$pristine={}),this.$transient||(this.$transient={}),t in this.$pristine||(this.$pristine[t]=this.$data[t]),t in this.$transient||(this.$transient[t]=this.$data[t]),this.$data[t]=e,i instanceof r.Data.Field&&i.onChange&&s.onFieldChange&&s.onFieldChange(i,e)}});this._recordClass=a}return this._recordClass}get service(){return this._service||(this._service=new r.Services.ModelService(this.name)),this._service}create(e,t){return this.newRecord(e,t)}newRecord(e,t){let s=new this.recordClass;return s.$state=i.RecordState.created,e&&Object.entries(e).forEach(([e,t])=>{var i=(this.allFields||this.fields)[e];i?i.setValue(s,t):s[e]=t}),t?.parent?.record&&(s.$parent=t.parent.record,s.$parentField=t.field?.name),s}fromObject(e,t){e=new this.recordClass(e);return e.$state=i.RecordState.unmodified,t?.parent&&(e.$parent=t.parent.record,e.$parentField=t.field?.name),e}fromArray(e){return e.map(e=>this.fromObject(e))}flush(e){e.$flush()}discard(e){e.$discard()}validate(e){for(var t of Object.values(this.fields))t.validate(e[t.name])}}})(Katrid=Katrid||{}),(e=>{var t;{var o=e.Data||(e.Data={});let n;(t=n=o.RecordState||(o.RecordState={}))[t.unmodified=0]="unmodified",t[t.destroyed=1]="destroyed",t[t.created=2]="created",t[t.modified=3]="modified",o.DataRecord=class{constructor(e={}){this.$data=e,this.hasOwnProperty("id")||(this.id=e.id),void 0!==e.record_name?this.$str=e.record_name:void 0!==e.$str&&(this.$str=e.$str)}$flush(e=!1){if(e){e=this.$validate();if(!e.valid)return e}if(this.$pending||(this.$pending={}),this.$modified||(this.$modified=[]),this.$pristine)for(var t of Object.keys(this.$pristine))this.$pending[t]=this.$data[t],this.$modified.includes(t)||this.$modified.push(t);return this.$state===n.unmodified&&(this.$state=n.modified),this.$pristine={},this.$dirty=!1,this.$parent&&(this.$parent.$childrenData||(this.$parent.$childrenData=[]),this.$parent.$childrenData.includes(this)||this.$parent.$childrenData.push(this)),!0}$validate(){return new e.Data.Validation(this).validate()}$destroy(){this.$state===n.created?this.$parent?.$childrenData?.includes(this)&&this.$parent.$childrenData.splice(this.$parent.$childrenData.indexOf(this),1):(this.$state=n.destroyed,this.$flush())}$discard(){Object.assign(this.$data,this.$pristine),this.$pristine={},this.$dirty=!1}$$discard(){this.$discard(),Object.assign(this.$data,this.$transient),this.$pending={},this.$transient={}}$serialize(){var e,t,i,s={},a=Object.getPrototypeOf(this).constructor.$model;s.id=this.id;for([e,t]of Object.entries(this.$pending))e.startsWith("$")||!(i=(a.allFields||a.fields)[e])||i instanceof o.OneToManyField||(s[e]=i.toJSON(t));if(this.$childrenData)for(var r of this.$childrenData)r.$parentField in s||(s[r.$parentField]=[]),r.$state===n.created?s[r.$parentField].push({action:"CREATE",values:r.$serialize()}):r.$state===n.modified?s[r.$parentField].push({action:"UPDATE",values:r.$serialize()}):r.$state===n.destroyed&&s[r.$parentField].push({action:"DESTROY",id:r.id});return s}$reset(){this.$pending={},this.$pristine={},this.$dirty=!1,this.$transient={}}}}})(Katrid=Katrid||{}),(e=>{(e.sql||(e.sql={})).exec=async function(e,t){return await Katrid.Services.Service.$post("/sql/exec/",{query:e,params:t,withDescription:!0,asDict:!0})}})(katrid=katrid||{}),(i=>{(i.Data||(i.Data={})).Validation=class{constructor(e){this.record=e,this.valid=!0,this.model=e.constructor.$model}validate(){this.validations=[];for(var e of Object.values(this.model.fields)){var t=e.validate(this.record[e.name]);t.length&&this.validations.push({field:e,msgs:t})}return this.valid=0===this.validations.length,this}showError(){let e="";for(var t of this.validations)e+=`<ul><li>${t.field.caption}<ul>${t.msgs.map(e=>`<li>${e}</li>`).join("")}</ul></li></ul>`;i.Forms.Dialogs.Alerts.error(e)}}})(Katrid=Katrid||{}),(s=>{(s.Data||(s.Data={})).Field=class{constructor(e){this._loaded=!1,this.attrs={},this.tag="input",this.widgetHelp="",this.visible=!0,"visible"in e&&(this.visible=e.visible),this.name=e.name,this.info=e,this.cssClass=e.type,this.caption=e.caption||e.name,this.helpText=this.info.help_text,this.required=!0===this.info.required,this.onChange=this.info.onchange,this.nolabel=!1,e.choices&&this.setChoices(e.choices),this.defaultValue=e.defaultValue,this.create(),this.loadInfo(e)}create(){this.visible=!0,this.emptyText="",this.cols=6,this.readonly=!1,this.defaultSearchLookup="__icontains"}setChoices(e){Array.isArray(e)?(this.displayChoices=s.dict(e),this.choices=e):(this.displayChoices=e,this.choices=Object.entries(e).map(([e,t])=>[e,t]))}loadInfo(e){e.cols&&(this.cols=e.cols),"readonly"in e&&(this.readonly=e.readonly),"visible"in e&&(this.visible=e.visible),e[":readonly"]&&(this.vReadonly=e[":readonly"]),""===e.required?this.required=!0:"required"in e&&(this.required=e.required),e.domain&&(this.filter=e.domain),e.filter&&(this.filter=e.filter),e.vMaxLength&&(this.vMaxLength=e.vMaxLength),e.vMinLength&&(this.vMinLength=e.vMinLength),"widget"in e&&(this.widget=e.widget),"nolabel"in e&&(this.nolabel=e.nolabel||!0)}get internalType(){return Object.getPrototypeOf(this).constructor.name}get fieldEl(){return this._fieldEl}set fieldEl(e){this._fieldEl=e,this.setElement(e)}setElement(e){}formLabel(e){var t;if(!this.attrs.nolabel)return(t=document.createElement("label")).innerText=this.attrs.caption,t.classList.add("form-label"),t}getControlId(){return"k-input-"+ ++s.$hashId}formControl(e){var t,i=document.createElement(this.tag);i.id=this.getControlId(),"input"===this.tag&&(i.type="text"),i.name=this.name,i.setAttribute("v-model","record."+this.name),i.classList.add("form-field","form-control");for(t of Object.keys(this.attrs))t.includes(":")&&i.setAttribute(t,this.attrs[t]);if(i.autocomplete="no",i.spellcheck=!1,i.setAttribute("v-input","v-input"),this.attrs["input-type"]&&i.setAttribute("type",this.attrs["input-type"]),this.attrs.required&&i.setAttribute("required","required"),this.maxLength&&(i.maxLength=this.maxLength),this.vMaxLength&&i.setAttribute(":maxlength",this.vMaxLength),this.vMinLength&&i.setAttribute(":minlength",this.vMinLength),"placeholder"===this.attrs.nolabel&&(i.placeholder=this.caption),(this.attrs.ngFieldChange||this.ngChange)&&i.setAttribute("v-on:change",this.attrs.ngFieldChange||this.ngChange),this.info?.attrs)for(var[s,a]of Object.entries(this.info.attrs))i.setAttribute(s,a.toString());return i}getValue(e){return e}getFieldAttributes(e){var t,i={};i.readonly=this.readonly,i.required=this.required,i.caption=this.caption,i.helpText=this.helpText;for(t of e.attributes)switch(t.name){case"readonly":i.readonly="false"!==t.value;break;case"required":i.required="false"!==t.value;break;case"label":i.caption=t.value;break;case"help-text":i.helpText=t.value;break;default:i[t.name]=t.value}return i}renderTo(e,t){"form"===t.getViewType()&&this.formCreate(e)}formCreate(e){var t=this.attrs=this.getFieldAttributes(e);let i;var s=t.widget||this.widget;let a,r;if(s){if((i=this.createWidget(s)).renderToForm)return i.renderToForm(e);i.formControl&&(a=i.formControl()),i.formLabel&&(r=i.formLabel())}else r=this.formLabel(e),a=this.formControl(e);let n=document.createElement("section");if(n.classList.add("form-field-section"),n.setAttribute("v-form-field",null),n.setAttribute("name",this.name),t["v-if"]&&n.setAttribute("v-if",t["v-if"]),t["v-show"]&&n.setAttribute("v-show",t["v-show"]),t[":class"]&&n.setAttribute(":class",t[":class"]),t[":readonly"]?n.setAttribute(":readonly",t[":readonly"]):t.readonly?n.setAttribute("readonly","readonly"):n.setAttribute(":readonly",`readonlyFields?.includes('${this.name}')`),t[":required"]&&n.setAttribute(":required",t[":required"]),n.classList.add("form-group"),t.cols?n.classList.add("col-md-"+t.cols):this.cols&&!isNaN(this.cols)?n.classList.add("col-md-"+this.cols):"string"==typeof this.cols&&n.classList.add(this.cols),this.cssClass&&n.classList.add(this.cssClass),r){let e=a;(e="INPUT"!==a.tagName?a.querySelector("input"):e)?.id?r.setAttribute("for",e.id):a?.id&&r.setAttribute("for",a.id),n.append(r)}n.append(a);s=this.formSpanTemplate();return s&&((e=document.createElement("div")).classList.add("form-field-readonly"),e.innerHTML=s,n.append(e)),this.createTooltip(n),n=i?i.afterRender(n):n}getTooltip(e){return new s.ui.Tooltip(e,null)}createTooltip(t){if(!s.settings.ui.isMobile){let e="";this.helpText&&(e=this.helpText),e+="<br>Field: "+this.name,this.widgetHelp&&(e+="<br>Dica:<br>"+this.widgetHelp),this.model&&(e+="<br>Model: "+this.model),t.setAttribute("data-title",e),t.setAttribute("v-ui-tooltip","$fields."+this.name)}}listCreate(e,t){var i=document.createElement("td"),s=(i.innerHTML=this.listSpanTemplate(),i.setAttribute("field-name",this.name),e.tRow.append(i),document.createElement("th"));s.innerHTML=this.listCaptionTemplate(),this.cssClass&&(i.classList.add(this.cssClass),s.classList.add(this.cssClass)),s.setAttribute("v-on:click",`columnClick('${this.name}')`),e.tHeadRow.append(s)}formSpanTemplate(){return this.hasChoices?`{{ $fields['${this.name}'].displayChoices[record.${this.name}] || '${this.emptyText}' }}`:"password"===this.attrs["input-type"]?"<span>********</span>":`<span>{{ record.${this.name} }}</span>`}listSpanTemplate(){return this.formSpanTemplate()}listCaptionTemplate(){return`<span class="grid-field-readonly">${this.caption}</span>`}cardCreate(){var e=document.createElement("span");return e.innerText=`{{ record.${this.name} }}`,e}setValue(e,t,i){e[this.name]=t}get hasChoices(){return this.info.choices&&0<this.info.choices.length}get model(){return this.info.model}get maxLength(){return this.info.max_length}get type(){return this.info.type}getParamTemplate(){return"view.param.String"}format(e){return e.toString()}getParamValue(e){return"string"==typeof e&&e.includes(";")?e.split(";").map(e=>e.trim()):e.toString()}$set(e){return e}toJSON(e){return e}createWidget(e,t){return new s.Forms.Widgets.registry[e](this,t)}validate(e){""===e&&(e=null);var t=[];return this.required&&null==e&&t.push(s.i18n.gettext("This field cannot be empty.")),t}validateForm(e,t){var i=[];return e.required&&!t&&!1!==t&&0!==t&&i.push(s.i18n.gettext("This field cannot be empty.")),i}get defaultCondition(){return"="}isControlVisible(e){switch(e){case"is null":case"is not null":return!1}return!0}getFilterConditions(){return[{name:"=",label:s.i18n.gettext("Is equal")},{name:"!=",label:s.i18n.gettext("Is different")},{name:"is not null",label:s.i18n.gettext("Is defined"),input:!1},{name:"is null",label:s.i18n.gettext("Is not defined"),input:!1}]}formBind(e,t){t=new s.Forms.BoundField(this,this.name,t);return t.container=e,t.control=e.querySelector(".form-field"),this.boundFields||(this.boundFields=[]),this.boundFields.push(t),t}formUnbind(e){if(this.boundFields)for(var t of this.boundFields)if(t.container===e){this.boundFields.splice(this.boundFields.indexOf(t),1);break}}}})(Katrid=Katrid||{}),(a=>{var r,n;function s(e,t){let i;var s;return e instanceof a.Data.Field?e:(s=e.type||"StringField",t&&!e.name&&(e.name=t),new(i=e.choices&&"ForeignKey"!==s?r.ChoiceField:n.registry[s]||a.Data.StringField)(e))}r=a.Data||(a.Data={}),(n=r.Fields||(r.Fields={})).registry={Field:r.Field},n.fromInfo=s,n.fromArray=function(i){let t={};if(Array.isArray(i)){let t={};i.forEach(e=>t[e.name]=e),i=t}return Object.keys(i).map(e=>t[e]=s(i[e],e)),t}})(Katrid=Katrid||{}),(s=>{{var e=s.Data||(s.Data={});class t extends e.Field{constructor(){super(...arguments),this.widgetHelp='<i>Pressione H para hoje</i><br><span class="fa fa-arrow-up"></span> Amanhã<br><span class="fa fa-arrow-down"></span> Ontem',this.tag="input-date"}loadInfo(e){e.cols||(e.cols=3),super.loadInfo(e)}formSpanTemplate(){return`{{ $filters.date(record.${this.name}, 'shortDate') || '${this.emptyText}' }}`}toJSON(e){return e}getParamTemplate(){return"view.param.Date"}getParamValue(e){if("string"!=typeof e)return e instanceof moment?e.format(moment.HTML5_FMT.DATE):e;{e=e.trim();let t=s.i18n.formats.shortDateFormat,i=s.i18n.formats.reShortDateFormat;return e.includes("..")?e.split("..").map(e=>moment(i.test(e.trim())?e.trim():katrid.utils.autoCompleteDate(e.trim(),t)).format(moment.HTML5_FMT.DATE)):e.includes(";")?e.split(";").map(e=>moment(i.test(e.trim())?e.trim():katrid.utils.autoCompleteDate(e.trim(),t)).format(moment.HTML5_FMT.DATE)):(i.test(e)?moment(e,s.i18n.formats.shortDateFormat):moment(katrid.utils.autoCompleteDate(e,t))).format(moment.HTML5_FMT.DATE)}}format(e){return s.isString(e)||e instanceof Date?moment(e).format(s.i18n.gettext("yyyy-mm-dd").toUpperCase()):e instanceof moment?e.format(s.i18n.gettext("yyyy-mm-dd").toUpperCase()):""}formControl(e){var t=document.createElement(this.tag);return t.setAttribute("v-model","record."+this.name),t.setAttribute("date-picker","L"),this.attrs.required&&t.setAttribute("required","true"),t.setAttribute("id",this.getControlId()),t}createTooltip(e){super.createTooltip(e),e.setAttribute(":data-tooltip",`record && record.${this.name} && $filters.dateHumanize(record.${this.name})`)}listSpanTemplate(){return`<span v-ui-tooltip="" :data-tooltip="record && record.${this.name} && $filters.dateHumanize(record.${this.name})">${this.formSpanTemplate()}</span>`}}e.DateField=t;class i extends t{formSpanTemplate(){return`{{ $filters.date(record.${this.name}, 'short') || '${this.emptyText}' }}`}create(){super.create()}listSpanTemplate(){return`<span v-ui-tooltip="" :data-tooltip="record && record.${this.name} && $filters.dateTimeHumanize(record.${this.name})">${this.formSpanTemplate()}</span>`}formControl(e){e=super.formControl(e);return e.setAttribute("date-picker","L LT"),e}createTooltip(e){super.createTooltip(e),e.setAttribute(":data-tooltip",`record && record.${this.name} && $filters.dateTimeHumanize(record.${this.name})`)}}e.DateTimeField=i;class a extends e.Field{constructor(){super(...arguments),this.tag="input-time"}loadInfo(e){e.cols||(e.cols=3),super.loadInfo(e)}create(){super.create()}formSpanTemplate(){return`{{ record.${this.name} || '${this.emptyText}' }}`}}e.TimeField=a,Object.assign(s.Data.Fields.registry,{DateField:t,DateTimeField:i,TimeField:a})}})(Katrid=Katrid||{}),(t=>{{var e=t.Data||(t.Data={});class i extends e.Field{constructor(e){e.cols||(e.cols=3),super(e)}getFilterConditions(){return[{name:"%",label:t.i18n.gettext("Contains")},{name:"!%",label:t.i18n.gettext("Not contains")}].concat(super.getFilterConditions())}}e.StringField=i;class s extends e.Field{formSpanTemplate(){return`{{ $fields.${this.name}.displayChoices[record.${this.name}] || '${this.emptyText}' }}`}formControl(e){var t=document.createElement("select"),i=(this.attrs.required&&(t.required=!0),t.classList.add("form-field","form-select"),t.name=this.name,t.setAttribute("v-model","record."+this.name),document.createElement("option"));return i.setAttribute("v-for",`(name, key) in $fields.${this.name}.displayChoices`),i.setAttribute(":value","key"),i.innerText="{{ name }}",t.append(i),t.id=this.getControlId(),t}}e.ChoiceField=s;class a extends i{formControl(){var e=super.formControl();return e.setAttribute("type","password"),e}formSpanTemplate(){return"**********************"}}e.PasswordField=a;class r extends e.Field{constructor(e){e.cols||(e.cols=3),super(e),this.nolabel=!0}formSpanTemplate(){return`{{ record.${this.name} == null ? '${this.emptyText}' : (record.${this.name} ? '${t.i18n.gettext("yes")}' : '${t.i18n.gettext("no")}') }}`}create(){super.create()}getParamTemplate(){return"view.param.Boolean"}getFilterConditions(){return[{name:"=",label:t.i18n.gettext("Is equal"),options:{yes:t.i18n.gettext("yes"),no:t.i18n.gettext("yes")}},{name:"!=",label:t.i18n.gettext("Is different")},{name:"is not null",label:t.i18n.gettext("Is defined"),input:!1},{name:"is null",label:t.i18n.gettext("Is not defined"),input:!1}]}formLabel(e){var t=document.createElement("label"),i=(t.classList.add("form-label","form-label-checkbox"),this.attrs.caption);return this.attrs.helpText?t.innerHTML=`<span>${i}</span>`:t.innerHTML=`
        <span class="checkbox-span">${i}</span>
        <span>&nbsp;</span>`,t}formControl(e){var t=document.createElement("label");t.classList.add("checkbox");let i=this.attrs.caption||this.caption;return this.helpText&&(i=this.helpText),t.innerHTML=`<input type="checkbox" name="${this.name}" class="form-field form-control" v-model="record.${this.name}">${i}<i class="fas"></i>`,t}}e.BooleanField=r;class n extends e.Field{constructor(e){e.cols||(e.cols=3),super(e),this.widgetHelp="<i>Pressione <strong>=</strong> para iniciar a calculadora</i>"}create(){super.create(),this.decimalPlaces=2,this.tag="input-decimal"}setValue(e,t){e[this.name]=null==t?null:parseFloat(t)}toJSON(e){return e&&t.isString(e)?parseFloat(e):e}$set(e){return this.toJSON(e)}formSpanTemplate(){return`{{ ((record.${this.name} != null) && $filters.toFixed(record.${this.name}, {minimumFractionDigits: 2, maximunFractionDigits: ${this.decimalPlaces}})) || '${this.emptyText}' }}`}getParamValue(e){return"string"==typeof e?e.includes("..")?e.split("..").map(e=>parseFloat(e.trim())):e.includes(";")?e.split(";").map(e=>parseFloat(e.trim())):parseFloat(e):super.getParamValue(e)}}e.NumericField=n;class o extends n{loadInfo(e){e.cols||(e.cols=3),super.loadInfo(e)}create(){super.create(),this.tag="input",this.decimalPlaces=0}formSpanTemplate(){return`{{ record.${this.name} || '${this.emptyText}' }}`}formControl(e){e=super.formControl(e);return e.setAttribute("type","number"),e}toJSON(e){return e&&t.isString(e)?parseInt(e):e}}e.IntegerField=o;class d extends n{}e.FloatField=d;class l extends n{constructor(e){super(e),this.decimalPlaces=2,this.info.attrs&&(this.decimalPlaces=this.info.attrs.decimal_places||2)}formControl(e){e=super.formControl(e);return e.setAttribute("input-decimal",this.decimalPlaces.toString()),e.setAttribute("inputmode","decimal"),e}listSpanTemplate(){return`<span class="grid-field-readonly">{{ $filters.toFixed(record.${this.name}, ${this.decimalPlaces}) }}</span>`}}e.DecimalField=l;class c extends i{constructor(){super(...arguments),this.tag="textarea"}formControl(e){e=super.formControl(e);return e.classList.add("form-field","form-control"),e.spellcheck=!0,e}}e.TextField=c;class h extends c{}e.XmlField=h;class p extends c{}e.JsonField=p;class u extends s{formControl(e){var t,i,s=document.createElement("div"),e=(s.classList.add("radio-button","radio-inline","form-field"),e.getAttribute("class"));e&&s.classList.add(...e.split(" ")),s.id=this.getControlId();let a=0;for([t,i]of Object.entries(this.displayChoices)){a++;var r=document.createElement("input"),n=s.id+"-"+a,o=(r.setAttribute("id",n),r.setAttribute("type","radio"),r.setAttribute("v-model","record."+this.name),r.setAttribute("value",t),document.createElement("label"));o.innerText=i,o.setAttribute("for",n),s.appendChild(r),s.appendChild(o)}return s}}e.RadioField=u,Object.assign(t.Data.Fields.registry,{StringField:i,BooleanField:r,DecimalField:l,NumericField:n,IntegerField:o,ChoiceField:s,TextField:c,XmlField:h,JsonField:p,RadioField:u,radio:u})}})(Katrid=Katrid||{}),(t=>{{var e=t.Data||(t.Data={});class i extends e.Field{constructor(){super(...arguments),this.tag="field-foreignkey"}formControl(e){var t=document.createElement(this.tag),e=(t.setAttribute(":field",`$fields && $fields[${this.name}]`),t.setAttribute("v-model","record."+this.name),"allow-open"in this.attrs&&t.setAttribute("allow-open",null),this.attrs["v-on:change"]&&t.setAttribute("v-on:change",this.attrs["v-on:change"]),t.setAttribute("name",this.name),this.attrs.required&&t.setAttribute("required",this.attrs.required),"placeholder"===this.attrs.nolabel&&t.setAttribute("placeholder",this.caption),t.classList.add("input-dropdown","form-field"),this.filter&&t.setAttribute("filter",this.filter),e?.hasAttribute(":filter")&&(this.vFilter=e.getAttribute(":filter")),document.createElement("input"));return e.type="text",e.className="form-field",e.spellcheck=!1,e.autocomplete="off",e.id=this.getControlId(),t.append(e),t}listSpanTemplate(){return`<a v-show="record.${this.name}" class="grid-field-readonly">{{ $filters.foreignKey(record.${this.name}) }}</a><span v-show="!record.${this.name}">${this.emptyText}</span>`}formSpanTemplate(){return t.webApp?.currentMenu?`<a v-show="record.${this.name}" :href="'#/app/?menu_id=${t.webApp.currentMenu.id}&model=${this.model}&view_type=form&id=' + $filters.pk(record.${this.name})" v-on:click.prevent="openRelatedObject(record.${this.name}, $fields.${this.name}, $event)">{{ $filters.foreignKey(record.${this.name}) }} </a><span v-show="!record.${this.name}">${this.emptyText}</span>`:`<a v-show="record.${this.name}" href="#">{{ $filters.foreignKey(record.${this.name}) }} </a><span v-show="!record.${this.name}">${this.emptyText}</span>`}create(){super.create()}setChoices(e){this.choices=e}getParamTemplate(){return"view.param.ForeignKey"}getParamValue(e){return Array.isArray(e)?e[0]:t.isObject(e)?e.id:e}format(e){return Array.isArray(e)?e[1]:t.isObject(e)?e.text:e}toJSON(e){return Array.isArray(e)?e[0]:e?.id?e.id:e}setValue(e,t){return Array.isArray(t)?e[this.name]={id:t[0],text:t[1]}:e[this.name]=t,t}getLabelById(e,t){return e.getFieldChoices({field:this.name,term:"",kwargs:{ids:[t]}})}createTooltip(e){t.settings.ui.isMobile||(super.createTooltip(e),e.setAttribute("v-ui-tooltip","$fields."+this.name),e.setAttribute(":data-tooltip",`record && record.${this.name} && (record.${this.name}.text + '<br> (ID: ' + record.${this.name}.id + ')')`))}}e.ForeignKey=i,t.filter("foreignKey",e=>e?.text),t.filter("pk",e=>e?.id),t.Data.Fields.registry.ForeignKey=i}})(Katrid=Katrid||{}),(t=>{{var e=t.Data||(t.Data={});class i extends e.Field{constructor(e){super(e),this.noImageUrl="/static/admin/assets/img/no-image.png"}get vSrc(){var e=this.attrs.ngEmptyImage||this.attrs.emptyImage&&"'"+this.attrs.emptyImage||`'${this.noImageUrl}'`;return`record.${this.name} || `+e}formSpanTemplate(){return""}formControl(){var e=document.createElement("image-field");return e.setAttribute("v-model","record."+this.name),e.innerHTML=`<img :src="${this.vSrc}">        
<div class="text-right image-box-buttons">
          <button class="btn btn-default" type="button" title="${t.i18n.gettext("Change")}"
                  onclick="$(this).closest('.image-box').find('input').trigger('click')">
            <i class="fa fa-pen"></i>
          </button>
          <button class="btn btn-default" type="button" title="${t.i18n.gettext("Clear")}" ng-click="record.${this.name} = null">
            <i class="fa fa-trash"></i>
          </button>
        </div>
`,e}}t.Data.Fields.registry.ImageField=e.ImageField=i}})(Katrid=Katrid||{}),(t=>{{var e=t.Data||(t.Data={});class i extends e.ForeignKey{constructor(){super(...arguments),this.tag="input-tags"}toJSON(e){return Array.isArray(e)?e.map(e=>e.id):t.isString(e)?e.split(","):e}loadInfo(e){super.loadInfo(e),console.debug("loadinfo",e)}formCreate(e){e=super.formCreate(e);return e.classList.add("ManyToManyField"),e}formSpanTemplate(){return`<div class="input-tags"><label class="badge badge-dark" v-for="tag in record.${this.name}">{{tag.text}}</label></div>`}}t.Data.Fields.registry.ManyToManyField=e.ManyToManyField=i}})(Katrid=Katrid||{}),(o=>{{var e=o.Data||(o.Data={});class t extends e.Field{constructor(){super(...arguments),this.viewMode="list",this.pasteAllowed=!0}create(){super.create(),this.cols=12}get editor(){let e=this.fieldEl.getAttribute("editor");return e=!e&&o.Forms.globalSettings.defaultGridInline?"inline":e}get field(){return this.info.field}loadInfo(e){super.loadInfo(e),e.views&&(this._loaded=!0),e["view-mode"]&&(this.viewMode=e["view-mode"])}async loadViews(e){if(!this._loaded){this._loaded=!0;var t={},i=this.fieldEl?.querySelector("template");if(i)for(var s of i.content.children)t[s.tagName.toLowerCase()]=s.cloneNode(!0);var a,i=new o.Services.ModelService(this.info.model),r={form:null},n=(r[this.viewMode]=null,await i.loadViews({views:r}));this.views=n.views,this.fields=n.fields,Object.values(n.views).forEach(e=>{e=e.info.fields[this.info.field];e&&(e.required=!1,e.visible=!1)});for(a of Object.keys(t))a in n.views||(n.views[a]={fields:n.fields}),n.views[a].content=t[a],n.views[a].fields=n.fields}}setElement(e){e.hasAttribute("allow-paste")&&(this.pasteAllowed=!0),e.hasAttribute("view-mode")&&(this.viewMode=e.getAttribute("view-mode"))}setValue(s,e,t){if(t){let i=t.childByName(this.name);e&&e instanceof Array&&e.map(e=>{if("CLEAR"===e.action&&s[this.name]){for(var t of s[this.name])t.$destroy();s[this.name]=[]}else"CREATE"===e.action&&(s[this.name]||(s[this.name]=[]),(e=i.model.newRecord(e.values,i)).$flush(),s[this.name].push(e))})}}formSpanTemplate(){return""}formControl(){var e=document.createElement("onetomany-field");return e.setAttribute("name",this.name),e.setAttribute("v-model","record."+this.name),this.attrs["v-on:change"]&&e.setAttribute("v-on:change",this.attrs["v-on:change"]),e}createTooltip(e){}getView(e="list"){var t,i;return this.views?(i=(t=this.views[e]).content||t.info.template,(t=new o.Forms.Views.registry[e]({name:this.model,viewInfo:t,template:i})).model.allFields=this.fields,t):"list"===e?((i=new o.Forms.TableView({model:new o.Data.Model({name:this.model,fields:this.info.views.list.fields})})).model.allFields=this.info.fields,i.allowGrouping=!1,i):"form"===e?(t=this.info.views.form||this.info.views.list,(i=new o.Forms.FormView({model:new o.Data.Model({name:this.model,fields:t.fields})})).model.allFields=this.info.fields,i):void 0}}o.Data.Fields.registry.OneToManyField=e.OneToManyField=t}})(Katrid=Katrid||{}),(e=>{{(e=e.db||(e.db={})).ClientDatabase=class{constructor(e){this.config=e,this.name=e.name,this.version=e.version,this.tables=e.tables}table(e){return new t({name:e,db:this})}open(){return new Promise((e,t)=>{let i=indexedDB.open(this.name,this.version);i.onerror=t,i.onsuccess=()=>{this.db=i.result,e(this.db)},this.config.onupgradeneeded?i.onupgradeneeded=this.config.onupgradeneeded:i.onupgradeneeded=e=>{console.log("upgrade neeed");let t=e.target.result;if(this.tables)for(var i of this.tables.filter(e=>!t.objectStoreNames.contains(e)))"string"==typeof i?t.createObjectStore(i,{keyPath:"id"}):t.createObjectStore(i.name,i.options)}})}transaction(e,t="readwrite"){return this.db.transaction(e,t)}};class t{constructor(e){this.db=e.db,this.name=e.name}all(e){return new Promise((t,i)=>{let s=this.db.transaction([this.name],"readonly");let a=s.objectStore(this.name).getAll(e);a.onsuccess=e=>t(a.result),a.onerror=e=>i(s.error)})}delete(e){return new Promise((t,i)=>{let s=this.db.transaction([this.name],"readwrite");let a=s.objectStore(this.name).delete(e);a.onsuccess=e=>t(a.result),a.onerror=e=>i(s.error)})}clear(){return new Promise((t,i)=>{let s=this.db.transaction([this.name],"readwrite");let a=s.objectStore(this.name).clear();a.onsuccess=e=>t(a.result),a.onerror=e=>i(s.error)})}get(e){return new Promise((t,i)=>{let s=this.db.transaction([this.name],"readonly");let a=s.objectStore(this.name).get(e);a.onsuccess=e=>t(a.result),a.onerror=e=>i(s.error)})}put(r,n){return new Promise((t,i)=>{let s=this.db.transaction([this.name],"readwrite");var e=s.objectStore(this.name);let a;(a=null!=n?e.put(r):e.put(r,n)).onsuccess=e=>t(a.result),a.onerror=e=>i(s.error)})}}e.ClientTable=t}})(katrid=katrid||{}),(e=>{(e.design||(e.design={})).ClipboardManager=class{constructor(e){this.designer=e}async getClipboardData(){var e=await navigator.clipboard.readText();if(e&&"selection"===(e=JSON.parse(e)).type)return e}prepareCopyData(){var e=this.designer.selection.map(e=>e.dump());return JSON.stringify({type:"selection",objects:e})}async copy(){await navigator.clipboard.writeText(this.prepareCopyData())}pasteData(e){if("selection"===e.type){var t,i=[];for(t of e.objects){var s=this.designer.loadObject(t);this.designer.pasteObject(s).locked=!1,this.designer.addToSelection(s),i.push(s)}return this.designer.clearSelection(),i}console.error("Invalid clipboard data")}async paste(){var e=await this.getClipboardData();if(e)return this.pasteData(e)}}})(katrid=katrid||{}),(e=>{{class i{constructor(e){this.el=e,this.width=8,this.height=8}set left(e){this.el.setAttribute("x",""+e)}set top(e){this.el.setAttribute("y",""+e)}set width(e){this.el.setAttribute("width",""+e)}set height(e){this.el.setAttribute("height",""+e)}}(e.design||(e.design={})).GrabHandles=class{constructor(e){this._dragging=!1,this.gridX=4,this.gridY=4,this.snapToGrid=!1,this.container=e.container,this.target=e.target,this.onObjectResized=e.onObjectResized,this.onObjectResizing=e.onObjectResizing,this.designer=e.designer,this.handles=[],this.createHandles(),this.setPosition(),e.snapToGrid&&(this.gridX=e.gridX,this.gridY=e.gridY,this.snapToGrid=!0)}set dragging(e){this._dragging=e,this.designer.resizing=e}get dragging(){return this._dragging}createHandle(){var e=document.createElementNS("http://www.w3.org/2000/svg","rect");return e.classList.add("resize-handle"),this.handles.push(e),e}clear(){for(var e of this.handles)e.remove();this.handles=[]}setPosition(){var e=this.target.getDesignRect();let t=new i(this.bottomLeft);t.left=e.left-3,t.top=e.bottom-5,(t=new i(this.middleLeft)).left=e.left-3,t.top=e.bottom-e.height/2-4,(t=new i(this.topLeft)).left=e.left-3,t.top=e.top-3,(t=new i(this.topRight)).left=e.right-4,t.top=e.top-3,(t=new i(this.middleRight)).left=e.right-4,t.top=e.bottom-e.height/2-4,(t=new i(this.bottomRight)).left=e.right-4,t.top=e.bottom-5,(t=new i(this.topCenter)).left=e.right-e.width/2-4,t.top=e.top-3,(t=new i(this.bottomCenter)).left=e.right-e.width/2-4,t.top=e.bottom-5}_setGrabHandle(){this.topLeft.addEventListener("pointerdown",e=>{e.stopPropagation(),e.preventDefault();let t=e.target,a=e.clientX,r=e.clientY,i=(this.snapToGrid&&(a=Math.trunc(a/this.gridX)*this.gridX,r=Math.trunc(r/this.gridY)*this.gridY),this.dragging=!0,e.pointerId&&t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=i.clientY,t=i.clientX;this.snapToGrid&&(t=Math.trunc(t/this.gridX)*this.gridX,e=Math.trunc(e/this.gridY)*this.gridY);var i=t-a,s=e-r;(i||s)&&(this.applyRect(i,s,-i,-s),i&&(a=t),s)&&(r=e)}});t.addEventListener("pointermove",i),t.addEventListener("pointerup",e=>{e.pointerId&&t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",i))},{once:!0})}),this.topRight.addEventListener("pointerdown",e=>{let t=e.target,a=e.clientX,r=e.clientY,i=(this.snapToGrid&&(a=Math.trunc(a/this.gridX)*this.gridX,r=Math.trunc(r/this.gridY)*this.gridY),this.dragging=!0,e.stopPropagation(),e.preventDefault(),e.pointerId&&t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=i.clientX,t=i.clientY;this.snapToGrid&&(e=Math.trunc(e/this.gridX)*this.gridX,t=Math.trunc(t/this.gridY)*this.gridY);var i=e-a,s=t-r;(i||s)&&(this.applyRect(0,s,i,-s),i&&(a=e),s)&&(r=t)}});t.addEventListener("pointermove",i),t.addEventListener("pointerup",e=>{e.pointerId&&t.setPointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",i))},{once:!0})}),this.bottomRight.addEventListener("pointerdown",e=>{let t=e.target,a=e.clientX,r=e.clientY,i=(this.snapToGrid&&(a=Math.trunc(a/this.gridX)*this.gridX,r=Math.trunc(r/this.gridY)*this.gridY),this.dragging=!0,e.stopPropagation(),e.preventDefault(),e.pointerId&&t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=i.clientX,t=i.clientY;this.snapToGrid&&(e=Math.trunc(e/this.gridX)*this.gridX,t=Math.trunc(t/this.gridY)*this.gridY);var i=e-a,s=t-r;(i||s)&&(this.applyRect(0,0,i,s),i&&(a=e),s)&&(r=t)}});t.addEventListener("pointermove",i),t.addEventListener("pointerup",e=>{e.pointerId&&t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",i))},{once:!0})}),this.middleLeft.addEventListener("pointerdown",e=>{let t=e.target,i=e.clientX,s=(this.snapToGrid&&(i=Math.trunc(i/this.gridX)*this.gridX),this.dragging=!0,e.stopPropagation(),e.preventDefault(),e.pointerId&&t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),this.dragging){let e=t.clientX;t=(e=this.snapToGrid?Math.trunc(e/this.gridX)*this.gridX:e)-i;t&&(this.applyRect(t,0,-t,0),i=e)}});t.addEventListener("pointermove",s),t.addEventListener("pointerup",e=>{e.pointerId&&t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",s))},{once:!0})}),this.middleRight.addEventListener("pointerdown",e=>{let t=e.target,i=(e.stopPropagation(),e.preventDefault(),e.clientX),s=(this.snapToGrid&&(i=Math.trunc(i/this.gridX)*this.gridX),this.dragging=!0,e.pointerId&&t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),t.stopPropagation(),this.dragging){let e=t.clientX;t=(e=this.snapToGrid?Math.trunc(e/this.gridX)*this.gridX:e)-i;t&&(this.applyRect(0,0,t,0),i=e)}});t.addEventListener("pointermove",s),t.addEventListener("pointerup",e=>{e.pointerId&&t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",s))},{once:!0})}),this.bottomCenter.addEventListener("pointerdown",e=>{let t=e.target,i=e.clientY,s=(this.snapToGrid&&(i=Math.trunc(i/this.gridY)*this.gridY),this.dragging=!0,e.stopPropagation(),e.preventDefault(),e.pointerId&&t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),this.dragging){let e=t.clientY;t=(e=this.snapToGrid?Math.trunc(e/this.gridY)*this.gridY:e)-i;t&&(this.applyRect(0,0,0,t),i=e)}});t.addEventListener("pointermove",s),t.addEventListener("pointerup",e=>{e.pointerId&&t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",s))},{once:!0})}),this.topCenter.addEventListener("pointerdown",e=>{let t=e.target,i=e.clientY,s=(this.snapToGrid&&(i=Math.trunc(i/this.gridY)*this.gridY),this.dragging=!0,e.stopPropagation(),e.preventDefault(),e.pointerId&&t.setPointerCapture(e.pointerId),t=>{if(t.preventDefault(),this.dragging){let e=t.clientY;t=(e=this.snapToGrid?Math.trunc(e/this.gridY)*this.gridY:e)-i;t&&(this.applyRect(0,t,0,-t),i=e)}});t.addEventListener("pointermove",s),t.addEventListener("pointerup",e=>{e.pointerId&&t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",s))},{once:!0})}),this.bottomLeft.addEventListener("pointerdown",e=>{let t=e.target,a=e.clientX,r=e.clientY,i=(this.snapToGrid&&(a=Math.trunc(a/this.gridX)*this.gridX,r=Math.trunc(r/this.gridY)*this.gridY),this.dragging=!0,e.stopPropagation(),e.preventDefault(),e.pointerId&&t.setPointerCapture(e.pointerId),i=>{if(i.preventDefault(),this.dragging){let e=i.clientX,t=i.clientY;this.snapToGrid&&(e=Math.trunc(e/this.gridX)*this.gridX,t=Math.trunc(t/this.gridY)*this.gridY);var i=e-a,s=t-r;(i||s)&&(this.applyRect(i,0,-i,s),i&&(a=e),s)&&(r=t)}});t.addEventListener("pointermove",i),t.addEventListener("pointerup",e=>{e.pointerId&&t.releasePointerCapture(e.pointerId),this.dragging&&(e.preventDefault(),this.dragging=!1,this.resized(),t.removeEventListener("pointermove",i))},{once:!0})})}createHandles(){let e;return this.bottomLeft=e=this.createHandle(),e.classList.add("bottom-left"),this.middleLeft=e=this.createHandle(),e.classList.add("middle-left"),this.topLeft=e=this.createHandle(),e.classList.add("top-left"),this.topRight=e=this.createHandle(),e.classList.add("top-right"),this.middleRight=e=this.createHandle(),e.classList.add("middle-right"),this.bottomRight=e=this.createHandle(),e.classList.add("bottom-right"),this.topCenter=e=this.createHandle(),e.classList.add("top-center"),this.bottomCenter=e=this.createHandle(),e.classList.add("bottom-center"),this.container.append(...this.handles),this.setPosition(),this._setGrabHandle(),this}resized(){this.onObjectResized&&this.onObjectResized({target:this.target})}applyRect(e=0,t=0,i=0,s=0){var a;this.designer&&100!==this.designer.zoom&&(e/=a=this.designer.zoom/100,t/=a,i/=a,s/=a),this.target.designer?this.target.designer.designApplyRect(e,t,i,s):(this.target.x+=e,this.target.y+=t,this.target.width+=i,this.target.height+=s),this.setPosition(),this.onObjectResizing?.({target:this.target})}destroy(){for(var e of this.handles)e.remove();this.handles=[]}}}})(katrid=katrid||{}),(e=>{{class t{create(){}redraw(){}}(e=e.design||(e.design={})).Rule=t;class i extends t{}e.HorizontalRule=i;class s extends t{}e.VerticalRule=s}})(katrid=katrid||{}),(e=>{{var t=e.design||(e.design={});class i extends e.drawing.BaseWidget{constructor(e){super(),this.text=e}defaultProps(){super.defaultProps(),this.width=100,this.height=20}get font(){return this._font||(this._font={name:"Helvetica",size:"9pt",color:"#000000"}),this._font}set font(e){this._font=e,this.applyStyle()}get hAlign(){return this._hAlign}set hAlign(e){this._hAlign=e,this.applyStyle()}get vAlign(){return this._vAlign}set vAlign(e){this._vAlign=e,this.applyStyle()}applyStyle(){this.designer.redraw(this)}}t.TextWidget=i}})(katrid=katrid||{}),(e=>{(e.design||(e.design={})).UndoManager=class{constructor(e){this.designer=e,this.enabled=!0,this.stack=[],this.index=-1,this.capacity=100}beginUpdate(){this.enabled=!1}endUpdate(){this.enabled=!0}add(e,t,i){this.enabled&&(this.stack.splice(this.index+1),this.stack.push({action:e,data:t,description:i}),this.index++,this.stack.length>this.capacity)&&this.stack.shift()}undo(){try{this.enabled=!1,-1<this.index&&(this.undoEntry(this.stack[this.index]),this._redoEntry&&(this.stack[this.index]=this._redoEntry,this._redoEntry=null),this.index--)}finally{this.enabled=!0}}redo(){try{this.enabled=!1,this.index<this.stack.length-1&&(this.index++,this.redoEntry(this.stack[this.index]))}finally{this.enabled=!0}}resizeSelection(e){this.add("resize",e.map(e=>({target:e,x:e.x,y:e.y,w:e.width,h:e.height})))}moveSelection(e){this.add("move",e.map(e=>({target:e,x:e.x,y:e.y})))}addRedo(e){this._redoEntry?this._redoEntry.data.push(e.data):this._redoEntry=e}undoMoveObject(e,t){this.addRedo({action:"move",description:t,data:e.map(e=>({target:e.target,x:e.target.x,y:e.target.y}))});for(var i of e)i.target.designer.moveTo(i.x,i.y)}undoResizeObject(e){this.addRedo({action:"resize",data:e.map(e=>({target:e.target,x:e.target.x,y:e.target.y,w:e.target.width,h:e.target.height}))});for(var t of e)t.target.designer.setRect(t.x,t.y,t.w,t.h)}undoPaste(e){for(var t of e.reverse())this.undoEntry(t)}undoProperty(e){for(var t of e)t.target[t.property]=t.value,t.target.redraw()}undoRemove(e){for(var t of e)(t.parent||this.designer).addObject(t)}undoEntry(e){switch(e.action){case"add":this.designer.removeObjects(e.data);break;case"move":this.undoMoveObject(e.data,e.description);break;case"resize":this.undoResizeObject(e.data);break;case"paste":this.undoPaste(e.data);break;case"property":this.undoProperty(e.data);break;case"remove":this.undoRemove(e.data)}}redoEntry(e){switch(e.action){case"add":for(var t of e.data)this.designer.addObject(t);break;case"move":this.undoMoveObject(e.data);break;case"resize":this.undoResizeObject(e.data);break;case"paste":this.redoPaste(e.data);break;case"property":this.redoProperty(e.data)}}}})(katrid=katrid||{}),(e=>{function n(e){var t=document.createElement("div"),i=document.createElement("div"),s=document.createElement("div"),s=(i.className="modal",s.className="modal-dialog modal-xl modal-fullscreen-md-down",t.className="modal-content",i.appendChild(s),s.append(t),!1!==e.header&&((s=document.createElement("div")).className="modal-header","string"==typeof e.header&&(s.innerHTML=`<h5 class="modal-title">${e.header}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>`),t.appendChild(s)),document.createElement("div"));return s.className="modal-body",t.appendChild(s),!1!==e.footer&&((s=document.createElement("div")).className="modal-footer","string"==typeof e.footer&&(s.innerHTML=e.footer),t.appendChild(s)),i}(e=e.ui||(e.ui={})).createDialogElement=n,e.confirm=function(r){return new Promise(e=>{let t=n({header:r.title,autoDestroy:!0});var i=t.querySelector(".modal-footer");let s=document.createElement("button"),a=(s.innerText=Katrid.i18n.gettext("OK"),s.classList.add("btn","btn-outline-secondary"),s.type="button",s.addEventListener("click",()=>{a.hide(),e(!0)}),i.appendChild(s),(s=document.createElement("button")).innerText=Katrid.i18n.gettext("Cancel"),s.type="button",s.classList.add("btn","btn-outline-secondary","ms-1"),s.addEventListener("click",()=>{a.hide(),e(!1)}),i.appendChild(s),r.dom&&t.querySelector(".modal-body").appendChild(r.dom),document.body.appendChild(t),t.addEventListener("hidden.bs.modal",e=>{t.remove(),a.dispose()}),new bootstrap.Modal(t));a.show()})}})(katrid=katrid||{}),(t=>{var e=t.drawing||(t.drawing={});{e=e.editors||(e.editors={});var i=t.design.FontProperty,s=t.design.HAlignProperty,a=t.design.VAlignProperty,r=t.design.TextProperty,n=t.design.BorderProperty,o=t.design.BackgroundProperty,d=t.design.BooleanProperty,l=t.design.DisplayFormatProperty;class c extends t.design.WidgetEditor{static defineProperties(){return[new i("font",{caption:"Font"}),new s("hAlign",{caption:"H Alignment"}),new a("vAlign",{caption:"V Alignment"}),new r("text",{caption:"Text"}),new n("border",{caption:"Border"}),new o("background"),new d("wrap",{caption:"Word wrap"}),new d("canGrow",{caption:"Can Grow"}),new d("allowTags",{caption:"Allow HTML Tags"}),new d("allowExpression",{caption:"Allow Expression"}),new l("displayFormat")].concat(...super.defineProperties(),new t.design.StringProperty("margins",{caption:"Margins"}))}async showEditor(){var e=await t.bi.showCodeEditor(this.targetObject.text,this.targetObject.allowTags?"html":"text");!1!==e&&(this.targetObject.text=e)}}e.TextObjectEditor=c;class h extends t.design.WidgetEditor{static defineProperties(){return super.defineProperties().concat(new t.design.StringProperty("field",{caption:"Field Name (Expression)"}),new t.design.ComponentProperty("datasource",{caption:"Data Source",onGetValues:e=>e.designer.report.datasources.map(e=>({value:e,text:e.name}))}),new t.design.BooleanProperty("center",{caption:"Center"}))}}e.ImageEditor=h;class p extends t.design.WidgetEditor{static defineProperties(){return super.defineProperties().concat(new t.design.StringProperty("field",{caption:"Field Name (Expression)"}),new t.design.StringProperty("barcodeType",{caption:"Barcode Type"}),new t.design.ComponentProperty("datasource",{caption:"Data Source",onGetValues:e=>e.designer.reportDesigner.report.datasources.map(e=>({value:e,text:e.name}))}),new t.design.BooleanProperty("center",{caption:"Center"}))}}e.BarcodeEditor=p,t.design.registerComponentEditor(t.drawing.Text,c),t.design.registerComponentEditor(t.drawing.Barcode,p),t.design.registerComponentEditor(t.drawing.Image,h)}})(katrid=katrid||{}),(e=>{(e=e.drawing||(e.drawing={})).pointInRect=function(e,t,i){return e>=i.left&&e<=i.right&&t>=i.top&&t<=i.bottom},e.rectInRect=function(e,t){return(t.left>=e.left&&t.left<=e.right||t.right>=e.left&&t.right<=e.right||e.left>=t.left&&e.left<=t.right||e.right>=t.left&&e.right<=t.right)&&(t.top>=e.top&&t.top<=e.bottom||t.bottom>=e.top&&t.bottom<=e.bottom||e.top>=t.top&&e.top<=t.bottom||e.bottom>=t.top&&e.bottom<=t.bottom)}})(katrid=katrid||{}),(e=>{e.drawing||(e.drawing={})})(katrid=katrid||{}),(s=>{{var e=s.Forms||(s.Forms={});class a{constructor(e,t=null){this.menu=e,"-"===(this.text=t)?(this.el=document.createElement("div"),this.el.classList.add("dropdown-divider")):(this.el=document.createElement("a"),this.el.classList.add("dropdown-item")),this.el.innerHTML=t}addEventListener(e,t,i){return this.el.addEventListener(e,t,i)}get index(){return this.menu.items.indexOf(this)}}e.MenuItem=a;class t extends a{constructor(e){super(e,"-")}}e.MenuItemSeparator=t;class r{static{this.instances=[]}constructor(e=null){this.container=e,this.items=[],e||(this.container=document.body)}add(e,t){let i=this.insert(-1,e);return"-"!==i.text&&i.addEventListener("mouseup",e=>{this.close(),t&&t(e,i)}),i.addEventListener("mousedown",e=>e.stopPropagation()),i}insert(e,t){let i;return s.isString(t)?i=new a(this,t):t instanceof a&&(i=t),-1===e?this.items.push(i):this.items.splice(e,0,i),i}addSeparator(){this.items.push(new t(this))}destroyElement(){this.el&&this.el.remove()}createElement(){this.el=document.createElement("div"),this.el.classList.add("dropdown-menu","context-menu");for(var e of this.items)this.el.append(e.el)}show(e,t,i=null){this.destroyElement(),this.createElement(),this.el.style.left=e+"px",this.el.style.top=t+"px",this.target=i,this._visible=!0,this._eventHook=e=>{e.target.parentElement!==this.el&&this.close()},this._eventKeyDownHook=e=>{27===e.keyCode&&this.close()},document.addEventListener("mousedown",this._eventHook),document.addEventListener("pointerdown",this._eventHook,{once:!0}),document.addEventListener("wheel",this._eventHook),document.addEventListener("keydown",this._eventKeyDownHook),document.body.append(this.el);Popper.createPopper({getBoundingClientRect(){return{width:0,height:0,left:e,top:t,right:e,bottom:t}}},this.el,{placement:"auto-start"});this.el.classList.add("show"),r.instances.push(this)}close(){document.removeEventListener("mousedown",this._eventHook),document.removeEventListener("wheel",this._eventHook),document.removeEventListener("keydown",this._eventKeyDownHook),this.el.remove(),this._eventHook=null;var e=r.instances.indexOf(this);-1<e&&r.instances.splice(e,1)}get visible(){return this._visible}static closeAll(){for(var e of Array.from(this.instances))e.close()}}e.ContextMenu=r}})(Katrid=Katrid||{}),(e=>{(e.ui||(e.ui={})).ContextMenu=Katrid.Forms.ContextMenu})(katrid=katrid||{}),(e=>{{e=e.Forms||(e.Forms={});let a={};class r{static render(i,s){for(let[e,t]of Object.entries(a))t.prototype instanceof r?new t(i,s):t instanceof Function&&s.querySelectorAll(e).forEach(e=>t.call(i,e))}selector(){}constructor(e,t){this.view=e;e=t.querySelectorAll(this.selector());e.length&&this.prepare(e,t)}prepare(e,t){}assign(e,t){t.innerHTML=e.innerHTML;for(var i of e.attributes)t.setAttribute(i.name,i.value)}}e.CustomTag=r;class i extends r{prepare(e,i){var s,a=i.querySelector(".toolbar-action-buttons");for(s of e.values())if(this.view.toolbarVisible){let e;var r=s.getAttribute("name");let t;(t=r?i.querySelector(`.btn-actions[name=${r}]`):t)?e=t.parentElement:((e=document.createElement("div")).classList.add("btn-group"),e.innerHTML='<div class="dropdown"><button type="button" class="btn btn-outline-secondary dropdown-toggle btn-actions" data-bs-toggle="dropdown"></button><div class="dropdown-menu custom-actions"></div></div>',t=e.querySelector("button"),r&&t.setAttribute("name",r),(r=s.getAttribute("caption"))&&(t.innerHTML=r+" "),a.append(e));var n,o=e.querySelector(".dropdown-menu"),r=s.getAttribute("v-show"),r=(r&&e.setAttribute("v-show",r),s.getAttribute("v-if"));r&&e.setAttribute("v-if",r);for(n of s.querySelectorAll("action"))o.append(this.prepareAction(n)),n.remove()}else s.remove()}selector(){return"actions"}prepareAction(e){var t=document.createElement("a");if(t.classList.add("dropdown-item"),this.assign(e,t),t.hasAttribute("data-action"))t.setAttribute("v-on:click",`action.onActionLink('${e.getAttribute("data-action")}', '${e.getAttribute("data-action-type")}', null, $event)`);else if("object"===t.getAttribute("type")&&t.hasAttribute("name"))t.setAttribute("v-on:click",`action.formButtonClick(record.id, '${t.getAttribute("name")}')`);else if("object"===t.getAttribute("type")&&t.hasAttribute("name"))t.setAttribute("v-on:click",`formButtonClick({params: {id: record.id}, method: '${t.getAttribute("name")}'})`);else if("view-action"===t.getAttribute("type")&&t.hasAttribute("name")){let e="";t.hasAttribute("confirm-dialog")&&(e=`, confirm: \`${t.getAttribute("confirm-dialog").replaceAll("`","\\``")}\``),t.hasAttribute("prompt-dialog")&&(e=`, prompt: \`${t.getAttribute("prompt-dialog").replaceAll("`","\\``")}\``),t.setAttribute("v-on:click",`callAdminViewAction({action: '${t.getAttribute("name")}'${e}})`)}else"sub-action"===t.getAttribute("type")&&t.hasAttribute("name")&&t.setAttribute("v-on:click",`callSubAction('${t.getAttribute("name")}')`);return e.hasAttribute("name")&&t.setAttribute("name",e.getAttribute("name")),e.hasAttribute("id")&&t.setAttribute("id",e.id),e.hasAttribute("caption")&&(t.innerHTML=e.getAttribute("caption")),e.hasAttribute("binding-params")&&t.setAttribute("data-binding-params",e.getAttribute("binding-params")),t}}function t(e,t){a[e]=t}e.ActionsTag=i,(e.registerCustomTag=t)(":scope > actions",i)}})(Katrid=Katrid||{}),(n=>{var e=n.Forms||(n.Forms={});function r(e,t,i){var s=document.createElement("div");s.classList.add("modal"),s.tabIndex=-1;let a=`
        <button type="button" name="btn-ok" class="btn btn-primary">OK</button>
        <button type="button" name="btn-cancel" class="btn btn-secondary" data-bs-dismiss="modal">${n.i18n.gettext("Cancel")}</button>
    `;if(i){a="";for(var r of i)"string"==typeof r&&(a+=(e=>{let t='<button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">';switch(e){case"close":t+=n.i18n.gettext("Close");break;case"cancel":t+=n.i18n.gettext("Cancel")}return t+="</button>"})(r))}return s.innerHTML=`<div class="modal-dialog modal-xl modal-fullscreen-md-down" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">${e}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      ${t||""}
      </div>
      <div class="modal-footer">
      ${a}
      </div>
    </div>
  </div>`,s}e=e.Dialogs||(e.Dialogs={}),window.toastr&&(toastr.options={closeButton:!0,progressBar:!0,timeOut:6e4}),e.Alerts=class{static success(e){return n.UI.Toast.success({message:e})}static warning(e){return n.UI.Toast.warning({message:e})}static warn(e){return n.UI.Toast.warning({message:e})}static info(e){return n.UI.Toast.info({message:e})}static error(e){return n.UI.Toast.danger({message:e})}},e.WaitDialog=class{static show(){$("#loading-msg").show()}static hide(){$("#loading-msg").hide()}},e.ExceptionDialog=class{static show(e,t,i){var s=document.createElement("div");s.classList.add("modal"),s.tabIndex=-1,s.setAttribute("role","dialog"),s.innerHTML=`<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger"><i class="fa fa-fw fa-bug text-danger"></i> ${e}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      ${t||""}
      </div>
      <div class="modal-footer">
        <button type="button" name="btn-cancel" class="btn btn-outline-secondary" data-bs-dismiss="modal">${n.i18n.gettext("Close")}</button>
      </div>
    </div>
  </div>`,$(s).modal()}},e.toast=function(e){var t=$(`<div role="alert" aria-live="assertive" aria-atomic="true" class="toast" data-autohide="false">
  <div class="toast-header">
    <img class="rounded mr-2">
    <strong class="mr-auto">Bootstrap</strong>
    <small>11 mins ago</small>
    <button type="button" class="ml-2 mb-1 close" data-bs-dismiss="toast" aria-label="Close">
      <span aria-hidden="true">&times;</span>
    </button>
  </div>
  <div class="toast-body">
    Hello, world! This is a toast message.
  </div>
</div>`);console.log(t[0]),document.body.append(t[0]),t.toast({autohide:!1})},e.alert=function(e,t,i){return n.UI.Toast.danger({message:e.text})},e.createModal=r,e.createDialog=function(e,t,i){let s=r(e,t,i),a=new bootstrap.Modal(s);return s.addEventListener("hidden.bs.modal",e=>{s.remove(),a.dispose()}),a}})(Katrid=Katrid||{}),(e=>{{var t=e.Forms||(e.Forms={});t.BoundField=class{constructor(e,t,i){this.field=e,this.name=t,this.fieldEl=i,this._dirty=!1,this._touched=!1,this._valid=!0}focus(){this.control.focus()}get dirty(){return this._dirty}set dirty(e){(this._dirty=e)?(this.control.classList.remove("v-pristine"),this.control.classList.add("v-dirty")):(this.control.classList.remove("v-dirty"),this.control.classList.add("v-pristine"))}get required(){var e;return this.container.hasAttribute("required")?""===(e=this.container.getAttribute("req"))||"true"===e||"null"===e:this.field.required}reset(){this.dirty&&(this.dirty=!1),this.touched&&(this.touched=!1)}get touched(){return this._touched}set touched(e){this._touched=e,this.control&&(this.control.classList.remove("v-untouched"),this.control.classList.add("v-touched"))}get valid(){return this._valid}set valid(e){(this._valid=e)?(this.control.classList.remove("v-invalid"),this.control.classList.add("v-valid")):(this.control.classList.remove("v-valid"),this.control.classList.add("v-invalid"))}get pristine(){return!this.dirty}set pristine(e){this.dirty=!e}get invalid(){return!this._valid}set invalid(e){this.valid=!e}get untouched(){return!this._touched}set untouched(e){this.touched=!e}};class i{constructor(e){this.el=e,this.fields={},this.touched=!1,this.valid=!0,this.dirty=!1,this._loading=!1}setFieldValue(e,t){e=this.fields[e.name];if(e)for(var i of e)i.dirty=!0;this.dirty=!0}setValid(e){if(!(this.valid=e))for(var t of Object.values(this.fields))t.forEach(e=>e.valid=!0)}reset(){if(this.dirty){this.dirty=!1,this.touched=!1;for(var e of Object.values(this.fields))e.forEach(e=>e.reset())}}setLoading(e){this._loading=e}}t.DataForm=i,e.directive("data-form",{mounted(e){e.classList.add("v-data-form");e.$form=new i(e)}}),e.directive("form-field",{mounted(e,t,i){let s;"INPUT"===(s="INPUT"===e.tagName?e:e.querySelector("input"))?.tagName&&s.addEventListener("mouseup",()=>{s.select()})}})}})(Katrid=Katrid||{}),(e=>{(e.Forms||(e.Forms={})).ModelViewInfo=class{constructor(e){this.info=e,this._pending=!0,this.fields=e.fields}async loadPendingViews(){if(this._pending){this._pending=!1;var e,t=this.template;for(e of Array.from(t.querySelectorAll("field"))){var i=e.getAttribute("name");i&&(i=this.fields[i])&&(i.fieldEl=e)}await Promise.all(Object.values(this.fields).filter(e=>e.loadViews).map(e=>e.loadViews()))}}get template(){return e.html(this.info.template)}}})(Katrid=Katrid||{}),(h=>{{var r=h.Forms||(h.Forms={});function n(e){navigator.clipboard.writeText(h.UI.Utils.tableToText(e))}async function o(t){var i=h.i18n.gettext("Yes").toLowerCase();h.i18n.gettext("No").toLowerCase();let e=await navigator.clipboard.readText();let s=0;var a,r={};for(a of(e=e.includes("\t")?e:";").split("\n")){if(0<s&&(a=a.trim())){var n,o={};let e=0;for(n of a.split("\t")){var d,l,c=t.$view.$columns[e];c&&(c instanceof h.Data.ForeignKey?n&&(r[c.name]||(r[c.name]={}),(d=r[c.name])[n]||(l=await t.$view.model.service.getFieldChoice({field:c.name,term:n,kwargs:{exact:!0}})).items?.length&&(d[n]=l.items[0]),o[c.name]=d[n]):c instanceof h.Data.BooleanField?(n=n.trim().toLowerCase())&&(1===n.length?o[c.name]=n===i[0]:"0"===n?o[c.name]=!1:"1"===n?o[c.name]=!0:o[c.name]=n===i):o[c.name]=n),e++}t.$addRecord(o)}s++}}function d(e,t){e=e.getAttribute("field-name");e&&(t=t[e],this.$view.action.addFilter(e,t))}r.selectionSelectToggle=function(e){e.$selected=!e.$selected,e.$selected&&!this.selection.includes(e)?this.selection.push(e):!e.$selected&&this.selection.includes(e)&&this.selection.splice(this.selection.indexOf(e),1),this.selectionLength=this.selection.length},r.selectionToggleAll=function(e){var t,i=this.records||this.groups;this.allSelected=void 0===e?!this.allSelected:e;for(t of i)t.$hasChildren||(t.$selected=this.allSelected);this.allSelected?(this.selectionLength=i.length,this.selection=[...i]):(this.selection=[],this.selectionLength=0)},r.tableContextMenu=function(e,t){e.preventDefault(),e.stopPropagation();var i=new r.ContextMenu;i.add('<i class="fa fa-fw fa-copy"></i> Copiar',()=>n(e.target.closest("table"))),console.log(t),t.pasteAllowed&&i.add('<i class="fa fa-fw fa-paste"></i> Colar',()=>o(this)),i.show(e.pageX,e.pageY)},r.listRecordContextMenu=function(e,t,i){i.preventDefault(),i.stopPropagation();let s=i.target;"TD"!==s.tagName&&(s=$(s).closest("td")[0]),e&&!e.$selected&&(this.unselectAll(),e.$selected=!0);var a=new r.ContextMenu;s&&"TD"===s.tagName&&a.add('<i class="fa fa-fw fa-copy"></i> Copiar',()=>n(i.target.closest("table"))),this.field?.pasteAllowed&&this.$parent.dataSource.changing&&a.add('<i class="fa fa-fw fa-paste"></i> Colar',()=>o(this)),s&&"TD"===s.tagName&&(a.addSeparator(),a.add('<i class="fa fa-fw fa-filter"></i> Filtrar pelo conteúdo deste campo',()=>d.call(this,s,e)),a.add('<i class="fa fa-fw fa-paper"></i> Transformar em relatório',()=>d.call(this,s,e))),e&&(a.addSeparator(),a.add('<i class="fa fa-fw fa-trash"></i> Excluir',()=>this.deleteSelection())),a.show(i.pageX,i.pageY,s)},r.unselectAll=function(){for(var e of this.selection)e.$selected=!1;this.selection=[],this.selectionLength=0},r.selectionDelete=function(){this.allSelected=!1;for(var e of this.selection){e.$destroy();e=this.records.indexOf(e);-1<e&&this.records.splice(e,1)}this.selection=[],this.selectionLength=0,this.$onChange()};class e extends Array{constructor(){super(...arguments),this._allSelected=!1}get element(){return this._element}set element(e){this._element=e}get allSelected(){return this._allSelected}set allSelected(e){this._allSelected=e}selectToggle(e){e.$selected=!e.$selected}selectRecord(e){console.log("select record",e),e.$selected=!0,this.push(e)}toggleAll(){this.allSelected=!this.allSelected;for(var e of this.records)e.$selected=this.allSelected;this.allSelected||(this.length=0)}unselectRecord(e){$(this.element).find(`tr.selected[data-id=${e.id}]`).removeClass("selected"),this.splice(this.indexOf(e),1),this.allSelected=!1}unselectAll(){for(var e of this)$(this.element).find(`tr.selected[data-id=${e.id}]`).removeClass("selected"),e.$selected=!1;this.length=0}clear(){this._allSelected=!1,this.length=0}}r.SelectionHelper=e}})(Katrid=Katrid||{}),(e=>{{e=e.Forms||(e.Forms={});class t extends e.BaseView{constructor(e){super(e),this.container&&this.render()}}e.View=t}})(Katrid=Katrid||{}),!function(Katrid){var Reports;!function(Reports){let _counter=0;class Params{static{this.Operations={exact:"exact",in:"in",contains:"contains",startswith:"startswith",endswith:"endswith",gt:"gt",lt:"lt",between:"between",isnull:"isnull"}}static{this.Labels=null}static{this.DefaultOperations={CharField:Params.Operations.exact,IntegerField:Params.Operations.exact,DateTimeField:Params.Operations.between,DateField:Params.Operations.between,FloatField:Params.Operations.between,DecimalField:Params.Operations.between,ForeignKey:Params.Operations.exact,ModelChoices:Params.Operations.exact,SelectionField:Params.Operations.exact}}static{this.TypeOperations={CharField:[Params.Operations.exact,Params.Operations.in,Params.Operations.contains,Params.Operations.startswith,Params.Operations.endswith,Params.Operations.isnull],IntegerField:[Params.Operations.exact,Params.Operations.in,Params.Operations.gt,Params.Operations.lt,Params.Operations.between,Params.Operations.isnull],FloatField:[Params.Operations.exact,Params.Operations.in,Params.Operations.gt,Params.Operations.lt,Params.Operations.between,Params.Operations.isnull],DecimalField:[Params.Operations.exact,Params.Operations.in,Params.Operations.gt,Params.Operations.lt,Params.Operations.between,Params.Operations.isnull],DateTimeField:[Params.Operations.exact,Params.Operations.in,Params.Operations.gt,Params.Operations.lt,Params.Operations.between,Params.Operations.isnull],DateField:[Params.Operations.exact,Params.Operations.in,Params.Operations.gt,Params.Operations.lt,Params.Operations.between,Params.Operations.isnull],ForeignKey:[Params.Operations.exact,Params.Operations.in,Params.Operations.isnull],ModelChoices:[Params.Operations.exact,Params.Operations.in,Params.Operations.isnull],SelectionField:[Params.Operations.exact,Params.Operations.isnull]}}static{this.Widgets={CharField(e){return`<div><input id="rep-param-id-${e.id}" v-model="param.value1" type="text" class="form-control"></div>`},IntegerField(e){let t="";return"between"===e.operation&&(t=`<div class="col-sm-6"><input id="rep-param-id-${e.id}-2" v-model="param.value2" type="number" class="form-control"></div>`),`<div class="row"><div class="col-sm-6"><input id="rep-param-id-${e.id}" type="number" v-model="param.value1" class="form-control"></div>${t}</div>`},DecimalField(e){let t="";return"between"===e.operation&&(t=`<div class="col-6"><input id="rep-param-id-${e.id}-2" v-model="param.value2" input-decimal class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-6"><input id="rep-param-id-${e.id}" input-decimal v-model="param.value1" class="form-control"></div>${t}</div>`},DateTimeField(e){let t="";return"between"===e.operation&&(t=`<div class="col-6"><input id="rep-param-id-${e.id}-2" type="text" date-picker="L" v-model="param.value2" class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-6"><input id="rep-param-id-${e.id}" type="text" date-picker="L" v-model="param.value1" class="form-control"></div>${t}</div>`},DateField(e){let t="";return"between"===e.operation&&(t=`<div class="col-6">
<input-date class="input-group date" v-model="param.value2" date-picker="L">
<input id="rep-param-id-${e.id}-2" type="text" class="form-control form-field" inputmode="numeric" autocomplete="off">
      <label class="input-group-text btn-calendar"><i class="fa fa-calendar fa-sm"></i></label>
</input-date>
</div>`),`<div class="col-sm-12 row"><div class="col-6">
<input-date class="input-group date" v-model="param.value1" date-picker="L">
<input id="rep-param-id-${e.id}" type="text" class="form-control" inputmode="numeric" autocomplete="off">
      <label class="input-group-text btn-calendar"><i class="fa fa-calendar fa-sm"></i></label>
</input-date>
</div>${t}</div>`},ForeignKey(e){var t=e.info.field.attr("model")||e.params.model;let i="";return"in"===e.operation&&(i="multiple"),`<div><input-ajax-choices id="rep-param-id-${e.id}" ajax-choices="${t}" field-name="${e.name}" v-model="param.value1" ${i}></div>`},ModelChoices(e){let t="";return"in"===e.operation&&(t="multiple"),`<div><input-ajax-choices id="rep-param-id-${e.id}" ajax-choices="ui.action.report" model-choices="${e.info.modelChoices}" v-model="param.value1" ${t}></div>`},SelectionField(e){let t="",i="select";return t="in"===e.operation?(i="multiple-tags",'multiple="multiple" class="multiple-tags"'):'class="form-select"',`<div><${i} ${t} v-model="param.value1"><option :value="value" v-for="(name, value, index) in param.choices">{{name}}</option></${i}></div>`}}}}Reports.Params=Params,Params.Widgets.StringField=Params.Widgets.CharField;class Param{constructor(info,params){if(this.info=info,this.choices=info.choices,this.name=this.info.name,this.params=params,params?.info?.fields&&(this.field=this.params.info.fields[this.name]),this.label=this.info.label||this.params.info.caption,this.static="static"===this.info.param,this.type=this.info.type||this.field&&this.field.type||"CharField",this.defaultOperation=this.info.operation||Params.DefaultOperations[this.type],this.operation=this.defaultOperation,info.options&&(this.choices=info.options),this.exclude=this.info.exclude,this.id=++_counter,this.defaultValue=info.defaultValue,info.defaultValue)try{this.value1=eval(info.defaultValue)}catch{console.error("Error evaluating default expression for param:",this.name)}}setOperation(e,t){null==t&&(t=!0),this.createControls();var i=this.el.find("#rep-param-id-"+this.id);t&&i.focus()}createControls(){var e=this.el.find(".param-widget"),t=(e.empty(),Params.Widgets[this.type](this)),t=$(t);return e.append(t)}getOperations(){if(Params.TypeOperations[this.type])return Array.from(Params.TypeOperations[this.type]).map(e=>({id:e,text:Params.Labels[e]}))}operationTemplate(){var e=this.getOperations();return`<div class="col-sm-4"><select id="param-op-${this.id}" v-model="param.operation" class="form-select" onchange="$('#param-${this.id}').data('param').change();$('#rep-param-id-${this.id}')[0].focus()">
  ${e}
  </select></div>`}template(){let e="";return this.operation||(e=this.operationTemplate()),`<div id="param-${this.id}" class="row form-group" data-param="${this.name}"><label class="control-label">${this.label}</label>${e}<div id="param-widget-${this.id}"></div></div>`}render(e){return this.el=$(this.template()),this.el.data("param",this),this.createControls(),e.append(this.el[0])}dump(){return{name:this.name,op:this.operation,value1:this.value1,value2:this.value2,type:this.type}}}function createParamsPanel(e,t){var i=$(`<div class="params-params row">
<div v-for="param in params" class="col-lg-6 form-group">
          <div class="col-12">
            <label class="control-label">{{ param.label }}</label>
          </div>
          <div class="col-4" v-if="param.operationsVisible">
            <select v-model="param.operation" class="form-control" v-on:change="param.setOperation(param.operation)">
              <option v-for="op in param.operations" :value="op.id">{{ op.text }}</option>
            </select>
          </div>
          <div class="col param-widget">
          <report-param-widget :param="param"/>
</div>
        </div>
</div>`)[0],s=Katrid.createVm({data(){return{params:t}}});return s.mount(i),e&&e.append(i),s}Reports.Param=Param,Reports.createParamsPanel=createParamsPanel,Katrid.component("report-param-widget",{props:["param"],render(){var e=Params.Widgets[this.param.type](this.param);return Vue.compile(e)(this)},components:Katrid.componentsRegistry,directives:Katrid.directivesRegistry});class ReportEngine{static load(e){$("row").each((e,t)=>{t.addClass("row")}),$("column").each((e,t)=>{t.addClass("col")})}}Reports.ReportEngine=ReportEngine}(Reports=Katrid.Reports||(Katrid.Reports={}))}(Katrid=Katrid||{}),(n=>{{var a=n.Reports||(n.Reports={});let t=0;a.currentReport={},a.currentUserReport={},a.Report=class{constructor(e){this.action=e,this.info=this.action.info,a.currentReport=this,null==a.Params.Labels&&(a.Params.Labels={exact:n.i18n.gettext("Is equal"),in:n.i18n.gettext("Selection"),contains:n.i18n.gettext("Contains"),startswith:n.i18n.gettext("Starting with"),endswith:n.i18n.gettext("Ending with"),gt:n.i18n.gettext("Greater-than"),lt:n.i18n.gettext("Less-than"),between:n.i18n.gettext("Between"),isnull:n.i18n.gettext("Is Null")}),this.name=this.info.name,this.id=++t,this.values={},this.params=[],this.filters=[],this.groupables=[],this.sortables=[],this.totals=[]}telegram(){}getUserParams(){var i,e=$(this.container),s={data:[],file:e.find("#id-report-file").val()},a=[];for(i of this.params){let e,t;e=i.value1,t=i.value2,""===e&&(e=null),""===t&&(t=null),null!==e&&(e&&t?a.push(`${i.label}: [${e}, ${t}]`):e&&a.push(i.label+": "+e),s.data.push({name:i.name,op:i.operation,value1:e,value2:t,type:i.type}))}s.displayParams=a.join("\n");var t=e.find("#report-id-fields").val(),t=(s.fields=t,e.find("#report-id-totals").val()),t=(s.totals=t,e.find("#report-id-sorting").val()),t=(s.sorting=t,e.find("#report-id-grouping").val());return s.grouping=t,s}loadFromXml(e){var s,a={date:"DateField",datetime:"DateTimeField"},r=("string"==typeof e&&(e=$.parseXML(e).children[0]),this.action.customizableReport=e.getAttribute("customizableReport"),this.action.advancedOptions=e.getAttribute("advancedOptions"),this.model=e.getAttribute("model"),[]);for(s of e.children){var n=s.tagName;if("field"===n||"param"===n){var o=s.getAttribute("name");let e;this.info.fields&&(e=this.info.fields[o]);var d=s.getAttribute("label")||s.getAttribute("caption")||e&&e.caption||o,l=s.getAttribute("groupable"),c=s.getAttribute("sortable"),h=s.getAttribute("total");let t=s.getAttribute("param");"field"===n&&(t=t||"static");var n=s.getAttribute("required"),p=s.getAttribute("autoCreate")||n||"static"===t,u=s.getAttribute("operation"),m=s.getAttribute("default");let i=s.getAttribute("type")||$(s).data("type")||e&&e.type;i in a&&(i=a[i]);var g,v={};for(g of s.querySelectorAll("option"))v[g.getAttribute("value")]=g.childNodes[0].textContent;var f=s.getAttribute("model-choices");!i&&f&&(i="ModelChoices"),r.push({name:o,label:d,choices:v,groupable:l,sortable:c,total:h,param:t,required:n,operation:u,modelChoices:f,type:i,autoCreate:p,defaultValue:m,field:s})}}e=Array.from(e.querySelectorAll("param")).map(e=>e.getAttribute("name"));return this.load(r,e)}saveDialog(){var e=this.getUserParams(),t=window.prompt(n.i18n.gettext("Report name"),n.Reports.currentUserReport.name);return t&&(n.Reports.currentUserReport.name=t,$.ajax({type:"POST",url:this.container.find("#report-form").attr("action")+"?save="+t,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(e)})),!1}load(e,t){if(e=e||this.info.fields,t=t||[],this.fields=e,this.action.fields)for(var i of e)(this.action.fields[i.name]=i).groupable&&this.groupables.push(i),i.sortable&&this.sortables.push(i),i.total&&this.totals.push(i),i.autoCreate||(i.autoCreate=t.includes(i.name))}loadParams(){for(var e of this.fields)e.autoCreate&&this.addParam(e.name)}addParam(e,t){var i;this.container.querySelector("#params-params");for(i of this.fields)if(i.name===e){var s=new a.Param(i,this);this.params.push(s);break}}createParams(e){for(var t of this.fields){t=new a.Param(t,this);this.params.push(t)}}getValues(){}async export(e){null==e&&(e=localStorage.katridReportViewer||"pdf");var t=this.getUserParams(),e=await new n.Services.ModelService("ui.action.report").post("export_report",{args:[this.info.id],kwargs:{format:e,params:t}});if(console.debug("invoke",e.invoke),e.invoke)for(var[i,s]of Object.entries(e.invoke))katrid.invoke(i)(s);return!1}preview(){return this.export(localStorage.katridReportViewer)}renderFields(){let t;var e=$("<div></div>"),i=this.fields.map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),s=(()=>{var e=[];for(t of Array.from(this.fields))t.total&&e.push(`<option value="${t.name}">${t.label}</option>`);return e})().join("");let a=(e=$(this.container).find("#report-params")).find("#report-id-fields");return a.append($(i)).select2({tags:(()=>{var e,t=[];for(e of Array.from(this.fields))t.push({id:e.name,text:e.label});return t})()}),n.Reports.currentUserReport.params&&n.Reports.currentUserReport.params.fields&&(console.log(n.Reports.currentUserReport.params.fields),a.select2("val",n.Reports.currentUserReport.params.fields)),(a=e.find("#report-id-totals")).append(s).select2({tags:(()=>{var e,t=[];for(e of Array.from(this.fields))e.total&&t.push({id:e.name,text:e.label});return t})()}),e}renderParams(e){let t;var i=$("<div></div>"),s=(this.elParams=i,{}),a=n.Reports.currentUserReport.params;if(a&&a.data)for(var r of Array.from(a.data))s[r.name]=!0,this.addParam(r.name,r.value);for(t of Array.from(this.params))t.static&&!s[t.name]&&$(t.render(i));return e.querySelector("#params-params").append(i[0])}renderGrouping(e){var t=Array.from(this.groupables).map(e=>`<option value="${e.name}">${e.label}</option>`).join("");let i=e.find("#params-grouping").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start(){return i.select2("onSortStart")},update(){return i.select2("onSortEnd")}})}renderSorting(e){var t=Array.from(this.sortables).filter(e=>e.sortable).map(e=>`<option value="${e.name}">${e.label}</option>`).join("");let i=e.find("#params-sorting").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start(){return i.select2("onSortStart")},update(){return i.select2("onSortEnd")}})}render(e){this.container=e;let t=this.renderFields();return this.sortables.length?t=this.renderSorting(e):$(e).find("#params-sorting").hide(),this.groupables.length?t=this.renderGrouping(e):$(e).find("#params-grouping").hide(),t=this.renderParams(e)}},a.renderDialog=function(e){return`
    <div class="report-dialog">
      <form id="report-form" method="get" action="/web/reports/report/">
        <div class="data-heading panel panel-default">
          <div class="panel-body">
          <h2>${e.name}</h2>
          <div class="toolbar toolbar-action-buttons">
            <button class="btn btn-primary" type="button" v-on:click="report.preview()"><span class="fa fa-print fa-fw"></span> ${n.i18n.gettext("Preview")}</button>

            <div class="btn-group">
              <button class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                      aria-expanded="false">${n.i18n.gettext("Export")} <span class="caret"></span></button>
              <div class="dropdown-menu">
                <a class="dropdown-item" v-on:click="Katrid.Reports.Reports.preview()">PDF</a>
                <a class="dropdown-item" v-on:click="$event.preventDefault();report.telegram();">Telegram</a>
                <a class="dropdown-item" v-on:click="report.export('docx')">Word</a>
                <a class="dropdown-item" v-on:click="report.export('xlsx')">Excel</a>
                <a class="dropdown-item" v-on:click="report.export('pptx')">PowerPoint</a>
                <a class="dropdown-item" v-on:click="report.export('csv')">CSV</a>
                <a class="dropdown-item" v-on:click="report.export('txt')">${n.i18n.gettext("Text File")}</a>
              </div>
            </div>

            <div class="btn-group">
              <button class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                      aria-expanded="false">${n.i18n.gettext("My reports")} <span class="caret"></span></button>
              <ul class="dropdown-menu">
              </ul>
            </div>

          <div class="pull-right btn-group">
            <button class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"
                    aria-expanded="false"><i class="fa fa-sliders-h"></i></button>
            <div class="dropdown-menu">
              <a class="dropdown-item" v-on:click="report.saveDialog()">${n.i18n.gettext("Save")}</a>
              <a class="dropdown-item">${n.i18n.gettext("Load")}</a>
              <div class="dropdown-divider"></div>
              <h6 class="dropdown-header">Report Viewer</h6>
              <a class="dropdown-item" onclick="localStorage.setItem('katridReportViewer', 'pdf')">Visualizar em PDF</a>
              <a class="dropdown-item" onclick="localStorage.setItem('katridReportViewer', 'native')">Visualizador Nativo</a>
            </div>
          </div>

          </div>
        </div>
        </div>
        <div class="col-sm-12">
          <table class="col-sm-12" style="margin-top: 20px; display:none;">
            <tr>
              <td colspan="2" style="padding-top: 8px;">
                <label>${n.i18n.gettext("My reports")}</label>

                <select class="form-control" v-on:change="userReportChanged(userReport.id)" v-model="userReport.id">
                    <option value=""></option>
                    <option v-for="rep in userReports" :value="rep.id">{{ rep.name }}</option>
                </select>
              </td>
            </tr>
          </table>
        </div>
      <div id="report-params">
      <div id="params-fields" class="col-sm-12 form-group" v-if="customizableReport">
        <div class="checkbox"><label><input type="checkbox" v-model="paramsAdvancedOptions"> ${n.i18n.gettext("Advanced options")}</label></div>
        <div v-show="paramsAdvancedOptions">
          <div class="form-group">
            <label>${n.i18n.gettext("Printable Fields")}</label>
            <input type="hidden" id="report-id-fields"/>
          </div>
          <div class="form-group">
            <label>${n.i18n.gettext("Totalizing Fields")}</label>
            <input type="hidden" id="report-id-totals"/>
          </div>
        </div>
      </div>

      <div class="clearfix"></div>

      </div>
        <div v-if="advancedOptions">
        <div id="params-sorting" class="col-sm-12 form-group">
          <label class="control-label">${n.i18n.gettext("Sorting")}</label>
          <select multiple id="report-id-sorting"></select>
        </div>

        <div id="params-grouping" class="col-sm-12 form-group">
          <label class="control-label">${n.i18n.gettext("Grouping")}</label>
          <select multiple id="report-id-grouping"></select>
        </div>
        <hr>
        <table class="col-sm-12">
          <tr>
            <td class="col-sm-4">
              <select class="form-control" v-model="newParam">
                <option value="">--- ${n.i18n.gettext("FILTERS")} ---</option>
                <option v-for="field in report.fields" :value="field.name">{{ field.label }}</option>
              </select>
            </td>
            <td class="col-sm-8">
              <button
                  class="btn btn-outline-secondary" type="button"
                  v-on:click="report.addParam(newParam)">
                <i class="fa fa-plus fa-fw"></i> ${n.i18n.gettext("Add Parameter")}
              </button>
            </td>
          </tr>
        </table>
        <div class="clearfix"></div>
        <hr>
      </div>
      <div id="params-params" class="params-params margin-top-8 row">
        <div v-for="param in report.params" class="col-lg-6 form-group">
          <div class="col-12">
            <label class="control-label">{{ param.label }}</label>
          </div>
          <div class="col-4" v-if="param.operationsVisible">
            <select v-model="param.operation" class="form-control" ng-change="param.setOperation(param.operation)">
              <option v-for="op in param.operations" :value="op.id">{{ op.text }}</option>
            </select>
          </div>
          <div class="col param-widget">
          <report-param-widget :param="param"/>
</div>
        </div>
      </div>
      </form>
    </div>
    `}}})(Katrid=Katrid||{}),(e=>{{class i{load(e){this.metadata=e}}(e.bi||(e.bi={})).MetaDocument=class{load(e){this.type=e.type,this.pages=e.pages.map(e=>{var t=new i;return t.load(e),t})}}}})(katrid=katrid||{}),(e=>{{var t=e.Forms||(e.Forms={});class i extends t.RecordCollectionView{static{this.viewType="calendar"}static createViewModeButton(e){var t=document.createElement("button");t.type="button",t.className="btn btn-outline-secondary btn-view-list",t.innerHTML='<i class="fas fa-calendar"></i>',t.setAttribute("v-on:click","setViewMode('calendar')"),e.append(t)}beforeRender(e){var t=super.beforeRender(e);return this.fieldStart=e.getAttribute("date-start"),this.fieldEnd=e.getAttribute("date-end"),t}dataSourceCallback(e){super.dataSourceCallback(e),this._refresh(e.records)}_refresh(e){this._calendar.removeAllEvents();let t=0;for(var i of e){t++;var s={id:i.id,title:i.$str,start:i[this.fieldStart],extendedProps:{record:i,index:t}};this.fieldEnd&&(s.end=i[this.fieldEnd]),this._calendar.addEvent(s)}}renderTemplate(e){var t=document.createElement("div");return t.className="calendar-view",t}render(){var e=super.render();return setTimeout(()=>{var e=this.element.querySelector(".calendar-view");this._calendar=new FullCalendar.Calendar(e,{initialView:"dayGridMonth",height:e.parentElement.getBoundingClientRect().height,eventClick:e=>{console.debug(e.event.extendedProps),this._recordClick(e.event.extendedProps.record,e.event.extendedProps.index)}}),this._calendar.render()}),e}}e.Forms.Views.registry.calendar=t.CalendarView=i}})(Katrid=Katrid||{}),(n=>{{var e=n.Forms||(n.Forms={});class t{constructor(e){this.fields=e}renderField(e){e=e.getAttribute("name");if(e){var t=this.fields[e];if(t){if(t.visible)return t.cardCreate()}else console.error(`Field "${e}" not found`)}}render(e){var t,i,s=n.html(`
    <div class="content no-padding">
      <div class="data-panel col-12">
      
        <div class="card-view kanban" v-if="groups && groups.length" card-draggable=".card-group" card-group>

          <div v-for="group in groups" class="card-group sortable-item">
            <div class="card-header">
              <div class="card-h">{{group.$str}}</div>
              <button class="btn" v-on:click="showQuickAddDlg(group, $event)"><i class="fa fa-plus"></i></button>

            </div>
            
              <form id="card-add-group-item-dlg" v-on:submit.prevent="submitItem(group)" v-if="group.$cardShowAddGroupItemDlg">
                <div class="form-group">
                  <input type="text" v-model="newName" class="form-control" placeholder="${n.i18n.gettext("Add")}" v-on:blur="cardHideAddGroupItemDlg(group)" v-on:keydown.esc="cardHideAddGroupItemDlg(group)">
                </div>
                <button type="submit" class="btn btn-primary" v-on:mousedown.prevent.stop>${n.i18n.gettext("Add")}</button>
                <button type="submit" class="btn btn-primary" v-on:mousedown.prevent.stop>${n.i18n.gettext("Edit")}</button>
                <button type="button" class="btn btn-outline-secondary" v-on:click="cardHideAddGroupItemDlg(group)" title="${n.i18n.gettext("Discard record changes")}">${n.i18n.gettext("Discard")}</button>
              </form>

            <div class="card-items" card-draggable=".card-items" card-item>
              <div v-for="(record, index) in group.$children" class="card panel-default card-item card-link"
                v-on:click="recordClick(record, index, $event)">
            <div class="template-placeholder"></div>
              </div>
            </div>
          </div>

          <div class="card-add-group" title="${n.i18n.gettext("Click here to add new column")}" v-on:click="cardShowAddGroupDlg($event);" :data-group-name="groups[0]._paramName">
            <div v-show="!cardAddGroupDlg">
              <i class="fa fa-fw fa-chevron-right fa-2x"></i>
              <div class="clearfix"></div>
              <span class="title">${n.i18n.gettext("Add New Column")}</span>
            </div>
            <form v-show="cardAddGroupDlg" v-on:submit="cardAddGroup(newName, $event)">
            <div class="form-group">
              <input class="form-control" v-on:blur="cardAddGroupDlg=false" placeholder="${n.i18n.gettext("Add")}" v-model="cardNewName">
            </div>
              <button type="submit" class="btn btn-primary">${n.i18n.gettext("Add")}</button>
              <button type="button" class="btn btn-default">${n.i18n.gettext("Cancel")}</button>
            </form>
          </div>
        </div>
        <div class="card-view card-deck" v-else>
          <div v-for="(record, index) in records" class="card panel-default card-item card-link"
               v-on:click="recordClick(record, index, $event)">
            <div class="template-placeholder"></div>
          </div>

        <div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div><div class="card-item card-ghost"></div>
          
        </div>
      </div>
    </div>
      `);e.querySelectorAll(":scope > field").forEach(e=>{e.remove()});for(t of e.querySelectorAll("field")){var a=this.renderField(t);a&&t.replaceWith(a)}for(i of s.querySelectorAll(".template-placeholder")){var r=document.createElement("div");r.innerHTML=e.innerHTML,i.parentElement.insertBefore(r,i)}return s}}e.CardRenderer=t;class i extends e.RecordCollectionView{static{this.viewType="card"}static createViewModeButton(e){var t=document.createElement("button");t.type="button",t.className="btn btn-outline-secondary btn-view-card",t.innerHTML='<i class="fas fa-table"></i>',t.setAttribute("v-on:click","setViewMode('card')"),e.append(t)}renderTemplate(e){return new t(this.fields).render(e)}createComponent(){var e=super.createComponent();return e.methods.submitItem=function(e){console.log("add item"),this.cardHideAddGroupItemDlg(e)},e.methods.showQuickAddDlg=function(e,t){this.newName="",e.$cardShowAddGroupItemDlg=!0,setTimeout(()=>t.target.closest(".card-group").querySelector("input").focus())},e.methods.cardHideAddGroupItemDlg=function(e){e.$cardShowAddGroupItemDlg=!1},e}insert(){var e=this.model.newRecord(null,this.datasource);this.vm.records.unshift(e)}}n.Forms.Views.registry.card=e.CardView=i}})(Katrid=Katrid||{}),(e=>{{var t=e.Forms||(e.Forms={});class i extends t.RecordCollectionView{static createViewModeButton(e){var t=document.createElement("button");t.type="button",t.className="btn btn-outline-secondary btn-view-list",t.innerHTML='<i class="fas fa-chart-pie"></i>',t.setAttribute("v-on:click","setViewMode('calendar')"),e.append(t)}}e.Forms.Views.registry.chart=t.ChartView=i}})(Katrid=Katrid||{}),(r=>{{var s=r.Forms||(r.Forms={}),t=r.Data.DataSourceState;s.changingStates=[t.inserting,t.editing];class e extends s.ModelView{static{this.viewType="form"}constructor(e){if(super(e),this.dataCallbacks=[],this._pendingViews=!0,this.fields)for(var t of Object.values(this.fields))if(t.onChange){this.model.onFieldChange=(e,t)=>this.$onFieldChange(e,t);break}}create(e){super.create(e),this.nestedViews=[],this._record=e?.record||{},this._readonly=!1}get record(){return this._record}set record(e){this._record=e,this.vm.record=e;for(var t of this.dataCallbacks)t(this.vm.record);this.element&&this.element.dispatchEvent(new CustomEvent("record-changed",{detail:{record:this.vm.record}}))}addDataCallback(e){this.dataCallbacks.push(e)}get state(){return this._state}set state(e){switch(this._state=e,this.element.classList.remove("inserting","editing","changing","browsing","loading","inactive","readonly"),s.changingStates.includes(e)&&this.element.classList.add("changing"),e){case t.inserting:this.element.classList.add("inserting");break;case t.editing:this.element.classList.add("editing");break;case t.browsing:this.element.classList.add("browsing"),this.element.classList.add("readonly");break;case t.loading:this.element.classList.add("loading");break;case t.inactive:this.element.classList.add("inactive")}}setState(e){this.state=e,this.vm.state=e,this.vm.changing=this.changing,this.vm.inserting=this.inserting,this.vm.editing=this.editing}get inserting(){return this._state===t.inserting}get editing(){return this._state===t.editing}get changing(){return s.changingStates.includes(this._state)}renderField(e,t){e=e.name;if(e){var i=this.fields[e];if(i){if(t.hasAttribute("v-sum")&&this.addSumHook(i,t),!t.hasAttribute("invisible"))return i.formCreate(t)}else console.error(`Field "${e}" not found`)}}addSumHook(e,t){this.sumHooks||(this.sumHooks={});var i=t.getAttribute("v-sum");t.removeAttribute("v-sum"),i.includes(".")&&(i=(t=i.split("."))[0],t=t[1],this.sumHooks[i]||(this.sumHooks[i]=[]),this.sumHooks[i].push({field:e,fieldToSum:t}))}beforeRender(t){this._attributes=t.attributes;var e,i,s=t;s.setAttribute("autocomplete","off"),s.classList.add("row");for(e of s.querySelectorAll("field"))"FORM"===e.parentElement.tagName&&e.parentElement!==s||(i=e.getAttribute("name"))&&(i=this.fields[i])&&(i.fieldEl=e,!i.visible||e.hasAttribute("invisible")||"false"===e.getAttribute("visible")?e.remove():(i=this.renderField(i,e))&&(e.parentElement.insertBefore(i,e),e.remove()));if(this.dialog)return this.createDialog(s,this.dialogButtons);if(this.toolbarVisible){var t=r.html(`<div class="v-form form-view data-form">
      <div class="content">
        <header class="content-container-heading"></header>
        <div class="page-sheet">
          <div class="content container">
            <div class="form-sheet panel-default data-panel">
              <div class="template-placeholder">
                <a class="maximize-button" role="button" title="${r.i18n.gettext("Maximize")}"
                   onclick="$(this).closest('div.card.data-panel').toggleClass('box-fullscreen');$(this).find('i').toggleClass('fa-compress fa-expand')">
                  <i class=" fa fa-expand"></i>
                </a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>`),a=(t.insertBefore(this.createToolbar(),t.children[0]),t.querySelector("action-navbar").actionManager=this.action.actionManager,t.querySelector("header"));this.mergeHeader(a,s);let e=s.querySelector("comments");return e&&(e.parentElement.removeChild(e),(e=document.createElement("user-comments")).datasource=this.datasource,t.appendChild(e)),t.querySelector(".template-placeholder").append(s),t}return(a=document.createElement("div")).classList.add("form-view"),a.append(s),a.setAttribute("v-form",null),a}createToolbar(){var e=`<div class="data-heading panel panel-default">
      <div class="panel-body">
        <div class="row">
        <action-navbar></action-navbar>
          <div class="col-sm-6 breadcrumb-nav"></div>
          <!--p class="help-block">${this.action.config.usage||""}&nbsp;</p-->
        </div>
        <div class="toolbar row">
          <div class="col-sm-6 toolbar-action-buttons"></div>
          <div class="col-sm-6">
            <div class="float-end">
              <div class="btn-group pagination-area">
              <span v-if="recordCount">
                {{ recordIndex + 1 }} / {{ recordCount }}
              </span>
              </div>
              <div class="btn-group" role="group">
                <button id="btn-form-prior" class="btn btn-outline-secondary" type="button" @click="prior()">
                  <i class="fa fa-chevron-left"></i>
                </button>
                <button id="btn-form-next" class="btn btn-outline-secondary" type="button" @click="next()">
                  <i class="fa fa-chevron-right"></i>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>`,e=r.html(e);return this.createToolbarButtons(e),e}createElement(){super.createElement(),this._attributes&&Array.from(this._attributes).map(t=>{if(t.name.startsWith("v-on:")){let e=new Function("__ctx__",`with (__ctx__) { ${t.value} }`);this.element.addEventListener(t.name.substring(5),()=>e(this.vm))}})}createToolbarButtons(e){var e=e.querySelector(".toolbar-action-buttons"),t=document.createElement("div");return t.classList.add("btn-toolbar"),t.innerHTML=`
    <button class="btn btn-primary btn-action-save" type="button" v-bind:disabled="loadingRecord"
      v-on:click="save()" v-show="changing">
        ${r.i18n.gettext("Save")}
      </button>
      <button class="btn btn-primary btn-action-edit" type="button" v-bind:disabled="loadingRecord"
      v-on:click="edit()" v-show="!changing">
        ${r.i18n.gettext("Edit")}
      </button>
      <button class="btn btn-outline-secondary btn-action-create" type="button" v-bind:disabled="loadingRecord"
      v-on:click="insert()" v-show="!changing">
        ${r.i18n.gettext("Create")}
      </button>
      <button class="btn btn-outline-secondary btn-action-cancel" type="button" v-on:click="discard()"
      v-show="changing">
        ${r.i18n.gettext("Discard")}
      </button>
    <div class="btn-group">
      <div class="dropdown">
        <button type="button" class="btn toolbtn btn-action-refresh" v-if="!changing" v-on:click="refresh()" title="${r.i18n.gettext("Refresh")}">
          <i class="fa fa-fw fa-redo-alt"></i>
        </button>
        <button type="button" class="btn btn-outline-secondary dropdown-toggle btn-actions" name="actions" data-bs-toggle="dropdown"
                aria-haspopup="true">
          ${r.i18n.gettext("Action")} <span class="caret"></span>
        </button>
        <div class="dropdown-menu dropdown-menu-actions">
          <a class="dropdown-item" v-on:click="deleteSelection()">
<!--            <i class="fa fa-fw fa-trash-o"></i> -->
${r.i18n.gettext("Delete")}
          </a>
          <a class="dropdown-item" v-on:click="copy()">
<!--            <i class="fa fa-fw fa-files-o"></i>-->
            ${r.i18n.gettext("Duplicate")}
          </a>
        </div>
      </div>
    </div>
    <div class="btn-group">
      <attachments-button v-show="!inserting"></attachments-button>
</div>
`,e.append(t),e}getComponentData(){var e={action:this.action,attachments:null,record:this._record||{},records:[],name:"",actionView:this,loadingRecord:!1,changing:this.changing,inserting:this.inserting,editing:this.editing,state:this._state,$fields:this.fields,recordIndex:this._recordIndex,recordCount:this.recordCount,readonlyFields:null};return this._applyDataDefinition(e),e}async ready(){this.action?.params&&this.onHashChange(this.action.params)}async onHashChange(e){e=e.id;e&&this.setRecordId(e)}render(){return super.render(),this.readonly=this._readonly,null==this._state&&(this.state=t.editing),this.element}get recordIndex(){return this._recordIndex}set recordIndex(e){this._recordIndex=e,this.vm.recordIndex=e,this.record=this.records[e],this.setRecordId(this.record.id)}async setRecordId(i){setTimeout(()=>{var e,t;this._search({id:i}),this.action&&i&&(t=this.action.params,e={},Object.assign(e,t),e.id=i,t="#/app/?"+new URLSearchParams(e).toString(),setTimeout(()=>this.refresh(),1e3),window.history.pushState("","",t))},100)}edit(){this.setState(t.editing)}insert(e){return this.datasource.record=null,this.setState(t.inserting),this.datasource.insert(!0,e).then(()=>setTimeout(()=>{this.focus()}))}async save(){for(var e of this.nestedViews)e.$flush();await this.datasource.save(),this.setState(t.browsing)}discard(){this.setState(t.browsing),this._record&&(this.vm.record=this._record),this.$discard();for(var e of this.nestedViews)e.$discard()}next(){this.moveBy(1)}prior(){this.moveBy(-1)}moveBy(e){e=this._recordIndex+e;this.records.length>e&&0<=e&&(this.recordIndex=e)}back(e,t){this.action.back(e,t)}refresh(){this.datasource.get({id:this.record.id})}async copy(){var e=await this.model.service.copy(this.record.id);await this.insert(e)}createComponent(){var e=super.createComponent();let s=this;return Object.assign(e,{data(){return s.getComponentData()}}),Object.assign(e.methods,{edit(){s.edit()},insert(e){console.log("insert",e),s.insert(e)},save(){s.save()},discard(){s.discard()},next(){s.next()},prior(){s.prior()},back(e,t){s.back(e,t)},copy(){s.copy()},readonly(e,t,i){e?("*"===t&&(this.readonlyFields=Object.keys(s.model.fields)),this.readonlyFields?.length&&i?.length&&(this.readonlyFields=this.readonlyFields.filter(e=>!i.includes(e)))):this.readonlyFields=null},deleteAndClose(){s.deleteAndClose()},saveAndClose(e){s.saveAndClose(e)},discardAndClose(){s.discardAndClose()},deleteSelection(){s.deleteSelection(this.selection),this.next()},refresh(){s.refresh()},openRelatedObject(e,t,i){i=i.target;i instanceof HTMLAnchorElement&&(s.dialog?r.Forms.FormView.createNew({model:t.model,dialog:!0,id:e.id,buttons:["close"]}):r.webApp.loadPage(i.href,!1))},async doFormAction(e,t){try{s.pendingOperation++;var i=await s.model.service.rpc(e,[this.recordId],t);await s.action._evalResponseAction(i)}finally{s.pendingOperation--}},sendFile(e,t){return r.Services.Upload.sendFile({model:this.action.model,method:e,file:t,vm:this})}}),Object.assign(e.computed,{selection(){return[this.record]},recordId(){return this.record.id},$fields(){return s.fields}}),e}createDialog(e,t=["close"]){e=super.createDialog(e,t);return e.classList.add("form-view"),e}async showDialog(i){this.dialog=!0,(i=i||{}).buttons&&(this.dialogButtons=i.buttons);let s=this.element;s||(this.createElement(),await this.loadPendingViews(),s=this.render()),i?.id&&await this.setRecordId(i.id),null!=i?.state?(this.state=i.state,i.backdrop="static"):this.state=t.browsing,this.dialogPromise=new Promise(async(e,t)=>{this._modal=new bootstrap.Modal(s,i),s.addEventListener("hidden.bs.modal",()=>{this.$result||this.$discard(),e(this.$result),this._modal.dispose(),s.remove(),this._modal=null}),this._modal.show()})}$onFieldChange(e,s){var a;if(this.sumHooks&&e.name in this.sumHooks)for(a of this.sumHooks[e.name]){let i=a.fieldToSum;if(Array.isArray(s)){let t=0;s.forEach(e=>t+=e[i]||0),console.log(a.field.name,t),this.vm.record[a.field.name]=t}}e.onChange&&this.datasource&&this.datasource.$onFieldChange(e,s,this.datasource.record)}static async createNew(e){var t=await new r.Services.ModelService(e.model).getViewInfo({view_type:"form"}),i=new r.Data.Model({name:e.model,fields:t.fields}),t=new s.ModelViewInfo(t),i=(await t.loadPendingViews(),new r.Forms.FormView({model:i,info:t.info}));return e.dialog&&(i.dialog=!0,i.dialogButtons=e.buttons||[{text:"OK",click:"saveAndClose(true)"},{text:"Cancelar",dismiss:"modal"}]),i.render(),e.dialog&&(i.showDialog({backdrop:"static"}),e.id?i.setRecordId(e.id):e.record?i.record=e.record:i.insert()),i}getDisplayText(){return"{{record.$str}}"}saveAndClose(e){e?this.$result=this.datasource.save():(this.datasource.flush(),this.$result=this._record),this.closeDialog()}discardAndClose(){this.$result=!1,this.closeDialog()}recordClick(e,t,i){}focus(e){e||this.element.querySelector(".form-field")?.focus()}deleteAndClose(){var e=this.records.indexOf(this.record);e&&(this.$result=this.vm.record,this.records.splice(e,1)),this.closeDialog()}async loadPendingViews(){this._pendingViews&&(this._pendingViews=!1,await Promise.all(Object.values(this.fields).filter(e=>e.loadViews).map(e=>e.loadViews())))}$discard(){this.record.$state===r.Data.RecordState.created?(this.record.$discard(),this.datasource.state=t.browsing,this.records&&this._recordIndex&&(this.datasource.record=this.records[this._recordIndex])):this.datasource.parent?this.record.$discard():this.refresh()}}r.Forms.Views.registry.form=s.FormView=e}})(Katrid=Katrid||{}),(t=>{{var e=t.Forms||(t.Forms={});class i extends e.ModelView{static{this.viewType="search"}constructor(e,t){super(e),this._dataOffset=1,this._dataOffsetLimit=1,this.pageSize=100,this.action=t||e.action,e.resultView&&(this.resultView=e.resultView)}get resultView(){return this._resultView}set resultView(e){this._resultView=e,this.vm&&(this.vm.recordCount=e.recordCount)}getComponentData(){return{filterGroups:null,groups:null,customSearchExpanded:!1,groupByExpanded:!1,fieldList:Object.values(this.fields),field:null,searchValue:null,searchValue2:null,customFilter:[],facets:[],tempConditions:[],recordCount:this.resultView?.recordCount,pendingRequest:!1,dataOffset:1,dataOffsetLimit:1,availableItems:null,currentIndex:0,customGroupField:null}}get dataOffset(){return this._dataOffset}set dataOffset(e){this._dataOffset=e,this.vm.dataOffset=e}get dataOffsetLimit(){return this._dataOffsetLimit}set dataOffsetLimit(e){this._dataOffsetLimit=e,this.vm.dataOffsetLimit=e}get pageIndex(){return this._pageIndex}set pageIndex(e){this._pageIndex=e}nextPage(){this.pageIndex++}prevPage(){this.pageIndex--}_vmCreated(e){super._vmCreated(e),e.newCondition()}createComponent(){var e=super.createComponent();let i=this;return Object.assign(e.methods,{addFieldCondition(){this.tempFilter||(this.tempFilter=new t.Forms.Views.Search.SearchFilters(this.$view));for(var e of this.tempConditions)this.tempFilter.push(new t.Forms.Views.Search.CustomFilterItem(this.$view,e.$field,e.condition,e.value,this.tempFilter));this.tempConditions=[],this.newCondition(),this.field=null,this.fieldName=null,this.condition=null,this.controlVisible=!1,this.searchValue=void 0},newCondition(){this.tempConditions.push({fieldName:null,$field:null,condition:null,value:null,value2:null,values:null})},applyFilter(){this.addFieldCondition(),this.customFilter.push(this.tempFilter),this.tempFilter.selected=!0,this.tempCondition=null,this.tempFilter=new t.Forms.Views.Search.SearchFilters(this.$view),this.customSearchExpanded=!1},setSearchText(e){return e.length?i.controller.show():i.controller.close()},removeFacet(e){e=this.facets.indexOf(e);this.facets[e].clear(),this.facets.splice(e,1),i.controller.input.focus(),i.update(this)},update(){i.update(this)},move(e){this.currentIndex+=e,this.currentIndex>=this.availableItems.length?this.currentIndex=0:this.currentIndex<0&&(this.currentIndex=this.availableItems.length-2)},fieldChange(e){var t=e.fieldName;t?(e.$field=i.fields[t],e.conditions=i.getFieldConditions(e.$field),e.condition=Object.keys(e.conditions)[0],e.value=[null]):e.$field=null},conditionChange(e){".."===e.condition&&(2<e.value.length?e.value=[e.value[0],e.value[1]]:1===e.value.length&&(e.value=[e.value[0],null]))},addCustomGroupField(e){e&&(e=t.Forms.Views.Search.SearchGroups.fromField({view:this.$view,field:this.$view.fields[e]}),this.$view.controller.groups.push(e),e.items[0].toggle())},nextPage(){i._resultView.nextPage()},prevPage(){i._resultView.prevPage()}}),e}update(e){this._resultView&&(this._resultView.groupLength=this.controller.groupLength),this.controller.groupLength?this._resultView&&this._resultView.applyGroups(this.controller.groupBy(),this.controller.getParams()):this._resultView?this._resultView.setSearchParams(this.controller.getParams()):$(this).trigger("Katrid:updateSearch",this.controller.getParams())}beforeRender(){var e=t.html(`<div class="search-view-container"><div class="search-area">
      <div class="search-view">
        <div class="search-view-facets">
          <div class="facet-view" v-for="facet in facets">
            <span class="facet-label" v-html="facet.caption"></span>
            <span class="facet-value" v-html="facet.templateValue"></span>
            <span class="fas fa-times facet-remove" v-on:click="removeFacet(facet)"></span>
          </div>
        </div>
        <input class="search-view-input" role="search" v-on:input="setSearchText(searchText)" placeholder="${t.i18n.gettext("Search...")}" v-model="searchText">
      </div>
      <div class="col-sm-12">
        <ul class="search-dropdown-menu search-view-menu" role="menu">
          <li v-for="(item, index) in availableItems" :class="{active: currentIndex === index}">
            <a v-if="item.expandable" class="expandable" v-on:click.prevent.stop
               v-on:mousedown.prevent.stop="item.expanded=!item.expanded">
              <i class="fa" :class="{'fa-angle-down': item.expanded, 'fa-angle-right': !item.expanded}"></i>
            </a>
            <a href="#" class="search-menu-item" v-on:mousedown.prevent.stop
               v-on:click.prevent="item.select()" :class="{'indent': item.indent}" v-show="!item.test || item.test(searchText)">
              <span v-if="!item.indent" v-html="item.template"></span>
              <span v-if="item.indent">{{ item.text }}</span>
            </a>
            <a v-if="item.loading" class="search-menu-item"><i>${t.i18n.gettext("Loading...")}</i></a>
          </li>
        </ul>
      </div>
    </div>
    <div class="btn-group search-view-more-area">
      <div class="btn-group search-filter-button"></div>
      <div class="btn-group search-groupby-button"></div>
      <div class="btn-group search-filter-favorites"></div>
    </div>
    
    <div class="btn-group search-view-more-area">
      <div custom-filter class="btn-group">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" type="button" aria-expanded="false">
          <span class="fa fa-filter"></span> ${t.i18n.gettext("Filters")} <span class="caret"></span>
        </button>
        
    
<div class="dropdown-menu search-view-filter-menu">
      <div>
        <div v-for="group in filterGroups">
          <a class="dropdown-item" :class="{'selected': item.selected}" v-for="item in group.items" v-on:click.stop="item.toggle()">
            {{ item.toString() }}
          </a>
          <div class="dropdown-divider"></div>
        </div>
      </div>
      <div>
        <div v-for="filter in customFilter">
          <a class="dropdown-item" :class="{'selected': filter.selected}" v-on:click.stop="filter.toggle()" v-html="filter.toString()"></a>
          <div class="dropdown-divider"></div>
        </div>
        <a class="dropdown-item dropdown-search-item add-custom-filter" v-on:click.stop.prevent="customSearchExpanded=!customSearchExpanded">
          <i :class="{ 'fa-caret-right': !customSearchExpanded, 'fa-caret-down': customSearchExpanded }" class="fa expandable"></i>
          <span>${t.i18n.gettext("Add Custom Filter")}</span>
        </a>
        <div v-if="customSearchExpanded" v-on:click.stop.prevent>
          <div v-show="tempFilter && tempFilter.length" class="margin-bottom-8">
            <a href="#" v-on:click.prevent class="dropdown-item" v-for="filter in tempFilter" v-html="filter.toString()" title="${t.i18n.gettext("Remove item")}"></a>
          </div>
          <div class="col-12 filter-condition" v-for="(cond, condIndex) in tempConditions">
            <div v-if="condIndex > 0">
            <small>${t.i18n.gettext("or")}</small>
            </div>
            <div v-else class="margin-top-8"></div>
            <div class="form-group">
              <select class="form-select" v-model="cond.fieldName" v-on:change="fieldChange(cond)">
                <option></option>
                <option v-once v-for="field in fieldList" :value="field.name">{{ field.caption }}</option>
              </select>
            </div>
            <div class="form-group" v-if="cond.fieldName">
            <select class="form-select" v-model="cond.condition" v-on:change="conditionChange(cond)">
              <option></option>
              <option v-for="(name, value, index) in cond.conditions" :value="value">{{name}}</option>
            </select>
            </div>
            <div class="form-group" v-if="cond.fieldName && cond.condition">
              <select class="form-select" v-model="cond.value[0]" v-if="cond.$field.choices">
                <option v-for="choice in cond.$field.choices" :value="choice[0]">{{choice[1]}}</option>
              </select>
              <input class="form-control" v-model="cond.value[0]" type="text" v-else-if="cond.fieldName && (cond.$field.internalType === 'IntegerField')">
              <div v-else-if="cond.$field.internalType === 'DateField'">
<input-date class="input-group date" v-model="cond.value[0]" date-picker="L"></input-date>
<input-date class="input-group date" v-model="cond.value[1]" date-picker="L" v-if="cond.condition === '..'"></input-date>
              </div>
              <div v-else-if="cond.$field.internalType === 'DateTimeField'">
<input-date class="input-group date" v-model="cond.value[0]" date-picker="L"></input-date>
<input-date class="input-group date" v-model="cond.value[1]" date-picker="L" v-if="cond.condition === '..'"></input-date>
              </div>
              <input class="form-control" v-model="cond.value[0]" type="text" v-else-if="cond.$field.internalType === 'StringField'">

<div v-else-if="['IntegerField', 'FloatField', 'DecimalField'].includes(cond.$field.internalType)">
              <input class="form-control" v-model="cond.value[0]" type="number">
              <input class="form-control" v-model="cond.value[1]" type="number" v-if="cond.condition === '..'">
              </div>
              <input-autocomplete v-model="cond.value[0]" :data-model="cond.$field.model" v-else-if="(cond.condition === '=') && (cond.$field.internalType === 'ForeignKey')"/>
            </div>
          </div>
          <div class="col-12">
            <div class="form-group">
              <button class="btn btn-primary" type="button" v-on:click="applyFilter()">
                ${t.i18n.gettext("Apply")}
              </button>
              <button class="btn btn-outline-secondary" type="button" v-on:click="newCondition()">
                ${t.i18n.gettext("Add a condition")}
              </button>
            </div>
</div>
        </div>
      </div>
</div>    
    
      </div>
      <div class="btn-group">
        <button class="btn btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" type="button">
          <span class="fa fa-bars"></span> ${t.i18n.gettext("Group By")} <span class="caret"></span>
        </button>
        <ul class="dropdown-menu search-view-groups-menu">
        
          <div v-for="group in groups">
            <a class="dropdown-item" :class="{'selected': item.selected}" v-on:click.stop="item.toggle()" v-for="item in group.items">
              {{ item.toString() }}
            </a>
            <div class="dropdown-divider"></div>
          </div>

          <a class="dropdown-item dropdown-search-item add-custom-group" v-on:click.stop.prevent
             v-on:click="groupByExpanded=!groupByExpanded">
            <i :class="{ 'fa-caret-right': !groupByExpanded, 'fa-caret-down': groupByExpanded }"
               class="fa expandable"></i>
            <span>${t.i18n.gettext("Add Custom Group")}</span>
          </a>
          

          <div v-if="groupByExpanded" v-on:click.stop.prevent>
            <div class="col-12">
              <div class="form-group">
                <select class="form-select" v-model="customGroupField">
                  <option value=""></option>
                  <option v-for="field in fieldList" :value="field.name">{{ field.caption }}</option>
                </select>
              </div>
              <div class="form-group">
                <button class="btn btn-primary" type="button" v-on:click="addCustomGroupField(customGroupField)">
                  ${t.i18n.gettext("Apply")}
                </button>
              </div>
            </div>
          </div>
</ul>
      </div>
      <button class="btn btn-outline-secondary">
        <span class="fa fa-star"></span> ${t.i18n.gettext("Favorites")} <span class="caret"></span>
      </button>
    </div>
            <div class="float-end">
              <div class="btn-group pagination-area">
                <span v-if="pendingRequest"><i class="fas fa-spinner fa-spin"></i>  ${t.i18n.gettext("Loading...")}</span>
                <div v-if="!pendingRequest">
                <span class="paginator">{{dataOffset}} - {{dataOffsetLimit}}</span>
                  /
                  <span class="total-pages">{{recordCount}}</span>
                </div>
              </div>
              <div class="btn-group">
                <button class="btn btn-outline-secondary" type="button" v-on:click="prevPage()">
                  <i class="fa fa-chevron-left"></i>
                </button>
                <button class="btn btn-outline-secondary" type="button" v-on:click="nextPage()">
                  <i class="fa fa-chevron-right"></i>
                </button>
              </div>
              <div class="btn-view-modes btn-group" role="group"></div>
            </div>
    
    </div>`);return this.action&&this.action.createViewsButtons(e.querySelector(".btn-view-modes")),e}render(){return this.element||(this.element=this.beforeRender(),this.createVm(this.element),this.controller=new t.Forms.Views.Search.SearchViewController(this),this.controller.setContent(this.domTemplate()),this.action?.context.search_default&&setTimeout(()=>this.load(this.action.context.search_default))),this.container&&this.container.append(this.element),this.element}load(e){}renderTo(e){super.renderTo(e)}getFieldConditions(e){if(e)return e.choices?{"=":t.i18n.gettext("Is equal"),"!=":t.i18n.gettext("Is different"),"is not null":t.i18n.gettext("Is filled"),"is null":t.i18n.gettext("Is not filled")}:"StringField"===e.internalType||"EmailField"===e.internalType?{"%":t.i18n.gettext("Contains"),"!%":t.i18n.gettext("Not contains"),"=":t.i18n.gettext("Is equal"),"!=":t.i18n.gettext("Is different"),"is not null":t.i18n.gettext("Is filled"),"is null":t.i18n.gettext("Is not filled")}:"ForeignKey"===e.internalType?{"=":t.i18n.gettext("Is equal"),"!=":t.i18n.gettext("Is different"),"is not null":t.i18n.gettext("Is filled"),"is null":t.i18n.gettext("Is not filled")}:["IntegerField","DecimalField","FloatField"].includes(e.internalType)?{"=":t.i18n.gettext("Is equal"),"..":t.i18n.gettext("Between"),"!=":t.i18n.gettext("Is different"),">":t.i18n.gettext("Greater-than"),"<":t.i18n.gettext("Less-than"),"is not null":t.i18n.gettext("Is defined"),"is null":t.i18n.gettext("is not defined")}:"DateField"===e.internalType||"DateTimeField"===e.internalType?{"..":t.i18n.gettext("Between"),"=":t.i18n.gettext("Is equal"),"!=":t.i18n.gettext("Is different"),">":t.i18n.gettext("Greater-than"),"<":t.i18n.gettext("Less-than"),">=":t.i18n.gettext("Greater-than equal"),"<=":t.i18n.gettext("Less-than equal"),"is not null":t.i18n.gettext("Is defined"),"is null":t.i18n.gettext("Is not defined")}:"BooleanField"===e.internalType?{true:t.i18n.gettext("Yes"),false:t.i18n.gettext("No")}:void 0}}t.Forms.Views.registry.search=e.SearchView=i}})(Katrid=Katrid||{}),(r=>{{var a=r.Forms||(r.Forms={});class s{constructor(e,t){this.viewInfo=e,this.options=t,this.inlineEditor=!1,this.rowSelector=!1,this.columns=[]}render(e,t){e.classList.add("list-view");var i,s=this.options||{rowSelector:!0,showStar:!1,allowGrouping:!0},a=e.getAttribute("data-options"),a=(a&&(a=JSON.parse(a),Object.assign(s,a)),document.createElement("table"));a.classList.add("table","table-sm","table-striped"),this.tHead=document.createElement("thead"),this.tHeadRow=document.createElement("tr"),this.tBody=document.createElement("tbody"),this.tRow=document.createElement("tr"),s.rowSelector&&(this.tHeadRow.innerHTML=`<th class="list-record-selector">
        <input type="checkbox" v-model="allSelected" v-on:click.stop="toggleAll()">
          </th>`,this.tRow.innerHTML=`<th class="list-record-selector" v-on:click.stop="selectToggle(record)">
        <input type="checkbox" v-model="record.$selected">
          </th>`),s.showStar&&((o=document.createElement("th")).classList.add("list-record-star"),this.tHeadRow.append(o),(o=document.createElement("th")).classList.add("list-record-star"),o.title="Mark with star",o.setAttribute("v-on:click.stop","action.markStar(record)"),o.innerHTML='<i class="far fa-fw fa-star"></i>',this.tRow.append(o));for(i of e.querySelectorAll(":scope > field"))this.addField(i),i.remove();this.tRow.setAttribute(":data-id","record.id"),this.tRow.setAttribute("v-if","!groups"),this.tRow.setAttribute("v-for","(record, index) in "+(t||"records")),this.tRow.setAttribute(":selected","record.$selected"),this.tRow.setAttribute("v-on:contextmenu","recordContextMenu(record, index, $event)"),a.setAttribute("v-on:contextmenu","tableContextMenu($event)"),a.setAttribute("v-on:keydown","rowKeyDown($event)"),this.options?.recordClick?this.tRow.setAttribute("v-on:click",this.options.recordClick):this.tRow.setAttribute("v-on:click","recordClick(record, index, $event)");let r=e.getAttribute("v-tr-class");if(r&&(r.startsWith("{")||(r="{"+r+"}"),this.tRow.setAttribute(":class",r)),this.tRow.setAttribute(":class","{modified: record.$state}"),s.allowGrouping){let i=document.createElement("tr");i.setAttribute("v-else-if","groups.length > 0"),i.setAttribute("v-for","(record, index) in groups"),i.setAttribute("v-on:click","if (record.$hasChildren) toggleGroup(record); else recordClick(record, record.$index, $event);"),i.setAttribute(":class","{'group-header': record.$hasChildren}"),i.innerHTML=this.tRow.innerHTML;for(var n of i.children)n.setAttribute("v-if","!record.$hasChildren");Array.from(this.tRow.children).forEach((e,t)=>{1<t&&((t=document.createElement("td")).setAttribute("v-if","record.$hasChildren"),i.append(t))});var o=document.createElement("th");o.setAttribute("v-if","record.$hasChildren"),o.innerHTML=`<i class="fas fa-fw" :class="{'fa-chevron-right': !record.$expanded, 'fa-chevron-down': record.$expanded}"></i> <span v-text="record.$str"></span>`,this.columns.length;s.rowSelector&&0,o.setAttribute("colspan","2"),i.insertBefore(o,i.firstElementChild),this.tBody.append(i)}this.tHead.append(this.tHeadRow);t=document.createElement("tr");return t.setAttribute("v-if","loading"),t.innerHTML=`<td class="table-loading text-center" colspan="${this.tRow.children.length}">
  <div class="spinner-border ms-auto" role="status" aria-hidden="true"></div>
</td>`,this.tBody.append(t),this.tBody.append(this.tRow),a.append(this.tHead),a.append(this.tBody),this.table=a}addField(t){if(!t.hasAttribute("invisible")&&"False"!==t.getAttribute("visible")){var e=t.getAttribute("name"),i=this.viewInfo.model.fields[e];if(!i||i.visible){var s=t.innerHTML;if(!i?.visible&&i||this.columns.push(i),!e||s){var e=document.createElement("td"),a=document.createElement("th");if(a.classList.add("grid-field-readonly"),i){let e=i.caption;t.hasAttribute("caption")&&(e=t.getAttribute("caption")),a.innerHTML=`<span class="grid-field-readonly">${e}</span>`}else a.innerText=t.getAttribute("header");e.innerHTML=s,this.tHeadRow.append(a),this.tRow.append(e)}else i.listCreate(this,t)}}}compile(){}}a.ListRenderer=s;class e extends a.RecordCollectionView{constructor(){super(...arguments),this._formCounter=0,this.forms={},this._readonly=!0,this.rowSelector=!0,this.allowGrouping=!0}static{this.viewType="list"}static createViewModeButton(e){var t=document.createElement("button");t.type="button",t.className="btn btn-outline-secondary btn-view-list",t.innerHTML='<i class="fas fa-list"></i>',t.setAttribute("v-on:click","setViewMode('list')"),e.append(t)}static async createSearchDialog(e){let t=e.model;console.debug(t);var i=await(t="string"==typeof t?new r.Data.Model({name:t}):t).service.loadViews({views:{list:null,search:null}}),s=new this({name:t.name,viewInfo:i.views.list.info}),i=(e.where&&(s.datasource.domain=e.where),new r.Forms.SearchView({name:t.name,viewInfo:i.views.search.info,multiple:e.multiple,where:e.where})),e=(s.dialog=!0,s.rowSelector=!0,e.multiple&&!e.buttons&&(s.dialogButtons=[{text:"OK",click:"$closeDialog(selection)"},{text:r.i18n.gettext("Cancel"),click:"$closeDialog(null)"}]),s.render(),i.resultView=s,i.render(),s.element.querySelector(".modal-body"));return e.insertBefore(i.element,e.firstElementChild),s}create(e){!e.multiple&&null!=e.multiple||(this.rowSelector=e.multiple),super.create(e)}createSelectionInfo(e){var t=document.createElement("div");t.className="selection-info";let i=document.createElement("span");t.setAttribute("v-if","(selection.length > 0)"),i.setAttribute("v-text",'selection.length + " '+r.i18n.gettext("selected")+'"'),i.setAttribute("v-if","!allSelectionFilter"),t.append(i),(i=document.createElement("span")).setAttribute("v-if","allSelectionFilter"),i.setAttribute("v-text",'"Todos " + recordCount + " selecionados"'),t.append(i);var s=document.createElement("button");t.appendChild(s),s.type="button",s.className="btn btn-outline-secondary",s.setAttribute("v-if","(selection.length < recordCount) && allSelected && !allSelectionFilter"),s.innerHTML='<i class="fas fa-arrow-right"></i> <span>Selecionar todos {{recordCount}}</span>',s.setAttribute("v-on:click","allSelectionFilter = true"),e.appendChild(t)}showDialog(s){return s=s||{},this.dialog=!0,s.buttons?(s.buttons,this.dialogButtons=s.buttons,delete s.buttons):this.rowSelector?this.dialogButtons=[{text:"OK",click:"$closeDialog(selection)"},{text:r.i18n.gettext("Cancel"),click:"$closeDialog(null)"}]:this.dialogButtons=["close"],this.dialogPromise=new Promise(async(e,t)=>{let i=this.element;i=i||this.render(),this._modal=new bootstrap.Modal(i,s),i.addEventListener("hidden.bs.modal",()=>{e(this.vm.$result),this._modal.dispose(),i.remove(),this._modal=null}),this._modal.show()}),this.dialogPromise}createInlineEditor(){var e,t,i,s=document.createElement("tr");s.classList.add("form-view","inline-editor"),s.setAttribute("data-form-id",(++this._formCounter).toString()),this.rowSelector&&s.append(document.createElement("th"));for(e of Object.values(this.fields))e.visible&&(t=document.createElement("td"),(i=e.formControl()).setAttribute("v-form-field",null),t.append(i),s.append(t));return s}async _recordClick(e,t){await super._recordClick(e,t),this.vm.unselectAll(),e.$selected=!0,this.vm.selection=[e]}createFormComponent(e){let t=this;return{created(){this.$fields=t.fields,this.$view=t},data(){return{...r.globalData,allSelectionFilter:!1,selection:[],record:e}}}}createComponent(){let s=this;var e=super.createComponent();return Object.assign(e.methods,{tableContextMenu(e){a.tableContextMenu.call(this,...arguments)},columnClick(e){s.orderBy&&s.orderBy.includes(e)&&(e="-"+e),s.orderBy=[e],s.refresh()},recordContextMenu(e,t,i){a.listRecordContextMenu.call(this,...arguments)},unselectAll(){this.allSelectionFilter=!1,a.unselectAll.call(this,...arguments)},selectToggle(e){this.allSelectionFilter=!1,a.selectionSelectToggle.call(this,e),e.$selected?this.allSelected=this.records.every(e=>e.$selected):this.allSelected=!1},toggleAll(e){this.allSelectionFilter=!1,a.selectionToggleAll.call(this,...arguments)},async actionViewClick(e,t){try{t?.selection||(t={ids:this.selection.map(e=>e.id)}),this.pendingOperation=!0;var i=await s.model.service.rpc(e,null,t);await s.action._evalResponseAction(i)}finally{this.pendingOperation=!1}}}),e}edit(e){this.readonly=!1,this.element.removeAttribute("readonly");let t=this.element.querySelector("table").tBodies[0],i=this.createInlineEditor(),s=t.rows[e],a=(i.setAttribute("data-index",e.toString()),r.createVm(this.createFormComponent(this.vm.records[e])).mount(i));return Vue.nextTick().then(()=>{this.forms[this._formCounter]={formRow:i,relRow:s,index:e,record:a.record||{}},t.insertBefore(i,s),s&&t.removeChild(s)}),i}insert(){var e=this.model.newRecord(null,this.datasource);this.vm.records.unshift(e);e=this.edit(0).querySelector("input.form-field");e&&(e.select(),e.focus())}_removeForm(e){var t=this.forms[e];return t.formRow?.parentElement&&t.formRow.parentElement.insertBefore(t.relRow,t.formRow),t.formRow.remove(),delete this.forms[e],t}save(e){for(var t of e?[e]:Array.from(Object.keys(this.forms))){t=this._removeForm(t);-1<t.index?t.record.$flush():this.vm.records.push(t.record)}}discard(e){for(var t of e?[e]:Array.from(Object.keys(this.forms))){t=this._removeForm(t);t.record.$state===r.Data.RecordState.created&&this.vm.records.splice(this.vm.records.indexOf(t.record),1)}}renderTemplate(e){console.debug("list render",e),e.setAttribute("data-options",JSON.stringify({rowSelector:this.rowSelector}));var t=new s({model:this.model},{allowGrouping:this.allowGrouping}),i=document.createElement("div"),e=t.render(e);return i.className="table-responsive",i.append(e),this.$columns=t.columns,i}async groupBy(e){this.vm.records=this.vm.groups}}function t(t){t.stopPropagation(),t.preventDefault();var e=new a.ContextMenu;e.add('<i class="fa fa-fw fa-copy"></i> Copiar',()=>{var e;e=t.target.closest("table"),navigator.clipboard.writeText(r.UI.Utils.tableToText(e))}),e.show(t.pageX,t.pageY)}a.TableView=e,a.dataTableContextMenu=t,r.directive("table-view",{mounted(e){e.addEventListener("contextmenu",t)}}),r.Forms.Views.registry.list=e}})(Katrid=Katrid||{}),(r=>{let s={};function i(e){let t,i=(t="object"==typeof e?JSON.stringify(e):e.toString(),s[t]);return i||(i="number"==typeof e?new Intl.NumberFormat(r.i18n.languageCode,{minimumFractionDigits:e,maximumFractionDigits:e}):new Intl.NumberFormat(r.i18n.languageCode,e),s[t]=i),i}r.intl={number(e){var t={};return e?"number"==typeof e?t.minimumFractionDigits=e:e.minimumFractionDigits&&(t.minimumFractionDigits=e.minimumFractionDigits):t.maximumFractionDigits=2,e?.maximumFractionDigits&&(t.maximumFractionDigits=e.maximumFractionDigits),i(t)},toFixed:e=>i(e)};let n={d:"DD",m:"MM",M:"m",i:"mm",H:"HH"};function a(i){let s=!1,a="";for(let t=0;t<i.length;t++){let e=i[t];"\\"===e?s=!s:s||(e=n[e]||e),a+=e}return a}r.i18n={languageCode:"en-us",formats:{shortDateFormat:"YYYY-MM-DD",reShortDateFormat:/\d+[-/]\d+[-/]\d+/},catalog:{},initialize(t,e,i){r.i18n.plural=t,r.i18n.catalog=e,r.i18n.formats=((e=i).shortDateFormat=a(e.SHORT_DATE_FORMAT),e.shortDateTimeFormat=a(e.SHORT_DATETIME_FORMAT),e),r.i18n.formats.reShortDateFormat||(r.i18n.formats.reShortDateFormat=/\d+[-/]\d+[-/]\d+/),r.i18n.pluralidx=t?function(e){return t instanceof Boolean?t?1:0:t}:function(e){return 1===e?0:1}},merge(t){return Array.from(t).map(e=>r.i18n.catalog[e]=t[e])},gettext(e){var t=r.i18n.catalog[e];return null!=t?t:e},gettext_noop(e){return e},ngettext(e,t,i){var s=r.i18n.catalog[e];return null!=s?s[r.i18n.pluralidx(i)]:1===i?e:t},pgettext(e){let t=r.i18n.gettext(e);return t=-1!==t.indexOf("")?e:t},npgettext(e,t,i,s){let a=r.i18n.ngettext(e+""+t,e+""+i,s);return a=-1!==a.indexOf("")?r.i18n.ngettext(t,i,s):a},interpolate(e,t){return e=this.gettext(e),Array.isArray(t)?e.replace(/%s/g,e=>String(t.shift())):e.replace(/%\(\w+\)s/g,e=>String(t[e.slice(2,-2)]))}},window.KATRID_I18N?r.i18n.initialize(KATRID_I18N.plural,KATRID_I18N.catalog,KATRID_I18N.formats):r.i18n.gettext=e=>e})(Katrid=Katrid||{}),(katrid=katrid||{}).i18n=Katrid.i18n,(s=>{var e=s.Forms||(s.Forms={});e=e.Views||(e.Views={});{var a=e.Search||(e.Search={});class t{constructor(e){var t=(this.searchView=e).element;this.query=new a.SearchQuery(this),this.searchItems=[],this.searchFields=[],this.filterGroups=[],this.groups=[],this._groupLength=this.groupLength=0,this.facetGrouping=new a.FacetGroup,this.query=new a.SearchQuery(this),this.menu=t.querySelector(".search-dropdown-menu.search-view-menu"),this.input=t.querySelector(".search-view-input");let i=e.vm;i.filterGroups=this.filterGroups,i.groups=this.groups,this.vm=i,this.facets=this.vm.facets,this.input.addEventListener("blur",e=>{i.searchText="",this.close()}),this.input.addEventListener("keydown",e=>{switch(e.which){case s.UI.keyCode.DOWN:i.move(1),e.preventDefault();break;case s.UI.keyCode.UP:i.move(-1),e.preventDefault();break;case s.UI.keyCode.ENTER:var t=i.availableItems[i.currentIndex];t&&t.select(),i.searchText="";break;case s.UI.keyCode.BACKSPACE:""===i.searchText&&(i.facets[this.facets.length-1].clear(),i.facets.splice(this.facets.length-1,1).map(e=>e.clear()),i.update())}})}get text(){return this.vm.searchText}get schema(){return this._schema}set schema(e){(this._schema=e)&&this.setContent(e)}setContent(e){if(e instanceof HTMLElement)for(var t of e.children){var i=t.tagName;let e;if("FILTER"===i)e=a.SearchFilters.fromItem(this.searchView,t),this.filterGroups.push(e);else{if("FILTER-GROUP"===i){e=a.SearchFilters.fromGroup(this.searchView,t),this.filterGroups.push(e);continue}if("GROUP"===i){e=a.SearchGroups.fromGroup({view:this.searchView,el:t}),this.groups.push(e);continue}if("FIELD"===i){e=a.SearchField.fromField(this.searchView,t),this.searchFields.push(e);continue}if("STRINGFIELD"===i){e=a.SearchField.fromField(this.searchView,t),this.searchFields.push(e);continue}}e&&this.addItem(e)}else for(var s of e.items);}addItem(e){this.searchItems.push(e)}get availableItems(){return this._availableItems}show(){this.vm.availableItems=[],this._availableItems||(this._availableItems=[].concat(this.searchFields));for(var e of this._availableItems)e.expanded&&(e.expanded=!1);this.vm.availableItems=this._availableItems,this.menu.classList.add("show"),this.first()}close(){this.vm.availableItems=null,this.vm.searchText="",this.menu.classList.remove("show"),this.reset(),this.input.value=""}reset(){for(var e of this.searchFields)e&&e.children&&e.children.length&&(e.expanded=!1)}clear(){}addCustomFilter(e,t){var i=new a.SearchFilters(this.searchView);i.push(new a.CustomFilterItem(this,e,"=",t,i)),i.selectAll()}first(){this.vm.currentIndex=0}removeItem(e){this.facets[e].destroy(),this.facets.splice(e,1),this.update()}getParams(){let e=[];for(var t of this.vm.facets)t.grouping||(e=e.concat(t.getParamValues()),console.debug("params",t));return e}addFacet(e){this.vm.facets.includes(e)||this.vm.facets.push(e)}load(e){e.map(e=>{let t;(t="string"==typeof e?this.getByName(e):this.getByName(e[0]))?.selected||t.toggle()})}getByName(e){for(var t of this.filterGroups)for(var i of t)if(i.name===e)return i;for(var s of this.groups)for(var a of s.items)if(a.name===e)return a}dump(){var e,t=[];for(e of this.facets)t.push(e);return t}async update(){this.groupLength!==this._groupLength&&(this._groupLength=this.groupLength,await this.searchView.resultView.applyGroups(this.groupBy(),this.getParams())),this.vm.update()}groupBy(){let e=[];for(var t of this.groups)e=e.concat(t.items.filter(e=>e.selected).map(e=>e.groupBy));return e}}a.SearchViewController=t,s.component("search-view",{template:"",mounted(){this.$viewInfo=this.$parent.views?.search;var e=this.search=this.$search=new t(this);this.$parent.searchView=e,this.facets=e.facets,this.$parent.search=this.$search,this.$search.model=this.$parent.model,this.$search.action=this.$parent.action,this.$viewInfo?.fields&&(this.$search.fields=this.$viewInfo.fields),e.view=this.$parent.actionView,this.$viewInfo?.template&&this.$search.setContent(this.$viewInfo.template)},data(){return{fields:this.$parent.fields,search:{},fieldConditions:{},action:this.$parent.action,fieldName:null,currentIndex:-1,searchText:"",groupByExpanded:!1,facets:[],availableItems:[],customFilter:[],customSearchExpanded:!1,tempCondition:null,tempFilter:null,searchValue:null}},components:s.componentsRegistry})}})(Katrid=Katrid||{}),(n=>{var e=n.Forms||(n.Forms={});e=e.Views||(e.Views={});{var i=e.Search||(e.Search={});i.conditionsLabels={"=":n.i18n.gettext("Is equal"),"..":n.i18n.gettext("Between"),"!=":n.i18n.gettext("Is different"),">":n.i18n.gettext("Greater-than"),"<":n.i18n.gettext("Less-than"),"%":n.i18n.gettext("Contains"),"!%":n.i18n.gettext("Not contains"),range:n.i18n.gettext("Between"),like:n.i18n.gettext("Like"),in:n.i18n.gettext("In"),"!in":n.i18n.gettext("Not in"),isnull:n.i18n.gettext("Is null"),"!isnull":n.i18n.gettext("Is not null"),true:n.i18n.gettext("Yes"),false:n.i18n.gettext("No")},i.conditionSuffix={"=":"","..":"__range","!=":"__isnot","%":"__icontains","!%":"__not_icontains",">":"__gt",">=":"__gte","<":"__lt","<=":"__lte",in:"__in","!in":"__not_in",range:"__range",isnull:"__isnull","!isnull":"__isnull"};class t{constructor(e,t,i){this.view=e,this.name=t,this.el=i,this.controller=e.controller}test(e){return!this.pattern||!e||this.pattern.test(e)}getDisplayValue(){return Array.isArray(this.value)?this.value[1]:this.searchString}getParamValue(e,t){var i={};return Array.isArray(t)?i[e]=t[0]:i[e+"__icontains"]=t,i}_doChange(){this.view.update()}}i.SearchItem=t;class a extends t{constructor(e,t,i,s,a,r){super(e,t,r),this.group=a,this.caption=i,n.isString(s)&&(s=JSON.parse(s.replace(/'/g,'"'))),this.domain=s,this._selected=!1}static fromItem(e,t,i){return new a(e,t.attr("name"),t.attr("caption")||t.attr("label"),t.attr("domain"),i,t)}toString(){return this.caption}toggle(){this.selected=!this.selected}get selected(){return this._selected}set selected(e){(this._selected=e)?this.group.addValue(this):this.group.removeValue(this),this._doChange()}getDisplayValue(){return this.caption}get facet(){return this.group.facet}getParamValue(){return this.domain}get value(){return this.domain}}i.SearchFilter=a,i.SearchFilters=class d{constructor(e,t){this.view=e,this.items=[],this._selected=!1,this.view=e,this.controller=e.controller,this._selection=[],t=t||new i.FacetView(this),this.facet=t}static fromItem(e,t){var i=new d(e);return i.push(a.fromItem(e,t,i)),i}static fromGroup(e,t){var i,s=new d(e);for(i of $(t).children())s.push(a.fromItem(e,$(i),s));return s}get selected(){return this._selected}set selected(e){if(this._selected=e)for(var t of this.items)this.addValue(t);else for(var i of this.items)this.removeValue(i);this.view.update()}toggle(){this.selected=!this.selected}addValue(e){-1<this._selection.indexOf(e)||(this._selection.push(e),this.facet.values=this._selection.map(e=>new s(e.toString(),e.value)),this._refresh())}removeValue(e){this._selection.splice(this._selection.indexOf(e),1),this.facet.values=this._selection.map(e=>({searchString:e.getDisplayValue(),value:e.value})),this._refresh()}selectAll(){for(var e of this.items)this.addValue(e);this.view.update()}get caption(){return'<span class="fa fa-filter"></span>'}toString(){return this.items.join(" OR ")}_refresh(){this._selection.length?-1===this.controller.vm.facets.indexOf(this.facet)&&this.controller.vm.facets.push(this.facet):-1<this.controller.vm.facets.indexOf(this.facet)&&this.controller.vm.facets.splice(this.controller.vm.facets.indexOf(this.facet),1)}getParamValue(e){return e.value}clear(){this._selection=[]}push(e){this.items.push(e)}};class s{constructor(e,t){this.display=e,this.value=t}}i.SearchObject=s;class r{constructor(e,t){this.field=e,this.value=[t.id,t.text],this.text=t.text,this.indent=!0}select(){console.log("select field",this.field,this.value),this.field.selectItem(this.value)}}i.SearchResult=r;class o extends t{constructor(e,t,i,s){super(e,t,i),this.lookup="",this.field=s,this._expanded=!1,this.options=$(i).data("options"),this.caption=i.getAttribute("caption")||s.caption,"ForeignKey"===s.type?(this.expandable=!0,this.children=[]):("IntegerField"===s.type?this.pattern=/^[\d]+[\d;.]*$/:"FloatField"===s.type||"DecimalField"===s.type?this.pattern=/^[\d]+[\d,;.]*$/:"DateField"===s.type?this.pattern=/^[\d.\s\-\/;]+$/:"DateTimeField"===s.type&&(this.pattern=/^[\d.\s\-:\/;]+$/),this.expandable=!1),i.hasAttribute("search-key")&&(this.searchKey=i.getAttribute("search-key")),i&&i.hasAttribute("search-pattern")&&(this.pattern=new RegExp(i.getAttribute("search-pattern")))}get expanded(){return this._expanded}set expanded(e){if(this._expanded=e)this._loadChildren();else if(this.children=[],this.view.controller.availableItems)for(let e=this.view.controller.availableItems.length-1;0<e;e--)this.view.controller.availableItems[e].field===this&&this.view.controller.availableItems.splice(e,1)}_loadChildren(){this.loading=!0,this.view.model.service.getFieldChoices({field:this.name,term:this.view.vm.searchText}).then(e=>{this.children=e.items;let t=this.view.controller.availableItems.indexOf(this);if(-1<t)for(var i of this.children)t++,this.view.controller.availableItems.splice(t,0,new r(this,i))}).finally(()=>this.loading=!1)}get facet(){return this._facet||(this._facet=new i.FacetView(this)),this._facet}getDisplayValue(){return this.value}getParamValue(e){var t={},i=this.searchKey||this.name;if(Array.isArray(e))t[i+this.lookup]=e[0];else{if(e instanceof s)return e.value;i.includes("__")?t[i]=e:t[i+this.field.defaultSearchLookup]=e}return t}get value(){return this._value||this.view.vm.searchText}async select(){if(this._value=null,!1!==this.options?.allowSelect){if(this.field){this.field instanceof n.Data.DateTimeField&&(this.lookup="__date"),this._value=this.field.getParamValue(this.value);let e;Array.isArray(this._value)?(e=this._value.map(this.field.format),this.view.vm.searchText.includes("..")?this.lookup="__range":this.view.vm.searchText.includes(";")&&(this.lookup="__in")):e=this.field.format(this._value),e===this._value?this.facet.addValue(this.value):this.facet.addValue([this._value,e])}else this.facet.addValue(this.value);return this.view.controller.addFacet(this.facet),this.view.controller.close(),this.view.update(),!0}if(this.expandable)return this.expanded=!this.expanded,!1}selectItem(e){var t={};t[this.field.name]=e[0],this.facet.addValue(new s(e[1],t)),this.view.controller.addFacet(this.facet),this.view.controller.close(),this.view.update()}static fromField(e,t){let i=e.fields[t.getAttribute("name")];var s;return i||"STRINGFIELD"!==t.tagName||(s=t.getAttribute("name"),i=new n.Data.StringField({name:s,caption:t.getAttribute("caption")})),new o(e,i.name,t,i)}get template(){return n.i18n.interpolate(n.i18n.gettext("Search <i>%(caption)s</i> by: <strong>%(text)s</strong>"),{caption:this.caption,text:this.view.vm.searchText})}}i.SearchField=o}})(Katrid=Katrid||{}),(r=>{var e=r.Forms||(r.Forms={});e=e.Views||(e.Views={});{var s=e.Search||(e.Search={});class t extends s.SearchFilter{constructor(e,t,i,s,a){super(e,t.name,t.caption,null,a),this.field=t,this.condition=i,(t instanceof r.Data.DateField||t instanceof r.Data.DateTimeField)&&Array.isArray(s)&&(s=s.map(e=>"string"==typeof e?moment(e):e)),this._value=s,this._selected=!0}toString(){let e=this._value,t;return 1===e.length?null!=(e=e[0])&&(t=this.field.format(e)):1<e.length&&(t=e.map(e=>this.field.format(e))),t=t?' "'+t+'"':"",this.field.caption+" "+s.conditionsLabels[this.condition].toLowerCase()+t}get value(){var e={};let t=this.field.name;this.field instanceof r.Data.DateTimeField&&!["isnull","!isnull"].includes(this.condition)&&(t+="__date");var i=s.conditionSuffix[this.condition]||"";return t+=i,".."===this.condition?e[t]=this._value.map(e=>this.field.getParamValue(e)):"="===this.condition||"!="===this.condition||"%"===this.condition||"!%"===this.condition?e[t]=this.field.getParamValue(this._value[0]):"isnull"===this.condition?e[t]=!0:"!isnull"===this.condition||"false"===this.condition?e[t]=!1:"true"===this.condition?e[t]=!0:e[t]=this._value[0],e}}s.CustomFilterItem=t,s.CustomFilterHelper=class{constructor(i,e){this.searchView=i,e.innerHTML=`<button class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" type="button"
                aria-expanded="false">
          <span class="fa fa-filter fa-fw"></span> ${r.i18n.gettext("Filters")} <span class="caret"></span>
        </button>

    <div class="dropdown-menu search-view-filter-menu">
      <div>
        <div v-for="group in filterGroups">
          <a class="dropdown-item" ng-class="{'selected': filter.selected}" v-for="filter in group" v-on:click.prevent="filter.toggle()">
            {{filter.toString()}}
          </a>
          <div class="dropdown-divider"></div>
        </div>
      </div>
      <div>
        <div v-for="filter in filters">
          <a class="dropdown-item" :class="{'selected': filterItem.selected}"
             v-on:click.stop.prevent="filterItem.toggle()"
             v-for="filterItem in filter.items">{{filterItem.toString()}}</a>
          <div class="dropdown-divider"></div>
        </div>
        <a class="dropdown-item dropdown-search-item" v-on:click.stop="expanded=!expanded">
          <i :class="{ 'fa-caret-right': !expanded, 'fa-caret-down': expanded }" class="fa expandable"></i>
          ${r.i18n.gettext("Add Custom Filter")}
        </a>

        <div v-if="expanded" v-on:click.stop.prevent="">
          <div v-show="tempFilter.length" class="margin-bottom-8">
            <a href="#" v-on:click.prevent="" class="dropdown-item" v-for="filter in tempFilter" title="${r.i18n.gettext("Remove item")}">
            {{ filter.toString() }}
            </a>
          </div>
          <div class="col-12">
            <div class="form-group">
              <select class="form-control" v-model="fieldName" v-on:change="fieldChange(fieldName)">
                <option value=""></option>
                <option v-for="field in fieldList" :value="field.name">{{field.caption}}</option>
              </select>
            </div>
            <div class="form-group">
              <select class="form-control" v-model="conditionName" v-if="field" v-on:change="condition=conditions[conditionName]">
                <option :value="cond.name" v-for="cond in conditionList">{{ cond.label }}</option>
              </select>
            </div>
            <div class="form-group">
              <input class="form-control" v-model="value" v-if="condition.input === 'input'">
              <select class="form-control" v-model="value" v-if="condition.input === 'select'">
                <option :value="value" v-for="(value, name) in condition.options">{{ name }}</option>
              </select>
            </div>
            <div class="form-group">
              <button class="btn btn-primary" type="button" v-on:click="applyFilter(field, condition, searchValue)" v-show="conditionName">
                ${r.i18n.gettext("Apply")}
              </button>
              <button class="btn btn-outline-secondary" type="button"
                      v-on:click="addCondition(field, condition, searchValue);fieldName='';" v-show="conditionName">
                ${r.i18n.gettext("Add a condition")}
              </button>
            </div>
          </div>
        </div>

      </div>
    </div>`,new Vue({el:e,methods:{applyFilter:function(){this.value&&this.addCondition(this.field,this.conditionName,this.value),this.customFilter.push(this.tempFilter),this.tempFilter.selectAll(),this.filters.push(this.tempFilter),console.log("apply filters field change"),this.tempFilter=new s.SearchFilters(i),this.expanded=!1},addCondition:function(){this.tempFilter.push(new t(i,this.field,this.conditionName,this.value,this.tempFilter)),this.field=null,this.condition={input:!1},this.value=null},fieldChange:function(e){this.condition={input:!1},this.conditionName="",this.conditions={},this.field=i.fields[e],this.conditionList=this.field.getFilterConditions();for(var t of this.conditionList)void 0===t.input&&(t.input="input"),this.conditions[t.name]=t}},data(){return{value:null,conditions:{},conditionList:[],condition:{input:!1},conditionName:"",searchValue:null,customFilter:[],tempFilter:new s.SearchFilters(i),field:null,fieldName:"",filters:[],fieldList:Object.values(i.fields),fields:i.fields,filterGroups:i.filterGroups,expanded:!1}}})}},s.GroupFilterHelper=class{constructor(e,t){t.innerHTML=`<button class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" type="button">
          <span class="fa fa-bars fa-fw"></span> ${r.i18n.gettext("Group By")} <span class="caret"></span>
        </button>
        <div class="dropdown-menu search-view-groups-menu">
          <div>
            <div v-for="group in groups">
              <a class="dropdown-item" ng-class="{'selected': filter.selected}" v-for="filter in group"
                 v-on:click.prevent="filter.toggle()">
                {{filter.toString()}}
              </a>
              <div class="dropdown-divider" v-if="groups.length"></div>
            </div>
          </div>

          <a class="dropdown-item dropdown-search-item" v-on:click.stop="expanded=!expanded">
            <i :class="{ 'fa-caret-right': !expanded, 'fa-caret-down': expanded }"
               class="fa expandable"></i>
            ${r.i18n.gettext("Add Custom Group")}
          </a>

          <div v-if="expanded" v-on:click.stop.prevent="">
            <div class="col-12">
              <div class="form-group">
                <select class="form-control" v-model="fieldName" v-change="fieldChange(fields[fieldName])">
                  <option value=""></option>
                  <option v-for="field in fieldList" :value="field.name">{{field.caption}}</option>
                </select>
              </div>
              <div class="form-group">
                <button class="btn btn-primary" type="button" v-on:click="addCustomGroup(fields[fieldName]);fieldName='';">
                  ${r.i18n.gettext("Apply")}
                </button>
              </div>
            </div>
          </div>

        </div>`}},s.SaveFilterHelper=class{constructor(e,t){t.innerHTML=`<button class="btn btn-outline-secondary dropdown-toggle" data-toggle="dropdown" type="button"
                aria-expanded="false">
          <span class="fa fa-star fa-fw"></span> ${r.i18n.gettext("Favorites")} <span class="caret"></span>
        </button>
        <div class="dropdown-menu search-favorite-menu" style="min-width: 300px">
          <a class="dropdown-item dropdown-search-item" v-on:click.stop="expanded=!expanded">
            <i :class="{ 'fa-caret-right': !expanded, 'fa-caret-down': expanded }"
               class="fa expandable"></i>
            ${r.i18n.gettext("Save current search")}
          </a>
          <div v-if="expanded" v-on:click.stop>
            <div class="col-12">
              <div class="form-group">
                <input type="text" class="form-control" v-model="saveSearch.name" placeholder="${r.i18n.gettext("Search name")}">
              </div>
              <div class="form-group" ng-init="saveSearch.is_default=false;saveSearch.is_shared=true;">
                <label>
                  <input type="checkbox" v-model="saveSearch.is_default" v-on:click.stop>
                  ${r.i18n.gettext("Use by default")}
                </label>
                <label>
                  <input type="checkbox" v-model="saveSearch.is_shared">
                  ${r.i18n.gettext("Share with all users")}
                </label>
              </div>
              <div class="form-group">
                <button class="btn btn-primary" type="button" v-on:click="saveSearch(saveSearch)">
                  ${r.i18n.gettext("Save")}
                </button>
              </div>
            </div>
          </div>
        </div>`}}}})(Katrid=Katrid||{}),(e=>{var t,i;t=(t=e.Forms||(e.Forms={})).Views||(t.Views={}),(i=t.Search||(t.Search={})).FacetView=class{constructor(e){this.item=e,this.values=[]}get separator(){return` <span class="facet-values-separator">${e.i18n.gettext("or")}</span> `}init(e,t){this.item=e,this.values=t||[{searchString:this.item.getDisplayValue(),value:this.item.value}]}addValue(e){return this.values.push(e)}get caption(){return this.item.caption}clear(){this.values=[]}get templateValue(){return Array.from(this.values).map(e=>Array.isArray(e)?e[1]:e instanceof i.SearchObject?e.display:e).join(this.separator)}template(){}link(t){var e=$(this.template());return((this.item.facet=this).element=e).find(".facet-remove").click(e=>t.onRemoveItem(e,this.item)),e}render(e){}refresh(){return this.element.find(".facet-value").html(this.templateValue)}load(e){e.query.loadItem(this.item),this.render(e)}destroy(){this.clear()}getParamValues(){var e,t=[];for(e of this.values)t.push(this.item.getParamValue(e));return 1<t.length?[{OR:t}]:t}}})(Katrid=Katrid||{}),!function(Katrid){var Forms;!function(Forms){var Views;!function(Views){var Search;!function(Search){class FacetGroup extends Search.FacetView{constructor(...e){super(e),this.grouping=!0}clear(){var e,t=this.values;super.clear();for(e of t)e._ref&&(e._ref._selected=!1)}get separator(){return" <span> &gt; </span> "}get caption(){return'<span class="fa fa-bars"></span>'}}Search.FacetGroup=FacetGroup;class SearchGroups extends Search.SearchFilters{constructor(e,t){super(e,t=t||new FacetGroup)}static fromGroup(e){var t=e.view,i=e.el,e=e.facet||t.facetGrouping,e=new SearchGroups(t,e);return e.push(SearchGroup.fromItem(t,i,e)),e}static fromField({view:e,field:t}){var i=e.facetGrouping,i=new SearchGroups(e,i);return i.push(SearchGroup.fromField(e,t,i)),i}addValue(e){this.view.controller.groupLength++;var t=new Search.SearchObject(e.toString(),e.value);t._ref=e,this.facet.values.push(t),this._refresh()}removeValue(e){this.view.controller.groupLength--;for(var t of this.facet.values)if(t._ref===e){this.facet.values.splice(this.facet.values.indexOf(t),1);break}this._refresh()}_refresh(){this.facet.values.length?-1===this.view.controller.facets.indexOf(this.facet)&&this.view.controller.facets.push(this.facet):-1<this.view.controller.facets.indexOf(this.facet)&&this.view.controller.facets.splice(this.view.controller.facets.indexOf(this.facet),1)}}Search.SearchGroups=SearchGroups;class SearchGroup extends Search.SearchFilter{constructor(view,name,caption,group,el){super(view,name,caption,null,group,el),this.group=group,el&&el.getAttribute("context")&&(this.context=eval(`(${el.getAttribute("context")})`)),this.groupBy=this.context?.group_by||name,this._selected=!1}static fromItem(e,t,i){return new SearchGroup(e,t.getAttribute("name"),t.getAttribute("caption"),i,t)}static fromField(e,t,i){return new SearchGroup(e,t.name,t.caption,i)}toString(){return this.caption}}Search.SearchGroup=SearchGroup}(Search=Views.Search||(Views.Search={}))}(Views=Forms.Views||(Forms.Views={}))}(Forms=Katrid.Forms||(Katrid.Forms={}))}(Katrid=Katrid||{}),(e=>{var t;e=(e=e.Forms||(e.Forms={})).Views||(e.Views={}),(t=e.Search||(e.Search={})).SearchQuery=class{constructor(e){this.searchView=e,this.items=[],this.groups=[]}add(e){this.items.includes(e)?(e.facet.addValue(e),e.facet.refresh()):(this.items.push(e),this.searchView.renderFacets()),e instanceof t.SearchGroup&&this.groups.push(e),this.searchView.change()}loadItem(e){this.items.push(e),e instanceof t.SearchGroup&&this.groups.push(e)}remove(e){this.items.splice(this.items.indexOf(e),1),e instanceof t.SearchGroup&&this.groups.splice(this.groups.indexOf(e),1),this.searchView.change()}getParams(){let e=[];for(var t of this.items)e=e.concat(t.getParamValues());return e}}})(Katrid=Katrid||{}),(l=>{var e=l.Forms||(l.Forms={});e.Controls||(e.Controls={}),l.component("input-ajax-choices",{props:["modelValue"],template:"<input>",mounted(){var e=$(this.$el),t=this.$el.hasAttribute("multiple");let a=this.$attrs["ajax-choices"],r=this.$attrs.field,n=null,o=this.$attrs["name-fields"],d=this.$attrs["model-choices"];var i={allowClear:!0,query(i){let s={args:[i.term],kwargs:{count:1,page:i.page,name_fields:o?.split(",")||null}};n&&clearTimeout(n),n=setTimeout(()=>{var e=new l.Services.ModelService(a);let t;(t=r?e.getFieldChoices({field:r,term:i.term,kwargs:s.kwargs}):new l.Services.ModelService(d).searchByName(s)).then(e=>{var t=e.items.map(e=>({id:e.id,text:e.text})),e=i.page*l.settings.services.choicesPageLimit<e.count;return i.callback({results:t,more:e})})},400)},escapeMarkup(e){return e},initSelection(e,t){}};t&&(i.multiple=!0);let s=e.select2(i);s.addClass("col-12"),e.on("$destroy",function(){return $(".select2-hidden-accessible").remove(),$(".select2-drop").remove(),$(".select2-drop-mask").remove()}),s.on("change",e=>{let t=s.select2("data");Array.isArray(t)?t=t.map(e=>e.id):t&&"id"in t&&(t=t.id),this.$emit("update:modelValue",t)})}}),l.component("multiple-tags",{template:"<select><slot></slot></select>",mounted(){let i=$(this.$el).select2();i.on("change",e=>{let t=i.select2("data");Array.isArray(t)?t=t.map(e=>e.id):t&&"id"in t&&(t=t.id),this.$emit("update:modelValue",t)})}})})(Katrid=Katrid||{}),(i=>{var e=i.Forms||(i.Forms={});e.Controls||(e.Controls={}),i.component("attachments-button",{render(){var e=`<div class="dropdown">
        <button id="attachments-button"
                type="button" class="btn btn-outline-secondary dropdown-toggle"
                data-bs-toggle="dropdown" aria-haspopup="true">
          <span v-if="!attachments.length">${i.i18n.gettext("Attachments")} </span>
          <span
              v-if="attachments.length">{{ $filters.sprintf('${i.i18n.gettext("%s Attachment(s)")}', attachments.length) }}
          </span>
          <span class="caret"></span>
        </button>
        <div class="dropdown-menu attachments-menu">
          <a class="dropdown-item position-relative" v-for="(attachment, index) in attachments"
             :href="attachment.download_url">
            {{ attachment.name }} <span
              class="fa fa-times remove-attachment-button" title="${i.i18n.gettext("Delete attachment")}"
              v-on:click.prevent.stop="deleteAttachment(index)"></span>
          </a>
          <div role="separator" class="dropdown-divider" v-show="attachments.length"></div>
          <a class="dropdown-item" onclick="$(this).next().click();">
            ${i.i18n.gettext("Add...")}
          </a>
          <input type="file" class="input-file-hidden" multiple="multiple"
                 v-on:change="upload($event)"/>
        </div>
      </div>`;return Vue.compile(e)(this)},mounted(){let e;this.$parentRecordChanged=async t=>{this.attachments=[],clearTimeout(e),t&&t.id&&(e=setTimeout(async()=>{var e=await new i.Services.ModelService("content.attachment").search({where:{model:this.$parent.$view.model.name,object_id:t.id},count:!1});e&&e.data&&(this.attachments=e.data)},1e3))},this.$parent.$view.addDataCallback(this.$parentRecordChanged)},unmounted(){this.$parent.$view.dataCallbacks.splice(this.$parent.$view.dataCallbacks.indexOf(this.parentRecordChanged))},methods:{async upload(e){e=await i.Services.Attachments.upload(e.target,{model:this.$parent.$view.model,recordId:this.$parent.record.id});if(this.attachments||(this.attachments=[]),e&&e.result)for(var t of e.result)this.attachments.push(t)},deleteAttachment(e){this.$parent.action.deleteAttachment(this.attachments,e)}},data(){return{attachments:[]}}})})(Katrid=Katrid||{}),(e=>{(e.UI||(e.UI={})).InputMask=class{constructor(e,t){this.el=e,this.options=t,this._changed=!1,this._inputMask=t?.mask,void 0===this._inputMask&&(this._inputMask=this.el.getAttribute("input-mask")),e.addEventListener("change",()=>{this._invalidate()}),e.addEventListener("blur",()=>this._format()),e.addEventListener("keypress",e=>this._keyPress(e)),e.addEventListener("keydown",e=>this._keyDown(e)),this._create()}_keyPress(t){if(this._inputMask&&!t.shiftKey&&!t.altKey&&!t.ctrlKey){let e=this.el.selectionStart;var i=this.el.selectionEnd,s=this._inputMask[e];return"9"!==s||/[\d]/.test(t.key)?"9"!==s&&s===t.key||void(e===i&&(this.el.value.length>e&&"9"!==s&&e++,this.el.value=this.el.value.substring(0,e)+this.el.value.substring(e+1),this.el.selectionEnd=e,s?"9"===s||this.el.value.length>e||(this.el.value+=s):t.preventDefault())):(t.preventDefault(),!1)}}_keyDown(e){if(this._inputMask)if("Backspace"===e.code){if(this.el.selectionEnd===this.el.value.length&&this.el.selectionStart===this.el.value.length)return!0;0<this.el.selectionStart?(this.el.selectionStart--,e.preventDefault()):0===this.el.selectionStart&&this.el.selectionEnd<this.el.value.length&&(this.el.selectionEnd=this.el.value.length,e.preventDefault())}else"Delete"===e.code&&(this.el.selectionEnd=this.el.value.length)}_format(){}_create(){}_invalidate(){}}})(Katrid=Katrid||{}),(d=>{{var e=d.Forms||(d.Forms={});class t extends d.UI.InputMask{}e.InputDate=t,d.component("input-date",{props:["modelValue"],template:`<div class="input-group date">
      <input type="text" class="form-control form-field" inputmode="numeric">
      <label class="input-group-text btn-calendar" type="button"><i class="fa fa-calendar fa-sm"></i></label></div>`,mounted(){let i=this,t=d.i18n.gettext("9999-99-99"),s=d.i18n.gettext("Today")[0].toLowerCase(),a=i.$attrs["date-picker"]||"L",r,n=(r="L LT"===a&&(t=d.i18n.gettext("9999-99-99 99:99"),d.i18n.formats.shortDateTimeFormat)||d.i18n.formats.shortDateFormat,i.$el.querySelector("input"));new d.UI.InputMask(n,{mask:t});n.value="",i.$attrs.name&&(n.name=i.$attrs.name),i.$input=n,this.$lastValue="",n.addEventListener("focusin",()=>this.$changing=!0),n.addEventListener("focusout",()=>this.$changing=!1),n.addEventListener("keypress",e=>{if(!e.shiftKey&&!e.ctrlKey&&!e.altKey&&"Enter"===e.code)return n.value&&(e=katrid.utils.autoCompleteDate(n.value.replace("_",""),r),n.value=e?moment(e).format(r):""),!0}),n.addEventListener("keydown",e=>{var t;"ArrowUp"===e.code?(t=moment(this.modelValue||new Date).add(1,"days").format(r),n.value=t,i.$emit("update:modelValue",o(t))):"ArrowDown"===e.code?(t=moment(this.modelValue||new Date).add(-1,"days").format(r),n.value=t,i.$emit("update:modelValue",o(t))):e.key.toLowerCase()===s&&(t=moment(new Date).format(r),n.value=t,i.$emit("update:modelValue",o(t)))}),n.addEventListener("change",()=>{var e;n.value&&n.value.length<t.length&&(e=katrid.utils.autoCompleteDate(n.value,r),n.value=e?moment(e).format(r):""),i.$emit("update:modelValue",o(this.value))}),this.$format=r;let o=e=>(e=n.value,"L"===a?this.$lastValue=moment(e,r).format("YYYY-MM-DD"):this.$lastValue=moment(e,r).format("YYYY-MM-DDTHH:mm:ss"),"Invalid date"===this.$lastValue&&(this.$lastValue=null),i.$emit("change",this.$lastValue),this.$lastValue);this.$el.querySelector(".btn-calendar").addEventListener("click",()=>{let e=this.modelValue;e=e&&moment(e).toDate(),new d.ui.Calendar(this.$el,{change:e=>{e=moment(e).format(r);n.value=e,i.$emit("update:modelValue",o(e))},date:e}).show()}),this.modelValue&&(n.value=moment(this.modelValue).format(this.$format))},watch:{modelValue(e){this.$changing||(e?("L"!==this.$format||""!==this.$input.value&&e===this.$lastValue||(this.$input.value=moment(e).format(this.$format)),""!==this.$input.value&&e===this.$lastValue||(this.$input.value=moment(e).format(this.$format))):this.$input.value="")}}}),class extends d.UI.InputMask{},d.component("input-time",{props:["modelValue"],template:'<input class="form-control" type="text">',mounted(){let e=this.$el;new d.UI.InputMask(e,{mask:"99:99"});e.addEventListener("blur",()=>{2===e.value.length&&(e.value+=":"),3===e.value.length&&(e.value+="00"),e.value&&this.$emit("update:modelValue",e.value)}),e.addEventListener("change",()=>{this.$emit("update:modelValue",e.value)}),this.modelValue&&(e.value=this.modelValue)},watch:{modelValue(e){e&&e!==this.$el.value?this.$el.value=e:e||(this.$el.value="")}}})}})(Katrid=Katrid||{}),(e=>{(e.utils||(e.utils={})).autoCompleteDate=function(i,e){if((i=Array.from(i.matchAll(/(\d)+/g))).length){var s=new Date,a=Number.parseInt(i[0][0]);let e=s.getMonth(),t=s.getFullYear();if(1<i.length&&(e=Number.parseInt(i[1][0])-1),2<i.length){let e=i[2][0];2===e.length&&(e="20"+e),t=Number.parseInt(e)}return new Date(t,e,a)}}})(katrid=katrid||{}),(e=>{(e.UI||(e.UI={})).toggleFullScreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()}})(Katrid=Katrid||{}),!function(Katrid){var Forms;!function(Forms){let decimalSeparator=Katrid.i18n.formats.DECIMAL_SEPARATOR||".",thousandSeparator=Katrid.i18n.formats.THOUSAND_SEPARATOR||",",RE_INPUT=new RegExp(`[-=0-9\\${decimalSeparator}]`),RE_FORMULA=new RegExp(`[=+-/*d\\${decimalSeparator}]`);class InputDecimal{constructor(e){this.element=e,this._formula=!1,this._changed=!1,this.element.addEventListener("change",()=>{this._invalidate()}),this.element.addEventListener("blur",()=>this._format()),this._create()}_formatValue(e){var t=this.element.getAttribute("display-format")||"0.00";let i;var s=parseInt(this.element.getAttribute("input-decimal")||"2");return i=(t.endsWith("#")?Katrid.intl.number({minimumFractionDigits:s}):t.endsWith("0")?Katrid.intl.number({minimumFractionDigits:2,maximumFractionDigits:s}):Katrid.intl.number({maximumFractionDigits:s})).format(e)}_format(){var e;this.element.value&&(e=this._formatValue(this.getValue()))&&(this.element.value=e)}_create(){this.element.addEventListener("keypress",e=>{if(this._formula)return e.shiftKey||e.ctrlKey||e.altKey||"Enter"!==e.code||this._invalidate(),!0;if(!e.shiftKey&&!e.ctrlKey&&!e.altKey){if("Enter"===e.code&&this._formula)return this._invalidate(),!0;if(RE_INPUT.test(e.key))return"="===e.key&&(this.element.value="=",this._formula=!0,e.preventDefault()),!0}e.preventDefault()}),this.element.addEventListener("input",()=>(this._formula=this.element.value&&"="===this.element.value[0],!1)),this.element.addEventListener("focusin",()=>{this._changed=!1;var e=this.element.value;e.includes(thousandSeparator)&&(this.element.value=e.replace(new RegExp("\\"+thousandSeparator,"g"),"")),this.element.select()})}_invalidate(){if(this.element.value&&this._formula){this._formula=null;let s=this.element.value,val=(s=s.replace(new RegExp("\\"+decimalSeparator,"g"),"."),eval(s.substring(1,s.length)));"number"==typeof val?this.element.value=val.toString().replace(/\./g,decimalSeparator):this.element.value="0"}}getValue(){let e=this.element.value;return e?(e.includes(thousandSeparator)&&(e=e.replace(new RegExp("\\"+thousandSeparator,"g"),"")),"."!==decimalSeparator&&(e=e.replace(decimalSeparator,".")),parseFloat(e)):null}setValue(e){null==e||""===e?this.element.value="":("string"==typeof e&&(e=parseFloat(e)),this.element.value=this._formatValue(e))}}Forms.InputDecimal=InputDecimal,Katrid.component("input-decimal",{props:["modelValue"],template:'<input type="text" class="form-control">',mounted(){let e=this;e.$attrs["input-decimal"];this.$inputDecimal=new InputDecimal(this.$el),this.$el.addEventListener("input",()=>{this.$el._formula||(this.$changing=!0,e.$emit("update:modelValue",this.$inputDecimal.getValue()),setTimeout(()=>this.$changing=!1))}),this.$el.addEventListener("change",()=>{this.$changing=!0,e.$emit("update:modelValue",this.$inputDecimal.getValue()),setTimeout(()=>this.$changing=!1)}),null!=e.modelValue&&this.$inputDecimal.setValue(e.modelValue)},emits:["update:modelValue"],watch:{modelValue:function(e){this.$changing||this.$inputDecimal.setValue(e)}}})}(Forms=Katrid.Forms||(Katrid.Forms={}))}(Katrid=Katrid||{}),(e=>{(e.ui||(e.ui={})).InputDecimal=Katrid.Forms.InputDecimal})(katrid=katrid||{}),(e=>{(e=(e=e.Forms||(e.Forms={})).Widgets||(e.Widgets={})).Widget=class{constructor(e,t){this.field=e,this.fieldEl=t}formLabel(){return this.field.formLabel(this.fieldEl)}afterRender(e){return e}},e.registry={}})(Katrid=Katrid||{}),(e=>{var t=e.Forms||(e.Forms={});{t=t.Widgets||(t.Widgets={});class i extends t.Widget{renderToForm(){return e.html(`
     <status-field class="status-field status-field-sm pull-right">
      <input type="hidden" ng-model="self.%(fieldName)s"/>
      <div class="steps">
        <a :class="{active: record.${this.field.name} === item[0]}" v-for="item in $fields.${this.field.name}.choices">
          <span>{{item[1]}}</span>
        </a>
      </div>
    </status-field> 
      `)}}t.StatusField=i;let r=0;class s extends t.Widget{formControl(){var e=document.createElement("div"),t=(e.className="form-field",document.createElement("div")),i=(t.setAttribute("v-for",`(choice, index) in $fields.${this.field.name}.choices`),t.classList.add("form-check","form-check-inline"),this.field.fieldEl.getAttribute("class")),i=(i&&t.classList.add(...i.split(" ")),document.createElement("input")),s=(i.className="form-check-input",`'RADIO_ID-${this.field.name}-${++r}-' + index`),a=(i.setAttribute(":id",s),i.setAttribute("type","radio"),i.setAttribute("v-model","record."+this.field.name),i.setAttribute(":value","choice[0]"),document.createElement("label"));return a.className="form-check-label",a.innerText="{{ choice[1] }}",a.setAttribute(":for",s),t.appendChild(i),t.appendChild(a),e.append(t),e}}t.RadioField=s;class a extends t.Widget{renderToForm(){var e=document.createElement("div");return e.classList.add("stat-value"),e.innerText=`{{record.${this.field.name}}}`,e}}t.StatValue=a;class n extends t.Widget{afterRender(e){return e.querySelector("input").setAttribute("type","password"),e}}t.PasswordField=n,e.component("stat-button",{template:'<button class="btn stat-button"><slot/></button>'}),Object.assign(t.registry,{StatusField:i,RadioField:s,PasswordField:n,radio:s,"stat-value":a})}})(Katrid=Katrid||{}),(n=>{{var e=n.UI||(n.UI={});e.keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38};class t{constructor(e,t){this.options=t,this.template='<a class="dropdown-item" href="#">${item}</a>',this.waitTemplate=()=>`<div class="dropdown-wait text-muted"><i class="fas fa-spinner fa-spin"></i> ${n.i18n.gettext("Loading...")}</div>`,this._loading=!1,this.delay=500,this._elements=[],this.mouseDown=!1,this.el=document.createElement("div"),this.el.classList.add("dropdown-menu"),this.input=e,this.target=this.options?.target||e,t&&(t.template&&(this.template=t.template),t.source)&&(this.source=t.source)}show(){document.body.append(this.el),this._popper=Popper.createPopper(this.target,this.el,{placement:"bottom-start"}),this.el.classList.add("show")}hide(){this.el.classList.remove("show"),this._popper.destroy(),this.el.remove()}get visible(){return this.el.classList.contains("show")}loadItems(e){if(e.length){for(var t of e)this.addItem(t);this.move(1)}}clearItems(){this.items=[];for(var e of this._elements)e.remove();this._elements=[]}init(){this.cancelSearch(),this._pending=this.search()}search(){if(this.clearItems(),"function"==typeof this._source)return this.loading=!0,new Promise((e,t)=>{this._pendingTimeout=setTimeout(()=>{e(this._source({term:this.input.term}).then(e=>{this.clearItems(),this.loadItems(e)}).finally(()=>this.loading=!1))},this.delay)});if(Array.isArray(this._source)){let e=this._source;this.input.term&&(e=e.filter(e=>e.text?.toLowerCase().includes(this.input.term.toLowerCase()))),this.loadItems(e)}}cancelSearch(){this._pendingTimeout&&clearTimeout(this._pendingTimeout),this._pendingTimeout=null}showWait(){let e=this.waitTemplate;"function"==typeof e&&(e=e()),this._wait=$(e)[0],this.el.append(this._wait)}hideWait(){this._wait.remove(),this._wait=null}get loading(){return this._loading}set loading(e){e!==this._loading&&((this._loading=e)?this.showWait():this.hideWait())}addItem(e){this.items.push(e);let t=e.template;t="function"==typeof t?t():t||`<a class="dropdown-item" data-item-id="${e.id}">${e.text}</a>`,$(this.el).append(t);var i=this.el.querySelector(".dropdown-item:last-child");return $(i).data("item",e),this._elements.push(i),i.addEventListener("mousedown",e=>this.mouseDown=!0),i.addEventListener("mouseup",e=>this.mouseDown=!1),e.click?i.addEventListener("click",e.click):i.addEventListener("click",e=>{this.input.input.focus(),e.preventDefault(),e.stopPropagation();let t=e.target;"A"!=t.tagName&&(t=t.closest("a.dropdown-item")),this.onSelectItem(t)}),i}onSelectItem(e){return e=e||this.activeItem,this.input._selectItem(e)}onActivateItem(e){this.activeItem&&this.onDeactivateItem(this.activeItem),e&&e.classList.add("active"),this.activeItem=e}onDeactivateItem(e){e.classList.remove("active")}move(t){var i=0<t;for(t=Math.abs(t);0!==t;){t--;let e=this.el.querySelector(".dropdown-item.active");e=e?(this.onDeactivateItem(e),i?e.nextElementSibling:e.previousElementSibling):i?this.el.querySelector(".dropdown-item"):this.el.querySelector(".dropdown-item:last-child"),this.onActivateItem(e)}}get source(){return this._source}set source(e){this._source=e}}e.DropdownMenu=t;class i{constructor(e){this.el=e.el,this.el&&this._create(this.el)}_create(e){}}e.BaseInputWidget=i;class s extends i{constructor(){super(...arguments),this.menu=null,this.closeOnChange=!0,this.term="",this.multiple=!1,this.allowOpen=!1,this._tags=[],this._facets=[]}_create(t){t.classList.add("input-autocomplete","input-dropdown");let e="",i="";var s=t.getAttribute("name"),a=t.getAttribute("data-model");t.hasAttribute("allow-open")&&(e=`<span class="fa fa-fw fa-folder-open autocomplete-open" title="${n.i18n.gettext("Open this object")}" v-on:click="openObject('${a}', record.${s}.id)"></span>`,this.allowOpen=!0),t.classList.add("form-control"),this.multiple&&(i='<div class="input-dropdown">',e="</div>"+e,t.classList.add("multiple"));let r=t.querySelector("input");r?(i&&t.insertBefore(n.html(i),r),t.append(n.html('<span class="caret"></span>')),e&&t.append(n.html(e))):(t.innerHTML=i+'<input class="form-field" autocomplete="nope" spellcheck="false"> <span class="caret"></span>'+e,r=t.querySelector("input")),this.input=r,t.addEventListener("click",e=>{this.input.focus(),this.showMenu()}),t.querySelector(".caret").addEventListener("click",e=>t.click()),this.input.type="text",this.input.addEventListener("input",()=>this.onInput()),this.input.addEventListener("click",e=>{"none"===window.getComputedStyle(t).display?e.stopPropagation():(this.input.select(),this.onClick())}),this.input.addEventListener("blur",()=>this.onFocusout()),this.input.addEventListener("keydown",e=>this.onKeyDown(e)),t.hasAttribute("placeholder")&&(this.input.placeholder=t.getAttribute("placeholder")),this.$selectedItem&&(this.selectedItem=this.$selectedItem)}_addTag(e){var t;return!this.el.querySelector(`[data-id="${e.id}"]`)&&((t=$(`<div class="facet-view badge bg-secondary">
        <span class="facet-value">${e.text}</span>
        <span class="fas fa-times facet-remove"></span>
        </div>`)[0]).querySelector(".facet-remove").addEventListener("click",()=>this.removeTag(e)),t.setAttribute("data-id",e.id),this._tags.push(e),this._facets.push(t),this.el.insertBefore(t,this.input),!0)}addTag(e){this._addTag(e),this._setValues(this._tags),this.hideMenu()}removeTag(e){this._tags.splice(this._tags.indexOf(e),1);e=this.el.querySelector(`[data-id="${e.id}"]`);e&&(this._facets.splice(this._facets.indexOf(e),1),e.remove()),this._setValues(this._tags)}set tags(e){for(var t of this._facets)t.remove();e=e||[],this._tags=[];for(var i of e)this._addTag(i)}_setValues(e){e=new CustomEvent("onChange",{detail:{tags:e}});return this.el.dispatchEvent(e),e}onInput(){this.term=this.input.value,this.$selectedItem&&(this.$selectedItem=null,this._setValue(null)),this.showMenu()}onClick(){this.showMenu()}onFocusout(){this.menu?.mouseDown||(this.hideMenu(),this.invalidateValue()),this.term=""}createMenu(){this.menu=new t(this,{source:this._source,target:this.el})}invalidateValue(){this.selectedItem=this.$selectedItem}onKeyDown(e){if(this.menu)switch(e.which){case n.UI.keyCode.DOWN:this.menu.move(1),e.preventDefault();break;case n.UI.keyCode.UP:this.menu.move(-1),e.preventDefault();break;case n.UI.keyCode.ENTER:this.menu.activeItem&&(this.menu.onSelectItem(),e.preventDefault());break;case n.UI.keyCode.ESCAPE:this.menu&&this.hideMenu()}}showMenu(){this.menu||(this.createMenu(),this.menu.show()),this.menu.init()}hideMenu(){this.menu&&this.menu.hide(),this.menu=null}menuVisible(){return this.menu.visible}setOptions(e){e.source&&this.setSource(e.source)}setSource(e){this._source=e}_selectItem(e){let t=null;return e&&(t=$(e).data("item")),this.term="",this.multiple?(this.addTag(t),this._setValue(t)):this.setValue(t)}_setValue(e,t){e=new CustomEvent("selectItem",{detail:{item:e,dropdownItem:t}});return this.el.dispatchEvent(e),e}setValue(e,t){t=this._setValue(e,t);return t.defaultPrevented||(this.selectedItem=e,this.menu&&this.hideMenu()),t}get selectedItem(){return this.$selectedItem}set selectedItem(e){this.$selectedItem=e,this.input&&(e?(this.input.value=e.text,this.allowOpen&&this.el.classList.add("allow-open")):(this.input.value="",this.allowOpen&&this.el.classList.remove("allow-open")))}get selectedValue(){if(this.$selectedItem)return this.$selectedItem.id}}e.BaseAutoComplete=s;class a extends s{_create(e){super._create(e);e=e.getAttribute("data-model");if(e){let t=new n.Services.ModelService(e);this.setSource(async e=>(await t.searchByName({args:[e.term]})).items)}}}n.component("input-autocomplete",{props:["modelValue","items"],template:"<input-autocomplete/>",mounted(){var e=this.$el,e=new a({el:e});this.$el._autocomplete=e,this.items&&e.setSource(this.items),this.$el.addEventListener("selectItem",e=>{this.$emit("update:modelValue",e.detail.item)}),this.modelValue&&(e.selectedItem=this.modelValue)},watch:{modelValue:function(e){e!==this.$el._autocomplete.selectedItem&&(this.$el._autocomplete.selectedItem=e)}}})}})(Katrid=Katrid||{}),!function(Katrid){var Forms;!function(Forms){var Controls;!function(Controls){class InputForeignKeyElement extends Katrid.UI.BaseAutoComplete{constructor(){super(...arguments),this.allowAdvancedSearch=!0,this.allowCreateNew=!0,this.filter=null}bind(options){let field=options.field,model=options.model,name=(this.allowCreateNew="false"!==this.el.getAttribute("allow-create"),this.allowAdvancedSearch="false"!==this.el.getAttribute("allow-search"),this.el.getAttribute("name")),vm=(this.field=field,this.actionView=this.el.closest("action-view"),options.vm);field?.choices?this.setSource(field.choices):this.setSource(async query=>{let domain=this.filter||this.field.filter;if(domain&&"string"==typeof domain&&(domain=JSON.parse(domain)),this.field.vFilter){let newDomain=eval(`(function($parent, ${Object.keys(vm)}) {return ${this.field.vFilter}})`).call(vm,vm.$parent,...Object.values(vm));newDomain&&(domain=(domain,Object.assign({},domain)),domain=Object.assign(domain,newDomain))}let format="html",data={args:[query.term],kwargs:{count:1,page:query.page,filter:domain,format:format,name_fields:this.el.getAttribute("name-fields")?.split(",")||null}};if(model){let res=await model.service.getFieldChoices({field:this.field.name,term:query.term,kwargs:data.kwargs}),items=res.items;return this.allowAdvancedSearch&&items.push({template:`<a class="dropdown-item action-search-more"><i>${Katrid.i18n.gettext("Search more...")}</i></a>`,click:async e=>{e.stopPropagation(),this.hideMenu();var e=new Katrid.Data.Model({name:field.model}),e=await Katrid.Forms.TableView.createSearchDialog({model:e,caption:field.caption}),t=e.showDialog();e.ready(),(t=await t)&&(data.kwargs.ids=t.id,(e=await model.service.getFieldChoices({field:this.field.name,term:"",kwargs:data.kwargs})).items.length)&&this.setValue(e.items[0])}}),this.allowCreateNew&&items.push({template:`<a class="dropdown-item action-create-new"><i>${Katrid.i18n.gettext("Create new...")}</i></a>`,click:async e=>{e.stopPropagation(),this.hideMenu();var e=await(await Katrid.Forms.FormView.createNew({model:field.model,dialog:!0})).dialogPromise;e?.id&&(e=await this.field.getLabelById(model.service,e.id))?.items&&this.setValue(e.items[0])}}),items}}),name&&this.actionView?.view&&(this.field=this.actionView.view.fields[name])}}Controls.InputForeignKeyElement=InputForeignKeyElement,Katrid.component("field-foreignkey",{props:["modelValue"],template:'<div class="input-autocomplete"><slot/></div>',mounted(){var e=this.$el,e=new InputForeignKeyElement({el:e});this.$el._autocomplete=e,this.$field=this.$parent.$fields[this.$attrs.name],e.bind({vm:this.$parent,field:this.$field,view:this.$parent.$view,model:this.$parent.$view.model}),this.$el.addEventListener("selectItem",e=>{this.$emit("update:modelValue",e.detail.item)}),this.modelValue&&(e.selectedItem=this.modelValue)},watch:{modelValue:function(e){e!==this.$el._autocomplete.selectedItem&&(this.$el._autocomplete.selectedItem=e)}}}),Katrid.component("input-tags",{props:["modelValue"],template:'<div class="input-autocomplete"><slot/></div>',mounted(){var e=this.$el,e=new InputForeignKeyElement({el:e});e.multiple=!0,this.$el._autocomplete=e,this.$field=this.$parent.$fields[this.$attrs.name],e.bind({vm:this.$parent,field:this.$field,view:this.$parent.$view,model:this.$parent.$view.model}),this.$el.addEventListener("onChange",e=>{console.log("select item",e.detail),this.$emit("update:modelValue",e.detail.tags)}),this.modelValue&&(e.selectedItem=this.modelValue)},watch:{modelValue:function(e){this.$el._autocomplete.tags=e}}})}(Controls=Forms.Controls||(Forms.Controls={}))}(Forms=Katrid.Forms||(Katrid.Forms={}))}(Katrid=Katrid||{}),(e=>{e.Forms||(e.Forms={}),e.component("image-field",{props:["modelValue"],template:`<div class="image-box image-field form-control">
<slot></slot>
        <input type="file" v-on:change="onImageChange($event)" accept="image/*">
      </div>`,methods:{onImageChange(e){var t=new FileReader;t.onload=e=>{e=e.target.result;this.$emit("update:modelValue",e)},t.readAsDataURL(e.target.files[0]),e.target.value=""}}})})(Katrid=Katrid||{}),(e=>{function t(e,t){let i=new RegExp(t);e.addEventListener("keypress",e=>{if(!e.ctrlKey&&!e.altKey&&i.test(e.key))return!0;e.preventDefault()})}(e.ui||(e.ui={})).inputRegexPattern=t,Katrid.directive("input",{mounted(e){e.hasAttribute("input-re-pattern")&&t(e,e.getAttribute("input-re-pattern"))}})})(katrid=katrid||{}),(o=>{{var s=o.Forms||(o.Forms={});async function d(e){var t=e.field.getView("form"),i=(t.parentVm=e.parentVm,t.datasource.parent=e.master,t.datasource.field=e.field,t.fields[e.field.info.field]);return i&&(i.visible=!1),await t.showDialog(e.options),t}o.component("onetomany-field",{props:["modelValue"],beforeCreate(){var e=this.$parent.$fields[this.$attrs.name];this.$field=e,this.$view=e.getView(e.viewMode),this.$fields=this.$view.fields,(this.$view.datasource.vm=this).$view.datasource.field=this.$field,this.$view.datasource.parent=this.$parent.$view.datasource},render(){var e,t,i;return this.$compiledTemplate||(this.$field,e=this.$view.renderTemplate(this.$view.domTemplate()),(t=document.createElement("div")).className="content-container-heading",(i=document.createElement("div")).classList.add("grid-toolbar"),i.innerHTML=`
<button class="btn btn-sm btn-outline-secondary btn-action-add" type="button" v-on:click="createNew()" v-show="$parent.changing && !readonly">${o.i18n.gettext("Add")}</button>
<button class="btn btn-sm btn-outline-secondary btn-action-delete" type="button" v-on:click="deleteSelection()" v-show="$parent.changing && !readonly && selectionLength">${o.i18n.gettext("Delete")}</button>
`,t.append(i),(i=document.createElement("div")).className="table-responsive",i.append(e),(e=document.createElement("div")).className="onetomany-grid",e.append(t),e.append(i),t=e,this.$columns=this.$view.$columns,this.$compiledTemplate=Vue.compile(t)),this.$compiledTemplate(this)},created(){this.$parent.$view instanceof o.Forms.FormView&&this.$parent.$view.nestedViews.push(this)},data(){return{allSelected:!1,selection:[],action:{},record:{},records:null,groups:null,view:null,pendingRequest:!1,recordCount:0,dataOffset:0,dataOffsetLimit:0,selectionLength:0,$editing:!1,loading:!1,readonly:!1}},methods:{async recordClick(e,s,a){if(!this.$editing){var t=this.$parent.$view.changing;try{if("inline"===this.$field.editor){if(this.$parent.changing){this.$view.save();let t=this.$view.edit(s);let i=a.target.getAttribute("field-name");i&&setTimeout(()=>{var e=t.querySelector(`input[name=${i}]`);e&&(e.select(),e.focus())})}}else{var i=t?[{text:o.i18n.gettext("Save"),click:"saveAndClose()"},{text:o.i18n.gettext("Discard"),click:"discardAndClose()"}]:["close"],r=await d({index:s,field:this.$field,parentVm:this.$parent,master:this.$parent.$view.datasource,options:{keyboard:!1,backdrop:"static",buttons:i}}),n=(e.$loaded||e.$state!==o.Data.RecordState.unmodified?r.datasource.record=this.records[s]:await r.datasource.get({id:e.id}),t&&(r.edit(),r.focus()),await r.dialogPromise);n&&(n.$state===o.Data.RecordState.destroyed?this.records.splice(s,1):this.records[s]=n,this.$onChange())}}finally{this.$editing=!1}}},rowKeyDown(e){var t=e.target;"Escape"!==e.key||e.shiftKey||e.altKey?"Enter"!==e.key||e.shiftKey||e.altKey||(e=t.closest("tr").getAttribute("data-form-id"),this.$view.save(e)):(t.closest("tr").getAttribute("data-form-id"),this.$discard())},$flush(){"inline"===this.$field.editor&&this.$view.save()},$discard(){this.$view.discard();for(var e of this.records)e.$state===o.Data.RecordState.created&&this.records.splice(this.modelValue.indexOf(e),1),e.$$discard&&e.$$discard()},$onChange(){this.$parent.$view.$onFieldChange(this.$field,this.records),this.$emit("change",this.value),this.$emit("update:modelValue",this.modelValue)},$addRecord(e){var t=this.$view.datasource,e=t.model.newRecord(e,t);e.$flush(),this.records||(this.records=[]),this.records.push(e)},recordContextMenu(e,t,i){s.listRecordContextMenu.call(this,...arguments)},tableContextMenu(e){s.tableContextMenu.call(this,...arguments,{pasteAllowed:this.$field.pasteAllowed&&this.$parent.$view.changing})},async createNew(){if(!this.$editing)try{var e,t,i;if("inline"!==this.$field.editor)return this.$editing=!0,(e=await d({field:this.$field,parentVm:this.$parent,master:this.$parent.$view.datasource,options:{keyboard:!1,backdrop:"static",buttons:[{text:o.i18n.gettext("Save"),click:"saveAndClose()"},{text:o.i18n.gettext("Discard"),click:"discardAndClose()"}]}})).insert(),this.records||(this.records=[]),this.$parent.record[this.$field.name]||(this.$parent.record[this.$field.name]=this.records),(t=await e.dialogPromise)&&(i=e.record,this.records.push(i),this.$onChange()),t;this.$view.insert()}finally{this.$editing=!1}},toggleAll(){this._invalidateEditor(),o.Forms.selectionToggleAll.call(this,...arguments)},selectToggle(e){this._invalidateEditor(),o.Forms.selectionSelectToggle.call(this,...arguments)},unselectAll(){this._invalidateEditor(),o.Forms.unselectAll.call(this,...arguments)},deleteSelection(){this._invalidateEditor(),o.Forms.selectionDelete.call(this,...arguments)},_invalidateEditor(){this.$view.discard()}},mounted(){this.$view.element=this.$el.parentElement;var e=(this.$view.vm=this).modelValue;e&&(this.records=e)},emits:["update:modelValue"],computed:{$fields(){return console.debug("get $fields",this.$view.fields),this.$view.fields}},watch:{modelValue(e){this.records=e=e||[]}},directives:o.directivesRegistry}),o.component("field-onetomany",{template:"<div></div>",mounted(){var e=this.$parent.$view.fields[this.$attrs.name],e=(console.debug("el",e),new t(e));e.appendTo(this.$el),this.$el.$widget=e},watch:{modelValue(e){e&&console.debug("field val",e)}}});class t{constructor(e){this.field=e,this.editing=!1}newRecord(){this.editing||("inline"===this.field.editor?this.view.insert():"dialog"===this.field.editor&&console.debug("form template",this.field.getView("form")))}render(e){var t=document.createElement("div"),i=(t.className="content-container-heading",document.createElement("div")),i=(i.classList.add("grid-toolbar"),i.innerHTML=`
  <button class="btn btn-sm btn-outline-secondary btn-action-add" type="button" v-show="$parent.changing && !readonly">${o.i18n.gettext("Add")}</button>
  <button class="btn btn-sm btn-outline-secondary btn-action-delete" type="button" v-on:click="deleteSelection()" v-show="$parent.changing && !readonly && selectionLength">${o.i18n.gettext("Delete")}</button>
  `,i.querySelector(".btn-action-add").addEventListener("click",()=>this.newRecord()),t.append(i),document.createElement("div")),e=(i.className="table-responsive",i.append(e),document.createElement("div"));return e.className="onetomany-grid",e.append(t),e.append(i),e}appendTo(e){console.debug("o2m field",this.field.viewMode);var t=this.field.getView(this.field.viewMode),i=this.render(t.renderTemplate(t.domTemplate()));this.view=t,e.append(i)}}}})(Katrid=Katrid||{}),(e=>{var t=e.Forms||(e.Forms={});t.Controls||(t.Controls={}),e.component("status-field",{template:"<div><slot></slot></div>",mounted(){console.log("status field")}})})(Katrid=Katrid||{}),(e=>{var t=e.Forms||(e.Forms={});t.Widgets||(t.Widgets={}),e.component("table-field",{template:'<div class="table-responsive"><slot></slot></div>',mounted(){var e=this.$parent.$view.element;this.$name=this.$el.getAttribute("name"),this.$elView=e,this.$recordLoaded=(...e)=>this.recordLoaded(...e),e.addEventListener("record-changed",this.$recordLoaded)},unmounted(){this.$elView.removeEventListener("record-changed",this.$recordLoaded)},methods:{async recordLoaded(i){this.$timeout&&clearTimeout(this.$timeout),this.$timeout=setTimeout(async()=>{var e=i.detail.record,t={},t=(t[this.$parent.$fields[this.$name].info.field||"id"]=e.id,await this.$parent.$view.model.service.getFieldChoices({field:this.$name,filter:t}));e[this.$name]=t.data},1e3)}}})})(Katrid=Katrid||{}),(e=>{var t=e.Forms||(e.Forms={});t.Widgets||(t.Widgets={}),(0,e.Forms.registerCustomTag)("tabset",function(e){var t=document.createElement("div");t.classList.add("col-12","tabset");let a=document.createElement("div");var i=document.createElement("nav");t.append(i),a.classList.add("nav","nav-tabs"),a.setAttribute("role","tablist"),i.append(a);let r=document.createElement("div");return r.classList.add("tab-content"),Array.from(e.children).forEach((e,t)=>{var i=document.createElement("a"),s=(i.setAttribute("class",e.getAttribute("class")),i.classList.add("nav-item","nav-link"),i.setAttribute("role","tab"),e.querySelector("tab-heading")),s=(s?(i.innerHTML=s.innerHTML,s.remove()):e.hasAttribute("caption")&&(i.innerHTML=e.getAttribute("caption")),e.hasAttribute("v-if")&&i.setAttribute("v-if",e.getAttribute("v-if")),e.hasAttribute("v-show")&&i.setAttribute("v-show",e.getAttribute("v-show")),e.hasAttribute("v-hide")&&i.setAttribute("v-hide",e.getAttribute("v-hide")),i.setAttribute("onclick",`$(this).tab('show');let tabset=$(this).closest('.tabset');tabset.find('[data-tab]').removeClass('active');tabset.find('[data-tab=${t}]').addClass('active');`),a.append(i),document.createElement("div"));s.classList.add("tab-pane","row"),s.setAttribute("data-tab",t.toString()),s.setAttribute("role","tabpanel"),s.innerHTML=e.innerHTML,r.append(s),0===t&&(i.classList.add("active"),s.classList.add("active"))}),t.append(r),e.replaceWith(t),t})})(Katrid=Katrid||{}),(s=>{var e=s.Forms||(s.Forms={});e.Widgets||(e.Widgets={}),s.directive("ui-tooltip",{mounted(e,t,i){t=t.value;t instanceof s.Data.Field&&t.getTooltip(e)}})})(Katrid=Katrid||{}),(e=>{{e=e.ui||(e.ui={});class t extends e.WebComponent{get datasource(){return this._datasource}set datasource(e){this._callback&&this._datasource&&this._datasource.unregisterCallback(this._callback),this._callback=e=>{this._created&&this.parentNotification(e)},(this._datasource=e)&&e.registerCallback(this._callback)}create(){super.create(),this._files=[],this.createEditor(),this._panel=document.createElement("div"),this._panel.className="container comments",this.appendChild(this._panel)}createEditor(){var e=document.createElement("div");e.innerHTML=`
      <div class="container">
          <h3>${Katrid.i18n.gettext("Comments")}</h3>
          <div class="form-group">
          <button class="btn btn-outline-secondary btn-show-editor">${Katrid.i18n.gettext("New message")}</button>
          <button class="btn btn-outline-secondary">${Katrid.i18n.gettext("Log note")}</button>
          </div>
          <div id="mail-editor" style="display: none;">
            <div class="form-group">
              <textarea id="mail-msgEditor" class="form-control"></textarea>
            </div>
            <div class="form-group">
              <button class="btn btn-default" type="button" onclick="$(this).next().click()"><i class="fa fa-paperclip"></i></button>
              <input class="input-file-hidden" type="file" multiple>
            </div>
            <div class="form-group">
              <ul class="list-inline attachments-area">
              </ul>
            </div>
            <div class="from-group">
              <button class="btn btn-primary btn-send">${Katrid.i18n.gettext("Send")}</button>
            </div>
          </div>
  
          <hr>`,this._textEditor=e.querySelector("textarea"),this._file=e.querySelector("input"),this._file.addEventListener("change",e=>this.addFile(e)),e.querySelector("button.btn-show-editor").addEventListener("click",()=>this.showEditor()),e.querySelector("button.btn-send").addEventListener("click",()=>this.sendMessage(this._textEditor.value)),this.appendChild(e)}showEditor(){$(this.querySelector("#mail-editor")).show(),this._textEditor.focus(),this._textEditor.scrollIntoView()}closeEditor(){$(this.querySelector("#mail-editor")).hide(),this.querySelector(".attachments-area").innerHTML="",this._files=[]}addFile(e){for(var t of e.target.files){this._files.push(t);t=`<li title="${Katrid.i18n.gettext("Delete this attachment")}">${t.name} <i class="fa fa-times"></i></li>`;this.querySelector(".attachments-area").insertAdjacentHTML("beforeend",t)}}async _sendMessage(e,t){var i=new Katrid.Services.ModelService("mail.message"),i=(console.log(t),t=t&&t.map(e=>e.id),await i.post("post_message",{args:[this._datasource.model.name,this._recordId],kwargs:{content:e,content_subtype:"html",format:!0,attachments:t}}));this._panel.insertAdjacentElement("afterbegin",this._createComment(i))}async sendMessage(e){this._textEditor.value="";var t=this._files,t=(this.closeEditor(),console.log("files",t),await Katrid.Services.Attachments.upload({files:t},{model:this._datasource.model,recordId:this._recordId}));console.log("att",t),await this._sendMessage(e,t.result)}async parentNotification(e){this._panel.innerHTML="";var t=this.datasource.recordId;if(null!=(this._recordId=t)){t=await new Katrid.Services.ModelService("mail.message").rpc("get_messages",null,{model_name:this.datasource.model.name,id:t});if(t.comments)for(var i of t.comments)this._panel.appendChild(this._createComment(i))}}_createComment(e){var t=e.attachments?.length?`
      <div class="form-group">
        <ul class="list-inline">
          ${e.attachments.map(e=>e.mimetype.startsWith("image")?`<li><div class="comment-preview-image" style="width: 16%;height:100px;background-image:url('/web/content/${e.id}')"></div></li>`:`<li><a href="/web/content/${e.id}/?download">${e.name}</a></li>`).join("")}
        </ul>
      </div>
`:"",i=document.createElement("div");return i.className="comment d-flex",i.innerHTML=`
        <div class="flex-shrink-0"><img src="/static/admin/assets/img/avatar.png" class="avatar rounded"></div>
        <div class="flex-grow-1 ms-3">
          <strong>${e.author_name}</strong> - 
          <span class="timestamp text-muted" title="${moment(e.date_time).format("LLLL")}"> ${moment(e.date_time).fromNow()}</span>
          <div class="form-group">
            ${e.content}
          </div>

          ${t}

        </div>
      `,i}}Katrid.define("user-comments",e.UserCommentsElement=t),Katrid.component("user-comments",{template:"<user-comments/>",mounted(){this.$el.datasource=this.$parent.$view?.datasource}})}})(katrid=katrid||{}),(s=>{{var e=s.Services||(s.Services={});class t{}e.BaseAdapter=t,e.LocalMemoryConnection=class{};class i extends t{$fetch(i,e,t){return t&&(i=new URL(i),Object.entries(t).map((e,t)=>i.searchParams.append(e,t))),$(s).trigger("fetch.before"),fetch(i,e).then(e=>($(s).trigger("fetch.done"),e))}fetch(e,t){return window.fetch(e,t)}}e.FetchAdapter=i}})(Katrid=Katrid||{}),(e=>{{e=e.Services||(e.Services={});class t extends e.FetchAdapter{}e.JsonRpcAdapter=t}})(Katrid=Katrid||{}),(r=>{{var e=r.Services||(r.Services={});class s extends e.Service{searchByName(e){return this.post("api_search_by_name",e)}createName(e){return this.post("api_create_name",{kwargs:{name:e}})}search(e,t,i,s){return this.post("api_search",{kwargs:e},t,i,s)}listId(e,t,i){return this.post("api_list_id",{kwargs:e},null,t,i)}delete(e){return Array.isArray(e)||(e=[e]),this.post("api_delete",{kwargs:{ids:e}})}getById(e,t){var i=t?.fields;return this.post("api_get",{args:[e,i]},null,t)}getDefaults(e,t){return this.post("api_get_defaults",{kwargs:e},null,t)}copy(e){return this.post("api_copy",{args:[e]})}static _prepareFields(t){return t&&(t.fields&&(t.fields=r.Data.Fields.fromArray(t.fields),t.fieldList=Object.values(t.fields)),t.views)&&(Object.values(t.views).map(e=>e.fields=r.Data.Fields.fromArray(e.fields)),Object.keys(t.views).map(e=>t.views[e]=new r.Forms.ModelViewInfo(t.views[e]))),t}getViewInfo(e){return this.post("admin_get_view_info",{kwargs:e}).then(this.constructor._prepareFields)}async loadViews(e){return this.post("admin_load_views",{kwargs:e}).then(s._prepareFields)}getFieldsInfo(e){return this.post("admin_get_fields_info",{kwargs:e}).then(s._prepareFields)}getFieldChoices(e){var t=e.kwargs||{};return e.filter&&(t.filter=e.filter),e.context&&(t.context=e.context),this.post("api_get_field_choices",{args:[e.field,e.term],kwargs:t},null,e.config)}getFieldChoice(e){var t=e.kwargs||{};return e.filter&&(t.filter=e.filter),e.context&&(t.context=e.context),this.post("api_get_field_choice",{args:[e.field,e.term],kwargs:t},null,e.config)}doViewAction(e){return this.post("admin_do_view_action",{kwargs:e})}callAdminViewAction(e){return this.post("admin_call_view_action",{kwargs:e})}callSubAction(e,t){return this.post("admin_call_sub_action",{params:{ids:t.ids}})}write(e,s){return new Promise((t,i)=>{this.post("api_write",{kwargs:{data:e}},s).then(e=>{r.Forms.Dialogs.Alerts.success(r.i18n.gettext("Record saved successfully.")),t(e)}).catch(e=>{500===e.status&&e.responseText?alert(e.responseText):(r.Forms.Dialogs.Alerts.error(r.i18n.gettext("Error saving record changes")),console.log("error",e),e.error&&r.Forms.Dialogs.Alerts.error(e.error)),i(e)})})}groupBy(e,t){return this.post("api_group_by",{kwargs:{grouping:e,params:t}})}autoReport(){return this.post("admin_auto_report",{kwargs:{}})}rpc(e,s,a){return new Promise((t,i)=>{this.post(e,{args:s,kwargs:a}).then(e=>{t(e)}).catch(e=>{if(e?.error&&"string"==typeof e.error)r.Forms.Dialogs.Alerts.error(e.error);else if(e.messages&&r.isObject(e.messages))for(var t of Object.values(e.messages))"string"==typeof t?r.Forms.Dialogs.Alerts.error(t):t instanceof Array&&r.Forms.Dialogs.Alerts.error(t.join("\n"));else r.Forms.Dialogs.Alerts.error(e.message);i(e)})})}}e.ModelService=s;class n extends s{constructor(e){super("ui.action.report"),this.id=e}static read(e){let t,i,s,a;return i=r.isObject(e)?(t=e.details,s=e.params,a=e.filter,e.id):e,(new n).post("read",{args:[i],kwargs:{with_description:t,params:s,as_dict:e.as_dict,filter:a}})}static all(){return(new n).rpc("list_all")}getMetadata(e=!1){return this.rpc("get_metadata",[this.id],{dev_info:e})}execute(e){return this.rpc("execute",[this.id],{params:e.params})}static executeSql(e){return(new n).post("execute_sql",{args:[e]})}}e.Query=n;class t extends s{static load(e){return new s("ui.action").post("load",{args:[e],kwargs:{context:r.app.context}})}static onExecuteAction(e,t,i){return new s(t).post("on_execute_action",{args:[e],kwargs:{context:i}})}}e.Actions=t}})(Katrid=Katrid||{}),(e=>{{e=e.Services||(e.Services={});class t extends e.BaseAdapter{constructor(...e){super(),openDatabase(...e)}$fetch(e,t,i){console.log(e,t,i)}}e.WebSQLAdapter=t}})(Katrid=Katrid||{}),(e=>{(e=e.sql||(e.sql={})).Select=class{},e.From=class{},e.Alias=class{constructor(e){this.name=e}},e.select=function(){},e.from=function(){}})(katrid=katrid||{});let select=katrid.sql.select;function sprintf(e,t){return Array.isArray(t)?e.replace(/%s/g,e=>String(t.shift())):e.replace(/%\(\w+\)s/g,e=>String(t[e.slice(2,-2)]))}!function(katrid){var test;!function(test){function click(e){document.querySelector(e).click()}function modelActionTour(e){var t=new Tour;return console.log("args",e),t.modelActionTour(e)}function waitFor(s,a=1e4){let r;return new Promise((t,e)=>{let i=document.querySelector(s);if(i)return t(i);(r=new MutationObserver(e=>e.forEach(e=>{e.addedNodes&&(i=document.querySelector(s))&&t(i)}))).observe(document.body,{childList:!0,subtree:!0,attributes:!1,characterData:!1}),setTimeout(()=>e(),a)}).finally(()=>{r&&r.disconnect()})}async function menuClick(...e){let t=Katrid.webApp.config.menu;for(var i of e)for(var s of t)if(s.name===i){t=s.children,document.getElementById("ui-menu-"+s.id).click(),await katrid.sleep(1e3);break}}async function sendKeys(e,t,i=0){}function _sendKeys(e,t){for(var i of t)e.value+=i}test.click=click,test.modelActionTour=modelActionTour,test.waitFor=waitFor,test.menuClick=menuClick,test.sendKeys=sendKeys;class Tour{constructor(e){this.parent=e,this.navigationInterval=1e3}async textClick(e){this.parent&&$(parent).find(`:contains("${e}")`)[0].click()}async set(e,t){let i;e=(i="string"==typeof e?document.querySelector(`.form-field-section[name="${e}"]`):e).querySelector("input,select");e&&(e.focus(),e.click(),e.value=t,e.dispatchEvent(new Event("input")),e.dispatchEvent(new Event("change")),i.classList.contains("ForeignKey"))&&(await this.waitFor(".dropdown-item[data-item-id]")).click()}async menuClick(e){return menuClick(...e)}waitFor(e,t=1e4){return waitFor(e,t)}click(e){return document.querySelector(e).click()}async sendKeys(e,t){e.focus(),e.click(),e.value=t,e.dispatchEvent(new Event("input"))}async sendKeysToField(e,t,i){e=e.querySelector(`.form-field-section[name="${t}"]`);await this.set(e,i)}async addRecordTo(e,t){e.querySelector(".btn-action-add").click();var i,s,a=await this.waitFor(".modal[data-model]");for([i,s]of Object.entries(t))await this.sendKeysToField(a,i,s.toString());await katrid.sleep(100),a.querySelector(".modal-footer .btn").click()}async editRecordFrom(e,t){e.click();var i,s,a=await this.waitFor(".modal[data-model]");for([i,s]of Object.entries(t))i.startsWith("$")||i.startsWith("_")||await this.sendKeysToField(a,i,s.toString());await katrid.sleep(100),a.querySelector(".modal-footer .btn").click()}async deleteRecordFrom(e,t){await katrid.sleep(1e3),e.querySelector(`tbody tr:nth-child(${t}) input[type=checkbox]`).click(),e.querySelector(".btn-action-delete").click(),await katrid.sleep(100)}async _setFields(e,t){for(var[i,s]of Object.entries(e))if(!i.startsWith("$")&&!i.startsWith("_")){var a=t.querySelector(`.form-field-section[name="${i}"]`);if(a)if(a.classList.contains("OneToManyField"))if(Array.isArray(s))for(var r of s)void 0!==r.$edit?await this.editRecordFrom(a.querySelector(`tbody tr:nth-child(${r.$edit+1})`),r):r.$delete?await this.deleteRecordFrom(a,r.$delete):await this.addRecordTo(a,r);else await this.addRecordTo(a,s);else await this.set(a,s.toString());else console.log("Field not found",i,t)}}async _modelAction(e,t){"create"===e||"new"===e?((await this.waitFor(".btn-action-create")).click(),await katrid.sleep(500),await this.waitFor(".btn-action-save"),await this._setFields(t,document.body),"create"===e&&document.querySelector(".btn-action-save").click()):"update"===e?((await this.waitFor(".btn-action-edit")).click(),await this._setFields(t,document.body),await katrid.sleep(500),document.querySelector(".btn-action-save").click()):"refresh"===e&&(document.querySelector(".btn-action-refresh").click(),await katrid.sleep(1e3))}async modelActionTour(e){for(var[t,i]of Object.entries(e))switch(t){case"steps":await this.tour(i);break;case"menu":await this.menuClick(i);break;default:await this._modelAction(t,i)}}async assert(e){if("object"==typeof e&&!this._step(e))throw Error("Assertion error")}async _step(step){for(var[k,v]of Object.entries(step))switch(k){case"steps":await this.tour(v);break;case"model":await this.modelActionTour(v);break;case"menu":await this.menuClick(v);break;case"click":await document.querySelector(v.toString()).click();break;case"waitFor":await this.waitFor(v.toString());break;case"waitAndClick":await this.waitFor(v.toString()),await document.querySelector(v.toString()).click();break;case"sleep":await katrid.sleep(Number(v));break;case"eval":await eval(v.toString());break;case"assert":await this.assert(v);break;case"count":for(var[sel,count]of Object.entries(v))return document.querySelectorAll(sel).length===count}}async tour(e){if(Array.isArray(e))for(var t of e)await this._step(t);else e.steps&&await this._step(e)}}function runTour(e){return(new Tour).tour(e)}async function tour(e){console.debug("Start test tour"),await e.call(new Tour),console.debug("Test tour finish")}test.Tour=Tour,test.runTour=runTour,test.tour=tour}(test=katrid.test||(katrid.test={}))}(katrid=katrid||{}),(e=>{{var t=e.ui||(e.ui={});class i extends e.Core.WebApplication{}t.Application=i}})(Katrid=Katrid||{}),(h=>{{var e=h.UI||(h.UI={});class t extends h.WebComponent{constructor(){super(...arguments),this._menuClicked=!1}create(){this.app=h.webApp,super.create(),this.app?.config?.menu&&(this.loadModules(this.app.config.menu),this.createUserMenu(),document.addEventListener("click",e=>{this._menuClicked=!1,this.hideMenu()})),this.inputSearch=this.querySelector("#navbar-search"),this.autocomplete=new i(this.inputSearch,this.app.config.menu);let e=new h.ui.Tooltip(this.querySelector(".navbar-search"),{helpText:`<h5>Pesquisa rápida</h5>Cliente: <strong>cli: &lt;nome do cliente&gt;</strong>
<br>Forncedor: <strong>for: &lt;nome do cliente&gt;</strong>
<br>Nota Fiscal: <strong>nf: &lt;num da nota&gt;</strong>
`});this.inputSearch.addEventListener("input",()=>e.hide())}loadModules(e){this.nav=document.querySelector("#navbar"),this.navMenu=document.querySelector("#navbar-menu");var t,i=document.querySelector(".apps-menu");for(t of e){this._rootItem=t;var s,a=this.createDropdownItem(t),r=(a.classList.add("text-center"),t.icon),r=(r?.includes(".")?((s=document.createElement("img")).src=r,a.append(s)):((s=document.createElement("i")).className=r||"fa-4x fas fa-cube",a.append(s)),document.createElement("span")),r=(r.innerText=t.name,a.append(r),i.append(a),"#/app/?menu_id="+t.id);t.url=r,a.setAttribute("href",r),a.classList.add("module-selector"),this.createMenu(t)}}createMenu(e){var t=document.createElement("a"),i=document.createElement("div"),s=document.createElement("h3");if(i.classList.add("dropdown"),t.classList.add("module-nav-link","navbar-menu-header"),i.style.display="none",s.innerText=e.name,t.append(s),t.setAttribute("data-bs-toggle","dropdown"),i.append(t),this.insertBefore(i,this.navMenu),i.setAttribute("data-menu-id",e.id.toString()),h.isMobile)t.classList.add("dropdown-toggle"),i.classList.add("mr-auto"),e.children?.length&&(s=this.createDropdownMenu(e.children),i.append(s));else{var a=document.createElement("ul"),r=(a.classList.add("navbar-nav","navbar-menu-group","mr-auto"),a.style.display="none",a.setAttribute("data-parent-id",e.id.toString()),this.navMenu.append(a),e=>{e.stopPropagation(),e.preventDefault(),this._menuClicked=!this._menuClicked,this._menuClicked?this.showMenu(e.target.parentElement):this.hideMenu()}),n=e=>{this.hideMenu(),this._menuClicked?this.showMenu(e.target):this._timeout=setTimeout(()=>this.showMenu(e.target),2e3)},o=()=>{clearTimeout(this._timeout),this._menuClicked||(this._timeout=setTimeout(()=>this.hideMenu(),2e3))};if(e.children)for(var d of e.children){var l=document.createElement("li"),c=(l.classList.add("nav-item","dropdown"),l.addEventListener("click",r),l.addEventListener("pointerenter",n),l.addEventListener("pointerleave",o),document.createElement("a"));c.classList.add("nav-link","dropdown-link","menu-item-action"),c.setAttribute("id","ui-menu-"+d.id.toString()),c.setAttribute("role","button"),c.innerText=d.name,l.append(c),a.append(l),d.children?.length?l.append(this.createDropdownMenu(d.children)):(d.url="#/app/?menu_id="+this._rootItem.id.toString()+"&action="+d.action,c.setAttribute("href",d.url),c.addEventListener("click",e=>(e.stopPropagation(),!1)))}}return t}showMenu(e){$(".apps-menu.show").removeClass("show"),clearTimeout(this._timeout),e.classList.add("show"),this._currentMenu=e}hideMenu(){clearTimeout(this._timeout),this._currentMenu&&(this._currentMenu.classList.remove("show"),this._currentMenu=null)}createDropdownMenu(e){var t,i=document.createElement("div");i.classList.add("dropdown-menu");for(t of e)this.createMenuItem(t,i);return i}createDropdownItem(t){var i=document.createElement("a");if(i.classList.add("dropdown-item","menu-item-action"),i.setAttribute("id","ui-menu-"+t.id.toString()),i.setAttribute("data-menu-id",t.id.toString()),t.url){let e=t.url;e.startsWith("#/action/")&&(e+="?menu_id="+this._rootItem.id),t.url=e,i.setAttribute("href",e)}return i}createMenuItem(e,i){if(!e.children||!e.children.length)return(a=this.createDropdownItem(e)).innerText=e.name,e.action&&(e.url="#/app/?menu_id="+this._rootItem.id+"&action="+e.action,a.setAttribute("href",e.url)),(e.action||e.url)&&a.addEventListener("click",e=>{e.stopPropagation(),this.hideMenu()}),i.append(a),a;{var s,a=this.createDropdownItem(e),r=(a.innerText=e.name,document.createElement("li"));let t=document.createElement("ul");a.classList.add("dropdown-toggle"),r.classList.add("dropdown-submenu"),r.append(a),r.append(t),a.addEventListener("click",e=>{e.stopPropagation(),e.preventDefault(),t.classList.toggle("show")}),i.append(r);for(s of e.children)this.createMenuItem(s,t)}}createUserMenu(){this.querySelector(".nav-item.user-menu.dropdown")}}e.AppHeader=t,h.define("app-header",t);class i{constructor(e,o){this.input=e,this.menu=null,this.term="",this._localMenuCache=[],this.input.addEventListener("input",()=>this.onInput()),this.input.addEventListener("click",e=>{this.input.select(),this.onClick()}),this.input.addEventListener("blur",()=>this.onFocusout()),this.input.addEventListener("keydown",e=>this.onKeyDown(e));this.setSource(async n=>new Promise(r=>{clearTimeout(void 0),setTimeout(async()=>{var e,t=[],i=n.term.normalize("NFD").replace(/\p{Diacritic}/gu,""),s=new RegExp(i,"i");let a=h.Services.Service.$post("/web/menu/search/",{term:i}).then(e=>e.items);this._localMenuCache.length||o.forEach(e=>this._registerMenuItem(e));for(e of this._localMenuCache)if(s.test(e.normalized)&&(t.push({id:e.id,text:e.fullPath,href:e.href}),5<t.length))break;try{a=await a}catch(e){a=[]}r(t.concat(a))},300)}))}_registerMenuItem(e,t){var i=e.name.trim(),s=i.normalize("NFD").replace(/\p{Diacritic}/gu,"");let a=i;var r,t=(a=t?t+" / "+a:a).normalize("NFD").replace(/\p{Diacritic}/gu,"");this._localMenuCache.push({id:e.id,text:i,fullPath:a,normalized:s,normalizedFullPath:t,href:e.url});for(r of e.children)this._registerMenuItem(r,a)}onInput(){this.term=this.input.value,this.$selectedItem&&(this.$selectedItem=null),this.showMenu()}onClick(){this.showMenu()}onFocusout(){this.menu.mouseDown||(this.hideMenu(),this.invalidateValue()),this.term=""}createMenu(){this.menu=new e.DropdownMenu(this,{source:this._source,target:this.input.parentElement})}invalidateValue(){this.selectedItem=this.$selectedItem}onKeyDown(e){if(this.menu)switch(e.which){case h.UI.keyCode.DOWN:this.menu.move(1),e.preventDefault();break;case h.UI.keyCode.UP:this.menu.move(-1),e.preventDefault();break;case h.UI.keyCode.ENTER:this.menu.activeItem&&(this.menu.onSelectItem(),e.preventDefault());break;case h.UI.keyCode.ESCAPE:this.menu&&this.hideMenu()}}showMenu(){this.menu||(this.createMenu(),this.menu.show()),this.menu.init()}hideMenu(){this.input.value="",this.menu&&this.menu.hide(),this.menu=null}menuVisible(){return this.menu.visible}setOptions(e){e.source&&this.setSource(e.source)}setSource(e){this._source=e}_selectItem(e){this.term="";e&&(e=$(e).data("item"))?.href&&(window.location.href=e.href),this.hideMenu()}setValue(e,t){t=new CustomEvent("selectItem",{detail:{item:e,dropdownItem:t}});return t.defaultPrevented||(this.selectedItem=e,this.menu&&this.hideMenu()),t}get selectedItem(){return this.$selectedItem}set selectedItem(e){this.$selectedItem=e,this.input&&(this.input.value=e?e.text:"")}get selectedValue(){if(this.$selectedItem)return this.$selectedItem.id}}}})(Katrid=Katrid||{}),(e=>{(e.ui||(e.ui={})).Button=class{constructor(e){this.config=e,this.text=e.text,this.onClick=e.click}}})(Katrid=Katrid||{}),(e=>{(e.ui||(e.ui={})).Calendar=class{constructor(e,t){this.config=t,this.target=e,this.config||(this.config={}),this._date=this.config.date||new Date}get date(){return this._date}set date(e){this._date=e}_renderMonthCalendar(t,i){var s=document.createElement("div"),a=(s.classList.add("month-calendar"),new Date(t,i,1)),e=a.getDay(),r=document.createElement("div");r.classList.add("month-header");let n=document.createElement("button");n.type="button",n.classList.add("btn"),n.innerHTML='<i class="fas fa-chevron-left"></i>',n.addEventListener("pointerdown",e=>e.stopPropagation()),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.element.innerHTML="";e=moment(new Date(t,i,1)).add(-1,"months");this._renderMonthCalendar(e.year(),e.month())}),r.append(n);var o=document.createElement("label"),d=(o.classList.add("month-name"),o.innerText=moment(a).format("MMMM"),r.append(o),(n=document.createElement("button")).type="button",n.classList.add("btn"),n.innerHTML='<i class="fas fa-chevron-right"></i>',n.addEventListener("pointerdown",e=>e.stopPropagation()),n.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),this.element.innerHTML="";e=moment(new Date(t,i,1)).add(1,"months");this._renderMonthCalendar(e.year(),e.month())}),r.append(n),this.element.append(r),["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"]);for(let e=0;e<7;e++){var l=document.createElement("div");l.classList.add("dow"),l.innerText=d[e],s.append(l)}var c=e=>this.dayClick(e);a.setDate(a.getDate()-e);for(let e=0;e<42;e++){var h=this._renderDay(a),p=a.getMonth();i<p?h.classList.add("new"):p<i&&h.classList.add("old"),s.append(h),a.setDate(a.getDate()+1),h.addEventListener("click",c),h.addEventListener("pointerdown",this.dayMouseDown)}this.element.append(s)}dayMouseDown(e){e.stopPropagation()}dayClick(e){e.stopPropagation(),this.config.change&&this.config.change(e.target.getAttribute("data-value")),this.hide()}_renderDay(e){var t=document.createElement("div");return t.classList.add("day"),t.innerText=e.getDate().toString(),t.setAttribute("data-value",moment(e).format("YYYY-MM-DD")),t}render(){return this.element=document.createElement("div"),this.element.classList.add("date-calendar"),this._renderMonthCalendar(this._date.getFullYear(),this._date.getMonth()),this.element}show(){this._docMouseEvent=()=>{document.removeEventListener("pointerdown",this._docMouseEvent),this.hide()},document.addEventListener("pointerdown",this._docMouseEvent);var e=this.render();this._popper=Popper.createPopper(this.target,e,{placement:"bottom-start"}),e.classList.add("show"),document.body.append(e)}hide(){this.element.remove(),this._popper.destroy()}}})(Katrid=Katrid||{}),(e=>{(e.ui||(e.ui={})).openFileDialog=async function(e,t=!1){let i=document.createElement("input");return i.type="file",i.style.display="none",i.accept=e,i.multiple=t,new Promise((e,t)=>{i.addEventListener("change",()=>{e(i)}),i.addEventListener("cancel",()=>e()),i.click()})}})(katrid=katrid||{}),(e=>{function t(e,t="MM/DD/YYYY"){if(e)return"shortDate"==t?t=Katrid.i18n.formats.shortDateFormat:"short"==t&&(t=Katrid.i18n.formats.shortDateTimeFormat),moment(e).format(t)}(e=e.filters||(e.filters={})).date=t,e.shortDate=function(e){return t(e,"shortDate")},e.dateTimeHumanize=function(e){if(e)return moment(e).format("ddd, LLL")+" ("+moment(e).fromNow()+")"}})(katrid=katrid||{}),Katrid.filter("date",katrid.filters.date),Katrid.filter("shortDate",katrid.filters.shortDate),Katrid.filter("dateHumanize",function(e){if(e)return moment(e).format("ddd, LL")+" ("+moment(e).fromNow()+")"}),Katrid.filter("dateTimeHumanize",katrid.filters.dateTimeHumanize),Katrid.filter("number",function(e,t){if(null!=e)return Katrid.intl.number(t).format(e)}),Katrid.filter("toFixed",function(e,t=2){if(null!=e)return Katrid.intl.toFixed(t).format(e)}),Katrid.filter("sprintf",function(e,...t){return sprintf(e,t)}),(e=>{{class t{getTooltipHelp(e){}}(e=e.UI||(e.UI={})).HelpProvider=t,e.helpProvider=new t}})(Katrid=Katrid||{}),(t=>{{var i=t.UI||(t.UI={});class s{constructor(e){(this.app=e)||(this.app=t.webApp),this._actionChanged=()=>this.actionChanged(),this.app.element.addEventListener("katrid.actionChange",this._actionChanged),this.container=document.createElement("div"),this.container.className="help-center",this.app.element.parentElement.append(this.container),this.actionChanged(0)}clear(){this.element&&(this.element.innerHTML=t.i18n.gettext("Loading..."))}actionChanged(e=1e3){this.clear(),this._timeout&&clearTimeout(this._timeout),this._timeout=setTimeout(()=>{this.createElement(),this.collectHelp()},e)}destroy(){this.app.element.removeEventListener("katrid.actionChange",this._actionChanged),this.container.remove(),e=null}createElement(){this.element||(this.element=document.createElement("div")),this.element.className="help-center-content";var e=this.element;e.innerHTML=`<table class="table"><tr><td><h2>Help Center</h2></td><td style="text-align: right"><button title="${t.i18n.gettext("Close")}" class="btn-close"></button></td></tr></table>`,e.querySelector(".btn-close").addEventListener("click",()=>this.destroy()),this.container.append(e)}collectHelp(){this.app.actionManager.action&&this.app.actionManager.action.generateHelp(this)}}i.HelpCenter=s;let e;i.helpCenter=function(){return e=e||new s}}})(Katrid=Katrid||{}),(e=>{(e.ui||(e.ui={})).Input=class{constructor(e){(this.input=e).className="form-control"}}})(Katrid=Katrid||{}),(n=>{var e=n.Forms||(n.Forms={});{e=e.Widgets||(e.Widgets={});class t extends HTMLElement{connectedCallback(){var e=this.getAttribute("data-title");let r={};e&&(r.title=e);var e=this.getAttribute("data-service"),t=(this.getAttribute("data-url"),this.getAttribute("data-query-id"));if(e){var i=this.getAttribute("data-method");new n.Services.ModelService(e).rpc(i).then(e=>{n.isString(e)&&(e=JSON.parse(e)),Plotly.plot(this,JSON.parse(e),r,{responsive:!0})})}else if(t){let i=this.getAttribute("data-x"),s=this.getAttribute("data-y"),a=this.getAttribute("data-marker");a=a&&JSON.parse(a);let e;i||(e=[i,s]),i=i||0,s=s||1,n.Services.Query.read({id:t,as_dict:!1,fields:e}).then(e=>{let t=this.getAttribute("chart-type");t=t||"bar";e=this.transformData(e.data,i,s),e={chartType:t,x:e.x,y:e.y,marker:a};Plotly.plot(this,e,r,{responsive:!0})})}}transformData(e,t,i){var s,a=[],r=[];for(s of e)a.push(s[t]),r.push(s[i]);return{x:a,y:r}}}e.PlotlyChart=t,n.define("plotly-chart",t)}})(Katrid=Katrid||{}),(e=>{(e=(e=e.UI||(e.UI={})).Utils||(e.Utils={})).tableToText=function(e){var t,i,s=[];let a=[];for(t of e.tHead.rows[0].querySelectorAll("th"))t.classList.contains("list-record-selector")||a.push(t.innerText);s.push(a.join("\t"));for(i of e.querySelectorAll("tr")){a=[];for(var r of i.querySelectorAll("td"))a.push(r.innerText);a.length&&s.push(a.join("\t"))}return s.join("\n")},e.toTsv=function(e){var t,i=[];for(t of e){var s,a,r=[];for([s,a]of Object.entries(t))null==a?r.push(""):r.push(a.toString());i.push(r.join("\t"))}return i.join("\n")},e.textToDownload=function(e,t){var e=new Blob([e],{type:"text/csv"}),i=document.createElement("a");try{i.href=URL.createObjectURL(e),t=t||"document.csv",i.download=t,document.body.appendChild(i),i.click()}finally{document.body.removeChild(i)}}})(Katrid=Katrid||{}),(e=>{{class t{static createElement(e){this._container||((t=document.createElement("div")).classList.add("toast-container","position-fixed","bottom-0","end-0","p-3"),document.body.append(t),this._container=t);var t=document.createElement("div");return t.classList.add("toast"),e.classList&&t.classList.add(...e.classList),t.innerHTML=`<div class="d-flex"><div class="toast-body">${e.message}</div></div>`,void 0!==e.canClose&&!e.canClose||t.querySelector(".d-flex").append($('<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>')[0]),this._container.append(t),t}static show(e){let t=this.createElement(e);e=new bootstrap.Toast(t);return e.show(),t.addEventListener("hidden.bs.toast",()=>t.remove()),e}static danger(e){return e.classList=["text-bg-danger","toast-dark"],this.show(e)}static success(e){return e.classList=["text-bg-success","toast-dark"],this.show(e)}static info(e){return e.classList=["text-bg-info"],this.show(e)}static warning(e){return e.classList=["text-bg-warning"],this.show(e)}}(e=e.UI||(e.UI={})).Toast=t,e.showMessage=function(e){return t.show({message:e})}}})(Katrid=Katrid||{}),(e=>{{(e=e.ui||(e.ui={})).Toolbar=class{constructor(e){this.container=e,this._vertical=!1,this.create(),e&&e.appendChild(this.el)}create(){this.el=document.createElement("div"),this.el.className="toolbar"}addButton(e){var t,i=document.createElement("button");return i.type="button",i.className="btn btn-outline-secondary tool-button","string"==typeof e?i.innerHTML=e:(e.iconClass&&((t=document.createElement("i")).className=e.iconClass,t.classList.add("icon"),i.appendChild(t)),e.text&&i.append(e.text),e.onClick&&i.addEventListener("click",e.onClick)),this.el.appendChild(i),i}addSeparator(){var e=document.createElement("div");e.className="separator",this.el.appendChild(e)}addGroup(){return new t(this)}get vertical(){return this._vertical}set vertical(e){(this._vertical=e)?this.el.classList.add("vertical"):this.el.classList.remove("vertical")}showFloating(e,t){this.el.classList.add("floating"),this.el.style.left=e+"px",this.el.style.top=t+"px",document.body.appendChild(this.el)}};class t{constructor(e){this.toolbar=e,this.create()}create(){this.el=document.createElement("div"),this.el.className="btn-group",this.toolbar.el.appendChild(this.el)}addButton(e){return this.el.appendChild(this.toolbar.addButton(e))}}e.ToolButtonGroup=t}})(katrid=katrid||{}),(e=>{{e=e.ui||(e.ui={});let r,n;e.Tooltip=class{constructor(t,e){let i=e?.helpText,s=(this.target=t).getAttribute("data-title");s&&t.removeAttribute("data-title");let a;t.addEventListener("mouseenter",e=>{n&&n.hide(),clearTimeout(r),r=setTimeout(()=>{n=this;let e=t.getAttribute("data-tooltip")||"";e&&(e+="<br>"),(e+=s||i)&&this.show(e)},1500),a=setTimeout(()=>this.hide(),15e4)},!1),t.addEventListener("mouseleave",e=>{clearTimeout(r),clearTimeout(a),a=setTimeout(()=>{}),this.hide()},!1)}createElement(e){return $(`<div class="tooltip"><div class="tooltip-inner">${e}<div class="documentation-tip"></div></div></div>`)[0]}show(e){this.element||(this.element=this.createElement(e),this._popper=Popper.createPopper(this.target,this.element,{placement:"top-start"})),document.body.append(this.element),this.element.classList.add("show"),this.documentation&&this.loadAdditionalTip()}hide(){clearTimeout(this._additionalTip),this.element&&(this.element.remove(),this._popper=null,this.element=null)}loadAdditionalTip(){this._additionalTip=setTimeout(()=>{this.element.querySelector(".documentation-tip").innerHTML=this.documentation,this._popper.update()},1500)}}}})(Katrid=Katrid||{}),(e=>{(e.ui||(e.ui={})).Tooltip=Katrid.ui.Tooltip})(katrid=katrid||{}),(e=>{{e=e.ui||(e.ui={});let t="fa-chevron-right",i="fa-chevron-down";e.Component=class{get el(){return this._el}set el(e){this.setElement(e)}setElement(e){(this._el=e).katrid={object:this}}};class s{constructor(e,t,i){var s;this.treeView=e,this.options=i,this._selected=!1,this._expanded=!1,this._level=0,this._children=[],t instanceof HTMLElement?this.el=t:t&&(this.data=t,(e=document.createElement("li")).classList.add("tree-node"),(s=document.createElement("div")).addEventListener("mousedown",e=>{e.preventDefault(),this.treeView.el.focus()}),s.addEventListener("click",()=>this.select()),s.addEventListener("dblclick",e=>{e.preventDefault(),this._expanded?this.collapse():this.expand()}),this._ul=document.createElement("ul"),s.className="tree-item",e.appendChild(s),e.appendChild(this._ul),this.el=e,this._a=s,this._canExpand=!0,this._exp=document.createElement("span"),this._exp.addEventListener("dblclick",e=>e.stopPropagation()),this._exp.addEventListener("click",e=>{e.preventDefault(),this.expanded=!this.expanded}),i?.onContextMenu&&s.addEventListener("contextmenu",e=>{e.preventDefault(),e.stopPropagation(),this.select(),i.onContextMenu(this,e)}),this._exp.classList.add("fa","fa-fw"),s.appendChild(this._exp),"string"==typeof t.icon?(this._iconElement=document.createElement("span"),this._iconElement.className="icon "+t.icon,s.appendChild(this._iconElement)):"string"==typeof i?.icons?.default&&(this._iconElement=document.createElement("span"),this._iconElement.className="icon "+i.icons.default,s.appendChild(this._iconElement)),(e=document.createElement("span")).innerText=t.text,s.appendChild(e),i?.checkbox)&&this.createCheckbox()}get children(){return this._children}select(){return this.treeView.selection=[this],this.options?.onSelect?.(this),this}collapse(){this._expanded&&(this.options?.onCollapse?.(this),this.expanded=!1)}createCheckbox(){document.createElement("label").className="checkbox checkbox-inline";let t=document.createElement("input");t.type="checkbox",t.className="checkbox",t.addEventListener("change",e=>{e.stopPropagation(),this.checked=t.checked}),this.checkbox=t,this._a.insertBefore(t,this._exp.nextElementSibling)}setCheckAll(e){if(this.setChecked(e),this.children.length)for(var t of this.children)t.setCheckAll(e)}setText(e){this._a.querySelector("span:last-child").textContent=e}setChecked(e){"string"==typeof(this._checked=e)?(this.checkbox.indeterminate=!0,this.checkbox.checked=null):(this.checkbox.indeterminate=!1,this.checkbox.checked=e)}get checked(){return this._checked}set checked(e){this.setCheckAll(!0===e),this._parent?.updateCheckboxState()}updateCheckboxState(){let e=!1,t=!1,i=!1;for(var s of this.children)if(!0===s._checked){if(e=!0,t){i="indeterminate";break}}else if(s._checked){if("indeterminate"===s._checked){i="indeterminate";break}}else if(t=!0,e){i="indeterminate";break}i||t||(i=!0),this.setChecked(i),this._parent?.updateCheckboxState()}async expand(){!this._expanded&&this._canExpand&&(await this.options?.onExpand?.(this),this.children?.length)&&(this.expanded=!0)}get expanded(){return this._expanded}set expanded(e){(this._expanded=e)?(this.el.classList.add("expanded"),this._exp.classList.remove(t),this._exp.classList.add(i)):(this.el.classList.remove("expanded"),this._exp.classList.remove(i),this._exp.classList.add(t))}get index(){return(this._parent?this._parent.children:this.treeView.nodes).indexOf(this)}get previousSibling(){let e;return(e=this._parent?this._parent.children:this.treeView.nodes)[this.index-1]}get nextSibling(){let e;return(e=this._parent?this._parent.children:this.treeView.nodes)[this.index+1]}get previous(){let e=this.previousSibling;if(e){for(;e._expanded&&e.children?.length;)e=e.last;return e}return this._parent||e}get next(){if(this._expanded&&this.children.length)return this.first;var e=this.nextSibling;if(!e){let e=this._parent;for(;e;){var t=e.nextSibling;if(t)return t;e=e._parent}}return e}get first(){return this.children[0]}get last(){return this.children[this.children.length-1]}get selected(){return this._selected}set selected(e){(this._selected=e)?this._a.classList.add("selected"):this._a.classList.remove("selected"),this.treeView.selection.includes(this)||this.treeView.selection.push(this)}get parent(){return this._parent}set parent(e){this._parent&&this.remove(),(this._parent=e)&&e._addNode(this)}_addNode(e){this.children.push(e),this._ul.appendChild(e.el),this.update(),e.calcLevel()}addNode(e){return e.parent=this,e}addItem(e,t){return this.addNode(new s(this.treeView,e,t||this.options))}remove(){this._parent&&this._parent.removeNode(this),this.el.remove()}removeNode(e){this.children.splice(this.children.indexOf(e),1),this.update()}calcLevel(){this._parent?this.level=this._parent.level+1:this.level=0}update(){this._canExpand&&this.children.length?(this._exp.className="fa fa-fw",this._exp.classList.add(t)):(this.el.classList.remove("expanded"),this._exp.className="fa-regular fa-fw")}get level(){return this._level}set level(e){e!==this._level&&(this._level=e,this._a.style.paddingLeft=15*(e+1)+"px")}*all(){for(var e of this.children){for(var t of e.all())yield t;yield e}}}e.TreeNode=s,e.TreeView=class{constructor(e,t){this.options=t,this._selection=[],this._striped=!1,this.el=e,this.nodes=[],this.el.classList.add("tree-view"),this.el.tabIndex=0,this._ul=document.createElement("ul"),this.el.append(this._ul),this.el.addEventListener("keydown",async e=>{let t;if(!e.shiftKey)switch(e.key){case"ArrowDown":this.next();break;case"ArrowUp":this.previous();break;case"ArrowRight":(t=this.currentNode)&&t.children.length?(await t.expand(),t.next.select()):this.next();break;case"ArrowLeft":(t=this.currentNode)?t.expanded?t.collapse():t.parent?.select()||t.previousSibling?.select():this.firstNode.select();break;case" ":this.currentNode?.checkbox&&(this.currentNode.checked=!this.currentNode.checked)}}),Array.isArray(t?.data)&&this.addNodes(t)}get selection(){return this._selection}set selection(e){for(var t of this._selection)t.selected=!1;for(var i of this._selection=e)i.selected=!0;e=new CustomEvent("selectionchange",{detail:{selection:e}});this.el.dispatchEvent(e)}get firstNode(){if(this.nodes.length)return this.nodes[0]}get lastNode(){if(this.nodes.length)return this.nodes[this.nodes.length-1]}previous(){var e=this.currentNode;e?e.previous?.select():this.lastNode.select()}next(){var e=this.currentNode;e?e.next?.select():this.firstNode.select()}addNodes(e,t=null){let i=e.data;for(var s of i=Array.isArray(e.data)?i:[e.data]){var a=this.addItem(s,t,e.options);s.children&&this.addNodes({data:s.children,options:e.options},a)}}addItem(e,t,i){"string"==typeof e&&(e={text:e});e=new s(this,e,i||this.options?.options);return t?e.parent=t:(this.nodes.push(e),this._ul.appendChild(e.el)),e}*all(){for(var e of this.nodes)yield e,yield*e.all()}get currentNode(){if(this.selection.length)return this.selection[this.selection.length-1]}collapseAll(){for(var e of this.nodes)e.collapse()}expandAll(){for(var e of this.nodes)e.expand()}get striped(){return this._striped}set striped(e){(this._striped=e)?(this.el.classList.add("striped"),this._ul.style.backgroundSize="auto 50px"):this.el.classList.remove("striped")}update(){}clear(){this._ul.innerHTML="",this.nodes=[]}}}})(katrid=katrid||{}),(e=>{(e.ui||(e.ui={})).search=async function(e){return null==e.multiple&&(e.multiple=!0),(e=await Katrid.Forms.TableView.createSearchDialog(e)).ready(),e.showDialog()}})(katrid=katrid||{}),(e=>{{class t{constructor(e){}$render(e){}}(e=e.ui||(e.ui={})).BaseView=t;class i extends t{constructor(e){super(e)}}e.ModelView=i;class s extends t{}e.RecordCollectionView=s;class a extends s{createTableRow(){}}e.TableView=a;class r extends s{quickCreateItem(){}createCardItem(){}createCardGroup(){}}e.CardView=r}})(katrid=katrid||{});var kui=katrid.ui,katrid,katrid,katrid,katrid,katrid,katrid,Katrid,katrid,katrid,Katrid,katrid;(o=>{var e;{var t=o.ui||(o.ui={});function i(e){var t=document.createElement("dialog"),i=(t.className="dialog",e.title&&(t.innerHTML=`<header class="dialog-header">${e.title}</header>`),document.createElement("div")),i=(i.className="dialog-body",e.content&&(i.innerHTML=e.content),t.appendChild(i),document.createElement("footer"));if(i.className="dialog-footer",e.buttons){var s=i;for(let t of e.buttons)if("string"==typeof t){var a=document.createElement("button");switch(a.classList.add("btn"),a.classList.add("btn-secondary"),t){case"ok":a.classList.add("btn-primary"),a.textContent=o.i18n.gettext("OK");break;case"cancel":a.textContent=o.i18n.gettext("Cancel");break;case"yes":a.textContent=o.i18n.gettext("Yes");break;case"no":a.textContent=o.i18n.gettext("No");break;case"close":a.textContent=o.i18n.gettext("Close");break;default:a.textContent=o.i18n.gettext(t)}a.addEventListener("click",e=>{s.closest("dialog").close(t),s.dispatchEvent(new CustomEvent("dialog-button-click",{detail:{button:t}}))}),s.appendChild(a)}}return t.appendChild(i),t}function r(e,t,i){var s=document.createElement("div");s.classList.add("modal"),s.tabIndex=-1;let a=`
        <button type="button" name="btn-ok" class="btn btn-primary">OK</button>
        <button type="button" name="btn-cancel" class="btn btn-secondary" data-bs-dismiss="modal">${o.i18n.gettext("Cancel")}</button>
    `;if(i){a="";for(var r of i)"string"==typeof r&&(a+=(e=>{let t='<button type="button" class="btn btn-outline-secondary">';switch(e){case n.close:t+=o.i18n.gettext("Close");break;case n.cancel:t+=o.i18n.gettext("Cancel");break;case n.yes:t+=o.i18n.gettext("Yes");break;case n.no:t+=o.i18n.gettext("No");break;case n.ok:t+=o.i18n.gettext("OK");break;default:t+=o.i18n.gettext(e)}return t+="</button>"})(r))}return s.innerHTML=`<div class="modal-dialog modal-xl modal-fullscreen-md-down" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">${e}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      ${t||""}
      </div>
      <div class="modal-footer">
      ${a}
      </div>
    </div>
  </div>`,s}t.Alerts=class{static success(e){return o.ui.Toast.success({message:e})}static warning(e){return o.ui.Toast.warning({message:e})}static warn(e){return o.ui.Toast.warning({message:e})}static info(e){return o.ui.Toast.info({message:e})}static error(e){return o.ui.Toast.danger({message:e})}},t.createDialogElement=i,t.ExceptionDialog=class{static show(e,t,i){var s=document.createElement("div");s.classList.add("modal"),s.tabIndex=-1,s.setAttribute("role","dialog"),s.innerHTML=`<div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title text-danger"><i class="fa fa-fw fa-bug text-danger"></i> ${e}</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
      ${t||""}
      </div>
      <div class="modal-footer">
        <button type="button" name="btn-cancel" class="btn btn-outline-secondary" data-bs-dismiss="modal">${o.i18n.gettext("Close")}</button>
      </div>
    </div>
  </div>`}static showValidationError(e,t,i,s){let a="";for(var[r,n]of Object.entries(s)){a+="<li>"+`<h6>${i.fields[r].caption}</h6>`+"<ul>";for(let e of n)a+=`<li class="help-block">${e.message}</li>`;a+="</ul></li>"}return a}},t.createModal=r,t.createDialog=function(e,t,i){let s=r(e,t,i),a=new bootstrap.Modal(s);return s.addEventListener("hidden.bs.modal",e=>{s.remove(),a.dispose()}),a};let n;(e=n=t.DialogResult||(t.DialogResult={})).ok="ok",e.cancel="cancel",e.yes="yes",e.no="no",e.close="close",t.Dialog=class{constructor(e){this.dialog=i(e),this.dialogPromise=new Promise((e,t)=>{this.resolve=e,this.reject=t,this.dialog.addEventListener("close",e=>{this.resolve(this.dialog.returnValue)})})}async showModal(){return document.body.append(this.dialog),this.dialog.showModal(),this.dialogPromise}close(){this.dialog.close()}}}})(katrid=katrid||{}),(i=>{{var e=i.ui||(i.ui={});class t{static createElement(e){this._container||((t=document.createElement("div")).classList.add("toast-container","position-fixed","bottom-0","end-0","p-3"),document.body.append(t),this._container=t);var t=document.createElement("div");return t.classList.add("toast"),e.classList&&t.classList.add(...e.classList),t.innerHTML=`<div class="d-flex"><div class="toast-body">${e.message}</div></div>`,void 0!==e.canClose&&!e.canClose||t.querySelector(".d-flex").append(i.ui.html('<button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>')[0]),this._container.append(t),t}static show(e){let t=this.createElement(e);e=new bootstrap.Toast(t);return e.show(),t.addEventListener("hidden.bs.toast",()=>t.remove()),e}static danger(e){return e.classList=["text-bg-danger","toast-dark"],this.show(e)}static success(e){return e.classList=["text-bg-success","toast-dark"],this.show(e)}static info(e){return e.classList=["text-bg-info"],this.show(e)}static warning(e){return e.classList=["text-bg-warning"],this.show(e)}}e.Toast=t,e.showMessage=function(e){return t.show({message:e})}}})(katrid=katrid||{}),(s=>{{var a=s.ui||(s.ui={});let i;function t(e){let t;"string"==typeof e&&(t=s.i18n.gettext("Please wait...")),(i??=a.createDialogElement({message:t})).showModal()}function e(){i?.close()}a.showWaitDialog=t,a.closeWaitDialog=e,a.WaitDialog=class{static show(e){t(e)}static hide(){e()}}}})(katrid=katrid||{}),(e=>{{var t=e.ui||(e.ui={});t.TableCell=class{constructor(){this.touched=!1}},t.TableColumn=class{};class i extends e.OwnedCollection{notify(e,t){}}t.TableColumns=i;class s{constructor(e){this.create(),e&&e.appendChild(this.el)}create(){this.el=document.createElement("div"),this.el.className="cells-selection-box"}setBounds(e,t,i,s){this.el.style.left=e+"px",this.el.style.top=t+"px",this.el.style.width=i+"px",this.el.style.height=s+"px"}destroy(){this.el.remove()}}class o{constructor(e,t,i,s){this.startRow=e,this.startCol=t,this.endRow=i,this.endCol=s}static fromCells(e){let t=null,i=null,s=null,a=null;for(var r of e)(null===t||r.row<t)&&(t=r.row),(null===s||r.row>s)&&(s=r.row),(null===i||r.col<i)&&(i=r.col),(null===a||r.col>a)&&(a=r.col);var n=new o(t,i,s,a);return n.cells=e,n}getRect(){let e=null,t=null,i=null,s=null;for(var a of this.cells)a.el&&(a=a.el.getBoundingClientRect(),(null===e||a.left<e)&&(e=a.left),(null===t||a.top<t)&&(t=a.top),(null===i||a.right>i)&&(i=a.right),null===s||a.bottom>s)&&(s=a.bottom);return new DOMRect(e,t,i-e,s-t)}cellInRange(e,t){return e>=this.startRow&&e<=this.endRow&&t>=this.startCol&&t<=this.endCol}rowInRange(e){return e>=this.startRow&&e<=this.endRow}equals(e){return this.startRow===e.startRow&&this.startCol===e.startCol&&this.endRow===e.endRow&&this.endCol===e.endCol}}t.CellsRange=o;class a{constructor(){this.rowHeight=20,this.colWidth=64,this.minRows=0,this.maxRows=-1,this.loadedRows=0,this.incrementalLoad=!0,this._striped=!1,this._visibleRows=[],this._cells=[],this.columns=new i(this),this._rowTag="div",this._cellTag="div"}dump(){}_create(){this.el=document.createElement("div"),this.el.className="table-grid",this.table=document.createElement("div"),this.table.className="grid"}create(){this._create(),this.createSizeLayer(),this.createEvents(),this.createHeader(),this.calcSize(),this.createRowHeader(),this.incrementalLoad&&this.el.addEventListener("scroll",e=>{this._scroll()})}appendTo(e){this.create(),e.appendChild(this.el),setTimeout(()=>this.render())}render(){this.dataRows?this._scroll():this.renderEmptyData()}renderEmptyData(){}createEvents(){this.el.tabIndex=0,this.el.addEventListener("keydown",e=>this.keyDown(e))}keyDown(e){if(e.shiftKey)switch(e.key){case"ArrowUp":this.moveBy(0,-1,!0),e.stopPropagation(),e.preventDefault();break;case"ArrowDown":this.moveBy(0,1,!0),e.stopPropagation(),e.preventDefault();break;case"ArrowLeft":this.moveBy(-1,0,!0),e.stopPropagation(),e.preventDefault();break;case"ArrowRight":this.moveBy(1,0,!0),e.stopPropagation(),e.preventDefault()}else switch(e.key){case"ArrowUp":this.moveBy(0,-1),e.stopPropagation(),e.preventDefault();break;case"ArrowDown":this.moveBy(0,1),e.stopPropagation(),e.preventDefault();break;case"ArrowLeft":this.moveBy(-1,0),e.stopPropagation(),e.preventDefault();break;case"ArrowRight":this.moveBy(1,0),e.stopPropagation(),e.preventDefault()}}moveBy(e,t,i=!1){var s=i&&this.selectedCells?.at(-1)||this.selectedCell;(s=this.getCell(s.row+t,s.col+e))&&(i?this.addToSelection(s):this.selectCell(s))}goto(e,t){e=this.getCell(e,t);e&&this.selectCell(e)}createSizeLayer(){this.sizeLayer=document.createElement("div"),this.sizeLayer.className="grid-size-layer",this.sizeLayer.appendChild(this.table),this.el.appendChild(this.sizeLayer)}calcSize(){this.sizeLayer.style.width=this.cols*this.colWidth+"px",this.sizeLayer.style.height=this.rows*this.rowHeight+"px"}createRowHeader(){this.rowHeaderElement=document.createElement("div"),this.rowHeaderElement.className="row-header"}createHeader(){this.headerElement=document.createElement("div"),this.headerElement.className="header"}cellMouseDown(e,t){this.el.focus(),this.selectCell(e)}setSelectedCells(e){if(this.selectedCells)for(var t of this.selectedCells)t.el?.classList.remove("selected");if(e)for(var i of e)this.selectCell(i)}get selectedCell(){return this._selectedCell||(this._selectedCell=this.getCell(0,0)),this._selectedCell}set selectedCell(e){this.selectCell(e)}addToSelection(e){this.selectedCells??=[],this.selectedCells.push(e),this._updateSelectionBox()}_updateSelectionBox(){var e;this._selBox??=new s(this.el),1<this.selectedCells.length?(e=o.fromCells(this.selectedCells).getRect(),this._selBox.setBounds(e.x,e.y,e.width,e.height)):(this._selBox.destroy(),this._selBox=null)}selectCell(e){this.selectedCells=[],this._updateSelectionBox(),this._selectedCell?.el?.classList.remove("selected"),(this._selectedCell=e)?.el?.classList.add("selected"),e&&this.scrollToCell(e),this.addToSelection(e),this._updateSelectionBox()}scrollToCell(e){e=e.el.getBoundingClientRect();this.visibleRect.top,e.top,this.visibleRect.bottom}getCell(e,t){return this.getRowCells(e)[t]}getRowCells(e){return this.incrementalLoad&&e>=this.loadedRows&&this.rows>this.loadedRows&&this.loadMore(e-this.loadedRows),this._cells[e]}loadMore(t){this.cols??=this.columns.items.length;for(let e=0;e<t;e++){let t=this.dataRows?.[this.loadedRows];!t&&this.rows>this.loadedRows&&((t=[])[this.cols-1]=void 0);var i=[];for(let e=0;e<this.cols;e++){var s=t[e];i.push({row:this.loadedRows,col:e,content:s||"",touched:!1})}i.rowIndex=this.loadedRows,this._cells.push(i),this.loadedRows++}}_renderRows(e){var t,i=[];for(t of e)i.push(this.renderRow(t));return i}renderHeader(){}renderFooter(){}scrollCol(e){}scrollRow(e){}destroyOffscreenCells(e){var t,i=[];for(t of this._visibleRows)if(e.rowInRange(t.rowIndex)){i.push(t);for(var s of t)e.cellInRange(s.row,s.col)||s.el?.remove()}else t.rowElement?.remove(),t.rowElement=null;return this._visibleRows=i}renderRowHeader(e){if(this.rowHeader)for(var t of this.rowHeader){var i=document.createElement("th");e.appendChild(i)}}renderRow(i){var s=document.createElement(this._rowTag);s.className="grid-row",s.style.height=this.rowHeight+"px",this.renderRowHeader(s);let a=0;var e=this._visibleRange?.startCol||0,r=Math.min(this._visibleRange?.endCol,this.cols);for(let t=e;t<r;t++){let e=i[t];(e=e||(i[a]={content:""+t})).el=s.appendChild(this.renderCell(e)),a++}return i.rowElement=s}renderCell(t){let i=document.createElement(this._cellTag);return i.style.width=this.colWidth+"px",i.className="cell",i.textContent=t?.content||"",i.addEventListener("pointerdown",e=>this.cellMouseDown(t||{el:i},e)),i}addColumn(){}addRow(e){this.dataRows.push(e)}redrawGrid(){var e,t=this._getVisibleRange();t.startRow=Math.max(--t.startRow,0),this.rows&&(t.endRow=Math.min(t.endRow+=2,this.rows)),this._visibleRange?.equals(t)||(e=this.destroyOffscreenCells(t),this._visibleRange=t,this.loadedRows<t.endRow&&this.loadMore(t.endRow-this.loadedRows),e.length?e[0].rowIndex>t.startRow?this.insertRows(this._cells.slice(t.startRow,e[0].rowIndex)):e.at(-1).rowIndex<t.endRow&&this.appendRows(this._cells.slice(e.at(-1).rowIndex+1,t.endRow)):this.appendRows(this._cells.slice(t.startRow,t.endRow)))}insertRows(e){var t,i=this.table.firstChild;for(t of this._renderRows(e))this.table.insertBefore(t,i);this._visibleRows.splice(0,0,...e)}appendRows(e){for(var t of this._renderRows(e))this.table.appendChild(t);this._visibleRows.push(...e)}_scroll(){this.visibleRect=new DOMRect(this.el.scrollLeft,this.el.scrollTop,this.el.clientWidth,this.el.clientHeight),this.redrawGrid(),this.incrementalLoad&&(this.sizeLayer.style.paddingTop=this._visibleRange.startRow*this.rowHeight+"px")}_getVisibleRange(){return new o(Math.floor(this.visibleRect.y/this.rowHeight),Math.min(Math.floor(this.visibleRect.x/this.colWidth),this.cols),Math.floor((this.visibleRect.y+this.visibleRect.height)/this.rowHeight),Math.floor((this.visibleRect.x+this.visibleRect.width)/this.colWidth))}addDataRow(e){this.dataRows??=[],this.dataRows.push(e),this.rows=this.dataRows.length}}t.BaseGrid=a;class r extends a{}t.Grid=r}})(katrid=katrid||{}),(e=>{{e=e.ui||(e.ui={});class t extends e.Grid{constructor(e){super(),this.incrementalLoad=!0,this.rows=e?.rows||100,this.cols=e?.cols||20}create(){super.create(),this.table.classList.add("spreadsheet")}render(){this.loadMore(this.rows)}}e.Spreadsheet=t}})(katrid=katrid||{}),(e=>{{var t=e.ui||(e.ui={});t.DataColumn=class{constructor(e){this.collection=e}dump(){return{dataIndex:this.dataIndex,caption:this.caption}}load(e){this.dataIndex=e.dataIndex,this.caption=e.caption}};class i extends e.OwnedCollection{notify(e,t){}}t.DataColumns=i;class s extends t.BaseGrid{constructor(){super(),this._rowTag="tr",this._cellTag="td",this.incrementalLoad=!1}calcSize(){}createSizeLayer(){this.sizeLayer=document.createElement("div"),this.sizeLayer.className="grid-size-layer",this.sizeLayer.appendChild(this.table),this.el.appendChild(this.sizeLayer)}_create(){this.el=document.createElement("div"),this.el.classList.add("table-grid"),this.table=document.createElement("table"),this.table.className="table table-sm",this._tbody=this.table.createTBody()}createHeader(){if(this.headerElement=document.createElement("thead"),this.table.appendChild(this.headerElement),this.columns){var e,t=document.createElement("tr");this.headerElement.appendChild(t);for(e of this.columns.items){var i=document.createElement("th");i.innerText=e.caption||e.dataIndex.toString(),t.appendChild(i)}}}redrawGrid(){this._visibleRange=this._getVisibleRange(),this.loadMore(this.rows),this._tbody.append(...this._renderRows(this._cells))}}t.BaseTable=s;class a extends s{}t.Table=a}})(katrid=katrid||{}),(t=>{function a(e){return"number"==typeof e}function i(e,t){let i=0;if(e)for(var s of e){let e=s[t];a(e)||(e=Number(e)),isNaN(e)&&(e=0),i+=e}return i}t.isString=function(e){return"string"==typeof e},t.isNumber=a,t.isObject=function(e){return"object"==typeof e},t.hash=function(e){return e.$hashId||(e.$hashId=++t.$hashId),e.$hashId},t.sum=i,t.avg=function(e,t){if(e&&e.length)return i(e,t)/e.length},t.guid=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(e){var t=16*Math.random()|0;return("x"===e?t:3&t|8).toString(16)})}})(Katrid=Katrid||{}),(e=>{{class a{constructor(e,t,i,s){this.key=e,this.data=t,this.childCols=i,this.childRows=s}expand(e,t){var i=this,s=t,a=e;s&&(i.childRows=r(Map.groupBy(i.data,e=>e[s]))),a&&(i.childCols=r(Map.groupBy(i.data,e=>e[a])))}}function r(e){var t,i,s=[];for([t,i]of e)s.push(new a(t,i,null,null));return s}(e.utils||(e.utils={})).pivot=function(e,t){return r(Map.groupBy(e,e=>e[t]))}}})(katrid=katrid||{}),(katrid||(katrid={})).printHtml=function(e){let t=document.createElement("iframe");t.style.display="none",document.body.appendChild(t);var i=t.contentDocument;i.open(),i.write(e),i.close(),t.onload=()=>{console.debug("page loaded"),t.contentWindow.print(),setTimeout(()=>{t.remove()},1e3)}},(e=>{e.toCamelCase=function(e){return e=(e=(e=e.replace(/([^a-zA-Z0-9_\- ])|^[_0-9]+/g,"").trim().toLowerCase()).replace(/([ -]+)([a-zA-Z0-9])/g,function(e,t,i){return i.toUpperCase()})).replace(/([0-9]+)([a-zA-Z])/g,function(e,t,i){return t+i.toUpperCase()})},e.dict=function(e){if(e){var t,i,s={};for([t,i]of e)s[t]=i;return s}}})(Katrid=Katrid||{}),(e=>{e.sleep=function(t){return new Promise(e=>setTimeout(()=>e(),t))},e.invoke=function(e){let t=window;for(var i of e.split("."))t=t[i];if(t)return t}})(katrid=katrid||{});
//# sourceMappingURL=katrid.min.js.map