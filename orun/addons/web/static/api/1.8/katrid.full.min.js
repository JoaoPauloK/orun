katrid={core:{}},katrid.settings={additionalModules:[],server:"",servicesProtocol:"undefined"!=typeof io&&null!==io&&io.connect?"io":"http",services:{choicesPageLimit:10}},katrid.core.plugins={callbacks:[],init(e){for(let t of this.callbacks)t(e)},register(e){this.callbacks.push(e)}},katrid.isObject=_.isObject,katrid.isString=_.isString,katrid.isNumber=_.isNumber,katrid.isFunction=_.isFunction,katrid.isArray=_.isArray,katrid.isElement=_.isElement,katrid.isBoolean=_.isBoolean,katrid.isDate=_.isDate,function(){$.ajaxSetup({beforeSend:function(e,t){var i;i=t.type,/^(GET|HEAD|OPTIONS|TRACE)$/.test(i)||this.crossDomain||e.setRequestHeader("X-CSRFToken",katrid.auth.csrfToken)}}),katrid.auth={setCsrfToken(e){katrid.services.defaultHeaders["X-CSRFToken"]=katrid.auth.csrfToken=e}}}(),katrid.$hashId=0,_.mixin({hash:e=>(e.$hashId||(e.$hashId=++katrid.$hashId),e.$hashId)}),_.mixin({sum(e,t){let i=0;if(e)for(let s of e){let e=s[t];_.isNumber(e)||(e=Number(e)),_.isNaN(e)&&(e=0),i+=e}return i},avg(e,t){if(e&&e.length)return _.sum(e,t)/e.length}}),function(){const e=this;katrid.i18n={languageCode:"pt-BR",formats:{},catalog:{},initialize:(t,i,s)=>(katrid.i18n.plural=t,katrid.i18n.catalog=i,katrid.i18n.formats=s,katrid.i18n.pluralidx=t?function(e){return t instanceof boolean?t?1:0:t}:function(e){return 1===count?0:1},e.pluralidx=katrid.i18n.pluralidx,e.gettext=katrid.i18n.gettext,e.ngettext=katrid.i18n.ngettext,e.gettext_noop=katrid.i18n.gettext_noop,e.pgettext=katrid.i18n.pgettext,e.npgettext=katrid.i18n.npgettext,e.interpolate=katrid.i18n.interpolate,e.get_format=katrid.i18n.get_format,_.mixin({gettext:katrid.i18n.gettext,sprintf:sprintf}),katrid.i18n.initialized=!0),merge:e=>Array.from(e).map(t=>katrid.i18n.catalog[t]=e[t]),gettext(e){const t=katrid.i18n.catalog[e];return null!=t?t:e},gettext_noop:e=>e,ngettext(e,t,i){const s=katrid.i18n.catalog[e];return null!=s?s[katrid.i18n.pluralidx(i)]:1===i?e:t},pgettext(e){let t=katrid.i18n.gettext(e);return-1!==t.indexOf("")&&(t=e),t},npgettext(e,t,i,s){let a=katrid.i18n.ngettext(e+""+t,e+""+i,s);return-1!==a.indexOf("")&&(a=katrid.i18n.ngettext(t,i,s)),a},interpolate:(e,t,i)=>(i?e.replace(/%\(\w+\)s/g,e=>String(t[e.slice(2,-2)])):e.replace(/%s/g,e=>String(t.shift())),{get_format(e){const t=katrid.i18n.formats[e];return null!=t?t:e}})}}(),function(){class e{constructor(e){this.app=e,$(".menu-item-action").on("click",e=>{e.preventDefault();let t=$(e.target);this.actionClick(t.attr("href")),t.parent(".dropdown-menu").hide()}),$("li.nav-item.dropdown").on("mouseenter",function(){$(this).children(".dropdown-menu").removeAttr("style")})}actionClick(e){this.app.loadPage(e,!0)}}class t{constructor(t){katrid.app=this,"csrfToken"in t&&katrid.auth.setCsrfToken(t.csrfToken),this.menu=new e(this),this.actionManager=new katrid.actions.ActionManager,this.title=t.title,this.plugins=["ui.katrid","ngSanitize"];let i=this;$(katrid).on("app.ready",()=>{let e,t,s=$("#loading-msg").hide(),a=$("#overlay").hide();$(katrid).on("fetch.before",()=>{e=setTimeout(()=>s.show(),400),t=setTimeout(()=>{s.hide(),a.show()},2500)}).on("fetch.always",()=>{clearTimeout(e),clearTimeout(t),s.hide(),a.hide()}),$(document).ajaxStart(function(){e=setTimeout(()=>s.show(),400),t=setTimeout(()=>{s.hide(),a.show()},2500)}).ajaxStop(function(){clearTimeout(e),clearTimeout(t),s.hide(),a.hide()}),$("a.module-selector").on("click",function(e){e.preventDefault();let t=$(this);t.data("menu-id"),katrid.app.actionManager.clear(),i.loadPage(t.attr("href"))}).each(function(e,t){t=$(t);let i={};i.menu_id=t.data("menu-id"),i.action=$(`.menu-item-action[data-parent-id="${i.menu_id}"]:first`).data("action-id"),t.attr("href","#/app/?"+$.param(i))}),""===location.hash?$("a.module-selector:first").trigger("click"):this.loadPage(location.hash)}),window.addEventListener("hashchange",e=>{this.loadPage(location.hash)}),fetch(t.templates||"/web/client/templates/").then(e=>e.text()).then(e=>{e&&(e="<templates>"+e+"</templates>"),this.ngApp=angular.module("katridApp",this.plugins).run(["$templateCache",t=>{this.$templateCache=t,katrid.ui.templates=new katrid.ui.Templates(this,e)}]).config(["$locationProvider","$interpolateProvider",function(e,t){e.hashPrefix(""),t.startSymbol("${"),t.endSymbol("}")}]),this.ngApp.controller("AppController",["$scope","$compile","$location",function(e,t,i){katrid.core.$compile=t,katrid.app.$scope=e,katrid.app.$location=i,e._=_,katrid.app.$element=$("#katrid-action-view"),$(katrid).trigger("app.ready",[katrid.app])}]),this.ngApp.controller("ActionController",["$scope",function(e){}]),katrid.core.plugins.init(this),$(katrid).trigger("loaded",[katrid.app])})}static bootstrap(e){let i=new t(e);return $(katrid).on("loaded",function(){angular.element(function(){angular.bootstrap(document,["katridApp"])})}),i}async loadPage(e,t){let i=$.Event("hashchange");if($(this).trigger(i,[e,t]),!i.isPropagationStopped()){this.$scope.currentMenu="",e.startsWith("#/app/?")&&(e=e.split("#/app/?")[1]),e=new URLSearchParams(e);let i={};for(let[t,s]of e.entries())i[t]=s;i.menu_id&&$("a.module-selector"),(!this.$scope.$parent.currentMenu||i.menu_id&&this.$scope.$parent.currentMenu.id!=i.menu_id)&&(this.$scope.$parent.currentMenu={id:i.menu_id,name:$(`.module-selector[data-menu-id="${i.menu_id}"]`).text()}),("action"in i||"model"in i)&&await this.actionManager.onHashChange(i,t)}}getTemplate(e,t){let i=this.$templateCache.get(e);if(e.endsWith("jinja2")){let i={_:_};return t&&Object.assign(i,t),katrid.ui.Templates.env.render(e,i)}return e.endsWith("pug")&&(i=i(t)),i}static get context(){return this.actionManager.context}}katrid.core.Application=class{},katrid.core.WebApplication=t}(),angular.module("basicApp",[]).controller("LoginController",["$scope",function(e){e.login=(async(t,i,s,a)=>{console.log("login controller"),e.loading=!0;try{let r;s&&(r=await katrid.services.post("/web/db/",{db:a})),(s&&r.redirect||!s)&&((r=await katrid.services.post("/web/login/",{username:t,password:i})).error?(e.messages=[{type:"danger",message:r.message}],e.$apply()):(e.messages=[{type:"success",message:r.message}],e.$apply(),setTimeout(()=>window.location.href=r.redirect)))}finally{e.loading=!1,e.$apply()}})}]),function(){let e,t={Accept:"application/json","Content-Type":"application/json"};katrid.socketio&&(e=new class{constructor(){this.requestId=0,this.requests={}}request(){const t=++e.requestId,i=new $.Deferred;return this.requests[t]=i,i.requestId=t,i}},katrid.socketio.on("connect",()=>console.log("I'm connected!")),katrid.socketio.on("api",function(t){return _.isString(t)&&(t=JSON.parse(t)),e.requests[t["req-id"]].resolve(t)}));class i{static get url(){return"/api/rpc/"}constructor(e,t){this.name=e}static $fetch(e,t,i){return i&&(e=new URL(e),Object.entries(i).map((t,i)=>e.searchParams.append(t,i))),$(katrid).trigger("fetch.before"),fetch(e,t).then(e=>($(katrid).trigger("fetch.done"),e))}static $post(e,i,s){return this.$fetch(e,{method:"POST",credentials:"same-origin",body:JSON.stringify(i),headers:t},s).then(e=>e.json())}delete(e,t,i){}get(e,t){if("ws"===katrid.Settings.servicesProtocol)return katrid.socketio.emit("api",{channel:"rpc",service:this.name,method:e,data:data,args:t});{const i=this.name?this.name+"/":"",s=katrid.Settings.server+this.constructor.url+i+e+"/";return $.get(s,t)}}post(i,s,a){let r;if(katrid.app&&(r=katrid.app.context),s||(s={}),r&&(s.context=r),s={jsonrpc:"2.0",method:i,params:s,id:Math.floor(1e3*Math.random()*1e3*1e3)},"io"===katrid.settings.servicesProtocol){const t=e.request();return katrid.socketio.emit("api",{"req-id":t.requestId,"req-method":"POST",service:this.name,method:i,data:s,args:a}),t}{const e=this.name?this.name+"/":"";let r=katrid.settings.server+this.constructor.url+e+i+"/";return a&&(r+=`?${$.param(a)}`),new Promise((e,i)=>{console.log("default headers",t),fetch(r,{method:"POST",body:JSON.stringify(s),headers:t}).then(e=>e.json()).then(t=>{if(t.error)i(t.error);else{if(t.result){let e;e=t.result.messages?t.result.messages:[],t.result.message?e.push(t.result.message):t.result.warn?e.push({type:"warn",message:t.result.warn}):t.result.info?e.push({type:"info",message:t.result.info}):t.result.error&&e.push({type:"error",message:t.result.error}),e.forEach(function(e){_.isString(e)?katrid.ui.dialogs.Alerts.success(e):"warn"===e.type?katrid.ui.dialogs.Alerts.warn(e.message):"info"===e.type?katrid.ui.dialogs.Alerts.info(e.message):"error"!==e.type&&"danger"!==e.type||katrid.ui.dialogs.Alerts.error(e.message)})}e(t.result)}}).catch(e=>i(e))})}}}class s extends i{searchName(e){return _.isString(e)&&(e={args:e}),this.post("search_name",e)}createName(e){let t={name:e};return this.post("create_name",{kwargs:t})}search(e,t){return this.post("search",{kwargs:e},t)}destroy(e){return _.isArray(e)||(e=[e]),this.post("destroy",{kwargs:{ids:e}})}getById(e){return this.post("get",{args:[e]})}getDefaults(e){return this.post("get_defaults",{kwargs:e})}copy(e){return this.post("copy",{args:[e]})}static _prepareFields(e){return e&&(e.fields=katrid.data.fields.Field.fromArray(e.fields),e.fieldList=Object.values(e.fields),e.views&&(Object.values(e.views).map(e=>e.fields=katrid.data.fields.Field.fromArray(e.fields)),Object.keys(e.views).map(t=>e.views[t]=new katrid.ui.ViewInfo(e.views[t])))),e}getViewInfo(e){return this.post("get_view_info",{kwargs:e}).then(this.constructor._prepareFields)}async loadViews(e){return this.post("load_views",{kwargs:e}).then(this.constructor._prepareFields)}getFieldsInfo(e){return this.post("get_fields_info",{kwargs:e}).then(this.constructor._prepareFields)}getFieldChoices(e,t,i){return this.post("get_field_choices",{args:[e,t],kwargs:i})}doViewAction(e){return this.post("do_view_action",{kwargs:e})}write(e,t){return new Promise((i,s)=>{this.post("write",{kwargs:{data:e}},t).then(e=>{katrid.ui.dialogs.Alerts.success(katrid.i18n.gettext("Record saved successfully.")),i(e)}).catch(e=>{500===e.status&&e.responseText?alert(e.responseText):katrid.ui.dialogs.Alerts.error(katrid.i18n.gettext("Error saving record changes")),s(e)})})}groupBy(e,t){return this.post("group_by",{kwargs:{grouping:e,where:t}})}autoReport(){return this.post("auto_report",{kwargs:{}})}rpc(e,t,i){return new Promise((s,a)=>{this.post(e,{args:t,kwargs:i}).then(e=>{e&&e.open&&window.open(e.open),s(e)}).catch(e=>{if(e.messages&&_.isObject(e.messages))for(let t of Object.values(e.messages))katrid.ui.dialogs.Alerts.error(t.join("\n"));else katrid.ui.dialogs.Alerts.error(e.message);a(e)})})}}class a extends s{constructor(){super("ir.query")}static read(e){let t,i,s;return _.isObject(e)?(t=e.details,s=e.params,i=e.id):i=e,(new a).post("read",{args:[i],kwargs:{with_desc:t,params:s,as_dict:e.as_dict}})}static all(){return(new a).rpc("all")}static executeSql(e){return(new a).post("execute_sql",{args:[e]})}}class r extends i{static get url(){return"/web/data/"}reorder(e,t,i="sequence",s=0){return this.post("reorder",{args:[e,t,i,s]})}}this.katrid.services={Data:r,View:class extends s{constructor(){super("ui.view")}fromModel(e){return this.post("from_model",null,{model:e})}},data:new r(""),Attachments:class{static destroy(e){new s("ir.attachment").destroy(e)}static upload(e,t=null){let i=new FormData;null===t&&(t=angular.element(e).scope()),i.append("model",t.model.name),i.append("id",t.recordId);for(let t of e.files)i.append("attachment",t,t.name);return $.ajax({url:"/web/content/upload/",type:"POST",data:i,processData:!1,contentType:!1}).done(e=>{if(console.log("attachments",t.attachments,t),t.attachments||(t.attachments=[]),e)for(let i of e)t.attachments.push(i);t.$apply()})}},Service:i,Model:s,Query:a,Auth:class extends i{static login(e,t){return this.$post("/web/login/",{username:e,password:t})}},Upload:class{static sendFile(e,t){let i=new FormData;i.append("files",t.files[0]);let s=angular.element(t).scope(),a=`/web/file/upload/${s.model.name}/${e}/`;s.record&&s.record.id&&i.append("id",s.record.id);let r=s.action.dataSource;if(!r){r=s.$parent.dataSource;let e=s.$parent;for(;e&&!(r=e.dataSource);)e=s.$parent}$.ajax({url:a,data:i,processData:!1,contentType:!1,type:"POST",success:e=>{r.refresh(),katrid.ui.dialogs.Alerts.success("Operação realizada com sucesso.")}})}static uploadTo(e,t){let i=new FormData;return i.append("files",t.files[0]),$.ajax({url:e,data:i,processData:!1,contentType:!1,type:"POST",success:e=>{katrid.ui.dialogs.Alerts.success("Arquivo enviado com sucesso!")}})}},Actions:class extends s{static load(e){return new s("ir.action").post("load",{args:[e]})}},defaultHeaders:t,post:(e,i)=>fetch(e,{method:"POST",body:JSON.stringify(i),headers:t}).then(e=>e.json())}}(),katrid.data={},function(){class e{constructor(e,t,i){this.raw=e,this.data={},this.dataSource=t,this.pending=null,this.modified=!1,this.children=[],this.state=i,this.submitted=!1,e.$record=this}get scope(){return this.dataSource.scope}get pk(){return this.raw.id}$delete(){this.state=t.destroyed,this.pk?this.setModified():this.parent.children.indexOf(this)>-1&&this.parent.children.splice(this.parent.children.indexOf(this),1)}_prepareRecord(e,t){console.log(e.constructor.name)}setModified(e){this.modified||this.state===t.destroyed||(this.pk?this.state=t.modified:this.state=t.created),e&&this.dataSource.$setDirty(e),this.dataSource._pendingChanges=!0,this.modified=!0,this.parent&&this.scope.fieldName&&(this.parent.setModified(this.scope.fieldName),this.parent.addChild(this))}get parent(){return this.dataSource.parent&&this.dataSource.parent.record.$record}addChild(e){this.setModified(e.scope.fieldName),-1===this.children.indexOf(e)&&this.children.push(e)}compare(e,t){return _.isArray(e)&&_.isArray(t)?e.join(",")!==t.join(","):e!=t}set(e,t){let i=this.dataSource.fieldByName(e);if(i){let s=this.raw[e];if(t=i.toJSON(t),this.compare(s,t)&&(this.setModified(e),this.data[e]=t,this.modified=!0,i.onChange)){let i=this.$encode(this.raw);if(i[e]=t,this.dataSource.parent&&this.dataSource.fieldName){i[this.dataSource.parent.fields[this.dataSource.fieldName]._info.field]=this.$encode(this.dataSource.parent.record)}this.dataSource.dispatchEvent("field_change_event",[e,i])}}return!0}$encode(e){if(_.isArray(e))return e.map(e=>this.$encode(e));if(_.isObject(e)){let t={};for(let[i,s]of Object.entries(e))i.startsWith("$")||(t[i]=this.$encode(s));return t}return e}$new(){return e(this.raw)}toObject(){let e=jQuery.extend({},this.data);this.pk&&(e.id=this.pk);for(let i of this.children)i.scope.fieldName in e||(e[i.scope.fieldName]=[]),i.state===t.created?e[i.scope.fieldName].push({action:"CREATE",values:i.toObject()}):i.state===t.modified?e[i.scope.fieldName].push({action:"UPDATE",values:i.toObject()}):i.state===t.destroyed&&e[i.scope.fieldName].push({action:"DESTROY",id:i.pk});return e}}class t{static initClass(){this.destroyed="destroyed",this.created="created",this.modified="modified"}}t.initClass(),katrid.data.RecordState=t,katrid.data.createRecord=function(t,i){return new e(t,i),new Proxy(t,{set(e,s,a,r){if(!s.startsWith("$$")){let e=i.scope,r=i.fieldByName(s);s.startsWith("$")||!e||!r||r instanceof katrid.data.fields.OneToManyField||t.$record.set(s,a)}return Reflect.set(e,s,a,r)}})},katrid.data.SubRecords=class{constructor(e){this.recs=e}append(e){-1===this.recs.indexOf(e)&&this.recs.push(e)}}}(),function(){class e{static initClass(){this.inserting="inserting",this.browsing="browsing",this.editing="editing",this.loading="loading",this.inactive="inactive"}}e.initClass(),DEFAULT_REQUEST_INTERVAL=300;katrid.data.DataSource=class{constructor(e,t){this.groups=[],this.readonly=!1,this.$modifiedRecords=[],this.scope=e,this.action=t,this._recordIndex=0,this.recordCount=null,this.loading=!1,this.loadingRecord=!1,this._masterSource=null,this._pageIndex=0,this.pageLimit=100,this.offset=0,this.offsetLimit=0,this.requestInterval=DEFAULT_REQUEST_INTERVAL,this.pendingRequest=null,this.fieldName=null,this.children=[],this.modifiedData=null,this.uploading=0,this._state=null,this.fieldWatchers=[],this._pendingChanges=!1,this.recordId=null,e.$fieldLog={}}get pageIndex(){return this._pageIndex}set pageIndex(e){this._pageIndex=e,console.log("goto page",e),this.search(this._params,e,this._fields,DEFAULT_REQUEST_INTERVAL)}get fields(){return this.scope.view.fields}get loadingAction(){return this._loadingAction}set loadingAction(e){this.requestInterval=e?0:DEFAULT_REQUEST_INTERVAL,this._loadingAction=e}async cancel(){this.changing&&(this._recordIndex=null,this._pendingChanges=!1,this.state===e.editing?await this.refresh():this.action&&this.action.switchView("list"),this.state=e.browsing,this.scope.$emit("afterCancel",this))}async saveAndClose(){let e=await this.save(!1);return this.scope.$emit("saveAndClose",this.scope,e),this.action.$element.closest(".modal").modal("hide")}async copy(e){let t=await this.model.copy(e);return this.record={},await this.insert(),this.setValues(t),t}findById(e){for(let t of this.scope.records)if(t.id===e)return t;return null}hasKey(e){return null!==this.findById(e)}refresh(e){let t;return(t=e?this.get(e[0]):this.scope.record&&this.scope.record.id?this.get(this.scope.record.id):this.search(this._params,this._page)).then(()=>{for(let e in this.children)e.invalidate&&(e.invalidate(this.recordId),e.scope.$apply())}),t}_validateForm(e,t,i){let s;for(let a in t.$error)if("required"===a)for(let r of Array.from(t.$error[a]))if(r.$name.startsWith("grid-row-form"))s=this._validateForm(e.find("#"+r.$name),r,i);else{(s=e.find(`.form-field[name="${r.$name}"]`)).addClass("ng-touched");const t=angular.element(e).scope().view.fields[r.$name];i.push(`<span>${t.caption}</span><ul><li>${katrid.i18n.gettext("This field cannot be empty.")}</li></ul>`)}else console.log(t.$error[a]);return s}validate(e=!0){if(this.scope.form.$invalid){let t,i=[],s=`<span>${katrid.i18n.gettext("The following fields are invalid:")}</span><hr>`;const a=this.scope.formElement;if(t=this._validateForm(a,this.scope.form,i),katrid.ui.ngKatrid.setFocus(t),s+=i.join(""),katrid.ui.dialogs.Alerts.error(s),e)throw Error("Error validating form: "+s);return!1}return!0}indexOf(e){if(this.scope.records)return this.scope.records.indexOf(this.findById(e.id))}search(e,t,i,s){let a;return this.masterSource,this._params=e,this._page=t,this._fields=i,this._clearTimeout(),this.pendingRequest=!0,this.loading=!0,t=t||1,this._pageIndex=t,this.action&&(a=this.action.info.domain),a&&(a=JSON.parse(a)),_.isObject(i)&&(i=Object.keys(i)),e={count:!0,page:t,where:e[0],fields:i,domain:a,limit:this.pageLimit},new Promise((t,i)=>{let s=()=>{this.model.search(e).catch(e=>i(e)).then(e=>(this.pageIndex>1?this.offset=(this.pageIndex-1)*this.pageLimit+1:this.offset=1,this.scope.$apply(()=>{null!=e.count&&(this.recordCount=e.count);let t=e.data;return this.readonly?this.scope.records=t:this.scope.records=t.map(e=>katrid.data.createRecord(e,this)),this.scope.groups=this.scope.records,1===this.pageIndex?this.offsetLimit=this.scope.records.length:this.offsetLimit=this.offset+this.scope.records.length-1}),t(e))).finally(()=>{this.pendingRequest=!1,this.scope.$apply(()=>{this.loading=!1})})};this.requestInterval>0?this.pendingRequest=setTimeout(s,this.requestInterval):s()})}async groupBy(e,t){if(this._params=[],console.log("group by",e,t),!e||!e.length)return this.groups=[],this.action.groups=null,this.scope.groups=null,void this.search(t);this.scope.action.groups=e,this.scope.groupings=[],this.groups=e,this.scope.groups=await this._loadGroup(e,0,t),this.scope.$apply()}async _loadGroup(e,t,i,s){let a=[];i||(i=[]),s&&s.$params&&(i=i.concat(s.$params));let r=await this.model.groupBy([e[t]],i);const n=e[t];for(let e of r){let i,r=e[n];$.isArray(r)?(i=r[0],r=r[1]):i=r,e.__str__=r,e.$paramValue=i,e.$paramName=n,e.$expanded=!1,e.$group=n,e.$params=[],s&&(e.$params=e.$params.concat(s.$params));let o={};o[n]=i,e.$params.push(o),e.$level=t,e.$hasChildren=!0,a.push(e)}return a}goto(e){return this.recordIndex=e}moveBy(e){const t=this._recordIndex+e;t>-1&&t<this.scope.records.length&&(this.recordIndex=t)}_clearTimeout(){this.loading=!1,this.loadingRecord=!1,this._canceled=!0,clearTimeout(this.pendingRequest)}set masterSource(e){this._masterSource=e,e.children.push(this)}get masterSource(){return this._masterSource}applyModifiedData(e,t,i){const s=this.getModifiedData(e,t,i),a=_.hash(i);if(s){let e=this.modifiedData;null==e&&(e={});let t=e[a];t||(t={},e[a]=t);for(let e in s){const i=s[e];t[e]=i}this.modifiedData=e,this.masterSource.scope.form.$setDirty()}return s}getNestedData(){let e={};for(let t of this.children)if(t.$modifiedRecords.length){let i=[],s=[];for(let e of t.$modifiedRecords)e.$deleted&&(s.push(e),null!==e.id&&void 0!==e.id&&i.push({id:e.id,action:"DESTROY"}));for(let e of t.$modifiedRecords)if(console.log(e.$modified,e.$modifiedData),e.$modifiedData&&!e.$deleted&&e.$modified&&-1===s.indexOf(e)){let s=this._getModified(e.$modifiedData);e.id&&(s.id=e.id),jQuery.extend(s,t.getNestedData()),null===e.id||void 0===e.id?i.push({action:"CREATE",values:s}):null!==e.id&&void 0!==e.id&&i.push({action:"UPDATE",values:s})}Object.keys(i).length>0&&(e[t.fieldName]=i)}return e}save(t=!0){for(let e of this.children)e.changing&&e.scope.save();const i=this.action.$form;if(this.validate()){const s=this.record.$record.toObject();this.scope.form.data=s;let a=i.attr("before-submit");if(a&&(a=this.scope.$eval(a)),s)return this.uploading++,this.model.write([s]).then(i=>(this.action&&this.action.viewType&&"form"===this.action.viewType&&katrid.app.$location.search("id",i[0]),this.scope.form.$setPristine(),this.scope.form.$setUntouched(),this._pendingChanges=!1,this.state=e.browsing,t?this.refresh(i):i)).catch(e=>{let t=`<span>${katrid.i18n.gettext("The following fields are invalid:")}<hr></span>`;if(e.message)t=e.message;else if(e.messages){let s;for(let a of Object.keys(e.messages)){const r=e.messages[a];let n;if(a.indexOf(".")>-1){let e=(a=a.split("."))[1];for(let t of this.children)t.scope.fieldName===a[0]&&(n=t.scope.view.fields[e])}else n=this.scope.view.fields[a];if(console.log("field invalid",n),n&&n.name){(s=i.find(`.form-field[name="${n.name}"]`)).addClass("ng-invalid ng-touched"),t+=`<strong>${n.caption}</strong><ul>`;for(let e of r)t+=`<li>${e}</li>`;t+="</ul>"}}s&&s.focus()}throw katrid.ui.dialogs.Alerts.error(t),new Error(t)}).finally(()=>this.scope.$apply(()=>this.uploading--));katrid.ui.dialogs.Alerts.warn(katrid.i18n.gettext("No pending changes"))}}_getNested(e){let t,i=[];if(e.$deleted&&e.$deleted.recs.length)for(let t of e.$deleted.recs)i.push({id:t.id,action:"DESTROY"});if(e.recs.length)for(let s of e.recs)if(s){if(t={},s.$created)t={action:"CREATE",values:this._getModified(s.$modifiedData)};else{if(!s.$modified)continue;(t={action:"UPDATE",values:this._getModified(s.$modifiedData)}).values.id=s.id}i.push(t)}return i}_getModified(e){let t={};if(e)for(let[i,s]of Object.entries(e))s instanceof Katrid.Data.SubRecords?t[i]=this._getNested(s):t[i]=s;return t}getModifiedData(e,t,i){let s={};return i.$modified&&jQuery.extend(s,this._getModified(i.$modifiedData)),this.record.id&&(s.id=i.id),s}get(t,i,s=!0,a=!1){return this._clearTimeout(),this.state=e.loading,this.loadingRecord=!0,this._canceled=!1,new Promise((r,n)=>{const o=()=>this.model.getById(t).catch(e=>n(e)).then(t=>{if(!this._canceled&&t){if(this.state===e.loading)this.state=e.browsing;else if(this.state===e.inserting)return;return this.record=t.data[0],!1!==a&&(this.scope.records[a]=this.record),r(this.record)}}).finally(()=>{if(this.loadingRecord=!1,s)return this.scope.$apply()});if(!i&&!this.requestInterval)return o();this.pendingRequest=setTimeout(o,i||this.requestInterval)})}get defaultValues(){}set defaultValues(e){for(let[t,i]of Object.entries(e))_.isObject(i)&&t in this.fields&&(this.fields[t].defaultValues=i)}async insert(t=!0,i,s){this._clearTimeout();for(let e of this.children)e._clearTimeout();let a,r={$created:!0},n=this.scope.records;this.record=r,this.scope.records=n,t&&(a=await this.model.getDefaults(s));for(let e of this.children)e.scope.records=[];this.state=e.inserting,this.scope.record.record_name=katrid.i18n.gettext("(New)");let o={};this.masterSource&&this.field&&this.field.defaultValues&&Object.assign(o,this.field.defaultValues);for(let e of Object.values(this.fields))e.default&&(o[e.name]=e.default);this.scope.ngDefaultValues&&Object.assign(o,this.scope.$eval(this.scope.ngDefaultValues)),this.action.context.default_values&&Object.assign(o,this.action.context.default_values),i&&Object.assign(o,i),a&&Object.assign(o,a);for(let[e,t]of Object.entries(o))_.isFunction(t)&&(t=t(o,this),_.isUndefined(t)||(o[e]=t));this.setValues(o)}_new(){return Katrid.Data.createRecord({},this)}setValues(e){Object.entries(e).forEach(([e,t])=>{let i=this.fields[e];i?i.fromJSON(t,this):this.scope.record[e]=t}),this.scope.$apply()}edit(){this.state=e.editing}toClientValue(e,t){const i=this.scope.view.fields[e];return i&&"DateTimeField"===i.type&&(t=new Date(t)),t}fieldByName(e){return this.scope.views?this.scope.views.form.fields[e]:this.scope.view.fields[e]}set state(t){this._modifiedFields=[],this._state=t,this.inserting=t===e.inserting,this.editing=t===e.editing,this.loading=t===e.loading,this.changing=[e.editing,e.inserting].includes(this.state),this.scope&&this.scope.$emit("dataStateChange",this)}get browsing(){return this._state===e.browsing}childByName(e){for(let t of this.children)if(t.fieldName===e)return t}get state(){return this._state}get record(){return this.scope.record}set recordId(e){this.scope.recordId=e;for(let t of this.children)t.pendingMasterId=e;this.scope.$broadcast("masterChanged",this,e)}get recordId(){return this.scope.recordId}set record(e){this.scope.record=katrid.data.createRecord(e,this),this.recordId=e.id,this._pendingChanges=!1,this.scope.form&&this.scope.form.$setPristine()}next(){return this.moveBy(1)}prior(){return this.moveBy(-1)}nextPage(){let e=this.recordCount/this.pageLimit;Math.floor(e)&&e++,e>this.pageIndex+1&&this.pageIndex++}prevPage(){this.pageIndex>1&&this.pageIndex--}set recordIndex(e){if(this._recordIndex=e,this.scope.record=this.scope.records[e],!this.parent)return katrid.app.$location.search("id",this.scope.record.id);this.scope.recordId=null}get recordIndex(){return this._recordIndex}async expandGroup(e,t){let i=[];if(this._params&&(i=i.concat(this._params)),t.$params&&(i=i.concat(t.$params)),t.$level===this.groups.length-1){let s=await this.model.search({where:i[0]});s.data&&(t.$children=s.data,this.scope.$apply(()=>{this.scope.groups.splice.apply(this.scope.groups,[e+1,0].concat(s.data))})),this.scope.records=this._chain()}else{let i=await this._loadGroup(this.groups,t.$level+1,this._params,t);t.$children=i,this.scope.groups.splice.apply(this.scope.groups,[e+1,0].concat(i)),this.scope.$apply()}}collapseGroup(e,t){let i=(e,t)=>{console.log("collapse",e,t),t.$children&&t.$children.length&&t.$level!==this.groups.length-1&&t.$children.map(e=>i(this.scope.groups.indexOf(e),e)),t.$children&&t.$children.length&&this.scope.groups.splice(e+1,t.$children.length),t.$children=[]};i(e,t),this.scope.records=this._chain()}_chain(){let e=[];for(let t of this.scope.groups)t.$hasChildren&&t.$expanded&&t.$children.length&&(e=e.concat(t.$children));return e}_applyResponse(e){e&&(e.value&&this.setValues(e.value),this.scope.$apply())}async dispatchEvent(e,...t){let i=await this.model.rpc(e,...t);this._applyResponse(i)}get model(){return this.scope.model}open(){this.search({},1,this.action.view.fields)}get parent(){return this.masterSource}set parent(e){this._masterSource=e}$setDirty(e){let t=this.scope.form;if(t){let i=t[e];i&&i.$setDirty()}else this.action&&this.action.setDirty(e)}destroyChildren(){for(let e of this.children)e.scope.$destroy();this.children=[]}},katrid.data.DataSourceState=e}(),function(){class e{constructor(e){this.cols=e.cols||6,this.visible=!0,this._info=e,this.cssClass=e.type,this.caption=e.caption||e.name,this.helpText=this._info.help_text,this.required=this._info.required,this.onChange=this._info.onchange,this.nolabel=!1,!1===this._info.visible&&(this.visible=!1),this.readonly=this._info.readonly,this.readonly||(this.readonly=!1),this.displayChoices=_.object(e.choices),this.choices=e.choices,e.choices?this.template={list:"view.list.selection-field.jinja2",form:"view.form.selection-field.jinja2"}:this.template={list:"view.list.field.jinja2",form:"view.form.field.jinja2"},e.template&&(this.template=Object.assign(this.template,e.template)),this.emptyText="--"}static fromInfo(e){return new(katrid.data.fields[e.type]||t)(e)}static fromArray(e){let t={};return Object.keys(e).map(i=>t[i]=this.fromInfo(e[i])),t}render(e,t,i){this.$el=t;let s={};for(let e of t[0].attributes){s[e.name]=e.value;let t=e.name.replace(/([^a-zA-Z0-9_\- ])|^[_0-9]+/g,"").trim().toLowerCase().replace(/([ -]+)([a-zA-Z0-9])/g,function(e,t,i){return i.toUpperCase()}).replace(/([0-9]+)([a-zA-Z])/g,function(e,t,i){return t+i.toUpperCase()});t!==e.name&&(s[t]=e.value)}return s.cols&&(this.cols=s.cols),s.ngReadonly&&(this.ngReadonly=s.ngReadonly),s.domain&&(this.domain=s.domain),"false"===s.visible?this.visible=!1:"true"===s.visible&&(this.visible=!0),s.ngShow&&(this.ngShow=s.ngShow),s.ngIf&&(this.ngIf=s.ngIf),s.ngClass&&(this.ngClass=s.ngClass),this.attrs=s,i.field=this,i.attrs=s,i.html=t.html(),katrid.app.getTemplate(this.template[e],i)}assign(e){this.$el=e;let t=e.attr("label");_.isUndefined(t)||(this.caption=t);let i=e.attr("ng-readonly"),s=e.attr("invisible");_.isUndefined(s)||(this.visible=!1),_.isUndefined(i)||(this.ngReadonly=i);let a=e.attr("cols");_.isUndefined(a)||(this.cols=a)}fromJSON(e,t){t.record[this.name]=e}get validAttributes(){return["name","nolabel","readonly","required"]}getAttributes(){let e={};this.validAttributes;return this.ngReadonly?e["ng-readonly"]=this.ngReadonly:this.readonly&&(e.readonly=this.readonly),e["ng-model"]="record."+this.name,attrs.ngFieldChange&&(e["ng-change"]=attrs.ngFieldChange,console.log("change",attrs.ngFieldChange)),this.required&&(e.required=this.required),e}get hasChoices(){return this._info.choices&&this._info.choices.length>0}get name(){return this._info.name}get model(){return this._info.model}get maxLength(){return this._info.max_length}get type(){return this._info.type}get paramTemplate(){return"view.param.String"}format(e){return e.toString()}toJSON(e){return e}createWidget(e,t,i,s){return e||this.hasChoices&&(e="SelectionField"),new(Katrid.ui.Widgets[e||this.type]||Katrid.ui.Widgets.StringField)(t,i,this,s)}validate(){}get defaultCondition(){return"="}isControlVisible(e){switch(e){case"is null":case"is not null":return!1}return!0}}class t extends e{constructor(e){e.cols||(e.cols=3),super(...arguments)}}class i extends e{constructor(e){e.cols||(e.cols=3),super(...arguments),this.template.form="view.form.date-field.jinja2",this.template.list="view.list.date-field.jinja2"}toJSON(e){return e}get paramTemplate(){return"view.param.Date"}format(e){return _.isString(e)?moment(e).format(Katrid.i18n.gettext("yyyy-mm-dd").toUpperCase()):""}getAttributes(e){let t=super.getAttributes(e);return t.type="date",t}}class s extends i{constructor(e){e.cols||(e.cols=3),super(...arguments),this.template.form="view.form.datetime-field.jinja2",this.template.list="view.list.datetime-field.jinja2"}get paramTemplate(){return"view.param.DateTime"}getAttributes(e){let t=super.getAttributes(e);return t.type="datetime-local",t}}class a extends e{constructor(e){e.cols||(e.cols=3),super(...arguments),Katrid.UI.isMobile?this.template.form="view.form.numpad-field.pug":this.template.form="view.form.numeric-field.jinja2",this.template.list="view.list.numeric-field.jinja2"}fromJSON(e,t){t.record[this.name]=parseFloat(e)}toJSON(e){return e&&_.isString(e)?parseFloat(e):e}}class r extends e{constructor(e){super(...arguments),this.domain=e.domain,Object.assign(this.template,{list:"view.list.foreignkey.jinja2",form:"view.form.foreignkey.jinja2"})}assign(e){super.assign(e);let t=$(e).attr("domain");t&&(this.domain=t)}toJSON(e){return _.isArray(e)?e[0]:e}get validAttributes(){return super.validAttributes.concat(["domain"])}}class n extends t{constructor(e){super(...arguments),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.text-field.jinja2")}}katrid.data.fields={Field:e,StringField:t,PasswordField:class extends t{constructor(e){e.template||(e.template={}),e.template.form||(e.template.form="view.form.password.jinja2"),e.template.list||(e.template.list="view.list.password.jinja2"),super(e)}},IntegerField:class extends e{constructor(e){e.cols||(e.cols=3),super(...arguments)}toJSON(e){return e&&_.isString(e)?parseInt(e):e}get paramTemplate(){return"view.param.Integer"}},FloatField:class extends a{},DecimalField:class extends a{constructor(){super(...arguments),this.decimalPlaces=2,this._info.attrs&&(this.decimalPlaces=this._info.attrs.decimal_places||2)}},DateTimeField:s,TimeField:class extends s{constructor(e){e.cols||(e.cols=3),super(...arguments),this.template.form="view.form.time-field.jinja2",this.template.list="view.list.time-field.jinja2"}},ForeignKey:r,OneToManyField:class extends e{constructor(e){e.cols||(e.cols=12),super(...arguments),this.template.form="view.form.grid.jinja2"}get field(){return this._info.field}get validAttributes(){return super.validAttributes.concat(["inline-editor","ng-default-values"])}fromJSON(e,t){if(e&&e instanceof Array){let i=t.childByName(this.name);e.map(e=>{"CLEAR"===e.action?(i.scope.records=[],t.record[this.name]=[]):"CREATE"===e.action&&i.scope.addRecord(e.values)}),i.scope.$apply()}}},ManyToManyField:class extends r{constructor(e){super(...arguments),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.manytomany.jinja2")}toJSON(e){return _.isArray(e)?e.map(e=>_.isArray(e)?e[0]:e):(_.isString(e)&&(e=e.split(",")),e)}},TextField:n,XmlField:class extends n{constructor(e){super(...arguments),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.code-editor.jinja2")}},JsonField:class extends n{constructor(e){super(...arguments),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.json-field.jinja2")}},PythonCodeField:class extends n{constructor(e){super(...arguments),console.log("python code field"),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.python-code.jinja2")}},DateField:i,BooleanField:class extends e{constructor(e){e.cols||(e.cols=3),super(...arguments),this.template.form="view.form.boolean-field.jinja2",this.template.list="view.list.boolean-field.jinja2",this.nolabel=!0}get paramTemplate(){return"view.param.Boolean"}},ImageField:class extends e{constructor(e){e.template||(e.template={}),e.template.form||(e.template.form="view.form.image-field.jinja2"),super(...arguments),this.noImageUrl="/static/web/assets/img/no-image.png"}getAttributes(e){let t=super.getAttributes(e);return t.ngSrc=e.ngEmptyImage||e.emptyImage&&`'${e.emptyImage}`||`'${this.noImageUrl}'`,t.ngSrc=`{{ ${t["ng-model"]} || ${t.ngSrc} }}`,t}get ngSrc(){let e=this.attrs.ngEmptyImage||this.attrs.emptyImage&&`'${this.attrs.emptyImage}`||`'${this.noImageUrl}'`;return e=`\${ record.${this.name} || ${e} }`}}}}(),katrid.settings.ui={dateInputMask:!0,defaultView:"list",goToDefaultViewAfterCancelInsert:!0,goToDefaultViewAfterCancelEdit:!1,horizontalForms:!0},function(){this.katrid.ui={widgets:{},Widget:class{constructor(e){this.$el=e}},Component:class{},keyCode:{BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},toggleFullScreen(){document.fullscreenElement||document.mozFullScreenElement||document.webkitFullscreenElement||document.msFullscreenElement?document.exitFullscreen?document.exitFullscreen():document.msExitFullscreen?document.msExitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitExitFullscreen&&document.webkitExitFullscreen():document.documentElement.requestFullscreen?document.documentElement.requestFullscreen():document.documentElement.msRequestFullscreen?document.documentElement.msRequestFullscreen():document.documentElement.mozRequestFullScreen?document.documentElement.mozRequestFullScreen():document.documentElement.webkitRequestFullscreen&&document.documentElement.webkitRequestFullscreen(Element.ALLOW_KEYBOARD_INPUT)}},katrid.ui.ngKatrid=angular.module("ui.katrid",[])}(),katrid.ui.isMobile=function(){let e=!1;var t;return t=navigator.userAgent||navigator.vendor||window.opera,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(t)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(t.substr(0,4)))&&(e=!0),e}(),function(){class e{static initClass(){this.actionType=null,this._context=null}constructor(e,t,i,s){this.info=e,this.scope=t,katrid.app.actionManager.addAction(this),s||(s=katrid.app.$element),this.$parent=s}$destroy(){katrid.app.actionManager.removeAction(this),this.scope.$destroy(),this.$element?this.$element.remove():this.$parent.empty()}get id(){return this.info.id}get context(){return this._context||(_.isString(this.info.context)?this._context=JSON.parse(this.info.context):this._context={}),this._context}doAction(e){let t=e.type||e.action_type;return katrid.Actions[t].dispatchAction(this,e)}openObject(e){return e.preventDefault(),e.stopPropagation(),e.ctrlKey?(window.open(e.target.href),!1):(console.log(e.target.href),location.hash=e.target.href,!1)}restore(){}apply(){}backTo(e){let t=katrid.app.actionManager.breadcrumb[e];t&&katrid.app.actionManager.back(t.action,t.url)}execute(){}getCurrentTitle(){return this.info.record_name}search(){if(!this.isDialog)return this.location.search.apply(null,arguments)}async onHashChange(e){location.hash="#/app/?"+$.param(e),await this.execute()}}e.initClass();class t extends e{static initClass(){this.actionType="ir.action.view"}async onHashChange(e){location.hash="#/app/?"+$.param(e);let t=new katrid.Services.Model("ir.action.view"),i=(await t.post("get_view",{args:[this.info.view[0]]})).content;katrid.app.$element.html(katrid.core.$compile(i)(this.scope))}}t.initClass();class i extends e{static initClass(){this.actionType="ir.action.url"}constructor(e,t,i){super(e,t,i),window.location.href=e.url}}i.initClass(),katrid.actions={Action:e,ViewAction:t,UrlAction:i,ActionManager:class extends Array{constructor(){super(),this.currentAction=null,this.mainAction=null}addAction(e){this.mainAction||(this.mainAction=e),this.push(e),this.currentAction=e}back(e,t){e?this.action=e:this.length>1&&(this.action=this[this.length-2]),this.action.$attach(),this.action.refreshBreadcrumb(),angular.isString(t)?katrid.app.loadPage(t):t&&katrid.app.$location.search(t)}removeAction(e){this.splice(this.indexOf(e),this.length),0===this.length&&(this.mainAction=null)}get action(){return this.currentAction}set action(e){let t=this.indexOf(e);if(t>-1){for(t++;this.length>t;)this[t].$destroy();this.currentAction=e}}clear(){for(let e of this)e.$destroy();this.length=0,this.mainAction=null,this.currentAction=null}get path(){return this.action.path}doAction(e){}async onHashChange(e,t){let i,s,a=e.action;if(t&&this.clear(),s=i=this.currentAction,!a&&e.model&&(!s||s.params&&s.params.model!==e.model)){let t=new katrid.Services.Model(e.model),i=await t.rpc("get_formview_action",[e.id]),a=this.createScope();s=a.action=new katrid.Actions[i.action_type](i,a,e)}else if(!this.currentAction||this.currentAction.info.id!=a){this.currentAction&&t&&this.currentAction.$destroy();let i=await katrid.services.Actions.load(a),r=this.createScope();s=r.action=new katrid.actions[i.action_type](i,r,e)}await s.onHashChange(e)}createScope(){let e=katrid.app.$scope.$new(!0);return e._=_,e}get breadcrumb(){if(this._breadcrumb)return this._breadcrumb;let e=[];for(let t of this){let i=t.breadcrumb;if(i&&i.length){for(let e of i)e.isLeaf=!1;e.push(...i)}}return e[e.length-1].isLeaf=!0,this._breadcrumb=e,e}}},katrid.actions[t.actionType]=t,katrid.actions[i.actionType]=i}(),function(){class e extends katrid.actions.Action{static initClass(){this.actionType="ir.action.client",this.registry={}}static register(e,t){this.registry[e]=t}static executeTag(e,t){let i=this.registry[t.tag];i.prototype instanceof katrid.ui.views.ActionView?(i=new i(e.scope)).renderTo(e):console.log("is a function")}static tagButtonClick(t){let i={type:"ir.action.client",tag:t.attr("name"),target:t.attr("target")||"new"};(i=new e(i,katrid.actions.actionManager.action.scope,katrid.actions.actionManager.action.location)).execute()}tag_refresh(){this.dataSource.refresh()}get templateUrl(){return console.log(this.tag),this.tag.templateUrl}async execute(){let t=e.registry[this.info.tag];if(this.tag=t,t.prototype instanceof katrid.UI.Views.ClientView){this.tag=new t(this);let e=await this.tag.render();"new"===this.info.target?e=e.modal():$("#katrid-action-view").empty().append(e)}else _.isString(t)&&this[t].apply(this)}async routeUpdate(e){}get template(){return this.tag.template}}e.initClass(),katrid.actions.ClientAction=e,katrid.actions[e.actionType]=e}(),function(){class e extends katrid.actions.Action{static initClass(){this.actionType="ir.action.window"}constructor(e,t,i,s){super(e,t,i,s),this.viewMode=e.view_mode,this.viewModes=this.viewMode.split(","),e.model&&(t.model=this.model=new katrid.services.Model(e.model)),this.dataSource=new katrid.data.DataSource(t,this),t.$on("dataStateChange",this.onDataStateChange),t.$on("afterCancel",(e,t)=>{t===this.dataSource&&this.afterCancel(e,t)})}afterCancel(e,t){t.state===katrid.gata.DataSourceState.inserting&&(this.dataSource.record={},this.back())}back(){katrid.app.actionManager.history.back()}setDirty(e){const t=this.form[e];t&&t.$setDirty()}async onHashChange(e){let t=!1,i=["action","view_type","menu_id","model"];this.params&&(this.params.id,e.id);if(this.params={},e.view_type||(this.params.view_type=this.viewModes[0],t=!0),e.model||(this.params.model=this.info.model,t=!0),Object.assign(this.params,e),"form"===this.params.view_type&&i.splice(0,0,"id"),Object.keys(this.params).length===i.length)for(let e of Object.keys(this.params))i.includes(e)||(t=!0);else t=!0;if(t){let e=this.params;this.params={};for(let t of i)this.params[t]=e[t];this.params.action||delete this.params.action,location.hash="#/app/?"+$.param(this.params)}let s=this.params.view_type;s!==this.viewType&&(this.viewType=s,await this.execute()),this.params.id&&this.dataSource.recordId!=this.params.id&&await this.dataSource.get(this.params.id)}rpc(e,t,i){i&&i.stopPropagation(),t?_.isArray(t)?t={args:t}:_.isObject(t)||(t={args:[t]}):t={},this.model.rpc(e,t.args,t.kwargs)}getContext(){let e=super.getContext(),t=this.selection;return t&&t.length&&(e.active_id=t[0],e.active_ids=t),e}restore(e){this._currentPath||this.location.$$path;let t=this._currentParams[e]||{};t.view_type=e,katrid.app.actionManager.length>1?(t.actionId=this.info.id,this.$state.go("actionView",t)):this.viewType=e}getCurrentTitle(){return"form"===this.viewType?this.scope.record.record_name:super.getCurrentTitle()}switchView(e,t){if(e!==this.viewType){this.viewType=e,this.execute();let i=katrid.app.$location.$$search;Object.assign(i,t),i.view_type=e,katrid.app.$location.search(i)}}createNew(){this.switchView("form",{id:null})}async deleteSelection(){let e=this.selection;if(!e)return!1;if(1===e.length&&confirm(katrid.i18n.gettext("Confirm delete record?"))||e.length>1&&confirm(katrid.i18n.gettext("Confirm delete records?"))){await this.model.destroy(e);this.scope.records.indexOf(this.scope.record);this.viewType="list",this.dataSource.refresh()}}async copy(){return this.viewType="form",await this.dataSource.copy(this.scope.record.id),!1}async copyTo(e){if(this.scope.recordId){let t=new katrid.Services.Model("ir.copy.to"),i=await t.rpc("copy_to",[e,this.scope.recordId]),s=new katrid.Services.Model(i.model),a=await s.getViewInfo({view_type:"form"});new katrid.ui.Dialogs.Window(this.scope,{view:a},katrid.Core.compile,null,s).createNew({defaultValues:i.value})}}makeUrl(e){e||(e=this.viewModes[0]);const t={action:this.info.id,view_type:e,menu_id:katrid.app.$location.$$search.menu_id};return"form"===e&&this.record&&(t.id=this.record.id),t}get record(){return this.scope.record}get searchModes(){return this.viewModes.filter(e=>"form"!==e)}get breadcrumb(){let e=[];if(this.searchModes.length&&e.push({action:this,url:this.makeUrl(this.lastViewType),text:this.info.record_name}),"form"===this.viewType){let t={action:this,url:this.makeUrl("form")};this===katrid.app.actionManager.currentAction?t.text="${ record.record_name }":t.text=this.record&&this.record.record_name,e.push(t)}return e}refreshBreadcrumb(){katrid.app.actionManager._breadcrumb=null;let e=katrid.app.getTemplate("view.breadcrumb.jinja2",{breadcrumb:katrid.app.actionManager.breadcrumb,action:this});e=katrid.core.$compile(e)(this.scope),this.$element.find(".breadcrumb-nav").html(e)}$detach(){this.$element.detach()}$attach(){this.$element.appendTo(this.$parent)}async execute(){if(!this.views){let e=await this.model.loadViews({views:this.info.views,action:this.info.id,toolbar:!0});this.fields=e.fields,this.fieldList=e.fieldList,this.views=e.views;let t=katrid.app.getTemplate("ir.action.window.jinja2",{action:this});t=katrid.core.$compile(t)(this.scope),this.$parent.html(t),this.$element=t,this.$container=this.$element.find(".action-view-content:first")}this.refreshBreadcrumb(),this.scope.view=this.views[this.viewType];let e=new katrid.ui.views[this.viewType](this,this.scope.view);"form"!==this.viewType&&(this.lastViewType=this.viewType,this.lastUrl=location.hash),e.renderTo(this.$container),setTimeout(()=>{"form"!==this.viewType||katrid.app.$location.$$search.id||this.dataSource.insert()})}get viewType(){return this._viewType}set viewType(e){e!==this._viewType&&("form"!==e&&(this.dataSource.recordId=null),this.dataSource.destroyChildren(),this._viewType=e)}searchText(e){return this.location.search("q",e)}_prepareParams(e){const t={};for(let i of Array.from(e))i.field&&"ForeignKey"===i.field.type?t[i.field.name]=i.id:t[i.id.name+"__icontains"]=i.text;return t}clearGroups(){this.dataSource.groups=[]}setSearchParams(e){let t={};this.info.domain&&(t=$.parseJSON(this.info.domain));for(let[i,s]of Object.entries(t)){let t={};t[i]=s,e.push(t)}return this.dataSource.search(e)}async applyGroups(e,t){return await this.dataSource.groupBy(e,t)}groupHeaderClick(e,t){e.$expanded=!e.$expanded,e.$expanded?this.dataSource.expandGroup(t,e):this.dataSource.collapseGroup(t,e)}doViewAction(e,t,i,s){return this._doViewAction(this.scope,e,t,i,s)}_doViewAction(e,t,i,s,a){let r=null;if(a&&(r=window.prompt(a)),!s||s&&confirm(s))return this.model.doViewAction({action_name:t,target:i,prompt:r}).then(function(e){if("open"===e.status)return window.open(e.open)})}async formButtonClick(e,t,i){const s=await this.scope.model.rpc(t,[e]);if(s.open)return window.open(s.open);if(s.download){let e=document.createElement("a");return e.href=s.download,void e.click()}if("refresh"===s.tag&&this.dataSource.refresh(),s.type){new katrid.Actions[s.type](s,this.scope,this.scope.location).execute()}}doBindingAction(e){this.selection,katrid.Services.Actions.load($(e.currentTarget).data("id")).then(e=>{"ir.action.report"===e.action_type&&katrid.Actions.ReportAction.dispatchBindingAction(this,e)})}listRowClick(e,t,i){if(this.dataSource.state=katrid.data.DataSourceState.browsing,t.$hasChildren)console.log("list row click"),this.groupHeaderClick(t,e);else{const s={id:t.id,action:this.info.id,view_type:"form",menu_id:katrid.app.$location.$$search.menu_id};if(i.ctrlKey){const e=`#${hash}`;return void window.open(e)}katrid.app.$location.search(s),this.dataSource.recordIndex=e}}onDataStateChange(e,t){let i=t.scope.action;t.changing&&setTimeout(()=>{if(i.$element)for(let e of Array.from(i.$element.find("input[type!=hidden].form-field:visible")))if(!(e=$(e)).attr("readonly"))return void $(e).focus()})}autoReport(){return this.model.autoReport().then(function(e){if(e.ok&&e.result.open)return window.open(e.result.open)})}showDefaultValueDialog(){const e=katrid.UI.Utils.Templates.getSetDefaultValueDialog();$(katrid.core.compile(e)(this.scope)).modal().on("hidden.bs.modal",function(){return $(this).data("bs.modal",null),$(this).remove()})}selectToggle(e){this._selection=$(e).closest("table").find("td.list-record-selector :checkbox").filter(":checked"),this.selectionLength=this._selection.length}get selection(){return"form"===this.viewType?this.scope.recordId?this.scope.recordId:void 0:this._selection?Array.from(this._selection).map(e=>$(e).data("id")):void 0}deleteAttachment(e,t){let i=e[t];confirm(katrid.i18n.gettext("Confirm delete attachment?"))&&(e.splice(t,1),katrid.services.Attachments.destroy(i.id))}}e.initClass(),katrid.actions.WindowAction=e,katrid.actions[e.actionType]=e}(),(()=>{class e{constructor(e){this.$cache=e}getSource(e){return{src:this.$cache.get(e),path:e,noCache:!1}}}class t{constructor(s,a){this.app=s,t.env=new nunjucks.Environment(new e(s.$templateCache),{autoescape:!1});let r=s.$templateCache.get;s.$templateCache.get=(e=>this.prepare(e,r.call(this,e))),this.loadTemplates(s.$templateCache,a);for(let[e,t]of Object.entries(i))s.$templateCache.put(e,t)}prepare(e,t){if(_.isUndefined(t))throw Error("Template not found: "+e);return"SCRIPT"===t.tagName?t.innerHTML:t}compileTemplate(e,t){let i=$(e);t=$(t.innerHTML);for(let e of Array.from(t))if("JQUERY"===e.tagName){let t=(e=$(e)).attr("selector"),s=e.attr("operation");(t=t?$(i).find(t):i)[s](e[0].innerHTML)}return i[0].innerHTML}loadTemplates(e,t){let i={},s=e=>{"TEMPLATES"===e.tagName?Array.from(e.children).map(s):"SCRIPT"===e.tagName&&(i[e.id]=e.innerHTML)},a=t=>{if("TEMPLATES"===t.tagName)Array.from(t.children).map(a);else if("SCRIPT"===t.tagName){let s=t.getAttribute("extends"),a=t.getAttribute("id")||s;s?t=i[s]+t:a=t.id,e.put(a,t)}},r=(new DOMParser).parseFromString(t,"text/html").firstChild.children[1].firstChild;s(r),a(r)}}let i={};katrid.ui.registerTemplate=function(e,t){i[e]=t},katrid.ui.Templates=t,katrid.ui.Templates.PRE_LOADED_TEMPLATES=i})(),function(){class e extends katrid.actions.Action{static initClass(){this.actionType="ir.action.report"}static async dispatchBindingAction(e,t){let i=localStorage.katridReportViewer||"pdf",s=e.selection;console.log("selection ",s),s&&(s=s.join(","));let a={data:[{name:"id",value:s}]};const r=new katrid.services.Model("ir.action.report");let n=await r.post("export_report",{args:[t.id],kwargs:{format:i,params:a}});if(n.open)return window.open(n.open)}get name(){return this.info.name}constructor(e,t,i){super(e,t,i),this.templateUrl="view.report.jinja2",this.userReport={}}userReportChanged(e){return this.location.search({user_report:e})}async onHashChange(e){if(console.log("report hash change",e),this.userReport.id=e.user_report,this.userReport.id){const e=new katrid.Services.Model("ir.action.report");let t=await e.post("load_user_report",{kwargs:{user_report:this.userReport.id}});this.userReport.params=t.result}location.hash="#/app/?"+$.param(e);let t=katrid.reports.Reports.renderDialog(this);t=katrid.core.$compile(t)(this.scope),$("#katrid-action-view").empty().append(t)}}e.initClass(),katrid.actions.ReportAction=e,katrid.actions[e.actionType]=e}(),function(){let e=0;class t{static initClass(){this.currentReport={},this.currentUserReport={}}static get(e){}static renderDialog(e){return console.log(e),katrid.app.getTemplate("view.report.jinja2",{action:e})}}t.initClass();class i{constructor(t,i){this.action=t,this.scope=i,this.info=this.action.info,katrid.Reports.Reports.currentReport=this,null==s.Labels&&(s.Labels={exact:katrid.i18n.gettext("Is equal"),in:katrid.i18n.gettext("Selection"),contains:katrid.i18n.gettext("Contains"),startswith:katrid.i18n.gettext("Starting with"),endswith:katrid.i18n.gettext("Ending with"),gt:katrid.i18n.gettext("Greater-than"),lt:katrid.i18n.gettext("Less-than"),between:katrid.i18n.gettext("Between"),isnull:katrid.i18n.gettext("Is Null")}),this.name=this.info.name,this.id=++e,this.values={},this.params=[],this.filters=[],this.groupables=[],this.sortables=[],this.totals=[]}telegram(){katrid.Reports.Telegram.export(this)}getUserParams(){const e={data:[],file:this.container.find("#id-report-file").val()};for(let t of Array.from(this.params))e.data.push({name:t.name,op:t.operation,value1:t.value1,value2:t.value2,type:t.type});const t=this.container.find("#report-id-fields").val();e.fields=t;const i=this.container.find("#report-id-totals").val();e.totals=i;const s=this.container.find("#report-id-sorting").val();e.sorting=s;const a=this.container.find("#report-id-grouping").val();return e.grouping=a,e}loadFromXml(e){let t={date:"DateField",datetime:"DateTimeField"};_.isString(e)&&(e=$(e)),this.scope.customizableReport=e.attr("customizableReport"),this.scope.advancedOptions=e.attr("advancedOptions"),this.model=e.attr("model");const i=[];for(let s of Array.from(e.find("param,field"))){let e=s.tagName;const a=(s=$(s)).attr("name");let r;console.log(this.info),this.info.fields&&(r=this.info.fields[a]);const n=s.attr("label")||s.attr("caption")||r&&r.caption||a,o=s.attr("groupable"),l=s.attr("sortable"),c=s.attr("total");let d=s.attr("param");"FIELD"!==e||d||(d="static");const h=s.attr("required"),p=s.attr("autoCreate")||h||"static"===d,u=s.attr("operation");let m=s.attr("type")||s.data("type")||r&&r.type;m in t&&(m=t[m]);const f=s.attr("model-choices");!m&&f&&(m="ModelChoices"),i.push({name:a,label:n,groupable:o,sortable:l,total:c,param:d,required:h,operation:u,modelChoices:f,type:m,autoCreate:p,field:s})}const s=Array.from(e.find("param")).map(e=>$(e).attr("name"));return this.load(i,s)}saveDialog(){const e=this.getUserParams(),t=window.prompt(katrid.i18n.gettext("Report name"),katrid.Reports.Reports.currentUserReport.name);return t&&(katrid.Reports.Reports.currentUserReport.name=t,$.ajax({type:"POST",url:this.container.find("#report-form").attr("action")+"?save="+t,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(e)})),!1}load(e,t){e||({fields:e}=this.info),t||(t=[]),this.fields=e,this.scope.fields={};for(let i of e)this.scope.fields[i.name]=i,i.groupable&&this.groupables.push(i),i.sortable&&this.sortables.push(i),i.total&&this.totals.push(i),i.autoCreate||(i.autoCreate=t.includes(i.name))}loadParams(){for(let e of Array.from(this.fields))e.autoCreate&&this.addParam(e.name)}addParam(e){for(let t of Array.from(this.fields))if(t.name===e){t=new a(t,this),this.params.push(t);break}}getValues(){}export(e){null==e&&(e=localStorage.katridReportViewer||"pdf");const t=this.getUserParams();return console.log("send params",t),new katrid.Services.Model("ir.action.report").post("export_report",{args:[this.info.id],kwargs:{format:e,params:t}}).then(function(e){if(e.open)return window.open(e.open)}),!1}preview(){return this.export(localStorage.katridReportViewer)}renderFields(){let e,t=$("<div></div>");const i=this.fields.map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),s=(()=>{const t=[];for(e of Array.from(this.fields))e.total&&t.push(`<option value="${e.name}">${e.label}</option>`);return t})().join("");let a=(t=this.container.find("#report-params")).find("#report-id-fields");return a.append($(i)).select2({tags:(()=>{const t=[];for(e of Array.from(this.fields))t.push({id:e.name,text:e.label});return t})()}),katrid.Reports.Reports.currentUserReport.params&&katrid.Reports.Reports.currentUserReport.params.fields&&(console.log(katrid.Reports.Reports.currentUserReport.params.fields),a.select2("val",katrid.Reports.Reports.currentUserReport.params.fields)),(a=t.find("#report-id-totals")).append(s).select2({tags:(()=>{const t=[];for(e of Array.from(this.fields))e.total&&t.push({id:e.name,text:e.label});return t})()}),t}renderParams(e){let t;const i=$("<div></div>");this.elParams=i;const s={},a=katrid.Reports.Reports.currentUserReport.params;if(a&&a.data)for(t of Array.from(a.data))s[t.name]=!0,this.addParam(t.name,t.value);for(t of Array.from(this.params))t.static&&!s[t.name]&&$(t.render(i));return e.find("#params-params").append(i)}renderGrouping(e){const t=Array.from(this.groupables).map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),i=e.find("#params-grouping").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>i.select2("onSortStart"),update:()=>i.select2("onSortEnd")})}renderSorting(e){const t=Array.from(this.sortables).filter(e=>e.sortable).map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),i=e.find("#params-sorting").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>i.select2("onSortStart"),update:()=>i.select2("onSortEnd")})}render(e){this.container=e;let t=this.renderFields();return this.sortables.length?t=this.renderSorting(e):e.find("#params-sorting").hide(),this.groupables.length?t=this.renderGrouping(e):e.find("#params-grouping").hide(),this.renderParams(e)}}class s{static initClass(){this.Operations={exact:"exact",in:"in",contains:"contains",startswith:"startswith",endswith:"endswith",gt:"gt",lt:"lt",between:"between",isnull:"isnull"},this.DefaultOperations={CharField:this.Operations.exact,IntegerField:this.Operations.exact,DateTimeField:this.Operations.between,DateField:this.Operations.between,FloatField:this.Operations.between,DecimalField:this.Operations.between,ForeignKey:this.Operations.exact,ModelChoices:this.Operations.exact,SelectionField:this.Operations.exact},this.TypeOperations={CharField:[this.Operations.exact,this.Operations.in,this.Operations.contains,this.Operations.startswith,this.Operations.endswith,this.Operations.isnull],IntegerField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],FloatField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],DecimalField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],DateTimeField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],DateField:[this.Operations.exact,this.Operations.in,this.Operations.gt,this.Operations.lt,this.Operations.between,this.Operations.isnull],ForeignKey:[this.Operations.exact,this.Operations.in,this.Operations.isnull],ModelChoices:[this.Operations.exact,this.Operations.in,this.Operations.isnull],SelectionField:[this.Operations.exact,this.Operations.isnull]},this.Widgets={CharField:e=>`<div><input id="rep-param-id-${e.id}" ng-model="param.value1" type="text" class="form-control"></div>`,IntegerField(e){let t="";return"between"===e.operation&&(t=`<div class="col-sm-6"><input id="rep-param-id-${e.id}-2" ng-model="param.value2" type="number" class="form-control"></div>`),`<div class="row"><div class="col-sm-6"><input id="rep-param-id-${e.id}" type="number" ng-model="param.value1" class="form-control"></div>${t}</div>`},DecimalField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" ng-model="param.value2" input-decimal class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" input-decimal ng-model="param.value1" class="form-control"></div>${t}</div>`},DateTimeField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" type="text" date-picker="L" ng-model="param.value2" class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" type="text" date-picker="L" ng-model="param.value1" class="form-control"></div>${t}</div>`},DateField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" type="text" date-picker="L" ng-model="param.value2" class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" type="text" date-picker="L" ng-model="param.value1" class="form-control"></div>${t}</div>`},ForeignKey(e){const t=e.info.field.attr("model")||e.params.model;let i="";return"in"===e.operation&&(i="multiple"),`<div><input id="rep-param-id-${e.id}" ajax-choices="${t}" field="${e.name}" ng-model="param.value1" ${i}></div>`},ModelChoices(e){let t="";return"in"===e.operation&&(t="multiple"),`<div><input id="rep-param-id-${e.id}" ajax-choices="ir.action.report" model-choices="${e.info.modelChoices}" ng-model="param.value1" ${t}></div>`},SelectionField(e){e.info.choices=e.info.field.data("choices");let t=e.info.field.attr("default");if(t&&(t=` ng-init="param.value1='${t}'"`),!e.info.choices){e.info.choices={};for(let t of e.info.field.find("option"))t=$(t),e.info.choices[t.attr("value")]=t.text()}return`<div${t}><select class="form-control" ng-model="param.value1"><option value="\${ key }" ng-repeat="(key, value) in fields.${e.name}.choices">\${ value }</option></select></div>`}}}}s.initClass();class a{constructor(t,i){this.info=t,this.params=i,this.name=this.info.name,this.field=this.params.info.fields&&this.params.info.fields[this.name],this.label=this.info.label||this.params.info.caption,this.static="static"===this.info.param,this.type=this.info.type||this.field&&this.field.type||"CharField",this.defaultOperation=this.info.operation||s.DefaultOperations[this.type],this.operation=this.defaultOperation,this.operations=this.getOperations(),this.exclude=this.info.exclude,this.id=++e}defaultValue(){return null}setOperation(e,t){null==t&&(t=!0),this.createControls(this.scope);const i=this.el.find(`#rep-param-id-${this.id}`);t&&i.focus()}createControls(e){const t=this.el.find(".param-widget");t.empty();let i=s.Widgets[this.type](this);return i=katrid.Core.$compile(i)(e),t.append(i)}getOperations(){return Array.from(s.TypeOperations[this.type]).map(e=>({id:e,text:s.Labels[e]}))}operationTemplate(){const e=this.getOperations();return`<div class="col-sm-4"><select id="param-op-${this.id}" ng-model="param.operation" ng-init="param.operation='${this.defaultOperation}'" class="form-control" onchange="$('#param-${this.id}').data('param').change();$('#rep-param-id-${this.id}')[0].focus()">\n  ${e}\n  </select></div>`}template(){let e="";return this.operation||(e=this.operationTemplate()),`<div id="param-${this.id}" class="row form-group" data-param="${this.name}" ng-controller="ParamController"><label class="control-label">${this.label}</label>${e}<div id="param-widget-${this.id}"></div></div>`}render(e){return this.el=this.params.scope.compile(this.template())(this.params.scope),this.el.data("param",this),console.log("render param"),this.createControls(this.el.scope()),e.append(this.el)}}katrid.ui.ngKatrid.controller("ReportController",["$scope","$element","$compile",function(e,t,s){const a=e.$parent.action.info.content,r=new i(e.$parent.action,e);return e.report=r,r.loadFromXml(a),r.render(t),r.loadParams()}]),katrid.ui.ngKatrid.controller("ReportParamController",["$scope","$element",function(e,t){return e.$parent.param.el=t,e.$parent.param.scope=e,e.$parent.param.setOperation(e.$parent.param.operation,!1)}]);katrid.reports={Reports:t,Report:i,Param:a}}(),(()=>{let e=e=>{let t=0;return console.log(e),e.find("button").each((i,s)=>{let a=(s=$(s)).attr("type");if(s.attr("type")&&"object"!==s.attr("type")||s.attr("type","button"),"object"===a){let i=s.attr("send-file");if(s.attr("button-object",s.attr("name")),_.isUndefined(i))s.attr("ng-click",`action.formButtonClick(action.selection, '${s.attr("name")}', $event.target);$event.stopPropagation();`);else{let i=`__send_file_${++t}`;e.append(`<input id="${i}" type="file" style="display: none" onchange="katrid.Services.Upload.sendFile('${s.attr("name")}', this)"/>`),s.attr("send-file",s.attr("name")),s.attr("onclick",`$('#${i}').trigger('click')`)}}else"tag"===a&&(s.attr("button-tag",s.attr("name")),s.attr("onclick","katrid.actions.ClientAction.tagButtonClick($(this))"));s.attr("class")||s.addClass("btn btn-outline-secondary")})};katrid.ui.ngKatrid.directive("toolbar",class extends katrid.ui.Component{constructor(){super(),this.scope=!1,this.restrict="E",this.replace=!0,this.transclude=!0,this.templateUrl="view.header.jinja2"}});class t{constructor(e){this.scope=e}render(){return katrid.app.getTemplate(this.templateUrl)}}class i extends t{constructor(e,t,i,s){super(t),this.action=e,this.view=i,this.templateUrl="view.basic",this.toolbar=!0,this.content=s}getTemplateContext(){return{content:this.content}}render(){return sprintf(katrid.app.getTemplate(this.templateUrl),this.getTemplateContext())}renderTo(e){katrid.core.setContent(this.render(),this.scope)}}class s extends i{getBreadcrumb(){let e='<ol class="breadcrumb">',t=0;for(let i of katrid.app.actionManager)0===t&&i.viewModes.length>1&&(e+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(0, 0)">${i.info.record_name}</a></li>`),t++,katrid.actions.actionManager.length>t&&"form"===i.viewType&&(e+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(${t-1}, 'form')">${i.scope.record.record_name}</a></li>`);return"form"===this.constructor.type&&(e+='<li class="breadcrumb-item">{{ self.record_name }}</li>'),e+"</ol>"}render(){return sprintf(katrid.app.$templateCache.get(this.templateUrl),{content:this.content})}getViewButtons(){let e=Object.entries(s.buttons).map(e=>this.view.viewModes.includes(e[0])?e[1]:"").join("");return e&&(e=`<div class="btn-group">${e}</div>`),e}}class a{constructor(e,t){this.viewType=null,this.action=e,this.viewInfo=t,this.templateUrl=null}renderTo(e){e.html(this.render(e))}get fields(){return this.viewInfo.fields}renderField(e){let t=e.attr("name");if(t){let i=this.fields[t];if(i){let t=i.render(this.viewType,e,{view:this}).toString();return i.visible?t:""}console.error(`Field "${t}" not found`)}}}class r extends a{constructor(e,t,i){super(e,t),this.dialog=!1,this.viewType="form",this.templateUrl="view.form.jinja2",this.context={},i&&(this.dialog=i.dialog,i.templateUrl&&(this.templateUrl=i.templateUrl),i.context&&Object.assign(this.context,i.context))}render(t){let i=$(this.viewInfo.content);i.attr("smart-form","smart-form"),i.addClass("row"),e(i);let s=i.find("header:first"),a="";s.length&&(s.find("field[name=status]:first").attr("status-field","status-field"),a=s.html(),s.remove());for(let e of i.find("field"))void 0===(e=$(e)).attr("invisible")&&(e.parents("field").length||(e.attr("form-field","form-field"),e.replaceWith(this.renderField(e))));let r={};Object.assign(r,this.context),Object.assign(r,{header:a,content:i[0].outerHTML}),this.dialog||(r.breadcrumb=this.breadcrumb);let n=katrid.app.getTemplate(this.templateUrl,r);return n=$(n),(n=katrid.core.$compile(n)(this.action.scope)).addClass("ng-form"),this.action&&(this.action.$form=n.find("form").first(),this.action.form=angular.element(this.action.$form).controller("form")),n}}class n extends a{constructor(...e){super(...e),this.viewType="list",this.templateUrl="view.list.jinja2",this.action.view=this}render(t){let i=$(this.viewInfo.content);Object.assign({},this.context),e(i);let s=i.find("header:first"),a="";s.length&&(a=s.html(),s.remove());let r=katrid.app.getTemplate(this.templateUrl,{header:a,content:i[0].outerHTML});return(r=$(r)).find("list").attr("ng-row-click","action.listRowClick($index, record, $event)").attr("list-options",'{"rowSelector": true}').attr("ng-row-click","action.listRowClick($index, record, $event)"),r=katrid.core.$compile(r)(this.action.scope),setTimeout(()=>this.action.dataSource.open()),r}}katrid.ui.ngKatrid.directive("listView2",()=>({scope:!1,link(e,t){t.find("header").find("button").length||t.find("header").remove()},template(t){console.log("compile template"),e(t);let i=t.find("header").first(),s="";return i.find("button").length&&i.length&&(s=i.html(),i.remove()),t.find("list").attr("list-options",'{"rowSelector": true}').attr("ng-row-click","action.listRowClick($index, record, $event)"),sprintf(katrid.app.getTemplate("view.list").replace("\x3c!-- replace-header --\x3e",s),{content:t.html()})}})).directive("card2",()=>({replace:!0,template:e=>(e.children("field").remove(),e.find("field").each((e,t)=>$(t).replaceWith(`{{ ::record.${$(t).attr("name")} }}`)),sprintf(katrid.app.getTemplate("view.card"),{content:e.html()}))})).directive("smartForm",()=>({restrict:"A",link(e,t,i){"edit"in i&&i.$observe("edit",e=>{"false"===e?$(".action-view:first").find(".toolbutton-action-edit").hide():$(".action-view:first").find(".toolbutton-action-edit").show()})}})),katrid.ui.views={View:s,BaseView:t,ActionView:i,FormView:r,ClientView:class{constructor(e){this.action=e}get template(){return katrid.app.getTemplate(this.templateUrl)}render(){return $(this.template)}},List:n,searchModes:["list","card"]},katrid.ui.views.list=n,katrid.ui.views.form=r,katrid.ui.views.card=class extends a{constructor(...e){super(...e),this.viewType="card",this.templateUrl="view.card.jinja2",this.action.view=this}render(e){let t=$(this.viewInfo.content);t.children("field").remove(),t.find("field").each((e,t)=>$(t).replaceWith(`\${ ::record.${$(t).attr("name")} }`));let i=katrid.app.getTemplate(this.templateUrl,{content:t[0].outerHTML});return i=$(i),i=katrid.core.$compile(i)(this.action.scope),setTimeout(()=>this.action.dataSource.open()),i}}})(),function(){katrid.ui.ViewInfo=class{constructor(e){this._info=e,this.fields=e.fields,this.content=e.content,this.toolbar=e.toolbar}}}(),function(){katrid.ui.ngKatrid.directive("grid",["$compile",class{constructor(e){this.restrict="E",this.scope={},this.$compile=e}async loadViews(e,t,i,s){let a=await e.model.loadViews(),r=a.views.list.fields[e.field.field];e.dataSource.field=e.field,r&&(r.visible=!1);let n=a.views;for(let[e,t]of Object.entries(i))n[e].content=t;e.views=n,e.view=n.list;let o=$(e.view.content);e.inline?o.attr("ng-row-click","editItem($event, $index)").attr("inline-editor",e.inline):o.attr("ng-row-click","openItem($event, $index)"),o.attr("records","records"),o.attr("list-options",'{"deleteRow": true}');let l=this.$compile(o)(e);t.html(l),t.prepend(this.$compile(katrid.app.getTemplate("view.form.grid.toolbar.jinja2",{attrs:s}))(e)),t.find("table").addClass("table-bordered grid")}async showDialog(e,t,i){if(e.views.form&&await this.renderDialog(e,t),null!=i){e.recordIndex=i;let t=e.records[i];t&&t.$loaded?e.record=t:t&&((await e.dataSource.get(e.records[i].id,0,!1,i)).$loaded=!0)}}async link(e,t,i){i.ngDefaultValues&&(e.ngDefaultValues=i.ngDefaultValues);const s=e.$parent.view.fields[i.name];e.totalDisplayed=1e3,e.fieldName=i.name,e.field=s,e.records=[],e.recordIndex=-1,e._cachedViews={},e._=e.$parent._,e._changeCount=0,e.dataSet=[],e.model=new katrid.Services.Model(s.model),e.isList=!0,"tabular"===i.inlineEditor?e.inline="tabular":i.hasOwnProperty("inlineEditor")&&(e.inline="inline"),e.getContext=function(){return{}},e.$setDirty=function(){return{}};let a=e.dataSource=new katrid.Data.DataSource(e);a.readonly=!_.isUndefined(i.readonly);let r=e.$parent;for(;r;){if(r.action&&r.action.dataSource){e.dataSource.masterSource=r.action.dataSource;break}if(r.dataSource){e.dataSource.masterSource=r.dataSource;break}r=r.$parent}e.parent=a.masterSource.scope,e.action=a.masterSource.action,a.action=e.action,e.dataSource.fieldName=e.fieldName,e.gridDialog=null;let n={};for(let e of t.children())if(e.tagName.startsWith("GRID:")){let t=e.tagName.split(":")[1].toLowerCase();e=$(e),n[t]=`<${t}>${e.html()}</${t}>`}function o(e){for(let t=(e=e.replace(/^\s+/,"")).length-1;t>=0;t--)if(/\S/.test(e.charAt(t))){e=e.substring(0,t+1);break}return e}await this.loadViews(e,t,n,i),e.doViewAction=((t,i,s)=>e.action._doViewAction(e,t,i,s)),e._incChanges=(()=>{e.$parent.$fieldLog[e.field.name]||(e.$parent.$fieldLog[e.field.name]={}),e.$parent.$fieldLog[e.field.name].count++}),e.addItem=(async()=>{if(await e.dataSource.insert(),!i.$attr.inlineEditor)return this.showDialog(e,i);e.records.splice(0,0,e.record),e.dataSource.edit(),e.$parent.record[e.fieldName]||(e.$parent.record[e.fieldName]=[]),e.$parent.record[e.fieldName].push(e.record),e.$apply()}),e.addRecord=function(t){let i=katrid.Data.createRecord({$loaded:!0},e.dataSource);for(let[e,s]of Object.entries(t))i[e]=s;e.records.push(i),e.dataSource.parent.record[e.fieldName]||(e.dataSource.parent.record[e.fieldName]=[]),e.dataSource.parent.record[e.fieldName].push(i)},e.cancelChanges=(()=>e.dataSource.setState(katrid.Data.DataSourceState.browsing)),e.openItem=(async(t,s)=>{await this.showDialog(e,i,s),e.dataSource.masterSource.changing&&!e.dataSource.readonly&&e.dataSource.edit(),e.$apply()}),e.editItem=((t,i)=>{e.dataSource.changing&&e.save(),e.$parent.dataSource.changing&&(e.dataSource.recordIndex=i,e.dataSource.edit(),setTimeout(()=>{let e=$(t.target).closest("td").find("input.form-control").focus();setTimeout(()=>e.select())},100))}),e.removeItem=function(t){const i=e.records[t];e.records.splice(t,1),e._incChanges(),i.$record.$delete()},e.$set=((t,i)=>{const s=e.form[t];s.$setViewValue(i),s.$render()}),e.save=function(){if(e._incChanges(),!e.inline){if(e.recordIndex>-1){let t=e.record;e.record=null,e.records.splice(e.recordIndex,1),setTimeout(()=>{e.records.splice(e.recordIndex,0,t),e.$apply()})}else-1===e.recordIndex&&e.records.push(e.record);e.inline||e.gridDialog.modal("toggle")}},e.pasteData=async function(){let t={},i=async function(i,s){return new Promise(async(a,r)=>{if(t[i.name]||(t[i.name]={}),void 0===t[i.name][s]){let a=await e.model.getFieldChoices(i.name,s,{exact:!0});a.items&&a.items.length?t[i.name][s]=a.items[0]:t[i.name][s]=null}a(t[i.name][s])})},s=[];for(let t of $(e.view.content).find("field")){let i=e.view.fields[$(t).attr("name")];i&&(_.isUndefined(i.visible)||i.visible)&&s.push(i)}let a=await navigator.clipboard.readText();for(let t of a.split(/\r?\n/))if(t){let a=0,r={};for(let e of t.split(/\t/)){let t=s[a];t instanceof katrid.Data.Fields.ForeignKey?r[t.name]=await i(t,o(e)):r[t.name]=o(e),a++}e.addRecord(r)}e.$apply()};let l=function(t,i,a){if(i===e.dataSource.masterSource)if(e.dataSet=[],e._changeCount=0,e.records=[],null!=a){const t={};if(t[s.field]=a,a)return e.dataSource.pageLimit=1e3,e.dataSource.search(t).then(t=>{e.$parent.$fieldLog[s.name]={count:0,value:t.data},e.$parent.record[s.name]=t.data,e.$apply()}).finally(()=>e.dataSource.state=katrid.Data.DataSourceState.browsing)}else e.$parent.record[s.name]=[]};e.dataSource.pendingMasterId&&l(0,e.dataSource.parent,e.dataSource.pendingMasterId);let c=[e.$on("masterChanged",l),e.$on("afterCancel",function(t,i){i===e.dataSource.masterSource&&e.dataSource.cancel()})];e.$on("$destroy",function(){c.map(e=>e())})}async renderDialog(e,t){let i,s=e.views.form.content;e.view=e.views.form;let a=e.views.form.fields[e.field.field];if(a&&(a.visible=!1),t.inline)i=me.$compile(s)(e),gridEl.find(".inline-input-dialog").append(i);else{let t=new katrid.UI.Views.FormView({scope:e},e.views.form,{dialog:!0,templateUrl:"view.field.OneToManyField.Dialog.jinja2",context:{field:e.field}});i=t.render()}return e.formElement=i.find("form:first"),e.form=e.formElement.controller("form"),e.gridDialog=i,t.inline||(i.modal("show"),i.on("hidden.bs.modal",function(){e.record=null,e.dataSource.state=katrid.Data.DataSourceState.browsing,i.remove(),e.gridDialog=null,e.recordIndex=-1,_destroyChildren()})),i.find(".modal-dialog").addClass("ng-form"),new Promise(function(e){i.on("shown.bs.modal",()=>e(i))})}}]).directive("list",["$compile",e=>({restrict:"E",scope:!1,compile(t,i){t.addClass("table-responsive");let s=i.ngRowClick,a=i.records||"groups",r=t.html(),n={};i.listOptions&&(n=JSON.parse(i.listOptions));let o=katrid.app.getTemplate("view.list.table.jinja2",{attrs:i,rowClick:s,options:n,records:a});return function(t,i,s,a){let l,c=$(o),d=c.find("tbody>tr:first"),h=c.find("thead>tr:first"),p=c.find("tfoot>tr:first"),u=s.ngTrClass;u=u?","+u:"",s.inlineEditor?(c.addClass("inline-editor"),l=$(t.views.form.content),d.attr("ng-form","grid-row-form-{{$index}}").attr("id","grid-row-form-{{$index}}")):d.attr("ng-class","{'group-header': record.$hasChildren, 'form-data-changing': (dataSource.changing && dataSource.recordIndex === $index), 'form-data-readonly': !(dataSource.changing && dataSource.recordIndex === $index)"+u+"}");let m,f,g=$("<div>").append(r),v=[],w=!1;for(let e of g.children("field")){let i=(e=$(e)).attr("name"),a=t.view.fields[i];if(a){a.assign(e);let r=e.attr("total");if(r?(w=!0,v.push({field:a,name:i,total:r})):v.push(!1),!a.visible)continue;let n=!1;l&&(n=l.find(`field[name="${i}"]`),n=$(n[0].outerHTML).attr("form-field","form-field").attr("inline-editor",s.inlineEditor)[0].outerHTML),f=$(a.render("list",e,{view:t.view})).first(),m=$(f).next()}else f="<th></th>",m=`<td>${e.html()}</td>`;d.append(m),h.append(f)}if(w)for(total of v)p.append(katrid.app.getTemplate("view.list.table.total.jinja2",{field:total.field}));else p.remove();if(n.deleteRow){let e=$(katrid.app.getTemplate("view.list.table.delete.jinja2"));for(let t of e)"TD"===t.tagName?d.append(t):"TH"===t.tagName&&h.append(t);w&&p.append('<td class="list-column-delete" ng-show="dataSource.parent.changing && !dataSource.readonly"></td>')}i.html(""),i.append(e(c)(t))}}})])}(),katrid.ui.ngKatrid.filter("numberFormat",()=>(e,t=3)=>null==e?"":new Intl.NumberFormat("pt-br",{maximumSignificantDigits:t}).format(e)),function(){let e={"=":katrid.i18n.gettext("Is equal"),"!=":katrid.i18n.gettext("Is different"),">":katrid.i18n.gettext("Greater-than"),"<":katrid.i18n.gettext("Less-than")},t={"=":"","!=":"__isnot",like:"__icontains","not like":"__not_icontains",">":"__gt",">=":"__gte","<":"__lt","<=":"__lte",in:"__in","not in":"__not_in"};class i{constructor(e){this.searchView=e,this.items=[],this.groups=[]}add(e){this.items.includes(e)?(e.facet.addValue(e),e.facet.refresh()):(this.items.push(e),this.searchView.renderFacets()),e instanceof p&&this.groups.push(e),this.searchView.change()}loadItem(e){this.items.push(e),e instanceof p&&this.groups.push(e)}remove(e){this.items.splice(this.items.indexOf(e),1),e instanceof p&&this.groups.splice(this.groups.indexOf(e),1),this.searchView.change()}getParams(){let e=[];for(let t of this.items)e=e.concat(t.getParamValues());return e}}class s{constructor(e){this.item=e,this.values=[]}get separator(){return` <span class="facet-values-separator">${katrid.i18n.gettext("or")}</span> `}init(e,t){this.item=e,this.values=t||[{searchString:this.item.getDisplayValue(),value:this.item.value}]}addValue(e){return this.values.push(e)}get caption(){return this.item.caption}clear(){this.values=[]}get templateValue(){return Array.from(this.values).map(e=>e instanceof c?e.display:e).join(this.separator)}link(e){const t=$(this.template());return this.item.facet=this,this.element=t,t.find(".facet-remove").click(t=>e.onRemoveItem(t,this.item)),t}refresh(){return this.element.find(".facet-value").html(this.templateValue())}load(e){e.query.loadItem(this.item),this.render(e)}destroy(){this.clear()}getParamValues(){const e=[];for(let t of this.values)e.push(this.item.getParamValue(t));return e.length>1?[{OR:e}]:e}}class a extends s{constructor(...e){super(...e),this.grouping=!0}clear(){let e=this.values;super.clear();for(let t of e)t._ref&&(t._ref._selected=!1)}get separator(){return" <span> &gt; </span> "}get caption(){return'<span class="fa fa-bars"></span>'}}class r{constructor(e,t,i){this.view=e,this.name=t,this.el=i}getDisplayValue(){return this.value?this.value[1]:this.searchString}getParamValue(e,t){const i={};return _.isArray(t)?i[e]=t[0]:i[e+"__icontains"]=t,i}_doChange(){this.view.update()}}class n extends r{constructor(e,t,i,s,a,r){super(e,t,r),this.group=a,this.caption=i,_.isString(s)&&(s=JSON.parse(s.replace(/'/g,'"'))),this.domain=s,this._selected=!1}static fromItem(e,t,i){return new n(e,t.attr("name"),t.attr("caption")||t.attr("label"),t.attr("domain"),i,t)}toString(){return this.caption}toggle(){this.selected=!this.selected}get selected(){return this._selected}set selected(e){this._selected=e,e?this.group.addValue(this):this.group.removeValue(this),this._doChange()}getDisplayValue(){return this.caption}get facet(){return this.group.facet}getParamValue(){return this.domain}get value(){return this.domain}}class o extends Array{constructor(e,t){super(),this.view=e,this._selection=[],t||(t=new s(this)),this._facet=t}static fromItem(e,t){let i=new o(e);return i.push(n.fromItem(e,t,i)),i}static fromGroup(e,t){let i=new o(e);for(let s of t.children())i.push(n.fromItem(e,$(s),i));return console.log(i),i}addValue(e){this._selection.push(e),this._facet.values=this._selection.map(e=>new c(e.toString(),e.value)),this._refresh()}removeValue(e){this._selection.splice(this._selection.indexOf(e),1),this._facet.values=this._selection.map(e=>({searchString:e.getDisplayValue(),value:e.value})),this._refresh()}selectAll(){for(let e of this)this.addValue(e);this.view.update()}get caption(){return'<span class="fa fa-filter"></span>'}_refresh(){this._selection.length?-1===this.view.facets.indexOf(this._facet)&&this.view.facets.push(this._facet):this.view.facets.indexOf(this._facet)>-1&&this.view.facets.splice(this.view.facets.indexOf(this._facet),1)}getParamValue(e){return e.value}clear(){this._selection=[]}}class l extends o{constructor(e,t){t||(t=new a),super(e,t)}static fromGroup(e){let t=e.view,i=e.el,s=e.facet||t.facetGrouping,a=new l(t,s);if(i)for(let e of i.children())a.push(p.fromItem(t,$(e),a));return a}addValue(e){this.view.groupLength++;let t=new c(e.toString(),e.value);t._ref=e,this._facet.values.push(t),this._refresh()}removeValue(e){this.view.groupLength--;for(let t of this._facet.values)if(t._ref===e){this._facet.values.splice(this._facet.values.indexOf(t),1);break}this._refresh()}_refresh(){this._facet.values.length?-1===this.view.facets.indexOf(this._facet)&&this.view.facets.push(this._facet):this.view.facets.indexOf(this._facet)>-1&&this.view.facets.splice(this.view.facets.indexOf(this._facet),1)}}class c{constructor(e,t){this.display=e,this.value=t}}class d{constructor(e,t){this.field=e,this.value=t,this.text=t[1],this.indent=!0}select(){this.field.selectItem(this.value)}}class h extends r{constructor(e,t,i,s){super(e,t,i),this.field=s,this._expanded=!1,"ForeignKey"===s.type?(this.expandable=!0,this.children=[]):this.expandable=!1}get expanded(){return this._expanded}set expanded(e){if(this._expanded=e,e)this._loadChildren();else if(this.children=[],this.view.$items)for(let e=this.view.$items.length-1;e>0;e--){this.view.$items[e].field===this&&this.view.$items.splice(e,1)}}_loadChildren(){this.loading=!0,this.view.scope.model.getFieldChoices(this.name,this.view.text).then(e=>{this.children=e.items;let t=this.view.$items.indexOf(this);if(t>-1)for(let e of this.children)t++,this.view.$items.splice(t,0,new d(this,e))}).finally(()=>this.view.scope.$apply(()=>this.loading=!1))}get facet(){return this._facet||(this._facet=new s(this)),this._facet}getDisplayValue(){return this.value}getParamValue(e){const t={};let i=this.name;if(_.isArray(e))t[i]=e[0];else{if(e instanceof c)return e.value;t[i+"__icontains"]=e}return t}get caption(){return this.field.caption}get value(){return this._value?this._value[1]:this.view.text}select(){this.facet.addValue(this.value),this.view.addFacet(this.facet),this.view.close(),this.view.update()}selectItem(e){let t={};t[this.field.name]=e[0],this.facet.addValue(new c(e[1],t)),this.view.addFacet(this.facet),this.view.close(),this.view.update()}static fromField(e,t){let i=e.view.fields[t.attr("name")];return new h(e,i.name,t,i)}get template(){return _.sprintf(katrid.i18n.gettext("Search <i>%(caption)s</i> by: <strong>%(text)s</strong>"),{caption:this.field.caption,text:this.view.text})}}class p extends n{constructor(e,t,i,s,a){super(e,t,a),this.group=s,this.caption=i,this._selected=!1}static fromItem(e,t,i){return new p(e,t.attr("name"),t.attr("caption"),i,t)}toString(){return this.caption}}katrid.ui.ngKatrid.controller("CustomFilterController",["$scope","$element","$filter",function(i,s,a){i.tempFilter=null,i.customFilter=[],i.fieldChange=function(e){i.field=e,i.condition=e.defaultCondition,i.conditionChange(i.condition)},i.conditionChange=(e=>{i.controlVisible=i.field.isControlVisible(e)}),i.valueChange=(e=>{i.searchValue=e}),i.addCondition=((s,a,r)=>{i.tempFilter||(i.tempFilter=new o(i.$parent.search)),i.tempFilter.push(new class extends n{constructor(e,t,i,s,a){super(e,t.name,t.caption,null,a),this.field=t,this.condition=i,this._value=s,this._selected=!0}toString(){let t=this.field.format(this._value);return this.field.caption+" "+e[this.condition].toLowerCase()+' "'+t+'"'}get value(){let e={};return e[this.field.name+t[this.condition]]=this._value,e}}(i.$parent.search,s,a,r,i.tempFilter)),i.field=null,i.condition=null,i.controlVisible=!1,i.searchValue=void 0}),i.applyFilter=(()=>{i.searchValue&&i.addCondition(i.field,i.condition,i.searchValue),i.customFilter.push(i.tempFilter),i.tempFilter.selectAll(),i.tempFilter=null,i.customSearchExpanded=!1})}]).directive("customFilter",()=>({restrict:"A",scope:{action:"="}}));class u{constructor(e,t,s){if(this.scope=e,this.element=t,this.query=new i(this),this._viewMoreButtons="true"===localStorage.getItem("katrid.search.viewMoreButtons"),this.items=[],this.fields=[],this.filterGroups=[],this.groups=[],this._groupLength=this.groupLength=0,this.facets=[],this.input=t.find(".search-view-input"),this.view=s,this.$items=null,this.facetGrouping=new a,s){this.el=$(s.content),this.menu=t.find(".search-dropdown-menu.search-view-menu");for(let e of this.el.children()){let t,i=(e=$(e)).prop("tagName");if("FILTER"===i)t=o.fromItem(this,e),this.filterGroups.push(t);else{if("FILTER-GROUP"===i){t=o.fromGroup(this,e),this.filterGroups.push(t);continue}if("GROUP"===i){t=p.fromItem({view:this,el:e}),this.groups.push(t);continue}if("FIELD"===i){t=h.fromField(this,e),this.fields.push(t);continue}}console.log("obj",t),t&&this.append(t)}this.input.on("input",e=>this.input.val().length?this.show(e):this.close(e)).on("keydown",e=>{switch(e.which){case katrid.UI.keyCode.DOWN:this.move(1),e.preventDefault();break;case katrid.UI.keyCode.UP:this.move(-1),e.preventDefault();break;case katrid.UI.keyCode.ENTER:this.scope.$apply(()=>angular.element(this.menu.find("li.active a.search-menu-item")).scope().item.select(e));break;case katrid.UI.keyCode.BACKSPACE:""===this.input.val()&&(this.scope.$apply(()=>this.facets.splice(this.facets.length-1,1).map(e=>e.clear())),this.update())}}).on("blur",e=>(this.input.val(""),this.close()))}}addCustomGroup(e){this.customGroups||(this.customGroups=new l(this,this.facetGrouping),this.groups.push(this.customGroups));let t=new p(this,e.name,e.caption,this.customGroups);this.customGroups.push(t),t.selected=!0}set viewMoreButtons(e){this._viewMoreButtons!==e&&(this._viewMoreButtons=e,localStorage.setItem("katrid.search.viewMoreButtons",e))}get viewMoreButtons(){return this._viewMoreButtons}load(e){Object.entries(e).map((e,t)=>{let i=this.getByName(e[0]);i&&(i.selected=!0)})}getByName(e){for(let t of this.filterGroups)for(let i of t)if(i.name===e)return i;for(let t of this.items)if(t.name===e)return t}append(e){this.items.push(e)}addFacet(e){this.facets.includes(e)||this.facets.push(e)}first(){this.menu.find("li.active a.search-menu-item").removeClass("active"),this.menu.find("li:first").addClass("active")}remove(e){this.facets[e].destroy(),this.facets.splice(e,1),this.update()}getParams(){let e=[];for(let t of this.facets)t.grouping||(e=e.concat(t.getParamValues()));return e}dump(){let e=[];for(let t of this.facets)e.push(t);return e}move(e){const t=e>0;for(e=Math.abs(e);0!==e;){e--;let i=this.element.find(".search-view-menu li.active");i.length?(i.removeClass("active"),(i=t?i.next():i.prev()).addClass("active")):(i=t?this.element.find(".search-view-menu > li:first"):this.element.find(".search-view-menu > li:last")).addClass("active")}}update(){this.groupLength!==this._groupLength?(this._groupLength=this.groupLength,this.scope.action.applyGroups(this.groupBy(),this.getParams())):(this.scope.action.clearGroups(),this.scope.action.setSearchParams(this.getParams()))}groupBy(){return this.facetGrouping.values.map(e=>e._ref.name)}show(){let e=!1;this.$items||(this.$items=[].concat(this.fields),e=!0);for(let t of this.$items)t.expanded&&(t.expanded=!1,e=!0);e&&this.scope.$apply(),this.menu.show(),this.first()}close(){this.$items=null,this.menu.hide(),this.reset(),this.input.val("")}reset(){for(let e of this.fields)e&&e.children&&e.children.length&&(e.expanded=!1)}}class m{constructor(){this.retrict="E",this.templateUrl="view.search.jinja2",this.replace=!0,this.scope=!1}}katrid.ui.ngKatrid.controller("SearchMenuController",["$scope",function(e){}]),katrid.ui.ngKatrid.directive("searchView",m),katrid.ui.ngKatrid.directive("searchViewArea",class{constructor(){this.restrict="A",this.scope=!1}link(e,t,i){let s=e.action.views.search;e.action.searchView=new u(e,t,s),e.action.context.default_search&&e.action.searchView.load(e.action.context.default_search)}}),katrid.ui.views.SearchView=u,katrid.ui.views.SearchViewComponent=m}(),function(){let e=katrid.ui.ngKatrid,t=0;e.directive("formField2",["$compile",function(e){return{restrict:"A",priority:99,replace:!0,compile:(t,i)=>(function(i,s,a,r){let n=i.view.fields[a.name];if(_.isUndefined(n))throw Error('Invalid field name "'+a.name+'"');let o=n.template.form;if(n.assign(s),!n.visible)return void t.remove();let l=n.getAttributes(a),c={};l["ng-readonly"]&&(c["ng-readonly"]=l["ng-readonly"].toString()),a.ngShow&&(c["ng-show"]=a.ngShow),n.helpText&&(c.title=n.helpText);let d=s.html();o=katrid.app.getTemplate(o,{name:a.name,field:n,attrs:l,content:d,fieldAttributes:a,sectionAttrs:c}),o=e(o)(i),s.replaceWith(o);let h=o.find(".form-field");if(h.length){h=h[h.length-1];const e=o.controller("form");(r=angular.element(h).data().$ngModelController)&&e.$addControl(r)}})}}]),e.directive("inputField",()=>({restrict:"A",scope:!1,link(e,t,i){$(t).on("click",function(){$(this).select()})}})),e.directive("view",()=>({restrict:"E",template:(e,i)=>(t++,""),link(e,i,s){if(e.model)return i.attr("class",`view-form-${e.model.name.replace(new RegExp(".","g"),"-")}`),i.attr("id",`katrid-form-${t.toString()}`),i.attr("model",e.model),i.attr("name",`dataForm${t.toString()}`)}})),e.directive("ngSum",()=>({restrict:"A",priority:9999,require:"ngModel",link(e,t,i,s){const a=i.ngSum.split("."),r=a[0],n=a[1];return e.$watch(`record.$${r}`,function(t,i){if(t&&e.record){let t=0;e.record[r].map(e=>t+=parseFloat(e[n])),t.toString()!==s.$modelValue&&(s.$setViewValue(t),s.$render())}})}})),e.directive("ngEnter",()=>(e,t,i)=>t.bind("keydown keypress",t=>{13===t.which&&(e.$apply(()=>e.$eval(i.ngEnter,{$event:t})),t.preventDefault())})),e.directive("ngEsc",()=>(e,t,i)=>t.bind("keydown keypress",t=>{27===t.which&&(e.$apply(()=>e.$eval(i.ngEsc,{$event:t})),t.preventDefault())})),$.fn.modal&&($.fn.modal.Constructor.prototype._enforceFocus=function(){}),e.directive("ajaxChoices",["$location",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){const{multiple:a}=i,r=i.ajaxChoices;let n=i.field,o=null;const l={allowClear:!0,query(e){let t={args:[e.term],kwargs:{count:1,page:e.page,name_fields:i.nameFields&&i.nameFields.split(",")||null}};o&&clearTimeout(o),o=setTimeout(()=>{let s=new katrid.Services.Model(r);(s=n?s.getFieldChoices(n,e.term,t.kwargs):new katrid.Services.Model(i.modelChoices).searchName(t)).then(t=>{const i=t.items.map(e=>({id:e[0],text:e[1]})),s=e.page*katrid.settings.services.choicesPageLimit<t.count;return e.callback({results:i,more:s})})},400)},escapeMarkup:e=>e,initSelection(e,t){const i=s.$modelValue;if(i){if(a){const e=[];for(let t of Array.from(i))e.push({id:t[0],text:t[1]});return t(e)}return t({id:i[0],text:i[1]})}}};a&&(l.multiple=!0);const c=t.select2(l);t.on("$destroy",function(){return $(".select2-hidden-accessible").remove(),$(".select2-drop").remove(),$(".select2-drop-mask").remove()}),c.on("change",function(t){const i=c.select2("data");return s.$setDirty(),i&&(s.$viewValue=i),e.$apply()}),s.$render=(()=>{if(s.$viewValue)return t.select2("val",s.$viewValue)})}})]),e.directive("inputMask",()=>({restrict:"A",link(e,t,i){t.inputmask()}}));e.directive("inputDecimal",["$filter",class{constructor(e){this.restrict="A",this.require="ngModel",this.$filter=e}link(e,t,i,s){let a=i.inputDecimal,r={alias:"numeric",groupSeparator:".",unmaskAsNumber:!0,radixPoint:",",autoGroup:!0,digitsOptional:!1,placeholder:"0"};a&&(r.digits=parseInt(a)),t.inputmask(r),s.$parsers.push(e=>t.inputmask("unmaskedvalue")),s.$formatters.push(e=>(_.isNumber(e)?e=e.toFixed(r.digits).replace(".",","):_.isString(e)&&(e=e.replace(".",",")),e))}}]),e.filter("moment",()=>(function(e,t){return t?moment().format(t):moment(e).fromNow()})),e.directive("fileReader",()=>({restrict:"A",require:"ngModel",scope:{},link:(e,t,i,s)=>("image/*"===i.accept&&t.tag,t.bind("change",function(){const e=new FileReader;return e.onload=(e=>s.$setViewValue(e.target.result)),e.readAsDataURL(event.target.files[0])}))})),e.directive("dateInput",["$filter",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){let a=()=>{let e;e="date"===i.type?(new Date).toISOString().split("T")[0]:moment(new Date).format("YYYY-MM-DD HH:mm").replace(" ","T"),$(t).val(e),s.$setViewValue(e),r=!1},r=!0;t.focus(function(){""===$(this).val()&&(r=!0)}).keypress(function(e){"h"===e.key.toLowerCase()&&(a(),e.stopPropagation(),e.preventDefault())}).keydown(function(e){/\d/.test(e.key)&&""===$(this).val()&&r&&a()}),s.$formatters.push(function(e){if(e)return new Date(e)}),s.$parsers.push(function(e){if(_.isDate(e)){let t=moment.utc(e).format("YYYY-MM-DD");s.$modelValue&&(t+="T"+s.$modelValue.split("T",1)[1]);let i=moment.utc(t).format("YYYY-MM-DDTHH:mm:ss");return console.log("ret",e,t,i),i}})}})]),e.directive("timeInput",()=>({restrict:"A",require:"?ngModel",link(e,t,i,s){t.inputmask({regex:"([0-1]?[0-9]|2[0-4]):([0-5][0-9])",insertMode:!1}),t.on("focus",function(){setTimeout(()=>$(this).select())}),s.$parsers.push(function(e){let t=s.$modelValue.split("T",1)[0]+"T"+e;console.log("time parser",t,e,s.$viewValue);let i=moment.utc(t).format("YYYY-MM-DDTHH:mm:ss");return"Invalid date"===i&&(i=s.$modelValue),i}),s.$render=function(){let e=s.$modelValue;if(console.log("render",e),e)return t.val(moment.utc(e).format("HH:mm"))}}})),e.directive("cardDraggable",()=>({restrict:"A",link(e,t,i,s){let a={connectWith:i.cardDraggable,items:"> .sortable-item"};_.isUndefined(i.cardItem)||(a.receive=((e,t)=>{let i=angular.element(t.item.parent()).scope(),s=angular.element(t.item).scope();console.log(s),console.log(i);let a={};a.id=s.record.id,$.extend(a,i.group._domain),i.model.write([a]).then(e=>{console.log("write ok",e)})})),_.isUndefined(i.cardGroup)||(a.update=((i,s)=>{let a=[];$.each(s.item.parent().find(".card-group"),(e,t)=>{a.push($(t).data("id"))});let r=t.find(".card-group").first().data("group-name"),n=e.$parent.$parent.view.fields[r].model;katrid.Services.data.reorder(n,a).done(e=>{console.log(e)})})),t.sortable(a).disableSelection()}})),e.directive("uiTooltip",()=>({restrict:"A",link:(e,t,i)=>{$(t).tooltip({container:"body",delay:{show:200,hide:500}})}})),e.setFocus=(e=>{let t=$(e);t.data("select2")?t.select2("focus"):e.focus()}),e.directive("attachmentsButton",()=>({restrict:"A",scope:!1,link:(e,t)=>{let i;e.$parent.$watch("recordId",t=>{let s=new katrid.services.Model("ir.attachment",e);clearTimeout(i),i=setTimeout(()=>{s.search({params:{model:e.action.model.name,object_id:t},count:!1}).then(t=>{let i=null;t&&t.data&&(i=t.data),e.$apply(()=>e.attachments=i)})},1e3)})}})),e.directive("action",["$compile",e=>({restrict:"E",priority:99,link:(e,t,i)=>{console.log("define action",i.ngClick);let s=t.closest("div.data-form").find(".dropdown-menu-actions"),a=(i.name,`<li><a href="javascript:void(0)">${t.html()}</a></li>`),r=$(a);r.click(()=>{i.object&&e.model.rpc(i.object,[e.$parent.record.id])}),s.append(r),t.remove()}})])}(),function(){let e=0,t={BooleanField:3,DecimalField:3,FloatField:3,DateField:3,DateTimeField:3,IntegerField:3,SmallIntegerField:3,TimeField:3,CharField:3,OneToManyField:12};class i{static get tag(){return"input"}constructor(e,i,s,a){if(this.attrs=i,this.scope=e,this.templAttrs={},this.wAttrs={},this.field=s,this.element=a,this.content=a.html(),this.spanPrefix="",null!=s.depends&&s.depends.length&&e.dataSource.addFieldWatcher(s),i.ngShow&&(this.templAttrs["ng-show"]=i.ngShow),(i.ngReadonly||s.readonly)&&(this.templAttrs["ng-readonly"]=i.ngReadonly||s.readonly),s.attrs)for(let e of s.attrs){let t=s.attrs[e];(e.startsWith("container")||"ng-show"===e&&!i.ngShow)&&(this.templAttrs[e]=t)}i.ngFieldChange&&(this.wAttrs["ng-change"]=i.ngFieldChange);let r=i.cols;r||("CharField"===s.type&&s.max_length&&s.max_length<30&&(r=3),r||(r=t[s.type]||6)),this.col=r,this.classes=["form-field"],s.onchange&&e.$watch()}fieldChangeEvent(){}get caption(){return this.element.attr("label")||this.field.caption}renderTo(e,t=!1,i=""){let s=[];for(let[e,t]of Object.entries(this.templAttrs))s.push(e+'="'+t+'"');return t?`<${e} class="${i}" ${s.join("")}>${this.template(this.scope,this.element,this.attrs,this.field)}</${e}>`:`<${e} class="${this.field.type} section-field-${this.field.name} form-group" ${s.join("")}>`+this.template(this.scope,this.element,this.attrs,this.field)+`</${e}>`}get ngModel(){return`record.${this.field.name}`}get id(){return this._id||(this._id=++e),`katrid-input-${this._id.toString()}`}widgetAttrs(){let e;const t=this.wAttrs;if(this.field.required&&(t.required=null),t["ng-model"]=this.ngModel,this.field.attrs)for(let i of Object.keys(this.field.attrs))e=this.field.attrs[i],i.startsWith("container-")||"ng-show"===i||"ng-readonly"===i||(t[i]=e);if(!_.isUndefined(this.attrs.$attr))for(let i of Object.keys(this.attrs.$attr)){let s=this.attrs.$attr[i];s.startsWith("container-")||"ngShow"===i||"ngReadonly"===i||(e=this.attrs[i],s.startsWith("field-")?s=s.substr(6,s.length-6):"class"===s&&this.classes.push(e),t[s]=e)}return(null!=this.attrs.readonly||this.field.readonly)&&(t.readonly=""),this.classes&&(t.class=this.classes.join(" ")),t}_getWidgetAttrs(e,t,i,s){let a="";const r=this.widgetAttrs(e,t,i,s);for(let e in r){const t=r[e];a+=` ${e}`,(t||!1===t)&&(_.isString(t)&&t.indexOf('"')>-1?a+=`='${t}'`:a+=`="${t}"`)}return this.placeholder&&(a+=` placeholder="${this.placeholder}" `),a}innerHtml(){return""}labelTemplate(){const e=this.caption;return"placeholder"===this.attrs.nolabel?(this.placeholder=e,""):_.isUndefined(this.attrs.nolabel)?`<label for="${this.id}" class="form-label">${e}</label>`:""}get emptyText(){return this.inplaceEditor?"":"--"}get readOnlyClass(){return this.inplaceEditor||"::"===this.spanPrefix?"grid-field-readonly":"form-field-readonly"}spanTemplate(e,t,i,s){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}record.${this.field.name}.toString() || '${this.emptyText}' }}</span>`}widgetTemplate(){let e=`<${this.constructor.tag} id="${this.id}" name="${this.field.name}" ${this._getWidgetAttrs()}>`;const t=this.innerHtml();return t&&(e+=t+`</${this.constructor.tag}>`),e}template(){let e="",t=this.spanTemplate();this.inplaceEditor||(e=this.labelTemplate());let i=this.widgetTemplate();return"inline"===this.inline&&(i=`<div ng-if="dataSource.changing && dataSource.recordIndex === $index">${i}</div>`),`<div>${e}${t}${i}</div>`}link(e,t,i,s,a){if(a.depends)return(()=>{const t=[];for(let i of Array.from(a.depends))Array.from(e.dataSource.fieldChangeWatchers).includes(i)||(e.dataSource.fieldChangeWatchers.push(i),t.push(e.$watch(`record.${i}`,function(t,s){if(t!==s&&e.dataSource.changing)return e.model.onFieldChange(i,e.record).done(e.dataSource.onFieldChange)})));return t})()}th(){let e=`${this.field.type} list-column`,t=this.element.attr("label")||`{{view.fields.${this.field.name}.caption}}`;return`<th class="${e}" name="${this.field.name}"><span>${t}</span></th>`}_gridEditor(e){return this.renderTo("section",!0,e)}_tdContent(){return this.spanTemplate()}_td(e){let t;return this.inplaceEditor?t=this._gridEditor(e):(this.spanPrefix="::",t=this.spanTemplate()),`<td class="${e}">${t}</td>`}td(){return this.content?this.content:this._td(`${this.field.type} field-${this.field.name}`)}}class s extends i{static get tag(){return"input input-field"}constructor(){super(...arguments),this.classes.push("form-control")}get type(){return"text"}widgetTemplate1(){let e;e=this.constructor.tag.startsWith("input")?`<${this.tag} id="${attrs._id}" type="${type}" name="${attrs.name}" ${this._getWidgetAttrs(scope,el,attrs,field)}>`:`<${this.tag} id="${attrs._id}" name="${attrs.name}" ${this._getWidgetAttrs(scope,el,attrs,field)}>`;const t=this.innerHtml(scope,el,attrs,field);return t&&(e+=t+`</${this.tag}>`),e}widgetTemplate(){this.type;const e=this.attrs.icon;let t=`<${this.constructor.tag} id="${this.id}" type="${this.type}" name="${this.field.name}" ${this._getWidgetAttrs()}>`;if(e)return`<label class="prepend-icon"><i class="icon ${e}"></i>${t}</label>`;const i=this.innerHtml();return i&&(t+=i+`</${this.constructor.tag}>`),t}}class a extends s{widgetAttrs(){const e=super.widgetAttrs();return this.field.maxLength&&(e.maxlength=this.field.maxLength.toString()),e}}class r extends s{static get tag(){return"input decimal"}get type(){return Katrid.settings.ui.isMobile?"number":"text"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|number) || '${this.emptyText}' }}</span>`}}class n extends r{static get tag(){return'input decimal decimal-places="0"'}}class o extends s{static get tag(){return"select"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}view.fields.${this.field.name}.displayChoices[record.${this.field.name}] || '${this.emptyText}' }}</span>`}innerHtml(){return`<option ng-repeat="choice in view.fields.${this.field.name}.choices" value="{{choice[0]}}">{{choice[1]}}</option>`}}class l extends a{static get tag(){return"textarea"}}class c extends r{static get tag(){return Katrid.settings.ui.isMobile?"input":"input decimal"}get type(){return Katrid.settings.ui.isMobile?"number":"text"}spanTemplate(){let e=this.attrs.decimalPlaces||2;return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|number:${e}) || '${this.emptyText}' }}</span>`}_tdContent(){let e,t=this.element.attr("decimal-places");return t?e`number:${t}`:e=`numberFormat:${this.element.attr("max-digits")||6}`,`{{::record.${this.field.name}|${e} }}`}}class d extends c{spanTemplate(){let e=this.attrs.maxDigits,t="number";return e?t="numberFormat":e=this.attrs.decimalPlaces||2,`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|${t}:${e}) || '${this.emptyText}' }}</span>`}_tdContent(e){let t=this.element.attr("max-digits");return t?`<td class="${e}">{{::record.${this.field.name}|numberFormat:${t} }}${this._gridEditor()}</td>`:(t=2,`{{::record.${this.field.name}|number:${t} }}`)}}class h extends s{spanTemplate(){return`<span class="${this.readOnlyClass} bool-text">\n  {{${this.spanPrefix}record.${this.field.name} ? '${Katrid.i18n.gettext("yes")}' : '${Katrid.i18n.gettext("no")}'}}\n  </span>`}get type(){return"checkbox"}_td(e){return super._td("bool-text "+e)}widgetTemplate(){let e=super.widgetTemplate();return e=`<label class="checkbox" ng-show="dataSource.changing">${e}`,this.field.help_text?e+=this.field.help_text:e+=this.field.caption,e+="<i></i></label>"}labelTemplate(){return this.field.help_text?super.labelTemplate():`<label for="${this.id}" class="form-label form-label-checkbox"><span>${this.caption}</span>&nbsp;</label>`}}class p extends s{static get tag(){return"input file-reader"}get type(){return"file"}}class u extends p{static get tag(){return'input file-reader accept="image/*"'}spanTemplate(){return""}widgetTemplate(){let e=super.widgetTemplate(),t=this.attrs.ngEmptyImage||this.attrs.emptyImage&&"'"+this.attrs.emptyImage+"'"||"'/static/web/assets/img/no-image.png'";return e=`<div class="image-box image-field">\n  <img ng-src="{{ record.${this.field.name} || ${t} }}" />\n    <div class="text-right image-box-buttons">\n    <button class="btn btn-default" type="button" title="${Katrid.i18n.gettext("Change")}" onclick="$(this).closest('.image-box').find('input').trigger('click')"><i class="fa fa-pencil"></i></button>\n    <button class="btn btn-default" type="button" title="${Katrid.i18n.gettext("Clear")}" ng-click="record[this.field.name] = null"><i class="fa fa-trash"></i></button>\n    </div>\n      ${e}</div>`}}class m extends s{get type(){return"password"}spanTemplate(){return'<span class="form-field-readonly">*******************</span>'}}class f extends i{constructor(...e){super(...e),this.col=null}static get tag(){return"sortable-field"}get type(){return"hidden"}_td(e){return`<td onclick="event.preventDefault();event.stopPropagation();" class="list-column-sortable">${this.spanTemplate()}</td>`}th(){return`<th class="list-column-sortable" name="${this.field.name}"></th>`}spanTemplate(){return`<sortable-field id="${this.id}" name="${this.field.name}" ng-model="record.${this.field.name}"/>`}}Object.assign(this.katrid.ui.widgets,{Field:i,InputWidget:s,StringField:a,IntegerField:n,SelectionField:o,ForeignKey:class extends i{static get tag(){return"input foreignkey"}spanTemplate(){let e=!0;return(null!=this.attrs.allowOpen&&"false"===this.attrs.allowOpen||null==this.attrs.allowOpen&&this.field.attrs&&!1===this.field.attrs["allow-open"])&&(e=!1),!e||this.inList?`<span class="${this.readOnlyClass}"><a href="javascript:void(0)">{{ ${this.spanPrefix}record.${this.field.name}[1] || '${this.emptyText}' }}</a></span>`:`<span class="${this.readOnlyClass}"><a href="#/action/${this.field.model}/view/?id={{ ${this.spanPrefix}record.${this.field.name}[0] }}" ng-click="action.openObject('${this.field.model}', record.${this.field.name}[0], $event, '${this.field.caption}')">{{ ${this.spanPrefix}record.${this.field.name}[1] }}</a><span ng-if="!record.${this.field.name}[1]">--</span></span>`}get type(){return"hidden"}_tdContent(){return`{{record.${this.field.name}[1]}}`}},TextField:l,DecimalField:d,FloatField:c,DateField:class extends l{static get tag(){return"input date-input"}get type(){return"date"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|date:'${Katrid.i18n.gettext("yyyy-mm-dd").replace(/[m]/g,"M")}') || '${this.emptyText}' }}</span>`}_tdContent(e){return`{{::record.${this.field.name}|date:'${Katrid.i18n.gettext("yyyy-MM-dd")}'}}`}},DateTimeField:class extends l{static get tag(){return"input date-input"}get type(){return"datetime-local"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|date:'${Katrid.i18n.gettext("yyyy-MM-dd hh:mma")}') || '${this.emptyText}' }}</span>`}},TimeField:class extends s{get type(){return"time"}},BooleanField:h,OneToManyField:class extends i{static get tag(){return"grid"}spanTemplate(){return""}innerHtml(){return this.content}},ManyToManyField:class extends i{static get tag(){return"input foreignkey multiple"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}record.${this.field.name}|m2m }}</span>`}get type(){return"hidden"}},FileField:p,PasswordField:m,ImageField:u,SortableField:f,XmlField:class extends l{constructor(...e){super(...e),console.log("cols",this.cols)}},input:s,string:a,integer:n,selection:o,text:l,decimal:d,float:c,file:p,boolean:h,password:m,image:u,sortable:f})}(),function(){let e=katrid.ui.ngKatrid;e.controller("TabsetController",["$scope",function(e){const t=this,i=t.tabs=e.tabs=[];t.select=function(e){angular.forEach(i,function(t){t.active&&t!==e&&(t.active=!1,t.onDeselect())}),e.active=!0,e.onSelect()},t.addTab=function(e){i.push(e),1===i.length?e.active=!0:e.active&&t.select(e)},t.removeTab=function(e){const a=i.indexOf(e);if(e.active&&i.length>1&&!s){const e=a===i.length-1?a-1:a+1;t.select(i[e])}i.splice(a,1)};var s=void 0;e.$on("$destroy",function(){s=!0})}]),e.directive("tabset",()=>({restrict:"EA",transclude:!0,replace:!0,scope:{type:"@"},controller:"TabsetController",template:'<div class="tabset"><div class="clearfix"></div>\n  <div class="nav nav-{{type || \'tabs\'}}" ng-class="{\'nav-stacked\': vertical, \'nav-justified\': justified}" ng-transclude></div>\n  <div class="tab-content">\n    <div class="tab-pane" \n         ng-repeat="tab in tabs" \n         ng-class="{active: tab.active}"><div class="col-12"><div class="row" tab-content-transclude="tab"></div></div>    </div>\n  </div>\n</div>\n',link:(e,t,i)=>(e.vertical=!!angular.isDefined(i.vertical)&&e.$parent.$eval(i.vertical),e.justified=!!angular.isDefined(i.justified)&&e.$parent.$eval(i.justified))})),e.directive("tab",["$parse",e=>({require:"^tabset",restrict:"EA",replace:!0,template:'<a class="nav-item nav-link" href ng-click="select()" tab-heading-transclude ng-class="{active: active, disabled: disabled}">{{heading}}</a>',transclude:!0,scope:{active:"=?",heading:"@",onSelect:"&select",onDeselect:"&deselect"},controller(){},compile:(t,i,s)=>(function(t,i,a,r){t.$watch("active",function(e){e&&r.select(t)}),t.disabled=!1,a.disabled&&t.$parent.$watch(e(a.disabled),function(e){t.disabled=!!e}),t.select=function(){t.disabled||(t.active=!0)},r.addTab(t),t.$on("$destroy",function(){r.removeTab(t)}),t.$transcludeFn=s})})]),e.directive("tabHeadingTransclude",[()=>({restrict:"A",require:"^tab",link(e,t,i,s){e.$watch("headingElement",function(e){e&&(t.html(""),t.append(e))})}})]),e.directive("tabContentTransclude",function(){return{restrict:"A",require:"^tabset",link(e,t,i){const s=e.$eval(i.tabContentTransclude);s.$transcludeFn(s.$parent,function(e){angular.forEach(e,function(e){(e=>e.tagName&&(e.hasAttribute("tab-heading")||e.hasAttribute("data-tab-heading")||"tab-heading"===e.tagName.toLowerCase()||"data-tab-heading"===e.tagName.toLowerCase()))(e)?s.headingElement=e:t.append(e)})})}}})}(),function(){let e=katrid.ui.ngKatrid;e.directive("datePicker",["$filter",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){let a="99/99/9999",r=i.datePicker||"L";"L LT"===r&&(a="99/99/9999 99:99"),t.inputmask({mask:a,insertMode:!1});let n=$(t.parent()).datetimepicker({useCurrent:!1,format:r,icons:{time:"fa fa-clock"}}).on("dp.change",function(e){n.datetimepicker("hide")}).on("dp.hide",function(e){s.$setDirty(),s.$setViewValue(t.val())});t.on("focus",()=>t.select()),s.$render=function(){s.$modelValue?n.datetimepicker("date",moment.utc(s.$modelValue)):t.val("")},t.on("blur",()=>{let e=moment(t.val(),r);e.isValid()?s.$modelValue=e.format("YYYY-MM-DD"):s.$modelValue=null}),s.$parsers.push(e=>{let i=moment(t.val(),r);if(i.isValid()){if("L"===r)return i.format("YYYY-MM-DD");if("L LT"===r)return i.format("YYYY-MM-DD HH:mm")}return null})}})]),e.directive("timePicker",["$filter",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){t.inputmask({mask:"99:99",insertMode:!1}),t.on("focus",()=>t.select())}})])}(),function(){katrid.ui.ngKatrid.directive("comments",()=>({restrict:"E",scope:{},replace:!0,template:'<div class="content"><div class="comments"><mail-comments/></div></div>',link(e,t,i){t.closest(".modal-dialog").length?t.remove():$(t).closest(".form-view[ng-form=form]").children(".content:first").append(t)}})),katrid.ui.ngKatrid.directive("mailComments",()=>({restrict:"E",controller:["$scope",e=>{e.comments=new class{constructor(e){this.scope=e,this.model=this.scope.$parent.model,this.scope.$parent.$watch("recordId",e=>{this.items=null,this.scope.loading=katrid.i18n.gettext("Loading..."),clearTimeout(this._pendingOperation),this._pendingOperation=setTimeout(()=>(this._pendingOperation=null,this.masterChanged(e),this.scope.$apply(()=>this.scope.loading=null)),1e3)}),this.items=[]}async masterChanged(e){if(e){const e=new katrid.Services.Model("mail.message");if(this.scope.$parent.record)return e.post("get_messages",{args:[this.scope.$parent.record.messages]}).then(e=>{this.items=e,this.scope.$apply()})}}async _sendMesage(e,t){t&&(t=t.map(e=>e.id));let i=await this.model.post("post_message",{args:[[this.scope.$parent.recordId]],kwargs:{content:e,content_subtype:"html",format:!0,attachments:t}});this.scope.message="",this.items=i.concat(this.items),this.scope.$apply(),this.scope.files=null,this.scope.hideEditor()}postMessage(e){if(this.scope.files.length){let i=[];for(let e of this.scope.files)i.push(e.file);var t=this;katrid.Services.Attachments.upload({files:i},this.scope).done(i=>{t._sendMesage(e,i)})}else this._sendMesage(e)}}(e),e.files=[],e.showEditor=(()=>{$(e.el).find("#mail-editor").show(),$(e.el).find("#mail-msgEditor").focus()}),e.hideEditor=(()=>{$(e.el).find("#mail-editor").hide()}),e.attachFile=(t=>{for(let i of t.files)e.files.push({name:i.name,type:i.type,file:i});e.$apply()}),e.deleteFile=(t=>{e.files.splice(t,1)})}],replace:!0,link(e,t,i){e.el=t},template:()=>`\n  <div class="container">\n          <h3>${katrid.i18n.gettext("Comments")}</h3>\n          <div class="form-group">\n          <button class="btn btn-outline-secondary" ng-click="showEditor();">${katrid.i18n.gettext("New message")}</button>\n          <button class="btn btn-outline-secondary">${katrid.i18n.gettext("Log an internal note")}</button>\n          </div>\n          <div id="mail-editor" style="display: none;">\n            <div class="form-group">\n              <textarea id="mail-msgEditor" class="form-control" ng-model="message"></textarea>\n            </div>\n            <div class="form-group">\n              <button class="btn btn-default" type="button" onclick="$(this).next().click()"><i class="fa fa-paperclip"></i></button>\n              <input class="input-file-hidden" type="file" multiple onchange="angular.element(this).scope().attachFile(this)">\n            </div>\n            <div class="form-group" ng-show="files.length">\n              <ul class="list-inline attachments-area">\n                <li ng-repeat="file in files" ng-click="deleteFile($index)" title="${katrid.i18n.gettext("Delete this attachment")}">{{ file.name }}</li>\n              </ul>\n            </div>\n            <div class="from-group">\n              <button class="btn btn-primary" ng-click="comments.postMessage(message)">${katrid.i18n.gettext("Send")}</button>\n            </div>\n          </div>\n  \n          <hr>\n  \n          <div ng-show="loading">{{ loading }}</div>\n          <div class="comment media col-sm-12" ng-repeat="comment in comments.items">\n            <div class="media-left">\n              <img src="/static/web/assets/img/avatar.png" class="avatar rounded">\n            </div>\n            <div class="media-body">\n              <strong>{{ ::comment.author_name }}</strong> - <span class="timestamp text-muted" title="\${ ::comment.date_time|moment:'LLLL'}"> {{::comment.date_time|moment}}</span>\n              <div class="clearfix"></div>\n              <div class="form-group">\n                {{::comment.content}}\n              </div>\n              <div class="form-group" ng-if="comment.attachments">\n                <ul class="list-inline">\n                  <li ng-repeat="file in comment.attachments"><a href="/web/content/\${ ::file.id }/?download">{{ ::file.name }}</a></li>\n                </ul>\n              </div>\n            </div>\n          </div>\n    </div>`}));class e extends katrid.ui.Widget{static initClass(){this.prototype.tag="mail-comments"}spanTemplate(e,t,i,s){return""}}e.initClass(),katrid.ui.widgets.MailComments=e}(),katrid.ui.ngKatrid.directive("codeEditor",[function(){return{restrict:"EA",require:"ngModel",link:function(e,t,i,s){let a;require.config({paths:{vs:"/static/web/monaco/min/vs"}}),console.log("set language",i.language),require(["vs/editor/editor.main"],function(){(a=monaco.editor.create(t[0],{value:"",language:i.language||"xml",minimap:{enabled:!1},automaticLayout:!0})).getModel().onDidChangeContent(e=>{s.$setViewValue(a.getValue())}),s.$render=function(){setTimeout(()=>{a.setValue(s.$viewValue)},300)}})}}}]),function(){class e extends katrid.ui.views.BaseView{constructor(e,t){super(e),this.templateUrl="dialog.base",this.scope.isDialog=!0}render(){return $(Katrid.app.getTemplate(this.templateUrl).replace("\x3c!-- replace-content --\x3e",this.content))}show(){return this.el||(this.el=$(this.render()),this.root=this.el.find(".modal-dialog-body"),this.el.find("form").first().addClass("row"),this.$compile(this.el)(this.scope)),this.el.modal("show").on("shown.bs.modal",()=>Katrid.UI.uiKatrid.setFocus(this.el.find(".form-field").first())),this.el}}katrid.ui.dialogs={Alerts:class{static success(e){return toastr.success(e)}static warn(e){return toastr.warning(e)}static info(e){return toastr.info(e)}static error(e){return toastr.error(e)}},WaitDialog:class{static show(){$("#loading-msg").show()}static hide(){$("#loading-msg").hide()}},Dialog:e,Window:class extends e{constructor(e){super(e.scope,e),this.scope._=this.scope.$parent._,this.scope.parentAction=this.scope.action,this.scope.views={form:e.view},this.dialogTitle=e&&e.title||Katrid.i18n.gettext("Create: "),this.scope.view=this.view=e.view,this.scope.model=e.model,this.options=e}async createNew(e){let t=this.options.field;this.scope.$setDirty=(e=>{const t=this.scope.form[e];t&&t.$setDirty()});let i=this.scope.view,s=this.scope;s.views={form:i},s.isDialog=!0,this.dialogTitle,this.action=this.scope.action={scope:this.scope,context:{}};let a=this.action.dataSource=this.scope.dataSource=new Katrid.Data.DataSource(this.scope,this.action),r=new Katrid.UI.Views.FormView(this.action,this.view,{dialog:!0,templateUrl:"view.form.dialog.modal.jinja2"}).render(),n=r.find("form:first");if(s.root=n,this.action.$element=n,n.addClass("row"),r.modal("show").on("shown.bs.modal",()=>Katrid.UI.uiKatrid.setFocus(r.find(".form-field").first())).on("hidden.bs.modal",function(){$(this).modal("dispose").remove()}),this.scope.form=n.controller("form"),this.scope.formElement=n,t){let e=this.scope.$on("saveAndClose",async(i,s,a)=>{if(this.scope===s){if(_.isArray(a)&&a.length){let e={},i=(a=await this.scope.$parent.model.getFieldChoices(t.name,null,{ids:a})).items[0];e[t.name]=i,this.scope.$parent.action.dataSource.setValues(e),this.options.sel&&this.options.sel.select2("data",{id:i[0],text:i[1]})}e()}})}return new Promise(async(t,i)=>{setTimeout(async()=>{let i,s;e&&(e.creationName&&(i={creation_name:name}),e.defaultValues&&(s=e.defaultValues)),await a.insert(!0,s,i),this.scope.$apply(),t(r)})})}}}}(),katrid.ui.ngKatrid.directive("foreignkey",["$compile","$controller",(e,t)=>({restrict:"A",require:"ngModel",link(e,i,s,a){let r,n,o=i,l=!1;e.view&&e.view.fields&&(n=e.view.fields[s.name]),i.addClass("form-field"),r=s.serviceName?s:e.action&&e.action.model?e.action.model.name:s.foreignkey;const c=function(){},d=function(){};let h=null,p={allowClear:!0,query(t){let i;n&&n.domain&&(i=n.domain),i&&_.isString(i)&&(i=e.$eval(i));let a={args:[t.term],kwargs:{count:1,page:t.page,domain:i,name_fields:s.nameFields&&s.nameFields.split(",")||null}};h&&clearTimeout(h),h=setTimeout(()=>{let i;(i=e.model?e.model.getFieldChoices(n.name,t.term,a.kwargs):n?new katrid.services.Model(n.model).searchName(a):new katrid.services.Model(r).searchName(a)).then(e=>{const i=e.items.map(e=>({id:e[0],text:e[1]})),a=t.page*katrid.settings.services.choicesPageLimit<e.count;if(!m&&!a){let e;const t=o.data("select2").search.val();(s.allowCreate&&"false"!==s.allowCreate||null==s.allowCreate)&&t&&(e=katrid.i18n.gettext('Create <i>"%s"</i>...'),i.push({id:c,text:e}))}return t.callback({results:i,more:a})})},400)},ajax:{url:`/api/rpc/${r}/get_field_choices/`,contentType:"application/json",dataType:"json",type:"POST"},formatSelection:e=>e.id===c||e.id===d?katrid.i18n.gettext("Creating..."):e.text,formatResult(e){const t=o.data("select2").search.val();return e.id===c?(e.str=t,`<strong>${sprintf(e.text,t)}</strong>`):e.id===d?(e.str=t,`<strong>${sprintf(e.text,t)}</strong>`):e.text},initSelection(e,t){let i=a.$modelValue;return m?t(i=i.map(e=>({id:e[0],text:e[1]}))):_.isArray(i)?t({id:i[0],text:i[1]}):void 0}},u=s.noCreateEdit;u=_.isUndefined(u)||!Boolean(u);let{multiple:m}=s;return m&&(p.multiple=!0),o=o.select2(p),u&&n&&o.parent().find("div.select2-container>div.select2-drop").append(`<div style="padding: 4px;"><button type="button" class="btn btn-link btn-sm">${katrid.i18n.gettext("Create New...")}</button></div>`).find("button").click(()=>{o.select2("close");let i=new katrid.Services.Model(n.model);return i.getViewInfo({view_type:"form"}).then(function(s){let a=_.sprintf(katrid.i18n.gettext("Create: %(title)s"),{title:n.caption}),r={scope:e.$new(!0),$controller:t,sel:o,field:n,title:a,view:s,model:i,action:e.action};new katrid.UI.Dialogs.Window(r).createNew()})}),o.on("change",async i=>{console.log("on change",i.val);let s=i.added;if(s&&s.id===c){let i=new katrid.Services.Model(n.model);try{let a=await i.createName(s.str),r={};r[n.name]=a,e.dataSource.setValues(r),o.select2("data",{id:a[0],text:a[1]})}catch(a){let r=await i.getViewInfo({view_type:"form"}),l=_.sprintf(katrid.i18n.gettext("Create: %(title)s"),{title:n.caption}),c={scope:e.$new(!0),$controller:t,sel:o,field:n,title:l,view:r,model:i,action:e.action};new katrid.UI.Dialogs.Window(c).createNew({creationName:s.str}),o.select2("data",null)}}else if(!s||s.id!==d)return m&&i.val.length?a.$setViewValue(i.val):(a.$setDirty(),s?a.$setViewValue([s.id,s.text]):a.$setViewValue(null))}).on("select2-open",()=>{if(!l){l=!0;let e=i.closest("div.modal");e.length&&e.on("hide.bs.modal",()=>o.select2("destroy"))}}),a.$parsers.push(e=>e?_.isArray(e)?e:_.isObject(e)?[e.id,e.text]:e:null),m||e.$watch(s.ngModel,(e,t)=>o.select2("val",e)),a.$render=function(){if(!m)return a.$viewValue?o.select2("val",a.$viewValue[0]):o.select2("val",null);a.$modelValue&&(Array.from(a.$modelValue).map(e=>e[0]),o.select2("val",a.$modelValue))}}})]),katrid.ui.ngKatrid.filter("m2m",()=>(function(e){if(_.isArray(e))return e.map(e=>e?e[1]:null).join(", ")})),katrid.ui.ngKatrid.directive("statusField",["$compile",e=>({restrict:"A",priority:1,replace:!0,link(e,t,i,s){const a=e.view.fields[i.name];e.choices=a.choices,i.readonly||(e.itemClick=(()=>console.log("status field item click"))),t.closest("header").prepend(t)},template:(e,t)=>sprintf(katrid.app.$templateCache.get("view.field.StatusField"),{fieldName:t.name})})]),katrid.ui.ngKatrid.directive("sortableField",["$compile","$timeout",(e,t)=>({restrict:"E",require:"ngModel",replace:!0,scope:{},link:{post:function(e,t,i){t.closest("tbody").sortable({helper:function(e,t){let i=t.children(),s=t.clone();return s.children().each(function(e){$(this).width(i.eq(e).width())}),s},stop:function(e,t){$("td.list-column-sortable",t.item.parent()).each(function(e){})}}).disableSelection()}},template:(e,t)=>sprintf(katrid.$templateCache.get("view.field.SortableField"),{fieldName:t.name})})]),function(e){"use strict";function t(e,t){if(this.createTextRange){var i=this.createTextRange();i.collapse(!0),i.moveStart("character",e),i.moveEnd("character",t-e),i.select()}else this.setSelectionRange&&(this.focus(),this.setSelectionRange(e,t))}function i(e){var t=this.value.length;if(e="start"==e.toLowerCase()?"Start":"End",document.selection){var i,s,a,r=document.selection.createRange();return(i=r.duplicate()).expand("textedit"),i.setEndPoint("EndToEnd",r),a=(s=i.text.length-r.text.length)+r.text.length,"Start"==e?s:a}return void 0!==this["selection"+e]&&(t=this["selection"+e]),t}var s={codes:{188:44,110:44,108:44,109:45,190:46,191:47,192:96,220:92,222:39,221:93,219:91,173:45,187:61,186:59,189:45},shifts:{96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"}};e.fn.number=function(a,r,n,o){o=void 0===o?",":o,n=void 0===n?".":n,r=void 0===r?0:r;var l="\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4),c=new RegExp("[^-"+l+"0-9]","g"),d=new RegExp(l,"g");return!0===a?this.is("input:text")?this.on({"keydown.format":function(a){var l=e(this),h=l.data("numFormat"),p=a.keyCode?a.keyCode:a.which,u="",m=i.apply(this,["start"]),f=i.apply(this,["end"]),g="",v=!1;if("-"===a.key)return 0===l.val()?h.negative=!0:(h.negative=!1,this.value.includes("-")?this.value=this.value.substr(1,this.value.length-1):this.value="-"+this.value),l.val(this.value),void a.preventDefault();if(s.codes.hasOwnProperty(p)&&(p=s.codes[p]),!a.shiftKey&&p>=65&&p<=90?p+=32:!a.shiftKey&&p>=69&&p<=105?p-=48:a.shiftKey&&s.shifts.hasOwnProperty(p)&&(u=s.shifts[p]),""==u&&(u=String.fromCharCode(p)),8!==p&&u!=n&&!u.match(/[0-9]/)){var $=a.keyCode?a.keyCode:a.which;if(46==$||8==$||9==$||27==$||13==$||(65==$||82==$)&&!0===(a.ctrlKey||a.metaKey)||(86==$||67==$)&&!0===(a.ctrlKey||a.metaKey)||$>=35&&$<=39)return;return a.preventDefault(),!1}if(0==m&&f==this.value.length||0==l.val()?8===p?(m=f=1,this.value="",h.init=r>0?-1:0,h.c=r>0?-(r+1):0,t.apply(this,[0,0])):u===n?(m=f=1,this.value="0"+n+new Array(r+1).join("0"),h.init=r>0?1:0,h.c=r>0?-(r+1):0):0===this.value.length&&(h.init=r>0?-1:0,h.c=r>0?-r:0):h.c=f-this.value.length,r>0&&u==n&&m==this.value.length-r-1)h.c++,h.init=Math.max(0,h.init),a.preventDefault(),v=this.value.length+h.c;else if(u==n)h.init=Math.max(0,h.init),a.preventDefault();else if(r>0&&8==p&&m==this.value.length-r)a.preventDefault(),h.c--,v=this.value.length+h.c;else if(r>0&&8==p&&m>this.value.length-r){if(""===this.value)return;"0"!=this.value.slice(m-1,m)&&(g=this.value.slice(0,m-1)+"0"+this.value.slice(m),l.val(g.replace(c,"").replace(d,n))),a.preventDefault(),h.c--,v=this.value.length+h.c}else 8==p&&this.value.slice(m-1,m)==o?(a.preventDefault(),h.c--,v=this.value.length+h.c):r>0&&m==f&&this.value.length>r+1&&m>this.value.length-r-1&&isFinite(+u)&&!a.metaKey&&!a.ctrlKey&&!a.altKey&&1===u.length&&(g=f===this.value.length?this.value.slice(0,m-1):this.value.slice(0,m)+this.value.slice(m+1),this.value=g,v=m);!1===v&&44===p&&u===n&&(v=this.value.indexOf(n)+1),!1!==v&&t.apply(this,[v,v]),l.data("numFormat",h)},"keyup.format":function(s){var a,n=e(this),o=n.data("numFormat"),l=s.keyCode?s.keyCode:s.which,c=i.apply(this,["start"]);""===this.value||(l<48||l>57)&&(l<96||l>105)&&8!==l||(n.val(n.val()),r>0&&(o.init<1?(c=this.value.length-r-(o.init<0?1:0),o.c=c-this.value.length,o.init=1,n.data("numFormat",o)):c>this.value.length-r&&8!=l&&(o.c++,n.data("numFormat",o))),a=this.value.length+o.c,this.value.length-a===o.decimals&&String.fromCharCode(l)!==o.dec_point&&(a-=1,console.log("set pos",o.dec_point,l,String.fromCharCode(l))),t.apply(this,[a,a]))},"paste.format":function(t){var i=e(this),s=t.originalEvent,a=null;return window.clipboardData&&window.clipboardData.getData?a=window.clipboardData.getData("Text"):s.clipboardData&&s.clipboardData.getData&&(a=s.clipboardData.getData("text/plain")),i.val(a),t.preventDefault(),!1}}).each(function(){var t=e(this).data("numFormat",{c:-(r+1),decimals:r,thousands_sep:o,dec_point:n,regex_dec_num:c,regex_dec:d,init:!1});""!==this.value&&t.val(t.val())}):this.each(function(){var t=e(this),i=+t.text().replace(c,"").replace(d,".");t.number(isFinite(i)?+i:0,r,n,o)}):this.text(e.number.apply(window,arguments))};var a=null,r=null;e.isPlainObject(e.valHooks.text)?(e.isFunction(e.valHooks.text.get)&&(a=e.valHooks.text.get),e.isFunction(e.valHooks.text.set)&&(r=e.valHooks.text.set)):e.valHooks.text={},e.valHooks.text.get=function(t){var i,s=e(t).data("numFormat");return s?""===t.value?"":(i=+t.value.replace(s.regex_dec_num,"").replace(s.regex_dec,"."),""+(isFinite(i)?i:0)):e.isFunction(a)?a(t):void 0},e.valHooks.text.set=function(t,i){var s=e(t).data("numFormat");return s?t.value=e.number(i,s.decimals,s.dec_point,s.thousands_sep):e.isFunction(r)?r(t,i):void 0},e.number=function(e,t,i,s){s=void 0===s?",":s,i=void 0===i?".":i,t=isFinite(+t)?Math.abs(t):0;var a="\\u"+("0000"+i.charCodeAt(0).toString(16)).slice(-4),r="\\u"+("0000"+s.charCodeAt(0).toString(16)).slice(-4);e=(e+"").replace(".",i).replace(new RegExp(r,"g"),"").replace(new RegExp(a,"g"),".").replace(new RegExp("[^0-9+-Ee.]","g"),"");var n=isFinite(+e)?+e:0,o="";return(o=(t?function(e,t){var i=Math.pow(10,t);return""+Math.round(e*i)/i}(n,t):""+Math.round(n)).split("."))[0].length>3&&(o[0]=o[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,s)),(o[1]||"").length<t&&(o[1]=o[1]||"",o[1]+=new Array(t-o[1].length+1).join("0")),o.join(i)}}(jQuery),function(){katrid.ui.ngKatrid.directive("ngTotal",["$filter",class{constructor(e){this.restrict="E",this.scope=!1,this.replace=!0,this.$filter=e}template(e,t){return"'"===t.expr[0]?`<span>${t.expr.substring(1,t.expr.length-1)}</span>`:`<span ng-bind="total$${t.field}|number:2"></span>`}link(e,t,i,s){"'"!==i.expr[0]&&e.$watch("records",t=>{let s=0;t.map(e=>s+=parseFloat(e[i.field])),e["total$"+i.field]=s,e.parent["total$"+e.fieldName+"$"+i.field]=s})}}])}(),function(){let e=function(e,t,i){let s=[],a=(e[0],[]),r={},n=0;for(let s of t){let o=[];0===n&&o.push(t[0]);for(let l of e){let e=l[s];if(n>0&&!(e in r)){o=[e],r[e]=o;for(let e of a)o.push(0)}else n>0&&(o=r[e]);n>0?o[a.indexOf(l[t[0]])]=l[i||"total"]||0:o.includes(e)||o.push(e)}0===n&&(a=o,r[t[0]]=o),n++}return s=Object.values(r),console.log(s),s};katrid.actions.ClientAction.register("dashboard",class extends katrid.ui.views.ClientView{async render(){let e=new katrid.Services.Model("ir.action.client"),t=await e.rpc("get_view",[this.action.info.id]);if(t.content)return katrid.Core.$compile(t.content)(this.action.scope)}}),katrid.ui.ngKatrid.directive("dashboard",["$compile",class extends katrid.ui.Component{constructor(e){super(),this.$compile=e,this.restrict="E",this.scope=!1}async link(e,t,i,s){i.dashboardId}}]),katrid.ui.ngKatrid.directive("chart",class extends katrid.ui.Component{constructor(){super()}async link(t,i,s){let a,r,n,o,l=i.find("query");l.length&&(l.remove(),n=l.text()),console.log("init chart"),s.groups&&(o=s.groups.split(","));let c=async l=>{let c=(a=n?await katrid.Services.Query.executeSql(n):s.source?t[s.source]:await fetch(l).then(e=>e.json())).data;console.log(s);let d={bindto:i[0],data:{},color:{pattern:katrid.UI.Dashboard.colorPatterns}},h=!1,p=i.attr("type");if(p&&(d.data.type=p),o){c=e(c,o);let t=[];for(let e=1;e<c.length;e++)t.push(c[e][0]);h=!0}else if(_.isArray(c)&&c.length){let e=Object.keys(c[0]);d.data.columns=c.map(t=>[t[e[0]],t[e[1]]]),h=!0}h&&(r=c3.generate(d))};s.urlParams?(s.urlParams,t.$watch(s.urlParams,c)):s.source?t.$watch(s.source+".data",c):c(),s.$observe("url",c)}}),katrid.ui.ngKatrid.directive("query",class extends katrid.ui.Component{constructor(){super(),this.priority=200,this.scope=!1}link(e,t,s){new i(t,e),t.remove()}});class t{constructor(e){this.el=e}th(){let e=this.el.attr("caption")||this.el.attr("name"),t=this.el.attr("class"),i=this.el.attr("header-title"),s="";i||(i="");let a=this.el.attr("on-header-click");return t&&(s+='class ="'+t+'"'),a&&(s+=' ng-click="'+a+'"'),`<th title="${i}" ${s}>${e}</th>`}td(){let e=this.el.attr("format");e?(e="|"+e,console.log("format",e)):e="";let t=this.el.attr("title");t||(t="");this.el.attr("ng-class");let i=this.el[0].className,s=this.el.html();return s||(s=`\${ record.${this.name}${e} }`),`<td title='${t}' class="${i}">${s}</td>`}tfoot(){let e=this.total;return e=e?'${grid.total("'+this.name+'")}':this.footer?this.footer:"",`<td class="${this.el[0].className}">${e}</td>`}get name(){return this.el.attr("name")}get footer(){return this.el.attr("footer")}get total(){return this.el.attr("total")}}katrid.ui.ngKatrid.directive("tableView",()=>({restrict:"E",scope:!1,template(e,i){let s=[];for(let i of e.find("field"))s.push(new t($(i)));return katrid.app.getTemplate("dashboard.table.jinja2",{fields:s,el:e,attrs:i})}}));class i{constructor(e,t){this.$el=e,this.controls=[],this.$counter=0,this.$scope=t,this.params=this.$el.data("params"),this.name=e.attr("name"),this.name&&(t[this.name]=this),this.sql=this.$el.html(),this.url=e.data("url"),setTimeout(()=>this.execute(),100)}async execute(){this.$loading=!0;try{let e;if(this.url)e=await fetch(this.url).then(e=>e.json());else if(this.sql){let t=this.params;if(console.log(t),t){let e=t;t={};for(let i of e){let e=this.$scope[i];console.log(i,e),_.isDate(e)&&console.log("param is date",e),t[i]=e}}else t=this.$scope;let i=_.sprintf(this.sql,t);e=await katrid.Services.Query.executeSql(i)}this.$counter++,this.data=e.data,this.$scope.$apply(),this.onChange()}finally{this.$loading=!1}}onChange(){for(let e of this.controls)e.$render(this.data)}}class s{constructor(e){if(_.isString(e.el)?this.$el=$(e.el):this.$el=e.el,this.$scope=e.scope,this.$sourceScope=e.sourceScope||e.scope,this.$loading=!1,this.create(e),_.isString(this.dataSource)){let e=this.$sourceScope[this.dataSource];e&&(e.controls.push(this),e.$counter&&this.$render(e.data))}}create(e){this.dataSource=e.dataSource||this.$el.data("source"),this.caption=e.caption||this.$el.attr("caption")}$render(e){}}katrid.ui.ngKatrid.directive("gridView",()=>({restrict:"E",scope:{},async link(e,i,a){new class extends s{constructor(e){super(e),this._groupBy=[];let i=this.$el.attr("group-by");i&&(this._groupBy=i.split(",")),this.totals=[],this.fields=[];for(let e of this.$el.find("field")){let i=new t($(e));this.fields.push(i),i.total&&this.totals.push(i.name)}this.$scope.grid=this;let s=katrid.app.getTemplate("dashboard.grid.jinja2",{self:this,fields:this.fields});s=katrid.Core.$compile(s)(this.$scope),this.$el.html(s)}get groupBy(){return this._groupBy}set groupBy(e){this._groupBy=e,this._lastData&&this.$render(this._lastData)}total(e){console.log("calc attr",e);let t=0;if(this._lastData)for(let i of this._lastData)t+=i[e];return t}$render(e){this._lastData=e,e||(e=[]),this.groupBy.length&&(e=function(e,t,i,s){let a={};for(let r of e){let e=r[t],n=a[e];if(!n){n=a[e]={$children:[]};for(let e of i)n[e]=0}n.$children.push(r),n.$group=!0,n[s]=e;for(let e of i)n[e]+=r[e]}return Object.values(a)}(e,this.groupBy,this.totals,this.fields[0].name)),this.$scope.records=this._renderGroup(e)}_renderGroup(e){let t=[];for(let i of e)t.push(i),i.$group&&(t=t.concat(this._renderGroup(i.$children)));return t}}({el:i,attrs:a,scope:e,sourceScope:e.$parent})}})),katrid.ui.ngKatrid.filter("duration",()=>(e,t,i)=>{if(i||(i="HH:mm:ss"),e){"seconds"===t&&_.isString(e)&&(e=parseInt(e));let s=moment.duration(e,t).format(i);return 5===s.length&&(s="00:"+s),s}return e}),katrid.ui.dashboard={Chart:class extends s{constructor(e){super(e),this.backButton=$(`<button style="position: absolute; left: 0; top: 0;" class="btn btn-outline-secondary btn-sm back-button">${_.gettext("Back")}</button>`),this.backButton.hide(),this.$el.prepend(this.backButton)}groupBy(e,t,i){if(0===e.length)return[];let s=[],a=e[0],r="select ",n=t;if(_.isArray(n)?n=n.join(","):_.isNumber(t)&&(n=Object.keys(a)[t]),r+=n,_.isArray(i))for(let e of i)r+=",sum("+e+") as "+e;else _.isString(i)?r+=`,sum(${i}) as ${i}`:_.isNumber(i)&&(r+=",sum("+(i=Object.keys(a)[i])+") as "+i);return r+=" from ? group by ",r+=n,console.log(r),s=alasql(r,[e])}create(e){super.create(e),this.x=e.x,this.y=e.y,this.keys=e.keys,this.type=e.type,this.axis=e.axis,this.legend=e.legend,this.onclick=e.onclick,this.columns=e.columns,this.grid=e.grid,this.labels=e.labels,this.pie=e.pie,!this.columns&&!this.keys&&_.isUndefined(this.x)&&_.isUndefined(this.y)&&(this.x=0,this.y=1)}$render(e){this.$data=e,this.columns?this.$columns=this.columns:this.$columns=this.groupBy(e,this.x,this.y).map(e=>Object.values(e));let t={width:this.$el.parent().width()};this.$chart=c3.generate({bindto:this.$el[0],data:{columns:this.$columns,type:this.type,onclick:this.onclick,labels:this.labels},color:{pattern:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]},pie:this.pie,size:t,grid:this.grid,legend:this.legend,axis:this.axis}),this.$chart.$chart=this}query(e,t){return alasql(e,t)}},colorPatterns:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]}}(),function(){katrid.reports.Telegram=class{static async export(e,t){console.log("export telegram");let i=katrid.app.$templateCache.get("reportbot.dialog.contacts"),s=$(i);$("body").append(s);let a=s.find("#id-reportbot-select-contacts"),r=new katrid.Services.Model("res.partner"),n=await r.post("get_telegram_contacts");return n&&(n&&n.map(e=>a.append(`<option value="${e[0]}">${e[1]}</option>`)),a.select2()),s.find("#id-btn-ok").click(async()=>{let t=new katrid.Services.Model("telegram.pending");const i=e.getUserParams();t.post("export_report",{args:[e.info.id],kwargs:{contacts:a.val(),format:"pdf",params:i}}).ok&&console.log("ok")}),s.modal(),!0}}}();
//# sourceMappingURL=katrid.full.min.js.map