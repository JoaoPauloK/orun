var Katrid;!function(e){!function(t){t.registry={};class i{constructor(t){let i;this.info=t.info,this.scope=t.scope,this.location=t.location,this.app=e.app,e.app.actionManager.addAction(this),t.$container||(i=e.app.$element),this.$parent=i}getContext(){return{}}getBreadcrumb(){}get breadcrumb(){return this.getBreadcrumb()}$destroy(){e.app.actionManager.remove(this),this.scope.$destroy(),this.$element?this.$element.remove():this.$parent.empty()}get id(){return this.info.id}get context(){_.isString(this.info.context)?this._context=JSON.parse(this.info.context):this._context={};let e=window.location.href.split("#",2)[1];if(e){const t=new URLSearchParams(e);for(let[e,i]of t)e.startsWith("default_")&&(this._context[e]=i)}return this._context}doAction(e){let i=e.type||e.action_type;return t.registry[i].dispatchAction(this,e)}openObject(e){return e.preventDefault(),e.stopPropagation(),e.ctrlKey?(window.open(e.target.href),!1):(console.log(e.target.href),location.hash=e.target.href,!1)}restore(){}apply(){}backTo(t){let i=e.app.actionManager.breadcrumb[t];i&&e.app.actionManager.back(i.action,i.url)}execute(){$(this.app).trigger("action.execute",this)}getCurrentTitle(){return this.info.display_name}search(){if(!this.isDialog)return this.location.search.apply(null,arguments)}onHashChange(e){$(this.app).trigger("action",[this])}$attach(){}refreshBreadcrumb(){let t=e.app.getTemplate("view.breadcrumb.jinja2",{breadcrumb:e.app.actionManager.breadcrumb,action:this});t=e.Core.$compile(t)(this.scope),this.$element.find(".breadcrumb-nav").html(t)}}t.Action=i;class s extends i{async onHashChange(t){location.hash="#/app/?"+$.param(t);let i=new e.Services.Model("ir.action.view"),s=(await i.post("get_view",{args:[this.info.view[0]]})).content;$(e.app.$element).html(e.Core.$compile(s)(this.scope))}}s.actionType="ir.action.view";class a extends i{constructor(e){super(e),window.location.href=e.url}}a.actionType="ir.action.url";t.ActionManager=class{constructor(){this.$cachedActions={},this.actions=[],this.currentAction=null,this.mainAction=null}addAction(e){this.mainAction||(this.mainAction=e),this.actions.push(e),this.currentAction=e}back(t,i){t?this.action=t:this.length>1&&(this.action=this.actions[this.length-2],this.action.$attach()),this.action.refreshBreadcrumb(),angular.isString(i)?e.app.loadPage(i):i&&e.app.$location.search(i)}remove(e){this.actions.splice(this.actions.indexOf(e),this.length),0===this.length&&(this.mainAction=null)}get length(){return this.actions.length}get action(){return this.currentAction}get context(){if(this.currentAction)return this.currentAction.context}set action(e){let t=this.actions.indexOf(e);if(t>-1){for(t++;this.length>t;)this.actions[t].$destroy();this.currentAction=e}}clear(){for(let e of this.actions)e.$destroy();this.actions.length=0,this.mainAction=null,this.currentAction=null}get path(){return this.action.path}doAction(e){}async onHashChange(t,i){let s,a,r=t.action;if(i&&this.clear(),a=s=this.currentAction,r in this.$cachedActions){let i=this.$cachedActions[r],s=this.createScope();a=s.action=new e.Actions.registry[i.action_type]({info:i,scope:s,location:t})}else if(!r&&t.model&&(!a||a.params&&a.params.model!==t.model)){let i=new e.Services.Model(t.model),s=await i.rpc("get_formview_action",[t.id]),r=this.createScope();a=r.action=new e.Actions.registry[s.action_type]({info:s,scope:r,location:t})}else if(!this.currentAction||this.currentAction.info.id!=r){this.currentAction&&i&&this.currentAction.$destroy();let s=await e.Services.Actions.load(r),n=this.createScope();a=n.action=new e.Actions.registry[s.action_type]({info:s,scope:n,location:t})}await a.onHashChange(t)}createScope(){let t=e.app.$scope.$new(!0);return t._=_,t}get breadcrumb(){let e=[];for(let t of this.actions){let i=t.breadcrumb;if(i&&i.length){for(let e of i)e.isLeaf=!1;e.push(...i)}}return e[e.length-1].isLeaf=!0,e}},t.registry[s.actionType]=s,t.registry[a.actionType]=a}(e.Actions||(e.Actions={}))}(Katrid||(Katrid={})),function(e){!function(t){class i extends e.Actions.Action{static register(e,t){this.registry[e]=t}static executeTag(t,i){let s=this.registry[i.tag];s.prototype instanceof e.Forms.Views.ActionView?(s=new s(t.scope)).renderTo(t):console.log("is a function")}static tagButtonClick(t){let s={type:"ir.action.client",tag:t.attr("name"),target:t.attr("target")||"new"};(s=new i({action:s,app:e.app.actionManager.action.scope,location:e.app.actionManager.action.location})).execute()}tag_refresh(){this.dataSource.refresh()}get templateUrl(){return console.log(this.tag),this.tag.templateUrl}async execute(){let t=i.registry[this.info.tag];if(this.tag=t,t.prototype instanceof e.Forms.Views.ClientView){this.tag=new t(this);let e=await this.tag.render();"new"===this.info.target?e=e.modal():$("#katrid-action-view").empty().append(e)}else _.isString(t)&&this.constructor.registry[t].apply(this)}async routeUpdate(e){}get template(){return this.tag.template}}i.actionType="ir.action.client",i.registry={},t.ClientAction=i}(e.Actions||(e.Actions={}))}(Katrid||(Katrid={})),function(e){!function(t){class i extends e.Actions.Action{constructor(e,t,i){super(e),this.templateUrl="view.report.jinja2",this.userReport={}}static async dispatchBindingAction(t,i){let s=localStorage.katridReportViewer||"pdf",a=t.selection;a&&(a=a.join(","));let r={data:[{name:"id",value:a}]},n=new e.Services.Model("ir.action.report"),o=await n.post("export_report",{args:[i.id],kwargs:{format:s,params:r}});if(o.open)return window.open(o.open)}get name(){return this.info.name}userReportChanged(e){return this.location.search({user_report:e})}async onHashChange(t){if(console.log("report hash change",t),this.userReport.id=t.user_report,this.userReport.id){let t=new e.Services.Model("ir.action.report"),i=await t.post("load_user_report",{kwargs:{user_report:this.userReport.id}});this.userReport.params=i.result}location.hash="#/app/?"+$.param(t);let i=e.Reports.renderDialog(this);i=e.Core.$compile(i)(this.scope),$("#katrid-action-view").empty().append(i)}}i.actionType="ir.action.report",t.ReportAction=i,e.Actions.registry[i.actionType]=i}(e.Actions||(e.Actions={}))}(Katrid||(Katrid={})),function(e){!function(t){class i extends e.Actions.Action{constructor(t){super(t),this._cachedViews={},this.model=t.scope.model,this.viewMode=t.info.view_mode,this.viewModes=this.viewMode.split(","),t.info.model&&(t.scope.model=this.model=new e.Services.Model(t.info.model)),this.dataSource=new e.Data.DataSource({model:this.model,scope:t.scope,action:this}),t.scope.$on("dataStateChange",this.onDataStateChange),t.scope.$on("afterCancel",(e,t)=>{t===this.dataSource&&this.afterCancel(e,t)})}afterCancel(t,i){i.state===e.Data.DataSourceState.inserting&&(this.dataSource.record={},this.back())}back(){}setDirty(e){const t=this.form[e];t&&t.$setDirty()}async onHashChange(e){let t=!1,i=["action","view_type","menu_id","model"];this.params&&(this.params.id,e.id);this.params={},e.view_type||(this.params.view_type=this.viewModes[0],t=!0),e.model||(this.params.model=this.info.model,t=!0),Object.assign(this.params,e),"form"===this.params.view_type&&i.splice(0,0,"id");for(let e of Object.keys(this.params))i.includes(e)||e.startsWith("default_")||(t=!0);if(t){let e=this.params;this.params={};for(let t of i)this.params[t]=e[t];this.params.action||delete this.params.action,history.replaceState(null,null,"#/app/?"+$.param(this.params))}let s=this.params.view_type;s!==this.viewType&&(this.viewType=s,await this.execute()),this.params.id&&this.dataSource.recordId!=this.params.id&&await this.dataSource.get(this.params.id)}rpc(e,t,i){i&&i.stopPropagation(),t?_.isArray(t)?t={args:t}:_.isObject(t)||(t={args:[t]}):t={},this.model.rpc(e,t.args,t.kwargs)}getContext(){let e=super.getContext(),t=this.selection;return t&&t.length&&(e.active_id=t[0],e.active_ids=t),e}getCurrentTitle(){return"form"===this.viewType?this.scope.record.display_name:super.getCurrentTitle()}switchView(t,i){if(t!==this.viewType){let s={};Object.assign(s,e.app.$location.$$search),i&&Object.assign(s,i),s.view_type=t,e.app.$location.search(s)}}createNew(){this.switchView("form",{id:null})}async deleteSelection(t){let i=this.selection;if(!i)return!1;if(1===i.length&&confirm(e.i18n.gettext("Confirm delete record?"))||i.length>1&&confirm(e.i18n.gettext("Confirm delete records?"))){await this.dataSource.delete(i),t?(this.app.actionManager.backTo(-1),this.dataSource.refresh()):this.dataSource.next();for(let e of i){let t=this.dataSource.findById(e);console.log(this.dataSource.records.indexOf(t)),this.dataSource.records.splice(this.dataSource.records.indexOf(t),1)}this.scope.$apply()}}async copy(){return this.viewType="form",await this.dataSource.copy(this.scope.record.id),!1}async copyTo(t){if(this.scope.recordId){let i=new e.Services.Model("ir.copy.to"),s=await i.rpc("copy_to",[t,this.scope.recordId]),a=new e.Services.Model(s.model),r=await a.getViewInfo({view_type:"form"});new e.Forms.Dialogs.Window({scope:this.scope,view:r,model:a}).createNew({defaultValues:s.value})}}makeUrl(t){t||(t=this.viewModes[0]);let i={action:this.info.id,view_type:t,menu_id:e.app.$location.$$search.menu_id};return"form"===t&&this.record&&(i.id=this.record.id),i}get record(){return this.scope.record}get searchModes(){return this.viewModes.filter(e=>"form"!==e)}getBreadcrumb(){let t=[];if(this.searchModes.length&&t.push({action:this,url:this.makeUrl(this.lastViewType),text:this.info.record_name}),"form"===this.viewType){let i={action:this,url:this.makeUrl("form")};this===e.app.actionManager.currentAction?i.text="${ record.record_name }":i.text=this.record&&this.record.record_name,t.push(i)}return t}$detach(){this.$element.detach()}$attach(){this.$element.appendTo(this.$parent)}async execute(){if(super.execute(),!this.views){let t=await this.model.loadViews({views:this.info.views,action:this.info.id,toolbar:!0});this.fields=t.fields,this.fieldList=t.fieldList,this.views=t.views;let i=e.app.getTemplate("ir.action.window.jinja2",{action:this});(i=e.Core.$compile(i)(this.scope))[0].action=this,this.$parent.html(i),this.$element=i,this.$container=this.$element.find(".action-view-content:first")}let t,i=!1;this.view&&(console.log("cached",this.view.el),this._cachedViews[this.view.viewType]=this.view,this.view.el.detach()),this.$container.empty(),this.refreshBreadcrumb(),this.scope.view=this.views[this.viewType],this.viewType in this._cachedViews?(t=this._cachedViews[this.viewType],this.$container.append(t.el)):((t=new e.Forms.Views.registry[this.viewType]({action:this,viewInfo:this.scope.view})).renderTo(this.$container),t.ready()),"form"!==this.viewType&&(this.lastViewType=this.viewType,this.lastUrl=location.hash,this.dataSource.refresh(!0)),setTimeout(()=>{"form"!==this.viewType||e.app.$location.$$search.id||this.dataSource.insert()})}get viewType(){return this._viewType}set viewType(e){e!==this._viewType&&("form"!==e&&(this.dataSource.recordId=null),this.dataSource.destroyChildren(),this._viewType=e)}searchText(e){return this.location.search("q",e)}_prepareParams(e){let t={};for(let i of Array.from(e))i.field&&"ForeignKey"===i.field.type?t[i.field.name]=i.id:t[i.id.name+"__icontains"]=i.text;return t}setSearchParams(e){let t={};this.info.domain&&(t=$.parseJSON(this.info.domain));for(let[i,s]of Object.entries(t)){let t={};t[i]=s,e.push(t)}return console.log("search params",e),this.dataSource.search(e)}applyGroups(e,t){return this.dataSource.groupBy(e,t)}groupHeaderClick(e,t){console.log("group header click",e),e.$expanded=!e.$expanded,e.$expanded?this.dataSource.expandGroup(t,e):this.dataSource.collapseGroup(t,e)}async loadGroupRecords(e){if(e.count>0){let t=await this.dataSource.model.search({params:e.$params});e.records=t.data,console.log(e),this.scope.$apply()}}doViewAction(e,t,i,s){return this._doViewAction(this.scope,e,t,i,s)}_doViewAction(e,t,i,s,a){let r=null;if(a&&(r=window.prompt(a)),!s||s&&confirm(s))return this.model.doViewAction({action_name:t,target:i,prompt:r}).then(function(e){if("open"===e.status)return window.open(e.open)})}async formButtonClick(t,i,s){const a=await this.scope.model.rpc(i,[t]);if(a.open)return window.open(a.open);if(a.download){let e=document.createElement("a");return e.href=a.download,void e.click()}if("refresh"===a.tag&&this.dataSource.refresh(),a.type){new e.Actions.registry[a.type](a,this.scope,this.scope.location).execute()}}doBindingAction(t){this.selection,e.Services.Actions.load($(t.currentTarget).data("id")).then(t=>{"ir.action.report"===t.action_type&&e.Actions.ReportAction.dispatchBindingAction(this,t)})}listRowClick(t,i,s){if(i.$hasChildren)this.groupHeaderClick(i,t);else{let a={id:i.id,action:this.info.id,view_type:"form",menu_id:e.app.$location.$$search.menu_id};if(s.ctrlKey)return;e.app.$location.search(a),this.dataSource.recordIndex=t}}onDataStateChange(e,t){let i=t.scope.action;t.changing&&setTimeout(()=>{if(i.$element)for(let e of Array.from(i.$element.find("input[type!=hidden].form-field:visible")))if(!(e=$(e)).attr("readonly"))return void $(e).focus()})}autoReport(){return this.model.autoReport().then(function(e){if(e.ok&&e.result.open)return window.open(e.result.open)})}showDefaultValueDialog(){}selectToggle(e){this._selection=$(e).closest("table").find("td.list-record-selector :checkbox").filter(":checked"),this.selectionLength=this._selection.length}get selection(){return"form"===this.viewType?this.scope.recordId?[this.scope.recordId]:void 0:this._selection?Array.from(this._selection).map(e=>$(e).data("id")):void 0}set attachments(e){this.scope.$apply(()=>this.scope.attachments=e)}deleteAttachment(t,i){let s=t[i];confirm(e.i18n.gettext("Confirm delete attachment?"))&&(t.splice(i,1),e.Services.Attachments.destroy(s.id))}}i.actionType="ir.action.window",t.WindowAction=i,e.Actions.registry[i.actionType]=i}(e.Actions||(e.Actions={}))}(Katrid||(Katrid={})),function(e){const t=(s=!1,i=navigator.userAgent||navigator.vendor,(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(i)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(i.substr(0,4)))&&(s=!0),s);var i,s;e.settings={additionalModules:[],server:"",ui:{isMobile:t,dateInputMask:!0,defaultView:"list",goToDefaultViewAfterCancelInsert:!0,goToDefaultViewAfterCancelEdit:!1,horizontalForms:!0},services:{choicesPageLimit:10},speech:{enabled:!1}}}(Katrid||(Katrid={})),function(e){!function(e){class t{constructor(e){this.$cache=e}getSource(e){return{src:this.$cache.get(e),path:e,noCache:!1}}}e.Loader=t;class i{constructor(e,s){this.app=e,i.env=new nunjucks.Environment(new t(e.$templateCache),{autoescape:!1});let a=e.$templateCache.get;e.$templateCache.get=(e=>this.prepare(e,a.call(this,e))),this.loadTemplates(e.$templateCache,s);for(let[t,s]of Object.entries(i.PRE_LOADED_TEMPLATES))e.$templateCache.put(t,s)}prepare(e,t){if(_.isUndefined(t))throw Error("Template not found: "+e);return"SCRIPT"===t.tagName?t.innerHTML:t}compileTemplate(e,t){let i=$(e);t=$(t.innerHTML);for(let e of Array.from(t))if("JQUERY"===e.tagName){let t=$(e),s=t.attr("selector"),a=t.attr("operation");(s=s?i.find(s):i)[a](t[0].innerHTML)}return i[0].innerHTML}loadTemplates(e,t){let i={},s=e=>{"TEMPLATES"===e.tagName?Array.from(e.children).map(s):"SCRIPT"===e.tagName&&(i[e.id]=e.innerHTML)},a=t=>{if("TEMPLATES"===t.tagName)Array.from(t.children).map(a);else if("SCRIPT"===t.tagName){let s=t.getAttribute("extends"),a=t.getAttribute("id")||s;s?t=i[s]+t:a=t.id,e.put(a,t)}},r=(new DOMParser).parseFromString(t,"text/html").firstChild.childNodes[1].firstChild;s(r),a(r)}}i.PRE_LOADED_TEMPLATES={},e.Templates=i,e.registerTemplate=function(e,t){i.PRE_LOADED_TEMPLATES[e]=t}}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){class i{constructor(e){this.app=e,$(".menu-item-action").on("click",e=>{e.preventDefault();let t=e.target;this.actionClick(t.getAttribute("href")),t.closest(".dropdown-menu").style.display="none"}),$("li.nav-item.dropdown").on("mouseenter",function(){this.querySelectorAll(".dropdown-menu").forEach(e=>e.removeAttribute("style"))})}actionClick(e){this.app.loadPage(e,!0)}}t.Menu=i;class s{constructor(t){e.app=this;for(let t of Object.entries(e.customElementsRegistry))customElements.define(t[0],t[1]);this.menu=new i(this),this.actionManager=new e.Actions.ActionManager,this.title=t.title,this.plugins=["ui.katrid","ngSanitize"];let s=this;$(e).on("app.ready",()=>{let t,i,a=$("#loading-msg").hide(),r=$("#overlay").hide();$(e).on("fetch.before",()=>{t=setTimeout(()=>a.show(),400),i=setTimeout(()=>{a.hide(),r.show()},2500)}).on("fetch.always",()=>{clearTimeout(t),clearTimeout(i),a.hide(),r.hide()}),$(document).ajaxStart(function(){t=setTimeout(()=>a.show(),400),i=setTimeout(()=>{a.hide(),r.show()},2500)}).ajaxStop(function(){clearTimeout(t),clearTimeout(i),a.hide(),r.hide()}),$("a.module-selector").on("click",function(t){t.preventDefault();let i=$(this);i.data("menu-id"),e.app.actionManager.clear(),s.loadPage(i.attr("href"))}).each(function(e,t){let i=$(t),s={};s.menu_id=i.data("menu-id"),s.action=$(`.menu-item-action[data-parent-id="${s.menu_id}"]:first`).data("action-id"),i.attr("href","#/app/?"+$.param(s))}),""===location.hash?$("a.module-selector:first").trigger("click"):this.loadPage(location.hash)}),window.addEventListener("hashchange",e=>{this.loadPage(location.hash)}),fetch(t.templates||"/web/js/templates/").then(e=>e.text()).then(t=>{t&&(t="<templates>"+t+"</templates>"),this.ngApp=angular.module("katridApp",this.plugins).run(["$templateCache",i=>{this.$templateCache=i,e.Forms.templates=new e.Forms.Templates(this,t)}]).config(["$locationProvider","$interpolateProvider",function(e,t){e.hashPrefix(""),t.startSymbol("${"),t.endSymbol("}")}]),this.ngApp.controller("AppController",["$scope","$compile","$location",function(t,i,s){e.Core.$compile=i,e.app.$scope=t,e.app.$location=s,t._=_,e.app.$element=$("#katrid-action-view"),$(e).trigger("app.ready",[e.app])}]),this.ngApp.controller("ActionController",["$scope",function(e){}]),e.Core.plugins.init(this),$(this).trigger("loaded",[e.app])})}static bootstrap(e){let t=new s(e);return $(t).on("loaded",function(){angular.element(function(){angular.bootstrap(document,["katridApp"])})}),t}async loadPage(e,t){let i=$.Event("hashchange");if($(this).trigger(i,[e,t]),!i.isPropagationStopped()){this.$scope.currentMenu="",e.startsWith("#/app/?")&&(e=e.split("#/app/?")[1]);let i=new URLSearchParams(e),s={};for(let[e,t]of i.entries())s[e]=t;s.menu_id&&$("a.module-selector"),(!this.$scope.$parent.currentMenu||s.menu_id&&this.$scope.$parent.currentMenu.id!=s.menu_id)&&(this.$scope.$parent.currentMenu={id:s.menu_id,name:$(`.module-selector[data-menu-id="${s.menu_id}"]`).text()}),("action"in s||"model"in s)&&await this.actionManager.onHashChange(s,t)}}setContent(t,i){this.$element.empty(),t=e.Core.$compile(t)(i||this.$scope),this.$element.append(t)}getTemplate(t,i){let s=this.$templateCache.get(t);if(t.endsWith("jinja2")){let s={_:_,window:window};return i&&Object.assign(s,i),e.Forms.Templates.env.render(t,s)}return t.endsWith("pug")&&(s=s(i)),s}get context(){return this.actionManager.context}}t.WebApplication=s,angular.module("basicApp",[]).controller("LoginController",["$scope",function(t){t.login=(async(i,s,a,r)=>{let n,o=new URLSearchParams(window.location.search).get("next");a&&(n=await e.Services.post("/web/db/",{db:r})),(a&&n.redirect||!a)&&((n=await e.Services.post("/web/login/",{username:i,password:s,next:o})).error?(t.messages=[{type:"danger",message:n.message}],t.$apply()):(t.messages=[{type:"success",message:n.message}],t.$apply(),setTimeout(()=>window.location.href=n.redirect)))})}])}(e.Core||(e.Core={}))}(Katrid||(Katrid={})),Katrid||(Katrid={}),function(e){!function(t){_.emptyText="--";class i{constructor(){}static init(){e.localSettings=new i}get searchMenuVisible(){return 1===parseInt(localStorage.searchMenuVisible)}set searchMenuVisible(e){localStorage.searchMenuVisible=e?1:0}}t.LocalSettings=i,t.plugins={callbacks:[],init(e){for(let t of this.callbacks)t(e)},register(e){this.callbacks.push(e)}},t.setContent=function(e,t){}}(e.Core||(e.Core={}))}(Katrid||(Katrid={})),function(e){e.customElementsRegistry={},e.define=function(t,i){e.customElementsRegistry[t]=i}}(Katrid||(Katrid={})),function(e){!function(e){e.connections={},e.connection=null,e.defaultConnection="default"}(e.Data||(e.Data={}))}(Katrid||(Katrid={})),function(e){!function(t){let i;!function(e){e[e.inserting=0]="inserting",e[e.browsing=1]="browsing",e[e.editing=2]="editing",e[e.loading=3]="loading",e[e.inactive=4]="inactive"}(i=t.DataSourceState||(t.DataSourceState={}));let s=300;t.DataSource=class{constructor(e){this.$modifiedRecords=[],this.refreshInterval=1e3,this.readonly=!1,this.$modifiedRecords=[],this.scope=e.scope,this.action=e.action,this._model=e.model,this.field=e.field,this._recordIndex=0,this.recordCount=null,this.loading=!1,this.loadingRecord=!1,this._masterSource=null,this.masterSource=e.master,this._pageIndex=0,this.pageLimit=100,this.offset=0,this.offsetLimit=0,this.requestInterval=s,this.pendingOperation=null,this.pendingRequest=!1,this.fieldName=null,this.children=[],this.modifiedData=null,this.uploading=0,this._state=null,this.fieldWatchers=[],this._pendingChanges=!1,this.recordId=null,this.scope.$fieldLog={},this._records=[]}get pageIndex(){return this._pageIndex}set pageIndex(e){this._pageIndex=e,console.log("goto page",e),this.search(this._params,e,this._fields,s)}get fields(){return this.scope.view.fields}get loadingAction(){return this._loadingAction}set loadingAction(e){this.requestInterval=e?0:s,this._loadingAction=e}async cancel(){this.changing&&(this._recordIndex=null,this._pendingChanges=!1,this.state===i.editing?await this.refresh():this.action&&this.action.switchView("list"),this.state=i.browsing,this.scope.$emit("afterCancel",this))}async copy(e){let t=await this.model.copy(e);return this.record={},await this.insert(),this.setValues(t),t}findById(e){for(let t of this._records)if(t.id===e)return t;return null}$removeById(e){let t=0;for(let i of this._records){if(i.id===e)return this._records.splice(t,1),i;t++}return null}hasKey(e){return null!==this.findById(e)}refresh(e){let t;return!0===e?t=this.search(this._params,this._page):e?t=this.get(e[0]):this.record&&this.record.id&&(t=this.get(this.record.id)),t.then(()=>{}),t}_validateForm(t,i,s){let a;for(let r in i.$error)if("required"===r)for(let n of Array.from(i.$error[r]))if(n.$name.startsWith("grid-row-form"))a=this._validateForm(t.find("#"+n.$name),n,s);else{(a=t.find(`.form-field[name="${n.$name}"]`)).addClass("ng-touched");const i=angular.element(t).scope().view.fields[n.$name];s.push(`<span>${i.caption}</span><ul><li>${e.i18n.gettext("This field cannot be empty.")}</li></ul>`)}else console.log(i.$error[r]);return a}validate(t=!0){if(this.action.form.$invalid){let i,s=[],a=`<span>${e.i18n.gettext("The following fields are invalid:")}</span><hr>`;const r=this.scope.formElement;if(i=this._validateForm(r,this.scope.form,s),e.UI.uiKatrid.setFocus(i),a+=s.join(""),e.Forms.Dialogs.Alerts.error(a),t)throw Error("Error validating form: "+a);return!1}return!0}indexOf(e){if(this._records)return this._records.indexOf(this.findById(e.id))}search(t,i,s,a){let r;return this.masterSource,this._params=t,this._page=i,this._fields=s,this._clearTimeout(),this.pendingRequest=!0,this.loading=!0,i=i||1,this._pageIndex=i,this.action&&this.action.info&&(r=this.action.info.domain),r&&(r=JSON.parse(r)),_.isObject(s)&&(s=Object.keys(s)),t={count:!0,page:i,where:t,fields:s,domain:r,limit:this.pageLimit},new Promise((i,s)=>{let a=()=>{this.model.search(t).catch(e=>s(e)).then(t=>(this.pageIndex>1?this.offset=(this.pageIndex-1)*this.pageLimit+1:this.offset=1,this.scope.$apply(()=>{null!=t.count&&(this.recordCount=t.count);let i=t.data;return this.rawData=i,this.readonly?this._records=i:this._records=i.map(t=>e.Data.createRecord(t,this)),this.scope.records=this._records,1===this.pageIndex?this.offsetLimit=this._records.length:this.offsetLimit=this.offset+this._records.length-1}),i(t))).finally(()=>{this.pendingRequest=!1,this.scope.$apply(()=>{this.loading=!1})})};this.requestInterval>0?this.pendingOperation=setTimeout(a,this.requestInterval):a()})}async groupBy(e,t){return this._params=[],console.log("group by",e,t),e&&e.length?(this.scope.action.groups=e,this.scope.groupings=[],this.groups=e,this.scope.groups=await this._loadGroup(e,0,t),this.scope.$apply()):(this.groups=[],this.action.groups=null,this.scope.groups=null,void this.search(t))}async _loadGroup(e,t,i,s){let a=[];i||(i=[]),s&&s.$params&&(i=i.concat(s.$params));let r=await this.model.groupBy([e[t]],i);const n=e[t];for(let e of r){let i,r=e[n];$.isArray(r)?(i=r[0],r=r[1]):i=r,e.__str__=r,e.$expanded=!1,e.$group=n,e.$params=[],s&&(e.$params=e.$params.concat(s.$params));let o={};o[n]=i,e.$params.push(o),e.$level=t,e.$hasChildren=!0,a.push(e)}return a}goto(e){return this.recordIndex=e}moveBy(e){const t=this._recordIndex+e;t>-1&&t<this._records.length&&(this.recordIndex=t)}_clearTimeout(){this.loading=!1,this.loadingRecord=!1,this._canceled=!0,this.pendingRequest=!1,clearTimeout(this.pendingOperation)}set masterSource(e){this._masterSource=e,e&&e.children.push(this)}get masterSource(){return this._masterSource}applyModifiedData(e,t,i){const s=this.getModifiedData(e,t,i),a=_.hash(i);if(s){let e=this.modifiedData;null==e&&(e={});let t=e[a];t||(t={},e[a]=t);for(let e in s){let i=s[e];t[e]=i}this.modifiedData=e,this.masterSource.scope.form.$setDirty()}return s}getNestedData(){let e={};for(let t of this.children)if(t.$modifiedRecords.length){let i=[],s=[];for(let e of t.$modifiedRecords)e.$deleted&&(s.push(e),null!==e.id&&void 0!==e.id&&i.push({id:e.id,action:"DESTROY"}));for(let e of t.$modifiedRecords)if(console.log(e.$modified,e.$modifiedData),e.$modifiedData&&!e.$deleted&&e.$modified&&-1===s.indexOf(e)){let s=this._getModified(e.$modifiedData);e.id&&(s.id=e.id),jQuery.extend(s,t.getNestedData()),null===e.id||void 0===e.id?i.push({action:"CREATE",values:s}):null!==e.id&&void 0!==e.id&&i.push({action:"UPDATE",values:s})}Object.keys(i).length>0&&(e[t.fieldName]=i)}return e}save(t=!0){for(let e of this.children)e.changing&&e.flush();const s=this.action.$form;if(this.validate()){const a=this.record.$record.serialize();console.log(a);let r=s.attr("before-submit");if(r&&(r=this.scope.$eval(r)),a)return this.uploading++,this.model.write([a]).then(s=>(this.action&&this.action.viewType&&"form"===this.action.viewType&&e.app.$location.search("id",s[0]),this.action.form.$setPristine(),this.action.form.$setUntouched(),this._pendingChanges=!1,this.state=i.browsing,t?this.refresh(s):s)).catch(t=>{let i=`<span>${e.i18n.gettext("The following fields are invalid:")}<hr></span>`;if(t.message)i=t.message;else if(t.messages){let e;for(let a of Object.keys(t.messages)){const r=t.messages[a];let n;if(a.indexOf(".")>-1){let e=a.split("."),t=e[1];for(let i of this.children)i.scope.fieldName===e[0]&&(n=i.scope.view.fields[t])}else n=this.scope.view.fields[a];if(console.log("field invalid",n),n&&n.name){(e=s.find(`.form-field[name="${n.name}"]`)).addClass("ng-invalid ng-touched"),i+=`<strong>${n.caption}</strong><ul>`;for(let e of r)i+=`<li>${e}</li>`;i+="</ul>"}}e&&e.focus()}throw e.Forms.Dialogs.Alerts.error(i),new Error(i)}).finally(()=>this.scope.$apply(()=>this.uploading--));e.Forms.Dialogs.Alerts.warn(e.i18n.gettext("No pending changes"))}}async delete(e){await this.model.destroy(e)}_getNested(e){let t,i=[];if(e.$deleted&&e.$deleted.recs.length)for(let t of e.$deleted.recs)i.push({id:t.id,action:"DESTROY"});if(e.recs.length)for(let s of e.recs)if(s){if(t={},s.$created)t={action:"CREATE",values:this._getModified(s.$modifiedData)};else{if(!s.$modified)continue;(t={action:"UPDATE",values:this._getModified(s.$modifiedData)}).values.id=s.id}i.push(t)}return i}_getModified(t){let i={};if(t)for(let[s,a]of Object.entries(t))a instanceof e.Data.SubRecords?i[s]=this._getNested(a):i[s]=a;return i}getModifiedData(e,t,i){let s={};return i.$modified&&jQuery.extend(s,this._getModified(i.$modifiedData)),this.record.id&&(s.id=i.id),s}get(e,t,s=!0,a=!1){return this._clearTimeout(),this.state=i.loading,this.loadingRecord=!0,this._canceled=!1,new Promise((r,n)=>{const o=()=>this.model.getById(e).catch(e=>n(e)).then(e=>{if(!this._canceled&&e){if(this.state===i.loading)this.state=i.browsing;else if(this.state===i.inserting)return;return this.record=e.data[0],!1!==a&&(this._records[a]=this.record),r(this.record)}}).finally(()=>{if(this.loadingRecord=!1,s)return this.scope.$apply()});if(!t&&!this.requestInterval)return o();this.pendingOperation=setTimeout(o,t||this.requestInterval)})}get defaultValues(){}set defaultValues(e){for(let[t,i]of Object.entries(e))_.isObject(i)&&t in this.fields&&(this.fields[t].defaultValue=i)}async insert(s=!0,a,r){this._clearTimeout();for(let e of this.children)e._clearTimeout();let n,o=t.createRecord(null,this),l=this._records;this.record=o,this._records=l;for(let e of this.children)e._records=[];s&&(n=await this.model.getDefaults(r));const c=new URLSearchParams;console.log(c),this.state=i.inserting,this.scope.record.record_name=e.i18n.gettext("(New)");let d={};this.masterSource&&this.field&&this.field.defaultValue&&Object.assign(d,this.field.defaultValue);for(let e of Object.values(this.fields))e.defaultValue&&(d[e.name]=e.defaultValue);this.scope.ngDefaultValues&&Object.assign(d,this.scope.$eval(this.scope.ngDefaultValues)),this.action.context&&this.action.context.default_values&&Object.assign(d,this.action.context.default_values),a&&Object.assign(d,a),n&&Object.assign(d,n);for(let[e,t]of Object.entries(d))_.isFunction(t)&&(t=t(d,this),_.isUndefined(t)||(d[e]=t));return this.setValues(d),this.record}_new(){return e.Data.createRecord({},this)}setValues(e){Object.entries(e).forEach(([e,t])=>{let i=this.fields[e];i?i.fromJSON(t,this):this.scope.record[e]=t}),this.scope.$apply()}edit(){this.state=i.editing}toClientValue(e,t){const i=this.scope.view.fields[e];return i&&"DateTimeField"===i.type&&(t=new Date(t)),t}fieldByName(e){return this.scope.views?this.scope.views.form.fields[e]:this.scope.view.fields[e]}set state(e){this._modifiedFields=[],this._state=e,this.inserting=e===i.inserting,this.editing=e===i.editing,this.loading=e===i.loading,this.changing=[i.editing,i.inserting].includes(this.state)}get browsing(){return this._state===i.browsing}childByName(e){for(let t of this.children)if(t.fieldName===e)return t}get state(){return this._state}get record(){return this.scope.record}set recordId(e){this.scope.recordId=e}get recordId(){return this.scope.recordId}set record(t){t.$record||(t=e.Data.createRecord(t,this)),this.scope.record=t,this.recordId=t.id,this._pendingChanges=!1,this.scope.form&&this.scope.form.$setPristine(),this.action&&this.action.$element&&this.action.$element[0].dispatchEvent(new CustomEvent("recordLoaded",{detail:{rec:t}})),this.childrenNotification(t)}set records(e){this._records=e}get records(){return this._records}next(){return this.moveBy(1)}prior(){return this.moveBy(-1)}nextPage(){let e=this.recordCount/this.pageLimit;Math.floor(e)&&e++,e>this.pageIndex+1&&this.pageIndex++}prevPage(){this.pageIndex>1&&this.pageIndex--}set recordIndex(t){this._recordIndex=t,this.scope.record=this._records[t],this.parent||e.app.$location.search("id",this.scope.record.id),this.scope.recordId=null}get recordIndex(){return this._recordIndex}async expandGroup(e,t){let i=[];if(this._params&&(i=i.concat(this._params)),t.$params&&(i=i.concat(t.$params)),t.$level===this.groups.length-1){let s=await this.model.search({params:i});s.data&&(t.$children=s.data,this.scope.$apply(()=>{this.scope.groups.splice.apply(this.scope.groups,[e+1,0].concat(s.data))})),this._records=this._chain()}else{let i=await this._loadGroup(this.groups,t.$level+1,this._params,t);t.$children=i,this.scope.groups.splice.apply(this.scope.groups,[e+1,0].concat(i)),this.scope.$apply()}}collapseGroup(e,t){let i=(e,t)=>{console.log("collapse",e,t),t.$children&&t.$children.length&&t.$level!==this.groups.length-1&&t.$children.map(e=>i(this.scope.groups.indexOf(e),e)),t.$children&&t.$children.length&&this.scope.groups.splice(e+1,t.$children.length),t.$children=[]};i(e,t),this._records=this._chain()}_chain(){let e=[];for(let t of this.scope.groups)t.$hasChildren&&t.$expanded&&t.$children.length&&(e=e.concat(t.$children));return e}_applyResponse(e){e&&(e.value&&this.setValues(e.value),this.scope.$apply())}async dispatchEvent(e,...t){let i=await this.model.rpc(e,...t);this._applyResponse(i)}get model(){return this._model}open(){return console.log("data source open"),this.search({},1,this.action.view.fields)}get parent(){return this.masterSource}set parent(e){this._masterSource=e}$setDirty(e){let t=this.scope.form;if(t){let i=t[e];i&&i.$setDirty()}else this.action&&this.action.setDirty(e)}destroyChildren(){for(let e of this.children)e.scope.$destroy();this.children=[]}childrenNotification(e){for(let t of this.children)t.parentNotification(e)}async parentNotification(t){this.records=[],this._clearTimeout(),this.pendingOperation=setTimeout(async()=>{if(null!=t.id){let i={};i[this.field.info.field]=t.id;let s=await this.search(i);t[this.field.name]=s.data,this.state=e.Data.DataSourceState.browsing}else t[this.field.name]=[]},this.refreshInterval)}destroy(){this._masterSource&&this._masterSource.children.splice(this._masterSource.children.indexOf(this),1)}flush(e){e&&this.validate(),this.record.$record.flush(),this.state=i.browsing;for(let e of this.children)e.flush()}discardChanges(){this.record.$record.discard()}}}(e.Data||(e.Data={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){function i(e){return e=(e=(e=e.replace(/([^a-zA-Z0-9_\- ])|^[_0-9]+/g,"").trim().toLowerCase()).replace(/([ -]+)([a-zA-Z0-9])/g,function(e,t,i){return i.toUpperCase()})).replace(/([0-9]+)([a-zA-Z])/g,function(e,t,i){return t+i.toUpperCase()})}class s{constructor(e){this.visible=!0,this.info=e,this.cssClass=e.type,this.caption=e.caption||e.name,this.helpText=this.info.help_text,this.required=this.info.required,this.onChange=this.info.onchange,this.nolabel=!1,this.displayChoices=_.object(e.choices),this.choices=e.choices,this.create(),this.loadInfo(e)}create(){this.visible=!0,this.emptyText="--",this.cols=6,this.readonly=!1,this.info.choices?this.template={list:"view.list.selection-field.jinja2",card:"view.list.selection-field.jinja2",form:"view.form.selection-field.jinja2"}:this.template={list:"view.list.field.jinja2",card:"view.list.field.jinja2",form:"view.form.field.jinja2"}}loadInfo(e){e.template&&(this.template=Object.assign(this.template,e.template)),"cols"in e&&(this.cols=e.cols),"readonly"in e&&(this.readonly=e.readonly),"visible"in e&&(this.visible=e.visible)}assign(e,t){let i=new this.constructor(this.info);return i.view=e,i.fieldEl=t,i[i.view.viewType+"Render"].apply(i),i}get fieldEl(){return this._fieldEl}set fieldEl(e){if(this._fieldEl=e,e){let t={};for(let i of e.attributes)t[i.name]=e.nodeValue;this.loadInfo(t)}}formRender(t={}){let s=this._fieldEl,a=this.view,r=s.getAttribute("widget")||this.widget;if(r){let e=document.createElement(r+"-field");return e.bind(this),void(this.el=e)}let n=$(s),o={};for(let e of s.attributes){o[e.name]=e.value;let t=i(e.name);t!==e.name&&(o[t]=e.value)}o.cols&&(this.cols=o.cols),o.ngReadonly&&(this.ngReadonly=o.ngReadonly),o.domain&&(this.domain=o.domain),"false"===o.visible?this.visible=!1:"true"===o.visible&&(this.visible=!0),o.ngShow&&(this.ngShow=o.ngShow),o.ngIf&&(this.ngIf=o.ngIf),o.ngClass&&(this.ngClass=o.ngClass),this.attrs=o,t.field=this,t.attrs=o,t.html=n.html(),this.el=$(e.app.getTemplate(this.template[a.viewType],t))[0]}listRender(){let t=this._fieldEl,s=(this.view,t.getAttribute("widget")||this.widget);if(s){let e=document.createElement(s+"-field");return e.bind(this),void(this.el=e)}let a={};for(let e of t.attributes){a[e.name]=e.value;let t=i(e.name);t!==e.name&&(a[t]=e.value)}a.cols&&(this.cols=a.cols),a.ngReadonly&&(this.ngReadonly=a.ngReadonly),a.domain&&(this.domain=a.domain),"false"===a.visible?this.visible=!1:"true"===a.visible&&(this.visible=!0),a.ngShow&&(this.ngShow=a.ngShow),a.ngIf&&(this.ngIf=a.ngIf),a.ngClass&&(this.ngClass=a.ngClass);let r={field:this,html:$(t).html(),attrs:a},n=e.app.getTemplate(this.template[this.view.viewType],r),o=document.createElement("template");o.innerHTML=n,this.el=o}cardRender(){let e=this._fieldEl,t=(this.view,e.getAttribute("widget")||this.widget);if(t){let e=document.createElement(t+"-field");return e.bind(this),void(this.el=e)}}render(t,s,a){let r={};for(let e of s.attributes){r[e.name]=e.value;let t=i(e.name);t!==e.name&&(r[t]=e.value)}return r.cols&&(this.cols=r.cols),r.ngReadonly&&(this.ngReadonly=r.ngReadonly),r.domain&&(this.domain=r.domain),"false"===r.visible?this.visible=!1:"true"===r.visible&&(this.visible=!0),r.ngShow&&(this.ngShow=r.ngShow),r.ngIf&&(this.ngIf=r.ngIf),r.ngClass&&(this.ngClass=r.ngClass),this.attrs=r,a.field=this,a.attrs=r,a.html=$(s).html(),e.app.getTemplate(this.template[t],a)}fromJSON(e,t){t.record[this.name]=e}get validAttributes(){return["name","nolabel","readonly","required"]}getAttributes(e){let t={};this.validAttributes;return this.ngReadonly?t["ng-readonly"]=this.ngReadonly:this.readonly&&(t.readonly=this.readonly),t["ng-model"]="record."+this.name,e.ngFieldChange&&(t["ng-change"]=e.ngFieldChange),this.required&&(t.required=this.required),t}get hasChoices(){return this.info.choices&&this.info.choices.length>0}get name(){return this.info.name}get model(){return this.info.model}get maxLength(){return this.info.max_length}get type(){return this.info.type}get paramTemplate(){return"view.param.String"}format(e){return e.toString()}toJSON(e){return e}createWidget(t,i,s,a){return t||this.hasChoices&&(t="SelectionField"),new(e.Forms.Widgets.registry[t||this.type]||e.Forms.Widgets.StringField)(i,s,this,a)}validate(){}get defaultCondition(){return"="}isControlVisible(e){switch(e){case"is null":case"is not null":return!1}return!0}}t.Field=s;class a extends s{constructor(e){e.cols||(e.cols=3),super(e)}}t.PasswordField=class extends a{constructor(e){e.template||(e.template={}),e.template.form||(e.template.form="view.form.password.jinja2"),e.template.list||(e.template.list="view.list.password.jinja2"),super(e)}};class r extends s{constructor(e){e.cols||(e.cols=3),super(e),this.template.form="view.form.boolean-field.jinja2",this.template.list="view.list.boolean-field.jinja2",this.template.card="view.list.boolean-field.jinja2",this.nolabel=!0}get paramTemplate(){return"view.param.Boolean"}}t.BooleanField=r;class n extends s{constructor(e){e.cols||(e.cols=3),super(e),this.template.form="view.form.date-field.jinja2",this.template.list="view.list.date-field.jinja2",this.template.card="view.list.date-field.jinja2"}toJSON(e){return e}get paramTemplate(){return"view.param.Date"}format(t){return _.isString(t)?moment(t).format(e.i18n.gettext("yyyy-mm-dd").toUpperCase()):""}getAttributes(e){let t=super.getAttributes(e);return t.type="date",t}}class o extends n{constructor(e){e.cols||(e.cols=3),super(e),this.template.form="view.form.datetime-field.jinja2",this.template.list="view.list.datetime-field.jinja2"}get paramTemplate(){return"view.param.DateTime"}getAttributes(e){let t=super.getAttributes(e);return t.type="datetime-local",t}}class l extends o{constructor(e){e.cols||(e.cols=3),super(e),this.template.form="view.form.time-field.jinja2",this.template.list="view.list.time-field.jinja2"}}t.TimeField=l;class c extends s{constructor(e){e.cols||(e.cols=3),super(e),this.template.form="view.form.decimal-field.jinja2",this.template.list="view.list.decimal-field.jinja2"}fromJSON(e,t){t.record[this.name]=parseFloat(e)}toJSON(e){return e&&_.isString(e)?parseFloat(e):e}}t.NumericField=c;class d extends s{constructor(e){e.cols||(e.cols=3),super(e),this.template.form="view.form.numeric-field.jinja2",this.template.list="view.list.numeric-field.jinja2"}toJSON(e){return e&&_.isString(e)?parseInt(e):e}get paramTemplate(){return"view.param.Integer"}}t.IntegerField=d;t.FloatField=class extends c{};class h extends c{constructor(e){super(e),this.decimalPlaces=2,this.info.attrs&&(this.decimalPlaces=this.info.attrs.decimal_places||2)}}t.DecimalField=h;class p extends s{constructor(t){super(t),this.domain=t.domain,Object.assign(this.template,{list:"view.list.foreignkey.jinja2",card:"view.list.foreignkey.jinja2",form:"view.form.foreignkey.jinja2"}),e.settings.ui.isMobile&&(this.template.form="view.form.autocomplete.jinja2")}toJSON(e){return _.isArray(e)?e[0]:e}get validAttributes(){return super.validAttributes.concat(["domain"])}}t.ForeignKey=p;class u extends s{create(){super.create(),this.template.form="view.form.grid.jinja2",this.widget="onetomany",this.cols=12}get field(){return this.info.field}get validAttributes(){return super.validAttributes.concat(["inline-editor","ng-default-values"])}fromJSON(e,t){if(e&&e instanceof Array){let i=t.childByName(this.name);e.map(e=>{"CLEAR"===e.action?(i.scope.records=[],t.record[this.name]=[]):"CREATE"===e.action&&i.scope.addRecord(e.values)}),i.scope.$apply()}}}t.OneToManyField=u;class m extends p{constructor(e){super(e),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.manytomany.jinja2")}toJSON(e){return _.isArray(e)?e.map(e=>_.isArray(e)?e[0]:e):(_.isString(e)&&(e=e.split(",")),e)}}t.ManyToManyField=m;class f extends a{constructor(e){super(e),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.text-field.jinja2")}}t.TextField=f;class g extends f{constructor(e){super(e),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.code-editor.jinja2")}}t.XmlField=g;class v extends f{constructor(e){super(e),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.json-field.jinja2")}}t.JsonField=v;t.PythonCodeField=class extends f{constructor(e){super(e),(!e.template||e.template&&!e.template.form)&&(this.template.form="view.form.python-code.jinja2")}};class w extends s{constructor(e){e.template||(e.template={}),e.template.form||(e.template.form="view.form.image-field.jinja2"),super(e),this.noImageUrl="/static/web/assets/img/no-image.png"}getAttributes(e){let t=super.getAttributes(e);return t.ngSrc=e.ngEmptyImage||e.emptyImage&&`'${e.emptyImage}`||`'${this.noImageUrl}'`,t.ngSrc=`{{ ${t["ng-model"]} || ${t.ngSrc} }}`,t}get ngSrc(){let e=this.attrs.ngEmptyImage||this.attrs.emptyImage&&`'${this.attrs.emptyImage}`||`'${this.noImageUrl}'`;return e=`\${ record.${this.name} || ${e} }`}}t.ImageField=w;function y(t){return new(e.Data.Fields.registry[t.type]||a)(t)}t.fromInfo=y,t.fromArray=function(e){let t={};return Object.keys(e).map(i=>t[i]=y(e[i])),t},t.registry={Field:s,StringField:a,BooleanField:r,DecimalField:h,NumericField:c,IntegerField:d,TextField:f,ImageField:w,DateField:n,DateTimeField:o,TimeField:l,XmlField:g,JsonField:v,ForeignKey:p,ManyToManyField:m,OneToManyField:u,radio:class extends s{}}}(t.Fields||(t.Fields={}))}(e.Data||(e.Data={}))}(Katrid||(Katrid={})),function(e){!function(t){let i;!function(e){e[e.destroyed=0]="destroyed",e[e.created=1]="created",e[e.modified=2]="modified",e[e.unmodified=3]="unmodified"}(i=t.RecordState||(t.RecordState={}));class s{constructor(e,t,s){e||(e=this.newRecord()),this.pristine=e,this.data={},this.dataSource=t,this.pending=null,this.modified=!1,this.children=[],this.state=s||i.unmodified,this.submitted=!1,e.$record=this}get scope(){return this.dataSource.scope}get pk(){return this.pristine.id}addChild(e){-1===this.children.indexOf(e)&&this.children.push(e)}newRecord(){let e={$created:!0};return this.state=i.created,e}delete(){this.state=i.destroyed,this.state===i.unmodified?this.setModified():this.parent.children.indexOf(this)>-1&&this.parent.children.splice(this.parent.children.indexOf(this),1)}_prepareRecord(e,t){console.log(e.constructor.name)}setModified(e){this.modified=!0,e&&this.dataSource.$setDirty(e),this.dataSource._pendingChanges=!0}get parent(){return this.dataSource.parent&&this.dataSource.parent.record.$record}compare(e,t){return _.isArray(e)&&_.isArray(t)?e.join(",")!==t.join(","):e!=t}discard(){this.pending&&Object.assign(this.pristine,this.pending),this.data={}}flush(){this.pending||(this.pending={}),Object.assign(this.pending,this.data),this.parent.addChild(this)}set(e,t){let s=this.dataSource.fieldByName(e);if(s){this.state===i.unmodified&&(this.state=i.modified);let a=this.pristine[e];if(t=s.toJSON(t),this.compare(a,t)&&(this.setModified(e),this.data[e]=t,s.onChange)){let i=this.$encode(this.pristine);if(i[e]=t,this.dataSource.parent&&this.dataSource.fieldName){i[this.dataSource.parent.fields[this.dataSource.fieldName]._info.field]=this.$encode(this.dataSource.parent.record)}this.dataSource.dispatchEvent("field_change_event",[e,i])}}return!0}$encode(e){if(_.isArray(e))return e.map(e=>this.$encode(e));if(_.isObject(e)){let t={};for(let[i,s]of Object.entries(e))i.startsWith("$")||(t[i]=this.$encode(s));return t}return e}$new(){return new s(this.pristine)}serialize(){let e=jQuery.extend({},this.data);for(let t of this.children)t.dataSource.field.name in e||(e[t.dataSource.field.name]=[]),t.state===i.created?e[t.dataSource.field.name].push({action:"CREATE",values:t.serialize()}):t.state===i.modified?e[t.dataSource.field.name].push({action:"UPDATE",values:t.serialize()}):t.state===i.destroyed&&e[t.dataSource.field.name].push({action:"DESTROY",id:t.pk});return this.pk&&(e.id=this.pk),e}}t.Record=s;t.SubRecords=class{constructor(e){this.recs=e}append(e){-1===this.recs.indexOf(e)&&this.recs.push(e)}},t.createRecord=function(t,i){let a=new s(t,i);return t||(t=a.pristine),new Proxy(t,{set(s,a,r,n){if(!a.startsWith("$$")){let s=i.scope,n=i.fieldByName(a);a.startsWith("$")||!s||!n||n instanceof e.Data.Fields.OneToManyField||t.$record.set(a,r)}return Reflect.set(s,a,r,n)}})}}(e.Data||(e.Data={}))}(Katrid||(Katrid={})),function(e){!function(e){!function(e){e.Alerts=class{static success(e){return toastr.success(e)}static warn(e){return toastr.warning(e)}static info(e){return toastr.info(e)}static error(e){return toastr.error(e)}}}(e.Dialogs||(e.Dialogs={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(e){e.keyCode={BACKSPACE:8,COMMA:188,DELETE:46,DOWN:40,END:35,ENTER:13,ESCAPE:27,HOME:36,LEFT:37,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190,RIGHT:39,SPACE:32,TAB:9,UP:38},e.toggleFullScreen=function(){document.fullscreenElement?document.exitFullscreen&&document.exitFullscreen():document.documentElement.requestFullscreen&&document.documentElement.requestFullscreen()},e.uiKatrid=angular.module("ui.katrid",[])}(e.UI||(e.UI={}))}(Katrid||(Katrid={})),function(e){!function(e){!function(e){e.Widget=class{};e.Component=class{};let t=0;e.genId=function(){return++t};class i extends HTMLElement{get field(){return this._field}set field(e){this._field=e,this._fieldEl=e.fieldEl,this.fieldName=e.name,this.view=e.view}bind(e){this.field=e}connectedCallback(){this.actionView=this.closest("action-view"),this._id=++t,this.create()}disconnectedCallback(){this.destroy()}create(){}destroy(){}}e.FieldWidget=i;e.InputField=class extends i{},e.registry={}}(e.Widgets||(e.Widgets={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){let i=e=>{let t=0;return e.find("button").each((i,s)=>{let a=$(s),r=a.attr("type");if(a.attr("type")&&"object"!==a.attr("type")||a.attr("type","button"),"object"===r){let i=a.attr("send-file");if(a.attr("button-object",a.attr("name")),_.isUndefined(i))a.attr("ng-click",`action.formButtonClick(action.selection, '${a.attr("name")}', $event.target);$event.stopPropagation();`);else{let i=`__send_file_${++t}`;e.append(`<input id="${i}" type="file" style="display: none" onchange="Katrid.Services.Upload.sendFile('${a.attr("name")}', this)"/>`),a.attr("send-file",a.attr("name")),a.attr("onclick",`$('#${i}').trigger('click')`)}}else"tag"===r&&(a.attr("button-tag",a.attr("name")),a.attr("onclick","Katrid.Actions.ClientAction.tagButtonClick($(this))"));a.attr("class")||a.addClass("btn btn-outline-secondary")})};t.ClientView=class{constructor(e){this.action=e}get template(){return e.app.getTemplate(this.templateUrl)}render(){return $(this.template)}};class s{constructor(e){this.scope=e}render(){return $(e.app.getTemplate(this.templateUrl))}}t.BaseView=s;class a extends s{constructor(e,t,i,s){super(t),this.action=e,this.view=i,this.templateUrl="view.basic",this.toolbar=!0,this.content=s}getTemplateContext(){return{content:this.content}}render(){return sprintf(e.app.getTemplate(this.templateUrl),this.getTemplateContext())}renderTo(t){e.Core.setContent(this.render(),this.scope)}}t.ActionView=a;class r extends a{getBreadcrumb(){let t='<ol class="breadcrumb">',i=0;for(let s of e.app.actionManager.actions)s instanceof e.Actions.WindowAction&&0===i&&s.viewModes.length>1&&(t+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(0, 0)">${s.info.display_name}</a></li>`),i++,s instanceof e.Actions.WindowAction&&e.app.actionManager.length>i&&"form"===s.viewType&&(t+=`<li class="breadcrumb-item"><a href="#" ng-click="action.backTo(${i-1}, 'form')">${s.scope.record.display_name}</a></li>`);return"form"===this.type&&(t+='<li class="breadcrumb-item">{{ self.display_name }}</li>'),t+"</ol>"}render(){return sprintf(e.app.$templateCache.get(this.templateUrl),{content:this.content})}getViewButtons(){let e=Object.entries(r.buttons).map(e=>this.view.viewModes.includes(e[0])?e[1]:"").join("");return e&&(e=`<div class="btn-group">${e}</div>`),e}}r.buttons={},t.View=r;t.WindowView=class{constructor(e){this.config=e,this.action=e.action,this.viewInfo=e.viewInfo,this.templateUrl=null,this.create()}create(){this.context={},this.config.context&&Object.assign(this.context,this.config.context),this.config.templateUrl&&(this.templateUrl=this.config.templateUrl)}template(){let e=this.viewInfo.content;return e instanceof HTMLElement&&(e=e.cloneNode(!0)),$(e)[0]}render(e){}renderTo(e){this.el=this.render(e),e.append(this.el)}get fields(){return this.viewInfo.fields}renderField(e){let t=e.getAttribute("name");if(t){let i=this.fields[t];if(i){let t=i.assign(this,e);return t.visible?t.el:null}console.error(`Field "${t}" not found`)}}ready(){}createHeader(e){i($(e));let t=e.querySelector("header"),s="";if(t){let e=t.querySelector("field[name=status]");e&&e.setAttribute("status-field","status-field"),t.remove(),s=t.innerHTML}return s}},e.UI.uiKatrid.directive("smartForm",()=>({restrict:"A",link(e,t,i){"edit"in i&&i.$observe("edit",e=>{"false"===e?$(".action-view:first").find(".toolbutton-action-edit").hide():$(".action-view:first").find(".toolbutton-action-edit").show()})}})),t.searchModes=["list","card"],t.registry={}}(t.Views||(t.Views={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){class i extends e.Forms.Views.BaseView{constructor(e,t){super(e),this.templateUrl="dialog.base",this.scope.isDialog=!0}render(){return $(e.app.getTemplate(this.templateUrl).replace("\x3c!-- replace-content --\x3e",this.content))}show(){return this.el||(this.el=$(this.render()),this.root=this.el.find(".modal-dialog-body"),this.el.find("form").first().addClass("row"),this.$compile(this.el)(this.scope)),this.el.modal("show").on("shown.bs.modal",()=>e.UI.uiKatrid.setFocus(this.el.find(".form-field").first())),this.el}}t.Dialog=i;t.Window=class extends i{constructor(t){super(t.scope,t),this.scope._=this.scope.$parent._,this.scope.parentAction=this.scope.action,this.scope.views={form:t.view},this.dialogTitle=t&&t.title||e.i18n.gettext("Create: "),this.scope.view=this.view=t.view,this.scope.model=t.model,this.options=t}async createNew(t){let i=this.options.field;this.scope.$setDirty=(e=>{const t=this.scope.form[e];t&&t.$setDirty()});let s=this.scope.view,a=this.scope;a.views={form:s},a.isDialog=!0,this.dialogTitle,this.action=this.scope.action={scope:this.scope,context:{}};let r=this.action.dataSource=this.scope.dataSource=new e.Data.DataSource(this.scope,this.action),n=new e.Forms.Views.FormView({action:this.action,viewInfo:this.view,dialog:!0,templateUrl:"view.form.dialog.modal.jinja2"}).render(),o=n.find("form:first");if(a.root=o,this.action.$element=o,o.addClass("row"),n.modal("show").on("shown.bs.modal",()=>e.UI.uiKatrid.setFocus(n.find(".form-field").first())).on("hidden.bs.modal",function(){$(this).modal("dispose").remove()}),this.scope.form=o.controller("form"),this.scope.formElement=o,i){let e=this.scope.$on("saveAndClose",async(t,s,a)=>{if(this.scope===s){if(_.isArray(a)&&a.length){let e={},t=(a=await this.scope.$parent.model.getFieldChoices(i.name,null,{ids:a})).items[0];e[i.name]=t,this.scope.$parent.action.dataSource.setValues(e),this.options.sel&&this.options.sel.select2("data",{id:t[0],text:t[1]})}e()}})}return new Promise(async(e,i)=>{setTimeout(async()=>{let i,s;t&&(t.creationName&&(i={creation_name:name}),t.defaultValues&&(s=t.defaultValues)),await r.insert(!0,s,i),this.scope.$apply(),e(n)})})}}}(t.Dialogs||(t.Dialogs={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){class i extends t.WindowView{create(){super.create(),this.viewType="card",this.templateUrl="view.card.jinja2",this.action.view=this}render(t){let i=$(this.template());i.children("field").remove();for(let e of i.find("field")){let t=$(e),i=this.renderField(e);i?t.replaceWith(i):t.replaceWith(`\${ record.${t.attr("name")} }`)}let s=$(e.app.getTemplate(this.templateUrl,{content:i[0].outerHTML}));return e.Core.$compile(s)(this.action.scope)}ready(){setTimeout(()=>this.action.dataSource.open().then(()=>this.action.scope.$apply()),500)}}t.Card=i,t.registry.card=i}(t.Views||(t.Views={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){class i extends t.WindowView{create(){super.create(),this.templateUrl||(this.templateUrl="view.form.jinja2"),this.viewType="form"}template(){let e=super.template();return $(e).find("tabset").tabset(),e}prepare(t){let i=this.template();i.setAttribute("smart-form","smart-form"),i.classList.add("row");let s=this.createHeader(i);for(let e of i.querySelectorAll("field")){if(e.hasAttribute("invisible"))continue;let t=this.renderField(e);t&&(e.parentElement.insertBefore(t,e),e.remove(),t.setAttribute("form-field","form-field"))}let a={};Object.assign(a,this.context),Object.assign(a,{header:s});let r=$(e.app.getTemplate(this.templateUrl,a));return r.find(".template-placeholder").append(i),this.action&&(this.action.$form=r.find("form:first").first()),this.el=r,r}render(t){let i=this.prepare(t);return i=e.Core.$compile(i)(this.action.scope),this.action.form=angular.element(this.action.$form).controller("form"),i.addClass("ng-form"),i}}t.FormView=i;t.FormDialog=class extends i{get caption(){return this.el.attr("caption")}},t.registry.form=i}(t.Views||(t.Views={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){class i extends t.WindowView{create(){super.create(),this.viewType="list",this.templateUrl="view.list.html",this.action.view=this}render(t){let i=this.template();Object.assign({},this.context);let s=this.createHeader(i),a=$(e.app.getTemplate(this.templateUrl));return a.find("header:first").append($(s)),a.find(".template-placeholder").append(i),a.find("list").attr("ng-row-click","action.listRowClick($index, record, $event)").attr("list-options",'{"rowSelector": true}').attr("ng-row-click","action.listRowClick($index, record, $event)"),a=e.Core.$compile(a)(this.action.scope),this.action&&this.action.dataSource&&setTimeout(()=>this.action.dataSource.open()),a}ready(){this.action.dataSource.open()}}t.List=i,t.registry.list=i}(t.Views||(t.Views={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){e.i18n={languageCode:"pt-BR",formats:{},catalog:{},initialize:(t,i,s)=>(e.i18n.plural=t,e.i18n.catalog=i,e.i18n.formats=s,e.i18n.pluralidx=t?function(e){return t instanceof Boolean?t?1:0:t}:function(e){return 1===e?0:1},_.mixin({gettext:e.i18n.gettext,sprintf:sprintf}),e.i18n.initialized=!0),merge:t=>Array.from(t).map(i=>e.i18n.catalog[i]=t[i]),gettext(t){const i=e.i18n.catalog[t];return null!=i?i:t},gettext_noop:e=>e,ngettext(t,i,s){const a=e.i18n.catalog[t];return null!=a?a[e.i18n.pluralidx(s)]:1===s?t:i},pgettext(t){let i=e.i18n.gettext(t);return-1!==i.indexOf("")&&(i=t),i},npgettext(t,i,s,a){let r=e.i18n.ngettext(t+""+i,t+""+s,a);return-1!==r.indexOf("")&&(r=e.i18n.ngettext(i,s,a)),r},interpolate:(t,i,s)=>(s?t.replace(/%\(\w+\)s/g,e=>String(i[e.slice(2,-2)])):t.replace(/%s/g,e=>String(i.shift())),{get_format(t){const i=e.i18n.formats[t];return null!=i?i:t}})},window.KATRID_I18N&&e.i18n.initialize(KATRID_I18N.plural,KATRID_I18N.catalog,KATRID_I18N.formats)}(Katrid||(Katrid={})),function(e){!function(t){!function(t){let i={"=":e.i18n.gettext("Is equal"),"!=":e.i18n.gettext("Is different"),">":e.i18n.gettext("Greater-than"),"<":e.i18n.gettext("Less-than")},s={"=":"","!=":"__isnot",like:"__icontains","not like":"__not_icontains",">":"__gt",">=":"__gte","<":"__lt","<=":"__lte",in:"__in","not in":"__not_in"};class a{constructor(e){this.searchView=e,this.items=[],this.groups=[]}add(e){this.items.includes(e)?(e.facet.addValue(e),e.facet.refresh()):(this.items.push(e),this.searchView.renderFacets()),e instanceof m&&this.groups.push(e),this.searchView.change()}loadItem(e){this.items.push(e),e instanceof m&&this.groups.push(e)}remove(e){this.items.splice(this.items.indexOf(e),1),e instanceof m&&this.groups.splice(this.groups.indexOf(e),1),this.searchView.change()}getParams(){let e=[];for(let t of this.items)e=e.concat(t.getParamValues());return e}}class r{constructor(e){this.item=e,this.values=[]}get separator(){return` <span class="facet-values-separator">${e.i18n.gettext("or")}</span> `}init(e,t){this.item=e,this.values=t||[{searchString:this.item.getDisplayValue(),value:this.item.value}]}addValue(e){return this.values.push(e)}get caption(){return this.item.caption}clear(){this.values=[]}get templateValue(){return Array.from(this.values).map(e=>e instanceof h?e.display:e).join(this.separator)}template(){}link(e){const t=$(this.template());return this.item.facet=this,this.element=t,t.find(".facet-remove").click(t=>e.onRemoveItem(t,this.item)),t}render(e){}refresh(){return this.element.find(".facet-value").html(this.templateValue)}load(e){e.query.loadItem(this.item),this.render(e)}destroy(){this.clear()}getParamValues(){const e=[];for(let t of this.values)e.push(this.item.getParamValue(t));return e.length>1?[{OR:e}]:e}}class n extends r{constructor(...e){super(e),this.grouping=!0}clear(){let e=this.values;super.clear();for(let t of e)t._ref&&(t._ref._selected=!1)}get separator(){return" <span> &gt; </span> "}get caption(){return'<span class="fa fa-bars"></span>'}}class o{constructor(e,t,i){this.view=e,this.name=t,this.el=i}getDisplayValue(){return this.value?this.value[1]:this.searchString}getParamValue(e,t){let i={};return _.isArray(t)?i[e]=t[0]:i[e+"__icontains"]=t,i}_doChange(){this.view.update()}}class l extends o{constructor(e,t,i,s,a,r){super(e,t,r),this.group=a,this.caption=i,_.isString(s)&&(s=JSON.parse(s.replace(/'/g,'"'))),this.domain=s,this._selected=!1}static fromItem(e,t,i){return new l(e,t.attr("name"),t.attr("caption")||t.attr("label"),t.attr("domain"),i,t)}toString(){return this.caption}toggle(){this.selected=!this.selected}get selected(){return this._selected}set selected(e){this._selected=e,e?this.group.addValue(this):this.group.removeValue(this),this._doChange()}getDisplayValue(){return this.caption}get facet(){return this.group.facet}getParamValue(){return this.domain}get value(){return this.domain}}class c extends Array{constructor(e,t){super(),this.view=e,this._selection=[],t||(t=new r(this)),this._facet=t}static fromItem(e,t){let i=new c(e);return i.push(l.fromItem(e,t,i)),i}static fromGroup(e,t){let i=new c(e);for(let s of t.children())i.push(l.fromItem(e,$(s),i));return console.log(i),i}addValue(e){this._selection.push(e),this._facet.values=this._selection.map(e=>new h(e.toString(),e.value)),this._refresh()}removeValue(e){this._selection.splice(this._selection.indexOf(e),1),this._facet.values=this._selection.map(e=>({searchString:e.getDisplayValue(),value:e.value})),this._refresh()}selectAll(){for(let e of this)this.addValue(e);this.view.update()}get caption(){return'<span class="fa fa-filter"></span>'}_refresh(){console.log(this.view),this._selection.length?-1===this.view.facets.indexOf(this._facet)&&this.view.facets.push(this._facet):this.view.facets.indexOf(this._facet)>-1&&this.view.facets.splice(this.view.facets.indexOf(this._facet),1)}getParamValue(e){return e.value}clear(){this._selection=[]}}class d extends c{constructor(e,t){t||(t=new n),super(e,t)}static fromGroup(e){let t=e.view,i=e.el,s=e.facet||t.facetGrouping,a=new d(t,s);if(i)for(let e of i.children())a.push(m.fromItem(t,$(e),a));return a}addValue(e){this.view.groupLength++;let t=new h(e.toString(),e.value);t._ref=e,this._facet.values.push(t),this._refresh()}removeValue(e){this.view.groupLength--;for(let t of this._facet.values)if(t._ref===e){this._facet.values.splice(this._facet.values.indexOf(t),1);break}this._refresh()}_refresh(){this._facet.values.length?-1===this.view.facets.indexOf(this._facet)&&this.view.facets.push(this._facet):this.view.facets.indexOf(this._facet)>-1&&this.view.facets.splice(this.view.facets.indexOf(this._facet),1)}}class h{constructor(e,t){this.display=e,this.value=t}}class p{constructor(e,t){this.field=e,this.value=t,this.text=t[1],this.indent=!0}select(){this.field.selectItem(this.value)}}class u extends o{constructor(e,t,i,s){super(e,t,i),this.field=s,this._expanded=!1,"ForeignKey"===s.type?(this.expandable=!0,this.children=[]):this.expandable=!1}get expanded(){return this._expanded}set expanded(e){if(this._expanded=e,e)this._loadChildren();else if(this.children=[],this.view.$items)for(let e=this.view.$items.length-1;e>0;e--){this.view.$items[e].field===this&&this.view.$items.splice(e,1)}}_loadChildren(){this.loading=!0,this.view.scope.model.getFieldChoices(this.name,this.view.text).then(e=>{this.children=e.items;let t=this.view.$items.indexOf(this);if(t>-1)for(let e of this.children)t++,this.view.$items.splice(t,0,new p(this,e))}).finally(()=>this.view.scope.$apply(()=>this.loading=!1))}get facet(){return this._facet||(this._facet=new r(this)),this._facet}getDisplayValue(){return this.value}getParamValue(e){let t={},i=this.name;if(_.isArray(e))t[i]=e[0];else{if(e instanceof h)return e.value;t[i+"__icontains"]=e}return t}get caption(){return this.field.caption}get value(){return this._value?this._value[1]:this.view.text}select(){this.facet.addValue(this.value),this.view.addFacet(this.facet),this.view.close(),this.view.update()}selectItem(e){let t={};t[this.field.name]=e[0],this.facet.addValue(new h(e[1],t)),this.view.addFacet(this.facet),this.view.close(),this.view.update()}static fromField(e,t){let i=e.view.fields[t.attr("name")];return new u(e,i.name,t,i)}get template(){return _.sprintf(e.i18n.gettext("Search <i>%(caption)s</i> by: <strong>%(text)s</strong>"),{caption:this.field.caption,text:this.view.text})}}class m extends l{constructor(e,t,i,s,a){super(e,t,a),this.group=s,this.caption=i,this._selected=!1}static fromItem(e,t,i){return new m(e,t.attr("name"),t.attr("caption"),i,t)}toString(){return this.caption}}e.UI.uiKatrid.controller("CustomFilterController",["$scope","$element","$filter",function(e,t,a){e.tempFilter=null,e.customFilter=[],e.fieldChange=function(t){e.field=t,e.condition=t.defaultCondition,e.conditionChange(e.condition)},e.conditionChange=(t=>{e.controlVisible=e.field.isControlVisible(t)}),e.valueChange=(t=>{e.searchValue=t}),e.addCondition=((t,a,r)=>{e.tempFilter||(e.tempFilter=new c(e.$parent.action.searchView)),e.tempFilter.push(new class extends l{constructor(e,t,i,s,a){super(e,t.name,t.caption,null,a),this.field=t,this.condition=i,this._value=s,this._selected=!0}toString(){let e=this.field.format(this._value);return this.field.caption+" "+i[this.condition].toLowerCase()+' "'+e+'"'}get value(){let e={};return e[this.field.name+s[this.condition]]=this._value,e}}(e.$parent.action.searchView,t,a,r,e.tempFilter)),e.field=null,e.condition=null,e.controlVisible=!1,e.searchValue=void 0}),e.applyFilter=(()=>{e.searchValue&&e.addCondition(e.field,e.condition,e.searchValue),e.customFilter.push(e.tempFilter),e.tempFilter.selectAll(),e.tempFilter=null,e.customSearchExpanded=!1})}]).directive("customFilter",()=>({restrict:"A",scope:{action:"="}}));class f{constructor(t,i,s){if(this.scope=t,this.element=i,this.query=new a(this),this._viewMoreButtons="true"===localStorage.getItem("katrid.search.viewMoreButtons"),this.items=[],this.fields=[],this.filterGroups=[],this.groups=[],this._groupLength=this.groupLength=0,this.facets=[],this.input=i.find(".search-view-input"),this.view=s,this.$items=null,this.facetGrouping=new n,s){this.el=$(s.content),this.menu=i.find(".search-dropdown-menu.search-view-menu");for(let e of this.el.children()){let t,i=(e=$(e)).prop("tagName");if("FILTER"===i)t=c.fromItem(this,e),this.filterGroups.push(t);else{if("FILTER-GROUP"===i){t=c.fromGroup(this,e),this.filterGroups.push(t);continue}if("GROUP"===i){t=m.fromItem({view:this,el:e}),this.groups.push(t);continue}if("FIELD"===i){t=u.fromField(this,e),this.fields.push(t);continue}}console.log("obj",t),t&&this.append(t)}this.input.on("input",e=>this.input.val().length?this.show():this.close()).on("keydown",t=>{switch(t.which){case e.UI.keyCode.DOWN:this.move(1),t.preventDefault();break;case e.UI.keyCode.UP:this.move(-1),t.preventDefault();break;case e.UI.keyCode.ENTER:this.scope.$apply(()=>angular.element(this.menu.find("li.active a.search-menu-item")).scope().item.select(t));break;case e.UI.keyCode.BACKSPACE:""===this.input.val()&&(this.scope.$apply(()=>this.facets.splice(this.facets.length-1,1).map(e=>e.clear())),this.update())}}).on("blur",e=>(this.input.val(""),this.close()))}}addCustomGroup(e){this.customGroups||(this.customGroups=new d(this,this.facetGrouping),this.groups.push(this.customGroups));let t=new m(this,e.name,e.caption,this.customGroups);this.customGroups.push(t),t.selected=!0}set viewMoreButtons(e){this._viewMoreButtons!==e&&(this._viewMoreButtons=e,localStorage.setItem("katrid.search.viewMoreButtons",e.toString()))}get viewMoreButtons(){return this._viewMoreButtons}load(e){Object.entries(e).map((e,t)=>{let i=this.getByName(e[0]);i&&(i.selected=!0)})}getByName(e){for(let t of this.filterGroups)for(let i of t)if(i.name===e)return i;for(let t of this.items)if(t.name===e)return t}append(e){this.items.push(e)}addFacet(e){this.facets.includes(e)||this.facets.push(e)}first(){this.menu.find("li.active a.search-menu-item").removeClass("active"),this.menu.find("li:first").addClass("active")}remove(e){this.facets[e].destroy(),this.facets.splice(e,1),this.update()}getParams(){let e=[];for(let t of this.facets)t.grouping||(e=e.concat(t.getParamValues()));return e}dump(){let e=[];for(let t of this.facets)e.push(t);return e}move(e){const t=e>0;for(e=Math.abs(e);0!==e;){e--;let i=this.element.find(".search-view-menu li.active");i.length?(i.removeClass("active"),(i=t?i.next():i.prev()).addClass("active")):(i=t?this.element.find(".search-view-menu > li:first"):this.element.find(".search-view-menu > li:last")).addClass("active")}}update(){this.groupLength!==this._groupLength?(this._groupLength=this.groupLength,this.scope.action.applyGroups(this.groupBy(),this.getParams())):this.scope.action.setSearchParams(this.getParams())}groupBy(){return this.facetGrouping.values.map(e=>e._ref.name)}show(){let e=!1;this.$items||(this.$items=[].concat(this.fields),e=!0);for(let t of this.$items)t.expanded&&(t.expanded=!1,e=!0);e&&this.scope.$apply(),this.menu.show(),this.first()}close(){this.$items=null,this.menu.hide(),this.reset(),this.input.val("")}reset(){for(let e of this.fields)e&&e.children&&e.children.length&&(e.expanded=!1)}}e.UI.uiKatrid.controller("SearchMenuController",["$scope",function(e){}]),e.UI.uiKatrid.directive("searchView",class{constructor(){this.restrict="E",this.templateUrl="view.search.jinja2",this.replace=!0,this.scope=!1}}),e.UI.uiKatrid.directive("searchViewArea",class{constructor(){this.restrict="A",this.scope=!1}link(e,t,i){let s=e.action.views.search;e.action.searchView=new f(e,t,s),e.action.context.default_search&&e.action.searchView.load(e.action.context.default_search)}})}(t.Views||(t.Views={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(e){!function(e){e.ViewInfo=class{constructor(e){this._info=e,this.fields=e.fields,this.content=e.content,this.toolbar=e.toolbar}}}(e.Views||(e.Views={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){let i=0,s={BooleanField:3,DecimalField:3,FloatField:3,DateField:3,DateTimeField:3,IntegerField:3,SmallIntegerField:3,TimeField:3,CharField:3,OneToManyField:12};class a{constructor(e,t,i,a){if(this.attrs=t,this.scope=e,this.templAttrs={},this.wAttrs={},this.field=i,this.element=a,this.content=a.html(),this.spanPrefix="",null!=i.depends&&i.depends.length&&e.dataSource.addFieldWatcher(i),t.ngShow&&(this.templAttrs["ng-show"]=t.ngShow),(t.ngReadonly||i.readonly)&&(this.templAttrs["ng-readonly"]=t.ngReadonly||i.readonly),i.attrs)for(let e of i.attrs){let s=i.attrs[e];(e.startsWith("container")||"ng-show"===e&&!t.ngShow)&&(this.templAttrs[e]=s)}t.ngFieldChange&&(this.wAttrs["ng-change"]=t.ngFieldChange);let r=t.cols;r||("CharField"===i.type&&i.max_length&&i.max_length<30&&(r=3),r||(r=s[i.type]||6)),this.col=r,this.classes=["form-field"],i.onchange&&e.$watch()}static get tag(){return"input"}fieldChangeEvent(){}get caption(){return this.element.attr("label")||this.field.caption}renderTo(e,t=!1,i=""){let s=[];for(let[e,t]of Object.entries(this.templAttrs))s.push(e+'="'+t+'"');return t?`<${e} class="${i}" ${s.join("")}>${this.template(this.scope,this.element,this.attrs,this.field)}</${e}>`:`<${e} class="${this.field.type} section-field-${this.field.name} form-group" ${s.join("")}>`+this.template(this.scope,this.element,this.attrs,this.field)+`</${e}>`}get ngModel(){return`record.${this.field.name}`}get id(){return this._id||(this._id=++i),`katrid-input-${this._id.toString()}`}widgetAttrs(...e){let t;const i=this.wAttrs;if(this.field.required&&(i.required=null),i["ng-model"]=this.ngModel,this.field.attrs)for(let e of Object.keys(this.field.attrs))t=this.field.attrs[e],e.startsWith("container-")||"ng-show"===e||"ng-readonly"===e||(i[e]=t);if(!_.isUndefined(this.attrs.$attr))for(let e of Object.keys(this.attrs.$attr)){let s=this.attrs.$attr[e];s.startsWith("container-")||"ngShow"===e||"ngReadonly"===e||(t=this.attrs[e],s.startsWith("field-")?s=s.substr(6,s.length-6):"class"===s&&this.classes.push(t),i[s]=t)}return(null!=this.attrs.readonly||this.field.readonly)&&(i.readonly=""),this.classes&&(i.class=this.classes.join(" ")),i}_getWidgetAttrs(e,t,i,s){let a="",r=this.widgetAttrs(e,t,i,s);for(let e in r){const t=r[e];a+=` ${e}`,(t||!1===t)&&(_.isString(t)&&t.indexOf('"')>-1?a+=`='${t}'`:a+=`="${t}"`)}return this.placeholder&&(a+=` placeholder="${this.placeholder}" `),a}innerHtml(){return""}labelTemplate(){const e=this.caption;return"placeholder"===this.attrs.nolabel?(this.placeholder=e,""):_.isUndefined(this.attrs.nolabel)?`<label for="${this.id}" class="form-label">${e}</label>`:""}get emptyText(){return this.inplaceEditor?"":"--"}get readOnlyClass(){return this.inplaceEditor||"::"===this.spanPrefix?"grid-field-readonly":"form-field-readonly"}spanTemplate(e,t,i,s){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}record.${this.field.name}.toString() || '${this.emptyText}' }}</span>`}widgetTemplate(){let e=`<${this.constructor.tag} id="${this.id}" name="${this.field.name}" ${this._getWidgetAttrs()}>`;const t=this.innerHtml();return t&&(e+=t+`</${this.constructor.tag}>`),e}template(...e){let t="",i=this.spanTemplate();this.inplaceEditor||(t=this.labelTemplate());let s=this.widgetTemplate();return"inline"===this.inline&&(s=`<div ng-if="dataSource.changing && dataSource.recordIndex === $index">${s}</div>`),`<div>${t}${i}${s}</div>`}link(e,t,i,s,a){if(a.depends)return(()=>{const t=[];for(let i of Array.from(a.depends))Array.from(e.dataSource.fieldChangeWatchers).includes(i)||(e.dataSource.fieldChangeWatchers.push(i),t.push(e.$watch(`record.${i}`,function(t,s){if(t!==s&&e.dataSource.changing)return e.model.onFieldChange(i,e.record).done(e.dataSource.onFieldChange)})));return t})()}th(){let e=`${this.field.type} list-column`,t=this.element.attr("label")||`{{view.fields.${this.field.name}.caption}}`;return`<th class="${e}" name="${this.field.name}"><span>${t}</span></th>`}_gridEditor(e){return this.renderTo("section",!0,e)}_tdContent(){return this.spanTemplate()}_td(e){let t;return this.inplaceEditor?t=this._gridEditor(e):(this.spanPrefix="::",t=this.spanTemplate()),`<td class="${e}">${t}</td>`}}t.Field=a;class r extends a{static get tag(){return"input input-field"}constructor(e,t,i,s){super(e,t,i,s),this.classes.push("form-control")}get type(){return"text"}widgetTemplate(){this.type;const e=this.attrs.icon;let t=`<${this.constructor.tag} id="${this.id}" type="${this.type}" name="${this.field.name}" ${this._getWidgetAttrs()}>`;if(e)return`<label class="prepend-icon"><i class="icon ${e}"></i>${t}</label>`;const i=this.innerHtml();return i&&(t+=i+`</${this.constructor.tag}>`),t}}class n extends r{widgetAttrs(){const e=super.widgetAttrs();return this.field.maxLength&&(e.maxlength=this.field.maxLength.toString()),e}}t.StringField=n;class o extends r{static get tag(){return"input decimal"}get type(){return e.settings.ui.isMobile?"number":"text"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|number) || '${this.emptyText}' }}</span>`}}t.NumericField=o;class l extends o{static get tag(){return'input decimal decimal-places="0"'}}t.IntegerField=l;class c extends r{get type(){return"time"}}t.TimeField=c;class d extends r{static get tag(){return"select"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}view.fields.${this.field.name}.displayChoices[record.${this.field.name}] || '${this.emptyText}' }}</span>`}innerHtml(){return`<option ng-repeat="choice in view.fields.${this.field.name}.choices" value="{{choice[0]}}">{{choice[1]}}</option>`}}t.SelectionField=d;class h extends a{static get tag(){return"input fk-autocomplete"}spanTemplate(){let e=!0;return(null!=this.attrs.allowOpen&&"false"===this.attrs.allowOpen||null==this.attrs.allowOpen&&this.field.attrs&&!1===this.field.attrs["allow-open"])&&(e=!1),!e||this.inList?`<span class="${this.readOnlyClass}"><a href="javascript:void(0)">{{ ${this.spanPrefix}record.${this.field.name}[1] || '${this.emptyText}' }}</a></span>`:`<span class="${this.readOnlyClass}"><a href="#/action/${this.field.model}/view/?id={{ ${this.spanPrefix}record.${this.field.name}[0] }}" ng-click="action.openObject('${this.field.model}', record.${this.field.name}[0], $event, '${this.field.caption}')">{{ ${this.spanPrefix}record.${this.field.name}[1] }}</a><span ng-if="!record.${this.field.name}[1]">--</span></span>`}get type(){return"text"}_tdContent(){return`{{record.${this.field.name}[1]}}`}}t.ForeignKey=h;class p extends n{static get tag(){return"textarea"}}t.TextField=p;class u extends p{}t.XmlField=u;class m extends o{static get tag(){return e.settings.ui.isMobile?"input":"input decimal"}get type(){return e.settings.ui.isMobile?"number":"text"}spanTemplate(){let e=this.attrs.decimalPlaces||2;return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|number:${e}) || '${this.emptyText}' }}</span>`}_tdContent(){let e,t=this.element.attr("decimal-places");return t?e`number:${t}`:e=`numberFormat:${this.element.attr("max-digits")||6}`,`{{::record.${this.field.name}|${e} }}`}}t.FloatField=m;class f extends m{spanTemplate(){let e=this.attrs.maxDigits,t="number";return e?t="numberFormat":e=this.attrs.decimalPlaces||2,`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|${t}:${e}) || '${this.emptyText}' }}</span>`}}t.DecimalField=f;class g extends p{static get tag(){return"input date-input"}get type(){return"date"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|date:'${e.i18n.gettext("yyyy-mm-dd").replace(/[m]/g,"M")}') || '${this.emptyText}' }}</span>`}}t.DateField=g;class v extends a{static get tag(){return"grid"}spanTemplate(){return""}innerHtml(){return this.content}}t.OneToManyField=v;class w extends a{static get tag(){return"input foreignkey multiple"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}record.${this.field.name}|m2m }}</span>`}get type(){return"hidden"}}t.ManyToManyField=w;class $ extends r{spanTemplate(){return`<span class="${this.readOnlyClass} bool-text">\n  {{${this.spanPrefix}record.${this.field.name} ? '${e.i18n.gettext("yes")}' : '${e.i18n.gettext("no")}'}}\n  </span>`}get type(){return"checkbox"}widgetTemplate(){let e=super.widgetTemplate();return e=`<label class="checkbox" ng-show="dataSource.changing">${e}`,this.field.help_text?e+=this.field.help_text:e+=this.field.caption,e+="<i></i></label>"}labelTemplate(){return this.field.help_text?super.labelTemplate():`<label for="${this.id}" class="form-label form-label-checkbox"><span>${this.caption}</span>&nbsp;</label>`}}class y extends r{static get tag(){return"input file-reader"}get type(){return"file"}}t.FileField=y;class b extends y{static get tag(){return'input file-reader accept="image/*"'}spanTemplate(){return""}widgetTemplate(){let t=super.widgetTemplate(),i=this.attrs.ngEmptyImage||this.attrs.emptyImage&&"'"+this.attrs.emptyImage+"'"||"'/static/web/assets/img/no-image.png'";return t=`<div class="image-box image-field">\n  <img ng-src="{{ record.${this.field.name} || ${i} }}" />\n    <div class="text-right image-box-buttons">\n    <button class="btn btn-default" type="button" title="${e.i18n.gettext("Change")}" onclick="$(this).closest('.image-box').find('input').trigger('click')"><i class="fa fa-pencil"></i></button>\n    <button class="btn btn-default" type="button" title="${e.i18n.gettext("Clear")}" ng-click="record[this.field.name] = null"><i class="fa fa-trash"></i></button>\n    </div>\n      ${t}</div>`}}t.ImageField=b;class x extends r{get type(){return"password"}spanTemplate(){return'<span class="form-field-readonly">*******************</span>'}}class S extends a{constructor(e,t,i,s){super(e,t,i,s),this.col=null}static get tag(){return"sortable-field"}get type(){return"hidden"}th(){return`<th class="list-column-sortable" name="${this.field.name}"></th>`}spanTemplate(){return`<sortable-field id="${this.id}" name="${this.field.name}" ng-model="record.${this.field.name}"/>`}}t.SortableField=S,Object.assign(e.Forms.Widgets.registry,{Field:a,InputWidget:r,StringField:n,IntegerField:l,SelectionField:d,ForeignKey:h,TextField:p,DecimalField:f,FloatField:m,DateField:g,DateTimeField:class extends p{static get tag(){return"input date-input"}get type(){return"datetime-local"}spanTemplate(){return`<span class="${this.readOnlyClass}">{{ ${this.spanPrefix}(record.${this.field.name}|date:'${e.i18n.gettext("yyyy-MM-dd hh:mma")}') || '${this.emptyText}' }}</span>`}},TimeField:c,BooleanField:$,OneToManyField:v,ManyToManyField:w,FileField:y,PasswordField:x,ImageField:b,SortableField:S,XmlField:u,input:r,string:n,integer:l,selection:d,text:p,decimal:f,float:m,file:y,boolean:$,password:x,image:b,sortable:S})}(t.Widgets||(t.Widgets={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){!function(t){class i extends t.FieldWidget{create(){super.create(),this._viewMode=this._fieldEl.getAttribute("view-mode")||"list",this._model=new e.Services.Model(this.field.info.model),this._scope=this.actionView.action.scope.$new(!0),this._action=new s(this);let t={},i=this._fieldEl.querySelector("template");if(i)for(let e of i.content.children)t[e.tagName.toLowerCase()]=e.cloneNode(!0);this._dataSource=new e.Data.DataSource({model:this._model,scope:this._scope,master:this.actionView.action.dataSource,field:this.field,action:this._action}),this.loadViews(t)}get dataSource(){return this._dataSource}get scope(){return this._scope}get model(){return this._model}async loadViews(t){let i={form:null};i[this._viewMode]=null;let s=await this.model.loadViews({views:i});this.views=s.views;let a=this._viewInfo=s.views[this._viewMode],r=a.fields[this.field.info.field];r&&(r.visible=!1);for(let e of Object.keys(t))e in s.views||(s.views[e]={fields:s.fields}),s.views[e].content=t[e],s.views[e].fields=s.fields;this._scope.action=this._action,this.view=new e.Forms.Views.registry[this._viewMode]({action:this._action,viewInfo:a}),this._scope.views=s.views,this._scope.view=this.view,this.render(this.view.render(this)[0]),this.querySelector(".content")}render(t){let i=this.renderToolbar();e.Core.$compile(i)(this._scope),this.appendChild(i),this.appendChild(t)}renderToolbar(){let t=document.createElement("div");t.classList.add("grid-toolbar","col-12");let i=document.createElement("button");return i.setAttribute("type","button"),i.classList.add("btn","btn-xs","btn-outline-secondary","grid-editor-control"),i.innerText=e.i18n.gettext("Add"),i.setAttribute("ng-if","$parent.action.dataSource.changing"),t.appendChild(i),i.addEventListener("click",()=>this._action.addItem()),t}get viewMode(){return this._viewMode}async showDialog(){let t=this.views.form,i=t.fields[this.field.info.field];i&&(i.visible=!1);let s=new e.Forms.Views.FormDialog({action:this._action,viewInfo:t,templateUrl:"view.form.empty.jinja2"}),a=s.prepare();this._action.view=s,this._scope.view=s;let r=$(e.app.getTemplate("view.form.dialog.jinja2",{caption:s.caption||this.field.caption}));this.dlg=r,r[0].action=this._action,r.find(".modal-body").append(a),r.modal("show"),r.on("hidden",()=>r.data("modal",null)),e.Core.$compile(r)(this._scope),this._action.form=angular.element(this._action.$form).controller("form")}destroy(){super.destroy(),this._dataSource.destroy()}}t.OneToManyWidget=i,e.define("onetomany-field",i);class s{constructor(e){this.field=e,this.scope=e.scope}get dataSource(){return this.field.dataSource}listRowClick(e,t,i){this.editItem(t)}async addItem(){this.field.showDialog(),await this.field.dataSource.insert(),this.field.dataSource.record[this.field.info.field]=this.field.actionView.action.dataSource.recordId}editItem(e){console.log("item click"),this.field.scope.record=e,this.field.actionView.action.dataSource.changing&&this.field.dataSource.edit(),this.field.showDialog()}setDirty(){console.log("set dirty")}saveAndClose(){this.field.dlg.modal("hide"),this.field.dataSource.flush(),this.scope.records.push(this.scope.record)}}e.define("radio-field",class extends t.FieldWidget{create(){super.create();let e=document.createElement("div");e.setAttribute("ng-repeat",`choice in view.viewInfo.fields.${this.field.name}.choices`),e.classList.add("radio-button","radio-inline");let t=this._fieldEl.getAttribute("class");t&&e.classList.add(t.split(" "));let i=document.createElement("input"),s=`id-${this.field.name}-${this._id}-\${$index}`;i.setAttribute("id",s),i.setAttribute("type","radio"),i.setAttribute("ng-model",`$parent.record.${this.field.name}`),i.setAttribute("ng-value","choice[0]");let a=document.createElement("label");a.setAttribute("ng-bind","choice[1]"),a.setAttribute("for",s),e.appendChild(i),e.appendChild(a),this.appendChild(e)}})}(t.Widgets||(t.Widgets={}))}(e.Forms||(e.Forms={}))}(Katrid||(Katrid={})),function(e){!function(t){class i{constructor(e){this.name=e}static get url(){return"/api/rpc/"}static $fetch(t,i,s){return s&&(t=new URL(t),Object.entries(s).map((e,i)=>t.searchParams.append(e,i))),$(e).trigger("fetch.before"),fetch(t,i).then(t=>($(e).trigger("fetch.done"),t))}static $post(e,t,i){return this.$fetch(e,{method:"POST",credentials:"same-origin",body:JSON.stringify(t),headers:{"content-type":"application/json"}},i).then(e=>e.json())}delete(e,t,i){}get(t,i){const s=this.name?this.name+"/":"",a=e.settings.server+this.constructor.url+s+t+"/";return $.get(a,i)}post(t,i,s){let a;e.app&&(a=e.app.context),i||(i={}),a&&(i.context=a),i={method:t,params:i};const r=this.name?this.name+"/":"";let n=e.settings.server+this.constructor.url+r+t+"/";return s&&(n+=`?${$.param(s)}`),new Promise((t,s)=>{fetch(n,{method:"POST",body:JSON.stringify(i),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.json()).then(i=>{if(i.error)s(i.error);else{if(i.result){let t;t=i.result.messages?i.result.messages:[],i.result.message?t.push(i.result.message):i.result.warn?t.push({type:"warn",message:i.result.warn}):i.result.info?t.push({type:"info",message:i.result.info}):i.result.error&&t.push({type:"error",message:i.result.error}),t.forEach(function(t){_.isString(t)?e.Forms.Dialogs.Alerts.success(t):"warn"===t.type?e.Forms.Dialogs.Alerts.warn(t.message):"info"===t.type?e.Forms.Dialogs.Alerts.info(t.message):"error"!==t.type&&"danger"!==t.type||e.Forms.Dialogs.Alerts.error(t.message)})}t(i.result)}}).catch(e=>s(e))})}}t.Service=i;class s extends i{static get url(){return"/web/data/"}reorder(e,t,i="sequence",s=0){return this.post("reorder",{args:[e,t,i,s]})}}t.Data=s;t.Attachments=class{static destroy(t){new e.Services.Model("ir.attachment").destroy(t)}static upload(e,t=null){let i=new FormData;t||(t=angular.element(e).scope()),console.log(e),i.append("model",t.model.name),i.append("id",t.recordId);for(let t of e.files)i.append("attachment",t,t.name);return $.ajax({url:"/web/content/upload/",type:"POST",data:i,processData:!1,contentType:!1}).done(e=>{if(t.attachments||(t.attachments=[]),e&&e.result)for(let i of e.result)t.attachments.push(i);t.$apply()})}};t.data=new s(""),t.post=function(e,t){return fetch(e,{method:"POST",body:JSON.stringify(t),headers:{Accept:"application/json","Content-Type":"application/json"}}).then(e=>e.json())}}(e.Services||(e.Services={}))}(Katrid||(Katrid={})),function(e){!function(t){class i extends t.Service{searchName(e){let t={name:e};return this.post("search_name",t)}createName(e){let t={name:e};return this.post("create_name",{kwargs:t})}search(e,t){return this.post("search",{kwargs:e},t)}destroy(e){return _.isArray(e)||(e=[e]),this.post("destroy",{kwargs:{ids:e}})}getById(e){return this.post("get",{args:[e]})}getDefaults(e){return this.post("get_defaults",{kwargs:e})}copy(e){return this.post("copy",{args:[e]})}static _prepareFields(t){return t&&(t.fields=e.Data.Fields.fromArray(t.fields),t.fieldList=Object.values(t.fields),t.views&&(Object.values(t.views).map(t=>t.fields=e.Data.Fields.fromArray(t.fields)),Object.keys(t.views).map(i=>t.views[i]=new e.Forms.Views.ViewInfo(t.views[i])))),t}getViewInfo(e){return this.post("get_view_info",{kwargs:e}).then(this.constructor._prepareFields)}async loadViews(e){return this.post("load_views",{kwargs:e}).then(this.constructor._prepareFields)}getFieldsInfo(e){return this.post("get_fields_info",{kwargs:e}).then(this.constructor._prepareFields)}getFieldChoices(e,t,i){return this.post("get_field_choices",{args:[e,t],kwargs:i})}doViewAction(e){return this.post("do_view_action",{kwargs:e})}write(t,i){return new Promise((s,a)=>{this.post("write",{kwargs:{data:t}},i).then(t=>{e.Forms.Dialogs.Alerts.success(e.i18n.gettext("Record saved successfully.")),s(t)}).catch(t=>{500===t.status&&t.responseText?alert(t.responseText):e.Forms.Dialogs.Alerts.error(e.i18n.gettext("Error saving record changes")),a(t)})})}groupBy(e,t){return this.post("group_by",{kwargs:{grouping:e,params:t}})}autoReport(){return this.post("auto_report",{kwargs:{}})}rpc(t,i,s){return new Promise((a,r)=>{this.post(t,{args:i,kwargs:s}).then(e=>{e&&e.open&&window.open(e.open),a(e)}).catch(t=>{if(t.messages&&_.isObject(t.messages))for(let i of Object.values(t.messages))e.Forms.Dialogs.Alerts.error(i.join("\n"));else e.Forms.Dialogs.Alerts.error(t.message);r(t)})})}}t.Model=i;class s extends i{constructor(){super("ir.query")}static read(e){let t,i,a;return _.isObject(e)?(t=e.details,a=e.params,i=e.id):i=e,(new s).post("read",{args:[i],kwargs:{with_desc:t,params:a,as_dict:e.as_dict}})}static all(){return(new s).rpc("all")}static executeSql(e){return(new s).post("execute_sql",{args:[e]})}}t.Query=s;t.Actions=class extends i{static load(e){return new i("ir.action").post("load",{args:[e]})}}}(e.Services||(e.Services={}))}(Katrid||(Katrid={})),function(){Katrid.UI.uiKatrid.directive("fileManager",()=>({restrict:"E",scope:{},templateUrl:"file-manager.jinja2",link(e,t){e.level=0,e.levels={};let i=new class{constructor(e){this.$element=e.el,this.$scope=e.scope,this.service=this.$element.attr("service"),$.get(this.service).then(e=>{this.$scope.dirs=e.content.filter(e=>"dir"===e.type),this.$scope.files=e.content.filter(e=>"file"===e.type),this.$scope.items=e.content,this.$scope.levels[this.$scope.level]=this.$scope.items,this.$scope.$apply()})}getPath(e){let t=e.name,i=e.parent;for(;i;)t=i.name+"/"+t,i=i.parent;return t}expand(e){let t=this.getPath(e);t=this.service+"?path="+t,$.get(t).then(t=>{this.$scope.items=t.content,this.$scope.dirs=t.content.filter(e=>"dir"===e.type),this.$scope.files=t.content.filter(e=>"file"===e.type),t.content.map(t=>t.parent=e),this.$scope.levels[this.$scope.level]=this.$scope.items,this.$scope.$apply()})}}({el:t,scope:e});e.expand=(t=>{e.level++,e.currentItem=t,i.expand(t),e.currentPath=i.getPath(t)}),e.backTo=(t=>{e.level=t,console.log("back to",t),e.items=e.levels[e.level],e.dirs=e.items.filter(e=>"dir"===e.type),e.files=e.items.filter(e=>"file"===e.type),e.currentPath=i.getPath(e.items[0])}),e.uploadFile=(t=>{console.log("current path",e.currentPath),Katrid.Services.Upload.uploadTo("/pwapec/file-manager/upload/?path="+(e.currentPath||""),t).then(()=>{i.expand(e.currentItem)})})}}))}(),function(){Katrid.Core.plugins.register(e=>{$(e).on("hashchange",(t,i)=>{if(i.startsWith("#/app/query.manager/")){t.stopPropagation(),t.preventDefault(),e.$scope.$parent.currentMenu={name:"Query Manager"},new class{constructor(e){this.app=e,this.$scope=e.$scope.$new(),this.$scope.queryChange=(e=>this.queryChange(e)),this.$scope.search={};let t=this;this.action=this.$scope.action={context:{},views:{},async saveSearch(e){let i=new Katrid.Services.Model("ui.filter"),s={};Object.assign(s,e),s.query=t.$scope.query.id,null===e.name&&(e.name=prompt("Query name","current query namne"),e.is_default=!1,e.is_shared=!0),e.name&&await i.write([s])},setSearchParams(e){t.$scope.search.params=e,t.refresh(t.query)},switchView(e){console.log("set view type",e)},orderBy(e){t.$scope.ordering===e?t.$scope.reverse=!t.$scope.reverse:(t.$scope.ordering=e,t.$scope.reverse=!1)}}}getFilter(e){return"DateField"===e.type?"|date:'shortDate'":"DateTimeField"===e.type?"|date:'short'":"IntegerField"===e.type?"|number:0":""}getSearchView(e){let t;if(e.params)t=e.params;else{t="<search>";for(let i of e.fields)t+=`<field name="${i.name}"/>`;t+="</search>"}let i={};for(let t of e.fields)i[t.name]=Katrid.Data.Fields.Field.fromInfo(t);return this.fields=i,{content:t,fields:i}}async queryChange(e){this.$scope.search={viewMoreButtons:!0},this.query=e;let t=await this.refresh(e);e.fields=t.fields,this.action.search=this.getSearchView(e),this.action.fieldList=Object.values(this.fields),this.$scope.action.views.search=this.$scope.action.search,this.renderSearch(),this.renderTable(t),this.$scope.$apply()}async refresh(e){let t=await Katrid.Services.Query.read({id:e.id,details:!0,params:this.$scope.search.params});for(let e of t.fields)e.filter=this.getFilter(e);return this.$scope.records=t.data.map(e=>((e,t)=>{let i={},s=0;for(let a of e)i[a.name]=t[s],s++;return i})(t.fields,e)),this.$scope.$apply(),t}renderSearch(){let e=this.app.getTemplate("query.manager.search.jinja2");e=Katrid.Core.$compile(e)(this.$scope),this.$element.find("#query-search-view").html(e)}async render(){let e=this.app.getTemplate("query.manager.jinja2");e=Katrid.Core.$compile(e)(this.$scope),this.$element=e;let t=await Katrid.Services.Query.all();this.$scope.queries=t.data,this.app.$element.html(e),this.$scope.$apply()}renderTable(e){let t=this.app.getTemplate("query.manager.table.jinja2",{self:this,query:this.$scope.query,records:this.records,fields:Object.values(this.fields)});t=Katrid.Core.$compile(t)(this.$scope),this.$element.find("#query-manager-result").html(t)}}(e).render()}})})}(),function(e){!function(t){let i=0;class s{}s.Operations={exact:"exact",in:"in",contains:"contains",startswith:"startswith",endswith:"endswith",gt:"gt",lt:"lt",between:"between",isnull:"isnull"},s.Labels=null,s.DefaultOperations={CharField:s.Operations.exact,IntegerField:s.Operations.exact,DateTimeField:s.Operations.between,DateField:s.Operations.between,FloatField:s.Operations.between,DecimalField:s.Operations.between,ForeignKey:s.Operations.exact,ModelChoices:s.Operations.exact,SelectionField:s.Operations.exact},s.TypeOperations={CharField:[s.Operations.exact,s.Operations.in,s.Operations.contains,s.Operations.startswith,s.Operations.endswith,s.Operations.isnull],IntegerField:[s.Operations.exact,s.Operations.in,s.Operations.gt,s.Operations.lt,s.Operations.between,s.Operations.isnull],FloatField:[s.Operations.exact,s.Operations.in,s.Operations.gt,s.Operations.lt,s.Operations.between,s.Operations.isnull],DecimalField:[s.Operations.exact,s.Operations.in,s.Operations.gt,s.Operations.lt,s.Operations.between,s.Operations.isnull],DateTimeField:[s.Operations.exact,s.Operations.in,s.Operations.gt,s.Operations.lt,s.Operations.between,s.Operations.isnull],DateField:[s.Operations.exact,s.Operations.in,s.Operations.gt,s.Operations.lt,s.Operations.between,s.Operations.isnull],ForeignKey:[s.Operations.exact,s.Operations.in,s.Operations.isnull],ModelChoices:[s.Operations.exact,s.Operations.in,s.Operations.isnull],SelectionField:[s.Operations.exact,s.Operations.isnull]},s.Widgets={CharField:e=>`<div><input id="rep-param-id-${e.id}" ng-model="param.value1" type="text" class="form-control"></div>`,IntegerField(e){let t="";return"between"===e.operation&&(t=`<div class="col-sm-6"><input id="rep-param-id-${e.id}-2" ng-model="param.value2" type="number" class="form-control"></div>`),`<div class="row"><div class="col-sm-6"><input id="rep-param-id-${e.id}" type="number" ng-model="param.value1" class="form-control"></div>${t}</div>`},DecimalField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" ng-model="param.value2" input-decimal class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" input-decimal ng-model="param.value1" class="form-control"></div>${t}</div>`},DateTimeField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" type="text" date-picker="L" ng-model="param.value2" class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" type="text" date-picker="L" ng-model="param.value1" class="form-control"></div>${t}</div>`},DateField(e){let t="";return"between"===e.operation&&(t=`<div class="col-xs-6"><input id="rep-param-id-${e.id}-2" type="text" date-picker="L" ng-model="param.value2" class="form-control"></div>`),`<div class="col-sm-12 row"><div class="col-xs-6"><input id="rep-param-id-${e.id}" type="text" date-picker="L" ng-model="param.value1" class="form-control"></div>${t}</div>`},ForeignKey(e){const t=e.info.field.attr("model")||e.params.model;let i="";return"in"===e.operation&&(i="multiple"),`<div><input id="rep-param-id-${e.id}" ajax-choices="${t}" field="${e.name}" ng-model="param.value1" ${i}></div>`},ModelChoices(e){let t="";return"in"===e.operation&&(t="multiple"),`<div><input id="rep-param-id-${e.id}" ajax-choices="ir.action.report" model-choices="${e.info.modelChoices}" ng-model="param.value1" ${t}></div>`},SelectionField(e){e.info.choices=e.info.field.data("choices");let t=e.info.field.attr("default");if(t&&(t=` ng-init="param.value1='${t}'"`),!e.info.choices){e.info.choices={};for(let t of e.info.field.find("option"))t=$(t),e.info.choices[t.attr("value")]=t.text()}return`<div${t}><select class="form-control" ng-model="param.value1"><option value="\${ key }" ng-repeat="(key, value) in fields.${e.name}.choices">\${ value }</option></select></div>`}},t.Params=s;t.Param=class{constructor(e,t){this.info=e,this.params=t,this.name=this.info.name,this.field=this.params.info.fields&&this.params.info.fields[this.name],this.label=this.info.label||this.params.info.caption,this.static="static"===this.info.param,this.type=this.info.type||this.field&&this.field.type||"CharField",this.defaultOperation=this.info.operation||s.DefaultOperations[this.type],this.operation=this.defaultOperation,this.operations=this.getOperations(),this.exclude=this.info.exclude,this.id=++i}defaultValue(){return null}setOperation(e,t){null==t&&(t=!0),this.createControls(this.scope);const i=this.el.find(`#rep-param-id-${this.id}`);t&&i.focus()}createControls(t){const i=this.el.find(".param-widget");i.empty();let a=s.Widgets[this.type](this);return a=e.Core.$compile(a)(t),i.append(a)}getOperations(){}operationTemplate(){const e=this.getOperations();return`<div class="col-sm-4"><select id="param-op-${this.id}" ng-model="param.operation" ng-init="param.operation='${this.defaultOperation}'" class="form-control" onchange="$('#param-${this.id}').data('param').change();$('#rep-param-id-${this.id}')[0].focus()">\n  ${e}\n  </select></div>`}template(){let e="";return this.operation||(e=this.operationTemplate()),`<div id="param-${this.id}" class="row form-group" data-param="${this.name}" ng-controller="ParamController"><label class="control-label">${this.label}</label>${e}<div id="param-widget-${this.id}"></div></div>`}render(e){return this.el=this.params.scope.compile(this.template())(this.params.scope),this.el.data("param",this),console.log("render param"),this.createControls(this.el.scope()),e.append(this.el)}},e.UI.uiKatrid.controller("ReportController",["$scope","$element","$compile",function(e,i,s){const a=e.$parent.action.info.content,r=new t.Report(e.$parent.action,e);return e.report=r,r.loadFromXml(a),r.render(i),r.loadParams()}]),e.UI.uiKatrid.controller("ReportParamController",["$scope","$element",function(e,t){return e.$parent.param.el=t,e.$parent.param.scope=e,e.$parent.param.setOperation(e.$parent.param.operation,!1)}]);t.ReportEngine=class{static load(e){$("row").each((e,t)=>{t.addClass("row")}),$("column").each((e,t)=>{t.addClass("col")})}}}(e.Reports||(e.Reports={}))}(Katrid||(Katrid={})),function(e){!function(t){let i=0;t.currentReport={},t.currentUserReport={},t.renderDialog=function(t){return console.log(t),e.app.getTemplate("view.report.jinja2",{action:t})};t.Report=class{constructor(s,a){this.action=s,this.scope=a,this.info=this.action.info,t.currentReport=this,null==t.Params.Labels&&(t.Params.Labels={exact:e.i18n.gettext("Is equal"),in:e.i18n.gettext("Selection"),contains:e.i18n.gettext("Contains"),startswith:e.i18n.gettext("Starting with"),endswith:e.i18n.gettext("Ending with"),gt:e.i18n.gettext("Greater-than"),lt:e.i18n.gettext("Less-than"),between:e.i18n.gettext("Between"),isnull:e.i18n.gettext("Is Null")}),this.name=this.info.name,this.id=++i,this.values={},this.params=[],this.filters=[],this.groupables=[],this.sortables=[],this.totals=[]}telegram(){}getUserParams(){let e={data:[],file:this.container.find("#id-report-file").val()};for(let t of Array.from(this.params))e.data.push({name:t.name,op:t.operation,value1:t.value1,value2:t.value2,type:t.type});let t=this.container.find("#report-id-fields").val();e.fields=t;let i=this.container.find("#report-id-totals").val();e.totals=i;let s=this.container.find("#report-id-sorting").val();e.sorting=s;let a=this.container.find("#report-id-grouping").val();return e.grouping=a,e}loadFromXml(e){let t={date:"DateField",datetime:"DateTimeField"};_.isString(e)&&(e=$(e)),this.scope.customizableReport=e.attr("customizableReport"),this.scope.advancedOptions=e.attr("advancedOptions"),this.model=e.attr("model");const i=[];for(let s of Array.from(e.find("param,field"))){let e=s.tagName;const a=(s=$(s)).attr("name");let r;console.log(this.info),this.info.fields&&(r=this.info.fields[a]);const n=s.attr("label")||s.attr("caption")||r&&r.caption||a,o=s.attr("groupable"),l=s.attr("sortable"),c=s.attr("total");let d=s.attr("param");"FIELD"!==e||d||(d="static");const h=s.attr("required"),p=s.attr("autoCreate")||h||"static"===d,u=s.attr("operation");let m=s.attr("type")||s.data("type")||r&&r.type;m in t&&(m=t[m]);const f=s.attr("model-choices");!m&&f&&(m="ModelChoices"),i.push({name:a,label:n,groupable:o,sortable:l,total:c,param:d,required:h,operation:u,modelChoices:f,type:m,autoCreate:p,field:s})}const s=Array.from(e.find("param")).map(e=>$(e).attr("name"));return this.load(i,s)}saveDialog(){const t=this.getUserParams(),i=window.prompt(e.i18n.gettext("Report name"),e.Reports.currentUserReport.name);return i&&(e.Reports.currentUserReport.name=i,$.ajax({type:"POST",url:this.container.find("#report-form").attr("action")+"?save="+i,contentType:"application/json; charset=utf-8",dataType:"json",data:JSON.stringify(t)})),!1}load(e,t){e||({fields:e}=this.info),t||(t=[]),this.fields=e,this.scope.fields={};for(let i of e)this.scope.fields[i.name]=i,i.groupable&&this.groupables.push(i),i.sortable&&this.sortables.push(i),i.total&&this.totals.push(i),i.autoCreate||(i.autoCreate=t.includes(i.name))}loadParams(){for(let e of Array.from(this.fields))e.autoCreate&&this.addParam(e.name)}addParam(e,i){for(let i of Array.from(this.fields))if(i.name===e){i=new t.Param(i,this),this.params.push(i);break}}getValues(){}export(t){null==t&&(t=localStorage.katridReportViewer||"pdf");const i=this.getUserParams();return console.log("send params",i),new e.Services.Model("ir.action.report").post("export_report",{args:[this.info.id],kwargs:{format:t,params:i}}).then(function(e){if(e.open)return window.open(e.open)}),!1}preview(){return this.export(localStorage.katridReportViewer)}renderFields(){let t,i=$("<div></div>");const s=this.fields.map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),a=(()=>{const e=[];for(t of Array.from(this.fields))t.total&&e.push(`<option value="${t.name}">${t.label}</option>`);return e})().join("");let r=(i=this.container.find("#report-params")).find("#report-id-fields");return r.append($(s)).select2({tags:(()=>{const e=[];for(let t of Array.from(this.fields))e.push({id:t.name,text:t.label});return e})()}),e.Reports.currentUserReport.params&&e.Reports.currentUserReport.params.fields&&(console.log(e.Reports.currentUserReport.params.fields),r.select2("val",e.Reports.currentUserReport.params.fields)),(r=i.find("#report-id-totals")).append(a).select2({tags:(()=>{const e=[];for(let t of Array.from(this.fields))t.total&&e.push({id:t.name,text:t.label});return e})()}),i}renderParams(t){let i,s=$("<div></div>");this.elParams=s;let a={};const r=e.Reports.currentUserReport.params;if(r&&r.data)for(let e of Array.from(r.data))a[e.name]=!0,this.addParam(e.name,e.value);for(i of Array.from(this.params))i.static&&!a[i.name]&&$(i.render(s));return t.find("#params-params").append(s)}renderGrouping(e){const t=Array.from(this.groupables).map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),i=e.find("#params-grouping").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>i.select2("onSortStart"),update:()=>i.select2("onSortEnd")})}renderSorting(e){const t=Array.from(this.sortables).filter(e=>e.sortable).map(e=>`<option value="${e.name}">${e.label}</option>`).join(""),i=e.find("#params-sorting").find("select").select2();return i.append(t).select2("container").find("ul.select2-choices").sortable({containment:"parent",start:()=>i.select2("onSortStart"),update:()=>i.select2("onSortEnd")})}render(e){this.container=e;let t=this.renderFields();return this.sortables.length?t=this.renderSorting(e):e.find("#params-sorting").hide(),this.groupables.length?t=this.renderGrouping(e):e.find("#params-grouping").hide(),this.renderParams(e)}}}(e.Reports||(e.Reports={}))}(Katrid||(Katrid={})),Katrid.UI.uiKatrid.directive("codeEditor",[function(){return{restrict:"EA",require:"ngModel",link:function(e,t,i,s){let a;require.config({paths:{vs:"/static/web/monaco/min/vs"}}),console.log("set language",i.language),require(["vs/editor/editor.main"],function(){(a=monaco.editor.create(t[0],{value:"",language:i.language||"xml",minimap:{enabled:!1},automaticLayout:!0})).getModel().onDidChangeContent(e=>{s.$setViewValue(a.getValue())}),s.$render=function(){setTimeout(()=>{a.setValue(s.$viewValue)},300)}})}}}]),function(){let e=Katrid.UI.uiKatrid,t=0;e.directive("formField2",["$compile",function(e){return{restrict:"A",priority:99,replace:!0,compile:(t,i)=>(function(i,s,a,r){let n=i.view.fields[a.name];if(_.isUndefined(n))throw Error('Invalid field name "'+a.name+'"');let o=n.template.form;if(n.assign(s),!n.visible)return void t.remove();let l=n.getAttributes(a),c={};l["ng-readonly"]&&(c["ng-readonly"]=l["ng-readonly"].toString()),a.ngShow&&(c["ng-show"]=a.ngShow),n.helpText&&(c.title=n.helpText);let d=s.html();o=Katrid.app.getTemplate(o,{name:a.name,field:n,attrs:l,content:d,fieldAttributes:a,sectionAttrs:c}),o=e(o)(i),s.replaceWith(o);let h=o.find(".form-field");if(h.length){h=h[h.length-1];const e=o.controller("form");(r=angular.element(h).data().$ngModelController)&&e.$addControl(r)}})}}]),e.directive("inputField",()=>({restrict:"A",scope:!1,link(e,t,i){$(t).on("click",function(){$(this).select()})}})),e.directive("view",()=>({restrict:"E",template:(e,i)=>(t++,""),link(e,i,s){if(e.model)return i.attr("class",`view-form-${e.model.name.replace(new RegExp(".","g"),"-")}`),i.attr("id",`katrid-form-${t.toString()}`),i.attr("model",e.model),i.attr("name",`dataForm${t.toString()}`)}})),e.directive("ngSum",()=>({restrict:"A",priority:9999,require:"ngModel",link(e,t,i,s){const a=i.ngSum.split("."),r=a[0],n=a[1];return e.$watch(`record.$${r}`,function(t,i){if(t&&e.record){let t=0;e.record[r].map(e=>t+=parseFloat(e[n])),t.toString()!==s.$modelValue&&(s.$setViewValue(t),s.$render())}})}})),e.directive("ngEnter",()=>(e,t,i)=>t.bind("keydown keypress",t=>{13===t.which&&(e.$apply(()=>e.$eval(i.ngEnter,{$event:t})),t.preventDefault())})),e.directive("ngEsc",()=>(e,t,i)=>t.bind("keydown keypress",t=>{27===t.which&&(e.$apply(()=>e.$eval(i.ngEsc,{$event:t})),t.preventDefault())})),$.fn.modal&&($.fn.modal.Constructor.prototype._enforceFocus=function(){}),e.directive("ajaxChoices",["$location",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){const{multiple:a}=i,r=i.ajaxChoices;let n=i.field,o=null;const l={allowClear:!0,query(e){let t={args:[e.term],kwargs:{count:1,page:e.page,name_fields:i.nameFields&&i.nameFields.split(",")||null}};o&&clearTimeout(o),o=setTimeout(()=>{let s=new Katrid.Services.Model(r);(s=n?s.getFieldChoices(n,e.term,t.kwargs):new Katrid.Services.Model(i.modelChoices).searchName(t)).then(t=>{const i=t.items.map(e=>({id:e[0],text:e[1]})),s=e.page*Katrid.settings.services.choicesPageLimit<t.count;return e.callback({results:i,more:s})})},400)},escapeMarkup:e=>e,initSelection(e,t){const i=s.$modelValue;if(i){if(a){const e=[];for(let t of Array.from(i))e.push({id:t[0],text:t[1]});return t(e)}return t({id:i[0],text:i[1]})}}};a&&(l.multiple=!0);const c=t.select2(l);t.on("$destroy",function(){return $(".select2-hidden-accessible").remove(),$(".select2-drop").remove(),$(".select2-drop-mask").remove()}),c.on("change",function(t){const i=c.select2("data");return s.$setDirty(),i&&(s.$viewValue=i),e.$apply()}),s.$render=(()=>{if(s.$viewValue)return t.select2("val",s.$viewValue)})}})]),e.directive("inputMask",()=>({restrict:"A",link(e,t,i){t.inputmask()}}));e.directive("inputDecimal",["$filter",class{constructor(e){this.restrict="A",this.require="ngModel",this.$filter=e}link(e,t,i,s){let a=i.inputDecimal,r={alias:"numeric",groupSeparator:".",unmaskAsNumber:!0,radixPoint:",",autoGroup:!0,digitsOptional:!1,placeholder:"0"};a&&(r.digits=parseInt(a)),t.inputmask(r),s.$parsers.push(e=>t.inputmask("unmaskedvalue")),s.$formatters.push(e=>(_.isNumber(e)?e=e.toFixed(r.digits).replace(".",","):_.isString(e)&&(e=e.replace(".",",")),e))}}]),e.filter("moment",()=>(function(e,t){return t?moment().format(t):moment(e).fromNow()})),e.directive("fileReader",()=>({restrict:"A",require:"ngModel",scope:{},link:(e,t,i,s)=>("image/*"===i.accept&&t.tag,t.bind("change",function(){const e=new FileReader;return e.onload=(e=>s.$setViewValue(e.target.result)),e.readAsDataURL(event.target.files[0])}))})),e.directive("dateInput",["$filter",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){let a=()=>{let e;e="date"===i.type?(new Date).toISOString().split("T")[0]:moment(new Date).format("YYYY-MM-DD HH:mm").replace(" ","T"),$(t).val(e),s.$setViewValue(e),r=!1},r=!0;t.focus(function(){""===$(this).val()&&(r=!0)}).keypress(function(e){"h"===e.key.toLowerCase()&&(a(),e.stopPropagation(),e.preventDefault())}).keydown(function(e){/\d/.test(e.key)&&""===$(this).val()&&r&&a()}),s.$formatters.push(function(e){if(e)return new Date(e)}),s.$parsers.push(function(e){if(_.isDate(e)){let t=moment.utc(e).format("YYYY-MM-DD");s.$modelValue&&(t+="T"+s.$modelValue.split("T",1)[1]);let i=moment.utc(t).format("YYYY-MM-DDTHH:mm:ss");return console.log("ret",e,t,i),i}})}})]),e.directive("timeInput",()=>({restrict:"A",require:"?ngModel",link(e,t,i,s){t.inputmask({regex:"([0-1]?[0-9]|2[0-4]):([0-5][0-9])",insertMode:!1}),t.on("focus",function(){setTimeout(()=>$(this).select())}),s.$parsers.push(function(e){let t=s.$modelValue.split("T",1)[0]+"T"+e;console.log("time parser",t,e,s.$viewValue);let i=moment.utc(t).format("YYYY-MM-DDTHH:mm:ss");return"Invalid date"===i&&(i=s.$modelValue),i}),s.$render=function(){let e=s.$modelValue;if(console.log("render",e),e)return t.val(moment.utc(e).format("HH:mm"))}}})),e.directive("cardDraggable",()=>({restrict:"A",link(e,t,i,s){let a={connectWith:i.cardDraggable,cursor:"move"};_.isUndefined(i.cardItem)||(a.receive=((e,t)=>{console.log("event");let i=angular.element(t.item.parent()).scope(),s=angular.element(t.item).scope();console.log(s),console.log(i);let a={};a.id=s.record.id,$.extend(a,i.group.$params[0]),console.log(a),i.model.write([a]).then(e=>{console.log("write ok",e)})})),_.isUndefined(i.cardGroup)||(a.update=((i,s)=>{let a=[];$.each(s.item.parent().find(".card-group"),(e,t)=>{a.push($(t).data("id"))});let r=t.find(".card-group").first().data("group-name"),n=e.$parent.$parent.view.fields[r].model;Katrid.Services.data.reorder(n,a).done(e=>{console.log(e)})})),console.log(a),t.sortable(a).disableSelection(),$("#sortable").sortable()}})),e.directive("uiTooltip",()=>({restrict:"A",link:(e,t,i)=>{$(t).tooltip({container:"body",delay:{show:200,hide:500}})}})),e.setFocus=(e=>{let t=$(e);t.data("select2")?t.select2("focus"):e.focus()}),e.directive("action",["$compile",e=>({restrict:"E",priority:99,link:(e,t,i)=>{console.log("define action",i.ngClick);let s=t.closest("div.data-form").find(".dropdown-menu-actions"),a=(i.name,`<li><a href="javascript:void(0)">${t.html()}</a></li>`),r=$(a);r.click(()=>{i.object&&e.model.rpc(i.object,[e.$parent.record.id])}),s.append(r),t.remove()}})])}(),function(){let e=function(e,t,i){let s=[],a=(e[0],[]),r={},n=0;for(let s of t){let o=[];0===n&&o.push(t[0]);for(let l of e){let e=l[s];if(n>0&&!(e in r)){o=[e],r[e]=o;for(let e of a)o.push(0)}else n>0&&(o=r[e]);n>0?o[a.indexOf(l[t[0]])]=l[i||"total"]||0:o.includes(e)||o.push(e)}0===n&&(a=o,r[t[0]]=o),n++}return s=Object.values(r),console.log(s),s};Katrid.Actions.ClientAction.register("dashboard",class extends Katrid.Forms.Views.ClientView{async render(){let e=new Katrid.Services.Model("ir.action.client"),t=await e.rpc("get_view",[this.action.info.id]);if(t.content)return Katrid.Core.$compile(t.content)(this.action.scope)}}),Katrid.UI.uiKatrid.directive("dashboard",["$compile",class extends Katrid.Forms.Widgets.Component{constructor(e){super(),this.$compile=e,this.restrict="E",this.scope=!1}async link(e,t,i,s){i.dashboardId}}]),Katrid.UI.uiKatrid.directive("chart",class extends Katrid.Forms.Widgets.Component{constructor(){super()}async link(t,i,s){let a,r,n,o,l=i.find("query");l.length&&(l.remove(),n=l.text()),console.log("init chart"),s.groups&&(o=s.groups.split(","));let c=async l=>{let c=(a=n?await Katrid.Services.Query.executeSql(n):s.source?t[s.source]:await fetch(l).then(e=>e.json())).data;console.log(s);let d={bindto:i[0],data:{},color:{pattern:Katrid.UI.Dashboard.colorPatterns}},h=!1,p=i.attr("type");if(p&&(d.data.type=p),o){c=e(c,o);let t=[];for(let e=1;e<c.length;e++)t.push(c[e][0]);h=!0}else if(_.isArray(c)&&c.length){let e=Object.keys(c[0]);d.data.columns=c.map(t=>[t[e[0]],t[e[1]]]),h=!0}h&&(r=c3.generate(d))};s.urlParams?(s.urlParams,t.$watch(s.urlParams,c)):s.source?t.$watch(s.source+".data",c):c(),s.$observe("url",c)}}),Katrid.UI.uiKatrid.directive("query",class extends Katrid.Forms.Widgets.Component{constructor(){super(),this.priority=200,this.scope=!1}link(e,t,s){new i(t,e),t.remove()}});class t{constructor(e){this.el=e}th(){let e=this.el.attr("caption")||this.el.attr("name"),t=this.el.attr("class"),i=this.el.attr("header-title"),s="";i||(i="");let a=this.el.attr("on-header-click");return t&&(s+='class ="'+t+'"'),a&&(s+=' ng-click="'+a+'"'),`<th title="${i}" ${s}>${e}</th>`}td(){let e=this.el.attr("format");e?(e="|"+e,console.log("format",e)):e="";let t=this.el.attr("title");t||(t="");this.el.attr("ng-class");let i=this.el[0].className,s=this.el.html();return s||(s=`\${ record.${this.name}${e} }`),`<td title='${t}' class="${i}">${s}</td>`}tfoot(){let e=this.total;return e=e?'${grid.total("'+this.name+'")}':this.footer?this.footer:"",`<td class="${this.el[0].className}">${e}</td>`}get name(){return this.el.attr("name")}get footer(){return this.el.attr("footer")}get total(){return this.el.attr("total")}}Katrid.UI.uiKatrid.directive("tableView",()=>({restrict:"E",scope:!1,template(e,i){let s=[];for(let i of e.find("field"))s.push(new t($(i)));return Katrid.app.getTemplate("dashboard.table.jinja2",{fields:s,el:e,attrs:i})}}));class i{constructor(e,t){this.$el=e,this.controls=[],this.$counter=0,this.$scope=t,this.params=this.$el.data("params"),this.name=e.attr("name"),this.name&&(t[this.name]=this),this.sql=this.$el.html(),this.url=e.data("url"),setTimeout(()=>this.execute(),100)}async execute(){this.$loading=!0;try{let e;if(this.url)e=await fetch(this.url).then(e=>e.json());else if(this.sql){let t=this.params;if(console.log(t),t){let e=t;t={};for(let i of e){let e=this.$scope[i];console.log(i,e),_.isDate(e)&&console.log("param is date",e),t[i]=e}}else t=this.$scope;let i=_.sprintf(this.sql,t);e=await Katrid.Services.Query.executeSql(i)}this.$counter++,this.data=e.data,this.$scope.$apply(),this.onChange()}finally{this.$loading=!1}}onChange(){for(let e of this.controls)e.$render(this.data)}}class s{constructor(e){if(_.isString(e.el)?this.$el=$(e.el):this.$el=e.el,this.$scope=e.scope,this.$sourceScope=e.sourceScope||e.scope,this.$loading=!1,this.create(e),_.isString(this.dataSource)){let e=this.$sourceScope[this.dataSource];e&&(e.controls.push(this),e.$counter&&this.$render(e.data))}}create(e){this.dataSource=e.dataSource||this.$el.data("source"),this.caption=e.caption||this.$el.attr("caption")}$render(e){}}Katrid.UI.uiKatrid.directive("gridView",()=>({restrict:"E",scope:{},async link(e,i,a){new class extends s{constructor(e){super(e),this._groupBy=[];let i=this.$el.attr("group-by");i&&(this._groupBy=i.split(",")),this.totals=[],this.fields=[];for(let e of this.$el.find("field")){let i=new t($(e));this.fields.push(i),i.total&&this.totals.push(i.name)}this.$scope.grid=this;let s=Katrid.app.getTemplate("dashboard.grid.jinja2",{self:this,fields:this.fields});s=Katrid.Core.$compile(s)(this.$scope),this.$el.html(s)}get groupBy(){return this._groupBy}set groupBy(e){this._groupBy=e,this._lastData&&this.$render(this._lastData)}total(e){console.log("calc attr",e);let t=0;if(this._lastData)for(let i of this._lastData)t+=i[e];return t}$render(e){this._lastData=e,e||(e=[]),this.groupBy.length&&(e=function(e,t,i,s){let a={};for(let r of e){let e=r[t],n=a[e];if(!n){n=a[e]={$children:[]};for(let e of i)n[e]=0}n.$children.push(r),n.$group=!0,n[s]=e;for(let e of i)n[e]+=r[e]}return Object.values(a)}(e,this.groupBy,this.totals,this.fields[0].name)),this.$scope.records=this._renderGroup(e)}_renderGroup(e){let t=[];for(let i of e)t.push(i),i.$group&&(t=t.concat(this._renderGroup(i.$children)));return t}}({el:i,attrs:a,scope:e,sourceScope:e.$parent})}})),Katrid.UI.uiKatrid.filter("duration",()=>(e,t,i)=>{if(i||(i="HH:mm:ss"),e){"seconds"===t&&_.isString(e)&&(e=parseInt(e));let s=moment.duration(e,t).format(i);return 5===s.length&&(s="00:"+s),s}return e}),Katrid.UI.Dashboard={Chart:class extends s{constructor(e){super(e),this.backButton=$(`<button style="position: absolute; left: 0; top: 0;" class="btn btn-outline-secondary btn-sm back-button">${_.gettext("Back")}</button>`),this.backButton.hide(),this.$el.prepend(this.backButton)}groupBy(e,t,i){if(0===e.length)return[];let s=[],a=e[0],r="select ",n=t;if(_.isArray(n)?n=n.join(","):_.isNumber(t)&&(n=Object.keys(a)[t]),r+=n,_.isArray(i))for(let e of i)r+=",sum("+e+") as "+e;else _.isString(i)?r+=`,sum(${i}) as ${i}`:_.isNumber(i)&&(r+=",sum("+(i=Object.keys(a)[i])+") as "+i);return r+=" from ? group by ",r+=n,console.log(r),s=alasql(r,[e])}create(e){super.create(e),this.x=e.x,this.y=e.y,this.keys=e.keys,this.type=e.type,this.axis=e.axis,this.legend=e.legend,this.onclick=e.onclick,this.columns=e.columns,this.grid=e.grid,this.labels=e.labels,this.pie=e.pie,!this.columns&&!this.keys&&_.isUndefined(this.x)&&_.isUndefined(this.y)&&(this.x=0,this.y=1)}$render(e){this.$data=e,this.columns?this.$columns=this.columns:this.$columns=this.groupBy(e,this.x,this.y).map(e=>Object.values(e));let t={width:this.$el.parent().width()};this.$chart=c3.generate({bindto:this.$el[0],data:{columns:this.$columns,type:this.type,onclick:this.onclick,labels:this.labels},color:{pattern:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]},pie:this.pie,size:t,grid:this.grid,legend:this.legend,axis:this.axis}),this.$chart.$chart=this}query(e,t){return alasql(e,t)}},colorPatterns:["#1f77b4","#aec7e8","#ff7f0e","#ffbb78","#2ca02c","#98df8a","#d62728","#ff9896","#9467bd","#c5b0d5","#8c564b","#c49c94","#e377c2","#f7b6d2","#7f7f7f","#c7c7c7","#bcbd22","#dbdb8d","#17becf","#9edae5"]}}(),function(){let e=Katrid.UI.uiKatrid;e.directive("datePicker",["$filter",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){let a="99/99/9999",r=i.datePicker||"L";"L LT"===r&&(a="99/99/9999 99:99"),t.inputmask({mask:a,insertMode:!1});let n=$(t.parent()).datetimepicker({useCurrent:!1,format:r,icons:{time:"fa fa-clock"}}).on("dp.change",function(e){n.datetimepicker("hide")}).on("dp.hide",function(e){s.$setDirty(),s.$setViewValue(t.val())});t.on("focus",()=>t.select()),s.$render=function(){s.$modelValue?n.datetimepicker("date",moment.utc(s.$modelValue)):t.val("")},t.on("blur",()=>{let e=moment(t.val(),r);e.isValid()?s.$modelValue=e.format("YYYY-MM-DD"):s.$modelValue=null}),s.$parsers.push(e=>{let i=moment(t.val(),r);if(i.isValid()){if("L"===r)return i.format("YYYY-MM-DD");if("L LT"===r)return i.format("YYYY-MM-DD HH:mm")}return null})}})]),e.directive("timePicker",["$filter",e=>({restrict:"A",require:"?ngModel",link(e,t,i,s){t.inputmask({mask:"99:99",insertMode:!1}),t.on("focus",()=>t.select())}})])}(),function(){Katrid.UI.uiKatrid.directive("fkAutocomplete",["$controller",e=>({restrict:"A",require:"ngModel",link(e,t,i,s){const a=e.view.fields[i.name];$(t).autocomplete({source:(t,s)=>{let r=a.domain;r&&_.isString(r)&&(r=e.$eval(r));let n,o={args:[t.term],kwargs:{domain:r,name_fields:i.nameFields&&i.nameFields.split(",")||null}};(n=e.model?e.model.getFieldChoices(a.name,t.term,o.kwargs):new Katrid.Services.Model(a.model).searchName(o)).then(e=>{let t=[];for(let i of e.items)t.push({value:i[0],label:i[1]});s(t)})},minLength:1,select:(i,a)=>(t.val(a.item.label),e.$apply(()=>(t.data("value",[a.item.value,a.item.label]),s.$setDirty(),!1)),!1)}),s.$parsers.push(e=>t.data("value")),s.$formatters.push(e=>(console.log("formatter",e),_.isArray(e)?e[1]:e))}})]),Katrid.UI.uiKatrid.directive("foreignkey",["$compile","$controller",(e,t)=>({restrict:"A",require:"ngModel",link(e,i,s,a){let r,n=i,o=!1;const l=e.view.fields[s.name];i.addClass("form-field"),r=s.serviceName?s:e.action&&e.action.model?e.action.model.name:s.foreignkey;const c=function(){},d=function(){};let h=null,p={allowClear:!0,query(t){let i=l.domain;i&&_.isString(i)&&(i=e.$eval(i));let a={args:[t.term],kwargs:{count:1,page:t.page,domain:i,name_fields:s.nameFields&&s.nameFields.split(",")||null}};h&&clearTimeout(h),h=setTimeout(()=>{let i;(i=e.model?e.model.getFieldChoices(l.name,t.term,a.kwargs):new Katrid.Services.Model(l.model).searchName(a)).then(e=>{const i=e.items.map(e=>({id:e[0],text:e[1]})),a=t.page*Katrid.settings.services.choicesPageLimit<e.count;if(!m&&!a){let e;const t=n.data("select2").search.val();(s.allowCreate&&"false"!==s.allowCreate||null==s.allowCreate)&&t&&(e=Katrid.i18n.gettext('Create <i>"%s"</i>...'),i.push({id:c,text:e}))}return t.callback({results:i,more:a})})},400)},ajax:{url:`/api/rpc/${r}/get_field_choices/`,contentType:"application/json",dataType:"json",type:"POST"},formatSelection:e=>e.id===c||e.id===d?Katrid.i18n.gettext("Creating..."):e.text,formatResult(e){const t=n.data("select2").search.val();return e.id===c?(e.str=t,`<strong>${sprintf(e.text,t)}</strong>`):e.id===d?(e.str=t,`<strong>${sprintf(e.text,t)}</strong>`):e.text},initSelection(e,t){let i=a.$modelValue;return m?t(i=i.map(e=>({id:e[0],text:e[1]}))):_.isArray(i)?t({id:i[0],text:i[1]}):void 0}},u=s.noCreateEdit;u=_.isUndefined(u)||!Boolean(u);let{multiple:m}=s;m&&(p.multiple=!0),n=n.select2(p);return u&&n.parent().find("div.select2-container>div.select2-drop").append(`<div style="padding: 4px;"><button type="button" class="btn btn-link btn-sm">${Katrid.i18n.gettext("Create New...")}</button></div>`).find("button").click(()=>{n.select2("close");let i=new Katrid.Services.Model(l.model);return i.getViewInfo({view_type:"form"}).then(function(s){let a=_.sprintf(Katrid.i18n.gettext("Create: %(title)s"),{title:l.caption}),r={scope:e.$new(!0),$controller:t,sel:n,field:l,title:a,view:s,model:i,action:e.action};new Katrid.UI.Dialogs.Window(r).createNew()})}),n.on("change",async i=>{console.log("on change",i.val);let s=i.added;if(s&&s.id===c){let i=new Katrid.Services.Model(l.model);try{let a=await i.createName(s.str),r={};r[l.name]=a,e.dataSource.setValues(r),n.select2("data",{id:a[0],text:a[1]})}catch(a){let r=await i.getViewInfo({view_type:"form"}),o=_.sprintf(Katrid.i18n.gettext("Create: %(title)s"),{title:l.caption}),c={scope:e.$new(!0),$controller:t,sel:n,field:l,title:o,view:r,model:i,action:e.action};new Katrid.UI.Dialogs.Window(c).createNew({creationName:s.str}),n.select2("data",null)}}else if(!s||s.id!==d)return m&&i.val.length?a.$setViewValue(i.val):(a.$setDirty(),s?a.$setViewValue([s.id,s.text]):a.$setViewValue(null))}).on("select2-open",()=>{if(!o){o=!0;let e=i.closest("div.modal");e.length&&e.on("hide.bs.modal",()=>n.select2("destroy"))}}),a.$parsers.push(e=>e?_.isArray(e)?e:_.isObject(e)?[e.id,e.text]:e:null),m||e.$watch(s.ngModel,(e,t)=>n.select2("val",e)),a.$render=function(){if(!m)return a.$viewValue?n.select2("val",a.$viewValue[0]):n.select2("val",null);if(a.$modelValue){Array.from(a.$modelValue).map(e=>e[0]);n.select2("val",a.$modelValue)}}}})]),Katrid.UI.uiKatrid.filter("m2m",()=>(function(e){if(_.isArray(e))return e.map(e=>e?e[1]:null).join(", ")}))}(),Katrid.UI.uiKatrid.directive("sortableField",["$compile","$timeout",(e,t)=>({restrict:"E",require:"ngModel",replace:!0,scope:{},link:{post:function(e,t,i){t.closest("tbody").sortable({helper:function(e,t){let i=t.children(),s=t.clone();return s.children().each(function(e){$(this).width(i.eq(e).width())}),s},stop:function(e,t){$("td.list-column-sortable",t.item.parent()).each(function(e){})}}).disableSelection()}},template:(e,t)=>sprintf(Katrid.$templateCache.get("view.field.SortableField"),{fieldName:t.name})})]),Katrid.UI.uiKatrid.directive("statusField",["$compile",e=>({restrict:"A",priority:1,replace:!0,link(e,t,i,s){const a=e.view.fields[i.name];e.choices=a.choices,i.readonly||(e.itemClick=(()=>console.log("status field item click"))),t.closest("header").prepend(t)},template:(e,t)=>sprintf(Katrid.app.$templateCache.get("view.field.StatusField"),{fieldName:t.name})})]),Katrid.UI.uiKatrid.filter("numberFormat",()=>(e,t=3)=>null==e?"":new Intl.NumberFormat("pt-br",{maximumSignificantDigits:t}).format(e)),function(){Katrid.UI.uiKatrid.directive("grid",["$compile",class{constructor(e){this.restrict="E",this.scope={},this.$compile=e}async loadViews(e,t,i,s){let a=await e.model.loadViews(),r=a.views.list.fields[e.field.field];e.dataSource.field=e.field,r&&(r.visible=!1);let n=a.views;for(let[e,t]of Object.entries(i))n[e].content=t;e.views=n,e.view=n.list;let o=$(e.view.content);e.inline?o.attr("ng-row-click","editItem($event, $index)").attr("inline-editor",e.inline):o.attr("ng-row-click","openItem($event, $index)"),o.attr("records","records"),o.attr("list-options",'{"deleteRow": true}');let l=this.$compile(o)(e);t.html(l),t.prepend(this.$compile(Katrid.app.getTemplate("view.form.grid.toolbar.jinja2",{attrs:s}))(e)),t.find("table").addClass("table-bordered grid")}async showDialog(e,t,i){if(e.views.form&&await this.renderDialog(e,t),null!=i){e.recordIndex=i;let t=e.records[i];t&&t.$loaded?e.record=t:t&&((await e.dataSource.get(e.records[i].id,0,!1,i)).$loaded=!0)}}async link(e,t,i){i.ngDefaultValues&&(e.ngDefaultValues=i.ngDefaultValues);const s=e.$parent.view.fields[i.name];e.totalDisplayed=1e3,e.fieldName=i.name,e.field=s,e.records=[],e.recordIndex=-1,e._cachedViews={},e._=e.$parent._,e._changeCount=0,e.dataSet=[],e.model=new Katrid.Services.Model(s.model),e.isList=!0,"tabular"===i.inlineEditor?e.inline="tabular":i.hasOwnProperty("inlineEditor")&&(e.inline="inline"),e.getContext=function(){return{}},e.$setDirty=function(){return{}};let a=e.dataSource=new Katrid.Data.DataSource(e);a.readonly=!_.isUndefined(i.readonly);let r=e.$parent;for(;r;){if(r.action&&r.action.dataSource){e.dataSource.masterSource=r.action.dataSource;break}if(r.dataSource){e.dataSource.masterSource=r.dataSource;break}r=r.$parent}e.parent=a.masterSource.scope,e.action=a.masterSource.action,a.action=e.action,e.dataSource.fieldName=e.fieldName,e.gridDialog=null;let n={};for(let e of t.children())if(e.tagName.startsWith("GRID:")){let t=e.tagName.split(":")[1].toLowerCase();e=$(e),n[t]=`<${t}>${e.html()}</${t}>`}function o(e){for(let t=(e=e.replace(/^\s+/,"")).length-1;t>=0;t--)if(/\S/.test(e.charAt(t))){e=e.substring(0,t+1);break}return e}await this.loadViews(e,t,n,i),e.doViewAction=((t,i,s)=>e.action._doViewAction(e,t,i,s)),e._incChanges=(()=>{e.$parent.$fieldLog[e.field.name]||(e.$parent.$fieldLog[e.field.name]={}),e.$parent.$fieldLog[e.field.name].count++}),e.addItem=(async()=>{if(await e.dataSource.insert(),!i.$attr.inlineEditor)return this.showDialog(e,i);e.records.splice(0,0,e.record),e.dataSource.edit(),e.$parent.record[e.fieldName]||(e.$parent.record[e.fieldName]=[]),e.$parent.record[e.fieldName].push(e.record),e.$apply()}),e.addRecord=function(t){let i=Katrid.Data.createRecord({$loaded:!0},e.dataSource);for(let[e,s]of Object.entries(t))i[e]=s;e.records.push(i),e.dataSource.parent.record[e.fieldName]||(e.dataSource.parent.record[e.fieldName]=[]),e.dataSource.parent.record[e.fieldName].push(i),console.log("add record",i)},e.cancelChanges=(()=>e.dataSource.setState(Katrid.Data.DataSourceState.browsing)),e.openItem=(async(t,s)=>{await this.showDialog(e,i,s),e.dataSource.masterSource.changing&&!e.dataSource.readonly&&e.dataSource.edit(),e.$apply()}),e.editItem=((t,i)=>{e.dataSource.changing&&e.save(),e.$parent.dataSource.changing&&(e.dataSource.recordIndex=i,e.dataSource.edit(),setTimeout(()=>{let e=$(t.target).closest("td").find("input.form-control").focus();setTimeout(()=>e.select())},100))}),e.removeItem=function(t){const i=e.records[t];e.records.splice(t,1),e._incChanges(),i.$record.$delete()},e.$set=((t,i)=>{const s=e.form[t];s.$setViewValue(i),s.$render()}),e.save=function(){if(e._incChanges(),!e.inline){if(e.recordIndex>-1){let t=e.record;e.record=null,e.records.splice(e.recordIndex,1),setTimeout(()=>{e.records.splice(e.recordIndex,0,t),e.$apply()})}else-1===e.recordIndex&&e.records.push(e.record);e.inline||e.gridDialog.modal("toggle")}},e.pasteData=async function(){let t={},i=async function(i,s){return new Promise(async(a,r)=>{if(t[i.name]||(t[i.name]={}),void 0===t[i.name][s]){let a=await e.model.getFieldChoices(i.name,s,{exact:!0});a.items&&a.items.length?t[i.name][s]=a.items[0]:t[i.name][s]=null}a(t[i.name][s])})},s=[];for(let t of $(e.view.content).find("field")){let i=e.view.fields[$(t).attr("name")];i&&(_.isUndefined(i.visible)||i.visible)&&s.push(i)}let a=await navigator.clipboard.readText();for(let t of a.split(/\r?\n/))if(t){let a=0,r={};for(let e of t.split(/\t/)){let t=s[a];t instanceof Katrid.Data.Fields.ForeignKey?r[t.name]=await i(t,o(e)):r[t.name]=o(e),a++}e.addRecord(r)}e.$apply()};let l=function(t,i,a){if(i===e.dataSource.masterSource)if(e.dataSet=[],e._changeCount=0,e.records=[],null!=a){const t={};if(t[s.field]=a,a)return e.dataSource.pageLimit=1e3,e.dataSource.search(t).then(t=>{e.$parent.$fieldLog[s.name]={count:0,value:t.data},e.$parent.record[s.name]=t.data,e.$apply()}).finally(()=>e.dataSource.state=Katrid.Data.DataSourceState.browsing)}else e.$parent.record[s.name]=[]};e.dataSource.pendingMasterId&&l(0,e.dataSource.parent,e.dataSource.pendingMasterId);let c=[e.$on("masterChanged",l),e.$on("afterCancel",function(t,i){i===e.dataSource.masterSource&&e.dataSource.cancel()})];e.$on("$destroy",function(){c.map(e=>e())})}async renderDialog(e,t){let i,s=e.views.form.content;e.view=e.views.form;let a=e.views.form.fields[e.field.field];if(a&&(a.visible=!1),t.inline)i=me.$compile(s)(e),gridEl.find(".inline-input-dialog").append(i);else{let t=new Katrid.UI.Views.FormView({scope:e},e.views.form,{dialog:!0,templateUrl:"view.field.OneToManyField.Dialog.jinja2",context:{field:e.field}});i=t.render()}return e.formElement=i.find("form:first"),e.form=e.formElement.controller("form"),e.gridDialog=i,t.inline||(i.modal("show"),i.on("hidden.bs.modal",function(){e.record=null,e.dataSource.state=Katrid.Data.DataSourceState.browsing,i.remove(),e.gridDialog=null,e.recordIndex=-1,_destroyChildren()})),i.find(".modal-dialog").addClass("ng-form"),new Promise(function(e){i.on("shown.bs.modal",()=>e(i))})}}]).directive("list",["$compile",e=>({restrict:"E",scope:!1,compile(t,i){t.addClass("table-responsive");let s=i.ngRowClick,a=i.records||"records",r=t.html(),n={};i.listOptions&&(n=JSON.parse(i.listOptions));let o=Katrid.app.getTemplate("view.list.table.jinja2",{attrs:i,rowClick:s,options:n,records:a});return function(t,i,s,a){let l,c=$(o),d=c.find("tbody>tr:first"),h=c.find("thead>tr:first"),p=c.find("tfoot>tr:first"),u=s.ngTrClass;u=u?","+u:"",console.log("row class",u),s.inlineEditor?(c.addClass("inline-editor"),l=$(t.views.form.content),d.attr("ng-form","grid-row-form-{{$index}}").attr("id","grid-row-form-{{$index}}")):d.attr("ng-class","{'group-header': record.$hasChildren, 'form-data-changing': (dataSource.changing && dataSource.recordIndex === $index), 'form-data-readonly': !(dataSource.changing && dataSource.recordIndex === $index)"+u+"}");let m,f,g=$("<div>").append(r),v=[],w=!1;for(let e of g.children("field")){let i=e.getAttribute("name"),a=t.view.fields[i];if(a){a.assign(t.action.view,e);let r=e.getAttribute("total");if(r?(w=!0,v.push({field:a,name:i,total:r})):v.push(!1),!a.visible)continue;let n=!1;l&&(n=l.find(`field[name="${i}"]`),n=$(n[0].outerHTML).attr("form-field","form-field").attr("inline-editor",s.inlineEditor)[0].outerHTML),f=$(a.render("list",e,{view:t.view})).first(),m=$(f).next()}else f="<th></th>",m=`<td>${e.html()}</td>`;d.append(m),h.append(f)}if(w)for(total of v)p.append(Katrid.app.getTemplate("view.list.table.total.jinja2",{field:total.field}));else p.remove();if(n.deleteRow){let e=$(Katrid.app.getTemplate("view.list.table.delete.jinja2"));for(let t of e)"TD"===t.tagName?d.append(t):"TH"===t.tagName&&h.append(t);w&&p.append('<td class="list-column-delete" ng-show="dataSource.parent.changing && !dataSource.readonly"></td>')}i.html(""),i.append(e(c)(t))}}})])}(),function(){Katrid.UI.uiKatrid.directive("ngTotal",["$filter",class{constructor(e){this.restrict="E",this.scope=!1,this.replace=!0,this.$filter=e}template(e,t){return"'"===t.expr[0]?`<span>${t.expr.substring(1,t.expr.length-1)}</span>`:`<span ng-bind="total$${t.field}|number:2"></span>`}link(e,t,i,s){"'"!==i.expr[0]&&e.$watch("records",t=>{let s=0;t.map(e=>s+=parseFloat(e[i.field])),e["total$"+i.field]=s,e.parent["total$"+e.fieldName+"$"+i.field]=s})}}])}(),function(e){"use strict";function t(e,t){if(this.createTextRange){var i=this.createTextRange();i.collapse(!0),i.moveStart("character",e),i.moveEnd("character",t-e),i.select()}else this.setSelectionRange&&(this.focus(),this.setSelectionRange(e,t))}function i(e){var t=this.value.length;if(e="start"==e.toLowerCase()?"Start":"End",document.selection){var i,s,a,r=document.selection.createRange();return(i=r.duplicate()).expand("textedit"),i.setEndPoint("EndToEnd",r),a=(s=i.text.length-r.text.length)+r.text.length,"Start"==e?s:a}return void 0!==this["selection"+e]&&(t=this["selection"+e]),t}var s={codes:{188:44,110:44,108:44,109:45,190:46,191:47,192:96,220:92,222:39,221:93,219:91,173:45,187:61,186:59,189:45},shifts:{96:"~",49:"!",50:"@",51:"#",52:"$",53:"%",54:"^",55:"&",56:"*",57:"(",48:")",45:"_",61:"+",91:"{",93:"}",92:"|",59:":",39:'"',44:"<",46:">",47:"?"}};e.fn.number=function(a,r,n,o){o=void 0===o?",":o,n=void 0===n?".":n,r=void 0===r?0:r;var l="\\u"+("0000"+n.charCodeAt(0).toString(16)).slice(-4),c=new RegExp("[^-"+l+"0-9]","g"),d=new RegExp(l,"g");return!0===a?this.is("input:text")?this.on({"keydown.format":function(a){var l=e(this),h=l.data("numFormat"),p=a.keyCode?a.keyCode:a.which,u="",m=i.apply(this,["start"]),f=i.apply(this,["end"]),g="",v=!1;if("-"===a.key)return 0===l.val()?h.negative=!0:(h.negative=!1,this.value.includes("-")?this.value=this.value.substr(1,this.value.length-1):this.value="-"+this.value),l.val(this.value),void a.preventDefault();if(s.codes.hasOwnProperty(p)&&(p=s.codes[p]),!a.shiftKey&&p>=65&&p<=90?p+=32:!a.shiftKey&&p>=69&&p<=105?p-=48:a.shiftKey&&s.shifts.hasOwnProperty(p)&&(u=s.shifts[p]),""==u&&(u=String.fromCharCode(p)),8!==p&&u!=n&&!u.match(/[0-9]/)){var w=a.keyCode?a.keyCode:a.which;if(46==w||8==w||9==w||27==w||13==w||(65==w||82==w)&&!0===(a.ctrlKey||a.metaKey)||(86==w||67==w)&&!0===(a.ctrlKey||a.metaKey)||w>=35&&w<=39)return;return a.preventDefault(),!1}if(0==m&&f==this.value.length||0==l.val()?8===p?(m=f=1,this.value="",h.init=r>0?-1:0,h.c=r>0?-(r+1):0,t.apply(this,[0,0])):u===n?(m=f=1,this.value="0"+n+new Array(r+1).join("0"),h.init=r>0?1:0,h.c=r>0?-(r+1):0):0===this.value.length&&(h.init=r>0?-1:0,h.c=r>0?-r:0):h.c=f-this.value.length,r>0&&u==n&&m==this.value.length-r-1)h.c++,h.init=Math.max(0,h.init),a.preventDefault(),v=this.value.length+h.c;else if(u==n)h.init=Math.max(0,h.init),a.preventDefault();else if(r>0&&8==p&&m==this.value.length-r)a.preventDefault(),h.c--,v=this.value.length+h.c;else if(r>0&&8==p&&m>this.value.length-r){if(""===this.value)return;"0"!=this.value.slice(m-1,m)&&(g=this.value.slice(0,m-1)+"0"+this.value.slice(m),l.val(g.replace(c,"").replace(d,n))),a.preventDefault(),h.c--,v=this.value.length+h.c}else 8==p&&this.value.slice(m-1,m)==o?(a.preventDefault(),h.c--,v=this.value.length+h.c):r>0&&m==f&&this.value.length>r+1&&m>this.value.length-r-1&&isFinite(+u)&&!a.metaKey&&!a.ctrlKey&&!a.altKey&&1===u.length&&(g=f===this.value.length?this.value.slice(0,m-1):this.value.slice(0,m)+this.value.slice(m+1),this.value=g,v=m);!1===v&&44===p&&u===n&&(v=this.value.indexOf(n)+1),!1!==v&&t.apply(this,[v,v]),l.data("numFormat",h)},"keyup.format":function(s){var a,n=e(this),o=n.data("numFormat"),l=s.keyCode?s.keyCode:s.which,c=i.apply(this,["start"]);""===this.value||(l<48||l>57)&&(l<96||l>105)&&8!==l||(n.val(n.val()),r>0&&(o.init<1?(c=this.value.length-r-(o.init<0?1:0),o.c=c-this.value.length,o.init=1,n.data("numFormat",o)):c>this.value.length-r&&8!=l&&(o.c++,n.data("numFormat",o))),a=this.value.length+o.c,this.value.length-a===o.decimals&&String.fromCharCode(l)!==o.dec_point&&(a-=1,console.log("set pos",o.dec_point,l,String.fromCharCode(l))),t.apply(this,[a,a]))},"paste.format":function(t){var i=e(this),s=t.originalEvent,a=null;return window.clipboardData&&window.clipboardData.getData?a=window.clipboardData.getData("Text"):s.clipboardData&&s.clipboardData.getData&&(a=s.clipboardData.getData("text/plain")),i.val(a),t.preventDefault(),!1}}).each(function(){var t=e(this).data("numFormat",{c:-(r+1),decimals:r,thousands_sep:o,dec_point:n,regex_dec_num:c,regex_dec:d,init:!1});""!==this.value&&t.val(t.val())}):this.each(function(){var t=e(this),i=+t.text().replace(c,"").replace(d,".");t.number(isFinite(i)?+i:0,r,n,o)}):this.text(e.number.apply(window,arguments))};var a=null,r=null;e.isPlainObject(e.valHooks.text)?(e.isFunction(e.valHooks.text.get)&&(a=e.valHooks.text.get),e.isFunction(e.valHooks.text.set)&&(r=e.valHooks.text.set)):e.valHooks.text={},e.valHooks.text.get=function(t){var i,s=e(t).data("numFormat");return s?""===t.value?"":(i=+t.value.replace(s.regex_dec_num,"").replace(s.regex_dec,"."),""+(isFinite(i)?i:0)):e.isFunction(a)?a(t):void 0},e.valHooks.text.set=function(t,i){var s=e(t).data("numFormat");return s?t.value=e.number(i,s.decimals,s.dec_point,s.thousands_sep):e.isFunction(r)?r(t,i):void 0},e.number=function(e,t,i,s){s=void 0===s?",":s,i=void 0===i?".":i,t=isFinite(+t)?Math.abs(t):0;var a="\\u"+("0000"+i.charCodeAt(0).toString(16)).slice(-4),r="\\u"+("0000"+s.charCodeAt(0).toString(16)).slice(-4);e=(e+"").replace(".",i).replace(new RegExp(r,"g"),"").replace(new RegExp(a,"g"),".").replace(new RegExp("[^0-9+-Ee.]","g"),"");var n=isFinite(+e)?+e:0,o="";return(o=(t?function(e,t){var i=Math.pow(10,t);return""+Math.round(e*i)/i}(n,t):""+Math.round(n)).split("."))[0].length>3&&(o[0]=o[0].replace(/\B(?=(?:\d{3})+(?!\d))/g,s)),(o[1]||"").length<t&&(o[1]=o[1]||"",o[1]+=new Array(t-o[1].length+1).join("0")),o.join(i)}}(jQuery),function(){Katrid.UI.uiKatrid.directive("comments",()=>({restrict:"E",scope:{},replace:!0,template:'<div class="content"><div class="comments"><mail-comments/></div></div>',link(e,t,i){t.closest(".modal-dialog").length?t.remove():$(t).closest(".form-view[ng-form=form]").children(".content:first").append(t)}})),Katrid.UI.uiKatrid.directive("mailComments",()=>({restrict:"E",controller:["$scope",e=>{e.comments=new class{constructor(e){this.scope=e,this.model=this.scope.$parent.model,this.scope.$parent.$watch("recordId",e=>{this.items=null,this.scope.loading=Katrid.i18n.gettext("Loading..."),clearTimeout(this._pendingOperation),this._pendingOperation=setTimeout(()=>(this._pendingOperation=null,this.masterChanged(e),this.scope.$apply(()=>this.scope.loading=null)),1e3)}),this.items=[]}async masterChanged(e){if(e){const e=new Katrid.Services.Model("mail.message");if(this.scope.$parent.record)return e.post("get_messages",{args:[this.scope.$parent.record.messages]}).then(e=>{this.items=e,this.scope.$apply()})}}async _sendMesage(e,t){t&&(t=t.map(e=>e.id));let i=await this.model.post("post_message",{args:[[this.scope.$parent.recordId]],kwargs:{content:e,content_subtype:"html",format:!0,attachments:t}});this.scope.message="",this.items=i.concat(this.items),this.scope.$apply(),this.scope.files=null,this.scope.hideEditor()}postMessage(e){if(this.scope.files.length){let i=[];for(let e of this.scope.files)i.push(e.file);var t=this;Katrid.Services.Attachments.upload({files:i},this.scope.$parent).done(i=>{t._sendMesage(e,i)})}else this._sendMesage(e)}}(e),e.files=[],e.showEditor=(()=>{$(e.el).find("#mail-editor").show(),$(e.el).find("#mail-msgEditor").focus()}),e.hideEditor=(()=>{$(e.el).find("#mail-editor").hide()}),e.attachFile=(t=>{for(let i of t.files)e.files.push({name:i.name,type:i.type,file:i});e.$apply()}),e.deleteFile=(t=>{e.files.splice(t,1)})}],replace:!0,link(e,t,i){e.el=t},template:()=>`\n  <div class="container">\n          <h3>${Katrid.i18n.gettext("Comments")}</h3>\n          <div class="form-group">\n          <button class="btn btn-outline-secondary" ng-click="showEditor();">${Katrid.i18n.gettext("New message")}</button>\n          <button class="btn btn-outline-secondary">${Katrid.i18n.gettext("Log an internal note")}</button>\n          </div>\n          <div id="mail-editor" style="display: none;">\n            <div class="form-group">\n              <textarea id="mail-msgEditor" class="form-control" ng-model="message"></textarea>\n            </div>\n            <div class="form-group">\n              <button class="btn btn-default" type="button" onclick="$(this).next().click()"><i class="fa fa-paperclip"></i></button>\n              <input class="input-file-hidden" type="file" multiple onchange="angular.element(this).scope().attachFile(this)">\n            </div>\n            <div class="form-group" ng-show="files.length">\n              <ul class="list-inline attachments-area">\n                <li ng-repeat="file in files" ng-click="deleteFile($index)" title="${Katrid.i18n.gettext("Delete this attachment")}">{{ file.name }}</li>\n              </ul>\n            </div>\n            <div class="from-group">\n              <button class="btn btn-primary" ng-click="comments.postMessage(message)">${Katrid.i18n.gettext("Send")}</button>\n            </div>\n          </div>\n  \n          <hr>\n  \n          <div ng-show="loading">{{ loading }}</div>\n          <div class="comment media col-sm-12" ng-repeat="comment in comments.items">\n            <div class="media-left">\n              <img src="/static/web/assets/img/avatar.png" class="avatar rounded">\n            </div>\n            <div class="media-body">\n              <strong>{{ ::comment.author_name }}</strong> - <span class="timestamp text-muted" title="\${ ::comment.date_time|moment:'LLLL'}"> {{::comment.date_time|moment}}</span>\n              <div class="clearfix"></div>\n              <div class="form-group">\n                {{::comment.content}}\n              </div>\n              <div class="form-group" ng-if="comment.attachments">\n                <ul class="list-inline">\n                  <li ng-repeat="file in comment.attachments">\n                    {{file.mimetype}}\n                    <div class="comment-preview-image" ng-if="file.mimetype.startsWith('image')" style="width: 16%;height:100px;background-image:url('/web/content/\${ ::file.id }')"></div>\n                    <a href="/web/content/\${ ::file.id }/?download">{{ ::file.name }}</a>\n                  </li>\n                </ul>\n              </div>\n            </div>\n          </div>\n    </div>`}));class e extends Katrid.Forms.Widgets.Widget{static initClass(){this.prototype.tag="mail-comments"}spanTemplate(e,t,i,s){return""}}e.initClass(),Katrid.Forms.Widgets.MailComments=e}(),function(e){e.fn.tabset=function(){this.addClass("col-12");let t=e('<nav><div class="nav nav-tabs" role="tablist"></div></nav>'),i=t.find("div"),s=e('<div class="tab-content"></div>'),a=0;for(let t of this.children("tab")){let r=e('<a class="nav-item nav-link" role="tab"></a>'),n=t.querySelector("tab-heading");r.data("index",a),r.html(n.innerHTML),t.hasAttribute("ng-show")&&r.attr("ng-show",t.getAttribute("ng-show")),t.hasAttribute("ng-if")&&r.attr("ng-if",t.getAttribute("ng-if")),i.append(r),n.remove(),t.classList.add("tab-pane","row"),t.setAttribute("role","tabpanel"),s.append(t),r.click(function(){e(this).tab("show"),s.find(".tab-pane.active").removeClass("active show"),t.classList.add("active","show")}),0===a&&r.click(),a++}return this.append(t),this.append(s),this}}(jQuery),function(){Katrid.Reports.Telegram=class{static async export(e,t){console.log("export telegram");let i=Katrid.app.$templateCache.get("reportbot.dialog.contacts"),s=$(i);$("body").append(s);let a=s.find("#id-reportbot-select-contacts"),r=new Katrid.Services.Model("res.partner"),n=await r.post("get_telegram_contacts");return n&&(n&&n.map(e=>a.append(`<option value="${e[0]}">${e[1]}</option>`)),a.select2()),s.find("#id-btn-ok").click(async()=>{let t=new Katrid.Services.Model("telegram.pending");const i=e.getUserParams();t.post("export_report",{args:[e.info.id],kwargs:{contacts:a.val(),format:"pdf",params:i}}).ok&&console.log("ok")}),s.modal(),!0}}}(),function(e){!function(e){const t="fa-caret-right",i="fa-caret-down";class s{get el(){return this._el}set el(e){this.setElement(e)}setElement(e){this._el=e,e.katrid={object:this}}}e.Component=s;class a extends s{constructor(e,t){let i;if(super(),this.treeView=e,this._selected=!1,this._expanded=!1,this._level=0,this._children=[],t instanceof HTMLElement)this.el=t;else if(t){this.data=t,(i=document.createElement("li")).classList.add("tree-node");let e=document.createElement("a");e.addEventListener("mousedown",e=>{e.preventDefault(),this.treeView.el.focus()}),e.addEventListener("click",()=>this.select()),e.addEventListener("dblclick",e=>{e.preventDefault(),this.expanded=!this.expanded}),this._ul=document.createElement("ul"),e.classList.add("tree-item"),i.appendChild(e),i.appendChild(this._ul),this.el=i,this._a=e,this._canExpand=!0,this._exp=document.createElement("span"),this._exp.addEventListener("dblclick",e=>e.stopPropagation()),this._exp.addEventListener("click",e=>{e.preventDefault(),this.expanded=!this.expanded}),this._exp.classList.add("fa","fa-fw"),e.appendChild(this._exp),_.isString(t.icon)&&(this._iconElement=document.createElement("span"),this._iconElement.classList.add("icon","fa","fa-fw"),this._iconElement.classList.add(t.icon),e.appendChild(this._iconElement)),e.appendChild(document.createTextNode(t.text))}}get children(){return this._children}select(){this.treeView.selection=[this]}collapse(){this.expanded=!1}expand(){this.expanded=!0}get expanded(){return this._expanded}set expanded(e){this._expanded=e,e?(this.el.classList.add("expanded"),this._exp.classList.remove(t),this._exp.classList.add(i)):(this.el.classList.remove("expanded"),this._exp.classList.remove(i),this._exp.classList.add(t))}get index(){return this._parent?this._parent.children.indexOf(this):this.treeView.nodes.indexOf(this)}get previousSibling(){let e;return(e=this._parent?this._parent.children:this.treeView.nodes)[this.index-1]}get nextSibling(){let e;return(e=this._parent?this._parent.children:this.treeView.nodes)[this.index+1]}get previous(){let e=this.previousSibling;return e&&e._expanded&&e.children&&e.children.length?e.last:this._parent?this._parent:e}get next(){if(this._expanded&&this.children.length)return this.first;let e=this.nextSibling;return e&&e._expanded&&e.children&&e.children.length?e.first:this._parent?this._parent.nextSibling:e}get first(){return this.children[0]}get last(){return this.children[this.children.length-1]}get selected(){return this._selected}set selected(e){this._selected=e,e?this._a.classList.add("selected"):this._a.classList.remove("selected"),this.treeView.selection.includes(this)||this.treeView.selection.push(this)}get parent(){return this._parent}set parent(e){this._parent&&this._parent.remove(this),this._parent=e,e&&e.add(this)}add(e){this.children.push(e),this._ul.appendChild(e.el),this.update(),e.calcLevel()}remove(e){this.children.splice(this.children.indexOf(e),1),this.update(),e.calcLevel()}calcLevel(){this.level=this._parent.level+1}update(){this._canExpand&&this.children.length?this._exp.classList.add(t):this._exp.classList.remove(i)}get level(){return this._level}set level(e){if(console.log("set level",e,this._level),e!==this._level){for(let e of this.el.querySelectorAll(".indent"))e.parentNode.removeChild(e);let t=e-this._level;this._level=e;for(let e of this.all())e.level-=t;for(let e=0;e<this._level;e++){let e=document.createElement("span");e.classList.add("indent"),this._a.prepend(e)}}}*all(){for(let e of this.children){for(let t of e.all())yield t;yield e}}}e.TreeNode=a;e.TreeView=class{constructor(e){this._selection=[],this.el=e.dom,this.nodes=[],e.items&&this.addNodes(e.items),this.el.classList.add("tree-view"),this.el.tabIndex=0,this.el.addEventListener("keydown",e=>{let t;switch(console.log("key down;"),e.key){case"ArrowDown":console.log("arrow down;;"),this.next();break;case"ArrowUp":this.previous();break;case"ArrowRight":(t=this.currentNode)&&t.children.length?t.expanded?t.next.select():t.expand():this.next();break;case"ArrowLeft":(t=this.currentNode)&&t.children.length?t.expanded?t.collapse():t.previous.select():this.previous()}})}get selection(){return this._selection}set selection(e){for(let e of this._selection)e.selected=!1;this._selection=e;for(let t of e)t.selected=!0;let t=new CustomEvent("selectionchange",{detail:{selection:e}});this.el.dispatchEvent(t)}get firstNode(){if(this.nodes.length)return this.nodes[0]}get lastNode(){if(this.nodes.length)return this.nodes[this.nodes.length-1]}previous(){let e=this.currentNode;if(e){let t=e.previous;t&&t.select()}else this.lastNode.select()}next(){let e=this.currentNode;if(e){let t=e.next;t&&t.select()}else this.firstNode.select()}addNodes(e,t=null){for(let i of e){let e=this.addNode(i,t);i.children&&this.addNodes(i.children,e)}}addNode(e,t){let i;return e instanceof HTMLElement||"string"==typeof e&&(e={text:e}),console.log(e),i=new a(this,e),t?i.parent=t:(this.nodes.push(i),console.log(i.el),this.el.appendChild(i.el)),i}get currentNode(){if(this.selection.length)return this.selection[this.selection.length-1]}}}(e.UI||(e.UI={}))}(Katrid||(Katrid={})),function(){class e{getSettingsDropdown(e){if("form"===e)return`<ul class="dropdown-menu pull-right">\n    <li>\n      <a href="javascript:void(0);" ng-click="action.showDefaultValueDialog()">${Katrid.i18n.gettext("Set Default")}</a>\n    </li>\n  </ul>`}getSetDefaultValueDialog(){}static get cssListClass(){return"table table-striped table-bordered table-condensed table-hover display responsive nowrap dataTable no-footer dtr-column"}renderList(e,t,i,s,a,r=!0){let n='<th ng-show="dataSource.groups.length"></th>',o=!1,l=[],c='<td ng-show="dataSource.groups.length" class="group-header">\n  <div ng-show="record._group">\n  <span class="fa fa-fw fa-caret-right"\n    ng-class="{\'fa-caret-down\': record._group.expanded, \'fa-caret-right\': record._group.collapsed}"></span>\n    {{::record._group.__str__}} ({{::record._group.count }})</div></td>';r&&(n+="<th class=\"list-record-selector\"><input type=\"checkbox\" ng-click=\"action.selectToggle($event.currentTarget)\" onclick=\"$(this).closest('table').find('td.list-record-selector input').prop('checked', $(this).prop('checked'))\"></th>",c+='<td class="list-record-selector" onclick="event.stopPropagation();"><input title="teste" type="checkbox" ng-click="action.selectToggle($event.currentTarget)" onclick="if (!$(this).prop(\'checked\')) $(this).closest(\'table\').find(\'th.list-record-selector input\').prop(\'checked\', false)"></td>');for(let i of Array.from(t.children())){let t=i.outerHTML,s=(i=$(i)).attr("name");if(!s){c+=`<td>${i.html()}</td>`,n+="<th><span>${col.attr('label')}</span></th>";continue}let a=i.attr("total");a?(l.push([s,a]),o=!0):l.push(a),s=i.attr("name");const r=e.view.fields[s];if("False"===i.attr("visible")||!1===r.visible)continue;let d=r.createWidget(i.attr("widget"),e,i,i);d.inList=!0,d.inplaceEditor=Boolean(e.inline),n+=d.th(i.attr("label")),c+=d.td(e.inline,t,i)}a&&(n+='<th class="list-column-delete" ng-show="parent.dataSource.changing && !dataSource.readonly">',c+='<td class="list-column-delete" ng-show="parent.dataSource.changing && !dataSource.readonly" ng-click="removeItem($index);$event.stopPropagation();"><i class="fa fa-trash-o"></i></td>'),null==s&&(s="action.listRowClick($index, row, $event)"),o=o?`<tfoot><tr>${l.map(e=>e?`<td class="text-right"><strong><ng-total field="${e[0]}" type="${e[1]}"></ng-total></ strong></td>`:'<td class="borderless"></td>').join("")}</tr></tfoot>`:"";let d=" grid";return e.inline&&(d+=" inline-editor"),`<table class="${this.constructor.cssListClass}${d}">\n  <thead><tr>${n}</tr></thead>\n  <tbody>\n  <tr ng-repeat="record in records | limitTo:totalDisplayed" ng-click="${s}" ng-class="{'group-header': record._hasGroup, 'form-data-changing': (dataSource.changing && dataSource.recordIndex === $index), 'form-data-readonly': !(dataSource.changing && dataSource.recordIndex === $index)}" ng-form="grid-row-form-{{$index}}" id="grid-row-form-{{$index}}">${c}</tr>\n  </tbody>\n  ${o}\n  </table>\n  <a href="javascript:void(0)" ng-show="records.length > totalDisplayed" ng-click="totalDisplayed = totalDisplayed + 1000">${Katrid.i18n.gettext("View more...")}</a>\n  `}renderGrid(e,t,i,s){const a=this.renderList(e,t,i,s,!0,!1);let r;return`<div style="overflow-x: auto;"><div ng-show="!dataSource.readonly">\n  ${r="inline"==i.inline?`\n<button class="btn btn-xs btn-info" ng-click="addItem()" ng-show="parent.dataSource.changing && !dataSource.changing" type="button">${Katrid.i18n.gettext("Add")}</button>\n<button class="btn btn-xs btn-info" ng-click="addItem()" ng-show="dataSource.changing" type="button">${Katrid.i18n.gettext("Save")}</button>\n<button class="btn btn-xs btn-info" ng-click="cancelChanges()" ng-show="dataSource.changing" type="button">${Katrid.i18n.gettext("Cancel")}</button>\n`:`\n<button class="btn btn-xs btn-info" ng-click="addItem()" ng-show="parent.dataSource.changing" type="button">${Katrid.i18n.gettext("Add")}</button>\n<button class="btn btn-xs btn-outline-secondary float-right" ng-click="pasteData()" ng-show="parent.dataSource.changing" type="button" title="${Katrid.i18n.gettext("Paste")}">\n<i class="fa fa-clipboard"></i>\n</button>\n`}\n  </div><div class="row inline-input-dialog" ng-show="dataSource.changing"/>${a}</div>`}windowDialog(e){console.log("window dialog",e)}renderReportDialog(e){return`<div ng-controller="ReportController">\n  <form id="report-form" method="get" action="/web/reports/report/">\n    <div class="data-heading panel panel-default">\n      <div class="panel-body">\n      <h2>{{ report.name }}</h3>\n      <div class="toolbar">\n        <button class="btn btn-primary" type="button" ng-click="report.preview()"><span class="fa fa-print fa-fw"></span> ${Katrid.i18n.gettext("Preview")}</button>\n  \n        <div class="btn-group">\n          <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"\n                  aria-expanded="false">${Katrid.i18n.gettext("Export")} <span class="caret"></span></button>\n          <ul class="dropdown-menu">\n            <li><a ng-click="Katrid.Reports.Reports.preview()">PDF</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('docx')">Word</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('xlsx')">Excel</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('pptx')">PowerPoint</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('csv')">CSV</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('txt')">${Katrid.i18n.gettext("Text File")}</a></li>\n          </ul>\n        </div>\n  \n        <div class="btn-group">\n          <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"\n                  aria-expanded="false">${Katrid.i18n.gettext("My reports")} <span class="caret"></span></button>\n          <ul class="dropdown-menu">\n            <li><a ng-click="Katrid.Reports.Reports.preview()">PDF</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('docx')">Word</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('xlsx')">Excel</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('pptx')">PowerPoint</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('csv')">CSV</a></li>\n            <li><a href="javascript:void(0)" ng-click="Katrid.Reports.Reports.export('txt')">${Katrid.i18n.gettext("Text File")}</a></li>\n          </ul>\n        </div>\n  \n      <div class="pull-right btn-group">\n        <button class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-haspopup="true"\n                aria-expanded="false"><i class="fa fa-gear fa-fw"></i></button>\n        <ul class="dropdown-menu">\n          <li><a href="javascript:void(0)" ng-click="report.saveDialog()">${Katrid.i18n.gettext("Save")}</a></li>\n          <li><a href="#">${Katrid.i18n.gettext("Load")}</a></li>\n        </ul>\n      </div>\n  \n      </div>\n    </div>\n    </div>\n    <div class="col-sm-12">\n      <table class="col-sm-12" style="margin-top: 20px; display:none;">\n        <tr>\n          <td colspan="2" style="padding-top: 8px;">\n            <label>${Katrid.i18n.gettext("My reports")}</label>\n  \n            <select class="form-control" ng-change="action.userReportChanged(action.userReport.id)" ng-model="action.userReport.id">\n                <option value=""></option>\n                <option ng-repeat="rep in userReports" value="{{ rep.id }}">{{ rep.name }}</option>\n            </select>\n          </td>\n        </tr>\n      </table>\n    </div>\n  <div id="report-params">\n  <div id="params-fields" class="col-sm-12 form-group">\n    <div class="checkbox"><label><input type="checkbox" ng-model="paramsAdvancedOptions"> ${Katrid.i18n.gettext("Advanced options")}</label></div>\n    <div ng-show="paramsAdvancedOptions">\n      <div class="form-group">\n        <label>${Katrid.i18n.gettext("Printable Fields")}</label>\n        <input type="hidden" id="report-id-fields"/>\n      </div>\n      <div class="form-group">\n        <label>${Katrid.i18n.gettext("Totalizing Fields")}</label>\n        <input type="hidden" id="report-id-totals"/>\n      </div>\n    </div>\n  </div>\n  \n  <div id="params-sorting" class="col-sm-12 form-group">\n    <label class="control-label">${Katrid.i18n.gettext("Sorting")}</label>\n    <select multiple id="report-id-sorting"></select>\n  </div>\n  \n  <div id="params-grouping" class="col-sm-12 form-group">\n    <label class="control-label">${Katrid.i18n.gettext("Grouping")}</label>\n    <select multiple id="report-id-grouping"></select>\n  </div>\n  \n  <div class="clearfix"></div>\n  \n  </div>\n    <hr>\n      <table class="col-sm-12">\n        <tr>\n          <td class="col-sm-4">\n            <select class="form-control" ng-model="newParam">\n              <option value="">--- ${Katrid.i18n.gettext("FILTERS")} ---</option>\n              <option ng-repeat="field in report.fields" value="{{ field.name }}">{{ field.label }}</option>\n            </select>\n          </td>\n          <td class="col-sm-8">\n            <button\n                class="btn btn-default" type="button"\n                ng-click="report.addParam(newParam)">\n              <i class="fa fa-plus fa-fw"></i> ${Katrid.i18n.gettext("Add Parameter")}\n            </button>\n          </td>\n        </tr>\n      </table>\n  <div class="clearfix"></div>\n  <hr>\n  <div id="params-params">\n    <div ng-repeat="param in report.params" ng-controller="ReportParamController" class="row form-group">\n      <div class="col-sm-12">\n      <div class="col-sm-4">\n        <label class="control-label">{{param.label}}</label>\n        <select ng-model="param.operation" class="form-control" ng-change="param.setOperation(param.operation)">\n          <option ng-repeat="op in param.operations" value="{{op.id}}">{{op.text}}</option>\n        </select>\n      </div>\n      <div class="col-sm-8" id="param-widget"></div>\n      </div>\n    </div>\n  </div>\n  </form>\n  </div>  `}}Katrid.UI.utils={BaseTemplate:e,Templates:new e}}(),function(e){!function(t){!function(t){class i extends HTMLElement{connectedCallback(){this.classList.add("action-view")}}t.ActionView=i,customElements.define("action-view",i);customElements.define("attachments-button",class extends HTMLElement{connectedCallback(){this.actionView=this.closest("action-view"),this._recordLoadedHook=(async t=>{clearTimeout(this._timeout);let i=t.detail.record;i&&i.id?this._timeout=setTimeout(async()=>{let i=new e.Services.Model("ir.attachment"),s=await i.search({where:{model:this.actionView.action.model.name,object_id:t.detail.record.id},count:!1});s&&s.data&&(this.actionView.action.attachments=s.data)},1e3):setTimeout(()=>{this.actionView.action.attachments=[]})}),this.actionView.addEventListener("recordLoaded",this._recordLoadedHook)}disconnectedCallback(){this.actionView.removeEventListener("recordLoaded",this._recordLoadedHook)}renderItems(e){for(let t of e)this.renderItem(t)}renderItem(t){let i=document.createElement("a");i.classList.add("dropdown-item position-relative"),i.setAttribute("href",t.download_url),i.innerText=t.name,i.innerHTML=`<span class="fa fa-times remove-attachment-button" title="${e.i18n.gettext("Delete attachment")}"></span>`,i.querySelector("span").onclick=(e=>{e.preventDefault(),this.onDeleteAttachment(t),e.stopPropagation()})}onDeleteAttachment(e){}})}(t.Web||(t.Web={}))}(e.UI||(e.UI={}))}(Katrid||(Katrid={})),Katrid.$hashId=0,_.mixin({hash:e=>(e.$hashId||(e.$hashId=++Katrid.$hashId),e.$hashId)}),_.mixin({sum(e,t){let i=0;if(e)for(let s of e){let e=s[t];_.isNumber(e)||(e=Number(e)),_.isNaN(e)&&(e=0),i+=e}return i},avg(e,t){if(e&&e.length)return _.sum(e,t)/e.length}});
//# sourceMappingURL=katrid.min.js.map