{% extends "/web/base.jinja2" %}
{% import "/web/include/menu-utils.html" as menu_utils %}
{% block content %}
  <div id="page-content">

  <!-- Fixed navbar -->
  <nav id="header" class="navbar navbar-expand-lg navbar-dark bg-purple flex-row" ng-cloak>
    <a id="apps-button" class="header-link" data-toggle="dropdown">
      <i class="fa fa-th"></i>
    </a>
    <div class="dropdown-menu apps-menu">
      {% for menu in root_menu %}
      <a class="dropdown-item module-selector"
         id="ui-menu-{{ menu.pk }}"
         data-menu-id="{{ menu.pk }}" ng-click="currentMenu={ id: {{ menu.pk }}, name: '{{ menu.name }}' }">
        {{ menu.name }}
      </a>
      {% endfor %}
    </div>
    <a href="#/app/?#menu_id=" class="navbar-menu-header">
      <h3>${ currentMenu.name }</h3>
    </a>
    <div id="navbar" class="collapse navbar-collapse">
      {% for main_menu in root_menu %}
      <ul class="navbar-nav mr-auto" data-parent-id="{{ main_menu.pk }}" ng-show="currentMenu.id=={{ main_menu.pk }}">
        {% for menu in main_menu.children %}
        <li class="nav-item dropdown" aria-haspopup="true" aria-expanded="false">
          <a class="nav-link dropdown-link menu-item-action" role="button"
             id="ui-menu-{{ menu.pk }}"
             data-menu-id="{{ menu.pk }}"
             {% if not menu.children %}
             data-parent-id="{{ main_menu.pk }}"
             data-action-id="{{ menu.action_id }}"
             href="{{ menu.url }}&menu_id={{ main_menu.pk }}"
             {% endif %}
          >
            {% if menu.icon %}{{ menu.icon }}{% endif %} {{ gettext(menu.name) }}
          </a>
          {% if menu.children %}
          {{ menu_utils.dropdown_menu(menu, main_menu) }}
          {% endif %}
        </li>
        {% endfor %}
      </ul>
      {% endfor %}
      <input id="navbar-search" type="text" class="form-control form-control-dark typeahead" placeholder="{{ gettext('Find resources here...') }}">
      <ul class="nav navbar-nav navbar-right hidden-xs">
        <li class="dropdown">
          <a href="javascript:void(0)" data-toggle="dropdown" role="button" aria-haspopup="true"
             aria-expanded="false" ng-show="false">{{ gettext('Shortcuts') }} <span class="caret"></span>
          </a>
          <ul class="dropdown-menu" aria-haspopup="true" aria-expanded="true">
          </ul>
        </li>
      </ul>
      <ul id="static-nav" class="nav navbar-nav">
        <li class="nav-item">
          <a id="query-manager-link" class="nav-link" href="#/app/query.manager/" title="{{ gettext('Query Editor') }}">
            <i class="fa fa-database"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="dropdown-toggle nav-link" href="javascript:void(0);" data-action="messages" title="View notifications"
             data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
            <i class="fa fa-bell"></i>
            <!--
            <span class="label label-warning label-menu-corner">32</span>
            -->
          </a>
          <ul class="dropdown-menu dropdown-notifications-menu animated flipInY">
          </ul>

        </li>
        <li class="nav-item">
          <a class="nav-link btn-voice-command" href="javascript:void(0);" onclick="$(this).toggleClass('active');Katrid.Speech.voiceCommand.toggle();" data-action="voiceCommand" title="Execute command voice">
            <i class="fa fa-microphone"></i>
          </a>
        </li>
        <li class="nav-item hidden-xs">
          <a class="nav-link" href="javascript:void(0);" data-action="fullScreen" title="Full Screen" onclick="Katrid.UI.toggleFullScreen()">
            <i class="fa fa-arrows-alt"></i>
          </a>
        </li>
        <li class="nav-item">
          <a class="nav-link" href="/web/logout/" title="Logout"><i class="fa fa-lg fa-sign-out-alt"></i></a>
        </li>
      </ul>
    </div><!--/.nav-collapse -->
  </nav>


  <!-- Left Menu -->
  <aside id="left-menu" class="sidebar bg-light" style="display: none;">
    <div class="left-menu-content">
    <div class="logo-area text-center">
      <a href="/web/" class="avatar">
        <img id="logo" src="/web/company/logo/">
      </a>

{#      <div class="user-info">#}
{#        <small>{CONFIG DASHBOARD}</small><br>#}
{#        <span class="user-value">0</span><span> {{ _('Messages') }}</span><br>#}
{#        <span class="user-value">0</span><span> PendÃªncias</span>#}
{#      </div>#}
      <div class="clearfix"></div>

      <a class="user-profile-menu" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
        <span>{{ g.user.name }}</span>
        <span class="user-dropdown"><i class="fa fa-fw fa-angle-down"></i></span>
      </a>
      <div class="dropdown-menu">
        <a class="dropdown-item" href="/web/logout/"><i class="fa fa-fw fa-sign-out"></i> {{ gettext('Sign out') }}</a>
      </div>
    </div>
    <div class="module-menu d-block d-sm-none dropdown">
      <a href="javascript:void(0)" class="dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">{{ gettext(current_menu.name) }} <i class="pe pe-7s-right-arrow pull-right"></i></a>
      <div class="dropdown-menu">
        {% for menu in root_menu %}
        <a class="dropdown-item" ng-click="current_menu={{ menu.pk }}" href="javascript:void(0)">{% if menu.icon %}{{ menu.icon }}{% endif %} {{ gettext(menu.name) }}</a>
        {% endfor %}
      </div>
    </div>

    <!-- menu -->
    <nav class="sidebar-nav">
      {% for current_menu in root_menu %}
      <ul id="left-side-menu" class="nav flex-column" data-menu-id="{{ current_menu.pk }}" ng-show="current_menu==={{ current_menu.pk }}">
        {% for menu in current_menu.children %}
          {{ menu_utils.menu_item(menu) }}
        {% endfor %}
      </ul>
      {% endfor %}
    </nav>
    <!-- /menu -->
  </div>

  </aside>

  <!-- End Left Menu -->

  <div id="main-content" role="main">
    <div id="katrid-action-view" ng-controller="AppController"></div>
{#    <div ui-view id="katrid-action-view">#}
{#      <h4 id="h-loading" class="ajax-loading-animation"><i class="fa fa-refresh fa-spin"></i> <span ng-bind="::_.gettext('Loading...')"></span></h4>#}
{#    </div>#}
  </div>
  <!-- /container -->

  <footer id="footer" class="page-footer" ng-if="false">
    <div class="pull-right">
      Log History
    </div>
    &copy; Katrid 2015-2018
  </footer>

<!--  <div id="demo-settings" title="Theme settings">
    <span class="demo"><i class="fa fa-lg fa-gear"></i></span>
  </div>
-->

  </div>

{% endblock %}
{% block page_loaded %}
  <!-- menu-startup -->
  <script>
    $('.menu-item').each(function () {
      var li = $(this);
      if (li.find('.menu-item').length) li.children('a').append('<em class="fa fa-angle-left"></em>')
    });
    $('.menu-item>a').click(function (event) {
      var el = $(this);
      var li = el.parent();
      if (li.children('ul').length) {
        li.toggleClass('open');
        var span = li.children('a').children('em.fa');
        span.toggleClass('fa-angle-left');
        span.toggleClass('fa-angle-down');
      }
    });
  </script>

  <script>
    // start katrid application
    var app = Katrid.Core.WebApplication.bootstrap({
      templates: '/web/client/templates/',
    });
  </script>

  <script>
  $('#apps-button')
  .on('click', function() {
    $('apps-menu').dropdown();
  })
  </script>
  <script src="/static/web/assets/js/bootstrap3-typeahead.min.js"></script>
  <script>
    let items = [];
    $('.menu-item>a').each(function (idx, el) {
      el = $(el);
      items.push({href: el.attr('href'), name: el.text().trim()});
    });
    $('.typeahead').typeahead({
      source: items,
      updater: function(item) {
        window.location.href = item.href;
      }
    })
  </script>
  <script src="/static/web/monaco/min/vs/loader.js"></script>

  <script src="/static/bi/plugins/cube.js"></script>
  <link href="/static/bi/css/bi.css" rel="stylesheet"/>
  <script src="/static/bi/plugins/bi.js"></script>
  <script src="/static/bi/plugins/cube.js"></script>

{% endblock %}
